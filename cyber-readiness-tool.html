<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cyber Readiness Assessment Tool</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1226;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.44);
      --brand:#7C3AED;
      --brand2:#22D3EE;
      --good:#34D399;
      --warn:#FBBF24;
      --bad:#FB7185;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --shadow2: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 26px;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    *{ box-sizing: border-box; margin: 0; padding: 0; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(800px 600px at 50% 90%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      line-height: 1.6;
    }

    /* Subtle animated grid */
    .gridfx{
      position:fixed; inset:0;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.045) 1px, transparent 1px);
      background-size: 42px 42px;
      mask-image: radial-gradient(800px 600px at 50% 20%, black 35%, transparent 85%);
      pointer-events:none;
      opacity:.55;
      animation: drift 14s var(--ease) infinite alternate;
    }
    @keyframes drift{ from{ transform: translate3d(0,0,0); } to{ transform: translate3d(0,-14px,0);} }

    /* Floating orbs */
    .orb{
      position:fixed; width:520px; height:520px;
      border-radius:999px;
      filter: blur(18px);
      opacity:.55;
      pointer-events:none;
      mix-blend-mode: screen;
      animation: float 9s var(--ease) infinite alternate;
    }
    .orb.one{ left:-140px; top:-140px; background: radial-gradient(circle at 35% 30%, rgba(124,58,237,.75), transparent 55%); }
    .orb.two{ right:-180px; top:80px; background: radial-gradient(circle at 40% 35%, rgba(34,211,238,.55), transparent 60%); animation-duration: 11s;}
    .orb.three{ left:40%; bottom:-220px; background: radial-gradient(circle at 45% 45%, rgba(251,113,133,.45), transparent 62%); animation-duration: 13s;}
    @keyframes float { from{ transform: translate3d(0,0,0) scale(1); } to{ transform: translate3d(0,24px,0) scale(1.02);} }

    .wrap{ 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 28px 24px 60px; 
      position:relative;
      width: 100%;
    }

    /* Top Navigation - Enhanced */
    .topbar{
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      position: sticky; 
      top: 0; 
      z-index: 100;
      padding: 16px 20px;
      margin-bottom: 24px;
      border-radius: var(--radius2);
      background: rgba(10,14,26,.85);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    .brand{ 
      display: flex; 
      align-items: center; 
      gap: 14px; 
      user-select: none; 
    }
    .logo{
      width: 44px; 
      height: 44px; 
      border-radius: 12px;
      background: conic-gradient(from 210deg, rgba(124,58,237,.9), rgba(34,211,238,.9), rgba(251,113,133,.7), rgba(124,58,237,.9));
      box-shadow: 0 12px 32px rgba(124,58,237,.3);
      position: relative; 
      overflow: hidden;
      flex-shrink: 0;
    }
    .logo:after{
      content:""; 
      position:absolute; 
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 60%);
      transform: rotate(18deg);
    }
    .brand-text h1{ 
      font-size: 16px; 
      margin:0; 
      letter-spacing:.2px; 
      line-height:1.2; 
      font-weight: 700;
    }
    .brand-text .sub{ 
      font-size: 12.5px; 
      color: var(--muted); 
      margin-top: 4px; 
      line-height: 1.3;
    }

    .actions{ 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill{
      display: flex; 
      align-items: center; 
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      cursor: pointer;
      transition: all .2s var(--ease);
      user-select: none;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    .pill:hover{ 
      transform: translateY(-2px); 
      background: rgba(255,255,255,.1); 
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .pill:active{ transform: translateY(0px) scale(.98); }
    .pill .hint{ color: var(--muted); font-size:11px; }
    .pill.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,211,238,.65));
      border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 12px 32px rgba(124,58,237,.3);
    }

    /* Main Container - Enhanced */
    .main-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Hero Section - Enhanced */
    .hero-grid{
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 900px){ 
      .hero-grid{ grid-template-columns: 1fr; } 
    }
    
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(16px);
      overflow: hidden;
      position: relative;
      height: 100%;
    }
    .card .inner{ 
      padding: 28px; 
      position: relative; 
      z-index: 1; 
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .glow{
      position: absolute; 
      inset: -1px; 
      z-index: 0; 
      pointer-events: none;
      background:
        radial-gradient(700px 380px at 20% 15%, rgba(124,58,237,.20), transparent 55%),
        radial-gradient(650px 360px at 90% 30%, rgba(34,211,238,.14), transparent 55%);
      opacity: .95;
    }

    .hero-title{ 
      font-size: 36px; 
      margin: 0 0 12px; 
      letter-spacing: -.4px; 
      line-height: 1.1; 
      font-weight: 800;
    }
    .hero-title .grad{
      background: linear-gradient(90deg, rgba(255,255,255,.95), rgba(34,211,238,.85), rgba(124,58,237,.95));
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent;
    }
    .hero-desc{ 
      margin: 0 0 20px; 
      color: var(--muted); 
      font-size: 15px; 
      line-height: 1.6; 
      flex-grow: 1;
    }

    .chip-row{ 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      margin-bottom: 20px; 
    }
    .chip{ 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 14px; 
      border-radius: 999px; 
      background: rgba(255,255,255,.07); 
      border: 1px solid rgba(255,255,255,.12); 
      color: rgba(255,255,255,.86); 
      font-size: 12.5px; 
      font-weight: 500;
    }

    .meta-grid{ 
      display: grid; 
      grid-template-columns: repeat(2, minmax(0, 1fr)); 
      gap: 14px; 
      margin-bottom: 20px; 
    }
    @media (max-width: 520px){ 
      .meta-grid{ grid-template-columns: 1fr; } 
    }
    .meta{ 
      padding: 16px; 
      border-radius: 18px; 
      background: rgba(255,255,255,.06); 
      border: 1px solid rgba(255,255,255,.1); 
    }
    .meta .k{ 
      color: var(--muted2); 
      font-size: 13px; 
      font-weight: 500; 
      margin-bottom: 6px;
    }
    .meta .v{ 
      font-weight: 700; 
      font-size: 16px; 
      letter-spacing: .2px; 
      color: var(--text);
    }

    /* What to expect section */
    .info-card{
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      padding: 18px;
      margin-bottom: 20px;
    }
    .info-card .title{
      font-weight: 700; 
      font-size: 14px; 
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .info-card .content{
      color: var(--muted); 
      font-size: 13px; 
      line-height: 1.6;
    }

    /* Progress stepper - Enhanced */
    .stepper{
      padding: 20px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .stepper-top{
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .step-indicator{
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .badge{
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 13px;
      color: rgba(255,255,255,.9);
      font-weight: 600;
      white-space: nowrap;
    }
    .progress-wrap{
      width: 280px;
      max-width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow: hidden;
    }
    .progress-bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(124,58,237,.92), rgba(34,211,238,.65));
      border-radius: 999px;
      transition: width .35s var(--ease);
    }
    
    .completion-ring{
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ring-text{
      font-weight: 800;
      font-size: 14px;
      color: rgba(255,255,255,.9);
      min-width: 50px;
    }

    /* Buttons - Enhanced */
    .btn-group{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn{
      padding: 12px 20px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.9);
      cursor: pointer;
      transition: all .2s var(--ease);
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      white-space: nowrap;
    }
    .btn:hover{ 
      transform: translateY(-2px); 
      background: rgba(255,255,255,.1); 
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn.primary{ 
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,211,238,.65)); 
      border-color: rgba(255,255,255,.18); 
      box-shadow: 0 12px 32px rgba(124,58,237,.3);
      font-weight: 700;
    }
    .btn.danger{ 
      background: rgba(251,113,133,.12); 
      border-color: rgba(251,113,133,.22); 
    }
    .btn.small{ 
      padding: 10px 16px; 
      font-size: 13px; 
    }
    .btn.large{ 
      padding: 14px 24px; 
      font-size: 15px; 
    }

    /* Framework Toggles - Enhanced */
    .toggle-panel{ 
      display: flex; 
      flex-direction: column; 
      gap: 16px;
      height: 100%;
    }
    .toggle-panel .header{ 
      display: flex; 
      align-items: flex-start; 
      justify-content: space-between; 
      gap: 12px; 
    }
    .toggle-panel h3{ 
      margin: 0; 
      font-size: 16px; 
      font-weight: 700; 
      letter-spacing: .2px; 
    }
    .toggle-panel p{ 
      margin: 6px 0 0; 
      color: var(--muted); 
      font-size: 13px; 
      line-height: 1.5; 
    }
    .toggles-grid{ 
      display: grid; 
      grid-template-columns: repeat(2, minmax(0, 1fr)); 
      gap: 12px; 
    }
    @media (max-width: 520px){ 
      .toggles-grid{ grid-template-columns: 1fr; } 
    }
    .toggle-item{
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px;
      padding: 16px; 
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.1);
      transition: all .2s var(--ease);
    }
    .toggle-item:hover{ 
      transform: translateY(-2px); 
      border-color: rgba(255,255,255,.18); 
      background: rgba(255,255,255,.08);
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .toggle-item .label{ 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
    }
    .toggle-item .label .title{ 
      font-weight: 700; 
      font-size: 14px; 
    }
    .toggle-item .label .desc{ 
      color: var(--muted); 
      font-size: 12.5px; 
    }
    .switch{
      width: 52px; 
      height: 30px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      transition: all .2s var(--ease);
      flex: 0 0 auto;
    }
    .switch:before{
      content:""; 
      position: absolute; 
      top: 3px; 
      left: 3px; 
      width: 22px; 
      height: 22px; 
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      transition: transform .2s var(--ease), background .2s var(--ease);
    }
    .switch.on{ 
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(34,211,238,.55)); 
      border-color: rgba(255,255,255,.18); 
    }
    .switch.on:before{ 
      transform: translateX(22px); 
      background: rgba(255,255,255,.96); 
    }

    /* Page views */
    .page-views{ 
      margin-top: 20px; 
      position: relative; 
    }
    .view{ 
      display: none; 
      opacity: 0; 
      transform: translateY(20px); 
      transition: opacity .4s var(--ease), transform .4s var(--ease); 
    }
    .view.active{ 
      display: block; 
      opacity: 1; 
      transform: translateY(0px); 
    }

    /* Domain Grid - Enhanced */
    .domain-grid{ 
      display: grid; 
      grid-template-columns: repeat(3, minmax(0, 1fr)); 
      gap: 16px; 
      margin-top: 20px; 
    }
    @media (max-width: 980px){ 
      .domain-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } 
    }
    @media (max-width: 620px){ 
      .domain-grid{ grid-template-columns: 1fr; } 
    }
    .domain-tile{
      padding: 20px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      cursor: pointer;
      transition: all .25s var(--ease);
      position: relative;
      overflow: hidden;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .domain-tile:hover{ 
      transform: translateY(-4px); 
      border-color: rgba(255,255,255,.2); 
      background: rgba(255,255,255,.08);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }
    .domain-tile:active{ transform: translateY(-1px) scale(.99); }
    .domain-tile .title{ 
      font-weight: 800; 
      font-size: 18px; 
      letter-spacing: .2px; 
      margin-bottom: 8px; 
    }
    .domain-tile .desc{ 
      color: var(--muted); 
      font-size: 13.5px; 
      line-height: 1.5;
      flex-grow: 1;
    }
    .domain-tile .footer{ 
      margin-top: 16px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 10px; 
      color: var(--muted2); 
      font-size: 12.5px; 
    }
    .domain-tile .spark{ 
      position: absolute; 
      inset: -50%; 
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.12), transparent 55%), radial-gradient(circle at 70% 40%, rgba(124,58,237,.14), transparent 56%); 
      transform: rotate(12deg); 
      opacity: .9; 
      pointer-events: none; 
    }

    /* Question Cards - Enhanced */
    .questions-header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .questions-header .left{ 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
      flex: 1;
      min-width: 300px;
    }
    .questions-title{ 
      font-size: 22px; 
      font-weight: 800; 
      letter-spacing: -.2px; 
      margin: 0; 
    }
    .questions-subtitle{ 
      margin: 0; 
      color: var(--muted); 
      font-size: 14px; 
      line-height: 1.5; 
    }
    .questions-actions{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .capability-list{
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }
    .capability-card{
      border-radius: 20px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      padding: 20px;
      transition: all .2s var(--ease);
      position: relative;
      overflow: hidden;
    }
    .capability-card:hover{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
      box-shadow: 0 12px 32px rgba(0,0,0,.25);
    }
    .capability-header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .capability-header .main{
      flex: 1;
      min-width: 300px;
    }
    .capability-name{ 
      font-weight: 750; 
      font-size: 16px; 
      letter-spacing: .1px; 
      line-height: 1.4; 
      margin-bottom: 6px;
    }
    .capability-hint{ 
      color: var(--muted); 
      font-size: 13.5px; 
      line-height: 1.5; 
    }
    .score-indicator{
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      min-width: 140px;
      text-align: center;
    }
    
    .score-pills{ 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-bottom: 16px;
    }
    .score-pills button{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.85);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all .15s var(--ease);
      user-select: none;
      flex: 1;
      min-width: 90px;
      text-align: center;
    }
    .score-pills button:hover{ 
      transform: translateY(-2px); 
      background: rgba(255,255,255,.1); 
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 6px 16px rgba(0,0,0,.2);
    }
    .score-pills button.active{ 
      background: linear-gradient(135deg, rgba(124,58,237,.88), rgba(34,211,238,.55)); 
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 8px 20px rgba(124,58,237,.25);
      color: white;
      font-weight: 700;
    }
    
    .mapping-chips{ 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-bottom: 16px;
    }
    .mapping-chip{ 
      font-size: 11.5px; 
      padding: 6px 10px; 
      border-radius: 999px; 
      border: 1px solid rgba(255,255,255,.12); 
      background: rgba(255,255,255,.05); 
      color: rgba(255,255,255,.85); 
    }
    .mapping-chip.iso{ border-color: rgba(34,211,238,.22); }
    .mapping-chip.uae{ border-color: rgba(124,58,237,.24); }
    
    details.evidence{ 
      margin-top: 16px; 
      border-radius: 14px; 
      background: rgba(255,255,255,.045); 
      border: 1px solid rgba(255,255,255,.09); 
      padding: 14px; 
    }
    details.evidence summary{ 
      cursor: pointer; 
      color: rgba(255,255,255,.88); 
      font-weight: 650; 
      list-style: none; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 10px; 
      user-select: none; 
      font-size: 14px;
    }
    details.evidence summary::-webkit-details-marker{ display: none; }
    details.evidence p{ 
      margin: 14px 0 0; 
      color: var(--muted); 
      font-size: 13px; 
      line-height: 1.6; 
      padding-left: 4px;
    }

    /* Navigation row */
    .navigation-row{ 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      flex-wrap: wrap; 
      margin-top: 24px; 
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,.1);
    }

    /* Results Section - Enhanced */
    .results-grid{ 
      display: grid; 
      grid-template-columns: 1.1fr .9fr; 
      gap: 24px; 
      margin-top: 20px; 
    }
    @media (max-width: 980px){ 
      .results-grid{ grid-template-columns: 1fr; } 
    }

    /* KPI Row */
    .kpi-row{ 
      display: grid; 
      grid-template-columns: repeat(3, minmax(0, 1fr)); 
      gap: 16px; 
      margin-bottom: 24px; 
    }
    @media (max-width: 780px){ 
      .kpi-row{ grid-template-columns: 1fr; } 
    }
    .kpi{
      padding: 20px;
      border-radius: 20px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      position: relative;
      overflow: hidden;
      transition: all .2s var(--ease);
    }
    .kpi:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 12px 32px rgba(0,0,0,.3);
    }
    .kpi .label{ 
      color: var(--muted2); 
      font-size: 13px; 
      font-weight: 500;
      margin-bottom: 8px;
    }
    .kpi .value{ 
      margin-top: 8px; 
      font-size: 28px; 
      font-weight: 850; 
      letter-spacing: -.3px;
      line-height: 1;
    }
    .kpi .subtext{ 
      margin-top: 8px; 
      color: var(--muted); 
      font-size: 13px; 
      line-height: 1.4;
    }
    .kpi .shine{ 
      position: absolute; 
      inset: -40%; 
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.1), transparent 55%); 
      transform: rotate(10deg); 
      opacity: .9; 
      pointer-events: none; 
    }

    /* Visualizations */
    .viz-grid{ 
      display: grid; 
      grid-template-columns: 1fr 1.2fr; 
      gap: 20px; 
      margin-bottom: 24px; 
    }
    @media (max-width: 780px){ 
      .viz-grid{ grid-template-columns: 1fr; } 
    }
    .viz-card{ 
      padding: 20px; 
      border-radius: 20px; 
      background: rgba(255,255,255,.05); 
      border: 1px solid rgba(255,255,255,.12); 
    }
    .viz-title{ 
      font-weight: 900; 
      font-size: 15px; 
      margin-bottom: 16px; 
    }
    .donut-wrap{ 
      display: flex; 
      align-items: center; 
      gap: 20px; 
    }
    .donut-track{ fill: none; stroke: rgba(255,255,255,.12); stroke-width: 12; }
    .donut-fill{ fill: none; stroke: rgba(34,211,238,.85); stroke-width: 12; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 60px 60px; stroke-dasharray: 276.46; stroke-dashoffset: 276.46; transition: stroke-dashoffset .8s var(--ease); }
    .donut-text .donut-value{ font-weight: 900; font-size: 28px; letter-spacing: -.2px; line-height: 1; }
    .donut-text .donut-sub{ color: var(--muted); font-size: 13px; margin-top: 4px; }
    
    .radar{ width: 100%; height: 220px; }
    .radar-grid path, .radar-grid line, .radar-grid circle{ stroke: rgba(255,255,255,.12); fill: none; }
    .radar-poly{ fill: rgba(124,58,237,.18); stroke: rgba(124,58,237,.85); stroke-width: 2; }
    .radar-labels text{ fill: rgba(255,255,255,.80); font-size: 12px; }
    .radar-hint{ color: var(--muted); font-size: 13px; margin-top: 12px; }

    /* Domain breakdown bars */
    .bars-container{ 
      margin-top: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 14px; 
    }
    .bar-item{ 
      padding: 16px; 
      border-radius: 18px; 
      background: rgba(255,255,255,.05); 
      border: 1px solid rgba(255,255,255,.12); 
    }
    .bar-item .header{ 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      margin-bottom: 12px; 
    }
    .bar-item .name{ font-weight: 800; font-size: 15px; }
    .bar-item .value{ color: rgba(255,255,255,.86); font-weight: 800; font-size: 15px; }
    .bar-track{ 
      height: 10px; 
      background: rgba(255,255,255,.08); 
      border: 1px solid rgba(255,255,255,.12); 
      border-radius: 999px; 
      overflow: hidden; 
    }
    .bar-fill{ 
      height: 100%; 
      width: 0%; 
      background: linear-gradient(90deg, rgba(124,58,237,.92), rgba(34,211,238,.65)); 
      border-radius: 999px; 
      transition: width .5s var(--ease); 
    }

    /* Executive Insights - Enhanced */
    .executive-insights{
      padding: 24px;
      border-radius: 20px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      margin-bottom: 24px;
    }
    .executive-header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .executive-title{
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .executive-subtitle{
      color: var(--muted);
      font-size: 13.5px;
      margin-top: 4px;
    }
    
    .insight-section{
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px dashed rgba(255,255,255,.12);
    }
    .insight-section:last-child{
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .insight-section .title{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: .2px;
      margin-bottom: 12px;
      color: var(--brand2);
    }
    .insight-section .content{
      color: rgba(255,255,255,.9);
      font-size: 14px;
      line-height: 1.6;
    }
    
    .risk-distribution{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .risk-item{
      padding: 16px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      text-align: center;
    }
    .risk-item .risk-value{
      font-size: 24px;
      font-weight: 850;
      margin: 8px 0;
    }
    .risk-item.high .risk-value{ color: var(--bad); }
    .risk-item.medium .risk-value{ color: var(--warn); }
    .risk-item.low .risk-value{ color: var(--good); }
    
    .actions-list{
      margin-top: 12px;
      padding-left: 20px;
    }
    .actions-list li{
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .actions-list li:last-child{
      margin-bottom: 0;
    }

    /* Top gaps */
    .gap-list{ 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      margin-top: 16px; 
    }
    .gap-item{
      padding: 18px;
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all .2s var(--ease);
    }
    .gap-item:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .gap-item .content{ 
      display: flex; 
      flex-direction: column; 
      gap: 6px; 
      flex: 1;
    }
    .gap-item .title{ 
      font-weight: 800; 
      line-height: 1.3; 
      font-size: 14.5px;
    }
    .gap-item .meta{ 
      color: var(--muted); 
      font-size: 12.5px; 
      line-height: 1.4;
    }
    .severity{
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      min-width: 100px;
      text-align: center;
      user-select: none;
      white-space: nowrap;
    }
    .severity.high{ background: rgba(251,113,133,.16); border-color: rgba(251,113,133,.22); }
    .severity.medium{ background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.22); }
    .severity.low{ background: rgba(52,211,153,.14); border-color: rgba(52,211,153,.22); }

    /* Roadmap */
    .roadmap{ 
      margin-top: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    .roadmap-phase{ 
      padding: 20px; 
      border-radius: 18px; 
      background: rgba(255,255,255,.05); 
      border: 1px solid rgba(255,255,255,.12); 
    }
    .roadmap-phase .header{ 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px;
      margin-bottom: 16px;
    }
    .roadmap-phase .name{ 
      font-weight: 900; 
      font-size: 16px;
    }
    .roadmap-phase ul{ 
      margin: 0; 
      padding-left: 20px; 
      color: var(--muted); 
      font-size: 13px; 
      line-height: 1.6; 
    }
    .roadmap-phase ul li{ 
      margin-bottom: 8px; 
    }
    .roadmap-phase ul li:last-child{ 
      margin-bottom: 0; 
    }

    /* Toast notifications */
    .toast{
      position: fixed; 
      right: 24px; 
      bottom: 24px;
      padding: 16px 20px; 
      border-radius: 18px;
      background: rgba(10,14,26,.85);
      border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      backdrop-filter: blur(20px);
      color: rgba(255,255,255,.95);
      max-width: 400px;
      opacity: 0; 
      transform: translateY(20px);
      pointer-events: none;
      transition: opacity .3s var(--ease), transform .3s var(--ease);
      z-index: 1000;
    }
    .toast.show{ 
      opacity: 1; 
      transform: translateY(0px); 
    }
    .toast .title{ 
      font-weight: 900; 
      font-size: 14px; 
      margin-bottom: 4px;
    }
    .toast .message{ 
      color: var(--muted); 
      font-size: 13px; 
    }

    /* Analyzing overlay */
    .analyze-overlay{ 
      position: fixed; 
      inset: 0; 
      z-index: 1200; 
      display: none; 
      align-items: center; 
      justify-content: center; 
      background: rgba(5,8,16,.85); 
      backdrop-filter: blur(20px); 
    }
    .analyze-overlay.show{ 
      display: flex; 
    }
    .analyze-card{ 
      width: min(540px, calc(100% - 32px)); 
      border-radius: 24px; 
      background: rgba(255,255,255,.09); 
      border: 1px solid rgba(255,255,255,.16); 
      box-shadow: 0 40px 100px rgba(0,0,0,.65); 
      padding: 32px 28px; 
      text-align: center; 
    }
    .spinner{ 
      width: 60px; 
      height: 60px; 
      border-radius: 999px; 
      border: 4px solid rgba(255,255,255,.2); 
      border-top-color: rgba(34,211,238,.85); 
      margin: 0 auto 20px; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .analyze-title{ 
      font-weight: 900; 
      font-size: 20px; 
      margin-bottom: 8px; 
    }
    .analyze-subtitle{ 
      color: var(--muted); 
      font-size: 14px; 
      line-height: 1.5; 
      margin-bottom: 20px;
    }
    .analyze-progress{ 
      height: 10px; 
      border-radius: 999px; 
      overflow: hidden; 
      background: rgba(255,255,255,.12); 
      border: 1px solid rgba(255,255,255,.15); 
    }
    .analyze-fill{ 
      height: 100%; 
      width: 0%; 
      background: linear-gradient(90deg, rgba(124,58,237,.92), rgba(34,211,238,.65)); 
      transition: width .4s var(--ease); 
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .wrap {
        padding: 20px 16px 40px;
      }
      
      .topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
        padding: 16px;
      }
      
      .actions {
        justify-content: flex-start;
      }
      
      .hero-title {
        font-size: 28px;
      }
      
      .hero-desc {
        font-size: 14px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .card .inner {
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .hero-title {
        font-size: 24px;
      }
      
      .chip {
        padding: 6px 12px;
        font-size: 11.5px;
      }
      
      .pill {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .questions-title {
        font-size: 20px;
      }
    }

    /* Print styles */
    @media print {
      body {
        background: white !important;
        color: #111 !important;
      }
      
      .gridfx, .orb, .topbar, .no-print {
        display: none !important;
      }
      
      .card {
        background: white !important;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
        break-inside: avoid;
      }
      
      .glow, .shine, .spark {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="gridfx"></div>
  <div class="orb one"></div>
  <div class="orb two"></div>
  <div class="orb three"></div>

  <div class="wrap">
    <!-- Top Navigation -->
    <nav class="topbar no-print">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brand-text">
          <h1>Cyber Readiness Assessment Tool</h1>
          <div class="sub">ISO 27001 mapping • UAE compliance • Export-ready reports</div>
        </div>
      </div>
         <div class="actions">
        <a class="pill" href="index.html">Home</a>
        <a class="pill" href="grc-lab.html">GRC Lab</a>
        <a class="pill primary" href="cyber-readiness-tool.html">Cyber Readiness Tool</a>
        <a class="pill" href="terms.html">Terms</a>
        <a class="pill" href="https://www.youtube.com/@GRCMadeSimple" target="_blank" rel="noopener noreferrer">YouTube</a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
      <!-- Hero Section -->
      <div class="hero-grid">
        <!-- Left Card: Introduction -->
        <div class="card">
          <div class="glow"></div>
          <div class="inner">
            <h2 class="hero-title"><span class="grad">Cyber Readiness Assessment</span></h2>
            <p class="hero-desc">
              A structured cyber readiness assessment that produces practical governance outputs: 
              an overall maturity score, domain breakdown, top gaps, and a prioritized 30/60/90-day 
              improvement roadmap with ISO/IEC 27001 and optional UAE compliance mappings.
            </p>
            
            <div class="chip-row">
              <span class="chip">ISO/IEC 27001 clauses (4–10)</span>
              <span class="chip">ISO 27001:2022 Annex A mapping</span>
              <span class="chip">Optional UAE compliance layer</span>
              <span class="chip">Export JSON • Print/PDF report</span>
            </div>

            <div class="meta-grid">
              <div class="meta">
                <div class="k">Assessment style</div>
                <div class="v">Capability-based (0–4 scale)</div>
              </div>
              <div class="meta">
                <div class="k">Time to complete</div>
                <div class="v">~6–10 minutes</div>
              </div>
            </div>

            <div class="info-card">
              <div class="title">What to expect</div>
              <div class="content">
                1) Select a domain and score each capability from 0–4 based on current practice.<br/>
                2) The completion ring updates as you score capabilities.<br/>
                3) When all capabilities are scored, the tool analyzes your inputs and presents results progressively:
                maturity, domain analysis, top gaps, and a 30/60/90-day roadmap.
              </div>
            </div>

            <div class="stepper">
              <div class="stepper-top">
                <div class="step-indicator">
                  <span class="badge" id="stepBadge">Step 1/3 • Choose domain</span>
                  <div class="progress-wrap" aria-label="progress">
                    <div class="progress-bar" id="progressBar"></div>
                  </div>
                </div>
                <div class="completion-ring" aria-label="completion">
                  <svg viewBox="0 0 44 44" width="44" height="44" role="img" aria-label="Completion ring">
                    <circle class="ring-track" cx="22" cy="22" r="18"></circle>
                    <circle class="ring-fill" id="ringFill" cx="22" cy="22" r="18"></circle>
                  </svg>
                  <div class="ring-text" id="ringText">0%</div>
                </div>
              </div>
              
              <div class="btn-group">
                <button class="btn primary large" id="btnStart">
                  <span>Start Assessment</span>
                </button>
                <button class="btn large" id="btnDemo">
                  <span>Load Demo Data</span>
                </button>
              </div>
              
              <div style="margin-top: 16px; color: var(--muted); font-size: 12.5px; line-height:1.5">
                <strong>Note:</strong> This is a high-level readiness indicator, not a formal certification audit. 
                Use it to prioritize controls, evidence, and a practical implementation plan.
              </div>
            </div>
          </div>
        </div>

        <!-- Right Card: Framework Toggles -->
        <div class="card">
          <div class="glow"></div>
          <div class="inner toggle-panel">
            <div class="header">
              <div>
                <h3>Mapping Layers</h3>
                <p>Enable UAE mode for region-specific mapping chips and report sections.</p>
              </div>
              <div class="badge" id="modeBadge">ISO Mode</div>
            </div>
            
            <div class="toggles-grid" id="toggles"></div>
            
            <div style="margin-top: auto; display: flex; flex-direction: column; gap: 16px;">
              <div class="meta">
                <div class="k">Report outputs</div>
                <div class="v">Executive results • Top gaps • 30/60/90 roadmap</div>
              </div>
              <div class="meta">
                <div class="k">Assessment guidance</div>
                <div class="v">Score current practice (0–4 scale)</div>
                <div class="k" style="margin-top: 8px;">Use "Evidence" prompts to validate capability</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page Views -->
      <div class="page-views">
        <!-- View A: Domain Picker -->
        <div class="view active" id="viewDomains">
          <div class="card">
            <div class="glow"></div>
            <div class="inner">
              <div class="questions-header">
                <div class="left">
                  <h3 class="questions-title">Choose a domain</h3>
                  <p class="questions-subtitle">Each domain contains high-signal capabilities. Score honestly—this tool surfaces a real remediation roadmap.</p>
                </div>
                <div class="questions-actions">
                  <button class="btn small" id="btnBackHome">
                    <span>Back to Home</span>
                  </button>
                  <button class="btn small primary" id="btnQuickResults">
                    <span>Jump to Results</span>
                  </button>
                </div>
              </div>
              <div class="domain-grid" id="domainGrid"></div>
            </div>
          </div>
        </div>

        <!-- View B: Domain Questions -->
        <div class="view" id="viewQuestions">
          <div class="card">
            <div class="glow"></div>
            <div class="inner" id="questionsInner"></div>
          </div>
        </div>

        <!-- View C: Results -->
        <div class="view" id="viewResults">
          <div class="card">
            <div class="glow"></div>
            <div class="inner">
              <div class="questions-header">
                <div class="left">
                  <h3 class="questions-title">Executive Results</h3>
                  <p class="questions-subtitle">Boardroom-friendly insights for interviews, proposals, and portfolio demos.</p>
                </div>
                <div class="questions-actions">
                  <button class="btn small" id="btnBackDomains">
                    <span>Back to Domains</span>
                  </button>
                  <button class="btn small primary" id="btnSaveReport">
                    <span>Print / Save PDF</span>
                  </button>
                </div>
              </div>

              <div class="results-grid">
                <!-- Left Column -->
                <div>
                  <!-- KPI Row -->
                  <div class="kpi-row">
                    <div class="kpi">
                      <div class="shine"></div>
                      <div class="label">Overall maturity</div>
                      <div class="value" id="kpiOverall">0.00 / 4</div>
                      <div class="subtext" id="kpiLabel">Not started</div>
                    </div>
                    <div class="kpi">
                      <div class="shine"></div>
                      <div class="label">Focus area</div>
                      <div class="value" id="kpiFocus">—</div>
                      <div class="subtext">Fastest risk reduction</div>
                    </div>
                    <div class="kpi">
                      <div class="shine"></div>
                      <div class="label">Assessment coverage</div>
                      <div class="value" id="kpiCoverage">0 / 18</div>
                      <div class="subtext">Completion status</div>
                    </div>
                  </div>

                  <!-- Visual Summary -->
                  <div class="viz-card" style="margin-bottom: 24px;">
                    <div class="viz-title">Visual Summary</div>
                    <div class="viz-grid">
                      <div class="viz-card">
                        <div class="viz-title">Overall maturity</div>
                        <div class="donut-wrap">
                          <svg viewBox="0 0 120 120" width="120" height="120" role="img" aria-label="Overall maturity gauge">
                            <circle class="donut-track" cx="60" cy="60" r="44"></circle>
                            <circle class="donut-fill" id="donutFill" cx="60" cy="60" r="44"></circle>
                          </svg>
                          <div class="donut-text">
                            <div class="donut-value" id="donutVal">0%</div>
                            <div class="donut-sub">of 4.0</div>
                          </div>
                        </div>
                      </div>

                      <div class="viz-card">
                        <div class="viz-title">Domain radar</div>
                        <svg viewBox="0 0 260 220" class="radar" role="img" aria-label="Domain radar chart">
                          <g class="radar-grid" id="radarGrid"></g>
                          <path class="radar-poly" id="radarPoly" d=""></path>
                          <g class="radar-labels" id="radarLabels"></g>
                        </svg>
                        <div class="radar-hint">Values are normalized from 0 to 4.</div>
                      </div>
                    </div>
                  </div>

                  <!-- Domain Breakdown -->
                  <div class="viz-card" style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px;">
                      <div>
                        <div class="viz-title">Domain breakdown</div>
                        <div style="color: var(--muted); font-size: 13px; margin-top: 4px;">
                          Scores are averages (0–4). This view summarizes maturity across domains.
                        </div>
                      </div>
                      <div class="badge" id="badgeFrameworks">ISO 27001 • Annex A</div>
                    </div>
                    <div class="bars-container" id="bars"></div>
                  </div>

                  <!-- Executive Insights -->
                  <div class="executive-insights">
                    <div class="executive-header">
                      <div>
                        <div class="executive-title">Executive Insights</div>
                        <div class="executive-subtitle">Enterprise-style highlights generated from your scores (updates live).</div>
                      </div>
                      <div class="badge" id="execLiveBadge">Live • 0/18</div>
                    </div>

                    <div class="insight-section">
                      <div class="title">What to tell leadership</div>
                      <div class="content" id="execTellLeadership">—</div>
                      <div style="margin-top: 12px; color: var(--muted); font-size: 13px; line-height: 1.5;" id="execPrimaryDriver">—</div>
                    </div>

                    <div class="insight-section">
                      <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px;">
                        <div class="title">Risk signal distribution</div>
                        <div class="badge" id="execRiskBadge">High: 0 • Medium: 0 • Low: 0</div>
                      </div>
                      <div class="risk-distribution">
                        <div class="risk-item high">
                          <div class="risk-label">High</div>
                          <div class="risk-value" id="riskHigh">0</div>
                          <div class="risk-desc">Score 0–1</div>
                        </div>
                        <div class="risk-item medium">
                          <div class="risk-label">Medium</div>
                          <div class="risk-value" id="riskMed">0</div>
                          <div class="risk-desc">Score 2</div>
                        </div>
                        <div class="risk-item low">
                          <div class="risk-label">Low</div>
                          <div class="risk-value" id="riskLow">0</div>
                          <div class="risk-desc">Score 3–4</div>
                        </div>
                      </div>
                    </div>

                    <div class="insight-section">
                      <div class="title">Next best actions</div>
                      <div style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">Do these to increase maturity fastest.</div>
                      <ul class="actions-list" id="execActions"></ul>
                    </div>
                  </div>
                </div>

                <!-- Right Column -->
                <div>
                  <!-- Top Gaps -->
                  <div class="viz-card" style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px;">
                      <div>
                        <div class="viz-title">Top gaps (highest risk signal)</div>
                        <div style="color: var(--muted); font-size: 13px; margin-top: 4px;">Lowest scoring capabilities, with mappings based on your toggles.</div>
                      </div>
                      <div class="badge" id="badgeGaps">Top 6</div>
                    </div>
                    <div class="gap-list" id="gapList"></div>
                  </div>

                  <!-- Roadmap -->
                  <div class="viz-card">
                    <div class="viz-title">30 / 60 / 90 roadmap</div>
                    <div style="color: var(--muted); font-size: 13px; margin-bottom: 16px; margin-top: 4px;">
                      Auto-generated from your gaps to support planning and prioritization.
                    </div>
                    <div class="roadmap" id="roadmap"></div>
                  </div>
                </div>
              </div>

              <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,.1); color: var(--muted); font-size: 13px; line-height:1.6">
                <strong>Disclaimer:</strong> This is a high-level readiness indicator, not a formal certification audit. 
                Use it to prioritize controls, evidence, and a practical implementation plan.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
  </div>

  <!-- Analyzing Overlay -->
  <div class="analyze-overlay" id="analyzeOverlay" aria-hidden="true">
    <div class="analyze-card">
      <div class="spinner"></div>
      <div class="analyze-title">Analyzing responses</div>
      <div class="analyze-subtitle">Generating maturity scores, gap analysis, roadmap, and compliance mappings…</div>
      <div class="analyze-progress"><div class="analyze-fill" id="anFill"></div></div>
    </div>
  </div>

  <script>
    // Copy the original JavaScript functionality here
    // (The JavaScript code from the original file remains the same)
    const STORAGE_KEY = "cr_enterprise_v1_answers";
    const TOGGLES_KEY = "cr_enterprise_v1_toggles";

    const FRAMEWORKS = [
      { key: "ISO_CLAUSE", label: "ISO 27001 Clauses", desc: "Clauses 4–10 mapping", defaultOn: true, kind: "iso" },
      { key: "ISO_ANNEXA", label: "ISO 27001 Annex A", desc: "Annex A:2022 controls", defaultOn: true, kind: "iso" },
      { key: "UAE_IA", label: "UAE IA", desc: "Regional IA alignment layer", defaultOn: false, kind: "uae" },
      { key: "UAE_CSC", label: "UAE CSC", desc: "CSC policy alignment layer", defaultOn: false, kind: "uae" },
    ];

    const SCALE = [
      { v:0, label:"Not started", short:"0" },
      { v:1, label:"Initial", short:"1" },
      { v:2, label:"Developing", short:"2" },
      { v:3, label:"Managed", short:"3" },
      { v:4, label:"Optimized", short:"4" },
    ];

    const DOMAINS = [
      { key: "Govern", purpose: "Oversight, policy, risk ownership, and ISMS improvement.", questions: [
        { id:"g1", title:"Leadership-approved security policy", hint:"Is there a documented information security policy approved by top management and reviewed?", evidence:"Policy document + approval record + review cadence + communication proof (email/intranet).", mappings:[
          { fw:"ISO_CLAUSE", ref:"5.1–5.3" }, { fw:"ISO_ANNEXA", ref:"A.5.1, A.5.2" }, { fw:"UAE_IA", ref:"IA: Governance & Policy (map family)" }, { fw:"UAE_CSC", ref:"CSC: Governance policy set (map)" },
        ] },
        { id:"g2", title:"Roles, responsibilities & accountability", hint:"Are security roles defined (CISO/owner), with clear RACI and authorities?", evidence:"RACI matrix + job descriptions + committee minutes + org chart.", mappings:[
          { fw:"ISO_CLAUSE", ref:"5.3, 7.1–7.3" }, { fw:"ISO_ANNEXA", ref:"A.5.2, A.6.1" }, { fw:"UAE_IA", ref:"IA: Governance (roles/oversight)" }, { fw:"UAE_CSC", ref:"CSC: Program governance guidance" },
        ] },
        { id:"g3", title:"Risk assessment & treatment in motion", hint:"Do you run regular risk assessments, treatments, and track them in a risk register?", evidence:"Risk register + risk methodology + treatment plan + review meeting notes.", mappings:[
          { fw:"ISO_CLAUSE", ref:"6.1.2–6.1.3" }, { fw:"ISO_ANNEXA", ref:"A.5.4, A.5.7, A.5.8" }, { fw:"UAE_IA", ref:"IA: Risk management family" }, { fw:"UAE_CSC", ref:"CSC: Risk governance" },
        ] },
      ] },
      { key: "Identify", purpose: "Asset visibility, context, supplier risk, and data classification.", questions: [
        { id:"i1", title:"Asset inventory you can trust", hint:"Do you maintain an accurate inventory of devices, servers, cloud resources and SaaS?", evidence:"CMDB/asset list + ownership + classification + last updated + discovery tool output.", mappings:[
          { fw:"ISO_CLAUSE", ref:"4.1–4.4" }, { fw:"ISO_ANNEXA", ref:"A.5.9, A.5.10" }, { fw:"UAE_IA", ref:"IA: Asset management" }, { fw:"UAE_CSC", ref:"CSC: Asset visibility controls" },
        ] },
        { id:"i2", title:"Supplier / third-party security risk", hint:"Is third-party security assessed before onboarding and monitored through the lifecycle?", evidence:"Vendor due diligence checklist + contract clauses + SOC reports + periodic reviews.", mappings:[
          { fw:"ISO_CLAUSE", ref:"6.1.2, 8.1" }, { fw:"ISO_ANNEXA", ref:"A.5.19, A.5.20, A.5.21" }, { fw:"UAE_IA", ref:"IA: Third-party risk family" }, { fw:"UAE_CSC", ref:"CSC: Supplier security guidance" },
        ] },
        { id:"i3", title:"Information classification & handling", hint:"Is data classified (PII/confidential/public) with rules for storage, access and sharing?", evidence:"Classification policy + data labels + handling procedures + training evidence.", mappings:[
          { fw:"ISO_CLAUSE", ref:"8.2" }, { fw:"ISO_ANNEXA", ref:"A.5.12, A.5.13, A.5.14" }, { fw:"UAE_IA", ref:"IA: Data classification & protection" }, { fw:"UAE_CSC", ref:"CSC: Data governance controls" },
        ] },
      ] },
      { key: "Protect", purpose: "Access control, awareness, physical safeguards, cryptography.", questions: [
        { id:"p1", title:"Access control with MFA for crown jewels", hint:"Is MFA enforced for email/VPN/admin? Are privileged accounts controlled and reviewed?", evidence:"MFA enforcement report + PAM config + access reviews + joiner/mover/leaver process.", mappings:[
          { fw:"ISO_CLAUSE", ref:"6.1.3, 8.1" }, { fw:"ISO_ANNEXA", ref:"A.5.15, A.5.16, A.5.17" }, { fw:"UAE_IA", ref:"IA: Identity & access controls" }, { fw:"UAE_CSC", ref:"CSC: IAM policy controls" },
        ] },
        { id:"p2", title:"Awareness that changes behavior", hint:"Is security awareness training continuous, measured, and tied to real threats?", evidence:"Training logs + phishing simulation stats + policy acknowledgements + KPIs.", mappings:[
          { fw:"ISO_CLAUSE", ref:"7.2–7.3" }, { fw:"ISO_ANNEXA", ref:"A.6.3" }, { fw:"UAE_IA", ref:"IA: Awareness family" }, { fw:"UAE_CSC", ref:"CSC: Awareness guidance" },
        ] },
        { id:"p3", title:"Crypto & key management", hint:"Is encryption used appropriately (at rest/in transit) with key management controls?", evidence:"TLS configs + storage encryption + key rotation + KMS policies + exceptions register.", mappings:[
          { fw:"ISO_CLAUSE", ref:"8.1" }, { fw:"ISO_ANNEXA", ref:"A.8.24, A.8.25" }, { fw:"UAE_IA", ref:"IA: Cryptography family" }, { fw:"UAE_CSC", ref:"CSC: Cryptographic controls" },
        ] },
      ] },
      { key: "Detect", purpose: "Logging/monitoring, vulnerability management, threat intel use.", questions: [
        { id:"d1", title:"Centralized logging & meaningful alerts", hint:"Are key systems logging to a central platform with alerting and review cadence?", evidence:"SIEM/Wazuh/Sentinel dashboard screenshots + log sources list + alert response SLAs.", mappings:[
          { fw:"ISO_CLAUSE", ref:"9.1" }, { fw:"ISO_ANNEXA", ref:"A.8.15, A.8.16" }, { fw:"UAE_IA", ref:"IA: Monitoring & logging family" }, { fw:"UAE_CSC", ref:"CSC: Monitoring controls" },
        ] },
        { id:"d2", title:"Vulnerability management rhythm", hint:"Are vulnerabilities discovered, prioritized, remediated, and verified on a schedule?", evidence:"Scan reports + remediation tickets + SLA policy + exception process + trend metrics.", mappings:[
          { fw:"ISO_CLAUSE", ref:"8.1" }, { fw:"ISO_ANNEXA", ref:"A.8.8, A.8.9" }, { fw:"UAE_IA", ref:"IA: Vulnerability management family" }, { fw:"UAE_CSC", ref:"CSC: Vulnerability controls" },
        ] },
        { id:"d3", title:"Threat intelligence in practice", hint:"Is threat intel collected and converted into detections, hardening, or controls?", evidence:"Intel sources + detection rules updates + blocklists + lessons learned entries.", mappings:[
          { fw:"ISO_CLAUSE", ref:"5.1, 9.1" }, { fw:"ISO_ANNEXA", ref:"A.5.7, A.8.7" }, { fw:"UAE_IA", ref:"IA: Threat intelligence family" }, { fw:"UAE_CSC", ref:"CSC: Threat intel programs" },
        ] },
      ] },
      { key: "Respond", purpose: "IR plan, reporting, evidence, lessons learned.", questions: [
        { id:"r1", title:"Incident response plan & comms", hint:"Do you have an IR plan with roles, escalation, and internal/external comms templates?", evidence:"IR playbook + contact lists + comms templates + escalation matrix + tabletop records.", mappings:[
          { fw:"ISO_CLAUSE", ref:"6.1.3, 8.1, 9.1" }, { fw:"ISO_ANNEXA", ref:"A.5.24–A.5.27" }, { fw:"UAE_IA", ref:"IA: Incident management family" }, { fw:"UAE_CSC", ref:"CSC: Incident response guidance" },
        ] },
        { id:"r2", title:"Evidence handling & forensics readiness", hint:"Can you collect/retain evidence legally and consistently during incidents?", evidence:"Log retention policy + evidence handling SOP + chain-of-custody template + storage location.", mappings:[
          { fw:"ISO_CLAUSE", ref:"7.5, 9.1" }, { fw:"ISO_ANNEXA", ref:"A.5.28" }, { fw:"UAE_IA", ref:"IA: Forensics/evidence family" }, { fw:"UAE_CSC", ref:"CSC: Forensics policy" },
        ] },
        { id:"r3", title:"Post-incident improvement loop", hint:"Do you document lessons learned and convert them into control improvements?", evidence:"Postmortems + actions register + control updates + KPI trend improvement.", mappings:[
          { fw:"ISO_CLAUSE", ref:"10.1–10.2" }, { fw:"ISO_ANNEXA", ref:"A.5.27, A.5.36" }, { fw:"UAE_IA", ref:"IA: Continuous improvement family" }, { fw:"UAE_CSC", ref:"CSC: Improvement guidance" },
        ] },
      ] },
      { key: "Recover", purpose: "Backups, restore testing, BC/DR readiness, redundancy.", questions: [
        { id:"rc1", title:"Backups with restore testing", hint:"Are backups performed AND restore-tested routinely (not just 'backup jobs succeeded')?", evidence:"Backup policy + restore test results + RPO/RTO targets + offsite/immutable config.", mappings:[
          { fw:"ISO_CLAUSE", ref:"8.3" }, { fw:"ISO_ANNEXA", ref:"A.8.13" }, { fw:"UAE_IA", ref:"IA: Backup & resilience family" }, { fw:"UAE_CSC", ref:"CSC: Resilience policy" },
        ] },
        { id:"rc2", title:"BCP/DR plan you can execute", hint:"Is there a tested BCP/DR plan covering people/process/technology and dependencies?", evidence:"BCP/DR docs + test reports + recovery runbooks + dependency maps.", mappings:[
          { fw:"ISO_CLAUSE", ref:"8.3, 9.1" }, { fw:"ISO_ANNEXA", ref:"A.5.29, A.5.30" }, { fw:"UAE_IA", ref:"IA: Business continuity family" }, { fw:"UAE_CSC", ref:"CSC: Continuity guidance" },
        ] },
        { id:"rc3", title:"Redundancy for critical services", hint:"Are critical systems architected with redundancy to meet RTO/RPO and availability targets?", evidence:"Architecture diagrams + HA configs + failover tests + SLA commitments.", mappings:[
          { fw:"ISO_CLAUSE", ref:"8.1, 8.3" }, { fw:"ISO_ANNEXA", ref:"A.8.14" }, { fw:"UAE_IA", ref:"IA: Availability & resilience family" }, { fw:"UAE_CSC", ref:"CSC: Availability controls" },
        ] },
      ] },
    ];

    const state = {
      toggles: loadToggles(),
      answers: loadAnswers(),
      view: "domains",
      activeDomain: null,
    };

    function loadToggles(){
      try{ const raw = localStorage.getItem(TOGGLES_KEY); if(raw) return JSON.parse(raw); }catch(e){}
      const t = {}; for(const f of FRAMEWORKS) t[f.key] = f.defaultOn; return t;
    }
    function saveToggles(){ localStorage.setItem(TOGGLES_KEY, JSON.stringify(state.toggles)); }

    function loadAnswers(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw); }catch(e){}
      return {};
    }
    function saveAnswers(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.answers));
      updateAnsweredBadge();
    }

    function toast(title, message=""){
      const el = document.getElementById("toast");
      el.innerHTML = `<div class="title">${escapeHtml(title)}</div>` + (message ? `<div class="message">${escapeHtml(message)}</div>`:"");
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove("show"), 2800);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function clamp(v){
      v = Number(v); if(Number.isNaN(v)) return 0;
      return Math.max(0, Math.min(4, Math.round(v)));
    }

    function visibleMappings(mappings){
      return (mappings || []).filter(m => state.toggles[m.fw]);
    }

    function allQuestionIds(){
      const ids = [];
      for(const d of DOMAINS) for(const q of d.questions) ids.push(q.id);
      return ids;
    }
    function answeredCount(){ return Object.keys(state.answers).length; }
    function isComplete(){ return answeredCount() >= allQuestionIds().length; }

    function updateAnsweredBadge(){
      const total = allQuestionIds().length;
      const done = answeredCount();
      const hint = document.getElementById("saveHint");
      if(hint) hint.textContent = `${done} / ${total} answered`;

      const pct = total ? Math.round((done/total)*100) : 0;
      const ringText = document.getElementById("ringText");
      if(ringText) ringText.textContent = `${pct}%`;

      const ring = document.getElementById("ringFill");
      if(ring){
        const C = 2 * Math.PI * 18;
        ring.style.strokeDasharray = C.toFixed(2);
        ring.style.strokeDashoffset = (C * (1 - pct/100)).toFixed(2);
      }

      if(state.view === "questions"){
        const bar = document.getElementById("progressBar");
        if(bar){
          const base = 25; const span = 60;
          bar.style.width = (base + span*(pct/100)) + "%";
        }
      }
    }

    function currentFrameworkLabel(){
      const iso = [];
      if(state.toggles.ISO_CLAUSE) iso.push("ISO 27001");
      if(state.toggles.ISO_ANNEXA) iso.push("Annex A");
      const uae = [];
      if(state.toggles.UAE_IA) uae.push("UAE IA");
      if(state.toggles.UAE_CSC) uae.push("UAE CSC");
      const left = iso.length ? iso.join(" • ") : "No ISO mapping";
      const right = uae.length ? (" + " + uae.join(" • ")) : "";
      return left + right;
    }

    function modeBadgeText(){
      const uaeOn = !!(state.toggles.UAE_IA || state.toggles.UAE_CSC);
      return uaeOn ? "UAE Mode" : "ISO Mode";
    }

    function renderToggles(){
      const root = document.getElementById("toggles");
      root.innerHTML = "";
      for(const f of FRAMEWORKS){
        const row = document.createElement("div"); 
        row.className = "toggle-item";
        
        const sw = document.createElement("div");
        sw.className = "switch" + (state.toggles[f.key] ? " on" : "");
        sw.setAttribute("role","switch");
        sw.setAttribute("aria-checked", state.toggles[f.key] ? "true" : "false");
        sw.addEventListener("click", ()=>{
          state.toggles[f.key] = !state.toggles[f.key];
          saveToggles();
          renderToggles();
          const badge = document.getElementById("modeBadge"); 
          badge.textContent = modeBadgeText();
          const _bf = document.getElementById("badgeFrameworks"); 
          if (_bf) _bf.textContent = currentFrameworkLabel();
          toast("Updated mappings", currentFrameworkLabel());
          if(state.view === "questions") renderQuestions(state.activeDomain);
          if(state.view === "results") renderResults();
        });
        
        row.innerHTML = `
          <div class="label">
            <div class="title">${escapeHtml(f.label)}</div>
            <div class="desc">${escapeHtml(f.desc)}</div>
          </div>
        `;
        row.appendChild(sw);
        root.appendChild(row);
      }
      document.getElementById("modeBadge").textContent = modeBadgeText();
    }

    function setStep(stepIndex){
      const badge = document.getElementById("stepBadge");
      const bar = document.getElementById("progressBar");
      const map = {
        1:"Step 1/3 • Choose domain", 
        2:"Step 2/3 • Score capabilities", 
        3:"Step 3/3 • Executive results"
      };
      badge.textContent = map[stepIndex] || "Step";
      const pct = stepIndex === 1 ? 25 : stepIndex === 2 ? 65 : 100;
      bar.style.width = pct + "%";
    }

    function switchView(which){
      const views = { 
        domains: "viewDomains", 
        questions:"viewQuestions", 
        results:"viewResults" 
      };
      
      for(const k of Object.keys(views)){
        const el = document.getElementById(views[k]); 
        if(el) el.classList.remove("active");
      }
      
      state.view = which;
      const el = document.getElementById(views[which]); 
      el.classList.add("active");
      
      if(which === "domains") setStep(1);
      if(which === "questions") setStep(2);
      if(which === "results") setStep(3);
      
      const _bf = document.getElementById("badgeFrameworks"); 
      if (_bf) _bf.textContent = currentFrameworkLabel();
      
      // Scroll to top when switching views
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function analyzeAndShowResults(){
      const overlay = document.getElementById("analyzeOverlay");
      const fill = document.getElementById("anFill");
      if(overlay){ 
        overlay.classList.add("show"); 
        overlay.setAttribute("aria-hidden","false"); 
      }
      
      if(fill){
        fill.style.width = "0%";
        setTimeout(()=> fill.style.width = "30%", 150);
        setTimeout(()=> fill.style.width = "65%", 1700);
        setTimeout(()=> fill.style.width = "88%", 3800);
        setTimeout(()=> fill.style.width = "100%", 5600);
      }
      
      setTimeout(()=>{
        if(overlay){ 
          overlay.classList.remove("show"); 
          overlay.setAttribute("aria-hidden","true"); 
        }
        switchView("results"); 
        renderResults(); 
      }, 6000);
    }

    function renderDomains(){
      const grid = document.getElementById("domainGrid"); 
      grid.innerHTML = "";
      
      for(const d of DOMAINS){
        const tile = document.createElement("div"); 
        tile.className = "domain-tile";
        const done = d.questions.filter(q => state.answers[q.id] !== undefined).length;
        
        tile.innerHTML = `
          <div class="spark"></div>
          <div>
            <div class="title">${escapeHtml(d.key)}</div>
            <div class="desc">${escapeHtml(d.purpose)}</div>
          </div>
          <div class="footer">
            <span>${done} / ${d.questions.length} scored</span>
            <span style="display:flex;align-items:center;gap:6px;">
              Open <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </span>
          </div>
        `;
        
        tile.addEventListener("click", ()=>{
          state.activeDomain = d.key;
          renderQuestions(d.key);
          switchView("questions");
          toast(`Opening ${d.key}`, "Score capabilities (0–4). Evidence hints included.");
        });
        
        grid.appendChild(tile);
      }
    }

    function maturityLabel(score){
      if(score < 0.8) return "Not started";
      if(score < 1.6) return "Initial";
      if(score < 2.4) return "Developing";
      if(score < 3.2) return "Managed";
      return "Optimized";
    }

    function domainAverages(){
      const avgs = {};
      for(const d of DOMAINS){
        let sum = 0, count = 0;
        for(const q of d.questions){
          if(state.answers[q.id] !== undefined){
            sum += clamp(state.answers[q.id]);
            count += 1;
          }
        }
        avgs[d.key] = count ? +(sum / count).toFixed(2) : 0;
      }
      return avgs;
    }

    function overallAverage(){
      const ids = allQuestionIds();
      let sum = 0, count = 0;
      for(const id of ids){
        if(state.answers[id] !== undefined){
          sum += clamp(state.answers[id]);
          count += 1;
        }
      }
      return count ? +(sum / count).toFixed(2) : 0;
    }

    function topGaps(n=6){
      const items = [];
      for(const d of DOMAINS){
        for(const q of d.questions){
          const s = state.answers[q.id] !== undefined ? clamp(state.answers[q.id]) : 0;
          items.push({ domain: d.key, ...q, score: s });
        }
      }
      items.sort((a,b)=> a.score - b.score);
      return items.slice(0,n);
    }

    function severity(score){
      if(score <= 1) return {cls:"high", label:"High gap"};
      if(score === 2) return {cls:"medium", label:"Medium gap"};
      return {cls:"low", label:"Low gap"};
    }

    function uniq(arr){
      const out = []; const s = new Set();
      for(const a of arr){
        const k = a.toLowerCase();
        if(!s.has(k)){ s.add(k); out.push(a); }
      }
      return out;
    }

    function roadmapFromGaps(gaps){
      const phase = (title, desc, bullets)=> ({name: title, desc, bullets});
      const bullets30 = [];
      const bullets60 = [];
      const bullets90 = [];
      
      for(const g of gaps){
        if(g.score <= 1){
          bullets30.push(`${g.title}: create baseline policy/process + collect minimum evidence.`);
          bullets60.push(`${g.title}: implement control + assign ownership + define SLAs/metrics.`);
          bullets90.push(`${g.title}: automate monitoring + measure effectiveness + improve continuously.`);
        }else if(g.score === 2){
          bullets30.push(`${g.title}: define SOP and close obvious gaps.`);
          bullets60.push(`${g.title}: expand coverage + train stakeholders + start KPI tracking.`);
          bullets90.push(`${g.title}: integrate with SIEM/ITSM + periodic control testing.`);
        }else{
          bullets30.push(`${g.title}: validate and document existing practice.`);
          bullets60.push(`${g.title}: standardize and tighten evidence collection.`);
          bullets90.push(`${g.title}: optimize and benchmark against peers.`);
        }
      }
      
      return [
        phase("30 Days — Stabilize", "Get control owners, minimum evidence, and quick wins.", uniq(bullets30).slice(0,6)),
        phase("60 Days — Implement", "Build repeatable processes and close medium gaps.", uniq(bullets60).slice(0,6)),
        phase("90 Days — Optimize", "Automation, continuous improvement, and audit readiness.", uniq(bullets90).slice(0,6)),
      ];
    }

    function pctFromOverall(overall){
      return Math.round((overall / 4) * 100);
    }

    function findPrimaryRiskDriver(){
      let best = null;
      for(const d of DOMAINS){
        for(const q of d.questions){
          const s = state.answers[q.id] !== undefined ? clamp(state.answers[q.id]) : 0;
          if(!best || s < best.score){
            best = { domain: d.key, id: q.id, title: q.title, score: s };
          }
        }
      }
      return best;
    }

    function buildExecutiveInsightsPlus(){
      const total = allQuestionIds().length;
      const done = answeredCount();
      const overall = overallAverage();
      const pct = pctFromOverall(overall);
      const label = maturityLabel(overall);
      const avgs = domainAverages();

      let weakest = "—", strongest = "—";
      let min = 999, max = -1;
      for(const [k,v] of Object.entries(avgs)){
        if(v < min){ min = v; weakest = k; }
        if(v > max){ max = v; strongest = k; }
      }

      const driver = findPrimaryRiskDriver();
      const focusDomain = weakest;

      // Risk signal distribution
      const gaps = topGaps(6);
      let hi = 0, med = 0, low = 0;
      for(const g of gaps){
        if(g.score <= 1) hi++;
        else if(g.score === 2) med++;
        else low++;
      }

      const tellLeadership = `Overall posture: ${label} (${pct}%). Strongest domain: ${strongest}. Biggest exposure: ${weakest}.`;
      const primaryDriver = driver ? `Primary risk driver: "${driver.title}" in ${driver.domain}. Focus on ${focusDomain} for fastest risk reduction.` : `Primary risk driver: —`;

      // Next best actions
      const actions = [];
      if(driver){
        actions.push(`Close "${driver.title}" with a minimum evidence pack (policy/SOP + owner + review cadence).`);
      }else{
        actions.push(`Close your lowest scoring capability with a minimum evidence pack (policy/SOP + owner + review cadence).`);
      }
      actions.push(`Run a 30-day sprint in ${focusDomain}: assign owners, define SLAs, and track evidence in one place.`);
      actions.push(`For interviews/audits: export JSON + print the PDF and use the "Top gaps" as your narrative.`);

      return {
        liveBadge: (done >= total) ? `Final • ${done}/${total}` : `Live • ${done}/${total}`,
        tellLeadership,
        primaryDriver,
        risk: { hi, med, low },
        actions
      };
    }

    function renderQuestions(domainKey){
      const dom = DOMAINS.find(d => d.key === domainKey);
      const root = document.getElementById("questionsInner");
      if(!dom){ root.innerHTML = ""; return; }

      const answered = dom.questions.filter(q => state.answers[q.id] !== undefined).length;
      root.innerHTML = `
        <div class="questions-header">
          <div class="left">
            <h3 class="questions-title">${escapeHtml(dom.key)} — Capabilities</h3>
            <p class="questions-subtitle">${escapeHtml(dom.purpose)} • ${answered}/${dom.questions.length} scored</p>
          </div>
          <div class="questions-actions">
            <span class="badge">${escapeHtml(currentFrameworkLabel())}</span>
            <button class="btn small" id="btnBackDomains2">Back to Domains</button>
            <button class="btn small primary" id="btnToResults">View Results</button>
          </div>
        </div>
        <div class="capability-list" id="qList"></div>
        <div class="navigation-row">
          <button class="btn" id="btnPrevDomain">Previous Domain</button>
          <div class="btn-group">
            <button class="btn danger" id="btnClearDomain">Clear Domain Scores</button>
            <button class="btn primary" id="btnNextDomain">Next Domain</button>
          </div>
        </div>
      `;

      const qList = root.querySelector("#qList");
      for(const q of dom.questions){
        const cap = document.createElement("div"); 
        cap.className = "capability-card";
        const score = state.answers[q.id] !== undefined ? clamp(state.answers[q.id]) : null;
        const visMaps = visibleMappings(q.mappings);

        const mapHtml = visMaps.length ? `
          <div class="mapping-chips">${
            visMaps.map(m=>{
              const kind = (m.fw.startsWith("UAE")) ? "uae" : "iso";
              const label = m.fw === "ISO_CLAUSE" ? "ISO Clause" : m.fw === "ISO_ANNEXA" ? "Annex A" : m.fw === "UAE_IA" ? "UAE IA" : "UAE CSC";
              return `<span class="mapping-chip ${kind}">${escapeHtml(label)}: ${escapeHtml(m.ref)}</span>`;
            }).join("")
          }</div>
        ` : `<div class="mapping-chips"><span class="mapping-chip iso">Mappings hidden — enable a layer above</span></div>`;

        cap.innerHTML = `
          <div class="capability-header">
            <div class="main">
              <div class="capability-name">${escapeHtml(q.title)}</div>
              <div class="capability-hint">${escapeHtml(q.hint)}</div>
            </div>
            <div class="score-indicator">${score === null ? "Not scored" : ("Score: " + score + " • " + SCALE[score].label)}</div>
          </div>
          <div class="score-pills" role="radiogroup" aria-label="score ${escapeHtml(q.title)}">
            ${SCALE.map(s=> `<button data-q="${q.id}" data-v="${s.v}" class="${(score===s.v) ? "active":""}">${s.label}</button>`).join("")}
          </div>
          ${mapHtml}
          <details class="evidence">
            <summary>
              <span>Evidence that proves this (what an auditor/recruiter expects)</span>
              <span style="color: var(--muted); font-size:12px;">Expand</span>
            </summary>
            <p>${escapeHtml(q.evidence)}</p>
          </details>
        `;

        cap.querySelectorAll("button[data-q]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-q");
            const v = clamp(btn.getAttribute("data-v"));
            state.answers[id] = v;
            saveAnswers();
            
            // Add visual feedback
            cap.animate([
              {transform:"translateY(0px)"},
              {transform:"translateY(-4px)"},
              {transform:"translateY(0px)"}
            ], {duration: 300, easing: "cubic-bezier(.2,.8,.2,1)"});
            
            toast("Saved", `${q.title} → ${v} (${SCALE[v].label})`);
            renderQuestions(domainKey);
            renderDomains();

            // Live update executive insights if user is on results view
            if(state.view === "results"){
              renderResults();
            }
          });
        });

        qList.appendChild(cap);
      }

      root.querySelector("#btnBackDomains2").addEventListener("click", ()=>{ switchView("domains"); });
      root.querySelector("#btnToResults").addEventListener("click", ()=>{ switchView("results"); renderResults(); });

      const idx = DOMAINS.findIndex(d => d.key === domainKey);
      root.querySelector("#btnPrevDomain").addEventListener("click", ()=>{
        const prev = DOMAINS[(idx - 1 + DOMAINS.length) % DOMAINS.length].key;
        state.activeDomain = prev; 
        renderQuestions(prev); 
        toast("Previous domain", prev);
      });
      
      root.querySelector("#btnNextDomain").addEventListener("click", ()=>{
        const next = DOMAINS[(idx + 1) % DOMAINS.length].key;
        state.activeDomain = next; 
        renderQuestions(next); 
        toast("Next domain", next);
      });
      
      root.querySelector("#btnClearDomain").addEventListener("click", ()=>{
        for(const q of dom.questions) delete state.answers[q.id];
        saveAnswers(); 
        renderQuestions(domainKey); 
        renderDomains();
        toast("Cleared", `${dom.key} scores removed`);
      });
    }

    function updateVisuals(){
      const overall = overallAverage();
      const pct = Math.round((overall/4) * 100);

      const donutVal = document.getElementById("donutVal");
      if(donutVal) donutVal.textContent = `${pct}%`;

      const donutFill = document.getElementById("donutFill");
      if(donutFill){
        const C = 2 * Math.PI * 44;
        donutFill.style.strokeDasharray = C.toFixed(2);
        donutFill.style.strokeDashoffset = (C * (1 - pct/100)).toFixed(2);
      }

      const avgs = domainAverages();
      const order = ["Govern","Identify","Protect","Detect","Respond","Recover"];
      const values = order.map(k => (avgs[k] ?? 0));
      buildRadar(order, values);
    }

    function buildRadar(labels, values){
      const grid = document.getElementById("radarGrid");
      const poly = document.getElementById("radarPoly");
      const labs = document.getElementById("radarLabels");
      if(!grid || !poly || !labs) return;

      grid.innerHTML = ""; 
      labs.innerHTML = "";
      const cx = 130, cy = 110; 
      const maxR = 80; 
      const N = labels.length;

      // Create concentric circles
      for(let r=1; r<=4; r++){
        const rr = (maxR * r/4);
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", cx); 
        c.setAttribute("cy", cy); 
        c.setAttribute("r", rr);
        c.setAttribute("class", "radar-grid");
        grid.appendChild(c);
      }

      // Create axes
      for(let i=0; i<N; i++){
        const a = (-Math.PI/2) + (2*Math.PI*i/N);
        const x = cx + maxR*Math.cos(a);
        const y = cy + maxR*Math.sin(a);

        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", cx); 
        line.setAttribute("y1", cy); 
        line.setAttribute("x2", x); 
        line.setAttribute("y2", y);
        line.setAttribute("class", "radar-grid");
        grid.appendChild(line);

        // Labels
        const tx = cx + (maxR+24)*Math.cos(a);
        const ty = cy + (maxR+24)*Math.sin(a);

        const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t.textContent = labels[i];
        t.setAttribute("x", tx); 
        t.setAttribute("y", ty);
        t.setAttribute("text-anchor", "middle");
        t.setAttribute("dominant-baseline", "middle");
        t.setAttribute("class", "radar-labels");
        labs.appendChild(t);
      }

      // Create polygon
      const pts = values.map((v,i)=>{
        const nv = Math.max(0, Math.min(4, v))/4;
        const a = (-Math.PI/2) + (2*Math.PI*i/N);
        const rr = maxR * nv;
        return [cx + rr*Math.cos(a), cy + rr*Math.sin(a)];
      });

      const d = "M " + pts.map(p=> `${p[0].toFixed(1)} ${p[1].toFixed(1)}`).join(" L ") + " Z";
      poly.setAttribute("d", d);
    }

    function renderResults(){
      updateAnsweredBadge();
      const total = allQuestionIds().length;
      const done = answeredCount();
      const overall = overallAverage();
      const avgs = domainAverages();
      const label = maturityLabel(overall);

      // Update KPIs
      document.getElementById("kpiOverall").textContent = `${overall.toFixed(2)} / 4`;
      document.getElementById("kpiLabel").textContent = label;
      document.getElementById("kpiCoverage").textContent = `${done} / ${total}`;

      let focus = "—"; 
      let min = 999;
      for(const [k,v] of Object.entries(avgs)){
        if(v < min){ min = v; focus = k; }
      }
      document.getElementById("kpiFocus").textContent = focus;

      // Update framework badge
      const fwLabel = currentFrameworkLabel();
      const badge = document.getElementById("badgeFrameworks");
      if(badge) badge.textContent = fwLabel;

      // Update domain breakdown bars
      const bars = document.getElementById("bars"); 
      bars.innerHTML = "";
      for(const d of DOMAINS){
        const v = avgs[d.key] ?? 0;
        const bar = document.createElement("div"); 
        bar.className = "bar-item";
        bar.innerHTML = `
          <div class="header">
            <div class="name">${escapeHtml(d.key)}</div>
            <div class="value">${v.toFixed(2)} / 4</div>
          </div>
          <div class="bar-track"><div class="bar-fill" style="width:${(v/4)*100}%"></div></div>
        `;
        bars.appendChild(bar);
      }

      // Update top gaps
      const gaps = topGaps(6);
      const gapList = document.getElementById("gapList"); 
      gapList.innerHTML = "";
      for(const g of gaps){
        const sev = severity(g.score);
        const maps = visibleMappings(g.mappings);
        const mapText = maps.length ? maps.map(m => {
          const label = m.fw === "ISO_CLAUSE" ? "ISO Clause" : m.fw === "ISO_ANNEXA" ? "Annex A" : m.fw === "UAE_IA" ? "UAE IA" : "UAE CSC";
          return `${label} ${m.ref}`;
        }).join(" • ") : "Mappings hidden (enable a layer)";

        const item = document.createElement("div"); 
        item.className = "gap-item";
        item.innerHTML = `
          <div class="content">
            <div class="title">${escapeHtml(g.title)}</div>
            <div class="meta">${escapeHtml(g.domain)} • ${escapeHtml(mapText)}</div>
          </div>
          <div class="severity ${sev.cls}">${sev.label}</div>
        `;
        item.addEventListener("click", ()=>{
          state.activeDomain = g.domain;
          renderQuestions(g.domain);
          switchView("questions");
          toast("Jumped to gap", g.title);
        });
        gapList.appendChild(item);
      }

      // Update roadmap
      const rm = roadmapFromGaps(gaps);
      const roadmap = document.getElementById("roadmap");
      roadmap.innerHTML = "";
      for(const p of rm){
        const div = document.createElement("div"); 
        div.className = "roadmap-phase";
        div.innerHTML = `
          <div class="header">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="badge">${escapeHtml(p.desc)}</div>
          </div>
          <ul>${p.bullets.map(b=> `<li>${escapeHtml(b)}</li>`).join("")}</ul>
        `;
        roadmap.appendChild(div);
      }

      // Update visuals
      updateVisuals();

      // Update Executive Insights
      const ex = buildExecutiveInsightsPlus();
      const liveBadge = document.getElementById("execLiveBadge");
      const tell = document.getElementById("execTellLeadership");
      const driver = document.getElementById("execPrimaryDriver");
      const riskBadge = document.getElementById("execRiskBadge");
      const riskH = document.getElementById("riskHigh");
      const riskM = document.getElementById("riskMed");
      const riskL = document.getElementById("riskLow");
      const actions = document.getElementById("execActions");

      if(liveBadge) liveBadge.textContent = ex.liveBadge;
      if(tell) tell.textContent = ex.tellLeadership;
      if(driver) driver.textContent = ex.primaryDriver;
      if(riskH) riskH.textContent = String(ex.risk.hi);
      if(riskM) riskM.textContent = String(ex.risk.med);
      if(riskL) riskL.textContent = String(ex.risk.low);
      if(riskBadge) riskBadge.textContent = `High: ${ex.risk.hi} • Medium: ${ex.risk.med} • Low: ${ex.risk.low}`;
      if(actions){
        actions.innerHTML = ex.actions.map(x => `<li>${escapeHtml(x)}</li>`).join("");
      }
    }

    function exportJSON(){
      const payload = {
        tool: "Cyber Readiness & GRC Assessment (Enterprise Static)",
        version: "1.0.0-enterprise",
        generatedAt: new Date().toISOString(),
        frameworkToggles: state.toggles,
        summary: {
          overall: overallAverage(),
          maturity: maturityLabel(overallAverage()),
          coverage: { answered: answeredCount(), total: allQuestionIds().length },
          domainAverages: domainAverages(),
        },
        answers: state.answers,
        topGaps: topGaps(10).map(g => ({
          id: g.id,
          domain: g.domain,
          title: g.title,
          score: g.score,
          evidence: g.evidence,
          mappings: visibleMappings(g.mappings),
        })),
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); 
      a.href = url; 
      a.download = "cyber-readiness-assessment-results.json"; 
      a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 600);
      toast("Exported", "JSON file downloaded");
    }

    function resetAll(){
      if(!confirm("Reset all answers and settings to default?")) return;
      state.answers = {};
      state.toggles = (()=>{ const t={}; for(const f of FRAMEWORKS) t[f.key]=f.defaultOn; return t; })();
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(TOGGLES_KEY);
      renderToggles(); 
      renderDomains(); 
      updateAnsweredBadge();
      switchView("domains");
      toast("Reset complete", "All data cleared");
    }

    function loadDemo(){
      const ids = allQuestionIds();
      // Create realistic demo data with varying scores
      const demoPattern = [0, 1, 2, 3, 4, 2, 1, 3, 4, 2, 0, 1, 3, 4, 2, 1, 3, 2];
      
      for(let i=0; i<ids.length; i++){
        state.answers[ids[i]] = demoPattern[i] || 2;
      }
      saveAnswers(); 
      renderDomains();
      toast("Demo loaded", "Realistic scores populated for showcase");
    }

    function bindTopControls(){
      document.getElementById("btnExportJson").addEventListener("click", exportJSON);

      document.getElementById("btnPrint").addEventListener("click", ()=> {
        switchView("results"); 
        renderResults();
        document.body.classList.add("print-report");
        window.scrollTo(0,0);
        setTimeout(()=> {
          window.print();
          setTimeout(()=> document.body.classList.remove("print-report"), 800);
        }, 250);
      });

      document.getElementById("btnReset").addEventListener("click", resetAll);

      document.getElementById("btnGoResults").addEventListener("click", ()=>{ 
        if(isComplete()){
          analyzeAndShowResults();
        } else {
          switchView("results"); 
          renderResults();
          toast("Live insights", "Complete all capabilities to generate the full final report.");
        }
      });

      document.getElementById("btnStart").addEventListener("click", ()=>{ 
        switchView("domains"); 
        renderDomains(); 
        toast("Assessment started", "Pick a domain to begin"); 
      });
      
      document.getElementById("btnDemo").addEventListener("click", loadDemo);

      document.getElementById("btnBackHome").addEventListener("click", ()=>{ 
        switchView("domains"); 
        window.scrollTo({top:0, behavior:"smooth"}); 
      });
      
      document.getElementById("btnQuickResults").addEventListener("click", ()=>{ 
        if(isComplete()){
          analyzeAndShowResults();
        } else {
          switchView("results"); 
          renderResults();
          toast("Live insights", "Complete all capabilities to generate the full final report.");
        }
      });

      document.getElementById("btnBackDomains").addEventListener("click", ()=>{ 
        switchView("domains"); 
        renderDomains(); 
      });

      document.getElementById("btnSaveReport").addEventListener("click", ()=> {
        switchView("results"); 
        renderResults();
        document.body.classList.add("print-report");
        window.scrollTo(0,0);
        setTimeout(()=> {
          window.print();
          setTimeout(()=> document.body.classList.remove("print-report"), 800);
        }, 250);
      });
    }

    function init(){
      renderToggles();
      renderDomains();
      updateAnsweredBadge();
      const _bf = document.getElementById("badgeFrameworks"); 
      if (_bf) _bf.textContent = currentFrameworkLabel();
      bindTopControls();
      setStep(1);
    }

    // Initialize the application
    init();
  </script>
</body>
</html>
