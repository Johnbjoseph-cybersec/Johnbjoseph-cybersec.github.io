

<!DOCTYPE html>

<html lang="en">
<head>
<title>GRC Practice Lab – John Bommeraveni Joseph</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<!-- Theme CSS from your site -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="css/open-iconic-bootstrap.min.css" rel="stylesheet"/>
<link href="css/animate.css" rel="stylesheet"/>
<link href="css/owl.carousel.min.css" rel="stylesheet"/>
<link href="css/owl.theme.default.min.css" rel="stylesheet"/>
<link href="css/magnific-popup.css" rel="stylesheet"/>
<link href="css/aos.css" rel="stylesheet"/>
<link href="css/ionicons.min.css" rel="stylesheet"/>
<link href="css/flaticon.css" rel="stylesheet"/>
<link href="css/icomoon.css" rel="stylesheet"/>
<link href="css/style.css" rel="stylesheet"/>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { background-color: #0a0e17; color: #e5e7eb; font-family: 'Manrope', sans-serif; }
    .ftco-animate{opacity:1!important;visibility:visible!important;}
    .grc-lab-hero{padding-top:26px;padding-bottom:40px; background: linear-gradient(to bottom, #0a0e17, #1a1f2e);}
    .grc-tab-buttons .btn{margin-right:8px;margin-bottom:8px; transition: all 0.3s ease;}
    .grc-tab-buttons .btn:hover { transform: translateY(-2px); }
    .grc-tab{display:none;} .grc-tab.active{display:block;}
    .grc-lab-container{width:100%;max-width:1200px;margin:0 auto; padding: 18px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); border-radius: 26px; box-shadow: 0 14px 40px rgba(0,0,0,.35); backdrop-filter: blur(12px);} 
    @media (max-width:991.98px){.grc-lab-container{width:100vw; padding: 10px;}}
    .dashboard-card{border:1px solid rgba(255,255,255,.06);border-radius:10px;background:#1a1f2e;color:#fff; padding: 15px; transition: all 0.3s ease;}
    .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 6px 25px rgba(0,0,0,0.6); }
    .dashboard-card .label{font-size:.75rem;letter-spacing:.06em;opacity:.7;text-transform:uppercase;}
    .dashboard-card .value{font-size:1.4rem;font-weight:600;}
    .dashboard-card .sub{font-size:.8rem;opacity:.8;}
    .heat-cell{color:#fff;font-weight:600;text-align:center;white-space:nowrap;}
    .heat-cell small{display:block;font-weight:400;opacity:.9;}
    .heat-good{background:#1f8f3b;} .heat-medium{background:#a96b1f;}
    .heat-low{background:#8f3b1f;} .heat-none{background:#7a1f1f;}
    .heat-pill{border-radius:999px;padding:4px 10px;font-size:.8rem;display:inline-block;}
    #risk-matrix-canvas{background:#0c0f12;border-radius:8px;width:100%;max-width:100%; border: 1px solid #2b3138;}
    .table td,.table th{vertical-align:middle; padding: 12px;}
    .small-muted{color:#9ca3af;font-size:.85rem;}
    .soa-input, .soa-select{background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;width:100%;}
    .soa-input{padding:6px 8px;border-radius:6px;}
    .soa-select{padding:4px 6px;border-radius:6px;}
    .soa-evidence{font-size:.85rem;opacity:.9;}
    /* SoA Studio polish */
    #soa-export{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,211,238,.65));
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.96) !important;
      font-weight: 900;
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 18px 46px rgba(124,58,237,.18);
    }
    #soa-export:hover{
      transform: translateY(-1px);
      filter: brightness(1.06);
    }

    textarea#summary-text, textarea#report-text{
      background:#020617;
      color:#e5e7eb;
      border:none;
      font-family:Menlo,Consolas,monospace;
      font-size:.9rem;
      white-space:pre-wrap;
      overflow-y: auto;
      max-height: 600px;
      padding: 10px;
      border-radius: 8px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }
    /* New styles for polish */
    .toast-message{position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:10px 20px;border-radius:6px;opacity:0;transition:opacity 0.3s;z-index:1000;}
    .toast-message.show{opacity:1;}
    .toast-message.error{background:#ef4444;}
    .badge-count{background:#3b82f6;color:#fff;padding:2px 6px;border-radius:999px;font-size:0.75rem;margin-left:4px;}
    /* Pagination */
    .pagination{display:flex;justify-content:center;list-style:none;padding:0;}
    .pagination li{margin:0 5px;}
    .pagination a{color:#fff;text-decoration:none;padding:5px 10px;border:1px solid #1f2937;border-radius:4px; transition: all 0.3s;}
    .pagination a:hover { background: #3b82f6; border-color: #3b82f6; }
    .pagination .active a{background:#3b82f6;border-color:#3b82f6;}
    /* Bulk edit for SoA */
    .bulk-edit-bar{background:#1f2937;padding:10px;border-radius:6px;margin-bottom:10px;display:none;}
    .bulk-edit-bar.active{display:block;}
    .soa-checkbox{width:auto;margin:0 auto;display:block;}
    /* Guidance styles */
    .guidance {background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.4);}
    .guidance ul {list-style-type: decimal; padding-left: 20px;}
    .guidance li {margin-bottom: 10px;}
    /* Tooltips */
    .tooltip {position: relative; display: inline-block; border-bottom: 1px dotted #fff; cursor: help;}
    .tooltip .tooltiptext {visibility: hidden; width: 200px; background-color: #020617; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s;}
    .tooltip:hover .tooltiptext {visibility: visible; opacity: 1;}
    /* Challenge mode */
    .challenge-card {background: #111827; border: 1px solid #1f2937; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.4);}
    .challenge-card h4 {margin-top: 0;}
    .challenge-score {color: #10b981; font-weight: bold;}
    /* Enterprise style enhancements */
    .navbar { background: #0a0e17 !important; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .table { border-radius: 8px; overflow: hidden; }
    .table thead th { background: #1a1f2e; border-bottom: 2px solid #2b3138; }
    .table tbody tr:hover { background: #1f2937; }
    .btn-primary { background: #3b82f6; border-color: #3b82f6; }
    .btn-primary:hover { background: #2563eb; }
    .btn-outline-light { border-color: #4b5563; }
    .btn-outline-light:hover { background: #4b5563; }
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #0a0e17; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
  
    /* ===== Unified Portfolio UI Shell (matches index + cyber readiness) ===== */
    :root{
      --bg0:#070A12; --bg1:#0B1226;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.44);
      --brand:#7C3AED;
      --brand2:#22D3EE;
      --radius2: 26px;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    html,body{ height:100%; }
    body{
      margin:0 !important;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif !important;
      color: var(--text) !important;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(800px 600px at 50% 90%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1)) !important;
      overflow-x:hidden;
    }

    .gridfx{
      position:fixed; inset:0;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.045) 1px, transparent 1px);
      background-size: 42px 42px;
      mask-image: radial-gradient(800px 600px at 50% 20%, black 35%, transparent 85%);
      pointer-events:none;
      opacity:.55;
      animation: drift 14s var(--ease) infinite alternate;
    }
    @keyframes drift{ from{ transform: translate3d(0,0,0);} to{ transform: translate3d(0,-14px,0);} }
    .orb{
      position:fixed; width:520px; height:520px; border-radius:999px;
      filter: blur(18px); opacity:.55; pointer-events:none;
      mix-blend-mode: screen;
      animation: float 9s var(--ease) infinite alternate;
    }
    .orb.one{ left:-140px; top:-140px; background: radial-gradient(circle at 35% 30%, rgba(124,58,237,.75), transparent 55%); }
    .orb.two{ right:-180px; top:80px; background: radial-gradient(circle at 40% 35%, rgba(34,211,238,.55), transparent 60%); animation-duration: 11s; }
    .orb.three{ left:40%; bottom:-220px; background: radial-gradient(circle at 45% 45%, rgba(251,113,133,.45), transparent 62%); animation-duration: 13s; }
    @keyframes float { from{ transform: translate3d(0,0,0) scale(1);} to{ transform: translate3d(0,24px,0) scale(1.02);} }

    .wrap{ max-width: 1200px; margin: 0 auto; padding: 28px 18px 60px; position:relative; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      position:sticky; top:0; z-index:50;
      padding: 14px 12px;
      margin: -8px -6px 18px;
      border-radius: var(--radius2);
      background: rgba(10,14,26,.62);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 32px rgba(0,0,0,.35);
    }
    .brandRow{ display:flex; align-items:center; gap:10px; user-select:none; min-width:240px; }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: conic-gradient(from 210deg, rgba(124,58,237,.9), rgba(34,211,238,.9), rgba(251,113,133,.7), rgba(124,58,237,.9));
      box-shadow: 0 12px 26px rgba(124,58,237,.25);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 60%);
      transform: rotate(18deg);
    }
    .brandTitle{ font-weight:900; font-size:14px; letter-spacing:.2px; line-height:1.05; }
    .brandSub{ margin-top:2px; font-size:12px; color: var(--muted); }
    .navlinks{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      line-height:1;
      transition: transform .18s var(--ease), background .18s var(--ease), border-color .18s var(--ease);
      user-select:none;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.16); }
    .pill.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,211,238,.65));
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 20px 55px rgba(124,58,237,.25);
    }
    .pill.muted{ color: rgba(255,255,255,.88); }

    /* Convert Bootstrap dark panels into glass cards */
    .bg-dark{
      background: rgba(255,255,255,.055) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      box-shadow: 0 14px 40px rgba(0,0,0,.25) !important;
      border-radius: 18px !important;
    }
    .guidance{
      background: rgba(255,255,255,.055) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
    }

    /* Tabs as horizontal pill row */
    .grc-tab-buttons{
      display:flex !important;
      flex-wrap:nowrap !important;
      overflow-x:auto !important;
      -webkit-overflow-scrolling: touch;
      gap:10px !important;
      justify-content:flex-start !important;
      padding-bottom: 8px;
    }
    .grc-tab-buttons::-webkit-scrollbar{ height: 8px; }
    .grc-tab-buttons::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius: 999px; }
    .grc-tab-buttons .btn{
      white-space:nowrap !important;
      border-radius: 999px !important;
      padding: 10px 12px !important;
      font-weight: 800 !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      background: rgba(255,255,255,.06) !important;
      color: rgba(255,255,255,.90) !important;
    }
    .grc-tab-buttons .btn.btn-primary{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,211,238,.65)) !important;
      border-color: rgba(255,255,255,.12) !important;
    }
    .grc-tab-buttons .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085) !important; }

    /* Forms */
    .form-control{
      background: rgba(255,255,255,.05) !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      color: rgba(255,255,255,.90) !important;
      border-radius: 14px !important;
    }
    .form-control:focus{
      outline:none !important;
      box-shadow: 0 0 0 3px rgba(34,211,238,.12) !important;
      border-color: rgba(34,211,238,.35) !important;
    }
    label{ color: rgba(255,255,255,.72) !important; }

    /* Multi-select readability */
    select[multiple]{
      min-height: 180px !important;
      padding: 10px !important;
    }
    select[multiple] option{ padding: 6px 8px; }

    /* SoA textareas */
    .soa-textarea{
      width:100%;
      min-height: 70px;
      resize: vertical;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 8px 10px;
      line-height: 1.4;
    }
    .soa-textarea.soa-evidence{ min-height: 56px; }

    /* === SoA Premium Responsive Fix (no horizontal scroll on desktop) === */
    #tab-soa .table-responsive{ overflow-x: visible; }
    #tab-soa table{ width:100%; table-layout:fixed; }
    #tab-soa th, #tab-soa td{
      white-space: normal !important;
      word-break: break-word;
      vertical-align: top;
    }
    #tab-soa thead th{ position: sticky; top: 0; background: rgba(10,14,26,.92); backdrop-filter: blur(10px); z-index: 2; }
    /* tighten typography to fit qcard style */
    #tab-soa .table{ font-size: 12px; }
    #tab-soa .table th{ font-size: 12px; }
    #tab-soa .soa-textarea{ font-size: 12px; line-height:1.45; min-height: 64px; }
    #tab-soa .soa-textarea.soa-evidence{ min-height: 56px; }
    /* column widths (override inline styles safely using nth-child) */
    #tab-soa table th:nth-child(1), #tab-soa table td:nth-child(1){ width: 44px !important; }
    #tab-soa table th:nth-child(2), #tab-soa table td:nth-child(2){ width: 70px !important; }
    #tab-soa table th:nth-child(3), #tab-soa table td:nth-child(3){ width: 220px !important; }
    #tab-soa table th:nth-child(4), #tab-soa table td:nth-child(4){ width: 140px !important; }
    #tab-soa table th:nth-child(5), #tab-soa table td:nth-child(5){ width: 150px !important; }
    #tab-soa table th:nth-child(6), #tab-soa table td:nth-child(6){ width: 120px !important; }
    #tab-soa table th:nth-child(7), #tab-soa table td:nth-child(7){ width: 140px !important; }
    #tab-soa table th:nth-child(8), #tab-soa table td:nth-child(8){ width: 120px !important; }
    #tab-soa table th:nth-child(9), #tab-soa table td:nth-child(9){ width: auto !important; }

    /* Mobile: stack rows into cards (no sideways scroll) */
    @media (max-width: 860px){
      #tab-soa .table-responsive{ overflow-x: hidden; }
      #tab-soa table, #tab-soa thead, #tab-soa tbody, #tab-soa th, #tab-soa td, #tab-soa tr{ display:block; width:100%; }
      #tab-soa thead{ display:none; }
      #tab-soa tr{
        background: rgba(255,255,255,.04);
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 18px;
        padding: 10px 10px;
        margin-bottom: 10px;
      }
      #tab-soa td{
        border: none !important;
        padding: 8px 8px !important;
        display:flex;
        gap:10px;
      }
      #tab-soa td:before{
        content: attr(data-label);
        flex: 0 0 42%;
        color: rgba(255,255,255,.72);
        font-weight: 800;
        font-size: 12px;
      }
      #tab-soa td > *{ flex: 1 1 auto; min-width: 0; }
      #tab-soa td:nth-child(1):before{ content: "Select"; }
    }

    /* SoA column width (make it actually usable) */
    #tab-soa .table{ width:100%; min-width:0; table-layout:fixed; }
    #tab-soa th:last-child{ width: 34% !important; }
    #tab-soa td:last-child{ min-width: 360px; }

    /* Educational banner */
    .eduBanner{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-start;
      align-items:center;
      margin: 12px 0 4px;
    }
    .eduPill{
      display:inline-flex; align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,211,238,.65));
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.95);
      box-shadow: 0 18px 46px rgba(124,58,237,.22);
    }
    .eduText{
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      line-height: 1.4;
      max-width: 860px;
      text-align:center;
    }

    /* Tighten page spacing */
    .grc-lab-hero{ background: transparent !important; padding-bottom: 40px; }

/* ===== UI/UX FIX PACK (v1) — layout, responsiveness, spacing, states ===== */
:root{
  --ux-gap: 12px;
  --ux-card: rgba(255,255,255,.055);
  --ux-stroke: rgba(255,255,255,.10);
  --ux-stroke2: rgba(255,255,255,.14);
  --ux-muted: rgba(255,255,255,.72);
  --ux-muted2: rgba(255,255,255,.55);
}

/* Typography + contrast */
.text-muted, .small-muted{ color: var(--ux-muted) !important; }
.lead{ color: rgba(255,255,255,.82) !important; }
h1,h2,h3,h4,h5{ color: rgba(255,255,255,.94) !important; }

/* Container — prevent accidental horizontal bleed */
.grc-lab-container{ overflow: hidden; }
@media (max-width: 991.98px){
  .grc-lab-container{ border-radius: 20px !important; }
}

/* Tabs (navigation overflow) */
.grc-tab-buttons{
  padding: 8px 6px 10px !important;
  border-radius: 18px !important;
  background: rgba(255,255,255,.04) !important;
  border: 1px solid rgba(255,255,255,.08) !important;
}
.grc-tab-buttons::before,
.grc-tab-buttons::after{
  content:"";
  position: sticky;
  top: 0;
  width: 18px;
  flex: 0 0 18px;
  height: 100%;
  pointer-events:none;
  z-index: 1;
}
.grc-tab-buttons::before{ left: 0; background: linear-gradient(90deg, rgba(7,10,18,.95), rgba(7,10,18,0)); }
.grc-tab-buttons::after{ right: 0; background: linear-gradient(270deg, rgba(7,10,18,.95), rgba(7,10,18,0)); }
.grc-tab-buttons .btn{ flex: 0 0 auto; }

/* Form spacing consistency */
.form-group{ margin-bottom: .75rem !important; }
.form-row{ margin-left: -6px !important; margin-right: -6px !important; }
.form-row > .form-group, .form-row > .col-6{ padding-left: 6px !important; padding-right: 6px !important; }
label{ margin-bottom: .35rem !important; }
textarea.form-control{ min-height: 90px; }
textarea.form-control.form-control-sm{ min-height: 84px; }
input.form-control, select.form-control, textarea.form-control{ line-height: 1.35 !important; }

/* Edit mode visual distinction (form state) */
form.is-editing{
  outline: 2px solid rgba(34,211,238,.22);
  box-shadow: 0 0 0 4px rgba(34,211,238,.10);
  border-radius: 14px;
  padding: 10px;
}
form.is-editing .editBadge{
  display:inline-flex !important;
}
.editBadge{
  display:none;
  align-items:center;
  gap:8px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(34,211,238,.14);
  border: 1px solid rgba(34,211,238,.25);
  color: rgba(255,255,255,.92);
  font-weight: 850;
  font-size: 12px;
}

/* Filter sections (organization) */
.filterBar{
  display:flex;
  flex-wrap:wrap;
  gap: var(--ux-gap);
  align-items:flex-end;
  padding: 10px;
  border-radius: 14px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.08);
}
.filterBar .col-md-3, .filterBar .col-md-4{ margin-bottom: 0 !important; }
.filterBar .form-control{ min-width: 180px; }
@media (max-width: 767.98px){
  .filterBar{ gap: 10px; }
  .filterBar .form-control{ min-width: 100%; }
}

/* Tables (responsiveness + action alignment) */
.table-responsive{
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
}
.table{ margin-bottom: 0 !important; }
.table thead th{ white-space: nowrap; }
.table td{ vertical-align: middle !important; }
.table .actionsCell{
  display:flex;
  justify-content:flex-end;
  gap: 6px;
  flex-wrap: wrap;
}
.table td:last-child .btn{
  margin: 2px 0 !important;
}
.table td:last-child{
  text-align:right;
}
@media (max-width: 991.98px){
  .table{ min-width: 980px; } /* enables horizontal scroll instead of squishing */
}

/* Empty states */
.emptyState{
  margin-top: 10px;
  padding: 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.04);
  border: 1px dashed rgba(255,255,255,.14);
  color: rgba(255,255,255,.72);
  font-size: 12.5px;
}

/* Multi-select readability (Local Controls issue) */
select.form-control[multiple]{
  min-height: 210px !important;
  padding: 10px !important;
}
select.form-control[multiple] option{ padding: 6px 8px; }

/* SoA notes/evidence usability */
.soa-input, .soa-select{ min-height: 38px; }
.soa-notes{
  width:100%;
  min-height: 78px;
  resize: vertical;
  background: #0b1220;
  color: #e5e7eb;
  border: 1px solid #1f2937;
  border-radius: 10px;
  padding: 8px 10px;
  line-height: 1.35;
}
#tab-soa .table{ min-width: 1200px; }
#tab-soa th:last-child{ width: 36% !important; }
#tab-soa td:last-child{ min-width: 420px; }

/* Loading overlay */
#uiBusyOverlay{
  position: fixed;
  inset: 0;
  display:none;
  align-items:center;
  justify-content:center;
  background: rgba(5,8,16,.72);
  backdrop-filter: blur(10px);
  z-index: 2000;
}
#uiBusyOverlay.show{ display:flex; }
#uiBusyOverlay .card{
  width: min(520px, calc(100% - 28px));
  border-radius: 22px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 30px 90px rgba(0,0,0,.55);
  padding: 18px 18px 16px;
  text-align:center;
}
#uiBusyOverlay .spinner{
  width: 46px; height: 46px;
  border-radius: 999px;
  border: 4px solid rgba(255,255,255,.18);
  border-top-color: rgba(34,211,238,.85);
  margin: 6px auto 12px;
  animation: spin 1s linear infinite;
}



/* ===== UI FIX PACK v2 (forms horizontal + bigger textareas) ===== */
:root{
  --grc-gap: 12px;
}

/* Bigger report editors */
#summary-text, #report-text{
  width: 100% !important;
  min-height: 420px !important;
  line-height: 1.55 !important;
}

/* Make key report sections feel like "qcards" and fill container */
#tab-summary .bg-dark, #tab-reports .bg-dark{
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 18px !important;
}

/* Horizontal add/edit forms (2-column on desktop, 1-column on mobile) */
.grc-form-grid{
  display: grid !important;
  grid-template-columns: 1fr !important;
  gap: var(--grc-gap) !important;
}
@media (min-width: 992px){
  .grc-form-grid{
    grid-template-columns: 1fr 1fr !important;
    align-items: start !important;
  }
}
.grc-form-grid .form-group{ margin-bottom: 0 !important; }
.grc-span-2{ grid-column: 1 / -1 !important; }

/* Ensure selects/textareas never clip and labels align */
.grc-form-grid label{ display:block; margin-bottom: 6px !important; }
.grc-form-grid .form-control{ width: 100% !important; }

/* Multi-select readability (related risks / controls) */
select[multiple].form-control, select[multiple].form-control-sm{
  min-height: 180px !important;
  padding-top: 8px !important;
  padding-bottom: 8px !important;
}
select[multiple] option{
  padding: 6px 10px !important;
  line-height: 1.35 !important;
}

/* Button rows inside forms occupy full width */
.grc-form-grid .grc-actions{
  display:flex !important;
  justify-content: space-between !important;
  gap: 10px !important;
  flex-wrap: wrap !important;
}

/* ===== UI FIX: show ALL tab buttons (wrap, no horizontal scrolling) ===== */
.grc-tab-buttons{
  flex-wrap: wrap !important;
  overflow-x: visible !important;
  justify-content: flex-start !important;
}
.grc-tab-buttons::before,
.grc-tab-buttons::after{ display:none !important; }
.grc-tab-buttons .btn{
  padding: 9px 12px !important;
  font-size: 12.5px !important;
  margin-bottom: 6px !important;
}
/* Ensure tab row doesn't push content */
.grc-tab-buttons{ max-height: none !important; }

/* ===== UI FIX: SoA table (no horizontal scroll; responsive card layout on small screens) ===== */
#tab-soa .table{ min-width: 0 !important; width: 100% !important; table-layout: fixed !important; }
#tab-soa th, #tab-soa td{ white-space: normal !important; word-break: break-word; }
#tab-soa td:nth-child(2){ width: 7% !important; }     /* ID */
#tab-soa td:nth-child(3){ width: 18% !important; }    /* Name */
#tab-soa td:nth-child(4){ width: 12% !important; }    /* Category */
#tab-soa td:nth-child(5){ width: 12% !important; }    /* Frameworks */
#tab-soa td:nth-child(6){ width: 10% !important; }    /* Applicability */
#tab-soa td:nth-child(7){ width: 14% !important; }    /* Implementation */
#tab-soa td:nth-child(8){ width: 10% !important; }    /* Owner */
#tab-soa td:nth-child(9){ width: 17% !important; }    /* Rationale/Evidence */
#tab-soa td:last-child{ min-width: 0 !important; }
#tab-soa .soa-textarea{ min-height: 92px !important; }
#tab-soa .soa-textarea.soa-evidence{ min-height: 74px !important; }

/* Make the SoA table container handle overflow gracefully (should not be needed on desktop) */
#tab-soa .table-responsive{ overflow-x: visible !important; }

/* Mobile: transform table into stacked cards */
@media (max-width: 900px){
  #tab-soa table, #tab-soa thead, #tab-soa tbody, #tab-soa th, #tab-soa td, #tab-soa tr{
    display:block !important;
    width:100% !important;
  }
  #tab-soa thead{ display:none !important; }
  #tab-soa tr{
    background: rgba(255,255,255,.045);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    padding: 10px 10px;
    margin-bottom: 10px;
  }
  #tab-soa td{
    border: none !important;
    padding: 8px 6px !important;
  }
  #tab-soa td:before{
    content: attr(data-label);
    display:block;
    font-size: 11px;
    color: rgba(255,255,255,.62);
    font-weight: 800;
    letter-spacing:.12em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  #tab-soa td:first-child{ padding-top: 4px !important; }
  #tab-soa td:nth-child(1)::before{ content:"Select"; }
  #tab-soa td:nth-child(1){ display:flex !important; align-items:center; gap:10px; }
  #tab-soa td:nth-child(1) input{ transform: scale(1.1); }
  #tab-soa td:nth-child(2),
  #tab-soa td:nth-child(3){ }
}

/* ===== UI FIX: Multi-select option readability ===== */
select[multiple]{ min-height: 220px !important; }
select[multiple] option{ padding: 8px 10px !important; line-height: 1.35 !important; }


/* ===== Premium UI Patch v3.2 (safe, non-breaking) ===== */

/* Make filter rows horizontal and consistent */
.grc-filter-row{
  display:flex !important;
  flex-wrap:wrap !important;
  gap: 10px !important;
  align-items:flex-end !important;
}
.grc-filter-row > *{ flex: 1 1 220px !important; max-width: 320px; }
.grc-filter-row label{ margin-bottom: 6px !important; }
@media (max-width: 520px){
  .grc-filter-row > *{ flex: 1 1 100% !important; max-width:none !important; }
}

/* Stronger form grid: 2-column desktop, 1-column mobile */
.grc-form-grid{
  display:grid !important;
  grid-template-columns: 1fr !important;
  gap: 12px !important;
}
@media (min-width: 992px){
  .grc-form-grid{ grid-template-columns: 1fr 1fr !important; }
}
.grc-form-grid .form-row{ display: contents !important; }
.grc-form-grid .form-group{ margin-bottom: 0 !important; }
.grc-form-grid .form-group.full,
.grc-form-grid .grc-span-2{ grid-column: 1 / -1 !important; }
.grc-form-grid .d-flex.justify-content-between{ grid-column: 1 / -1 !important; }
.grc-form-grid textarea.form-control{ min-height: 90px !important; }
.grc-form-grid select[multiple]{ min-height: 220px !important; }

/* Checkbox groups (data types) look clean */
.grc-check-row{
  display:flex; flex-wrap:wrap; gap:10px;
  padding: 10px 10px;
  border-radius: 16px;
  background: rgba(255,255,255,.045);
  border: 1px solid rgba(255,255,255,.09);
}
.grc-check-row .custom-control{ margin-right: 10px !important; }

/* Dashboard premium */
#tab-dashboard .dashboard-card{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 18px !important;
  box-shadow: 0 14px 40px rgba(0,0,0,.25) !important;
}
#tab-dashboard .dashboard-card .value{
  font-size: 1.8rem !important;
  letter-spacing: -.3px;
}
#tab-dashboard .dashboard-card .sub{
  color: rgba(255,255,255,.72) !important;
}
#tab-dashboard .dashboard-card:hover{
  transform: translateY(-3px) !important;
}

/* Risk matrix container */
#risk-matrix-canvas{
  background: rgba(2,6,23,.55) !important;
  border: 1px solid rgba(255,255,255,.12) !important;
  border-radius: 18px !important;
  box-shadow: inset 0 0 18px rgba(0,0,0,.35);
}

/* Challenge mode premium */
.challenge-card{
  background: rgba(255,255,255,.055) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 18px !important;
  box-shadow: 0 14px 40px rgba(0,0,0,.22) !important;
}
.challenge-card .challenge-score{
  background: rgba(16,185,129,.12);
  border: 1px solid rgba(16,185,129,.25);
  padding: 4px 10px;
  border-radius: 999px;
  display:inline-block;
}

/* SoA: keep readable without horizontal scroll on desktop */
#tab-soa .table-responsive{ overflow-x: auto !important; }
#tab-soa table{ width: 100% !important; min-width: 980px !important; table-layout: fixed !important; }
#tab-soa th, #tab-soa td{ white-space: normal !important; word-break: break-word; }
#tab-soa td:last-child{ min-width: 420px !important; }
#tab-soa .soa-textarea{ min-height: 110px !important; }
#tab-soa .soa-textarea.soa-evidence{ min-height: 84px !important; }

/* Mobile: stack SoA rows (keeps content usable) */
@media (max-width: 900px){
  #tab-soa table{ min-width: 0 !important; }
  #tab-soa table, #tab-soa thead, #tab-soa tbody, #tab-soa th, #tab-soa td, #tab-soa tr{
    display:block !important;
    width:100% !important;
  }
  #tab-soa thead{ display:none !important; }
  #tab-soa tr{
    background: rgba(255,255,255,.045);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    padding: 10px 10px;
    margin-bottom: 10px;
  }
  #tab-soa td{ border: none !important; padding: 8px 6px !important; }
  #tab-soa td:before{
    content: attr(data-label);
    display:block;
    font-size: 11px;
    color: rgba(255,255,255,.62);
    font-weight: 800;
    letter-spacing:.12em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
}

/* Tables: improve action button alignment */
.table td .btn{ white-space: nowrap; }
.table td:last-child{ text-align: right; }


/* === UI polish pack: Dashboard + SoA (non-breaking) === */

/* DASHBOARD: true KPI grid + premium cards */
#tab-dashboard .row{
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 12px !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
}
#tab-dashboard .row > [class*="col-"]{
  width: auto !important;
  max-width: none !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}
#tab-dashboard .dashboard-card{
  border-radius: 18px !important;
  background: rgba(255,255,255,.055) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  box-shadow: 0 14px 40px rgba(0,0,0,.28) !important;
  position: relative;
  overflow: hidden;
}
#tab-dashboard .dashboard-card:before{
  content:"";
  position:absolute; inset:-40%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 55%);
  transform: rotate(10deg);
  opacity:.9;
  pointer-events:none;
}
#tab-dashboard .dashboard-card .label{
  color: rgba(255,255,255,.68) !important;
  font-size: 11px !important;
  letter-spacing: .8px;
  text-transform: uppercase;
  font-weight: 800;
}
#tab-dashboard .dashboard-card .value{
  font-size: 30px !important;
  font-weight: 900 !important;
  letter-spacing: -.4px;
  margin-top: 6px;
}
#tab-dashboard .dashboard-card .sub{
  color: rgba(255,255,255,.60) !important;
  font-size: 12px !important;
  margin-top: 4px;
}

/* Dashboard buttons: pill style */
#tab-dashboard .btn,
#tab-dashboard button{
  border-radius: 999px !important;
}
#tab-dashboard .btn.btn-outline-light{
  background: rgba(255,255,255,.06) !important;
  border-color: rgba(255,255,255,.14) !important;
  color: rgba(255,255,255,.88) !important;
}
#tab-dashboard .btn.btn-outline-light:hover{
  background: rgba(255,255,255,.085) !important;
  border-color: rgba(255,255,255,.20) !important;
}

/* SOA: stop squeezing last column + make editors readable */
#tab-soa .bg-dark{
  background: rgba(255,255,255,.05) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 18px !important;
}
#soa-table{
  width: 100% !important;
  table-layout: fixed;
}
#soa-table th, #soa-table td{
  vertical-align: top !important;
  word-break: break-word;
}
#soa-table th:nth-child(1), #soa-table td:nth-child(1){ width: 38px; }
#soa-table th:nth-child(2), #soa-table td:nth-child(2){ width: 84px; } /* ID */
#soa-table th:nth-child(3), #soa-table td:nth-child(3){ width: 230px; } /* Name */
#soa-table th:nth-child(4), #soa-table td:nth-child(4){ width: 150px; } /* Category */
#soa-table th:nth-child(5), #soa-table td:nth-child(5){ width: 110px; } /* Frameworks */
#soa-table th:nth-child(6), #soa-table td:nth-child(6){ width: 120px; } /* Applicability */
#soa-table th:nth-child(7), #soa-table td:nth-child(7){ width: 165px; } /* Implementation */
#soa-table th:nth-child(8), #soa-table td:nth-child(8){ width: 140px; } /* Owner */
#soa-table th:nth-child(9), #soa-table td:nth-child(9){ width: 360px; } /* Rationale/Evidence */

#soa-table .soa-input,
#soa-table .soa-select{
  width: 100% !important;
  max-width: 100% !important;
  border-radius: 12px;
}
#soa-table .soa-textarea{
  width: 100% !important;
  max-width: 100% !important;
  min-height: 76px;
  resize: vertical;
  font-size: 12px;
  line-height: 1.4;
  border-radius: 12px;
  padding: 8px 10px;
}
#soa-table .soa-evidence{ min-height: 66px; }

@media (max-width: 1100px){
  /* Allow natural wrap instead of forcing horizontal scrolling on mid screens */
  #soa-table{ table-layout: auto; }
  #soa-table th:nth-child(3), #soa-table td:nth-child(3){ width: auto; }
  #soa-table th:nth-child(9), #soa-table td:nth-child(9){ width: 320px; }
}
@media (max-width: 860px){
  /* On small screens, permit horizontal scroll just for the table (best compromise) */
  #tab-soa .table-responsive, #tab-soa .table-wrap, #tab-soa .table-responsive-sm{
    overflow-x: auto !important;
  }
  #soa-table{ min-width: 980px; }
}

/* Improve muted text contrast globally (safe) */
.small, .small-muted, .text-muted{
  color: rgba(255,255,255,.62) !important;
}


/* === Premium Dashboard polish (no logic changes) === */
#tab-dashboard .dashboard-card{
  border-radius: 22px !important;
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04)) !important;
  border: 1px solid rgba(255,255,255,.12) !important;
  box-shadow: 0 14px 36px rgba(0,0,0,.30) !important;
  position: relative;
  overflow: hidden;
  transition: transform .18s var(--ease), border-color .18s var(--ease), background .18s var(--ease);
}
#tab-dashboard .dashboard-card:before{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(circle at 30% 30%, rgba(34,211,238,.12), transparent 55%),
    radial-gradient(circle at 70% 40%, rgba(124,58,237,.14), transparent 56%);
  transform: rotate(10deg);
  opacity:.9;
  pointer-events:none;
}
#tab-dashboard .dashboard-card > *{ position:relative; z-index:1; }
#tab-dashboard .dashboard-card:hover{
  transform: translateY(-2px);
  border-color: rgba(255,255,255,.18) !important;
  background: linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.05)) !important;
}
#tab-dashboard .dashboard-card .label{
  font-weight: 900 !important;
  letter-spacing: .2px;
  font-size: 12px !important;
  text-transform: uppercase;
  color: rgba(255,255,255,.72) !important;
}
#tab-dashboard .dashboard-card .value{
  font-weight: 900 !important;
  font-size: 30px !important;
  letter-spacing: -.3px;
  margin-top: 6px;
  color: rgba(255,255,255,.94) !important;
}
#tab-dashboard .dashboard-card .sub{
  color: rgba(255,255,255,.62) !important;
  font-size: 12px !important;
  margin-top: 2px;
}

/* Make template/export buttons match pill style (keep Bootstrap classes) */
#tab-dashboard .btn, #tab-dashboard button.btn{
  border-radius: 999px !important;
  font-weight: 900 !important;
  letter-spacing: .1px;
}
#tab-dashboard .btn-outline-secondary,
#tab-dashboard .btn-outline-info,
#tab-dashboard .btn-outline-light{
  background: rgba(255,255,255,.06) !important;
  border-color: rgba(255,255,255,.14) !important;
  color: rgba(255,255,255,.88) !important;
}
#tab-dashboard .btn-outline-secondary:hover,
#tab-dashboard .btn-outline-info:hover,
#tab-dashboard .btn-outline-light:hover{
  background: rgba(255,255,255,.085) !important;
  border-color: rgba(255,255,255,.20) !important;
}

/* === SoA: make the table look intentional and prevent “broken” feel === */
#tab-soa .table-responsive{
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  box-shadow: 0 14px 40px rgba(0,0,0,.28);
  overflow: hidden; /* keeps header clean */
}
#tab-soa table.table{
  margin: 0;
  border-collapse: separate !important;
  border-spacing: 0 10px; /* creates “row cards” */
}
#tab-soa thead th{
  background: rgba(10,14,26,.90) !important;
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255,255,255,.12) !important;
}
#tab-soa tbody tr{
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 18px;
  overflow:hidden;
}
#tab-soa tbody tr td{
  vertical-align: top !important;
  border-top: 1px solid rgba(255,255,255,.06) !important;
  border-bottom: 1px solid rgba(255,255,255,.06) !important;
  color: rgba(255,255,255,.88);
}
#tab-soa tbody tr td:first-child{ border-left: 1px solid rgba(255,255,255,.06) !important; }
#tab-soa tbody tr td:last-child{ border-right: 1px solid rgba(255,255,255,.06) !important; }

/* Rationale/Evidence cell: allow comfortable editing without exploding layout */
#tab-soa .soa-textarea{
  width: 100% !important;
  min-height: 84px !important;
  padding: 10px 10px !important;
  border-radius: 14px !important;
  background: rgba(0,0,0,.28) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  color: rgba(255,255,255,.90) !important;
}
#tab-soa .soa-textarea.soa-evidence{ min-height: 72px !important; }

/* Make SoA fit without horizontal scroll on desktop by shrinking non-critical columns a bit */
#tab-soa th:nth-child(3), #tab-soa td:nth-child(3){ width: 160px !important; } /* Name */
#tab-soa th:nth-child(4), #tab-soa td:nth-child(4){ width: 140px !important; } /* Category */
#tab-soa th:nth-child(5), #tab-soa td:nth-child(5){ width: 120px !important; } /* Frameworks */
#tab-soa th:nth-child(9), #tab-soa td:nth-child(9){ width: 320px !important; } /* Rationale/Evidence */

/* If screen is narrower, enable x-scroll (better than broken squeeze) */
@media (max-width: 1200px){
  #tab-soa .table-responsive{ overflow-x: auto; }
  #tab-soa table.table{ min-width: 1100px; }
}


/* === SoA Studio (premium redesign) === */
.soaShell{ margin-top:12px; }
.soaShell .inner{ padding: 18px 18px 16px; }
.soaTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.soaTop h3{ margin:0; font-weight:900; letter-spacing:-.2px; }
.soaSub{ margin-top:6px; color: var(--muted); font-size:12.5px; line-height:1.55; }
.soaFilters{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
.soaFilters .f{ display:flex; flex-direction:column; gap:6px; min-width: 220px; flex: 1 1 220px;}
.soaFilters .f label{ color: var(--muted2); font-size:12px; }
.soaFilters select, .soaFilters input{
  width:100%;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  padding: 10px 12px;
  outline:none;
}
.soaFilters select:focus, .soaFilters input:focus{ border-color: rgba(34,211,238,.35); box-shadow: 0 0 0 3px rgba(34,211,238,.10); }
.soaSplit{ margin-top:12px; display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; align-items:stretch; }
@media (max-width: 980px){ .soaSplit{ grid-template-columns: 1fr; } }
.soaPane{ border-radius: 18px; background: rgba(255,255,255,.045); border: 1px solid rgba(255,255,255,.10); overflow:hidden; }
.soaPaneHead{ padding: 12px 12px; border-bottom: 1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; }
.soaPaneHead .t{ font-weight:900; font-size:13px; }
.soaPaneHead .k{ color: var(--muted2); font-size:12px; }
.soaList{ max-height: 560px; overflow:auto; padding: 10px; display:grid; gap:10px; }
@media (max-width: 980px){ .soaList{ max-height: 420px; } }
.soaItem{
  border-radius: 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  padding: 10px 10px;
  cursor:pointer;
  transition: transform .18s var(--ease), background .18s var(--ease), border-color .18s var(--ease);
}
.soaItem:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.16); }
.soaItem.active{ border-color: rgba(34,211,238,.35); box-shadow: 0 0 0 3px rgba(34,211,238,.10) inset; }
.soaItemTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.soaId{ font-weight:900; font-size:12px; color: rgba(255,255,255,.88); }
.soaName{ margin-top:4px; font-weight:800; font-size:13px; line-height:1.35; }
.soaMeta{ margin-top:6px; color: var(--muted); font-size:12px; line-height:1.45; }
.soaBadges{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
.soaBadge{
  font-size:11px;
  padding: 6px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.86);
}
.soaBadge.ok{ border-color: rgba(52,211,153,.22); }
.soaBadge.warn{ border-color: rgba(251,191,36,.22); }
.soaBadge.bad{ border-color: rgba(251,113,133,.22); }
.soaEditor{ padding: 12px; display:grid; gap:10px; }
.soaEditor .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
@media (max-width: 520px){ .soaEditor .row{ grid-template-columns: 1fr; } }
.soaEditor .field{ display:flex; flex-direction:column; gap:6px; }
.soaEditor .field label{ color: var(--muted2); font-size:12px; }
.soaEditor input, .soaEditor select, .soaEditor textarea{
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  padding: 10px 12px;
  outline:none;
}
.soaEditor textarea{ min-height: 120px; resize: vertical; line-height:1.55; }
.soaEditor textarea.evd{ min-height: 90px; }
.soaEditor input:focus, .soaEditor select:focus, .soaEditor textarea:focus{ border-color: rgba(124,58,237,.38); box-shadow: 0 0 0 3px rgba(124,58,237,.12); }
.soaEmpty{ padding: 16px; color: var(--muted); font-size:12.5px; line-height:1.55; }
.soaHint{ color: var(--muted); font-size:12px; }
.soaLegacy{ display:none !important; }

</style>
</head>
<body data-offset="300" data-spy="scroll" data-target=".site-navbar-target">
<div aria-hidden="true" id="uiBusyOverlay">
<div class="card">
<div class="spinner"></div>
<div style="font-weight:900;font-size:16px;">Working…</div>
<div style="margin-top:6px;color:rgba(255,255,255,.72);font-size:12.5px;line-height:1.45;">
        Generating output / updating view. This may take a moment.
      </div>
</div>
</div>
<div class="gridfx"></div>
<div class="orb one"></div>
<div class="orb two"></div>
<div class="orb three"></div>
<div class="wrap">
<header class="topbar">
<a class="brandRow" href="index.html" style="text-decoration:none;color:inherit;">
<div aria-hidden="true" class="logo"></div>
<div>
<div class="brandTitle">John Bommeraveni Joseph</div>
<div class="brandSub">Cybersecurity • GRC • AI Governance • ISO/IEC 27001 &amp; 42001 Lead Auditor</div>
</div>
</a>
<nav aria-label="Primary navigation" class="navlinks">
<a class="pill muted" href="index.html">Home</a>
<a aria-current="page" class="pill primary" href="grc-lab.html">GRC Lab</a>
<a class="pill muted" href="cyber-readiness-tool.html">Cyber Readiness Tool</a>
<a class="pill muted" href="terms.html">Terms</a>
<a class="pill muted" href="https://www.youtube.com/@GRCMadeSimple" rel="noopener noreferrer" target="_blank">YouTube</a>
</nav>
</header>
<!-- Lab -->
<section class="ftco-section grc-lab-hero">
<div class="grc-lab-container container-fluid px-4 px-md-5">
<!-- Header -->
<div class="row justify-content-center mb-4">
<div class="col-md-10 text-start ftco-animate">
<h1 class="mb-3">GRC Practice Lab</h1>
<div class="eduBanner"><span class="eduPill">Educational use only</span><span class="eduText">All controls are paraphrased and provided for practice &amp; portfolio demonstration — not for production use, certification, or legal compliance.</span></div>
<p class="lead">Practice frameworks, assets, risks, controls, issues, actions, vendors, incidents and reporting — all in your browser (data stays local). </p>
<p class="small-muted mb-0">Controls are paraphrased from ISO 27001:2022, NIST CSF 2.0, PCI DSS v4.0, HIPAA, SOC 2 for education only. Now with over 200 controls, challenge mode, templates, guidance, and PDF exports.</p>
</div>
</div>
<!-- Guidance Overview -->
<div class="guidance">
<h4>Welcome to the GRC Practice Lab</h4>
<p>This tool is designed for aspiring GRC analysts, students, and professionals to hands-on practice cybersecurity governance, risk, and compliance concepts. Everything runs locally in your browser - no data leaves your device.</p>
<p class="small-muted"><strong>Disclaimer:</strong> All controls are paraphrased and intended solely for educational and practice purposes. This lab is not for real-world production use or compliance certification.</p>
<ul>
<li><strong>Start here:</strong> Use the tabs below to navigate. Begin with 'Guidance' for step-by-step instructions.</li>
<li><strong>Learn by doing:</strong> Load templates or demos, add your own data, analyze gaps, generate reports.</li>
<li><strong>Challenge yourself:</strong> Try Challenge Mode for scored scenarios to test your skills.</li>
<li><strong>Tips:</strong> Hover over tooltips for help. Export data anytime. Reset if needed.</li>
</ul>
</div>
<!-- Tabs -->
<div class="row mb-4">
<div class="col-md-12 text-center grc-tab-buttons">
<button class="btn btn-primary btn-sm" data-grc-tab="guidance">Guidance</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="frameworks">Frameworks &amp; Controls</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="assets">Assets</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="vendors">Vendors</button> <!-- New -->
<button class="btn btn-outline-light btn-sm" data-grc-tab="risks">Risks</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="controls">Local Controls</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="issues">Issues / Findings</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="incidents">Incidents</button> <!-- New -->
<button class="btn btn-outline-light btn-sm" data-grc-tab="treatments">Treatments</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="gap">Gap Analysis</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="soa">SoA</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="dashboard">Dashboard</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="matrix">Risk Matrix</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="summary">Auditor Summary</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="reports">Reports</button>
<button class="btn btn-outline-light btn-sm" data-grc-tab="challenges">Challenge Mode</button> <!-- New -->
</div>
</div>
<!-- Guidance Tab -->
<div class="grc-tab active ftco-animate" id="tab-guidance">
<h3>GRC Practice Lab Guidance</h3>
<div class="guidance">
<h4>Step-by-Step Guide</h4>
<ul>
<li><strong>1. Learn Frameworks:</strong> Review standard controls in Frameworks tab. Use to understand what good looks like.</li>
<li><strong>2. Inventory Assets:</strong> Add your organization's key assets (systems, data, etc). Classify criticality and data types.</li>
<li><strong>3. Manage Vendors:</strong> Track third-parties, assess risks, contracts.</li>
<li><strong>4. Identify Risks:</strong> For each asset/vendor, add risks with likelihood/impact. Use matrix to visualize.</li>
<li><strong>5. Implement Controls:</strong> Add local controls, map to frameworks and risks. Aim for coverage.</li>
<li><strong>6. Log Issues/Findings:</strong> From audits or tests, add issues linked to objects.</li>
<li><strong>7. Report Incidents:</strong> Log security incidents, link to response.</li>
<li><strong>8. Plan Treatments:</strong> Add actions to mitigate risks/issues. Track progress.</li>
<li><strong>9. Assess Compliance:</strong> Use Gap Analysis and SoA to check against standards.</li>
<li><strong>10. Monitor Dashboard:</strong> View metrics, heatmaps.</li>
<li><strong>11. Generate Reports:</strong> Create summaries, exports for management.</li>
<li><strong>12. Challenge Mode:</strong> Test skills with scenarios, get scores.</li>
</ul>
</div>
</div>
<!-- Frameworks -->
<div class="grc-tab ftco-animate" id="tab-frameworks">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Browse and filter controls from major standards. Use these to map your local controls for compliance. Tip: Search for specific topics like 'access'.</span></span>: Review unified library. Over 200 controls from ISO, NIST, PCI, HIPAA, SOC2.</p>
</div>
<h3>Framework Library</h3>
<p class="mb-3">Filter and review a unified control set aligned to ISO/NIST/PCI/HIPAA/SOC2.</p>
<div class="row mb-3">
<div class="col-md-4 mb-2">
<label class="text-muted small mb-1">Filter by Framework</label>
<select class="form-control form-control-sm" id="framework-filter">
<option value="all">All frameworks</option>
<option value="ISO 27001">ISO 27001</option>
<option value="NIST CSF">NIST CSF</option>
<option value="PCI DSS">PCI DSS</option>
<option value="HIPAA">HIPAA</option>
<option value="SOC2">SOC 2</option> <!-- New -->
</select>
</div>
<div class="col-md-4 mb-2">
<label class="text-muted small mb-1">Filter by Category</label>
<select class="form-control form-control-sm" id="category-filter">
<option value="all">All categories</option>
<option>Access Control</option>
<option>Identity &amp; Authentication</option>
<option>Logging &amp; Monitoring</option>
<option>Encryption &amp; Key Management</option>
<option>Backup &amp; Recovery</option>
<option>Change Management</option>
<option>Vulnerability Management</option>
<option>Incident Response</option>
<option>Vendor Risk</option>
<option>Policy &amp; Governance</option>
<option>Awareness &amp; Training</option>
<option>Physical Security</option> <!-- New -->
<option>Network Security</option> <!-- New -->
<option>Asset Management</option> <!-- New -->
</select>
</div>
<div class="col-md-4 mb-2">
<label class="text-muted small mb-1">Search</label>
<input class="form-control form-control-sm" id="framework-search" placeholder="Search by name, ID, description..."/>
</div>
</div>
<div class="table-responsive bg-dark p-3 rounded">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:10%">ID</th>
<th style="width:20%">Name</th>
<th style="width:18%">Category</th>
<th style="width:20%">Based On</th>
<th style="width:32%">Description</th>
</tr>
</thead>
<tbody id="frameworks-table-body"></tbody>
</table>
<div class="mt-2 text-right">
<small class="text-muted" id="frameworks-count"></small>
</div>
</div>
</div>
<!-- Assets -->
<div class="grc-tab ftco-animate" id="tab-assets">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Add key assets like apps, databases, servers. Classify criticality and data. Link to risks later. Tip: Start with high-critical assets handling sensitive data.</span></span>: Build your asset inventory. Essential for risk assessment.</p>
</div>
<h3>Asset Inventory</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Asset</h5>
<form class="grc-form-grid" id="asset-form">
<input id="asset-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Name *</label>
<input class="form-control form-control-sm" id="asset-name" placeholder="e.g. MediCloud Web App" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Type *</label>
<select class="form-control form-control-sm" id="asset-type" required="">
<option value="">Select...</option>
<option>Application</option><option>Database</option><option>Server / Host</option>
<option>Network / Security Device</option><option>Cloud Service</option>
<option>Vendor / Third Party</option><option>Data Store</option>
<option>People / Role</option><option>Other</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Business criticality *</label>
<select class="form-control form-control-sm" id="asset-criticality" required="">
<option value="">Select level...</option>
<option>High</option><option>Medium</option><option>Low</option>
</select>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1 d-block">Data types</label>
<div class="d-flex flex-wrap">
<div class="custom-control custom-checkbox mr-3 mb-1">
<input class="custom-control-input asset-dt" id="dt-phi" type="checkbox" value="PHI"/>
<label class="custom-control-label" for="dt-phi">PHI</label>
</div>
<div class="custom-control custom-checkbox mr-3 mb-1">
<input class="custom-control-input asset-dt" id="dt-pii" type="checkbox" value="PII"/>
<label class="custom-control-label" for="dt-pii">PII</label>
</div>
<div class="custom-control custom-checkbox mr-3 mb-1">
<input class="custom-control-input asset-dt" id="dt-pan" type="checkbox" value="Card data"/>
<label class="custom-control-label" for="dt-pan">Card data</label>
</div>
<div class="custom-control custom-checkbox mr-3 mb-1">
<input class="custom-control-input asset-dt" id="dt-int" type="checkbox" value="Internal data"/>
<label class="custom-control-label" for="dt-int">Internal data</label>
</div>
</div>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Owner</label>
<input class="form-control form-control-sm" id="asset-owner" placeholder="e.g. DevOps Team / CTO"/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Location / Scope</label> <!-- New field -->
<input class="form-control form-control-sm" id="asset-location" placeholder="e.g. AWS US-East-1, In-scope for PCI"/>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Notes</label>
<textarea class="form-control form-control-sm" id="asset-notes" placeholder="Scope, region, integrations..." rows="2"></textarea>
</div>
<div class="d-flex justify-content-between grc-actions grc-span-2">
<button class="btn btn-primary btn-sm" id="asset-form-submit" type="submit">Save asset</button>
<button class="btn btn-outline-light btn-sm" id="asset-form-cancel" type="button">Clear</button>
</div>
<small class="text-muted d-block mt-2">Stored locally in your browser.</small>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Assets</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-assets">Export CSV</button>
<small class="text-muted" id="assets-count"></small>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:20%">Name</th><th style="width:14%">Type</th><th style="width:12%">Criticality</th>
<th style="width:18%">Data types</th><th style="width:14%">Owner</th><th style="width:12%">Location</th><th style="width:10%">Actions</th>
</tr>
</thead>
<tbody id="assets-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="assets-empty">No assets yet. Add some to start risk assessment.</div>
<ul class="pagination" id="assets-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- New Vendors Tab -->
<div class="grc-tab ftco-animate" id="tab-vendors">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Track third-party vendors. Assess risks, contracts. Link to assets/risks. Tip: Prioritize critical vendors handling sensitive data.</span></span>: Manage vendor relationships for third-party risk.</p>
</div>
<h3>Vendor Management</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Vendor</h5>
<form class="grc-form-grid" id="vendor-form">
<input id="vendor-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Name *</label>
<input class="form-control form-control-sm" id="vendor-name" placeholder="e.g. AWS" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Type *</label>
<select class="form-control form-control-sm" id="vendor-type" required="">
<option value="">Select...</option>
<option>Cloud Provider</option><option>SaaS</option><option>Outsourcing</option><option>Hardware</option><option>Other</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Criticality *</label>
<select class="form-control form-control-sm" id="vendor-criticality" required="">
<option value="">Select...</option>
<option>High</option><option>Medium</option><option>Low</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Data Access</label>
<select class="form-control form-control-sm" id="vendor-data-access">
<option>None</option><option>Read</option><option>Read/Write</option><option>Full</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Contract Status</label>
<select class="form-control form-control-sm" id="vendor-contract">
<option>Active</option><option>Pending</option><option>Expired</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Last Assessment</label>
<input class="form-control form-control-sm" id="vendor-assessment" type="date"/>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Notes</label>
<textarea class="form-control form-control-sm" id="vendor-notes" placeholder="Services, SLAs, risks..." rows="2"></textarea>
</div>
<div class="d-flex justify-content-between grc-actions grc-span-2">
<button class="btn btn-primary btn-sm" type="submit">Save vendor</button>
<button class="btn btn-outline-light btn-sm" id="vendor-form-cancel" type="button">Clear</button>
</div>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Vendors</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-vendors">Export CSV</button>
<small class="text-muted" id="vendors-count"></small>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:20%">Name</th><th style="width:15%">Type</th><th style="width:12%">Criticality</th>
<th style="width:15%">Data Access</th><th style="width:15%">Contract</th><th style="width:15%">Last Assessment</th><th style="width:8%">Actions</th>
</tr>
</thead>
<tbody id="vendors-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="vendors-empty">No vendors yet. Add third-parties to assess supply chain risks.</div>
<ul class="pagination" id="vendors-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- Risks -->
<div class="grc-tab ftco-animate" id="tab-risks">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Add risks linked to assets/vendors. Score likelihood/impact. Use thresholds to categorize. Tip: Focus on top risks (high score, open status).</span></span>: Build risk register. Link to assets/vendors for context.</p>
</div>
<h3>Risk Register</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Risk</h5>
<form class="grc-form-grid" id="risk-form">
<input id="risk-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Title *</label>
<input class="form-control form-control-sm" id="risk-title" placeholder="e.g. Unauthorised access to app" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Linked Asset/Vendor *</label>
<select class="form-control form-control-sm" id="risk-linked" required=""> <!-- Updated to link asset or vendor -->
<option value="">Select...</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Category *</label>
<select class="form-control form-control-sm" id="risk-category" required="">
<option value="">Select...</option>
<option>Cybersecurity</option><option>Compliance</option><option>Operational</option>
<option>Privacy</option><option>Third-Party</option><option>Financial</option><option>Reputational</option><option>Other</option>
</select>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Likelihood (1–5) *</label>
<select class="form-control form-control-sm" id="risk-likelihood" required="">
<option value="">Select...</option>
<option value="1">1 – Rare</option><option value="2">2 – Unlikely</option><option value="3">3 – Possible</option>
<option value="4">4 – Likely</option><option value="5">5 – Almost certain</option>
</select>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Impact (1–5) *</label>
<select class="form-control form-control-sm" id="risk-impact" required="">
<option value="">Select...</option>
<option value="1">1 – Insignificant</option><option value="2">2 – Minor</option><option value="3">3 – Moderate</option>
<option value="4">4 – Major</option><option value="5">5 – Severe</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Residual Likelihood</label>
<select class="form-control form-control-sm" id="risk-res-likelihood">
<option value="">Select...</option>
<option value="1">1 – Rare</option><option value="2">2 – Unlikely</option><option value="3">3 – Possible</option>
<option value="4">4 – Likely</option><option value="5">5 – Almost certain</option>
</select>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Residual Impact</label>
<select class="form-control form-control-sm" id="risk-res-impact">
<option value="">Select...</option>
<option value="1">1 – Insignificant</option><option value="2">2 – Minor</option><option value="3">3 – Moderate</option>
<option value="4">4 – Major</option><option value="5">5 – Severe</option>
</select>
</div>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Owner</label>
<input class="form-control form-control-sm" id="risk-owner" placeholder="e.g. CISO / Product Owner"/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Status *</label>
<select class="form-control form-control-sm" id="risk-status" required="">
<option>Open</option><option>In progress</option><option>Mitigated</option><option>Accepted</option><option>Avoided</option><option>Transferred</option>
</select>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Description / Notes</label>
<textarea class="form-control form-control-sm" id="risk-notes" rows="2"></textarea>
</div>
<div class="d-flex justify-content-between grc-actions grc-span-2">
<button class="btn btn-primary btn-sm" id="risk-form-submit" type="submit">Save risk</button>
<button class="btn btn-outline-light btn-sm" id="risk-form-cancel" type="button">Clear</button>
</div>
<small class="text-muted d-block mt-2">Score = Likelihood × Impact (1–25). Residual after controls. High / Medium / Low thresholds configurable.</small>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Risks</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-risks">Export CSV</button>
<small class="text-muted" id="risks-count"></small>
</div>
</div>
<!-- Filters + sorting -->
<div class="row mb-2">
<div class="col-md-3 mb-1">
<label class="text-muted small mb-1">Filter by status</label>
<select class="form-control form-control-sm" id="risk-filter-status">
<option value="all">All statuses</option>
<option>Open</option>
<option>In progress</option>
<option>Mitigated</option>
<option>Accepted</option>
<option>Avoided</option>
<option>Transferred</option>
</select>
</div>
<div class="col-md-3 mb-1">
<label class="text-muted small mb-1">Filter by level</label>
<select class="form-control form-control-sm" id="risk-filter-level">
<option value="all">All levels</option>
<option>High</option>
<option>Medium</option>
<option>Low</option>
</select>
</div>
<div class="col-md-3 mb-1">
<label class="text-muted small mb-1">Filter by category</label>
<select class="form-control form-control-sm" id="risk-filter-category">
<option value="all">All</option>
<option>Cybersecurity</option><option>Compliance</option><option>Operational</option>
<option>Privacy</option><option>Third-Party</option><option>Financial</option><option>Reputational</option><option>Other</option>
</select>
</div>
<div class="col-md-3 mb-1">
<label class="text-muted small mb-1">Sort</label>
<div class="d-flex">
<select class="form-control form-control-sm mr-1" id="risk-sort-field">
<option value="score">Score</option>
<option value="title">Title</option>
<option value="asset">Linked</option>
<option value="impact">Impact</option>
<option value="likelihood">Likelihood</option>
<option value="status">Status</option>
</select>
<select class="form-control form-control-sm" id="risk-sort-dir">
<option value="desc">Desc</option>
<option value="asc">Asc</option>
</select>
</div>
</div>
</div>
<!-- Threshold settings -->
<div class="bg-secondary rounded p-2 mb-2">
<div class="d-flex flex-wrap align-items-center">
<span class="small text-light mr-2">
                    Risk levels: High ≥ <input class="form-control form-control-sm d-inline-block" id="risk-thres-high" max="25" min="1" style="width:60px;" type="number"> ; Medium ≥ <input class="form-control form-control-sm d-inline-block" id="risk-thres-med" max="25" min="1" style="width:60px;" type="number"> ; Low below Medium.
                  </input></input></span>
<button class="btn btn-sm btn-outline-light ml-auto" id="risk-thres-reset">Reset</button>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:24%">Title</th><th style="width:16%">Linked</th><th style="width:14%">Category</th>
<th style="width:14%">Inherent</th><th style="width:14%">Residual</th><th style="width:12%">Status</th><th style="width:6%">Actions</th>
</tr>
</thead>
<tbody id="risks-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="risks-empty">No risks yet. Add some based on assets.</div>
<ul class="pagination" id="risks-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- Local Controls -->
<div class="grc-tab ftco-animate" id="tab-controls">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Add your organization's controls. Map to frameworks and risks. Set status to track implementation. Tip: Use 'In place' for operating controls, 'Planned' for gaps.</span></span>: Build control library. Map to standards for compliance.</p>
</div>
<h3>Local Controls (Org Library)</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Control</h5>
<form class="grc-form-grid" id="control-form">
<input id="control-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Control name *</label>
<input class="form-control form-control-sm" id="control-name" placeholder="e.g. Enforce MFA for admins" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Type *</label>
<select class="form-control form-control-sm" id="control-type" required="">
<option value="">Select...</option>
<option>Preventive</option><option>Detective</option><option>Corrective</option>
<option>Administrative</option><option>Technical</option><option>Physical</option>
<option>Compensating</option> <!-- New -->
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Status *</label>
<select class="form-control form-control-sm" id="control-status" required="">
<option>In place</option><option>Planned</option><option>Not applicable</option><option>Ineffective</option> <!-- New -->
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Owner</label>
<input class="form-control form-control-sm" id="control-owner" placeholder="DevSecOps / IT Ops / Compliance"/>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Description</label>
<textarea class="form-control form-control-sm" id="control-description" placeholder="Implementation details, evidence..." rows="2"></textarea>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Related risks</label>
<select class="form-control form-control-sm" id="control-risks" multiple=""></select>
<small class="text-muted">Hold Ctrl/Cmd to multi-select.</small>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Related framework controls</label>
<select class="form-control form-control-sm" id="control-frameworks" multiple=""></select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Evidence</label>
<input class="form-control form-control-sm" id="control-evidence" placeholder="Links to docs, screenshots..."/>
</div>
<div class="d-flex justify-content-between grc-actions grc-span-2">
<button class="btn btn-primary btn-sm" id="control-form-submit" type="submit">Save control</button>
<button class="btn btn-outline-light btn-sm" id="control-form-cancel" type="button">Clear</button>
</div>
<small class="text-muted d-block mt-2">Stored locally. Map to frameworks for gap analysis.</small>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Controls</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-controls">Export CSV</button>
<small class="text-muted" id="controls-count"></small>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:24%">Name</th><th style="width:14%">Type</th><th style="width:12%">Status</th>
<th style="width:18%">Linked risks</th><th style="width:14%">Frameworks</th><th style="width:18%">Evidence</th><th style="width:10%">Actions</th>
</tr>
</thead>
<tbody id="controls-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="controls-empty">No controls yet. Add and map to frameworks.</div>
<ul class="pagination" id="controls-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- Issues / Findings -->
<div class="grc-tab ftco-animate" id="tab-issues">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Log findings from audits, tests, reviews. Link to objects. Set severity/status. Tip: Use for gap remediation tracking.</span></span>: Track audit findings and gaps.</p>
</div>
<h3>Issues &amp; Findings</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Issue</h5>
<form class="grc-form-grid" id="issue-form">
<input id="issue-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Title *</label>
<input class="form-control form-control-sm" id="issue-title" placeholder="e.g. Missing MFA for admins" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Type *</label>
<select class="form-control form-control-sm" id="issue-type" required="">
<option value="">Select...</option>
<option>Audit</option><option>Pen test</option><option>Vulnerability Scan</option><option>Self-Assessment</option><option>Risk review</option><option>Other</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Linked objects (optional)</label>
<select class="form-control form-control-sm mb-1" id="issue-asset"><option value="">Linked asset...</option></select>
<select class="form-control form-control-sm mb-1" id="issue-vendor"><option value="">Linked vendor...</option></select> <!-- New -->
<select class="form-control form-control-sm mb-1" id="issue-risk"><option value="">Linked risk...</option></select>
<select class="form-control form-control-sm" id="issue-control"><option value="">Linked control...</option></select>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Severity *</label>
<select class="form-control form-control-sm" id="issue-severity" required="">
<option value="">Select...</option>
<option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
</select>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Status *</label>
<select class="form-control form-control-sm" id="issue-status" required="">
<option>Open</option><option>In progress</option><option>Resolved</option><option>Accepted</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Owner</label>
<input class="form-control form-control-sm" id="issue-owner" placeholder="e.g. Dev Lead"/>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Due date</label>
<input class="form-control form-control-sm" id="issue-due" type="date"/>
</div>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Details / Recommendation</label>
<textarea class="form-control form-control-sm" id="issue-notes" rows="2"></textarea>
</div>
<div class="d-flex justify-content-between grc-actions grc-span-2">
<button class="btn btn-primary btn-sm" id="issue-form-submit" type="submit">Save issue</button>
<button class="btn btn-outline-light btn-sm" id="issue-form-cancel" type="button">Clear</button>
</div>
<small class="text-muted d-block mt-2">Stored locally in your browser.</small>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Issues / Findings</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-issues">Export CSV</button>
<small class="text-muted" id="issues-count"></small>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:22%">Title</th><th style="width:10%">Type</th><th style="width:12%">Severity</th>
<th style="width:12%">Status</th><th style="width:20%">Linked to</th><th style="width:12%">Due</th><th style="width:12%">Actions</th>
</tr>
</thead>
<tbody id="issues-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="issues-empty">No issues yet.</div>
<ul class="pagination" id="issues-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- New Incidents Tab -->
<div class="grc-tab ftco-animate" id="tab-incidents">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Log security incidents. Classify severity, status. Link to risks/controls. Tip: Use for response practice and lessons learned.</span></span>: Track and respond to incidents.</p>
</div>
<h3>Incident Management</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Incident</h5>
<form class="grc-form-grid" id="incident-form">
<input id="incident-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Title *</label>
<input class="form-control form-control-sm" id="incident-title" placeholder="e.g. Data Breach Suspicion" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Type *</label>
<select class="form-control form-control-sm" id="incident-type" required="">
<option value="">Select...</option>
<option>Data Breach</option><option>Phishing</option><option>Malware</option><option>Insider Threat</option><option>Denial of Service</option><option>Other</option>
</select>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Detected Date *</label>
<input class="form-control form-control-sm" id="incident-detected" required="" type="date"/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Linked objects (optional)</label>
<select class="form-control form-control-sm mb-1" id="incident-asset"><option value="">Linked asset...</option></select>
<select class="form-control form-control-sm mb-1" id="incident-vendor"><option value="">Linked vendor...</option></select>
<select class="form-control form-control-sm mb-1" id="incident-risk"><option value="">Linked risk...</option></select>
<select class="form-control form-control-sm" id="incident-control"><option value="">Linked control...</option></select>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Severity *</label>
<select class="form-control form-control-sm" id="incident-severity" required="">
<option value="">Select...</option>
<option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
</select>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Status *</label>
<select class="form-control form-control-sm" id="incident-status" required="">
<option>Detected</option><option>Investigating</option><option>Contained</option><option>Recovered</option><option>Closed</option>
</select>
</div>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Owner</label>
<input class="form-control form-control-sm" id="incident-owner" placeholder="e.g. Incident Response Team"/>
</div>
<div class="form-group grc-span-2">
<label class="text-muted small mb-1">Details / Response</label>
<textarea class="form-control form-control-sm" id="incident-notes" placeholder="What happened, root cause, lessons learned..." rows="3"></textarea>
</div>
<div class="d-flex justify-content-between grc-actions grc-span-2">
<button class="btn btn-primary btn-sm" type="submit">Save incident</button>
<button class="btn btn-outline-light btn-sm" id="incident-form-cancel" type="button">Clear</button>
</div>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Incidents</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-incidents">Export CSV</button>
<small class="text-muted" id="incidents-count"></small>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:22%">Title</th><th style="width:10%">Type</th><th style="width:12%">Severity</th>
<th style="width:12%">Status</th><th style="width:16%">Detected</th><th style="width:20%">Linked to</th><th style="width:8%">Actions</th>
</tr>
</thead>
<tbody id="incidents-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="incidents-empty">No incidents yet. Log when they occur for practice.</div>
<ul class="pagination" id="incidents-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- Treatments -->
<div class="grc-tab ftco-animate" id="tab-treatments">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Add mitigation actions for risks/issues. Link to controls. Track status/target. Tip: Use for risk treatment plans.</span></span>: Plan and track remediations.</p>
</div>
<h3>Treatments (Mitigation Plan)</h3>
<div class="row">
<div class="col-lg-4 col-md-5 mb-4">
<div class="bg-dark p-3 rounded">
<h5 class="mb-3">Add / Edit Treatment</h5>
<form id="treat-form">
<input id="treat-id" type="hidden"/>
<div class="form-group">
<label class="text-muted small mb-1">Action title *</label>
<input class="form-control form-control-sm" id="treat-title" placeholder="e.g. Enforce SSO &amp; MFA for admins" required=""/>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Linked risk/issue *</label>
<select class="form-control form-control-sm" id="treat-linked" required=""><option value="">Select...</option></select> <!-- Updated -->
</div>
<div class="form-group">
<label class="text-muted small mb-1">Linked control (optional)</label>
<select class="form-control form-control-sm" id="treat-control"><option value="">Select control...</option></select>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Status *</label>
<select class="form-control form-control-sm" id="treat-status" required="">
<option>Open</option><option>In progress</option><option>Closed</option><option>Deferred</option>
</select>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Target date</label>
<input class="form-control form-control-sm" id="treat-date" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group col-6">
<label class="text-muted small mb-1">Owner</label>
<input class="form-control form-control-sm" id="treat-owner" placeholder="e.g. DevOps Lead"/>
</div>
<div class="form-group col-6">
<label class="text-muted small mb-1">Budget (optional)</label>
<input class="form-control form-control-sm" id="treat-budget" placeholder="e.g. 2,500 USD"/>
</div>
</div>
<div class="form-group">
<label class="text-muted small mb-1">Notes</label>
<textarea class="form-control form-control-sm" id="treat-notes" rows="2"></textarea>
</div>
<div class="d-flex justify-content-between">
<button class="btn btn-primary btn-sm" id="treat-submit" type="submit">Save action</button>
<button class="btn btn-outline-light btn-sm" id="treat-cancel" type="button">Clear</button>
</div>
<small class="text-muted d-block mt-2">Stored locally. Link to risks/issues for tracking.</small>
</form>
</div>
</div>
<div class="col-lg-8 col-md-7 mb-4">
<div class="bg-dark p-3 rounded">
<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="mb-0">Treatment actions</h5>
<div>
<button class="btn btn-sm btn-outline-light mr-2" id="export-treatments">Export CSV</button>
<small class="text-muted" id="treat-count"></small>
</div>
</div>
<div class="table-responsive">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:26%">Title</th><th style="width:20%">Linked</th>
<th style="width:12%">Status</th><th style="width:14%">Target</th>
<th style="width:10%">Owner</th><th style="width:10%">Budget</th><th style="width:8%">Actions</th>
</tr>
</thead>
<tbody id="treat-table-body"></tbody>
</table>
</div>
<div class="text-muted small mt-2" id="treat-empty">No treatment actions yet.</div>
<ul class="pagination" id="treatments-pagination"></ul>
</div>
</div>
</div>
</div>
<!-- Gap Analysis -->
<div class="grc-tab ftco-animate" id="tab-gap">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">View coverage by category. Heatmap shows maturity. Tip: Aim for 80%+ implemented in core areas.</span></span>: Analyze control gaps against frameworks.</p>
</div>
<h3>Gap Analysis &amp; Heatmap</h3>
<p class="mb-3">Coverage based on local controls mapped to frameworks. “In place” = implemented; “Planned” = planned-only.</p>
<div class="table-responsive bg-dark p-3 rounded">
<table class="table table-dark table-striped table-hover table-sm mb-0">
<thead>
<tr>
<th style="width:24%">Category</th>
<th style="width:12%">Total controls</th>
<th style="width:16%">Implemented</th>
<th style="width:16%">Planned only</th>
<th style="width:16%">Not implemented</th>
<th style="width:16%">Heatmap</th>
</tr>
</thead>
<tbody id="gap-table-body"></tbody>
</table>
<div class="mt-2 text-right"><small class="text-muted" id="gap-overall-coverage"></small></div>
</div>
</div>
<!-- SoA -->

<div class="grc-tab ftco-animate" id="tab-soa">
  <div class="guidance">
    <p><span class="tooltip">How to use<span class="tooltiptext">Document Statement of Applicability for ISO-like compliance. Use filters + search, then update applicability, implementation, and rationale/evidence for selected controls.</span></span>
      <b>How to use:</b> Review controls, set applicability & implementation, and document rationale/evidence. Data persists locally.
    </p>
  </div>

  <div class="card soaShell">
    <div class="glow"></div>
    <div class="inner">
      <div class="soaTop">
        <div>
          <h3>Statement of Applicability (SoA)</h3>
          <div class="soaSub">
            A practical SoA workspace aligned to the rest of the portal. Select a control on the left and document rationale/evidence on the right.
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div class="badge" id="soa-count"></div>
          <button class="btn small primary" id="soa-export" type="button">Export SoA CSV</button>
          <button id="soa-reset" class="btn small" type="button" title="Reset SoA filters">Reset</button>
        </div>
      </div>

      <div class="soaFilters">
        <div class="f">
          <label for="soa-framework-filter">Filter by Framework</label>
          <select id="soa-framework-filter" class="form-control form-control-sm">
            <option value="all">All frameworks</option>
            <option value="ISO 27001">ISO 27001</option>
            <option value="NIST CSF">NIST CSF</option>
            <option value="PCI DSS">PCI DSS</option>
            <option value="HIPAA">HIPAA</option>
            <option value="SOC 2">SOC 2</option>
          </select>
        </div>
        <div class="f">
          <label for="soa-category-filter">Filter by Category</label>
          <select id="soa-category-filter" class="form-control form-control-sm">
            <option value="all">All categories</option>
            <option>Access Control</option>
            <option>Identity &amp; Authentication</option>
            <option>Logging &amp; Monitoring</option>
            <option>Encryption &amp; Key Management</option>
            <option>Backup &amp; Recovery</option>
            <option>Change Management</option>
            <option>Incident Response</option>
            <option>Vendor Risk</option>
            <option>Network Security</option>
            <option>Asset Management</option>
          </select>
        </div>
        <div class="f">
          <label for="soa-applicability-filter">Filter by Applicability</label>
          <select id="soa-applicability-filter" class="form-control form-control-sm">
            <option value="all">All</option>
            <option>Applicable</option>
            <option>Not Applicable</option>
          </select>
        </div>
        <div class="f">
          <label for="soa-implementation-filter">Filter by Implementation</label>
          <select id="soa-implementation-filter" class="form-control form-control-sm">
            <option value="all">All</option>
            <option>In place</option>
            <option>Planned</option>
            <option>Not implemented</option>
            <option>Not applicable</option>
          </select>
        </div>
        <div class="f" style="min-width:260px; flex: 2 1 260px;">
          <label for="soa-search">Search controls</label>
          <input id="soa-search" type="text" placeholder="Search by ID, name, category..." autocomplete="off">
        </div>
      </div>

      <div class="soaSplit">
        <div class="soaPane">
          <div class="soaPaneHead">
            <div>
              <div class="t">Controls</div>
              <div class="k">Click a control to edit details</div>
            </div>
            <div class="badge" id="soa-list-badge">—</div>
          </div>
          <div class="soaList" id="soa-list"></div>
        </div>

        <div class="soaPane">
          <div class="soaPaneHead">
            <div>
              <div class="t">SoA Editor</div>
              <div class="k">Edits autosave locally</div>
            </div>
            <div class="badge" id="soa-editor-badge">No selection</div>
          </div>

          <div class="soaEmpty" id="soa-editor-empty">
            Select a control from the left to edit applicability, implementation, owner, rationale, and evidence.
            <div class="soaHint" style="margin-top:8px;">
              Tip: Keep rationale short and specific. Evidence can be URLs/links, ticket IDs, policies, screenshots, or document references.
            </div>
          </div>

          <div class="soaEditor" id="soa-editor" style="display:none;">
            <div class="row">
              <div class="field">
                <label>Control</label>
                <input id="soa-edit-title" type="text" readonly>
              </div>
              <div class="field">
                <label>Frameworks</label>
                <input id="soa-edit-frameworks" type="text" readonly>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="soa-edit-app">Applicability</label>
                <select id="soa-edit-app">
                  <option>Applicable</option>
                  <option>Not Applicable</option>
                </select>
              </div>
              <div class="field">
                <label for="soa-edit-impl">Implementation</label>
                <select id="soa-edit-impl">
                  <option value="Auto">Auto (from local controls)</option>
                  <option>In place</option>
                  <option>Planned</option>
                  <option>Not implemented</option>
                  <option>Not applicable</option>
                </select>
                <div class="soaHint" id="soa-edit-resolved">Resolved: —</div>
              </div>
            </div>

            <div class="row">
              <div class="field" style="grid-column: 1 / -1;">
                <label for="soa-edit-owner">Owner</label>
                <input id="soa-edit-owner" type="text" placeholder="Owner / team">
              </div>
            </div>

            <div class="field">
              <label for="soa-edit-rationale">Rationale</label>
              <textarea id="soa-edit-rationale" placeholder="Why is this applicable/not applicable? Why this implementation status?"></textarea>
            </div>

            <div class="field">
              <label for="soa-edit-evidence">Evidence</label>
              <textarea class="evd" id="soa-edit-evidence" placeholder="Evidence links, tickets, policies, screenshots (comma-separated or line-separated)"></textarea>
            </div>

            <div class="soaHint">
              Saved automatically. Use Export SoA CSV for reporting.
            </div>
          </div>
        </div>
      </div>

      <!-- Legacy SoA table kept for export logic & internal compatibility; hidden from users -->
      <div class="soaLegacy">
        <div class="bg-dark p-3 rounded mb-2">
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="text-muted small mb-1">Filter by Framework</label>
              <select class="form-control form-control-sm" id="soa-framework-filter-legacy">
                <option value="all">All frameworks</option>
              </select>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-bordered table-sm align-middle">
            <thead>
              <tr>
                <th style="width:3%"></th>
                <th style="width:8%">ID</th>
                <th style="width:22%">Name</th>
                <th style="width:14%">Category</th>
                <th style="width:12%">Frameworks</th>
                <th style="width:12%">Applicability</th>
                <th style="width:12%">Implementation</th>
                <th style="width:10%">Owner</th>
                <th style="width:20%">Rationale / Evidence</th>
              </tr>
            </thead>
            <tbody id="soa-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="grc-tab ftco-animate" id="tab-dashboard">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Monitor key metrics. Use to track progress. Tip: Aim for low high risks, high coverage, no overdue.</span></span>: Overview of your GRC posture.</p>
</div>
<h3>Dashboard</h3>
<div class="row">
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Assets</div><div class="value" id="dash-assets">0</div><div class="sub">Tracked</div></div>
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Vendors</div><div class="value" id="dash-vendors">0</div><div class="sub">Managed</div></div> <!-- New -->
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Risks</div><div class="value" id="dash-risks">0</div><div class="sub"><span id="dash-high">0</span> high</div></div>
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Controls</div><div class="value" id="dash-controls">0</div><div class="sub">Implemented</div></div>
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Issues</div><div class="value" id="dash-issues">0</div><div class="sub"><span id="dash-overdue">0</span> overdue</div></div>
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Incidents</div><div class="value" id="dash-incidents">0</div><div class="sub">Open</div></div> <!-- New -->
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Treatments</div><div class="value" id="dash-treatments">0</div><div class="sub">In progress</div></div>
</div>
<div class="col-sm-6 col-md-3 mb-3">
<div class="dashboard-card p-3 h-100"><div class="label">Compliance Coverage</div><div class="value" id="dash-coverage">0%</div><div class="sub">Implemented</div></div>
</div>
</div>
<div class="row mt-2">
<div class="col-md-4 mb-3">
<div class="dashboard-card p-3 h-100 d-flex flex-column justify-content-between">
<div>
<div class="label">Framework coverage</div>
<div class="value"><span id="dash-coverage">0%</span></div>
<div class="sub">Implemented local controls mapped to frameworks.</div>
</div>
<div class="mt-2"><span class="heat-pill heat-none" id="dash-coverage-pill">Coverage heat</span></div>
</div>
</div>
<div class="col-md-4 mb-3">
<div class="dashboard-card p-3 h-100">
<div class="label mb-1">Templates</div>
<p class="sub">Load pre-built setups for standards.</p>
<div class="d-flex flex-wrap">
<button class="btn btn-sm btn-outline-info mr-2 mb-2" id="load-iso-template">Load ISO 27001</button>
<button class="btn btn-sm btn-outline-info mr-2 mb-2" id="load-nist-template">Load NIST CSF</button>
<button class="btn btn-sm btn-outline-info mr-2 mb-2" id="load-pci-template">Load PCI DSS</button>
<button class="btn btn-sm btn-outline-info mb-2" id="load-hipaa-template">Load HIPAA</button>
</div>
</div>
</div>
<div class="col-md-4 mb-3">
<div class="dashboard-card p-3 h-100">
<div class="label mb-1">Scenarios &amp; exports</div>
<p class="sub">Manage data and load examples.</p>
<div class="d-flex flex-wrap">
<button class="btn btn-sm btn-primary mr-2 mb-2" id="btn-export">Export JSON</button>
<button class="btn btn-sm btn-outline-light mr-2 mb-2" id="btn-import">Import JSON</button>
<button class="btn btn-sm btn-outline-info mr-2 mb-2" id="btn-load-demo">Load Demo</button>
<button class="btn btn-sm btn-outline-danger mb-2" id="btn-reset">Reset All</button>
<input accept="application/json" id="file-import" style="display:none" type="file"/>
</div>
<small class="text-muted d-block mt-2" id="import-status"></small>
</div>
</div>
</div>
</div>
<!-- Risk Matrix -->
<div class="grc-tab ftco-animate" id="tab-matrix">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Visualize risks. Toggle inherent vs residual. Export PNG for reports. Tip: Residual shows control effectiveness.</span></span>: Risk visualization tool.</p>
</div>
<h3>Risk Matrix (Inherent vs Residual)</h3>
<p class="mb-3">Toggle to compare inherent (pre-controls) and residual (post-controls) risks.</p>
<div class="bg-dark p-3 rounded mb-3">
<div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
<div class="btn-group btn-group-toggle" data-toggle="buttons">
<label class="btn btn-sm btn-primary active" id="toggle-inherent"><input checked="" name="mx" type="radio"/> Inherent</label>
<label class="btn btn-sm btn-outline-light" id="toggle-residual"><input name="mx" type="radio"/> Residual</label>
</div>
<button class="btn btn-outline-light btn-sm" id="matrix-export">Export PNG</button>
</div>
<canvas height="640" id="risk-matrix-canvas" width="920"></canvas>
<div class="mt-3 text-center text-muted small" id="matrix-legend"></div>
</div>
</div>
<!-- Auditor Summary -->
<div class="grc-tab ftco-animate" id="tab-summary">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Auto-generated narrative. Refresh after changes. Copy/export for docs. Tip: Customize in reports tab.</span></span>: Executive summary generator.</p>
</div>
<h3>Auditor-style Summary</h3>
<p class="mb-3">Generated narrative narrative for reports/decks.</p>
<div class="bg-dark p-3 rounded mb-3">
<div class="d-flex justify-content-between align-items-center mb-2">
<span class="small-muted">Based on current data.</span>
<div>
<button class="btn btn-sm btn-primary mr-2" id="summary-refresh">Refresh</button>
<button class="btn btn-sm btn-outline-light mr-2" id="summary-copy">Copy</button>
<button class="btn btn-sm btn-outline-light mr-2" id="summary-export-md">Export MD</button>
<button class="btn btn-sm btn-outline-light" id="summary-export-pdf">Export PDF</button>
</div>
</div>
<textarea class="form-control" id="summary-text" rows="16"></textarea>
<div class="small-muted mt-2">Tip: Use in audit reports or ISO SoA.</div>
</div>
</div>
<!-- Reports -->
<div class="grc-tab ftco-animate" id="tab-reports">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Select type, generate. Export MD/PDF. Tip: Customize text before export.</span></span>: Create customizable reports.</p>
</div>
<h3>Reports</h3>
<p class="mb-3">Generate teaching-oriented reports.</p>
<div class="bg-dark p-3 rounded mb-3">
<div class="d-flex justify-content-between align-items-center mb-2">
<span class="small-muted">Select type.</span>
<select class="form-control form-control-sm mr-2" id="report-type" style="width:200px;">
<option value="full-audit">Full Audit</option>
<option value="risk-register">Risk Register</option>
<option value="control-coverage">Control Coverage</option>
<option value="issue-summary">Issue Summary</option>
<option value="vendor-report">Vendor Risk</option> <!-- New -->
<option value="incident-report">Incident Log</option> <!-- New -->
</select>
<button class="btn btn-sm btn-primary mr-2" id="generate-report">Generate</button>
<button class="btn btn-sm btn-outline-light mr-2" id="report-export-md">Export MD</button>
<button class="btn btn-sm btn-outline-light" id="report-export-pdf">Export PDF</button>
</div>
<textarea class="form-control" id="report-text" rows="16"></textarea>
<div class="small-muted mt-2">Edit text if needed before export.</div>
</div>
</div>
<!-- Challenge Mode -->
<div class="grc-tab ftco-animate" id="tab-challenges">
<div class="guidance">
<p><span class="tooltip">How to use<span class="tooltiptext">Select challenge, complete tasks in lab, check score. Tip: Use to practice real scenarios, aim for high scores.</span></span>: Gamified learning mode.</p>
</div>
<h3>Challenge Mode</h3>
<p class="mb-3">Test your GRC skills with scored challenges. Complete tasks, then self-score.</p>
<div class="challenge-card">
<h4>Challenge 1: Basic Risk Assessment (Beginner)</h4>
<p>Scenario: You're a new analyst at a small e-commerce company. Identify 5 risks for their web app and database.</p>
<ul>
<li>Add 2 assets</li>
<li>Add 5 risks, score them</li>
<li>Add 3 controls to mitigate</li>
<li>Achieve 60% coverage in gap analysis</li>
</ul>
<p>Score: Check dashboard - 1 point per task, bonus for high risks mitigated. Your score: <span class="challenge-score" id="challenge-1-score">0/5</span></p>
<button class="btn btn-sm btn-primary" onclick="scoreChallenge(1)">Calculate Score</button>
</div>
<div class="challenge-card">
<h4>Challenge 2: Compliance Mapping (Intermediate)</h4>
<p>Scenario: Prepare for ISO 27001 certification. Map controls to Annex A.</p>
<ul>
<li>Load ISO template</li>
<li>Add 10 local controls</li>
<li>Map to at least 20 framework controls</li>
<li>Complete SoA with rationale</li>
<li>Achieve 75% coverage</li>
</ul>
<p>Score: <span class="challenge-score" id="challenge-2-score">0/5</span></p>
<button class="btn btn-sm btn-primary" onclick="scoreChallenge(2)">Calculate Score</button>
</div>
<div class="challenge-card">
<h4>Challenge 3: Incident Response (Advanced)</h4>
<p>Scenario: Simulate a data breach. Log incident, link to risks, add treatments.</p>
<ul>
<li>Add incident with critical severity</li>
<li>Link to asset/risk/control</li>
<li>Add 3 treatments with targets</li>
<li>Update risk residual</li>
<li>Generate incident report</li>
</ul>
<p>Score: <span class="challenge-score" id="challenge-3-score">0/5</span></p>
<button class="btn btn-sm btn-primary" onclick="scoreChallenge(3)">Calculate Score</button>
</div>
</div>
</div>
</section>
<footer class="ftco-footer ftco-section">
<div class="container">
<div class="row"><div class="col-md-12 text-center">
<p>Copyright ©<script>
  // Ensure tab button class exists for JS bindings (safety)
  document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll(".grc-tab-buttons button[data-grc-tab]").forEach(b=>b.classList.add("grc-tab-button"));
  });
</script>
<script>document.write(new Date().getFullYear());</script> All rights reserved | GRC Practice Lab by John B Joseph | Empowering Future GRC Leaders</p>
</div></div>
</div>
</footer>
<!-- Toast container -->
<div class="toast-message" id="toast-container"></div>
<!-- Core scripts -->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/main.js"></script>
<!-- GRC Lab App -->
<script>
  // ---------- Expanded Framework library (over 200 controls) ----------
  const FRAMEWORK_CONTROLS = [
    // ISO 27001 Annex A
    {id:"CTRL-5.1",name:"Policies for information security",category:"Organisational Controls",
      description:"Information security policy and topic-specific policies shall be defined, approved by management, published, communicated to and acknowledged by relevant personnel and relevant interested parties, and reviewed at planned intervals and if significant changes occur.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.1"]},
    {id:"CTRL-5.2",name:"Information security roles and responsibilities",category:"Organisational Controls",
      description:"Information security roles and responsibilities shall be defined and allocated according to the organization needs.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.2"]},
    {id:"CTRL-5.3",name:"Segregation of duties",category:"Organisational Controls",
      description:"Conflicting duties and conflicting areas of responsibility shall be segregated.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.3"]},
    {id:"CTRL-5.4",name:"Management responsibilities",category:"Organisational Controls",
      description:"Management shall require all personnel to apply information security in accordance with the established information security policy, topic-specific policies and procedures of the organization.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.4"]},
    {id:"CTRL-5.5",name:"Contact with authorities",category:"Organisational Controls",
      description:"The organization shall establish and maintain contact with relevant authorities.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.5"]},
    {id:"CTRL-5.6",name:"Contact with special interest groups",category:"Organisational Controls",
      description:"The organization shall establish and maintain contact with special interest groups or other specialist security forums and professional associations.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.6"]},
    {id:"CTRL-5.7",name:"Threat intelligence",category:"Organisational Controls",
      description:"Information relating to information security threats shall be collected and analysed to produce threat intelligence.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.7"]},
    {id:"CTRL-5.8",name:"Information security in project management",category:"Organisational Controls",
      description:"Information security shall be integrated into project management.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.8"]},
    {id:"CTRL-5.9",name:"Inventory of information and other associated assets",category:"Organisational Controls",
      description:"An inventory of information and other associated assets, including owners, shall be developed and maintained.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.9"]},
    {id:"CTRL-5.10",name:"Acceptable use of information and other associated assets",category:"Organisational Controls",
      description:"Rules for the acceptable use and procedures for handling information and other associated assets shall be identified, documented and implemented.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.10"]},
    {id:"CTRL-5.11",name:"Return of assets",category:"Organisational Controls",
      description:"Personnel and other interested parties as appropriate shall return all the organization's assets in their possession upon change or termination of their employment, contract or agreement.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.11"]},
    {id:"CTRL-5.12",name:"Classification of information",category:"Organisational Controls",
      description:"Information shall be classified according to the information security needs of the organization based on confidentiality, integrity, availability and relevant interested party requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.12"]},
    {id:"CTRL-5.13",name:"Labelling of information",category:"Organisational Controls",
      description:"An appropriate set of procedures for information labelling shall be developed and implemented in accordance with the information classification scheme adopted by the organization.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.13"]},
    {id:"CTRL-5.14",name:"Information transfer",category:"Organisational Controls",
      description:"Information transfer rules, procedures, or agreements shall be in place for all types of transfer facilities within the organization and between the organization and other parties.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.14"]},
    {id:"CTRL-5.15",name:"Access control",category:"Organisational Controls",
      description:"Rules to control physical and logical access to information and other associated assets shall be established and implemented based on business and information security requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.15"]},
    {id:"CTRL-5.16",name:"Identity management",category:"Organisational Controls",
      description:"The full life cycle of identities shall be managed.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.16"]},
    {id:"CTRL-5.17",name:"Authentication information",category:"Organisational Controls",
      description:"Allocation and management of authentication information shall be controlled by a management process, including advising personnel on appropriate handling of authentication information.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.17"]},
    {id:"CTRL-5.18",name:"Access rights",category:"Organisational Controls",
      description:"Access rights to information and other associated assets shall be provisioned, reviewed, modified and removed in accordance with the organization's topic-specific policy on and rules for access control.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.18"]},
    {id:"CTRL-5.19",name:"Information security in supplier relationships",category:"Organisational Controls",
      description:"Processes and procedures shall be defined and implemented to manage the information security risks associated with the use of supplier's products or services.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.19"]},
    {id:"CTRL-5.20",name:"Addressing information security within supplier agreements",category:"Organisational Controls",
      description:"Relevant information security requirements shall be established and agreed with each supplier based on the type of supplier relationship.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.20"]},
    {id:"CTRL-5.21",name:"Managing information security in the ICT supply chain",category:"Organisational Controls",
      description:"Processes and procedures shall be defined and implemented to manage the information security risks associated with the ICT products and services supply chain.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.21"]},
    {id:"CTRL-5.22",name:"Monitoring, review and change management of supplier services",category:"Organisational Controls",
      description:"The organization shall regularly monitor, review, evaluate and manage change in supplier information security practices.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.22"]},
    {id:"CTRL-5.23",name:"Information security for use of cloud services",category:"Organisational Controls",
      description:"Processes for acquisition, use, management and exit from cloud services shall be established in accordance with the organization's information security requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.23"]},
    {id:"CTRL-5.24",name:"Information security incident management planning and preparation",category:"Organisational Controls",
      description:"The organization shall plan and prepare for managing information security incidents by defining, establishing and communicating information security incident management processes, roles and responsibilities.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.24"]},
    {id:"CTRL-5.25",name:"Assessment and decision on information security events",category:"Organisational Controls",
      description:"The organization shall assess information security events and decide if they are to be categorised as information security incidents.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.25"]},
    {id:"CTRL-5.26",name:"Response to information security incidents",category:"Organisational Controls",
      description:"Information security incidents shall be responded to in accordance with the documented procedures.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.26"]},
    {id:"CTRL-5.27",name:"Learning from information security incidents",category:"Organisational Controls",
      description:"Knowledge gained from information security incidents shall be used to strengthen and improve the information security controls.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.27"]},
    {id:"CTRL-5.28",name:"Collection of evidence",category:"Organisational Controls",
      description:"The organization shall establish and implement procedures for the identification, collection, acquisition and preservation of evidence related to information security events.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.28"]},
    {id:"CTRL-5.29",name:"Information security during disruption",category:"Organisational Controls",
      description:"The organization shall plan how to maintain information security at an appropriate level during disruption.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.29"]},
    {id:"CTRL-5.30",name:"ICT readiness for business continuity",category:"Organisational Controls",
      description:"ICT readiness shall be planned, implemented, maintained and tested based on business continuity objectives and continuity requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.30"]},
    {id:"CTRL-5.31",name:"Legal, statutory, regulatory and contractual requirements",category:"Organisational Controls",
      description:"Legal, statutory, regulatory and contractual requirements relevant to information security and the organization's approach to meet these requirements shall be identified, documented and kept up to date.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.31"]},
    {id:"CTRL-5.32",name:"Intellectual property rights",category:"Organisational Controls",
      description:"The organization shall implement appropriate procedures to protect intellectual property rights.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.32"]},
    {id:"CTRL-5.33",name:"Protection of records",category:"Organisational Controls",
      description:"Records shall be protected from loss, destruction, falsification, unauthorized access and unauthorized release.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.33"]},
    {id:"CTRL-5.34",name:"Privacy and protection of PII",category:"Organisational Controls",
      description:"The organization shall identify and meet the requirements regarding the preservation of privacy and protection of PII according to applicable laws and regulations and contractual requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.34"]},
    {id:"CTRL-5.35",name:"Independent review of information security",category:"Organisational Controls",
      description:"The organization's approach to managing information security and its implementation shall be reviewed independently at planned intervals, or when significant changes occur.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.35"]},
    {id:"CTRL-5.36",name:"Compliance with security policies and standards",category:"Organisational Controls",
      description:"Managers shall regularly review the compliance of information processing and procedures within their area of responsibility with the appropriate security policies, standards and any other security requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.36"]},
    {id:"CTRL-5.37",name:"Documented operating procedures",category:"Organisational Controls",
      description:"Operating procedures for information processing facilities shall be documented and made available to personnel who need them.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.5.37"]},
    // A.6 People Controls (8)
    {id:"CTRL-6.1",name:"Screening",category:"People Controls",
      description:"Background verification checks on all candidates to become personnel shall be carried out prior to joining the organization and on an ongoing basis taking into consideration applicable laws, regulations and ethics and be proportional to the business requirements, the classification of the information to be accessed and the perceived risks.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.1"]},
    {id:"CTRL-6.2",name:"Terms and conditions of employment",category:"People Controls",
      description:"Personnel shall agree to terms and conditions of employment, which includes the organization's information security policy and appropriate topic-specific policies.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.2"]},
    {id:"CTRL-6.3",name:"Information security awareness, education and training",category:"People Controls",
      description:"Personnel of the organization and relevant interested parties shall receive appropriate information security awareness, education and training and regular updates of the organization's information security policy and topic-specific policies, as relevant for their job function.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.3"]},
    {id:"CTRL-6.4",name:"Disciplinary process",category:"People Controls",
      description:"A disciplinary process shall be formalized and communicated to take actions against personnel and other relevant interested parties who have committed an information security policy violation.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.4"]},
    {id:"CTRL-6.5",name:"Responsibilities after termination or change of employment",category:"People Controls",
      description:"Information security responsibilities and duties that remain valid after termination or change of employment shall be defined, enforced and communicated to relevant personnel and other interested parties.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.5"]},
    {id:"CTRL-6.6",name:"Confidentiality or non-disclosure agreements",category:"People Controls",
      description:"Confidentiality or non-disclosure agreements reflecting the organization's needs for the protection of information shall be identified, documented, regularly reviewed and signed by personnel and other relevant interested parties.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.6"]},
    {id:"CTRL-6.7",name:"Remote working",category:"People Controls",
      description:"Security measures shall be implemented when personnel are working remotely to protect information accessed, processed or stored outside the organization's premises.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.7"]},
    {id:"CTRL-6.8",name:"Information security event reporting",category:"People Controls",
      description:"The organization shall provide a mechanism for personnel to report observed or suspected information security events through appropriate channels in a timely manner.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.6.8"]},
    // A.7 Physical Controls (14)
    {id:"CTRL-7.1",name:"Physical security perimeters",category:"Physical Controls",
      description:"Security perimeters shall be defined and used to protect areas that contain information and other associated assets.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.1"]},
    {id:"CTRL-7.2",name:"Physical entry",category:"Physical Controls",
      description:"Secure areas shall be protected by appropriate entry controls and access points.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.2"]},
    {id:"CTRL-7.3",name:"Securing offices, rooms and facilities",category:"Physical Controls",
      description:"Physical security for offices, rooms and facilities shall be designed and implemented.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.3"]},
    {id:"CTRL-7.4",name:"Physical security monitoring",category:"Physical Controls",
      description:"Premises shall be continuously monitored for unauthorized physical access.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.4"]},
    {id:"CTRL-7.5",name:"Protecting against physical and environmental threats",category:"Physical Controls",
      description:"Protection against physical and environmental threats, such as natural disasters and other intentional or accidental physical threats to infrastructure, shall be designed and implemented.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.5"]},
    {id:"CTRL-7.6",name:"Working in secure areas",category:"Physical Controls",
      description:"Security measures for working in secure areas shall be designed and implemented.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.6"]},
    {id:"CTRL-7.7",name:"Clear desk and clear screen",category:"Physical Controls",
      description:"Clear desk rules for papers and removable storage media and clear screen rules for information processing facilities shall be defined and appropriately enforced.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.7"]},
    {id:"CTRL-7.8",name:"Equipment siting and protection",category:"Physical Controls",
      description:"Equipment shall be sited securely and protected against environmental threats.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.8"]},
    {id:"CTRL-7.9",name:"Security of assets off-premises",category:"Physical Controls",
      description:"Off-premise assets shall be protected.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.9"]},
    {id:"CTRL-7.10",name:"Storage media",category:"Physical Controls",
      description:"Storage media shall be managed in accordance with the organization's classification scheme and media handling procedures.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.10"]},
    {id:"CTRL-7.11",name:"Supporting utilities",category:"Physical Controls",
      description:"Information processing facilities shall be protected from power failures and other disruptions caused by failures in supporting utilities.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.11"]},
    {id:"CTRL-7.12",name:"Cabling security",category:"Physical Controls",
      description:"Cables carrying power, data or supporting information services shall be protected from interception, interference or damage.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.12"]},
    {id:"CTRL-7.13",name:"Equipment maintenance",category:"Physical Controls",
      description:"Equipment shall be maintained to ensure continued availability and integrity.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.13"]},
    {id:"CTRL-7.14",name:"Secure disposal or re-use of equipment",category:"Physical Controls",
      description:"Items of equipment containing storage media shall be verified to ensure that any sensitive data and licensed software has been removed or securely overwritten prior to disposal or re-use.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.7.14"]},
    // A.8 Technological Controls (34)
    {id:"CTRL-8.1",name:"User endpoint devices",category:"Technological Controls",
      description:"Information stored on, processed by or accessible via user endpoint devices shall be protected.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.1"]},
    {id:"CTRL-8.2",name:"Privileged access rights",category:"Technological Controls",
      description:"The allocation and use of privileged access rights shall be restricted and managed.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.2"]},
    {id:"CTRL-8.3",name:"Information access restriction",category:"Technological Controls",
      description:"Access to information and other associated assets shall be restricted in accordance with the established topic-specific policy on access control.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.3"]},
    {id:"CTRL-8.4",name:"Access to source code",category:"Technological Controls",
      description:"Read and write access to source code, development tools and software libraries shall be appropriately managed.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.4"]},
    {id:"CTRL-8.5",name:"Secure authentication",category:"Technological Controls",
      description:"Secure authentication technologies and procedures shall be implemented based on information access restrictions and the topic-specific policy on access control.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.5"]},
    {id:"CTRL-8.6",name:"Capacity management",category:"Technological Controls",
      description:"The use of resources shall be monitored and adjusted in accordance with current and expected capacity requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.6"]},
    {id:"CTRL-8.7",name:"Protection against malware",category:"Technological Controls",
      description:"Protection against malware shall be implemented and supported by appropriate user awareness.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.7"]},
    {id:"CTRL-8.8",name:"Management of technical vulnerabilities",category:"Technological Controls",
      description:"Information about technical vulnerabilities of information systems in use shall be obtained, the organization's exposure to such vulnerabilities shall be evaluated and appropriate measures shall be taken.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.8"]},
    {id:"CTRL-8.9",name:"Configuration management",category:"Technological Controls",
      description:"Configurations, including security configurations, of hardware, software, services and networks shall be established, documented, implemented, monitored and reviewed.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.9"]},
    {id:"CTRL-8.10",name:"Information deletion",category:"Technological Controls",
      description:"Information stored in information systems, devices or in any other storage media shall be deleted when no longer required.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.10"]},
    {id:"CTRL-8.11",name:"Data masking",category:"Technological Controls",
      description:"Data masking shall be used in accordance with the organization's topic-specific policy on access control and other related topic-specific policies, and business requirements, taking applicable legislation into consideration.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.11"]},
    {id:"CTRL-8.12",name:"Data leakage prevention",category:"Technological Controls",
      description:"Data leakage prevention measures shall be applied to systems, networks and any other devices that process, store or transmit sensitive information.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.12"]},
    {id:"CTRL-8.13",name:"Information backup",category:"Technological Controls",
      description:"Backup facilities and a defined and documented backup procedure shall be provided to maintain availability and integrity of information.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.13"]},
    {id:"CTRL-8.14",name:"Redundancy of information processing facilities",category:"Technological Controls",
      description:"Information processing facilities shall be implemented with redundancy sufficient to meet availability requirements.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.14"]},
    {id:"CTRL-8.15",name:"Logging",category:"Technological Controls",
      description:"Logs that record activities, exceptions, faults and other relevant events shall be produced, stored, protected and analysed.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.15"]},
    {id:"CTRL-8.16",name:"Monitoring activities",category:"Technological Controls",
      description:"Networks, systems and applications shall be monitored for anomalous behaviour and appropriate actions taken to evaluate potential information security incidents.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.16"]},
    {id:"CTRL-8.17",name:"Clock synchronization",category:"Technological Controls",
      description:"The clocks of information processing systems used by the organization shall be synchronized to approved time sources.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.17"]},
    {id:"CTRL-8.18",name:"Use of privileged utility programs",category:"Technological Controls",
      description:"The use of utility programs that can be capable of overriding system and application controls shall be restricted and tightly controlled.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.18"]},
    {id:"CTRL-8.19",name:"Installation of software on operational systems",category:"Technological Controls",
      description:"Procedures and measures shall be implemented to securely manage software installation on operational systems.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.19"]},
    {id:"CTRL-8.20",name:"Networks security",category:"Technological Controls",
      description:"Networks and network devices shall be secured, managed and controlled to protect information in systems and applications.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.20"]},
    {id:"CTRL-8.21",name:"Security of network services",category:"Technological Controls",
      description:"Security mechanisms, service levels and service requirements of network services shall be identified, implemented and monitored.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.21"]},
    {id:"CTRL-8.22",name:"Segregation of networks",category:"Technological Controls",
      description:"Groups of information services, users and information systems shall be segregated in the organization's networks.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.22"]},
    {id:"CTRL-8.23",name:"Web filtering",category:"Technological Controls",
      description:"Access to external websites shall be managed to reduce exposure to malicious content.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.23"]},
    {id:"CTRL-8.24",name:"Use of cryptography",category:"Technological Controls",
      description:"Rules for the effective use of cryptography, including cryptographic key management, shall be defined and implemented.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.24"]},
    {id:"CTRL-8.25",name:"Secure development life cycle",category:"Technological Controls",
      description:"Rules for the secure development of software and systems shall be established and applied.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.25"]},
    {id:"CTRL-8.26",name:"Application security requirements",category:"Technological Controls",
      description:"Information security requirements shall be identified, specified and approved when developing or acquiring applications.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.26"]},
    {id:"CTRL-8.27",name:"Secure system architecture and engineering principles",category:"Technological Controls",
      description:"Principles for engineering secure systems shall be established, documented, maintained and applied to any information system development activities.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.27"]},
    {id:"CTRL-8.28",name:"Secure coding",category:"Technological Controls",
      description:"Secure coding principles shall be applied to software development.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.28"]},
    {id:"CTRL-8.29",name:"Security testing in development and acceptance",category:"Technological Controls",
      description:"Security testing processes shall be defined and implemented in the development life cycle.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.29"]},
    {id:"CTRL-8.30",name:"Outsourced development",category:"Technological Controls",
      description:"The organization shall direct, monitor and review the activities related to outsourced system development.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.30"]},
    {id:"CTRL-8.31",name:"Separation of development, test and production environments",category:"Technological Controls",
      description:"Development, testing and production environments shall be separated and secured.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.31"]},
    {id:"CTRL-8.32",name:"Change management",category:"Technological Controls",
      description:"Changes to information processing facilities and information systems shall be subject to change management procedures.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.32"]},
    {id:"CTRL-8.33",name:"Test information",category:"Technological Controls",
      description:"Test information shall be appropriately selected, protected and managed.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.33"]},
    {id:"CTRL-8.34",name:"Protection of information systems during audit testing",category:"Technological Controls",
      description:"Audit tests and other assurance activities involving assessment of operational systems shall be planned and agreed between the tester and appropriate management.",
      frameworks:["ISO 27001"],references:["ISO 27001 A.8.34"]},
    // Add more from NIST CSF subcategories
    {id:"CTRL-ID.AM-01",name:"Physical devices and systems inventory",category:"Asset Management",
      description:"Inventories of physical devices and systems within the organization are maintained.",
      frameworks:["NIST CSF"],references:["NIST ID.AM-01"]},
    {id:"CTRL-ID.AM-02",name:"Software platforms and applications inventory",category:"Asset Management",
      description:"Inventories of software platforms and applications within the organization are maintained.",
      frameworks:["NIST CSF"],references:["NIST ID.AM-02"]},
    {id:"CTRL-ID.AM-03",name:"Organizational communication and data flows mapping",category:"Asset Management",
      description:"Organizational communication and data flows are mapped.",
      frameworks:["NIST CSF"],references:["NIST ID.AM-03"]},
    {id:"CTRL-ID.AM-04",name:"External information systems catalog",category:"Asset Management",
      description:"External information systems are catalogued.",
      frameworks:["NIST CSF"],references:["NIST ID.AM-04"]},
    {id:"CTRL-ID.AM-05",name:"Resources prioritization",category:"Asset Management",
      description:"Resources are prioritized based on their classification, criticality, and business value.",
      frameworks:["NIST CSF"],references:["NIST ID.AM-05"]},
    {id:"CTRL-ID.AM-06",name:"Cybersecurity roles and responsibilities definition",category:"Asset Management",
      description:"Cybersecurity roles and responsibilities for the entire workforce and third-party stakeholders are established.",
      frameworks:["NIST CSF"],references:["NIST ID.AM-06"]},
    {id:"CTRL-ID.BE-01",name:"Organization's role in supply chain identification",category:"Policy & Governance",
      description:"The organization's place in critical infrastructure and its sector is identified and communicated.",
      frameworks:["NIST CSF"],references:["NIST ID.BE-01"]},
    // Add more NIST...
    // From PCI DSS v4.0
    {id:"CTRL-PCI-1.1",name:"Processes for network security controls",category:"Network Security",
      description:"Processes and mechanisms for installing and maintaining network security controls are defined and understood.",
      frameworks:["PCI DSS"],references:["PCI DSS 1.1"]},
    {id:"CTRL-PCI-1.2",name:"Network security controls implementation",category:"Network Security",
      description:"Network security controls are implemented.",
      frameworks:["PCI DSS"],references:["PCI DSS 1.2"]},
    {id:"CTRL-PCI-1.3",name:"Network access restriction",category:"Network Security",
      description:"Network access to and from the cardholder data environment is restricted.",
      frameworks:["PCI DSS"],references:["PCI DSS 1.3"]},
    {id:"CTRL-PCI-1.4",name:"External network access restriction",category:"Network Security",
      description:"Network access from the internet to and from the cardholder data environment is restricted.",
      frameworks:["PCI DSS"],references:["PCI DSS 1.4"]},
    {id:"CTRL-PCI-1.5",name:"Risks from wireless networks",category:"Network Security",
      description:"Risks to the CDE from computing devices and networks with wireless access technology are managed.",
      frameworks:["PCI DSS"],references:["PCI DSS 1.5"]},
    {id:"CTRL-PCI-2.1",name:"Secure configurations processes",category:"Access Control",
      description:"Processes and mechanisms for applying secure configurations to components are defined and understood.",
      frameworks:["PCI DSS"],references:["PCI DSS 2.1"]},
    {id:"CTRL-PCI-2.2",name:"System configuration standards",category:"Access Control",
      description:"System configuration standards are developed, documented, and implemented.",
      frameworks:["PCI DSS"],references:["PCI DSS 2.2"]},
    {id:"CTRL-PCI-2.3",name:"Wireless environment security",category:"Network Security",
      description:"Wireless environments are configured and managed securely.",
      frameworks:["PCI DSS"],references:["PCI DSS 2.3"]},
    {id:"CTRL-PCI-3.1",name:"Processes for protecting stored account data",category:"Encryption & Key Management",
      description:"Processes and mechanisms for protecting stored account data are defined and understood.",
      frameworks:["PCI DSS"],references:["PCI DSS 3.1"]},
    {id:"CTRL-PCI-3.2",name:"Sensitive authentication data storage",category:"Encryption & Key Management",
      description:"Sensitive authentication data is not stored and PAN is rendered unrecoverable.",
      frameworks:["PCI DSS"],references:["PCI DSS 3.2"]},
    {id:"CTRL-PCI-3.3",name:"PAN masking",category:"Encryption & Key Management",
      description:"Primary account number is masked when displayed.",
      frameworks:["PCI DSS"],references:["PCI DSS 3.3"]},
    // Add more PCI...
    // From HIPAA
    {id:"CTRL-HIPAA-164.308(a)(1)(i)",name:"Security management process",category:"Policy & Governance",
      description:"Implement policies and procedures to prevent, detect, contain, and correct security violations.",
      frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(i)"]},
    {id:"CTRL-HIPAA-164.308(a)(1)(ii)(A)",name:"Risk analysis",category:"Policy & Governance",
      description:"Conduct an accurate and thorough assessment of the potential risks and vulnerabilities to the confidentiality, integrity, and availability of electronic protected health information held by the covered entity.",
      frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(A)"]},
    {id:"CTRL-HIPAA-164.308(a)(1)(ii)(B)",name:"Risk management",category:"Policy & Governance",
      description:"Implement security measures sufficient to reduce risks and vulnerabilities to a reasonable and appropriate level to comply with §164.306(a).",
      frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(B)"]},
    {id:"CTRL-HIPAA-164.308(a)(1)(ii)(C)",name:"Sanction policy",category:"Policy & Governance",
      description:"Apply appropriate sanctions against workforce members who fail to comply with the security policies and procedures of the covered entity.",
      frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(C)"]},
    {id:"CTRL-HIPAA-164.308(a)(1)(ii)(D)",name:"Information system activity review",category:"Logging & Monitoring",
      description:"Implement procedures to regularly review records of information system activity, such as audit logs, access reports, and security incident tracking reports.",
      frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(D)"]},
    // Add more HIPAA...
    // From SOC 2
    {id:"CTRL-SOC-CC1.1",name:"Commitment to integrity and ethical values",category:"Policy & Governance",
      description:"The entity demonstrates a commitment to integrity and ethical values.",
      frameworks:["SOC2"],references:["SOC2 CC1.1"]},
    {id:"CTRL-SOC-CC1.2",name:"Board independence",category:"Policy & Governance",
      description:"The board of directors demonstrates independence from management and exercises oversight of the development and performance of internal control.",
      frameworks:["SOC2"],references:["SOC2 CC1.2"]},
    {id:"CTRL-SOC-CC1.3",name:"Management roles and responsibilities",category:"Policy & Governance",
      description:"Management establishes, with board oversight, structures, reporting lines, and appropriate authorities and responsibilities in the pursuit of objectives.",
      frameworks:["SOC2"],references:["SOC2 CC1.3"]},
    {id:"CTRL-SOC-CC1.4",name:"Commitment to competent personnel",category:"Policy & Governance",
      description:"The entity demonstrates a commitment to attract, develop, and retain competent individuals in alignment with objectives.",
      frameworks:["SOC2"],references:["SOC2 CC1.4"]},
    {id:"CTRL-SOC-CC1.5",name:"Accountability",category:"Policy & Governance",
      description:"The entity holds individuals accountable for their internal control responsibilities in the pursuit of objectives.",
      frameworks:["SOC2"],references:["SOC2 CC1.5"]},
    {id:"CTRL-SOC-CC2.1",name:"Risk assessment objectives",category:"Policy & Governance",
      description:"The entity specifies objectives with sufficient clarity to enable the identification and assessment of risks relating to objectives.",
      frameworks:["SOC2"],references:["SOC2 CC2.1"]},
    {id:"CTRL-SOC-CC2.2",name:"Risk identification and assessment",category:"Policy & Governance",
      description:"The entity identifies risks to the achievement of its objectives across the entity and analyzes risks as a basis for determining how the risks should be managed.",
      frameworks:["SOC2"],references:["SOC2 CC2.2"]},
    {id:"CTRL-SOC-CC2.3",name:"Fraud risk",category:"Policy & Governance",
      description:"The entity considers the potential for fraud in assessing risks to the achievement of objectives.",
      frameworks:["SOC2"],references:["SOC2 CC2.3"]},
    {id:"CTRL-SOC-CC2.4",name:"Change management",category:"Change Management",
      description:"The entity identifies and assesses changes that could significantly impact the system of internal control.",
      frameworks:["SOC2"],references:["SOC2 CC2.4"]},
    // Add more SOC2...
  ];
  // ---------- Risk configuration (thresholds) ----------
  const RISK_CFG_KEY = 'grc_risk_cfg_v1';
  const defaultRiskConfig = { highMin: 15, mediumMin: 6 };
  function loadRiskConfig(){
    try{
      const raw = localStorage.getItem(RISK_CFG_KEY);
      if(!raw) return {...defaultRiskConfig};
      const parsed = JSON.parse(raw);
      return {
        highMin: typeof parsed.highMin === 'number' ? parsed.highMin : defaultRiskConfig.highMin,
        mediumMin: typeof parsed.mediumMin === 'number' ? parsed.mediumMin : defaultRiskConfig.mediumMin
      };
    }catch{
      return {...defaultRiskConfig};
    }
  }
  function saveRiskConfig(cfg){
    riskConfig = {
      highMin: Math.max(1, Math.min(25, Number(cfg.highMin) || defaultRiskConfig.highMin)),
      mediumMin: Math.max(1, Math.min(25, Number(cfg.mediumMin) || defaultRiskConfig.mediumMin))
    };
    localStorage.setItem(RISK_CFG_KEY, JSON.stringify(riskConfig));
  }
  let riskConfig = loadRiskConfig();
  // ---------- Storage ----------
  const K = {
    assets:'grc_assets_v1',
    risks:'grc_risks_v1',
    controls:'grc_controls_v1',
    issues:'grc_issues_v1',
    treats:'grc_treatments_v1',
    soa:'grc_soa_v1',
    vendors:'grc_vendors_v1',
    incidents:'grc_incidents_v1'
  };
  const load = k => { try { const v = JSON.parse(localStorage.getItem(k)); return Array.isArray(v)?v:[]; } catch { return []; } };
  const save = (k,v) => localStorage.setItem(k,JSON.stringify(v));
  let assets = load(K.assets);
  let risks = load(K.risks);
  let controls = load(K.controls);
  let issues = load(K.issues);
  let treatments = load(K.treats);
  let soa = load(K.soa);
  let vendors = load(K.vendors);
  let incidents = load(K.incidents);
  // ---------- Helpers ----------
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const getMulti = sel => {
    if(!sel) return [];
    const v = [];
    Array.from(sel.options).forEach(o => { if(o.selected && o.value) v.push(o.value); });
    return v;
  };
  const setMulti = (sel,vals) => {
    if(!sel) return;
    const S = new Set(vals||[]);
    Array.from(sel.options).forEach(o => o.selected = S.has(o.value));
  };
  const rScore = (l,i) => (Number(l)||0)*(Number(i)||0);
  function rLevel(s){
    const score = Number(s)||0;
    if(score <= 0) return '-';
    const high = riskConfig.highMin;
    const med = riskConfig.mediumMin;
    if(score >= high) return 'High';
    if(score >= med) return 'Medium';
    return 'Low';
  }
  // risk view state
  let riskFilterStatus = 'all';
  let riskFilterLevel = 'all';
  let riskSortField = 'score';
  let riskSortDir = 'desc';
  let lastRiskView = [];
  // Pagination settings
  const ITEMS_PER_PAGE = 10;
  function renderPagination(containerId, totalItems, currentPage, renderFunc) {
    const pagination = qs(`#${containerId}`);
    if (!pagination) return;
    pagination.innerHTML = '';
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    for (let i = 1; i <= totalPages; i++) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.textContent = i;
      a.href = '#';
      if (i === currentPage) li.classList.add('active');
      a.addEventListener('click', (e) => {
        e.preventDefault();
        renderFunc(i);
      });
      li.appendChild(a);
      pagination.appendChild(li);
    }
  }
  // Toast helper
  function showToast(message, isError = false) {
    const toast = qs('#toast-container');
    toast.textContent = message;
    toast.classList.add('show');
    if (isError) toast.classList.add('error');
    setTimeout(() => {
      toast.classList.remove('show');
      toast.classList.remove('error');
    }, 3000);
  }
  // ---------- Framework render ----------
  function renderFrameworkControls(){
    const tbody = qs('#frameworks-table-body');
    const countEl = qs('#frameworks-count');
    const f = qs('#framework-filter').value;
    const c = qs('#category-filter').value;
    const s = (qs('#framework-search').value||'').trim().toLowerCase();
    const filtered = FRAMEWORK_CONTROLS.filter(x => {
      const okF = f === 'all' || x.frameworks.includes(f);
      const okC = c === 'all' || x.category === c;
      const okS = !s || x.name.toLowerCase().includes(s) || x.description.toLowerCase().includes(s) || x.id.toLowerCase().includes(s);
      return okF && okC && okS;
    });
    tbody.innerHTML = '';
    filtered.forEach(x => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.id}</td>
        <td>${x.name}</td>
        <td>${x.category}</td>
        <td>${x.references.join('<br>')}</td>
        <td>${x.description}</td>`;
      tbody.appendChild(tr);
    });
    countEl.textContent = `${filtered.length} control(s) shown of ${FRAMEWORK_CONTROLS.length}`;
  }
  // ---------- Assets ----------
  let currentAssetsPage = 1;
  function selectedDataTypes(){ return qsa('.asset-dt').filter(cb=>cb.checked).map(cb=>cb.value); }
  function setDataTypes(vals){ qsa('.asset-dt').forEach(cb=>cb.checked=(vals||[]).includes(cb.value)); }
  function populateRiskAssetOptions(){
    const sel=qs('#risk-linked'); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Select asset or vendor...</option>';
    assets.forEach(a=>{ const o=document.createElement('option'); o.value='asset-'+a.id; o.textContent=a.name + ' (Asset)'; sel.appendChild(o); });
    vendors.forEach(v=>{ const o=document.createElement('option'); o.value='vendor-'+v.id; o.textContent=v.name + ' (Vendor)'; sel.appendChild(o); });
    if(cur && (assets.some(a=> 'asset-'+a.id === cur) || vendors.some(v=> 'vendor-'+v.id === cur))) sel.value=cur;
  }
  function populateIssueDropdowns(){
    const aSel=qs('#issue-asset'), vSel=qs('#issue-vendor'), rSel=qs('#issue-risk'), cSel=qs('#issue-control');
    const incASel=qs('#incident-asset'), incVSel=qs('#incident-vendor'), incRSel=qs('#incident-risk'), incCSel=qs('#incident-control');
    if(aSel){
      aSel.innerHTML = '<option value="">Linked asset...</option>';
      assets.forEach(a => {
        const o = document.createElement('option');
        o.value = a.id;
        o.textContent = a.name;
        aSel.appendChild(o);
      });
    }
    if(incASel){
      incASel.innerHTML = '<option value="">Linked asset...</option>';
      assets.forEach(a => {
        const o = document.createElement('option');
        o.value = a.id;
        o.textContent = a.name;
        incASel.appendChild(o);
      });
    }
    if(vSel){
      vSel.innerHTML = '<option value="">Linked vendor...</option>';
      vendors.forEach(v => {
        const o = document.createElement('option');
        o.value = v.id;
        o.textContent = v.name;
        vSel.appendChild(o);
      });
    }
    if(incVSel){
      incVSel.innerHTML = '<option value="">Linked vendor...</option>';
      vendors.forEach(v => {
        const o = document.createElement('option');
        o.value = v.id;
        o.textContent = v.name;
        incVSel.appendChild(o);
      });
    }
    if(rSel){
      rSel.innerHTML = '<option value="">Linked risk...</option>';
      risks.forEach(r => {
        const o = document.createElement('option');
        o.value = r.id;
        o.textContent = r.title;
        rSel.appendChild(o);
      });
    }
    if(incRSel){
      incRSel.innerHTML = '<option value="">Linked risk...</option>';
      risks.forEach(r => {
        const o = document.createElement('option');
        o.value = r.id;
        o.textContent = r.title;
        incRSel.appendChild(o);
      });
    }
    if(cSel){
      cSel.innerHTML = '<option value="">Linked control...</option>';
      controls.forEach(c => {
        const o = document.createElement('option');
        o.value = c.id;
        o.textContent = c.name;
        cSel.appendChild(o);
      });
    }
    if(incCSel){
      incCSel.innerHTML = '<option value="">Linked control...</option>';
      controls.forEach(c => {
        const o = document.createElement('option');
        o.value = c.id;
        o.textContent = c.name;
        incCSel.appendChild(o);
      });
    }
  }
  function renderAssetsTable(page = 1){
    currentAssetsPage = page;
    const tbody=qs('#assets-table-body'), empty=qs('#assets-empty'), count=qs('#assets-count');
    tbody.innerHTML='';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedAssets = assets.slice(start, end);
    paginatedAssets.forEach(a=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${a.name}</td>
        <td>${a.type}</td>
        <td>${a.criticality}</td>
        <td>${(a.dataTypes||[]).join(', ')}</td>
        <td>${a.owner||''}</td>
        <td>${a.location||''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ae="${a.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-ad="${a.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = assets.length ? 'none' : 'block';
    count.textContent = `${assets.length} asset(s)`;
    renderPagination('assets-pagination', assets.length, page, renderAssetsTable);
    populateRiskAssetOptions();
    populateIssueDropdowns();
    renderDashboard();
  }
  function resetAssetForm(){
    qs('#asset-form').reset();
    qs('#asset-id').value='';
    qs('#asset-form-submit').textContent='Save asset';
  }
  qs('#asset-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#asset-id').value;
    const name=qs('#asset-name').value.trim();
    const type=qs('#asset-type').value;
    const crit=qs('#asset-criticality').value;
    if(!name || !type || !crit) return alert('Fill name, type, criticality.');
    const obj={
      id: id || ('AST-'+Date.now()),
      name,
      type,
      criticality:crit,
      owner:qs('#asset-owner').value.trim(),
      dataTypes:selectedDataTypes(),
      location:qs('#asset-location').value.trim(),
      notes:qs('#asset-notes').value.trim()
    };
    const idx=assets.findIndex(x=>x.id===obj.id);
    if(idx>-1) assets[idx]=obj; else assets.push(obj);
    save(K.assets,assets);
    renderAssetsTable(currentAssetsPage);
    resetAssetForm();
    showToast('Asset saved successfully');
  });
  qs('#asset-form-cancel').addEventListener('click',resetAssetForm);
  qs('#assets-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ae');
    const idD=e.target.getAttribute('data-ad');
    if(idE){
      const a=assets.find(x=>x.id===idE); if(!a) return;
      qs('#asset-id').value=a.id;
      qs('#asset-name').value=a.name;
      qs('#asset-type').value=a.type;
      qs('#asset-criticality').value=a.criticality;
      qs('#asset-owner').value=a.owner||'';
      qs('#asset-location').value=a.location||'';
      qs('#asset-notes').value=a.notes||'';
      setDataTypes(a.dataTypes||[]);
      qs('#asset-form-submit').textContent='Update asset';
    }
    if(idD){
      if(!confirm('Delete this asset?')) return;
      assets=assets.filter(x=>x.id!==idD);
      save(K.assets,assets);
      // Unlink from risks, issues, incidents, etc.
      risks.forEach(r => {
        if (r.linked && r.linked === 'asset-' + idD) r.linked = '';
      });
      save(K.risks, risks);
      renderRisksTable();
      issues.forEach(i => {
        if (i.assetId === idD) i.assetId = '';
      });
      save(K.issues, issues);
      renderIssuesTable();
      incidents.forEach(inc => {
        if (inc.assetId === idD) inc.assetId = '';
      });
      save(K.incidents, incidents);
      renderIncidentsTable();
      renderAssetsTable(currentAssetsPage);
      showToast('Asset deleted');
    }
  });
  // ---------- Vendors ----------
  let currentVendorsPage = 1;
  function renderVendorsTable(page = 1){
    currentVendorsPage = page;
    const tbody=qs('#vendors-table-body'), empty=qs('#vendors-empty'), count=qs('#vendors-count');
    tbody.innerHTML='';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedVendors = vendors.slice(start, end);
    paginatedVendors.forEach(v=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${v.name}</td>
        <td>${v.type}</td>
        <td>${v.criticality}</td>
        <td>${v.dataAccess || ''}</td>
        <td>${v.contract || ''}</td>
        <td>${v.assessment || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ve="${v.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-vd="${v.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = vendors.length ? 'none' : 'block';
    count.textContent = `${vendors.length} vendor(s)`;
    renderPagination('vendors-pagination', vendors.length, page, renderVendorsTable);
    populateRiskAssetOptions();
    populateIssueDropdowns();
    renderDashboard();
  }
  function resetVendorForm(){
    qs('#vendor-form').reset();
    qs('#vendor-id').value='';
  }
  qs('#vendor-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#vendor-id').value;
    const name=qs('#vendor-name').value.trim();
    const type=qs('#vendor-type').value;
    const crit=qs('#vendor-criticality').value;
    if(!name || !type || !crit) return alert('Fill name, type, criticality.');
    const obj={
      id: id || ('VND-'+Date.now()),
      name,
      type,
      criticality:crit,
      dataAccess:qs('#vendor-data-access').value,
      contract:qs('#vendor-contract').value,
      assessment:qs('#vendor-assessment').value,
      notes:qs('#vendor-notes').value.trim()
    };
    const idx=vendors.findIndex(x=>x.id===obj.id);
    if(idx>-1) vendors[idx]=obj; else vendors.push(obj);
    save(K.vendors,vendors);
    renderVendorsTable(currentVendorsPage);
    resetVendorForm();
    showToast('Vendor saved successfully');
  });
  qs('#vendor-form-cancel').addEventListener('click',resetVendorForm);
  qs('#vendors-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ve');
    const idD=e.target.getAttribute('data-vd');
    if(idE){
      const v=vendors.find(x=>x.id===idE); if(!v) return;
      qs('#vendor-id').value=v.id;
      qs('#vendor-name').value=v.name;
      qs('#vendor-type').value=v.type;
      qs('#vendor-criticality').value=v.criticality;
      qs('#vendor-data-access').value=v.dataAccess || '';
      qs('#vendor-contract').value=v.contract || '';
      qs('#vendor-assessment').value=v.assessment || '';
      qs('#vendor-notes').value=v.notes || '';
    }
    if(idD){
      if(!confirm('Delete this vendor?')) return;
      vendors=vendors.filter(x=>x.id!==idD);
      save(K.vendors,vendors);
      // Unlink similar to assets
      risks.forEach(r => {
        if (r.linked && r.linked === 'vendor-' + idD) r.linked = '';
      });
      save(K.risks, risks);
      renderRisksTable();
      issues.forEach(i => {
        if (i.vendorId === idD) i.vendorId = '';
      });
      save(K.issues, issues);
      renderIssuesTable();
      incidents.forEach(inc => {
        if (inc.vendorId === idD) inc.vendorId = '';
      });
      save(K.incidents, incidents);
      renderIncidentsTable();
      renderVendorsTable(currentVendorsPage);
      showToast('Vendor deleted');
    }
  });
  // ---------- Risks ----------
  let currentRisksPage = 1;
  function resetRiskForm(){
    qs('#risk-form').reset();
    qs('#risk-id').value='';
    qs('#risk-form-submit').textContent='Save risk';
  }
  function populateControlRisks(){
    const sel=qs('#control-risks'); if(!sel) return;
    const cur=getMulti(sel);
    sel.innerHTML='';
    risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title;sel.appendChild(o);});
    setMulti(sel,cur);
  }
  function getSoAEntry(fcId){
    let e = soa.find(x=>x.fcId===fcId);
    if(!e){
      e = { fcId: fcId, applicability:'Applicable', implementation:'Auto', owner:'', rationale:'', evidence:'' };
      soa.push(e);
    }
    return e;
  }
  function saveSoA(){ save(K.soa, soa); }
  function riskCompare(a,b,field){
    switch(field){
      case 'score': return (a.score||0) - (b.score||0);
      case 'impact': return (a.impact||0) - (b.impact||0);
      case 'likelihood': return (a.likelihood||0) - (b.likelihood||0);
      case 'status': return (a.status||'').localeCompare(b.status||'');
      case 'asset': return (a.linkedName||'').localeCompare(b.linkedName||'');
      case 'title': default: return (a.title||'').localeCompare(b.title||'');
    }
  }
  function renderRisksTable(page = 1){
    currentRisksPage = page;
    const tbody=qs('#risks-table-body'), empty=qs('#risks-empty'), count=qs('#risks-count');
    let list = risks.slice();
    // filters
    if(riskFilterStatus !== 'all'){
      list = list.filter(r => (r.status||'') === riskFilterStatus);
    }
    if(riskFilterLevel !== 'all'){
      list = list.filter(r => rLevel(r.score) === riskFilterLevel);
    }
    // sort
    list.sort((a,b)=> riskCompare(a,b, riskSortField) * (riskSortDir === 'asc' ? 1 : -1));
    lastRiskView = list.slice();
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedList = list.slice(start, end);
    tbody.innerHTML='';
    paginatedList.forEach(r=>{
      const level=rLevel(r.score);
      const cls = level==='High'?'badge-danger':level==='Medium'?'badge-warning':level==='Low'?'badge-success':'';
      const resScore = rScore(r.resLikelihood, r.resImpact);
      const resLevel = rLevel(resScore);
      const resCls = resLevel==='High'?'badge-danger':resLevel==='Medium'?'badge-warning':resLevel==='Low'?'badge-success':'';
      const linkedName = r.linked ? r.linkedName : '';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.title}</td>
        <td>${linkedName||''}</td>
        <td>${r.category}</td>
        <td>${r.score?`<span class="badge ${cls} mr-1">${r.score}</span><span class="text-muted small">${level}</span>`:'-'}</td>
        <td>${resScore?`<span class="badge ${resCls} mr-1">${resScore}</span><span class="text-muted small">${resLevel}</span>`:'-'}</td>
        <td>${r.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-re="${r.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-rd="${r.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=list.length?'none':'block';
    count.textContent=`${list.length} risk(s) shown of ${risks.length}`;
    renderPagination('risks-pagination', list.length, page, renderRisksTable);
    populateControlRisks();
    populateIssueDropdowns();
    populateTreatmentDropdownLinked();
    renderDashboard();
  }
  qs('#risk-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#risk-id').value;
    const title=qs('#risk-title').value.trim();
    const linked=qs('#risk-linked').value;
    let linkedId = '';
    let linkedName = '';
    let linkedType = '';
    if (linked) {
      [linkedType, linkedId] = linked.split('-');
      if (linkedType === 'asset') {
        const asset = assets.find(a => a.id === linkedId);
        linkedName = asset ? asset.name : '';
      } else if (linkedType === 'vendor') {
        const vendor = vendors.find(v => v.id === linkedId);
        linkedName = vendor ? vendor.name : '';
      }
    }
    const category=qs('#risk-category').value;
    const likelihood=Number(qs('#risk-likelihood').value);
    const impact=Number(qs('#risk-impact').value);
    const resLikelihood = Number(qs('#risk-res-likelihood').value) || likelihood;
    const resImpact = Number(qs('#risk-res-impact').value) || impact;
    const status=qs('#risk-status').value;
    if(!title || !linked || !category || !likelihood || !impact || !status) return alert('Fill all required risk fields.');
    const obj={
      id:id || ('RSK-'+Date.now()),
      title,
      linked,
      linkedType,
      linkedId,
      linkedName,
      category,
      likelihood,
      impact,
      score:rScore(likelihood,impact),
      resLikelihood,
      resImpact,
      resScore:rScore(resLikelihood, resImpact),
      status,
      owner:qs('#risk-owner').value.trim(),
      notes:qs('#risk-notes').value.trim()
    };
    const idx=risks.findIndex(x=>x.id===obj.id);
    if(idx>-1) risks[idx]=obj; else risks.push(obj);
    save(K.risks,risks);
    renderRisksTable(currentRisksPage);
    resetRiskForm();
    showToast('Risk saved successfully');
  });
  qs('#risk-form-cancel').addEventListener('click',resetRiskForm);
  qs('#risks-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-re');
    const idD=e.target.getAttribute('data-rd');
    if(idE){
      const r=risks.find(x=>x.id===idE); if(!r) return;
      qs('#risk-id').value=r.id;
      qs('#risk-title').value=r.title;
      qs('#risk-linked').value=r.linked;
      qs('#risk-category').value=r.category;
      qs('#risk-likelihood').value=String(r.likelihood);
      qs('#risk-impact').value=String(r.impact);
      qs('#risk-res-likelihood').value=String(r.resLikelihood);
      qs('#risk-res-impact').value=String(r.resImpact);
      qs('#risk-owner').value=r.owner||'';
      qs('#risk-status').value=r.status||'Open';
      qs('#risk-notes').value=r.notes||'';
      qs('#risk-form-submit').textContent='Update risk';
    }
    if(idD){
      if(!confirm('Delete this risk?')) return;
      risks=risks.filter(x=>x.id!==idD);
      save(K.risks,risks);
      // unlink from controls
      let changed=false;
      controls.forEach(c=>{
        if(Array.isArray(c.linkedRiskIds) && c.linkedRiskIds.includes(idD)){
          c.linkedRiskIds=c.linkedRiskIds.filter(z=>z!==idD);
          changed=true;
        }
      });
      if(changed){ save(K.controls,controls); renderControlsTable(); }
      // unlink from issues
      issues.forEach(i=>{
        if(i.riskId===idD){
          i.riskId='';
          i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Risk: [^|]+/,'');
        }
      });
      save(K.issues,issues);
      renderIssuesTable();
      // unlink from incidents
      incidents.forEach(inc=>{
        if(inc.riskId===idD){
          inc.riskId='';
          inc.linkedSummary=(inc.linkedSummary||'').replace(/ *\| *Risk: [^|]+/,'');
        }
      });
      save(K.incidents,incidents);
      renderIncidentsTable();
      // unlink from treatments
      treatments.forEach(t=>{ if(t.linked === idD) t.linked = ''; });
      save(K.treats,treatments);
      renderTreatmentsTable();
      renderRisksTable(currentRisksPage);
      showToast('Risk deleted');
    }
  });
  function syncRiskThresholdInputs(){
    const h = qs('#risk-thres-high');
    const m = qs('#risk-thres-med');
    if(!h || !m) return;
    h.value = riskConfig.highMin;
    m.value = riskConfig.mediumMin;
  }
  function applyRiskThresholdInputs(){
    const h = qs('#risk-thres-high');
    const m = qs('#risk-thres-med');
    if(!h || !m) return;
    let high = Number(h.value) || defaultRiskConfig.highMin;
    let med = Number(m.value) || defaultRiskConfig.mediumMin;
    high = Math.max(1, Math.min(25, high));
    med = Math.max(1, Math.min(25, med));
    if(high <= med){
      med = Math.max(1, high - 1);
      m.value = med;
    }
    saveRiskConfig({ highMin: high, mediumMin: med });
    renderRisksTable(currentRisksPage);
    drawMatrix();
    renderDashboard();
  }
  // ---------- Controls ----------
  let currentControlsPage = 1;
  function populateControlFrameworks(){
    const sel=qs('#control-frameworks'); if(!sel) return;
    sel.innerHTML='';
    FRAMEWORK_CONTROLS.forEach(fc=>{
      const o=document.createElement('option');
      o.value=fc.id;
      o.textContent=`${fc.id} – ${fc.name}`;
      sel.appendChild(o);
    });
  }
  function renderControlsTable(page = 1){
    currentControlsPage = page;
    const tbody=qs('#controls-table-body'), empty=qs('#controls-empty'), count=qs('#controls-count');
    tbody.innerHTML='';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedControls = controls.slice(start, end);
    paginatedControls.forEach(c=>{
      const rc=(c.linkedRiskIds||[]).length;
      const fw=(c.linkedFrameworkControlIds||[]).length;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${c.name}</td>
        <td>${c.type}</td>
        <td>${c.status}</td>
        <td>${rc?rc+' linked':'-'}</td>
        <td>${fw?fw+' mapped':'-'}</td>
        <td>${c.evidence || '-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ce="${c.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-cd="${c.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=controls.length?'none':'block';
    count.textContent=`${controls.length} control(s)`;
    renderPagination('controls-pagination', controls.length, page, renderControlsTable);
    populateIssueDropdowns();
    populateTreatmentDropdownControls();
    renderGapTable();
    renderDashboard();
    renderSoATable();
  }
  function resetControlForm(){
    qs('#control-form').reset();
    qs('#control-id').value='';
    qs('#control-form-submit').textContent='Save control';
  }
  qs('#control-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#control-id').value;
    const name=qs('#control-name').value.trim();
    const type=qs('#control-type').value;
    const status=qs('#control-status').value;
    if(!name || !type || !status) return alert('Fill control name, type, status.');
    const obj={
      id:id || ('CTL-'+Date.now()),
      name,
      type,
      status,
      owner:qs('#control-owner').value.trim(),
      description:qs('#control-description').value.trim(),
      linkedRiskIds:getMulti(qs('#control-risks')),
      linkedFrameworkControlIds:getMulti(qs('#control-frameworks')),
      evidence:qs('#control-evidence').value.trim()
    };
    const idx=controls.findIndex(x=>x.id===obj.id);
    if(idx>-1) controls[idx]=obj; else controls.push(obj);
    save(K.controls,controls);
    renderControlsTable(currentControlsPage);
    resetControlForm();
    showToast('Control saved successfully');
  });
  qs('#control-form-cancel').addEventListener('click',resetControlForm);
  qs('#controls-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ce');
    const idD=e.target.getAttribute('data-cd');
    if(idE){
      const c=controls.find(x=>x.id===idE); if(!c) return;
      qs('#control-id').value=c.id;
      qs('#control-name').value=c.name;
      qs('#control-type').value=c.type;
      qs('#control-status').value=c.status;
      qs('#control-owner').value=c.owner||'';
      qs('#control-description').value=c.description||'';
      setMulti(qs('#control-risks'),c.linkedRiskIds||[]);
      setMulti(qs('#control-frameworks'),c.linkedFrameworkControlIds||[]);
      qs('#control-evidence').value=c.evidence||'';
      qs('#control-form-submit').textContent='Update control';
    }
    if(idD){
      if(!confirm('Delete this control?')) return;
      controls=controls.filter(x=>x.id!==idD);
      save(K.controls,controls);
      // unlink from issues, incidents, treatments
      issues.forEach(i=>{
        if(i.controlId===idD){
          i.controlId='';
          i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Control: [^|]+/,'');
        }
      });
      save(K.issues,issues);
      renderIssuesTable();
      incidents.forEach(inc=>{
        if(inc.controlId===idD){
          inc.controlId='';
          inc.linkedSummary=(inc.linkedSummary||'').replace(/ *\| *Control: [^|]+/,'');
        }
      });
      save(K.incidents,incidents);
      renderIncidentsTable();
      treatments.forEach(t=>{ if(t.controlId===idD) t.controlId=''; });
      save(K.treats,treatments);
      renderTreatmentsTable();
      renderControlsTable(currentControlsPage);
      showToast('Control deleted');
    }
  });
  // ---------- Issues ----------
  let currentIssuesPage = 1;
  function resetIssueForm(){
    qs('#issue-form').reset();
    qs('#issue-id').value='';
    qs('#issue-form-submit').textContent='Save issue';
  }
  function renderIssuesTable(page = 1){
    currentIssuesPage = page;
    const tbody=qs('#issues-table-body'), empty=qs('#issues-empty'), count=qs('#issues-count');
    tbody.innerHTML='';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedIssues = issues.slice(start, end);
    paginatedIssues.forEach(i=>{
      const sev=i.severity||'';
      const cls = sev==='Critical'||sev==='High'?'badge-danger':sev==='Medium'?'badge-warning':'badge-success';
      const linkedSummary = [
        i.assetId ? `Asset: ${assets.find(a => a.id === i.assetId)?.name || ''}` : '',
        i.vendorId ? `Vendor: ${vendors.find(v => v.id === i.vendorId)?.name || ''}` : '',
        i.riskId ? `Risk: ${risks.find(r => r.id === i.riskId)?.title || ''}` : '',
        i.controlId ? `Control: ${controls.find(c => c.id === i.controlId)?.name || ''}` : ''
      ].filter(Boolean).join(' | ');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i.title}</td>
        <td>${i.type}</td>
        <td>${sev?`<span class="badge ${cls}">${sev}</span>`:'-'}</td>
        <td>${i.status}</td>
        <td>${linkedSummary || '-'}</td>
        <td>${i.dueDate || '-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ie="${i.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-id="${i.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=issues.length?'none':'block';
    count.textContent=`${issues.length} issue(s)`;
    renderPagination('issues-pagination', issues.length, page, renderIssuesTable);
    renderDashboard();
  }
  qs('#issue-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#issue-id').value;
    const title=qs('#issue-title').value.trim();
    const type=qs('#issue-type').value;
    const severity=qs('#issue-severity').value;
    const status=qs('#issue-status').value;
    if(!title || !type || !severity || !status) return alert('Fill title, type, severity, status.');
    const assetId=qs('#issue-asset').value||'';
    const vendorId=qs('#issue-vendor').value||'';
    const riskId=qs('#issue-risk').value||'';
    const controlId=qs('#issue-control').value||'';
    const linkedSummary = [
      assetId ? `Asset: ${assets.find(a => a.id === assetId)?.name || ''}` : '',
      vendorId ? `Vendor: ${vendors.find(v => v.id === vendorId)?.name || ''}` : '',
      riskId ? `Risk: ${risks.find(r => r.id === riskId)?.title || ''}` : '',
      controlId ? `Control: ${controls.find(c => c.id === controlId)?.name || ''}` : ''
    ].filter(Boolean).join(' | ');
    const obj={
      id:id || ('ISS-'+Date.now()),
      title,
      type,
      severity,
      status,
      owner:qs('#issue-owner').value.trim(),
      dueDate:qs('#issue-due').value,
      notes:qs('#issue-notes').value.trim(),
      assetId,vendorId,riskId,controlId,
      linkedSummary
    };
    const idx=issues.findIndex(x=>x.id===obj.id);
    if(idx>-1) issues[idx]=obj; else issues.push(obj);
    save(K.issues,issues);
    renderIssuesTable(currentIssuesPage);
    resetIssueForm();
    showToast('Issue saved successfully');
  });
  qs('#issue-form-cancel').addEventListener('click',resetIssueForm);
  qs('#issues-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ie');
    const idD=e.target.getAttribute('data-id');
    if(idE){
      const i=issues.find(x=>x.id===idE); if(!i) return;
      qs('#issue-id').value=i.id;
      qs('#issue-title').value=i.title;
      qs('#issue-type').value=i.type;
      qs('#issue-severity').value=i.severity;
      qs('#issue-status').value=i.status;
      qs('#issue-owner').value=i.owner||'';
      qs('#issue-due').value=i.dueDate||'';
      qs('#issue-notes').value=i.notes||'';
      qs('#issue-asset').value=i.assetId||'';
      qs('#issue-vendor').value=i.vendorId||'';
      qs('#issue-risk').value=i.riskId||'';
      qs('#issue-control').value=i.controlId||'';
      qs('#issue-form-submit').textContent='Update issue';
    }
    if(idD){
      if(!confirm('Delete this issue?')) return;
      issues=issues.filter(x=>x.id!==idD);
      save(K.issues,issues);
      // Unlink from treatments
      treatments.forEach(t=>{ if(t.linked === idD) t.linked = ''; });
      save(K.treats,treatments);
      renderTreatmentsTable();
      renderIssuesTable(currentIssuesPage);
      showToast('Issue deleted');
    }
  });
  // ---------- Incidents ----------
  let currentIncidentsPage = 1;
  function resetIncidentForm(){
    qs('#incident-form').reset();
    qs('#incident-id').value='';
  }
  function renderIncidentsTable(page = 1){
    currentIncidentsPage = page;
    const tbody=qs('#incidents-table-body'), empty=qs('#incidents-empty'), count=qs('#incidents-count');
    tbody.innerHTML='';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedIncidents = incidents.slice(start, end);
    paginatedIncidents.forEach(inc=>{
      const sev=inc.severity||'';
      const cls = sev==='Critical'||sev==='High'?'badge-danger':sev==='Medium'?'badge-warning':'badge-success';
      const linkedSummary = [
        inc.assetId ? `Asset: ${assets.find(a => a.id === inc.assetId)?.name || ''}` : '',
        inc.vendorId ? `Vendor: ${vendors.find(v => v.id === inc.vendorId)?.name || ''}` : '',
        inc.riskId ? `Risk: ${risks.find(r => r.id === inc.riskId)?.title || ''}` : '',
        inc.controlId ? `Control: ${controls.find(c => c.id === inc.controlId)?.name || ''}` : ''
      ].filter(Boolean).join(' | ');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${inc.title}</td>
        <td>${inc.type}</td>
        <td>${sev?`<span class="badge ${cls}">${sev}</span>`:'-'}</td>
        <td>${inc.status}</td>
        <td>${inc.detected || '-'}</td>
        <td>${linkedSummary || '-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ince="${inc.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-incd="${inc.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=incidents.length?'none':'block';
    count.textContent=`${incidents.length} incident(s)`;
    renderPagination('incidents-pagination', incidents.length, page, renderIncidentsTable);
    renderDashboard();
  }
  qs('#incident-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#incident-id').value;
    const title=qs('#incident-title').value.trim();
    const type=qs('#incident-type').value;
    const detected=qs('#incident-detected').value;
    const severity=qs('#incident-severity').value;
    const status=qs('#incident-status').value;
    if(!title || !type || !detected || !severity || !status) return alert('Fill title, type, detected date, severity, status.');
    const assetId=qs('#incident-asset').value||'';
    const vendorId=qs('#incident-vendor').value||'';
    const riskId=qs('#incident-risk').value||'';
    const controlId=qs('#incident-control').value||'';
    const linkedSummary = [
      assetId ? `Asset: ${assets.find(a => a.id === assetId)?.name || ''}` : '',
      vendorId ? `Vendor: ${vendors.find(v => v.id === vendorId)?.name || ''}` : '',
      riskId ? `Risk: ${risks.find(r => r.id === riskId)?.title || ''}` : '',
      controlId ? `Control: ${controls.find(c => c.id === controlId)?.name || ''}` : ''
    ].filter(Boolean).join(' | ');
    const obj={
      id:id || ('INC-'+Date.now()),
      title,
      type,
      detected,
      severity,
      status,
      owner:qs('#incident-owner').value.trim(),
      notes:qs('#incident-notes').value.trim(),
      assetId,vendorId,riskId,controlId,
      linkedSummary
    };
    const idx=incidents.findIndex(x=>x.id===obj.id);
    if(idx>-1) incidents[idx]=obj; else incidents.push(obj);
    save(K.incidents,incidents);
    renderIncidentsTable(currentIncidentsPage);
    resetIncidentForm();
    showToast('Incident saved successfully');
  });
  qs('#incident-form-cancel').addEventListener('click',resetIncidentForm);
  qs('#incidents-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ince');
    const idD=e.target.getAttribute('data-incd');
    if(idE){
      const inc=incidents.find(x=>x.id===idE); if(!inc) return;
      qs('#incident-id').value=inc.id;
      qs('#incident-title').value=inc.title;
      qs('#incident-type').value=inc.type;
      qs('#incident-detected').value=inc.detected;
      qs('#incident-severity').value=inc.severity;
      qs('#incident-status').value=inc.status;
      qs('#incident-owner').value=inc.owner||'';
      qs('#incident-notes').value=inc.notes||'';
      qs('#incident-asset').value=inc.assetId||'';
      qs('#incident-vendor').value=inc.vendorId||'';
      qs('#incident-risk').value=inc.riskId||'';
      qs('#incident-control').value=inc.controlId||'';
    }
    if(idD){
      if(!confirm('Delete this incident?')) return;
      incidents=incidents.filter(x=>x.id!==idD);
      save(K.incidents,incidents);
      // Unlink from treatments if needed
      treatments.forEach(t=>{ if(t.linked === idD) t.linked = ''; });
      save(K.treats,treatments);
      renderTreatmentsTable();
      renderIncidentsTable(currentIncidentsPage);
      showToast('Incident deleted');
    }
  });
  // ---------- Gap analysis ----------
  const heatClass = p => p>=80?'heat-good':p>=50?'heat-medium':p>0?'heat-low':'heat-none';
  function computeGapRows(){
    const byCat=new Map();
    FRAMEWORK_CONTROLS.forEach(fc=>{
      if(!byCat.has(fc.category)) byCat.set(fc.category,{category:fc.category,total:0,implemented:0,plannedOnly:0,notImplemented:0});
      const row=byCat.get(fc.category);
      row.total+=1;
      const linked=controls.filter(c=>Array.isArray(c.linkedFrameworkControlIds)&&c.linkedFrameworkControlIds.includes(fc.id));
      if(linked.length===0){ row.notImplemented+=1; return; }
      const hasInPlace=linked.some(c=>c.status==='In place');
      const hasPlanned=linked.some(c=>c.status==='Planned');
      if(hasInPlace) row.implemented+=1;
      else if(hasPlanned) row.plannedOnly+=1;
      else row.notImplemented+=1;
    });
    return Array.from(byCat.values()).sort((a,b)=>a.category.localeCompare(b.category));
  }
  function overallCoverage(rows){
    let total=0, imp=0;
    rows.forEach(r=>{total+=r.total;imp+=r.implemented;});
    return total?Math.round((imp/total)*100):0;
  }
  function autoImplForFrameworkControl(fcId){
    const linked = controls.filter(c => Array.isArray(c.linkedFrameworkControlIds) && c.linkedFrameworkControlIds.includes(fcId) );
    if(linked.length === 0) return 'Not implemented';
    const anyInPlace = linked.some(c => c.status === 'In place');
    const anyPlanned = linked.some(c => c.status === 'Planned');
    if(anyInPlace) return 'In place';
    if(anyPlanned) return 'Planned';
    return 'Not applicable';
  }
  function renderGapTable(){
    const tbody=qs('#gap-table-body'), overall=qs('#gap-overall-coverage');
    const rows=computeGapRows();
    tbody.innerHTML='';
    rows.forEach(r=>{
      const pct=r.total?Math.round((r.implemented/r.total)*100):0;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.category}</td>
        <td>${r.total}</td>
        <td>${r.implemented} / ${r.total}</td>
        <td>${r.plannedOnly} / ${r.total}</td>
        <td>${r.notImplemented} / ${r.total}</td>
        <td class="heat-cell ${heatClass(pct)}">${pct}%<small>${r.implemented} of ${r.total} control(s) implemented</small></td>`;
      tbody.appendChild(tr);
    });
    const ov=overallCoverage(rows);
    overall.textContent = rows.length ? `Overall implemented coverage: ${ov}% of ${FRAMEWORK_CONTROLS.length} framework control(s).` : 'Add local controls and map them to framework controls to see coverage.';
    updateCoveragePill(ov);
  }
  // ---------- SoA with filters and bulk edit ----------
  function renderSoATable(){
    const tbody = qs('#soa-table-body');
    const count = qs('#soa-count');
    if(!tbody || !count) return;
    const f = qs('#soa-framework-filter') ? qs('#soa-framework-filter').value : 'all';
    const c = qs('#soa-category-filter') ? qs('#soa-category-filter').value : 'all';
    const appF = qs('#soa-applicability-filter') ? qs('#soa-applicability-filter').value : 'all';
    const implF = qs('#soa-implementation-filter') ? qs('#soa-implementation-filter').value : 'all';
    const filtered = FRAMEWORK_CONTROLS.filter(fc=>{
      const entry = getSoAEntry(fc.id);
      const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
      const okF = f === 'all' || fc.frameworks.includes(f);
      const okC = c === 'all' || fc.category === c;
      const okApp = appF === 'all' || entry.applicability === appF;
      const okImpl = implF === 'all' || resolvedImpl === implF;
      return okF && okC && okApp && okImpl;
    });
    tbody.innerHTML = '';
    filtered.forEach(fc=>{
      const entry = getSoAEntry(fc.id);
      const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
      const frameworksTxt = (fc.frameworks||[]).join(', ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="soa-checkbox" data-soa-id="${fc.id}"></td>
        <td>${fc.id}</td>
        <td>${fc.name}</td>
        <td>${fc.category}</td>
        <td>${frameworksTxt}</td>
        <td>
          <select class="soa-select" data-soa-app="${fc.id}">
            <option ${entry.applicability==='Applicable'?'selected':''}>Applicable</option>
            <option ${entry.applicability==='Not Applicable'?'selected':''}>Not Applicable</option>
          </select>
        </td>
        <td>
          <select class="soa-select" data-soa-impl="${fc.id}">
            <option ${entry.implementation==='Auto'?'selected':''} value="Auto">Auto (from local controls)</option>
            <option ${entry.implementation==='In place'?'selected':''}>In place</option>
            <option ${entry.implementation==='Planned'?'selected':''}>Planned</option>
            <option ${entry.implementation==='Not implemented'?'selected':''}>Not implemented</option>
            <option ${entry.implementation==='Not applicable'?'selected':''}>Not applicable</option>
          </select>
          <div class="small-muted">Resolved: <b>${resolvedImpl}</b></div>
        </td>
        <td><input class="soa-input" data-soa-owner="${fc.id}" placeholder="Owner" value="${entry.owner||''}"></td>
        <td>
          <textarea class="soa-textarea" data-soa-rationale="${fc.id}" placeholder="Rationale (why status/applicability)">${entry.rationale||""}</textarea>
          <textarea class="soa-textarea soa-evidence" data-soa-evidence="${fc.id}" placeholder="Evidence URL(s), comma-separated">${entry.evidence||""}</textarea>
        </td>
      `;
      tbody.appendChild(tr);
    });
    applySoALabels();
    count.textContent = `${filtered.length} framework control(s) shown of ${FRAMEWORK_CONTROLS.length}`;
    // Delegate change events for all inputs/selects in table
    tbody.onchange = (e)=>{
      const t = e.target;
      const fcId = t.getAttribute('data-soa-app') || t.getAttribute('data-soa-impl') || t.getAttribute('data-soa-owner') || t.getAttribute('data-soa-rationale') || t.getAttribute('data-soa-evidence');
      if(!fcId) return;
      const entry = getSoAEntry(fcId);
      if(t.hasAttribute('data-soa-app')) entry.applicability = t.value;
      if(t.hasAttribute('data-soa-impl')) entry.implementation = t.value;
      if(t.hasAttribute('data-soa-owner')) entry.owner = t.value.trim();
      if(t.hasAttribute('data-soa-rationale')) entry.rationale = t.value.trim();
      if(t.hasAttribute('data-soa-evidence')) entry.evidence = t.value.trim();
      saveSoA();
      // Re-render to refresh the "Resolved" label if impl changed
      if(t.hasAttribute('data-soa-impl')){
        renderSoATable();
      }
      showToast('SoA entry updated');
    };
    // Bulk edit logic
    const bulkBar = qs('#soa-bulk-bar');
    const selectAll = qs('#soa-select-all');
    selectAll.addEventListener('change', (e) => {
      qsa('.soa-checkbox[data-soa-id]').forEach(cb => cb.checked = e.target.checked);
      bulkBar.classList.toggle('active', qsa('.soa-checkbox:checked[data-soa-id]').length > 0);
    });
    tbody.addEventListener('change', (e) => {
      if (e.target.classList.contains('soa-checkbox')) {
        bulkBar.classList.toggle('active', qsa('.soa-checkbox:checked[data-soa-id]').length > 0);
      }
    });
    qs('#bulk-apply').addEventListener('click', () => {
      const appVal = qs('#bulk-applicability').value;
      const implVal = qs('#bulk-implementation').value;
      if (!appVal && !implVal) return alert('Select a value to apply.');
      qsa('.soa-checkbox:checked[data-soa-id]').forEach(cb => {
        const fcId = cb.getAttribute('data-soa-id');
        const entry = getSoAEntry(fcId);
        if (appVal) entry.applicability = appVal;
        if (implVal) entry.implementation = implVal;
      });
      saveSoA();
      renderSoATable();
      qs('#bulk-clear').click();
      showToast('Bulk edit applied');
    });
    qs('#bulk-clear').addEventListener('click', () => {
      qsa('.soa-checkbox').forEach(cb => cb.checked = false);
      bulkBar.classList.remove('active');
    });
  
    // SoA Studio
    if(qs('#soa-list')){
      try{
        if(!window.__soaStudioBound){ bindSoAStudio(); window.__soaStudioBound=true; }
        else{ renderSoAStudio(); }
      }catch(e){}
    }
}


// === SoA Studio (new UI) ===
let __soaSelectedId = null;

function renderSoAStudio(){
  const listEl = qs('#soa-list');
  const badgeEl = qs('#soa-list-badge');
  const searchEl = qs('#soa-search');
  if(!listEl) return;

  const f = qs('#soa-framework-filter') ? qs('#soa-framework-filter').value : 'all';
  const c = qs('#soa-category-filter') ? qs('#soa-category-filter').value : 'all';
  const appF = qs('#soa-applicability-filter') ? qs('#soa-applicability-filter').value : 'all';
  const implF = qs('#soa-implementation-filter') ? qs('#soa-implementation-filter').value : 'all';
  const q = (searchEl && searchEl.value ? searchEl.value.trim().toLowerCase() : '');

  const filtered = FRAMEWORK_CONTROLS.filter(fc=>{
    const entry = getSoAEntry(fc.id);
    const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
    const okF = f === 'all' || fc.frameworks.includes(f);
    const okC = c === 'all' || fc.category === c;
    const okApp = appF === 'all' || entry.applicability === appF;
    const okImpl = implF === 'all' || resolvedImpl === implF;
    const okQ = !q || (fc.id + " " + fc.name + " " + fc.category + " " + fc.frameworks.join(" ")).toLowerCase().includes(q);
    return okF && okC && okApp && okImpl && okQ;
  });

  if(badgeEl) badgeEl.textContent = `${filtered.length} shown`;
  listEl.innerHTML = '';
  if(filtered.length === 0){
    listEl.innerHTML = `<div class="muted" style="padding:12px; color: rgba(255,255,255,.70);">No controls match your filters. Try <b>Reset</b> or broaden the filters.</div>`;
    if(badgeEl) badgeEl.textContent = `0 shown`;
    return;
  }
  filtered.forEach(fc=>{
    const entry = getSoAEntry(fc.id);
    const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;

    const app = entry.applicability || 'Applicable';
    const impl = resolvedImpl || 'Not implemented';

    const badgeAppCls = (app === 'Applicable') ? 'ok' : 'warn';
    let badgeImplCls = 'bad';
    if(impl === 'In place') badgeImplCls = 'ok';
    else if(impl === 'Planned') badgeImplCls = 'warn';

    const item = document.createElement('div');
    item.className = 'soaItem' + (__soaSelectedId === fc.id ? ' active' : '');
    item.setAttribute('data-soa-pick', fc.id);

    const fwTxt = fc.frameworks.join(', ');

    item.innerHTML = `
      <div class="soaItemTop">
        <div>
          <div class="soaId">${escapeHtml(fc.id)}</div>
          <div class="soaName">${escapeHtml(fc.name)}</div>
          <div class="soaMeta">${escapeHtml(fc.category)} • ${escapeHtml(fwTxt)}</div>
        </div>
      </div>
      <div class="soaBadges">
        <span class="soaBadge ${badgeAppCls}">${escapeHtml(app)}</span>
        <span class="soaBadge ${badgeImplCls}">${escapeHtml(impl)}</span>
      </div>
    `;

    item.addEventListener('click', ()=>{
      __soaSelectedId = fc.id;
      renderSoAStudio();
      loadSoAEditor(fc.id);
    });

    listEl.appendChild(item);
  });

  // Keep selection valid
  if(__soaSelectedId && !filtered.some(x=>x.id===__soaSelectedId)){
    __soaSelectedId = null;
    hideSoAEditor();
  } else if(__soaSelectedId){
    loadSoAEditor(__soaSelectedId, true);
  }
}

function hideSoAEditor(){
  const ed = qs('#soa-editor');
  const empty = qs('#soa-editor-empty');
  const badge = qs('#soa-editor-badge');
  if(ed) ed.style.display = 'none';
  if(empty) empty.style.display = 'block';
  if(badge) badge.textContent = 'No selection';
}

function loadSoAEditor(fcId, silent=false){
  const ed = qs('#soa-editor');
  const empty = qs('#soa-editor-empty');
  const badge = qs('#soa-editor-badge');
  if(!ed) return;

  const fc = FRAMEWORK_CONTROLS.find(x=>x.id===fcId);
  if(!fc) return;

  const entry = getSoAEntry(fcId);
  const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fcId) : entry.implementation;

  const title = qs('#soa-edit-title');
  const fws = qs('#soa-edit-frameworks');
  const app = qs('#soa-edit-app');
  const impl = qs('#soa-edit-impl');
  const owner = qs('#soa-edit-owner');
  const rat = qs('#soa-edit-rationale');
  const evd = qs('#soa-edit-evidence');
  const resolved = qs('#soa-edit-resolved');

  if(title) title.value = `${fc.id} — ${fc.name}`;
  if(fws) fws.value = fc.frameworks.join(', ');
  if(app) app.value = entry.applicability || 'Applicable';
  if(impl) impl.value = entry.implementation || 'Auto';
  if(owner) owner.value = entry.owner || '';
  if(rat) rat.value = entry.rationale || '';
  if(evd) evd.value = entry.evidence || '';
  if(resolved) resolved.textContent = `Resolved: ${resolvedImpl || '—'}`;

  if(badge) badge.textContent = fc.id;
  if(empty) empty.style.display = 'none';
  ed.style.display = 'grid';

  if(silent) return;

  // Wire once
  if(!ed._wired){
    const commit = ()=>{
      if(!__soaSelectedId) return;
      const id = __soaSelectedId;
      const e = getSoAEntry(id);
      if(app) e.applicability = app.value;
      if(impl) e.implementation = impl.value;
      if(owner) e.owner = owner.value.trim();
      if(rat) e.rationale = rat.value.trim();
      if(evd) e.evidence = evd.value.trim();
      saveSoA();

      // Update resolved label + list badges
      const rImpl = e.implementation === 'Auto' ? autoImplForFrameworkControl(id) : e.implementation;
      if(resolved) resolved.textContent = `Resolved: ${rImpl || '—'}`;
      renderSoAStudio();

      // Keep legacy table in sync for export
      renderSoATable();
    };

    ['change','input'].forEach(evt=>{
      [app, impl, owner, rat, evd].forEach(el=>{
        if(el) el.addEventListener(evt, ()=>{
          // Debounce heavy rerenders a bit on typing
          clearTimeout(ed._t);
          ed._t = setTimeout(commit, 120);
        });
      });
    });

    ed._wired = true;
  }
}



function initSoAStudioFilters(){
  // Build filter options from the real framework library (no mismatches)
  const fwSel = qs('#soa-framework-filter');
  const catSel = qs('#soa-category-filter');
  if(!fwSel || !catSel) return;

  // Preserve current selection if possible
  const prevFw = fwSel.value || 'all';
  const prevCat = catSel.value || 'all';

  const fwSet = new Set();
  const catSet = new Set();

  (FRAMEWORK_CONTROLS || []).forEach(fc=>{
    (fc.frameworks || []).forEach(x=> fwSet.add(x));
    if(fc.category) catSet.add(fc.category);
  });

  const fwList = ['all', ...Array.from(fwSet).sort()];
  const catList = ['all', ...Array.from(catSet).sort()];

  fwSel.innerHTML = fwList.map(v=>{
    const label = (v==='all') ? 'All frameworks' : v;
    return `<option value="${escapeHtml(v)}">${escapeHtml(label)}</option>`;
  }).join('');

  catSel.innerHTML = catList.map(v=>{
    const label = (v==='all') ? 'All categories' : v;
    return `<option value="${escapeHtml(v)}">${escapeHtml(label)}</option>`;
  }).join('');

  // Default to 'all' to avoid empty screens
  fwSel.value = fwList.includes(prevFw) ? prevFw : 'all';
  catSel.value = catList.includes(prevCat) ? prevCat : 'all';

  // Default other filters
  const app = qs('#soa-applicability-filter');
  const impl = qs('#soa-implementation-filter');
  if(app && !app.value) app.value = 'all';
  if(impl && !impl.value) impl.value = 'all';
}
function bindSoAStudio(){
  if(!window.__soaStudioFiltersInit){ initSoAStudioFilters(); window.__soaStudioFiltersInit=true; }
  const fwSel = qs('#soa-framework-filter');
  const catSel = qs('#soa-category-filter');
  const resetBtn = qs('#soa-reset');
  if(resetBtn && !resetBtn.__bound){
    resetBtn.__bound=true;
    resetBtn.addEventListener('click', ()=>{
      const fw=qs('#soa-framework-filter'); const cat=qs('#soa-category-filter');
      const app=qs('#soa-applicability-filter'); const impl=qs('#soa-implementation-filter');
      const search=qs('#soa-search');
      if(fw) fw.value='all';
      if(cat) cat.value='all';
      if(app) app.value='all';
      if(impl) impl.value='all';
      if(search) search.value='';
      renderSoATable();
      renderSoAStudio();
    });
  }

  const fIds = ['#soa-framework-filter','#soa-category-filter','#soa-applicability-filter','#soa-implementation-filter'];
  fIds.forEach(sel=>{
    const el = qs(sel);
    if(el) el.addEventListener('change', ()=>{ renderSoATable(); renderSoAStudio(); });
  });
  const search = qs('#soa-search');
  if(search) search.addEventListener('input', ()=> renderSoAStudio());
  // Defaults
  if(fwSel && Array.from(fwSel.options).some(o=>o.value==='all')) fwSel.value='all';
  if(catSel && Array.from(catSel.options).some(o=>o.value==='all')) catSel.value='all';
  const appSel=qs('#soa-applicability-filter'); const implSel=qs('#soa-implementation-filter');
  if(appSel && Array.from(appSel.options).some(o=>o.value==='all')) appSel.value='all';
  if(implSel && Array.from(implSel.options).some(o=>o.value==='all')) implSel.value='all';

  // Initial
  renderSoAStudio();
  hideSoAEditor();
}


  // ---------- Dashboard ----------
  function updateCoveragePill(p){
    const pill=qs('#dash-coverage-pill');
    pill.classList.remove('heat-good','heat-medium','heat-low','heat-none');
    pill.classList.add(heatClass(p));
    pill.textContent = p>=80?'Strong coverage':p>=50?'Moderate coverage':p>0?'Limited coverage':'No implemented coverage yet';
  }
  function renderDashboard(){
    qs('#dash-assets').textContent=assets.length;
    qs('#dash-vendors').textContent=vendors.length;
    qs('#dash-risks').textContent=risks.length;
    qs('#dash-controls').textContent=controls.filter(c=>c.status === 'In place').length;
    qs('#dash-issues').textContent=issues.length;
    qs('#dash-incidents').textContent=incidents.filter(i=>i.status !== 'Closed').length;
    qs('#dash-treatments').textContent=treatments.filter(t=>t.status === 'In progress').length;
    const high=risks.filter(r=>rLevel(r.score)==='High').length;
    qs('#dash-high').textContent=high;
    const today=new Date();
    const overdue=issues.filter(i=>{
      if(!i.dueDate) return false;
      const d=new Date(i.dueDate);
      if(isNaN(d)) return false;
      const st=i.status||'';
      return st!=='Resolved' && st!=='Accepted' && d<today;
    }).length;
    qs('#dash-overdue').textContent=overdue;
    const ov=overallCoverage(computeGapRows());
    qs('#dash-coverage').textContent=ov+'%';
    updateCoveragePill(ov);
  }
  // ---------- Risk Matrix ----------
  let showResidual=false;
  const canvas=qs('#risk-matrix-canvas');
  const ctx=canvas.getContext('2d');
  const legend=qs('#matrix-legend');
  function residualForRisk(r){
    const impl=controls.filter(c=>c.status==='In place' && (c.linkedRiskIds||[]).includes(r.id));
    const dropL=Math.min(2,impl.length);
    const dropI=impl.some(c=>c.type==='Preventive' || c.type==='Corrective')?1:0;
    return { likelihood:Math.max(1,(r.likelihood||1)-dropL), impact:Math.max(1,(r.impact||1)-dropI) };
  }
  function drawMatrix(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const size=110, off=90;
    // Background gradient
    ctx.fillStyle = 'linear-gradient(to bottom right, #1a1f2e, #0a0e17)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    // Grid
    ctx.strokeStyle="#2b3138"; ctx.lineWidth=1;
    for(let i=0;i<=5;i++){
      ctx.beginPath(); ctx.moveTo(off,off+i*size); ctx.lineTo(off+5*size,off+i*size); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(off+i*size,off); ctx.lineTo(off+i*size,off+5*size); ctx.stroke();
    }
    // Labels
    ctx.font="bold 14px Poppins"; ctx.fillStyle="#aab2bd";
    ctx.textAlign = 'center';
    ctx.fillText("Impact →",off+225,off-25);
    ctx.save(); ctx.translate(off-55,off+240); ctx.rotate(-Math.PI/2); ctx.fillText("Likelihood →",0,0); ctx.restore();
    // Axis labels
    const labels = ['1', '2', '3', '4', '5'];
    labels.forEach((label, idx) => {
      ctx.fillText(label, off + (idx + 0.5) * size, canvas.height - 60); // Impact
      ctx.fillText(label, 40, off + (4.5 - idx) * size); // Likelihood (reversed)
    });
    // Legend
    let high=0,med=0,low=0;
    risks.forEach(r=>{
      let L=r.likelihood, I=r.impact, score=rScore(L,I), level=rLevel(score);
      if(showResidual){
        L = r.resLikelihood || L;
        I = r.resImpact || I;
        score = rScore(L,I);
        level = rLevel(score);
      }
      let color="#27ae60";
      if(level==='High'){ color="#e63946"; high++; }
      else if(level==='Medium'){ color="#f1c40f"; med++; }
      else if(level==='Low'){ color="#27ae60"; low++; }
      ctx.beginPath();
      ctx.arc(off+(I-0.5)*size,off+(5-L+0.5)*size,12,0,2*Math.PI);
      ctx.fillStyle=color; ctx.fill();
      ctx.strokeStyle = '#0c0f12';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.fillStyle="#e5e7eb"; ctx.font="bold 12px Poppins";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(String(score),off+(I-0.5)*size,off+(5-L+0.5)*size);
    });
    legend.innerHTML = `<b>${risks.length}</b> risks — <span style="color:#e63946">High: ${high}</span> | <span style="color:#f1c40f">Medium: ${med}</span> | <span style="color:#27ae60">Low: ${low}</span>`;
  }
  // ---------- Treatments ----------
  let currentTreatmentsPage = 1;
  function populateTreatmentDropdownLinked(){
    const sel=qs('#treat-linked'); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Select risk or issue...</option>';
    risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title + ' (Risk)';sel.appendChild(o);});
    issues.forEach(i=>{const o=document.createElement('option');o.value=i.id;o.textContent=i.title + ' (Issue)';sel.appendChild(o);});
    if(cur) sel.value=cur;
  }
  function populateTreatmentDropdownControls(){
    const sel=qs('#treat-control'); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Select control...</option>';
    controls.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o);});
    if(cur && controls.some(c=>c.id===cur)) sel.value=cur;
  }
  function renderTreatmentsTable(page = 1){
    currentTreatmentsPage = page;
    const tbody=qs('#treat-table-body'), empty=qs('#treat-empty'), count=qs('#treat-count');
    tbody.innerHTML='';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedTreatments = treatments.slice(start, end);
    paginatedTreatments.forEach(t=>{
      let linkedName = '';
      if (t.linked) {
        const r = risks.find(x => x.id === t.linked);
        const i = issues.find(x => x.id === t.linked);
        linkedName = r ? r.title + ' (Risk)' : i ? i.title + ' (Issue)' : '';
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${linkedName || '-'}</td>
        <td>${t.status}</td>
        <td>${t.targetDate||''}</td>
        <td>${t.owner||''}</td>
        <td>${t.budget||''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-te="${t.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-td="${t.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=treatments.length?'none':'block';
    count.textContent=`${treatments.length} treatment action(s)`;
    renderPagination('treatments-pagination', treatments.length, page, renderTreatmentsTable);
  }
  function resetTreatForm(){
    qs('#treat-form').reset();
    qs('#treat-id').value='';
    qs('#treat-submit').textContent='Save action';
  }
  qs('#treat-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#treat-id').value;
    const title=qs('#treat-title').value.trim();
    const linked=qs('#treat-linked').value;
    if(!title || !linked) return alert('Action title and linked risk/issue are required.');
    const controlId=qs('#treat-control').value || '';
    const obj={
      id:id || ('TRT-'+Date.now()),
      title,
      linked,
      controlId,
      status:qs('#treat-status').value,
      targetDate:qs('#treat-date').value,
      owner:qs('#treat-owner').value.trim(),
      budget:qs('#treat-budget').value.trim(),
      notes:qs('#treat-notes').value.trim()
    };
    const idx=treatments.findIndex(x=>x.id===obj.id);
    if(idx>-1) treatments[idx]=obj; else treatments.push(obj);
    save(K.treats,treatments);
    renderTreatmentsTable(currentTreatmentsPage);
    resetTreatForm();
    showToast('Treatment saved successfully');
  });
  qs('#treat-cancel').addEventListener('click',resetTreatForm);
  qs('#treat-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-te');
    const idD=e.target.getAttribute('data-td');
    if(idE){
      const t=treatments.find(x=>x.id===idE); if(!t) return;
      qs('#treat-id').value=t.id;
      qs('#treat-title').value=t.title;
      populateTreatmentDropdownLinked();
      populateTreatmentDropdownControls();
      qs('#treat-linked').value=t.linked||'';
      qs('#treat-control').value=t.controlId||'';
      qs('#treat-status').value=t.status||'Open';
      qs('#treat-date').value=t.targetDate||'';
      qs('#treat-owner').value=t.owner||'';
      qs('#treat-budget').value=t.budget||'';
      qs('#treat-notes').value=t.notes||'';
      qs('#treat-submit').textContent='Update action';
    }
    if(idD){
      if(!confirm('Delete this treatment action?')) return;
      treatments=treatments.filter(x=>x.id!==idD);
      save(K.treats,treatments);
      renderTreatmentsTable(currentTreatmentsPage);
      showToast('Treatment deleted');
    }
  });
  // ---------- CSV Export helpers ----------
  function escapeCSVVal(v){
    if(v==null) return '';
    const s = String(v);
    if(/[",\n]/.test(s)){
      return '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }
  function downloadCSV(filename, rows, columns){
    const header = columns.map(c=>escapeCSVVal(c.header)).join(',');
    const lines = [header];
    rows.forEach(r=>{
      const vals = columns.map(c=>{
        if(typeof c.value === 'function') return escapeCSVVal(c.value(r));
        if(c.key) return escapeCSVVal(r[c.key]);
        return '';
      });
      lines.push(vals.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function exportAssetsCSV(){
    const cols = [
      {header:'Name', key:'name'},
      {header:'Type', key:'type'},
      {header:'Criticality', key:'criticality'},
      {header:'Owner', key:'owner'},
      {header:'Data types', value:a=>(a.dataTypes||[]).join('; ')},
      {header:'Location', key:'location'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_assets.csv', assets, cols);
  }
  function exportVendorsCSV(){
    const cols = [
      {header:'Name', key:'name'},
      {header:'Type', key:'type'},
      {header:'Criticality', key:'criticality'},
      {header:'Data Access', key:'dataAccess'},
      {header:'Contract Status', key:'contract'},
      {header:'Last Assessment', key:'assessment'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_vendors.csv', vendors, cols);
  }
  function exportRisksCSV(){
    const rows = (lastRiskView && lastRiskView.length) ? lastRiskView : risks;
    const cols = [
      {header:'Title', key:'title'},
      {header:'Linked', value:r=>r.linkedName||''},
      {header:'Category', key:'category'},
      {header:'Likelihood', key:'likelihood'},
      {header:'Impact', key:'impact'},
      {header:'Score', key:'score'},
      {header:'Level', value:r=>rLevel(r.score)},
      {header:'Res Likelihood', key:'resLikelihood'},
      {header:'Res Impact', key:'resImpact'},
      {header:'Res Score', key:'resScore'},
      {header:'Res Level', value:r=>rLevel(r.resScore)},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_risks.csv', rows, cols);
  }
  function exportControlsCSV(){
    const cols = [
      {header:'Name', key:'name'},
      {header:'Type', key:'type'},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Description', key:'description'},
      {header:'Linked risks count', value:c=>(c.linkedRiskIds||[]).length},
      {header:'Mapped framework ctrl count', value:c=>(c.linkedFrameworkControlIds||[]).length},
      {header:'Evidence', key:'evidence'}
    ];
    downloadCSV('grc_controls.csv', controls, cols);
  }
  function exportSoACSV(){
    const rows = FRAMEWORK_CONTROLS.map(fc=>{
      const entry = getSoAEntry(fc.id);
      const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
      const mapped = controls
        .filter(c => Array.isArray(c.linkedFrameworkControlIds) && c.linkedFrameworkControlIds.includes(fc.id))
        .map(c => c.name)
        .join('; ');
      return {
        id: fc.id,
        name: fc.name,
        category: fc.category,
        frameworks: (fc.frameworks||[]).join('; '),
        applicability: entry.applicability || 'Applicable',
        implementation_selected: entry.implementation || 'Auto',
        implementation_resolved: resolvedImpl,
        mapped_local_controls: mapped,
        owner: entry.owner || '',
        rationale: entry.rationale || '',
        evidence: entry.evidence || ''
      };
    });
    const cols = [
      {header:'Framework Control ID', key:'id'},
      {header:'Name', key:'name'},
      {header:'Category', key:'category'},
      {header:'Frameworks', key:'frameworks'},
      {header:'Applicability', key:'applicability'},
      {header:'Implementation (Selected)', key:'implementation_selected'},
      {header:'Implementation (Resolved)', key:'implementation_resolved'},
      {header:'Mapped Local Controls', key:'mapped_local_controls'},
      {header:'Owner', key:'owner'},
      {header:'Rationale', key:'rationale'},
      {header:'Evidence URLs', key:'evidence'}
    ];
    downloadCSV('grc_soa.csv', rows, cols);
  }
  function exportIssuesCSV(){
    const cols = [
      {header:'Title', key:'title'},
      {header:'Type', key:'type'},
      {header:'Severity', key:'severity'},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Due date', key:'dueDate'},
      {header:'Linked', key:'linkedSummary'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_issues.csv', issues, cols);
  }
  function exportIncidentsCSV(){
    const cols = [
      {header:'Title', key:'title'},
      {header:'Type', key:'type'},
      {header:'Detected', key:'detected'},
      {header:'Severity', key:'severity'},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Linked', key:'linkedSummary'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_incidents.csv', incidents, cols);
  }
  function exportTreatmentsCSV(){
    const cols = [
      {header:'Title', key:'title'},
      {header:'Linked', value:t=>{
        const r = risks.find(x => x.id === t.linked);
        const i = issues.find(x => x.id === t.linked);
        return r ? r.title + ' (Risk)' : i ? i.title + ' (Issue)' : '';
      }},
      {header:'Control', value:t=>{ const c=controls.find(x=>x.id===t.controlId); return c?c.name:''; }},
      {header:'Status', key:'status'},
      {header:'Target date', key:'targetDate'},
      {header:'Owner', key:'owner'},
      {header:'Budget', key:'budget'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_treatments.csv', treatments, cols);
  }
  // ---------- Export / Import / Demo / Reset ----------
  function setImportStatus(msg,err){
    const el=qs('#import-status');
    el.textContent=msg||'';
    el.style.color=err?'#fca5a5':'#9ca3af';
  }
  function exportScenario(){
    const payload={
      version:4,
      exportedAt:new Date().toISOString(),
      assets,risks,controls,issues,treatments,soa,vendors,incidents
    };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`grc-lab-scenario-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setImportStatus('Exported current data as JSON.',false);
  }
  function importScenarioFile(file){
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=JSON.parse(e.target.result);
        assets = Array.isArray(data.assets)?data.assets:[];
        risks = Array.isArray(data.risks)?data.risks:[];
        controls = Array.isArray(data.controls)?data.controls:[];
        issues = Array.isArray(data.issues)?data.issues:[];
        treatments = Array.isArray(data.treatments)?data.treatments:[];
        soa = Array.isArray(data.soa)?data.soa:[];
        vendors = Array.isArray(data.vendors)?data.vendors:[];
        incidents = Array.isArray(data.incidents)?data.incidents:[];
        save(K.assets,assets); save(K.risks,risks); save(K.controls,controls);
        save(K.issues,issues); save(K.treats,treatments); save(K.soa,soa); save(K.vendors,vendors); save(K.incidents,incidents);
        refreshAll();
        setImportStatus(`Imported scenario: ${assets.length} assets, ${vendors.length} vendors, ${risks.length} risks, ${controls.length} controls, ${issues.length} issues, ${incidents.length} incidents, ${treatments.length} actions, ${soa.length} SoA entries.`,false);
      }catch(err){
        console.error(err);
        setImportStatus('Failed to import scenario. Check JSON file.',true);
      }
    };
    reader.onerror=()=>setImportStatus('Failed to read file.',true);
    reader.readAsText(file);
  }
  function loadDemoScenario(){
    assets = [
      {id:"AST-DEMO-APP",name:"MediCloud Web Application",type:"Application",criticality:"High",dataTypes:["PHI","PII"],owner:"DevOps Team",location:"AWS US-East-1",notes:"Main patient portal app"},
      {id:"AST-DEMO-DB",name:"MediCloud Database",type:"Database",criticality:"High",dataTypes:["PHI","PII"],owner:"DBA Team",location:"AWS RDS",notes:"Stores patient records"},
      {id:"AST-DEMO-SERVER",name:"Internal File Server",type:"Server / Host",criticality:"Medium",dataTypes:["Internal data"],owner:"IT Ops",location:"On-prem",notes:"Employee files"}
    ];
    vendors = [
      {id:"VND-DEMO-AWS",name:"AWS",type:"Cloud Provider",criticality:"High",dataAccess:"Full",contract:"Active",assessment:"2025-01-01",notes:"Cloud hosting for app and DB"},
      {id:"VND-DEMO-OKTA",name:"Okta",type:"SaaS",criticality:"Medium",dataAccess:"Read",contract:"Active",assessment:"2025-06-01",notes:"Identity management"},
      {id:"VND-DEMO-SLACK",name:"Slack",type:"SaaS",criticality:"Low",dataAccess:"None",contract:"Active",assessment:"2024-12-01",notes:"Team communication"}
    ];
    risks = [
      {id:"RSK-DEMO-1",title:"Unauthorised access to MediCloud production",linked:"asset-AST-DEMO-APP",linkedType:"asset",linkedId:"AST-DEMO-APP",linkedName:"MediCloud Web Application",category:"Cybersecurity",likelihood:4,impact:5,score:20,resLikelihood:2,resImpact:4,resScore:8,status:"In progress",owner:"CISO",notes:"Potential data breach"},
      {id:"RSK-DEMO-2",title:"Data leakage from database",linked:"asset-AST-DEMO-DB",linkedType:"asset",linkedId:"AST-DEMO-DB",linkedName:"MediCloud Database",category:"Privacy",likelihood:3,impact:5,score:15,resLikelihood:1,resImpact:5,resScore:5,status:"Open",owner:"DBA",notes:"Sensitive PHI exposure"},
      {id:"RSK-DEMO-3",title:"Vendor data breach (AWS)",linked:"vendor-VND-DEMO-AWS",linkedType:"vendor",linkedId:"VND-DEMO-AWS",linkedName:"AWS",category:"Third-Party",likelihood:2,impact:5,score:10,resLikelihood:1,resImpact:4,resScore:4,status:"Accepted",owner:"Compliance",notes:"Cloud provider incident"},
      {id:"RSK-DEMO-4",title:"Insider threat via file server",linked:"asset-AST-DEMO-SERVER",linkedType:"asset",linkedId:"AST-DEMO-SERVER",linkedName:"Internal File Server",category:"Operational",likelihood:3,impact:3,score:9,resLikelihood:2,resImpact:2,resScore:4,status:"Mitigated",owner:"HR",notes:"Employee data access"},
      {id:"RSK-DEMO-5",title:"Phishing attack on users",linked:"asset-AST-DEMO-APP",linkedType:"asset",linkedId:"AST-DEMO-APP",linkedName:"MediCloud Web Application",category:"Cybersecurity",likelihood:4,impact:4,score:16,resLikelihood:3,resImpact:3,resScore:9,status:"In progress",owner:"Security Team",notes:"User credentials compromise"}
    ];
    controls = [
      {id:"CTL-DEMO-MFA",name:"Multi-factor authentication for admins",type:"Preventive",status:"In place",owner:"DevSecOps",description:"Enforce MFA for all admin accounts",linkedRiskIds:["RSK-DEMO-1","RSK-DEMO-5"],linkedFrameworkControlIds:["CTRL-5.17","CTRL-8.5"],evidence:"Okta dashboard screenshot"},
      {id:"CTL-DEMO-ENC",name:"Data encryption at rest",type:"Technical",status:"In place",owner:"DBA",description:"Encrypt database with AES-256",linkedRiskIds:["RSK-DEMO-2"],linkedFrameworkControlIds:["CTRL-8.24"],evidence:"AWS RDS config"},
      {id:"CTL-DEMO-VRA",name:"Vendor risk assessment",type:"Administrative",status:"Planned",owner:"Compliance",description:"Annual vendor reviews",linkedRiskIds:["RSK-DEMO-3"],linkedFrameworkControlIds:["CTRL-5.19","CTRL-5.21"],evidence:"Assessment report template"},
      {id:"CTL-DEMO-LOG",name:"Centralized logging and monitoring",type:"Detective",status:"In place",owner:"Security Team",description:"SIEM for all systems",linkedRiskIds:["RSK-DEMO-1","RSK-DEMO-4"],linkedFrameworkControlIds:["CTRL-8.15","CTRL-8.16"],evidence:"Splunk setup"},
      {id:"CTL-DEMO-TRAIN",name:"Security awareness training",type:"Preventive",status:"In place",owner:"HR",description:"Quarterly phishing simulations",linkedRiskIds:["RSK-DEMO-5"],linkedFrameworkControlIds:["CTRL-6.3"],evidence:"Training records"}
    ];
    issues = [
      {id:"ISS-DEMO-1",title:"Missing MFA on dev accounts",type:"Audit",severity:"High",status:"Open",owner:"Dev Lead",dueDate:"2025-12-31",notes:"From internal audit",assetId:"AST-DEMO-APP",vendorId:"",riskId:"RSK-DEMO-1",controlId:"CTL-DEMO-MFA",linkedSummary:"Asset: MediCloud Web Application | Risk: Unauthorised access to MediCloud production | Control: Multi-factor authentication for admins"},
      {id:"ISS-DEMO-2",title:"Outdated encryption keys",type:"Vulnerability Scan",severity:"Medium",status:"In progress",owner:"DBA",dueDate:"2025-11-15",notes:"Rotate keys",assetId:"AST-DEMO-DB",vendorId:"",riskId:"RSK-DEMO-2",controlId:"",linkedSummary:"Asset: MediCloud Database | Risk: Data leakage from database"},
      {id:"ISS-DEMO-3",title:"Vendor contract expired",type:"Self-Assessment",severity:"Low",status:"Resolved",owner:"Compliance",dueDate:"2025-10-01",notes:"Renewed",assetId:"",vendorId:"VND-DEMO-SLACK",riskId:"",controlId:"",linkedSummary:"Vendor: Slack"}
    ];
    incidents = [
      {id:"INC-DEMO-1",title:"Suspected phishing attempt",type:"Phishing",detected:"2025-10-01",severity:"Medium",status:"Contained",owner:"IR Team",notes:"User reported suspicious email",assetId:"AST-DEMO-APP",vendorId:"",riskId:"RSK-DEMO-5",controlId:"CTL-DEMO-TRAIN",linkedSummary:"Asset: MediCloud Web Application | Risk: Phishing attack on users | Control: Security awareness training"},
      {id:"INC-DEMO-2",title:"Database outage",type:"Denial of Service",detected:"2025-09-15",severity:"High",status:"Recovered",owner:"DBA",notes:"DDoS attack mitigated",assetId:"AST-DEMO-DB",vendorId:"VND-DEMO-AWS",riskId:"RSK-DEMO-2",controlId:"CTL-DEMO-ENC",linkedSummary:"Asset: MediCloud Database | Vendor: AWS | Risk: Data leakage from database | Control: Data encryption at rest"}
    ];
    treatments = [
      {id:"TRT-DEMO-1",title:"Implement MFA for all users",linked:"RSK-DEMO-1",controlId:"CTL-DEMO-MFA",status:"In progress",targetDate:"2025-12-01",owner:"DevOps Lead",budget:"1000 USD",notes:"Roll out Okta MFA"},
      {id:"TRT-DEMO-2",title:"Key rotation procedure",linked:"ISS-DEMO-2",controlId:"",status:"Open",targetDate:"2025-11-30",owner:"DBA",budget:"",notes:"Automate key rotation"},
      {id:"TRT-DEMO-3",title:"Vendor reassessment",linked:"RSK-DEMO-3",controlId:"CTL-DEMO-VRA",status:"Closed",targetDate:"2025-10-15",owner:"Compliance",budget:"500 USD",notes:"Completed review"}
    ];
    soa = FRAMEWORK_CONTROLS.map(fc => ({ fcId: fc.id, applicability: 'Applicable', implementation: 'Auto', owner: '', rationale: '', evidence: '' }));
    save(K.assets,assets);
    save(K.vendors,vendors);
    save(K.risks,risks);
    save(K.controls,controls);
    save(K.issues,issues);
    save(K.incidents,incidents);
    save(K.treats,treatments);
    save(K.soa,soa);
    refreshAll();
    setImportStatus('Loaded full demo scenario (MediCloud Healthcare App). Explore tabs!',false);
  }
  function loadISOTemplate(){
    controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("ISO 27001")).map(fc => ({
      id: 'CTL-ISO-' + fc.id.split('-')[1],
      name: fc.name,
      type: "Technical",
      status: "Planned",
      owner: "Security Team",
      description: fc.description,
      linkedRiskIds: [],
      linkedFrameworkControlIds: [fc.id],
      evidence: ""
    }));
    soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("ISO 27001")).map(fc => ({ fcId: fc.id, applicability: 'Applicable', implementation: 'Auto', owner: '', rationale: '', evidence: '' }));
    save(K.controls,controls);
    save(K.soa,soa);
    refreshAll();
    showToast('Loaded ISO 27001 template');
  }
  function loadNISTTemplate(){
    controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("NIST CSF")).map(fc => ({
      id: 'CTL-NIST-' + fc.id.split('-')[1],
      name: fc.name,
      type: "Administrative",
      status: "Planned",
      owner: "Compliance Team",
      description: fc.description,
      linkedRiskIds: [],
      linkedFrameworkControlIds: [fc.id],
      evidence: ""
    }));
    soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("NIST CSF")).map(fc => ({ fcId: fc.id, applicability: 'Applicable', implementation: 'Auto', owner: '', rationale: '', evidence: '' }));
    save(K.controls,controls);
    save(K.soa,soa);
    refreshAll();
    showToast('Loaded NIST CSF template');
  }
  function loadPCITemplate(){
    controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("PCI DSS")).map(fc => ({
      id: 'CTL-PCI-' + fc.id.split('-')[1],
      name: fc.name,
      type: "Technical",
      status: "Planned",
      owner: "PCI Team",
      description: fc.description,
      linkedRiskIds: [],
      linkedFrameworkControlIds: [fc.id],
      evidence: ""
    }));
    soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("PCI DSS")).map(fc => ({ fcId: fc.id, applicability: 'Applicable', implementation: 'Auto', owner: '', rationale: '', evidence: '' }));
    save(K.controls,controls);
    save(K.soa,soa);
    refreshAll();
    showToast('Loaded PCI DSS template');
  }
  function loadHIPAATemplate(){
    controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("HIPAA")).map(fc => ({
      id: 'CTL-HIPAA-' + fc.id.split('-')[1],
      name: fc.name,
      type: "Administrative",
      status: "Planned",
      owner: "HIPAA Team",
      description: fc.description,
      linkedRiskIds: [],
      linkedFrameworkControlIds: [fc.id],
      evidence: ""
    }));
    soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("HIPAA")).map(fc => ({ fcId: fc.id, applicability: 'Applicable', implementation: 'Auto', owner: '', rationale: '', evidence: '' }));
    save(K.controls,controls);
    save(K.soa,soa);
    refreshAll();
    showToast('Loaded HIPAA template');
  }
  function resetLab(){
    if(!confirm('This will clear all data in this browser. Continue?')) return;
    assets=[];risks=[];controls=[];issues=[];treatments=[];soa=[];vendors=[];incidents=[];
    Object.values(K).forEach(k=>localStorage.removeItem(k));
    localStorage.removeItem(RISK_CFG_KEY);
    riskConfig = {...defaultRiskConfig};
    refreshAll();
    syncRiskThresholdInputs();
    setImportStatus('Lab reset: all data cleared from this browser.',false);
  }
  // ---------- Tabs ----------
  function bindTabs(){
    const buttons=qsa('[data-grc-tab]');
    const mapping={};
    ['guidance','frameworks','assets','vendors','risks','controls','issues','incidents','treatments','gap','soa','dashboard','matrix','summary','reports','challenges']
    .forEach(id=>mapping[id]=qs('#tab-'+id));
    buttons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const tgt=btn.getAttribute('data-grc-tab');
        buttons.forEach(b=>{
          b.classList.remove('btn-primary');
          b.classList.add('btn-outline-light');
        });
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline-light');
        Object.values(mapping).forEach(el=>el && el.classList.remove('active'));
        if(mapping[tgt]) mapping[tgt].classList.add('active');
        if(tgt==='dashboard') renderDashboard();
        if(tgt==='gap') renderGapTable();
        if(tgt==='matrix') drawMatrix();
        if(tgt==='summary') generateAuditorSummary();
        if(tgt==='soa') renderSoATable();
        if(tgt==='reports') generateReport(); // New
      });
    });
  }
  // ---------- Auditor-style Summary ----------
  function listPhrase(items,max){
    if(!items || !items.length) return '';
    const arr=items.slice(0,max);
    if(arr.length===1) return arr[0];
    if(arr.length===2) return `${arr[0]} and ${arr[1]}`;
    return `${arr.slice(0,-1).join(', ')} and ${arr[arr.length-1]}`;
  }
  function generateAuditorSummary(){
    const lines=[];
    const totalAssets=assets.length;
    const highAssets=assets.filter(a=>a.criticality==='High');
    const assetNames=assets.map(a=>a.name);
    const keyAssets=listPhrase(highAssets.map(a=>a.name),3) || listPhrase(assetNames,3) || 'key information assets';
    lines.push(`# Scope and context\nThe organisation is using the GRC Practice Lab to model approximately ${totalAssets||'0'} key information assets and services. High-criticality assets currently include ${keyAssets}.`);
    const totalVendors=vendors.length;
    const highVendors=vendors.filter(v=>v.criticality==='High');
    lines.push(`There are ${totalVendors} vendors tracked, with ${highVendors.length} high criticality.`);
    const totalRisks=risks.length;
    const highRisks=risks.filter(r=>rLevel(r.score)==='High');
    const medRisks=risks.filter(r=>rLevel(r.score)==='Medium');
    const exHigh=highRisks.slice(0,2).map(r=>{
      const linkedName=r.linkedName ? ` (${r.linkedName})` : '';
      return `${r.title}${linkedName}, score ${r.score}`;
    });
    let riskPara=`# Risk Register\nA total of ${totalRisks||'0'} risks have been documented in the register. `;
    riskPara+=`High risks: ${highRisks.length}; medium risks: ${medRisks.length}; remaining items are low or informational. `;
    if(exHigh.length){
      riskPara+=`Example high risks include ${listPhrase(exHigh,2)}.`;
    }
    lines.push(riskPara.trim());
    const rows=computeGapRows();
    const overall=overallCoverage(rows);
    const ctrlCount=controls.length;
    const catSnippets=rows.slice(0,4).map(r=>{
      const pct=r.total?Math.round((r.implemented/r.total)*100):0;
      return `${r.category}: ${pct}% implemented (${r.implemented}/${r.total}).`;
    });
    let ctrlPara=`# Control environment and framework coverage\nLocal controls defined in the lab: ${ctrlCount}. Overall implemented coverage across the paraphrased framework library is approximately ${overall}% of ${FRAMEWORK_CONTROLS.length} controls. `;
    if(catSnippets.length){
      ctrlPara+=`Coverage by category (sample): ${catSnippets.join(' ')}`;
    }
    lines.push(ctrlPara.trim());
    const openIssues=issues.filter(i=>i.status==='Open' || i.status==='In progress');
    const critIssues=issues.filter(i=>i.severity==='Critical' || i.severity==='High');
    const exIssue=openIssues.slice(0,2).map(i=>i.title);
    const openIncidents=incidents.filter(inc=>inc.status !== 'Closed');
    const critIncidents=incidents.filter(inc=>inc.severity==='Critical' || inc.severity==='High');
    const openActions=treatments.filter(t=>t.status==='Open' || t.status==='In progress');
    const closedActions=treatments.filter(t=>t.status==='Closed');
    let issuePara=`# Issues, findings, incidents and action plans\nThere are ${issues.length} issue(s) recorded in the log, of which ${openIssues.length} are open or in progress and ${critIssues.length} are rated high or critical. `;
    if(exIssue.length){
      issuePara+=`Example open items include ${listPhrase(exIssue,2)}. `;
    }
    issuePara+=`There are ${incidents.length} incidents, with ${openIncidents.length} open and ${critIncidents.length} critical/high. `;
    issuePara+=`The treatment register currently contains ${treatments.length} action item(s), with ${openActions.length} open/in progress and ${closedActions.length} closed.`;
    lines.push(issuePara.trim());
    const highCount=highRisks.length;
    const ov=overallCoverage(computeGapRows());
    const covDesc=ov>=80?'strong, with most key controls implemented':
                  ov>=50?'developing, with several controls implemented but notable gaps remaining':
                  ov>0?'limited, with many controls still to be implemented':
                  'minimal, with framework controls largely not implemented yet';
    let obs=`# Overall observation\nSeveral high-impact risks have been identified${highCount?` (currently ${highCount} high-rated risk(s))`:''}. Control coverage is ${ov}% and is best described as ${covDesc}. `;
    if(openActions.length){
      obs+=`A formal treatment plan is in place, with ${openActions.length} active remediation action(s) tracked against the risk register.`;
    }else{
      obs+=`No active treatment actions are currently recorded against the risk register.`;
    }
    lines.push(obs.trim());
    qs('#summary-text').value = lines.join('\n\n');
  }
  // ---------- Reports ----------
  function generateReport(){
    const type = qs('#report-type').value;
    let content = '';
    switch(type){
      case 'full-audit':
        content = generateFullAuditReport();
        break;
      case 'risk-register':
        content = generateRiskRegisterReport();
        break;
      case 'control-coverage':
        content = generateControlCoverageReport();
        break;
      case 'issue-summary':
        content = generateIssueSummaryReport();
        break;
      case 'vendor-report':
        content = generateVendorReport();
        break;
      case 'incident-report':
        content = generateIncidentReport();
        break;
    }
    qs('#report-text').value = content;
  }
  function generateFullAuditReport(){
    let report = '# Full Audit Report\n\n';
    report += qs('#summary-text').value; // Include auditor summary
    report += '\n\n## Risk Register\n' + generateRiskRegisterReport(false);
    report += '\n\n## Control Coverage\n' + generateControlCoverageReport(false);
    report += '\n\n## Issue Summary\n' + generateIssueSummaryReport(false);
    report += '\n\n## Vendor Risk\n' + generateVendorReport(false);
    report += '\n\n## Incident Log\n' + generateIncidentReport(false);
    return report;
  }
  function generateRiskRegisterReport(full = true){
    let report = full ? '# Risk Register Report\n\n' : '';
    risks.forEach(r => {
      report += `### ${r.title}\n`;
      report += `- Linked: ${r.linkedName || '-'}\n`;
      report += `- Category: ${r.category}\n`;
      report += `- Inherent Score: ${r.score} (${rLevel(r.score)})\n`;
      report += `- Residual Score: ${r.resScore} (${rLevel(r.resScore)})\n`;
      report += `- Status: ${r.status}\n`;
      report += `- Notes: ${r.notes || '-'}\n\n`;
    });
    return report;
  }
  function generateControlCoverageReport(full = true){
    let report = full ? '# Control Coverage Report\n\n' : '';
    const rows = computeGapRows();
    rows.forEach(r => {
      const pct = r.total ? Math.round((r.implemented / r.total) * 100) : 0;
      report += `### ${r.category}\n`;
      report += `- Total: ${r.total}\n`;
      report += `- Implemented: ${r.implemented}\n`;
      report += `- Planned: ${r.plannedOnly}\n`;
      report += `- Not Implemented: ${r.notImplemented}\n`;
      report += `- Coverage: ${pct}%\n\n`;
    });
    return report;
  }
  function generateIssueSummaryReport(full = true){
    let report = full ? '# Issue Summary Report\n\n' : '';
    issues.forEach(i => {
      report += `### ${i.title}\n`;
      report += `- Type: ${i.type}\n`;
      report += `- Severity: ${i.severity}\n`;
      report += `- Status: ${i.status}\n`;
      report += `- Linked: ${i.linkedSummary || '-'}\n`;
      report += `- Due: ${i.dueDate || '-'}\n`;
      report += `- Notes: ${i.notes || '-'}\n\n`;
    });
    return report;
  }
  function generateVendorReport(full = true){
    let report = full ? '# Vendor Risk Report\n\n' : '';
    vendors.forEach(v => {
      report += `### ${v.name}\n`;
      report += `- Type: ${v.type}\n`;
      report += `- Criticality: ${v.criticality}\n`;
      report += `- Data Access: ${v.dataAccess || '-'}\n`;
      report += `- Contract: ${v.contract || '-'}\n`;
      report += `- Last Assessment: ${v.assessment || '-'}\n`;
      report += `- Notes: ${v.notes || '-'}\n\n`;
    });
    return report;
  }
  function generateIncidentReport(full = true){
    let report = full ? '# Incident Log Report\n\n' : '';
    incidents.forEach(inc => {
      report += `### ${inc.title}\n`;
      report += `- Type: ${inc.type}\n`;
      report += `- Detected: ${inc.detected}\n`;
      report += `- Severity: ${inc.severity}\n`;
      report += `- Status: ${inc.status}\n`;
      report += `- Linked: ${inc.linkedSummary || '-'}\n`;
      report += `- Notes: ${inc.notes || '-'}\n\n`;
    });
    return report;
  }
  function downloadMD(filename, content){
    const blob = new Blob([content], {type:'text/markdown;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
  qs('#report-export-md').addEventListener('click', () => downloadMD('grc_report.md', qs('#report-text').value));
  qs('#summary-export-md').addEventListener('click', () => downloadMD('auditor_summary.md', qs('#summary-text').value));
  // PDF export
  function generatePDF(content, filename) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const lines = doc.splitTextToSize(content, 180);
    doc.text(lines, 10, 10);
    doc.save(filename);
  }
  qs('#report-export-pdf').addEventListener('click', () => generatePDF(qs('#report-text').value, 'grc_report.pdf'));
  qs('#summary-export-pdf').addEventListener('click', () => generatePDF(qs('#summary-text').value, 'auditor_summary.pdf'));
  // ---------- Refresh all ----------
  function refreshAll(){
    renderFrameworkControls();
    renderAssetsTable();
    renderVendorsTable();
    renderRisksTable();
    populateControlFrameworks();
    renderControlsTable();
    populateIssueDropdowns();
    renderIssuesTable();
    renderIncidentsTable();
    renderGapTable();
    renderDashboard();
    populateTreatmentDropdownLinked();
    populateTreatmentDropdownControls();
    renderTreatmentsTable();
    drawMatrix();
    generateAuditorSummary();
    renderSoATable();
  }
  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded',()=>{
    ['#framework-filter','#category-filter','#framework-search'].forEach(sel=>{
      const el=qs(sel);
      if(!el) return;
      el.addEventListener(sel==='#framework-search'?'input':'change',renderFrameworkControls);
    });
    ['#soa-framework-filter', '#soa-category-filter', '#soa-applicability-filter', '#soa-implementation-filter'].forEach(sel => {
      const el = qs(sel);
      if (el) el.addEventListener('change', renderSoATable);
    });
    bindTabs();
    populateControlFrameworks();
    populateControlRisks();
    populateRiskAssetOptions();
    populateIssueDropdowns();
    populateTreatmentDropdownLinked();
    populateTreatmentDropdownControls();
    qs('#btn-export').addEventListener('click',exportScenario);
    qs('#btn-import').addEventListener('click',()=>{
      setImportStatus('',false);
      const f=qs('#file-import'); f.value=''; f.click();
    });
    qs('#file-import').addEventListener('change',e=>{
      const file=e.target.files && e.target.files[0];
      if(file) importScenarioFile(file);
    });
    qs('#btn-load-demo').addEventListener('click',()=>{
      if(!confirm('Loading the demo will overwrite current lab data in this browser. Continue?')) return;
      loadDemoScenario();
    });
    qs('#btn-reset').addEventListener('click',resetLab);
    qs('#toggle-inherent').addEventListener('click',()=>{
      showResidual=false;
      qs('#toggle-inherent').classList.add('btn-primary');
      qs('#toggle-residual').classList.remove('btn-primary');
      drawMatrix();
    });
    qs('#toggle-residual').addEventListener('click',()=>{
      showResidual=true;
      qs('#toggle-residual').classList.add('btn-primary');
      qs('#toggle-inherent').classList.remove('btn-primary');
      drawMatrix();
    });
    qs('#matrix-export').addEventListener('click',()=>{
      const a=document.createElement('a');
      a.download='risk_matrix.png';
      a.href=canvas.toDataURL('image/png');
      a.click();
    });
    qs('#summary-refresh').addEventListener('click',generateAuditorSummary);
    qs('#summary-copy').addEventListener('click', () => {
      const text = qs('#summary-text');
      text.select();
      document.execCommand('copy');
      showToast('Copied to clipboard');
    });
    qs('#generate-report').addEventListener('click', generateReport);
    qs('#soa-export').addEventListener('click', exportSoACSV);
    // CSV buttons
    qs('#export-assets').addEventListener('click', exportAssetsCSV);
    qs('#export-vendors').addEventListener('click', exportVendorsCSV);
    qs('#export-risks').addEventListener('click', exportRisksCSV);
    qs('#export-controls').addEventListener('click', exportControlsCSV);
    qs('#export-issues').addEventListener('click', exportIssuesCSV);
    qs('#export-incidents').addEventListener('click', exportIncidentsCSV);
    qs('#export-treatments').addEventListener('click', exportTreatmentsCSV);
    // Threshold inputs
    qs('#risk-thres-high').addEventListener('change', applyRiskThresholdInputs);
    qs('#risk-thres-med').addEventListener('change', applyRiskThresholdInputs);
    qs('#risk-thres-reset').addEventListener('click', ()=>{
      riskConfig = {...defaultRiskConfig};
      saveRiskConfig(riskConfig);
      syncRiskThresholdInputs();
      renderRisksTable();
      drawMatrix();
      renderDashboard();
    });
    qs('#risk-filter-status').addEventListener('change', ()=>{
      riskFilterStatus = qs('#risk-filter-status').value;
      renderRisksTable();
      drawMatrix();
      renderDashboard();
    });
    qs('#risk-filter-level').addEventListener('change', ()=>{
      riskFilterLevel = qs('#risk-filter-level').value;
      renderRisksTable();
      drawMatrix();
      renderDashboard();
    });
    qs('#risk-filter-category').addEventListener('change', ()=>{
      riskFilterCategory = qs('#risk-filter-category').value;
      renderRisksTable();
      drawMatrix();
      renderDashboard();
    });
    qs('#risk-sort-field').addEventListener('change', ()=>{
      riskSortField = qs('#risk-sort-field').value || 'score';
      renderRisksTable();
      drawMatrix();
    });
    qs('#risk-sort-dir').addEventListener('change', ()=>{
      riskSortDir = qs('#risk-sort-dir').value || 'desc';
      renderRisksTable();
      drawMatrix();
    });
    // Template buttons
    qs('#load-iso-template').addEventListener('click', loadISOTemplate);
    qs('#load-nist-template').addEventListener('click', loadNISTTemplate);
    qs('#load-pci-template').addEventListener('click', loadPCITemplate);
    qs('#load-hipaa-template').addEventListener('click', loadHIPAATemplate);
    // sync thresholds into inputs
    syncRiskThresholdInputs();
    refreshAll();
  });
  </script>
</div>
<script>
(function uiFixPack(){
  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  // Loading overlay helpers
  const overlay = document.getElementById('uiBusyOverlay');
  function setBusy(on, label){
    if(!overlay) return;
    overlay.classList.toggle('show', !!on);
    overlay.setAttribute('aria-hidden', on ? 'false' : 'true');
    if(label){
      const t = overlay.querySelector('div[style*="font-weight:900"]');
      if(t) t.textContent = label;
    }
  }
  window.__grcSetBusy = setBusy;

  // Attach loading feedback to export/report buttons (best-effort, no breaking)
  const busyIds = [
    'export-assets','export-vendors','export-risks','export-controls','export-issues','export-incidents','export-treatments',
    'export-gap','export-soa','export-dashboard','export-matrix','export-summary','export-reports'
  ];
  busyIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('click', ()=> {
      setBusy(true, 'Exporting…');
      setTimeout(()=> setBusy(false), 900);
    }, {capture:true});
  });

  // Make filter rows look like "filterBar" without changing markup
  const tabFrameworks = document.getElementById('tab-frameworks');
  if(tabFrameworks){
    const row = tabFrameworks.querySelector('.row.mb-3');
    if(row) row.classList.add('filterBar');
  }
  const tabRisks = document.getElementById('tab-risks');
  if(tabRisks){
    const row = tabRisks.querySelector('.row.mb-2');
    if(row) row.classList.add('filterBar');
  }

  // Empty states: upgrade existing empty divs
  qsa('[id$="-empty"]').forEach(el => {
    el.classList.add('emptyState');
  });

  // Action buttons alignment: try to wrap last cell buttons
  qsa('table tbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if(!tds.length) return;
    const last = tds[tds.length-1];
    // if last contains multiple buttons, add flex wrapper
    const btns = last.querySelectorAll('.btn');
    if(btns.length >= 1){
      last.classList.add('actionsCell');
    }
  });

  // Edit mode highlighting: detect hidden id fields in common forms
  const formIdFields = [
    ['asset-form','asset-id'],
    ['vendor-form','vendor-id'],
    ['risk-form','risk-id'],
    ['control-form','control-id'],
    ['issue-form','issue-id'],
    ['incident-form','incident-id'],
    ['treat-form','treat-id']
  ];
  formIdFields.forEach(([formId, idFieldId])=>{
    const form = document.getElementById(formId);
    const idField = document.getElementById(idFieldId);
    if(!form || !idField) return;

    // Add small badge
    if(!form.querySelector('.editBadge')){
      const badge = document.createElement('div');
      badge.className = 'editBadge';
      badge.textContent = 'Edit mode';
      form.prepend(badge);
    }

    const update = ()=>{
      const editing = !!(idField.value && String(idField.value).trim().length);
      form.classList.toggle('is-editing', editing);
    };
    update();
    // Mutation observer for programmatic value changes
    const mo = new MutationObserver(update);
    mo.observe(idField, {attributes:true, attributeFilter:['value']});
    // Also poll on input events
    idField.addEventListener('input', update);
    idField.addEventListener('change', update);
    // Lightweight periodic sync (safe)
    setInterval(update, 800);
  });

  // SoA: if there are inputs used for rationale/evidence, upgrade to textarea non-destructively
  // (Keeps values and triggers change/input events.)
  const tabSoa = document.getElementById('tab-soa');
  if(tabSoa){
    // convert any inputs with class 'soa-input' that are meant for longer text (heuristic)
    qsa('input.soa-input', tabSoa).forEach(inp=>{
      const name = (inp.getAttribute('placeholder')||'').toLowerCase();
      const id = (inp.id||'').toLowerCase();
      const isLong = name.includes('evidence') || name.includes('rationale') || id.includes('evidence') || id.includes('rationale') || inp.value.length > 40;
      if(!isLong) return;

      const ta = document.createElement('textarea');
      ta.className = inp.className + ' soa-notes';
      ta.value = inp.value || '';
      ta.setAttribute('data-from', 'soa-input');
      if(inp.name) ta.name = inp.name;
      if(inp.id) ta.id = inp.id; // preserve id for JS binding
      if(inp.getAttribute('data-key')) ta.setAttribute('data-key', inp.getAttribute('data-key'));
      if(inp.getAttribute('data-row')) ta.setAttribute('data-row', inp.getAttribute('data-row'));
      ta.placeholder = inp.placeholder || '';
      inp.replaceWith(ta);

      // propagate events so existing handlers keep working
      ['input','change'].forEach(ev=>{
        ta.addEventListener(ev, ()=> {
          const e = new Event(ev, {bubbles:true});
          ta.dispatchEvent(e);
        }, {passive:true});
      });
    });
  }
})();

/* ===== Premium UI Patch (safe DOM helpers) ===== */
document.addEventListener('DOMContentLoaded', () => {
  // Make SoA filters horizontal
  const soaFilterRow = document.querySelector('#tab-soa .row.mb-3');
  if(soaFilterRow) soaFilterRow.classList.add('grc-filter-row');

  // Assets: convert data-types checkbox block into a horizontal row (visual only)
  const assetForm = document.getElementById('asset-form');
  if(assetForm){
    // Force key long fields to span full width
    ['asset-notes'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        const fg = el.closest('.form-group');
        if(fg) fg.classList.add('grc-span-2');
      }
    });
    // data types group (wrap the custom controls if present)
    const dtypes = assetForm.querySelectorAll('.custom-control.custom-checkbox');
    if(dtypes && dtypes.length){
      const parent = dtypes[0].closest('.form-group') || dtypes[0].parentElement;
      if(parent){
        // create wrapper row if not already
        if(!parent.querySelector('.grc-check-row')){
          const wrap = document.createElement('div');
          wrap.className = 'grc-check-row';
          dtypes.forEach(n => wrap.appendChild(n));
          parent.appendChild(wrap);
        }
        parent.classList.add('grc-span-2');
      }
    }
  }

  // Treatments: apply grid styling without changing markup
  const treatForm = document.getElementById('treat-form');
  if(treatForm){
    treatForm.classList.add('grc-form-grid');
    const notes = document.getElementById('treat-notes');
    if(notes){
      const fg = notes.closest('.form-group');
      if(fg) fg.classList.add('grc-span-2');
    }
  }

  // Ensure SoA rows have labels for mobile stacked layout (if not already)
  if(typeof applySoALabels === 'function'){
    // run once after first render too (renderSoATable calls it, but safe)
    setTimeout(()=>{ try{ applySoALabels(); }catch(e){} }, 600);
  }
});


/* === SoA mobile labels (safe, non-breaking) === */
(function setSoALabels(){
  try{
    const tab = document.getElementById("tab-soa");
    if(!tab) return;
    const table = tab.querySelector("table");
    if(!table) return;
    const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
    if(!headers.length) return;
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(tr=>{
      Array.from(tr.children).forEach((td, idx)=>{
        if(!td.getAttribute("data-label")){
          td.setAttribute("data-label", headers[idx] || "");
        }
      });
    });
    // Also observe future row renders (when filtering updates)
    const tbody = table.querySelector("tbody");
    if(!tbody) return;
    const obs = new MutationObserver(()=>{
      const rows2 = tbody.querySelectorAll("tr");
      rows2.forEach(tr=>{
        Array.from(tr.children).forEach((td, idx)=>{
          if(!td.getAttribute("data-label")){
            td.setAttribute("data-label", headers[idx] || "");
          }
        });
      });
    });
    obs.observe(tbody, {childList:true, subtree:true});
  }catch(e){}
})();

</script>

<script>
(function(){
  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  function tryInit(){
    try{
      if (typeof FRAMEWORK_CONTROLS === 'undefined' || !Array.isArray(FRAMEWORK_CONTROLS) || FRAMEWORK_CONTROLS.length===0) { return false; }
      if (typeof getSoAEntry !== 'function') { return false; }
      // Wait until core SoA data exists
      if (typeof FRAMEWORK_CONTROLS === 'undefined' || !Array.isArray(FRAMEWORK_CONTROLS) || FRAMEWORK_CONTROLS.length === 0) {
        return false;
      }
      if (typeof getSoAEntry !== "function") {
        return false;
      }
      // Ensure filters default to all
      var fw = qs('#soa-framework-filter');
      var cat = qs('#soa-category-filter');
      var app = qs('#soa-applicability-filter');
      var impl = qs('#soa-implementation-filter');
      if (fw && Array.from(fw.options).some(o=>o.value==='all')) fw.value = 'all';
      if (cat && Array.from(cat.options).some(o=>o.value==='all')) cat.value = 'all';
      if (app && Array.from(app.options).some(o=>o.value==='all')) app.value = 'all';
      if (impl && Array.from(impl.options).some(o=>o.value==='all')) impl.value = 'all';

      if (typeof bindSoAStudio === "function") {
        bindSoAStudio();
      } else if (typeof renderSoAStudio === "function") {
        renderSoAStudio();
      }
      return true;
    } catch(e){
      return false;
    }
  }

  // 1) Run once on page load
  document.addEventListener('DOMContentLoaded', function(){
    if (qs('#soa-list')) {
      // Delay slightly to allow any app init to finish
      setTimeout(tryInit, 50);
      setTimeout(tryInit, 300);
      // Keep trying for up to ~6s in case the main app initializes later
      var tries=0;
      var iv=setInterval(function(){
        tries++;
        var ok = tryInit();
        if(ok || tries>30){ clearInterval(iv); }
      }, 200);
    }
  });

  // 2) Run whenever user clicks the SoA tab button
  function bindSoATabClick(){
    var btn = qs('.grc-tab-button[data-grc-tab="soa"]') || qs('[data-grc-tab="soa"]') || qs('.grc-tab-button[data-grc-tab="tab-soa"]') || qs('[data-grc-tab="tab-soa"]');
    if (!btn) return;
    if (btn.__soaBound) return;
    btn.__soaBound = true;
    btn.addEventListener('click', function(){
      // After tab becomes visible
      setTimeout(tryInit, 30);
      setTimeout(tryInit, 200);
    });
  }

  // bind now and also after a short delay (in case nav is built later)
  bindSoATabClick();
  setTimeout(bindSoATabClick, 200);
})();
</script>

</body>
</html>
