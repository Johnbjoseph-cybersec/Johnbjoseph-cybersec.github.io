<!DOCTYPE html>
<html lang="en">
<head>
    <title>GRC Practice Lab – John B Joseph</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <!-- Bootstrap CSS for enterprise polish -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <!-- Custom enterprise styles -->
    <style>
        body {
            background-color: #f8f9fa;
            color: #212529;
            font-family: 'Roboto', sans-serif;
        }
        .navbar {
            background-color: #007bff !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand, .nav-link {
            color: #fff !important;
        }
        .ftco-section {
            padding: 60px 0;
        }
        .grc-lab-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 30px;
        }
        .dashboard-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            transition: box-shadow 0.3s;
        }
        .dashboard-card:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .table {
            background: #fff;
        }
        .table thead th {
            background: #f1f3f5;
            border-bottom: 2px solid #dee2e6;
        }
        .btn-primary {
            background: #007bff;
            border-color: #007bff;
        }
        .guidance {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
        }
        textarea#summary-text, textarea#report-text {
            height: 600px; /* Increased text window */
            font-family: 'Roboto', sans-serif;
            background: #fff;
            border: 1px solid #ced4da;
        }
        .heat-good { background: #28a745; color: #fff; }
        .heat-medium { background: #ffc107; color: #212529; }
        .heat-low { background: #fd7e14; color: #fff; }
        .heat-none { background: #dc3545; color: #fff; }
        #risk-matrix-canvas {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .challenge-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        /* More aesthetic risk matrix styles */
        .risk-matrix-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
    </style>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">John B Joseph</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="ftco-nav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a href="index.html#home-section" class="nav-link">Home</a></li>
                    <li class="nav-item"><a href="toolkit.html" class="nav-link">Toolkit</a></li>
                    <li class="nav-item active"><a href="grc-lab.html" class="nav-link">GRC Practice Lab</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Lab -->
    <section class="ftco-section">
        <div class="grc-lab-container container">
            <!-- Header -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10 text-center">
                    <h1 class="mb-3">GRC Practice Lab (Enterprise Edition)</h1>
                    <p class="lead">Practice frameworks, assets, risks, controls, issues, actions, vendors, incidents and reporting — all in your browser (data stays local). Built to empower the next generation.</p>
                    <p class="small text-muted mb-0">Controls are paraphrased from ISO 27001:2022, NIST CSF 2.0, PCI DSS v4.0, HIPAA, SOC 2 for education only. Now with over 200 controls, challenge mode, templates, guidance, and PDF exports.</p>
                </div>
            </div>
            <!-- Guidance Overview -->
            <div class="guidance mb-4">
                <h4>Welcome to the GRC Practice Lab</h4>
                <p>This tool is designed for aspiring GRC analysts, students, and professionals to hands-on practice cybersecurity governance, risk, and compliance concepts. Everything runs locally in your browser - no data leaves your device.</p>
                <p class="small text-muted"><strong>Disclaimer:</strong> All controls are paraphrased and intended solely for educational and practice purposes. This lab is not for real-world production use or compliance certification.</p>
                <ul>
                    <li><strong>Start here:</strong> Use the tabs below to navigate. Begin with 'Guidance' for step-by-step instructions.</li>
                    <li><strong>Learn by doing:</strong> Load templates or demos, add your own data, analyze gaps, generate reports.</li>
                    <li><strong>Challenge yourself:</strong> Try Challenge Mode for scored scenarios to test your skills.</li>
                    <li><strong>Tips:</strong> Hover over tooltips for help. Export data anytime. Reset if needed.</li>
                    <li><strong>Pro tip:</strong> GRC is about people and process as much as tech. Focus on business impact, not just checklists.</li>
                </ul>
            </div>
            <!-- Tabs -->
            <div class="row mb-4">
                <div class="col-md-12 text-center">
                    <div class="btn-group grc-tab-buttons" role="group">
                        <button class="btn btn-primary btn-sm" data-grc-tab="guidance">Guidance</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="frameworks">Frameworks & Controls</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="assets">Assets</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="vendors">Vendors</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="risks">Risks</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="controls">Local Controls</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="issues">Issues / Findings</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="incidents">Incidents</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="treatments">Treatments</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="gap">Gap Analysis</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="soa">SoA</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="dashboard">Dashboard</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="matrix">Risk Matrix</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="summary">Auditor Summary</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="reports">Reports</button>
                        <button class="btn btn-outline-primary btn-sm" data-grc-tab="challenges">Challenge Mode</button>
                    </div>
                </div>
            </div>
            <!-- Guidance Tab -->
            <div id="tab-guidance" class="grc-tab active">
                <h3>GRC Practice Lab Guidance</h3>
                <div class="guidance">
                    <h4>Step-by-Step Guide</h4>
                    <ul>
                        <li><strong>1. Learn Frameworks:</strong> Review standard controls in Frameworks tab. Use to understand what good looks like.</li>
                        <li><strong>2. Inventory Assets:</strong> Add your organization's key assets (systems, data, etc). Classify criticality and data types.</li>
                        <li><strong>3. Manage Vendors:</strong> Track third-parties, assess risks, contracts.</li>
                        <li><strong>4. Identify Risks:</strong> For each asset/vendor, add risks with likelihood/impact. Use matrix to visualize.</li>
                        <li><strong>5. Implement Controls:</strong> Add local controls, map to frameworks and risks. Aim for coverage.</li>
                        <li><strong>6. Log Issues/Findings:</strong> From audits or tests, add issues linked to objects.</li>
                        <li><strong>7. Report Incidents:</strong> Log security incidents, link to response.</li>
                        <li><strong>8. Plan Treatments:</strong> Add actions to mitigate risks/issues. Track progress.</li>
                        <li><strong>9. Assess Compliance:</strong> Use Gap Analysis and SoA to check against standards.</li>
                        <li><strong>10. Monitor Dashboard:</strong> View metrics, heatmaps.</li>
                        <li><strong>11. Generate Reports:</strong> Create summaries, exports for management.</li>
                        <li><strong>12. Challenge Mode:</strong> Test skills with scenarios, get scores.</li>
                    </ul>
                    <h4>Best Practices</h4>
                    <p>GRC isn't checkboxes - it's about enabling business securely. Prioritize high-impact risks. Involve stakeholders. Review regularly. Use this lab to simulate real scenarios before production.</p>
                    <p>Pro Tips:</p>
                    <ul>
                        <li>Use demos/templates to start quickly.</li>
                        <li>Export often - data is local but can be lost if cache cleared.</li>
                        <li>For advanced: Map multiple frameworks, simulate audits in Challenge Mode.</li>
                        <li>Common pitfall: Over-focus on tech; remember people/process.</li>
                    </ul>
                    <p>Feedback? Tweet @johnbjoseph or contribute on GitHub.</p>
                </div>
            </div>
            <!-- Frameworks -->
            <div id="tab-frameworks" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Browse and filter controls from major standards. Use these to map your local controls for compliance. Tip: Search for specific topics like 'access'.</span></span>: Review unified library. Over 200 controls from ISO, NIST, PCI, HIPAA, SOC2.</p>
                </div>
                <h3>Framework Library</h3>
                <p class="mb-3">Filter and review a unified control set aligned to ISO/NIST/PCI/HIPAA/SOC2.</p>
                <div class="row mb-3">
                    <div class="col-md-4 mb-2">
                        <label class="text-muted small mb-1">Filter by Framework</label>
                        <select id="framework-filter" class="form-select form-select-sm">
                            <option value="all">All frameworks</option>
                            <option value="ISO 27001">ISO 27001</option>
                            <option value="NIST CSF">NIST CSF</option>
                            <option value="PCI DSS">PCI DSS</option>
                            <option value="HIPAA">HIPAA</option>
                            <option value="SOC2">SOC 2</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="text-muted small mb-1">Filter by Category</label>
                        <select id="category-filter" class="form-select form-select-sm">
                            <option value="all">All categories</option>
                            <option>Access Control</option>
                            <option>Identity &amp; Authentication</option>
                            <option>Logging &amp; Monitoring</option>
                            <option>Encryption &amp; Key Management</option>
                            <option>Backup &amp; Recovery</option>
                            <option>Change Management</option>
                            <option>Vulnerability Management</option>
                            <option>Incident Response</option>
                            <option>Vendor Risk</option>
                            <option>Policy &amp; Governance</option>
                            <option>Awareness &amp; Training</option>
                            <option>Physical Security</option>
                            <option>Network Security</option>
                            <option>Asset Management</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="text-muted small mb-1">Search</label>
                        <input id="framework-search" class="form-control form-control-sm" placeholder="Search by name, ID, description...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width:10%">ID</th>
                                <th style="width:20%">Name</th>
                                <th style="width:18%">Category</th>
                                <th style="width:20%">Based On</th>
                                <th style="width:32%">Description</th>
                            </tr>
                        </thead>
                        <tbody id="frameworks-table-body"></tbody>
                    </table>
                    <div class="mt-2 text-end">
                        <small id="frameworks-count" class="text-muted"></small>
                    </div>
                </div>
            </div>
            <!-- Assets -->
            <div id="tab-assets" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Add key assets like apps, databases, servers. Classify criticality and data. Link to risks later. Tip: Start with high-critical assets handling sensitive data.</span></span>: Build your asset inventory. Essential for risk assessment.</p>
                </div>
                <h3>Asset Inventory</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Asset</h5>
                            <form id="asset-form">
                                <input type="hidden" id="asset-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Name *</label>
                                    <input id="asset-name" class="form-control form-control-sm" required placeholder="e.g. MediCloud Web App">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Type *</label>
                                    <select id="asset-type" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>Application</option><option>Database</option><option>Server / Host</option>
                                        <option>Network / Security Device</option><option>Cloud Service</option>
                                        <option>Vendor / Third Party</option><option>Data Store</option>
                                        <option>People / Role</option><option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Business criticality *</label>
                                    <select id="asset-criticality" class="form-select form-select-sm" required>
                                        <option value="">Select level...</option>
                                        <option>High</option><option>Medium</option><option>Low</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small d-block">Data types</label>
                                    <div class="d-flex flex-wrap">
                                        <div class="form-check me-3">
                                            <input type="checkbox" class="form-check-input asset-dt" id="dt-phi" value="PHI">
                                            <label class="form-check-label" for="dt-phi">PHI</label>
                                        </div>
                                        <div class="form-check me-3">
                                            <input type="checkbox" class="form-check-input asset-dt" id="dt-pii" value="PII">
                                            <label class="form-check-label" for="dt-pii">PII</label>
                                        </div>
                                        <div class="form-check me-3">
                                            <input type="checkbox" class="form-check-input asset-dt" id="dt-pan" value="Card data">
                                            <label class="form-check-label" for="dt-pan">Card data</label>
                                        </div>
                                        <div class="form-check me-3">
                                            <input type="checkbox" class="form-check-input asset-dt" id="dt-int" value="Internal data">
                                            <label class="form-check-label" for="dt-int">Internal data</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Owner</label>
                                    <input id="asset-owner" class="form-control form-control-sm" placeholder="e.g. DevOps Team / CTO">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Location / Scope</label>
                                    <input id="asset-location" class="form-control form-control-sm" placeholder="e.g. AWS US-East-1, In-scope for PCI">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Notes</label>
                                    <textarea id="asset-notes" class="form-control form-control-sm" rows="2" placeholder="Scope, region, integrations..."></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit" id="asset-form-submit">Save asset</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="asset-form-cancel">Clear</button>
                                </div>
                                <small class="text-muted d-block mt-2">Stored locally in your browser.</small>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Assets</h5>
                                <div>
                                    <button id="export-assets" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="assets-count" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:20%">Name</th><th style="width:14%">Type</th><th style="width:12%">Criticality</th>
                                            <th style="width:18%">Data types</th><th style="width:14%">Owner</th><th style="width:12%">Location</th><th style="width:10%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assets-table-body"></tbody>
                                </table>
                            </div>
                            <div id="assets-empty" class="text-muted small mt-2">No assets yet. Add some to start risk assessment.</div>
                            <ul class="pagination mt-3" id="assets-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Vendors -->
            <div id="tab-vendors" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Track third-party vendors. Assess risks, contracts. Link to assets/risks. Tip: Prioritize critical vendors handling sensitive data.</span></span>: Manage vendor relationships for third-party risk.</p>
                </div>
                <h3>Vendor Management</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Vendor</h5>
                            <form id="vendor-form">
                                <input type="hidden" id="vendor-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Name *</label>
                                    <input id="vendor-name" class="form-control form-control-sm" required placeholder="e.g. AWS">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Type *</label>
                                    <select id="vendor-type" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>Cloud Provider</option><option>SaaS</option><option>Outsourcing</option><option>Hardware</option><option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Criticality *</label>
                                    <select id="vendor-criticality" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>High</option><option>Medium</option><option>Low</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Data Access</label>
                                    <select id="vendor-data-access" class="form-select form-select-sm">
                                        <option>None</option><option>Read</option><option>Read/Write</option><option>Full</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Contract Status</label>
                                    <select id="vendor-contract" class="form-select form-select-sm">
                                        <option>Active</option><option>Pending</option><option>Expired</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Last Assessment</label>
                                    <input type="date" id="vendor-assessment" class="form-control form-control-sm">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Notes</label>
                                    <textarea id="vendor-notes" class="form-control form-control-sm" rows="2" placeholder="Services, SLAs, risks..."></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit">Save vendor</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="vendor-form-cancel">Clear</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Vendors</h5>
                                <div>
                                    <button id="export-vendors" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="vendors-count" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:20%">Name</th><th style="width:15%">Type</th><th style="width:12%">Criticality</th>
                                            <th style="width:15%">Data Access</th><th style="width:15%">Contract</th><th style="width:15%">Last Assessment</th><th style="width:8%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendors-table-body"></tbody>
                                </table>
                            </div>
                            <div id="vendors-empty" class="text-muted small mt-2">No vendors yet. Add third-parties to assess supply chain risks.</div>
                            <ul class="pagination mt-3" id="vendors-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Risks -->
            <div id="tab-risks" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Add risks linked to assets/vendors. Score likelihood/impact. Use thresholds to categorize. Tip: Focus on top risks (high score, open status).</span></span>: Build risk register. Link to assets/vendors for context.</p>
                </div>
                <h3>Risk Register</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Risk</h5>
                            <form id="risk-form">
                                <input type="hidden" id="risk-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Title *</label>
                                    <input id="risk-title" class="form-control form-control-sm" required placeholder="e.g. Unauthorised access to app">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Linked Asset/Vendor *</label>
                                    <select id="risk-linked" class="form-select form-select-sm" required>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Category *</label>
                                    <select id="risk-category" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>Cybersecurity</option><option>Compliance</option><option>Operational</option>
                                        <option>Privacy</option><option>Third-Party</option><option>Financial</option><option>Reputational</option><option>Other</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Likelihood (1–5) *</label>
                                        <select id="risk-likelihood" class="form-select form-select-sm" required>
                                            <option value="">Select...</option>
                                            <option value="1">1 – Rare</option><option value="2">2 – Unlikely</option><option value="3">3 – Possible</option>
                                            <option value="4">4 – Likely</option><option value="5">5 – Almost certain</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Impact (1–5) *</label>
                                        <select id="risk-impact" class="form-select form-select-sm" required>
                                            <option value="">Select...</option>
                                            <option value="1">1 – Insignificant</option><option value="2">2 – Minor</option><option value="3">3 – Moderate</option>
                                            <option value="4">4 – Major</option><option value="5">5 – Severe</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <label class="form-label small">Residual Likelihood</label>
                                        <select id="risk-res-likelihood" class="form-select form-select-sm">
                                            <option value="">Select...</option>
                                            <option value="1">1 – Rare</option><option value="2">2 – Unlikely</option><option value="3">3 – Possible</option>
                                            <option value="4">4 – Likely</option><option value="5">5 – Almost certain</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Residual Impact</label>
                                        <select id="risk-res-impact" class="form-select form-select-sm">
                                            <option value="">Select...</option>
                                            <option value="1">1 – Insignificant</option><option value="2">2 – Minor</option><option value="3">3 – Moderate</option>
                                            <option value="4">4 – Major</option><option value="5">5 – Severe</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group mb-3 mt-3">
                                    <label class="form-label small">Owner</label>
                                    <input id="risk-owner" class="form-control form-control-sm" placeholder="e.g. CISO / Product Owner">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Status *</label>
                                    <select id="risk-status" class="form-select form-select-sm" required>
                                        <option>Open</option><option>In progress</option><option>Mitigated</option><option>Accepted</option><option>Avoided</option><option>Transferred</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Description / Notes</label>
                                    <textarea id="risk-notes" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit" id="risk-form-submit">Save risk</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="risk-form-cancel">Clear</button>
                                </div>
                                <small class="text-muted d-block mt-2">Score = Likelihood × Impact (1–25). Residual after controls. High / Medium / Low thresholds configurable.</small>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Risks</h5>
                                <div>
                                    <button id="export-risks" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="risks-count" class="text-muted"></small>
                                </div>
                            </div>
                            <!-- Filters + sorting -->
                            <div class="row mb-2">
                                <div class="col-md-3 mb-1">
                                    <label class="form-label small">Filter by status</label>
                                    <select id="risk-filter-status" class="form-select form-select-sm">
                                        <option value="all">All statuses</option>
                                        <option>Open</option>
                                        <option>In progress</option>
                                        <option>Mitigated</option>
                                        <option>Accepted</option>
                                        <option>Avoided</option>
                                        <option>Transferred</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-1">
                                    <label class="form-label small">Filter by level</label>
                                    <select id="risk-filter-level" class="form-select form-select-sm">
                                        <option value="all">All levels</option>
                                        <option>High</option>
                                        <option>Medium</option>
                                        <option>Low</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-1">
                                    <label class="form-label small">Filter by category</label>
                                    <select id="risk-filter-category" class="form-select form-select-sm">
                                        <option value="all">All</option>
                                        <option>Cybersecurity</option><option>Compliance</option><option>Operational</option>
                                        <option>Privacy</option><option>Third-Party</option><option>Financial</option><option>Reputational</option><option>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-1">
                                    <label class="form-label small">Sort</label>
                                    <div class="d-flex">
                                        <select id="risk-sort-field" class="form-select form-select-sm me-1">
                                            <option value="score">Score</option>
                                            <option value="title">Title</option>
                                            <option value="asset">Linked</option>
                                            <option value="impact">Impact</option>
                                            <option value="likelihood">Likelihood</option>
                                            <option value="status">Status</option>
                                        </select>
                                        <select id="risk-sort-dir" class="form-select form-select-sm">
                                            <option value="desc">Desc</option>
                                            <option value="asc">Asc</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Threshold settings -->
                            <div class="card bg-light p-2 mb-2">
                                <div class="d-flex flex-wrap align-items-center">
                                    <span class="small me-2"> Risk levels: High ≥ <input id="risk-thres-high" type="number" min="1" max="25" class="form-control form-control-sm d-inline-block" style="width:60px;" /> ; Medium ≥ <input id="risk-thres-med" type="number" min="1" max="25" class="form-control form-control-sm d-inline-block" style="width:60px;" /> ; Low below Medium. </span>
                                    <button id="risk-thres-reset" class="btn btn-sm btn-outline-secondary ms-auto">Reset</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:24%">Title</th><th style="width:16%">Linked</th><th style="width:14%">Category</th>
                                            <th style="width:14%">Inherent</th><th style="width:14%">Residual</th><th style="width:12%">Status</th><th style="width:6%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="risks-table-body"></tbody>
                                </table>
                            </div>
                            <div id="risks-empty" class="text-muted small mt-2">No risks yet. Add some based on assets.</div>
                            <ul class="pagination mt-3" id="risks-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Local Controls -->
            <div id="tab-controls" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Add your organization's controls. Map to frameworks and risks. Set status to track implementation. Tip: Use 'In place' for operating controls, 'Planned' for gaps.</span></span>: Build control library. Map to standards for compliance.</p>
                </div>
                <h3>Local Controls (Org Library)</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Control</h5>
                            <form id="control-form">
                                <input type="hidden" id="control-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Control name *</label>
                                    <input id="control-name" class="form-control form-control-sm" required placeholder="e.g. Enforce MFA for admins">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Type *</label>
                                    <select id="control-type" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>Preventive</option><option>Detective</option><option>Corrective</option>
                                        <option>Administrative</option><option>Technical</option><option>Physical</option>
                                        <option>Compensating</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Status *</label>
                                    <select id="control-status" class="form-select form-select-sm" required>
                                        <option>In place</option><option>Planned</option><option>Not applicable</option><option>Ineffective</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Owner</label>
                                    <input id="control-owner" class="form-control form-control-sm" placeholder="DevSecOps / IT Ops / Compliance">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Description</label>
                                    <textarea id="control-description" class="form-control form-control-sm" rows="2" placeholder="Implementation details, evidence..."></textarea>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Related risks</label>
                                    <select id="control-risks" class="form-select form-select-sm" multiple></select>
                                    <small class="text-muted">Hold Ctrl/Cmd to multi-select.</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Related framework controls</label>
                                    <select id="control-frameworks" class="form-select form-select-sm" multiple></select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Evidence</label>
                                    <input id="control-evidence" class="form-control form-control-sm" placeholder="Links to docs, screenshots...">
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit" id="control-form-submit">Save control</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="control-form-cancel">Clear</button>
                                </div>
                                <small class="text-muted d-block mt-2">Stored locally. Map to frameworks for gap analysis.</small>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Controls</h5>
                                <div>
                                    <button id="export-controls" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="controls-count" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:24%">Name</th><th style="width:14%">Type</th><th style="width:12%">Status</th>
                                            <th style="width:18%">Linked risks</th><th style="width:14%">Frameworks</th><th style="width:18%">Evidence</th><th style="width:10%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="controls-table-body"></tbody>
                                </table>
                            </div>
                            <div id="controls-empty" class="text-muted small mt-2">No controls yet. Add and map to frameworks.</div>
                            <ul class="pagination mt-3" id="controls-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Issues / Findings -->
            <div id="tab-issues" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Log findings from audits, tests, reviews. Link to objects. Set severity/status. Tip: Use for gap remediation tracking.</span></span>: Track audit findings and gaps.</p>
                </div>
                <h3>Issues &amp; Findings</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Issue</h5>
                            <form id="issue-form">
                                <input type="hidden" id="issue-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Title *</label>
                                    <input id="issue-title" class="form-control form-control-sm" required placeholder="e.g. Missing MFA for admins">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Type *</label>
                                    <select id="issue-type" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>Audit</option><option>Pen test</option><option>Vulnerability Scan</option><option>Self-Assessment</option><option>Risk review</option><option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Linked objects (optional)</label>
                                    <select id="issue-asset" class="form-select form-select-sm mb-1"><option value="">Linked asset...</option></select>
                                    <select id="issue-vendor" class="form-select form-select-sm mb-1"><option value="">Linked vendor...</option></select>
                                    <select id="issue-risk" class="form-select form-select-sm mb-1"><option value="">Linked risk...</option></select>
                                    <select id="issue-control" class="form-select form-select-sm"><option value="">Linked control...</option></select>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Severity *</label>
                                        <select id="issue-severity" class="form-select form-select-sm" required>
                                            <option value="">Select...</option>
                                            <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Status *</label>
                                        <select id="issue-status" class="form-select form-select-sm" required>
                                            <option>Open</option><option>In progress</option><option>Resolved</option><option>Accepted</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <label class="form-label small">Owner</label>
                                        <input id="issue-owner" class="form-control form-control-sm" placeholder="e.g. Dev Lead">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Due date</label>
                                        <input type="date" id="issue-due" class="form-control form-control-sm">
                                    </div>
                                </div>
                                <div class="form-group mb-3 mt-3">
                                    <label class="form-label small">Details / Recommendation</label>
                                    <textarea id="issue-notes" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit" id="issue-form-submit">Save issue</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="issue-form-cancel">Clear</button>
                                </div>
                                <small class="text-muted d-block mt-2">Stored locally in your browser.</small>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Issues / Findings</h5>
                                <div>
                                    <button id="export-issues" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="issues-count" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:22%">Title</th><th style="width:10%">Type</th><th style="width:12%">Severity</th>
                                            <th style="width:12%">Status</th><th style="width:20%">Linked to</th><th style="width:12%">Due</th><th style="width:12%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="issues-table-body"></tbody>
                                </table>
                            </div>
                            <div id="issues-empty" class="text-muted small mt-2">No issues yet.</div>
                            <ul class="pagination mt-3" id="issues-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Incidents -->
            <div id="tab-incidents" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Log security incidents. Classify severity, status. Link to risks/controls. Tip: Use for response practice and lessons learned.</span></span>: Track and respond to incidents.</p>
                </div>
                <h3>Incident Management</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Incident</h5>
                            <form id="incident-form">
                                <input type="hidden" id="incident-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Title *</label>
                                    <input id="incident-title" class="form-control form-control-sm" required placeholder="e.g. Data Breach Suspicion">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Type *</label>
                                    <select id="incident-type" class="form-select form-select-sm" required>
                                        <option value="">Select...</option>
                                        <option>Data Breach</option><option>Phishing</option><option>Malware</option><option>Insider Threat</option><option>Denial of Service</option><option>Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Detected Date *</label>
                                    <input type="date" id="incident-detected" class="form-control form-control-sm" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Linked objects (optional)</label>
                                    <select id="incident-asset" class="form-select form-select-sm mb-1"><option value="">Linked asset...</option></select>
                                    <select id="incident-vendor" class="form-select form-select-sm mb-1"><option value="">Linked vendor...</option></select>
                                    <select id="incident-risk" class="form-select form-select-sm mb-1"><option value="">Linked risk...</option></select>
                                    <select id="incident-control" class="form-select form-select-sm"><option value="">Linked control...</option></select>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Severity *</label>
                                        <select id="incident-severity" class="form-select form-select-sm" required>
                                            <option value="">Select...</option>
                                            <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Status *</label>
                                        <select id="incident-status" class="form-select form-select-sm" required>
                                            <option>Detected</option><option>Investigating</option><option>Contained</option><option>Recovered</option><option>Closed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group mb-3 mt-3">
                                    <label class="form-label small">Owner</label>
                                    <input id="incident-owner" class="form-control form-control-sm" placeholder="e.g. Incident Response Team">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Details / Response</label>
                                    <textarea id="incident-notes" class="form-control form-control-sm" rows="3" placeholder="What happened, root cause, lessons learned..."></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit">Save incident</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="incident-form-cancel">Clear</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Incidents</h5>
                                <div>
                                    <button id="export-incidents" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="incidents-count" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:22%">Title</th><th style="width:10%">Type</th><th style="width:12%">Severity</th>
                                            <th style="width:12%">Status</th><th style="width:16%">Detected</th><th style="width:20%">Linked to</th><th style="width:8%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="incidents-table-body"></tbody>
                                </table>
                            </div>
                            <div id="incidents-empty" class="text-muted small mt-2">No incidents yet. Log when they occur for practice.</div>
                            <ul class="pagination mt-3" id="incidents-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Treatments -->
            <div id="tab-treatments" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Add mitigation actions for risks/issues. Link to controls. Track status/target. Tip: Use for risk treatment plans.</span></span>: Plan and track remediations.</p>
                </div>
                <h3>Treatments (Mitigation Plan)</h3>
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4">
                        <div class="card p-3">
                            <h5 class="mb-3">Add / Edit Treatment</h5>
                            <form id="treat-form">
                                <input type="hidden" id="treat-id">
                                <div class="form-group mb-3">
                                    <label class="form-label small">Action title *</label>
                                    <input id="treat-title" class="form-control form-control-sm" required placeholder="e.g. Enforce SSO & MFA for admins">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Linked risk/issue *</label>
                                    <select id="treat-linked" class="form-select form-select-sm" required><option value="">Select...</option></select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label small">Linked control (optional)</label>
                                    <select id="treat-control" class="form-select form-select-sm"><option value="">Select control...</option></select>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Status *</label>
                                        <select id="treat-status" class="form-select form-select-sm" required>
                                            <option>Open</option><option>In progress</option><option>Closed</option><option>Deferred</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Target date</label>
                                        <input type="date" id="treat-date" class="form-control form-control-sm">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <label class="form-label small">Owner</label>
                                        <input id="treat-owner" class="form-control form-control-sm" placeholder="e.g. DevOps Lead">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Budget (optional)</label>
                                        <input id="treat-budget" class="form-control form-control-sm" placeholder="e.g. 2,500 USD">
                                    </div>
                                </div>
                                <div class="form-group mb-3 mt-3">
                                    <label class="form-label small">Notes</label>
                                    <textarea id="treat-notes" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" type="submit" id="treat-submit">Save action</button>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="treat-cancel">Clear</button>
                                </div>
                                <small class="text-muted d-block mt-2">Stored locally. Link to risks/issues for tracking.</small>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7 mb-4">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Treatment actions</h5>
                                <div>
                                    <button id="export-treatments" class="btn btn-sm btn-outline-secondary me-2">Export CSV</button>
                                    <small id="treat-count" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:26%">Title</th><th style="width:20%">Linked</th>
                                            <th style="width:12%">Status</th><th style="width:14%">Target</th>
                                            <th style="width:10%">Owner</th><th style="width:10%">Budget</th><th style="width:8%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="treat-table-body"></tbody>
                                </table>
                            </div>
                            <div id="treat-empty" class="text-muted small mt-2">No treatment actions yet.</div>
                            <ul class="pagination mt-3" id="treatments-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Gap Analysis -->
            <div id="tab-gap" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">View coverage by category. Heatmap shows maturity. Tip: Aim for 80%+ implemented in core areas.</span></span>: Analyze control gaps against frameworks.</p>
                </div>
                <h3>Gap Analysis & Heatmap</h3>
                <p class="mb-3">Coverage based on local controls mapped to frameworks. “In place” = implemented; “Planned” = planned-only.</p>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width:24%">Category</th>
                                <th style="width:12%">Total controls</th>
                                <th style="width:16%">Implemented</th>
                                <th style="width:16%">Planned only</th>
                                <th style="width:16%">Not implemented</th>
                                <th style="width:16%">Heatmap</th>
                            </tr>
                        </thead>
                        <tbody id="gap-table-body"></tbody>
                    </table>
                    <div class="mt-2 text-end"><small id="gap-overall-coverage" class="text-muted"></small></div>
                </div>
            </div>
            <!-- SoA -->
            <div id="tab-soa" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Set applicability and implementation for each control. Use bulk edit for efficiency. Add rationale/evidence for audits. Tip: 'Auto' uses local controls mapping.</span></span>: Document Statement of Applicability for ISO-like compliance.</p>
                </div>
                <h3>Statement of Applicability (SoA)</h3>
                <p class="mb-3 small text-muted"> Applicability & implementation against the unified framework library. Edit rationale/evidence inline; data persists locally. </p>
                <div class="card bg-light p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-muted">
                            <span id="soa-count"></span>
                        </div>
                        <div>
                            <button id="soa-export" class="btn btn-sm btn-outline-secondary">Export SoA CSV</button>
                        </div>
                    </div>
                </div>
                <!-- Filters for SoA -->
                <div class="row mb-3">
                    <div class="col-md-3 mb-2">
                        <label class="form-label small">Filter by Framework</label>
                        <select id="soa-framework-filter" class="form-select form-select-sm">
                            <option value="all">All frameworks</option>
                            <option value="ISO 27001">ISO 27001</option>
                            <option value="NIST CSF">NIST CSF</option>
                            <option value="PCI DSS">PCI DSS</option>
                            <option value="HIPAA">HIPAA</option>
                            <option value="SOC2">SOC 2</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label small">Filter by Category</label>
                        <select id="soa-category-filter" class="form-select form-select-sm">
                            <option value="all">All categories</option>
                            <option>Access Control</option>
                            <option>Identity & Authentication</option>
                            <option>Logging & Monitoring</option>
                            <option>Encryption & Key Management</option>
                            <option>Backup & Recovery</option>
                            <option>Change Management</option>
                            <option>Vulnerability Management</option>
                            <option>Incident Response</option>
                            <option>Vendor Risk</option>
                            <option>Policy & Governance</option>
                            <option>Awareness & Training</option>
                            <option>Physical Security</option>
                            <option>Network Security</option>
                            <option>Asset Management</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label small">Filter by Applicability</label>
                        <select id="soa-applicability-filter" class="form-select form-select-sm">
                            <option value="all">All</option>
                            <option>Applicable</option>
                            <option>Not Applicable</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label small">Filter by Implementation</label>
                        <select id="soa-implementation-filter" class="form-select form-select-sm">
                            <option value="all">All</option>
                            <option>In place</option>
                            <option>Planned</option>
                            <option>Not implemented</option>
                            <option>Not applicable</option>
                        </select>
                    </div>
                </div>
                <!-- Bulk edit bar -->
                <div class="bulk-edit-bar card bg-light p-2 mb-2" id="soa-bulk-bar" style="display:none;">
                    <label class="small mb-1">Bulk Edit Selected:</label>
                    <select id="bulk-applicability" class="form-select form-select-sm d-inline-block me-2" style="width:auto;">
                        <option value="">Set Applicability...</option>
                        <option>Applicable</option>
                        <option>Not Applicable</option>
                    </select>
                    <select id="bulk-implementation" class="form-select form-select-sm d-inline-block me-2" style="width:auto;">
                        <option value="">Set Implementation...</option>
                        <option>In place</option>
                        <option>Planned</option>
                        <option>Not implemented</option>
                        <option>Not applicable</option>
                    </select>
                    <button id="bulk-apply" class="btn btn-sm btn-primary">Apply</button>
                    <button id="bulk-clear" class="btn btn-sm btn-outline-secondary ms-2">Clear Selection</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width:5%"><input type="checkbox" id="soa-select-all" class="form-check-input"></th>
                                <th style="width:10%">ID</th>
                                <th style="width:18%">Name</th>
                                <th style="width:14%">Category</th>
                                <th style="width:14%">Frameworks</th>
                                <th style="width:12%">Applicability</th>
                                <th style="width:12%">Implementation</th>
                                <th style="width:10%">Owner</th>
                                <th style="width:20%">Rationale / Evidence</th>
                            </tr>
                        </thead>
                        <tbody id="soa-table-body"></tbody>
                    </table>
                </div>
            </div>
            <!-- Dashboard -->
            <div id="tab-dashboard" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Monitor key metrics. Use to track progress. Tip: Aim for low high risks, high coverage, no overdue.</span></span>: Overview of your GRC posture.</p>
                </div>
                <h3>Dashboard</h3>
                <div class="row">
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Assets</div><div class="value" id="dash-assets">0</div><div class="sub">Tracked</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Vendors</div><div class="value" id="dash-vendors">0</div><div class="sub">Managed</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Risks</div><div class="value" id="dash-risks">0</div><div class="sub"><span id="dash-high">0</span> high</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Controls</div><div class="value" id="dash-controls">0</div><div class="sub">Implemented</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Issues</div><div class="value" id="dash-issues">0</div><div class="sub"><span id="dash-overdue">0</span> overdue</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Incidents</div><div class="value" id="dash-incidents">0</div><div class="sub">Open</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Treatments</div><div class="value" id="dash-treatments">0</div><div class="sub">In progress</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-3 mb-3">
                        <div class="dashboard-card">
                            <div class="label">Compliance Coverage</div><div class="value" id="dash-coverage">0%</div><div class="sub">Implemented</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="dashboard-card d-flex flex-column justify-content-between">
                            <div>
                                <div class="label">Framework coverage</div>
                                <div class="value"><span id="dash-coverage">0%</span></div>
                                <div class="sub">Implemented local controls mapped to frameworks.</div>
                            </div>
                            <div class="mt-2"><span id="dash-coverage-pill" class="heat-pill heat-none">Coverage heat</span></div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="dashboard-card">
                            <div class="label mb-1">Templates</div>
                            <p class="sub">Load pre-built setups for standards.</p>
                            <div class="d-flex flex-wrap">
                                <button id="load-iso-template" class="btn btn-sm btn-outline-primary me-2 mb-2">Load ISO 27001</button>
                                <button id="load-nist-template" class="btn btn-sm btn-outline-primary me-2 mb-2">Load NIST CSF</button>
                                <button id="load-pci-template" class="btn btn-sm btn-outline-primary me-2 mb-2">Load PCI DSS</button>
                                <button id="load-hipaa-template" class="btn btn-sm btn-outline-primary mb-2">Load HIPAA</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="dashboard-card">
                            <div class="label mb-1">Scenarios & exports</div>
                            <p class="sub">Manage data and load examples.</p>
                            <div class="d-flex flex-wrap">
                                <button id="btn-export" class="btn btn-sm btn-primary me-2 mb-2">Export JSON</button>
                                <button id="btn-import" class="btn btn-sm btn-outline-primary me-2 mb-2">Import JSON</button>
                                <button id="btn-load-demo" class="btn btn-sm btn-outline-primary me-2 mb-2">Load Demo</button>
                                <button id="btn-reset" class="btn btn-sm btn-outline-danger mb-2">Reset All</button>
                                <input type="file" id="file-import" accept="application/json" style="display:none">
                            </div>
                            <small id="import-status" class="text-muted d-block mt-2"></small>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Risk Matrix -->
            <div id="tab-matrix" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Visualize risks. Toggle inherent vs residual. Export PNG for reports. Tip: Residual shows control effectiveness.</span></span>: Risk visualization tool.</p>
                </div>
                <h3>Risk Matrix (Inherent vs Residual)</h3>
                <p class="mb-3">Toggle to compare inherent (pre-controls) and residual (post-controls) risks.</p>
                <div class="risk-matrix-container">
                    <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
                        <div class="btn-group btn-group-toggle" data-bs-toggle="buttons">
                            <label class="btn btn-sm btn-primary active" id="toggle-inherent"><input type="radio" name="mx" checked> Inherent</label>
                            <label class="btn btn-sm btn-outline-primary" id="toggle-residual"><input type="radio" name="mx"> Residual</label>
                        </div>
                        <button id="matrix-export" class="btn btn-outline-primary btn-sm">Export PNG</button>
                    </div>
                    <canvas id="risk-matrix-canvas" width="920" height="640"></canvas>
                    <div id="matrix-legend" class="mt-3 text-center text-muted small"></div>
                </div>
            </div>
            <!-- Auditor Summary -->
            <div id="tab-summary" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Auto-generated narrative. Refresh after changes. Copy/export for docs. Tip: Customize in reports tab.</span></span>: Executive summary generator.</p>
                </div>
                <h3>Auditor-style Summary</h3>
                <p class="mb-3">Generated narrative for reports/decks.</p>
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">Based on current data.</span>
                        <div>
                            <button id="summary-refresh" class="btn btn-sm btn-primary me-2">Refresh</button>
                            <button id="summary-copy" class="btn btn-sm btn-outline-secondary me-2">Copy</button>
                            <button id="summary-export-md" class="btn btn-sm btn-outline-secondary me-2">Export MD</button>
                            <button id="summary-export-pdf" class="btn btn-sm btn-outline-secondary">Export PDF</button>
                        </div>
                    </div>
                    <textarea id="summary-text" class="form-control" rows="20"></textarea>
                    <div class="small text-muted mt-2">Tip: Use in audit reports or ISO SoA.</div>
                </div>
            </div>
            <!-- Reports -->
            <div id="tab-reports" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Select type, generate. Export MD/PDF. Tip: Customize text before export.</span></span>: Create customizable reports.</p>
                </div>
                <h3>Reports</h3>
                <p class="mb-3">Generate teaching-oriented reports.</p>
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">Select type.</span>
                        <select id="report-type" class="form-select form-select-sm me-2" style="width:200px;">
                            <option value="full-audit">Full Audit</option>
                            <option value="risk-register">Risk Register</option>
                            <option value="control-coverage">Control Coverage</option>
                            <option value="issue-summary">Issue Summary</option>
                            <option value="vendor-report">Vendor Risk</option>
                            <option value="incident-report">Incident Log</option>
                        </select>
                        <button id="generate-report" class="btn btn-sm btn-primary me-2">Generate</button>
                        <button id="report-export-md" class="btn btn-sm btn-outline-secondary me-2">Export MD</button>
                        <button id="report-export-pdf" class="btn btn-sm btn-outline-secondary">Export PDF</button>
                    </div>
                    <textarea id="report-text" class="form-control" rows="20"></textarea>
                    <div class="small text-muted mt-2">Edit text if needed before export.</div>
                </div>
            </div>
            <!-- Challenge Mode -->
            <div id="tab-challenges" class="grc-tab">
                <div class="guidance">
                    <p><span class="tooltip">How to use<span class="tooltiptext">Select challenge, complete tasks in lab, check score. Tip: Use to practice real scenarios, aim for high scores.</span></span>: Gamified learning mode.</p>
                </div>
                <h3>Challenge Mode</h3>
                <p class="mb-3">Test your GRC skills with scored challenges. Complete tasks, then self-score.</p>
                <div class="challenge-card">
                    <h4>Challenge 1: Basic Risk Assessment (Beginner)</h4>
                    <p>Scenario: You're a new analyst at a small e-commerce company. Identify 5 risks for their web app and database.</p>
                    <ul>
                        <li>Add 2 assets</li>
                        <li>Add 5 risks, score them</li>
                        <li>Add 3 controls to mitigate</li>
                        <li>Achieve 60% coverage in gap analysis</li>
                    </ul>
                    <p>Score: Check dashboard - 1 point per task, bonus for high risks mitigated. Your score: <span class="challenge-score" id="challenge-1-score">0/5</span></p>
                    <button class="btn btn-sm btn-primary" onclick="scoreChallenge(1)">Calculate Score</button>
                </div>
                <div class="challenge-card">
                    <h4>Challenge 2: Compliance Mapping (Intermediate)</h4>
                    <p>Scenario: Prepare for ISO 27001 certification. Map controls to Annex A.</p>
                    <ul>
                        <li>Load ISO template</li>
                        <li>Add 10 local controls</li>
                        <li>Map to at least 20 framework controls</li>
                        <li>Complete SoA with rationale</li>
                        <li>Achieve 75% coverage</li>
                    </ul>
                    <p>Score: <span class="challenge-score" id="challenge-2-score">0/5</span></p>
                    <button class="btn btn-sm btn-primary" onclick="scoreChallenge(2)">Calculate Score</button>
                </div>
                <div class="challenge-card">
                    <h4>Challenge 3: Incident Response (Advanced)</h4>
                    <p>Scenario: Simulate a data breach. Log incident, link to risks, add treatments.</p>
                    <ul>
                        <li>Add incident with critical severity</li>
                        <li>Link to asset/risk/control</li>
                        <li>Add 3 treatments with targets</li>
                        <li>Update risk residual</li>
                        <li>Generate incident report</li>
                    </ul>
                    <p>Score: <span class="challenge-score" id="challenge-3-score">0/5</span></p>
                    <button class="btn btn-sm btn-primary" onclick="scoreChallenge(3)">Calculate Score</button>
                </div>
                <div class="challenge-card">
                    <h4>Challenge 4: Vendor Risk Management (Intermediate)</h4>
                    <p>Scenario: Assess third-party risks for a supply chain.</p>
                    <ul>
                        <li>Add 5 vendors</li>
                        <li>Assess criticality and data access</li>
                        <li>Add risks linked to vendors</li>
                        <li>Implement vendor-specific controls</li>
                        <li>Achieve low residual risk for high vendors</li>
                    </ul>
                    <p>Score: <span class="challenge-score" id="challenge-4-score">0/5</span></p>
                    <button class="btn btn-sm btn-primary" onclick="scoreChallenge(4)">Calculate Score</button>
                </div>
                <div class="challenge-card">
                    <h4>Challenge 5: Compliance Audit Simulation (Advanced)</h4>
                    <p>Scenario: Prepare for a SOC 2 audit.</p>
                    <ul>
                        <li>Load SOC2 template</li>
                        <li>Map controls and evidence</li>
                        <li>Identify gaps and add treatments</li>
                        <li>Generate full audit report</li>
                        <li>Achieve 90% coverage</li>
                    </ul>
                    <p>Score: <span class="challenge-score" id="challenge-5-score">0/5</span></p>
                    <button class="btn btn-sm btn-primary" onclick="scoreChallenge(5)">Calculate Score</button>
                </div>
            </div>
        </div>
    </section>
    <footer class="bg-light py-3">
        <div class="container text-center">
            <p>Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | GRC Practice Lab by John B Joseph | Empowering Future GRC Leaders</p>
        </div>
    </footer>
    <!-- Toast container -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body"></div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- GRC Lab App -->
    <script>
        // ---------- Expanded Framework library (over 200 controls) ----------
        const FRAMEWORK_CONTROLS = [
            // ISO 27001 Annex A
            {id:"CTRL-5.1",name:"Policies for information security",category:"Organisational Controls", description:"Information security policy and topic-specific policies shall be defined, approved by management, published, communicated to and acknowledged by relevant personnel and relevant interested parties, and reviewed at planned intervals and if significant changes occur.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.1"]},
            {id:"CTRL-5.2",name:"Information security roles and responsibilities",category:"Organisational Controls", description:"Information security roles and responsibilities shall be defined and allocated according to the organization needs.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.2"]},
            {id:"CTRL-5.3",name:"Segregation of duties",category:"Organisational Controls", description:"Conflicting duties and conflicting areas of responsibility shall be segregated.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.3"]},
            {id:"CTRL-5.4",name:"Management responsibilities",category:"Organisational Controls", description:"Management shall require all personnel to apply information security in accordance with the established information security policy, topic-specific policies and procedures of the organization.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.4"]},
            {id:"CTRL-5.5",name:"Contact with authorities",category:"Organisational Controls", description:"The organization shall establish and maintain contact with relevant authorities.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.5"]},
            {id:"CTRL-5.6",name:"Contact with special interest groups",category:"Organisational Controls", description:"The organization shall establish and maintain contact with special interest groups or other specialist security forums and professional associations.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.6"]},
            {id:"CTRL-5.7",name:"Threat intelligence",category:"Organisational Controls", description:"Information relating to information security threats shall be collected and analysed to produce threat intelligence.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.7"]},
            {id:"CTRL-5.8",name:"Information security in project management",category:"Organisational Controls", description:"Information security shall be integrated into project management.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.8"]},
            {id:"CTRL-5.9",name:"Inventory of information and other associated assets",category:"Organisational Controls", description:"An inventory of information and other associated assets, including owners, shall be developed and maintained.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.9"]},
            {id:"CTRL-5.10",name:"Acceptable use of information and other associated assets",category:"Organisational Controls", description:"Rules for the acceptable use and procedures for handling information and other associated assets shall be identified, documented and implemented.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.10"]},
            {id:"CTRL-5.11",name:"Return of assets",category:"Organisational Controls", description:"Personnel and other interested parties as appropriate shall return all the organization's assets in their possession upon change or termination of their employment, contract or agreement.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.11"]},
            {id:"CTRL-5.12",name:"Classification of information",category:"Organisational Controls", description:"Information shall be classified according to the information security needs of the organization based on confidentiality, integrity, availability and relevant interested party requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.12"]},
            {id:"CTRL-5.13",name:"Labelling of information",category:"Organisational Controls", description:"An appropriate set of procedures for information labelling shall be developed and implemented in accordance with the information classification scheme adopted by the organization.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.13"]},
            {id:"CTRL-5.14",name:"Information transfer",category:"Organisational Controls", description:"Information transfer rules, procedures, or agreements shall be in place for all types of transfer facilities within the organization and between the organization and other parties.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.14"]},
            {id:"CTRL-5.15",name:"Access control",category:"Organisational Controls", description:"Rules to control physical and logical access to information and other associated assets shall be established and implemented based on business and information security requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.15"]},
            {id:"CTRL-5.16",name:"Identity management",category:"Organisational Controls", description:"The full life cycle of identities shall be managed.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.16"]},
            {id:"CTRL-5.17",name:"Authentication information",category:"Organisational Controls", description:"Allocation and management of authentication information shall be controlled by a management process, including advising personnel on appropriate handling of authentication information.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.17"]},
            {id:"CTRL-5.18",name:"Access rights",category:"Organisational Controls", description:"Access rights to information and other associated assets shall be provisioned, reviewed, modified and removed in accordance with the organization's topic-specific policy on and rules for access control.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.18"]},
            {id:"CTRL-5.19",name:"Information security in supplier relationships",category:"Organisational Controls", description:"Processes and procedures shall be defined and implemented to manage the information security risks associated with the use of supplier's products or services.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.19"]},
            {id:"CTRL-5.20",name:"Addressing information security within supplier agreements",category:"Organisational Controls", description:"Relevant information security requirements shall be established and agreed with each supplier based on the type of supplier relationship.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.20"]},
            {id:"CTRL-5.21",name:"Managing information security in the ICT supply chain",category:"Organisational Controls", description:"Processes and procedures shall be defined and implemented to manage the information security risks associated with the ICT products and services supply chain.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.21"]},
            {id:"CTRL-5.22",name:"Monitoring, review and change management of supplier services",category:"Organisational Controls", description:"The organization shall regularly monitor, review, evaluate and manage change in supplier information security practices.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.22"]},
            {id:"CTRL-5.23",name:"Information security for use of cloud services",category:"Organisational Controls", description:"Processes for acquisition, use, management and exit from cloud services shall be established in accordance with the organization's information security requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.23"]},
            {id:"CTRL-5.24",name:"Information security incident management planning and preparation",category:"Organisational Controls", description:"The organization shall plan and prepare for managing information security incidents by defining, establishing and communicating information security incident management processes, roles and responsibilities.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.24"]},
            {id:"CTRL-5.25",name:"Assessment and decision on information security events",category:"Organisational Controls", description:"The organization shall assess information security events and decide if they are to be categorised as information security incidents.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.25"]},
            {id:"CTRL-5.26",name:"Response to information security incidents",category:"Organisational Controls", description:"Information security incidents shall be responded to in accordance with the documented procedures.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.26"]},
            {id:"CTRL-5.27",name:"Learning from information security incidents",category:"Organisational Controls", description:"Knowledge gained from information security incidents shall be used to strengthen and improve the information security controls.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.27"]},
            {id:"CTRL-5.28",name:"Collection of evidence",category:"Organisational Controls", description:"The organization shall establish and implement procedures for the identification, collection, acquisition and preservation of evidence related to information security events.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.28"]},
            {id:"CTRL-5.29",name:"Information security during disruption",category:"Organisational Controls", description:"The organization shall plan how to maintain information security at an appropriate level during disruption.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.29"]},
            {id:"CTRL-5.30",name:"ICT readiness for business continuity",category:"Organisational Controls", description:"ICT readiness shall be planned, implemented, maintained and tested based on business continuity objectives and continuity requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.30"]},
            {id:"CTRL-5.31",name:"Legal, statutory, regulatory and contractual requirements",category:"Organisational Controls", description:"Legal, statutory, regulatory and contractual requirements relevant to information security and the organization's approach to meet these requirements shall be identified, documented and kept up to date.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.31"]},
            {id:"CTRL-5.32",name:"Intellectual property rights",category:"Organisational Controls", description:"The organization shall implement appropriate procedures to protect intellectual property rights.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.32"]},
            {id:"CTRL-5.33",name:"Protection of records",category:"Organisational Controls", description:"Records shall be protected from loss, destruction, falsification, unauthorized access and unauthorized release.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.33"]},
            {id:"CTRL-5.34",name:"Privacy and protection of PII",category:"Organisational Controls", description:"The organization shall identify and meet the requirements regarding the preservation of privacy and protection of PII according to applicable laws and regulations and contractual requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.34"]},
            {id:"CTRL-5.35",name:"Independent review of information security",category:"Organisational Controls", description:"The organization's approach to managing information security and its implementation shall be reviewed independently at planned intervals, or when significant changes occur.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.35"]},
            {id:"CTRL-5.36",name:"Compliance with security policies and standards",category:"Organisational Controls", description:"Managers shall regularly review the compliance of information processing and procedures within their area of responsibility with the appropriate security policies, standards and any other security requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.36"]},
            {id:"CTRL-5.37",name:"Documented operating procedures",category:"Organisational Controls", description:"Operating procedures for information processing facilities shall be documented and made available to personnel who need them.", frameworks:["ISO 27001"],references:["ISO 27001 A.5.37"]},
            // A.6 People Controls (8)
            {id:"CTRL-6.1",name:"Screening",category:"People Controls", description:"Background verification checks on all candidates to become personnel shall be carried out prior to joining the organization and on an ongoing basis taking into consideration applicable laws, regulations and ethics and be proportional to the business requirements, the classification of the information to be accessed and the perceived risks.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.1"]},
            {id:"CTRL-6.2",name:"Terms and conditions of employment",category:"People Controls", description:"Personnel shall agree to terms and conditions of employment, which includes the organization's information security policy and appropriate topic-specific policies.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.2"]},
            {id:"CTRL-6.3",name:"Information security awareness, education and training",category:"People Controls", description:"Personnel of the organization and relevant interested parties shall receive appropriate information security awareness, education and training and regular updates of the organization's information security policy and topic-specific policies, as relevant for their job function.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.3"]},
            {id:"CTRL-6.4",name:"Disciplinary process",category:"People Controls", description:"A disciplinary process shall be formalized and communicated to take actions against personnel and other relevant interested parties who have committed an information security policy violation.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.4"]},
            {id:"CTRL-6.5",name:"Responsibilities after termination or change of employment",category:"People Controls", description:"Information security responsibilities and duties that remain valid after termination or change of employment shall be defined, enforced and communicated to relevant personnel and other interested parties.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.5"]},
            {id:"CTRL-6.6",name:"Confidentiality or non-disclosure agreements",category:"People Controls", description:"Confidentiality or non-disclosure agreements reflecting the organization's needs for the protection of information shall be identified, documented, regularly reviewed and signed by personnel and other relevant interested parties.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.6"]},
            {id:"CTRL-6.7",name:"Remote working",category:"People Controls", description:"Security measures shall be implemented when personnel are working remotely to protect information accessed, processed or stored outside the organization's premises.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.7"]},
            {id:"CTRL-6.8",name:"Information security event reporting",category:"People Controls", description:"The organization shall provide a mechanism for personnel to report observed or suspected information security events through appropriate channels in a timely manner.", frameworks:["ISO 27001"],references:["ISO 27001 A.6.8"]},
            // A.7 Physical Controls (14)
            {id:"CTRL-7.1",name:"Physical security perimeters",category:"Physical Controls", description:"Security perimeters shall be defined and used to protect areas that contain information and other associated assets.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.1"]},
            {id:"CTRL-7.2",name:"Physical entry",category:"Physical Controls", description:"Secure areas shall be protected by appropriate entry controls and access points.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.2"]},
            {id:"CTRL-7.3",name:"Securing offices, rooms and facilities",category:"Physical Controls", description:"Physical security for offices, rooms and facilities shall be designed and implemented.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.3"]},
            {id:"CTRL-7.4",name:"Physical security monitoring",category:"Physical Controls", description:"Premises shall be continuously monitored for unauthorized physical access.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.4"]},
            {id:"CTRL-7.5",name:"Protecting against physical and environmental threats",category:"Physical Controls", description:"Protection against physical and environmental threats, such as natural disasters and other intentional or accidental physical threats to infrastructure, shall be designed and implemented.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.5"]},
            {id:"CTRL-7.6",name:"Working in secure areas",category:"Physical Controls", description:"Security measures for working in secure areas shall be designed and implemented.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.6"]},
            {id:"CTRL-7.7",name:"Clear desk and clear screen",category:"Physical Controls", description:"Clear desk rules for papers and removable storage media and clear screen rules for information processing facilities shall be defined and appropriately enforced.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.7"]},
            {id:"CTRL-7.8",name:"Equipment siting and protection",category:"Physical Controls", description:"Equipment shall be sited securely and protected against environmental threats.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.8"]},
            {id:"CTRL-7.9",name:"Security of assets off-premises",category:"Physical Controls", description:"Off-premise assets shall be protected.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.9"]},
            {id:"CTRL-7.10",name:"Storage media",category:"Physical Controls", description:"Storage media shall be managed in accordance with the organization's classification scheme and media handling procedures.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.10"]},
            {id:"CTRL-7.11",name:"Supporting utilities",category:"Physical Controls", description:"Information processing facilities shall be protected from power failures and other disruptions caused by failures in supporting utilities.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.11"]},
            {id:"CTRL-7.12",name:"Cabling security",category:"Physical Controls", description:"Cables carrying power, data or supporting information services shall be protected from interception, interference or damage.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.12"]},
            {id:"CTRL-7.13",name:"Equipment maintenance",category:"Physical Controls", description:"Equipment shall be maintained to ensure continued availability and integrity.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.13"]},
            {id:"CTRL-7.14",name:"Secure disposal or re-use of equipment",category:"Physical Controls", description:"Items of equipment containing storage media shall be verified to ensure that any sensitive data and licensed software has been removed or securely overwritten prior to disposal or re-use.", frameworks:["ISO 27001"],references:["ISO 27001 A.7.14"]},
            // A.8 Technological Controls (34)
            {id:"CTRL-8.1",name:"User endpoint devices",category:"Technological Controls", description:"Information stored on, processed by or accessible via user endpoint devices shall be protected.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.1"]},
            {id:"CTRL-8.2",name:"Privileged access rights",category:"Technological Controls", description:"The allocation and use of privileged access rights shall be restricted and managed.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.2"]},
            {id:"CTRL-8.3",name:"Information access restriction",category:"Technological Controls", description:"Access to information and other associated assets shall be restricted in accordance with the established topic-specific policy on access control.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.3"]},
            {id:"CTRL-8.4",name:"Access to source code",category:"Technological Controls", description:"Read and write access to source code, development tools and software libraries shall be appropriately managed.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.4"]},
            {id:"CTRL-8.5",name:"Secure authentication",category:"Technological Controls", description:"Secure authentication technologies and procedures shall be implemented based on information access restrictions and the topic-specific policy on access control.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.5"]},
            {id:"CTRL-8.6",name:"Capacity management",category:"Technological Controls", description:"The use of resources shall be monitored and adjusted in accordance with current and expected capacity requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.6"]},
            {id:"CTRL-8.7",name:"Protection against malware",category:"Technological Controls", description:"Protection against malware shall be implemented and supported by appropriate user awareness.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.7"]},
            {id:"CTRL-8.8",name:"Management of technical vulnerabilities",category:"Technological Controls", description:"Information about technical vulnerabilities of information systems in use shall be obtained, the organization's exposure to such vulnerabilities shall be evaluated and appropriate measures shall be taken.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.8"]},
            {id:"CTRL-8.9",name:"Configuration management",category:"Technological Controls", description:"Configurations, including security configurations, of hardware, software, services and networks shall be established, documented, implemented, monitored and reviewed.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.9"]},
            {id:"CTRL-8.10",name:"Information deletion",category:"Technological Controls", description:"Information stored in information systems, devices or in any other storage media shall be deleted when no longer required.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.10"]},
            {id:"CTRL-8.11",name:"Data masking",category:"Technological Controls", description:"Data masking shall be used in accordance with the organization's topic-specific policy on access control and other related topic-specific policies, and business requirements, taking applicable legislation into consideration.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.11"]},
            {id:"CTRL-8.12",name:"Data leakage prevention",category:"Technological Controls", description:"Data leakage prevention measures shall be applied to systems, networks and any other devices that process, store or transmit sensitive information.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.12"]},
            {id:"CTRL-8.13",name:"Information backup",category:"Technological Controls", description:"Backup facilities and a defined and documented backup procedure shall be provided to maintain availability and integrity of information.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.13"]},
            {id:"CTRL-8.14",name:"Redundancy of information processing facilities",category:"Technological Controls", description:"Information processing facilities shall be implemented with redundancy sufficient to meet availability requirements.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.14"]},
            {id:"CTRL-8.15",name:"Logging",category:"Technological Controls", description:"Logs that record activities, exceptions, faults and other relevant events shall be produced, stored, protected and analysed.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.15"]},
            {id:"CTRL-8.16",name:"Monitoring activities",category:"Technological Controls", description:"Networks, systems and applications shall be monitored for anomalous behaviour and appropriate actions taken to evaluate potential information security incidents.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.16"]},
            {id:"CTRL-8.17",name:"Clock synchronization",category:"Technological Controls", description:"The clocks of information processing systems used by the organization shall be synchronized to approved time sources.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.17"]},
            {id:"CTRL-8.18",name:"Use of privileged utility programs",category:"Technological Controls", description:"The use of utility programs that can be capable of overriding system and application controls shall be restricted and tightly controlled.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.18"]},
            {id:"CTRL-8.19",name:"Installation of software on operational systems",category:"Technological Controls", description:"Procedures and measures shall be implemented to securely manage software installation on operational systems.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.19"]},
            {id:"CTRL-8.20",name:"Networks security",category:"Technological Controls", description:"Networks and network devices shall be secured, managed and controlled to protect information in systems and applications.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.20"]},
            {id:"CTRL-8.21",name:"Security of network services",category:"Technological Controls", description:"Security mechanisms, service levels and service requirements of network services shall be identified, implemented and monitored.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.21"]},
            {id:"CTRL-8.22",name:"Segregation of networks",category:"Technological Controls", description:"Groups of information services, users and information systems shall be segregated in the organization's networks.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.22"]},
            {id:"CTRL-8.23",name:"Web filtering",category:"Technological Controls", description:"Access to external websites shall be managed to reduce exposure to malicious content.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.23"]},
            {id:"CTRL-8.24",name:"Use of cryptography",category:"Technological Controls", description:"Rules for the effective use of cryptography, including cryptographic key management, shall be defined and implemented.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.24"]},
            {id:"CTRL-8.25",name:"Secure development life cycle",category:"Technological Controls", description:"Rules for the secure development of software and systems shall be established and applied.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.25"]},
            {id:"CTRL-8.26",name:"Application security requirements",category:"Technological Controls", description:"Information security requirements shall be identified, specified and approved when developing or acquiring applications.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.26"]},
            {id:"CTRL-8.27",name:"Secure system architecture and engineering principles",category:"Technological Controls", description:"Principles for engineering secure systems shall be established, documented, maintained and applied to any information system development activities.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.27"]},
            {id:"CTRL-8.28",name:"Secure coding",category:"Technological Controls", description:"Secure coding principles shall be applied to software development.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.28"]},
            {id:"CTRL-8.29",name:"Security testing in development and acceptance",category:"Technological Controls", description:"Security testing processes shall be defined and implemented in the development life cycle.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.29"]},
            {id:"CTRL-8.30",name:"Outsourced development",category:"Technological Controls", description:"The organization shall direct, monitor and review the activities related to outsourced system development.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.30"]},
            {id:"CTRL-8.31",name:"Separation of development, test and production environments",category:"Technological Controls", description:"Development, testing and production environments shall be separated and secured.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.31"]},
            {id:"CTRL-8.32",name:"Change management",category:"Technological Controls", description:"Changes to information processing facilities and information systems shall be subject to change management procedures.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.32"]},
            {id:"CTRL-8.33",name:"Test information",category:"Technological Controls", description:"Test information shall be appropriately selected, protected and managed.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.33"]},
            {id:"CTRL-8.34",name:"Protection of information systems during audit testing",category:"Technological Controls", description:"Audit tests and other assurance activities involving assessment of operational systems shall be planned and agreed between the tester and appropriate management.", frameworks:["ISO 27001"],references:["ISO 27001 A.8.34"]},
            // Add more from NIST CSF subcategories
            {id:"CTRL-ID.AM-01",name:"Physical devices and systems inventory",category:"Asset Management", description:"Inventories of physical devices and systems within the organization are maintained.", frameworks:["NIST CSF"],references:["NIST ID.AM-01"]},
            {id:"CTRL-ID.AM-02",name:"Software platforms and applications inventory",category:"Asset Management", description:"Inventories of software platforms and applications within the organization are maintained.", frameworks:["NIST CSF"],references:["NIST ID.AM-02"]},
            {id:"CTRL-ID.AM-03",name:"Organizational communication and data flows mapping",category:"Asset Management", description:"Organizational communication and data flows are mapped.", frameworks:["NIST CSF"],references:["NIST ID.AM-03"]},
            {id:"CTRL-ID.AM-04",name:"External information systems catalog",category:"Asset Management", description:"External information systems are catalogued.", frameworks:["NIST CSF"],references:["NIST ID.AM-04"]},
            {id:"CTRL-ID.AM-05",name:"Resources prioritization",category:"Asset Management", description:"Resources are prioritized based on their classification, criticality, and business value.", frameworks:["NIST CSF"],references:["NIST ID.AM-05"]},
            {id:"CTRL-ID.AM-06",name:"Cybersecurity roles and responsibilities definition",category:"Asset Management", description:"Cybersecurity roles and responsibilities for the entire workforce and third-party stakeholders are established.", frameworks:["NIST CSF"],references:["NIST ID.AM-06"]},
            {id:"CTRL-ID.BE-01",name:"Organization's role in supply chain identification",category:"Policy & Governance", description:"The organization's place in critical infrastructure and its sector is identified and communicated.", frameworks:["NIST CSF"],references:["NIST ID.BE-01"]},
            // Add more NIST...
            // From PCI DSS v4.0
            {id:"CTRL-PCI-1.1",name:"Processes for network security controls",category:"Network Security", description:"Processes and mechanisms for installing and maintaining network security controls are defined and understood.", frameworks:["PCI DSS"],references:["PCI DSS 1.1"]},
            {id:"CTRL-PCI-1.2",name:"Network security controls implementation",category:"Network Security", description:"Network security controls are implemented.", frameworks:["PCI DSS"],references:["PCI DSS 1.2"]},
            {id:"CTRL-PCI-1.3",name:"Network access restriction",category:"Network Security", description:"Network access to and from the cardholder data environment is restricted.", frameworks:["PCI DSS"],references:["PCI DSS 1.3"]},
            {id:"CTRL-PCI-1.4",name:"External network access restriction",category:"Network Security", description:"Network access from the internet to and from the cardholder data environment is restricted.", frameworks:["PCI DSS"],references:["PCI DSS 1.4"]},
            {id:"CTRL-PCI-1.5",name:"Risks from wireless networks",category:"Network Security", description:"Risks to the CDE from computing devices and networks with wireless access technology are managed.", frameworks:["PCI DSS"],references:["PCI DSS 1.5"]},
            {id:"CTRL-PCI-2.1",name:"Secure configurations processes",category:"Access Control", description:"Processes and mechanisms for applying secure configurations to components are defined and understood.", frameworks:["PCI DSS"],references:["PCI DSS 2.1"]},
            {id:"CTRL-PCI-2.2",name:"System configuration standards",category:"Access Control", description:"System configuration standards are developed, documented, and implemented.", frameworks:["PCI DSS"],references:["PCI DSS 2.2"]},
            {id:"CTRL-PCI-2.3",name:"Wireless environment security",category:"Network Security", description:"Wireless environments are configured and managed securely.", frameworks:["PCI DSS"],references:["PCI DSS 2.3"]},
            {id:"CTRL-PCI-3.1",name:"Processes for protecting stored account data",category:"Encryption & Key Management", description:"Processes and mechanisms for protecting stored account data are defined and understood.", frameworks:["PCI DSS"],references:["PCI DSS 3.1"]},
            {id:"CTRL-PCI-3.2",name:"Sensitive authentication data storage",category:"Encryption & Key Management", description:"Sensitive authentication data is not stored and PAN is rendered unrecoverable.", frameworks:["PCI DSS"],references:["PCI DSS 3.2"]},
            {id:"CTRL-PCI-3.3",name:"PAN masking",category:"Encryption & Key Management", description:"Primary account number is masked when displayed.", frameworks:["PCI DSS"],references:["PCI DSS 3.3"]},
            // Add more PCI...
            // From HIPAA
            {id:"CTRL-HIPAA-164.308(a)(1)(i)",name:"Security management process",category:"Policy & Governance", description:"Implement policies and procedures to prevent, detect, contain, and correct security violations.", frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(i)"]},
            {id:"CTRL-HIPAA-164.308(a)(1)(ii)(A)",name:"Risk analysis",category:"Policy & Governance", description:"Conduct an accurate and thorough assessment of the potential risks and vulnerabilities to the confidentiality, integrity, and availability of electronic protected health information held by the covered entity.", frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(A)"]},
            {id:"CTRL-HIPAA-164.308(a)(1)(ii)(B)",name:"Risk management",category:"Policy & Governance", description:"Implement security measures sufficient to reduce risks and vulnerabilities to a reasonable and appropriate level to comply with §164.306(a).", frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(B)"]},
            {id:"CTRL-HIPAA-164.308(a)(1)(ii)(C)",name:"Sanction policy",category:"Policy & Governance", description:"Apply appropriate sanctions against workforce members who fail to comply with the security policies and procedures of the covered entity.", frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(C)"]},
            {id:"CTRL-HIPAA-164.308(a)(1)(ii)(D)",name:"Information system activity review",category:"Logging & Monitoring", description:"Implement procedures to regularly review records of information system activity, such as audit logs, access reports, and security incident tracking reports.", frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(D)"]},
            // Add more HIPAA...
            // From SOC 2
            {id:"CTRL-SOC-CC1.1",name:"Commitment to integrity and ethical values",category:"Policy & Governance", description:"The entity demonstrates a commitment to integrity and ethical values.", frameworks:["SOC2"],references:["SOC2 CC1.1"]},
            {id:"CTRL-SOC-CC1.2",name:"Board independence",category:"Policy & Governance", description:"The board of directors demonstrates independence from management and exercises oversight of the development and performance of internal control.", frameworks:["SOC2"],references:["SOC2 CC1.2"]},
            {id:"CTRL-SOC-CC1.3",name:"Management roles and responsibilities",category:"Policy & Governance", description:"Management establishes, with board oversight, structures, reporting lines, and appropriate authorities and responsibilities in the pursuit of objectives.", frameworks:["SOC2"],references:["SOC2 CC1.3"]},
            {id:"CTRL-SOC-CC1.4",name:"Commitment to competent personnel",category:"Policy & Governance", description:"The entity demonstrates a commitment to attract, develop, and retain competent individuals in alignment with objectives.", frameworks:["SOC2"],references:["SOC2 CC1.4"]},
            {id:"CTRL-SOC-CC1.5",name:"Accountability",category:"Policy & Governance", description:"The entity holds individuals accountable for their internal control responsibilities in the pursuit of objectives.", frameworks:["SOC2"],references:["SOC2 CC1.5"]},
            {id:"CTRL-SOC-CC2.1",name:"Risk assessment objectives",category:"Policy & Governance", description:"The entity specifies objectives with sufficient clarity to enable the identification and assessment of risks relating to objectives.", frameworks:["SOC2"],references:["SOC2 CC2.1"]},
            {id:"CTRL-SOC-CC2.2",name:"Risk identification and assessment",category:"Policy & Governance", description:"The entity identifies risks to the achievement of its objectives across the entity and analyzes risks as a basis for determining how the risks should be managed.", frameworks:["SOC2"],references:["SOC2 CC2.2"]},
            {id:"CTRL-SOC-CC2.3",name:"Fraud risk",category:"Policy & Governance", description:"The entity considers the potential for fraud in assessing risks to the achievement of objectives.", frameworks:["SOC2"],references:["SOC2 CC2.3"]},
            {id:"CTRL-SOC-CC2.4",name:"Change management",category:"Change Management", description:"The entity identifies and assesses changes that could significantly impact the system of internal control.", frameworks:["SOC2"],references:["SOC2 CC2.4"]},
            // Add more SOC2...
        ];

        // Risk configuration (thresholds)
        const RISK_CFG_KEY = 'grc_risk_cfg_v1';
        const defaultRiskConfig = { highMin: 15, mediumMin: 6 };
        function loadRiskConfig(){
            try{
                const raw = localStorage.getItem(RISK_CFG_KEY);
                if(!raw) return {...defaultRiskConfig};
                const parsed = JSON.parse(raw);
                return {
                    highMin: typeof parsed.highMin === 'number' ? parsed.highMin : defaultRiskConfig.highMin,
                    mediumMin: typeof parsed.mediumMin === 'number' ? parsed.mediumMin : defaultRiskConfig.mediumMin
                };
            }catch{
                return {...defaultRiskConfig};
            }
        }
        function saveRiskConfig(cfg){
            riskConfig = {
                highMin: Math.max(1, Math.min(25, Number(cfg.highMin) || defaultRiskConfig.highMin)),
                mediumMin: Math.max(1, Math.min(25, Number(cfg.mediumMin) || defaultRiskConfig.mediumMin))
            };
            localStorage.setItem(RISK_CFG_KEY, JSON.stringify(riskConfig));
        }
        let riskConfig = loadRiskConfig();

        // Storage
        const K = { assets:'grc_assets_v1', risks:'grc_risks_v1', controls:'grc_controls_v1', issues:'grc_issues_v1', treats:'grc_treats_v1', soa:'grc_soa_v1', vendors:'grc_vendors_v1', incidents:'grc_incidents_v1' };
        const load = k => {
            try {
                const v = JSON.parse(localStorage.getItem(k));
                return Array.isArray(v)?v:[];
            } catch {
                return [];
            }
        };
        const save = (k,v) => localStorage.setItem(k,JSON.stringify(v));
        let assets = load(K.assets);
        let risks = load(K.risks);
        let controls = load(K.controls);
        let issues = load(K.issues);
        let treatments = load(K.treats);
        let soa = load(K.soa);
        let vendors = load(K.vendors);
        let incidents = load(K.incidents);

        // Helpers
        const qs = s => document.querySelector(s);
        const qsa = s => Array.from(document.querySelectorAll(s));
        const getMulti = sel => {
            if(!sel) return [];
            const v = [];
            Array.from(sel.options).forEach(o => {
                if(o.selected && o.value) v.push(o.value);
            });
            return v;
        };
        const setMulti = (sel,vals) => {
            if(!sel) return;
            const S = new Set(vals||[]);
            Array.from(sel.options).forEach(o => o.selected = S.has(o.value));
        };
        const rScore = (l,i) => (Number(l)||0)*(Number(i)||0);
        function rLevel(s){
            const score = Number(s)||0;
            if(score <= 0) return '-';
            const high = riskConfig.highMin;
            const med = riskConfig.mediumMin;
            if(score >= high) return 'High';
            if(score >= med) return 'Medium';
            return 'Low';
        }
        // risk view state
        let riskFilterStatus = 'all';
        let riskFilterLevel = 'all';
        let riskFilterCategory = 'all';
        let riskSortField = 'score';
        let riskSortDir = 'desc';
        let lastRiskView = [];
        // Pagination settings
        const ITEMS_PER_PAGE = 10;
        function renderPagination(containerId, totalItems, currentPage, renderFunc) {
            const pagination = qs(`#${containerId}`);
            if (!pagination) return;
            pagination.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) li.classList.add('active');
                const a = document.createElement('a');
                a.classList.add('page-link');
                a.textContent = i;
                a.href = '#';
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderFunc(i);
                });
                li.appendChild(a);
                pagination.appendChild(li);
            }
        }
        // Toast helper
        function showToast(message, isError = false) {
            const toastContainer = qs('#toast-container');
            const toast = toastContainer.querySelector('.toast');
            const toastBody = toast.querySelector('.toast-body');
            toastBody.textContent = message;
            toast.classList.toggle('bg-danger', isError);
            toast.classList.toggle('bg-success', !isError);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        // ---------- Framework render ----------
        function renderFrameworkControls(){
            const tbody = qs('#frameworks-table-body');
            const countEl = qs('#frameworks-count');
            const f = qs('#framework-filter').value;
            const c = qs('#category-filter').value;
            const s = (qs('#framework-search').value||'').trim().toLowerCase();
            const filtered = FRAMEWORK_CONTROLS.filter(x => {
                const okF = f === 'all' || x.frameworks.includes(f);
                const okC = c === 'all' || x.category === c;
                const okS = !s || x.name.toLowerCase().includes(s) || x.description.toLowerCase().includes(s) || x.id.toLowerCase().includes(s);
                return okF && okC && okS;
            });
            tbody.innerHTML = '';
            filtered.forEach(x => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${x.id}</td>
                    <td>${x.name}</td>
                    <td>${x.category}</td>
                    <td>${x.references.join('<br>')}</td>
                    <td>${x.description}</td>`;
                tbody.appendChild(tr);
            });
            countEl.textContent = `${filtered.length} control(s) shown of ${FRAMEWORK_CONTROLS.length}`;
        }
        // ---------- Assets ----------
        let currentAssetsPage = 1;
        function selectedDataTypes(){
            return qsa('.asset-dt').filter(cb=>cb.checked).map(cb=>cb.value);
        }
        function setDataTypes(vals){
            qsa('.asset-dt').forEach(cb=>cb.checked=(vals||[]).includes(cb.value));
        }
        function populateRiskAssetOptions(){
            const sel=qs('#risk-linked');
            if(!sel) return;
            const cur=sel.value;
            sel.innerHTML='<option value="">Select asset or vendor...</option>';
            assets.forEach(a=>{
                const o=document.createElement('option');
                o.value='asset-'+a.id;
                o.textContent=a.name + ' (Asset)';
                sel.appendChild(o);
            });
            vendors.forEach(v=>{
                const o=document.createElement('option');
                o.value='vendor-'+v.id;
                o.textContent=v.name + ' (Vendor)';
                sel.appendChild(o);
            });
            if(cur && (assets.some(a=> 'asset-'+a.id === cur) || vendors.some(v=> 'vendor-'+v.id === cur))) sel.value=cur;
        }
        function populateIssueDropdowns(){
            const aSel=qs('#issue-asset'), vSel=qs('#issue-vendor'), rSel=qs('#issue-risk'), cSel=qs('#issue-control');
            const incASel=qs('#incident-asset'), incVSel=qs('#incident-vendor'), incRSel=qs('#incident-risk'), incCSel=qs('#incident-control');
            if(aSel){
                aSel.innerHTML = '<option value="">Linked asset...</option>';
                assets.forEach(a => {
                    const o = document.createElement('option');
                    o.value = a.id;
                    o.textContent = a.name;
                    aSel.appendChild(o);
                });
            }
            if(incASel){
                incASel.innerHTML = '<option value="">Linked asset...</option>';
                assets.forEach(a => {
                    const o = document.createElement('option');
                    o.value = a.id;
                    o.textContent = a.name;
                    incASel.appendChild(o);
                });
            }
            if(vSel){
                vSel.innerHTML = '<option value="">Linked vendor...</option>';
                vendors.forEach(v => {
                    const o = document.createElement('option');
                    o.value = v.id;
                    o.textContent = v.name;
                    vSel.appendChild(o);
                });
            }
            if(incVSel){
                incVSel.innerHTML = '<option value="">Linked vendor...</option>';
                vendors.forEach(v => {
                    const o = document.createElement('option');
                    o.value = v.id;
                    o.textContent = v.name;
                    incVSel.appendChild(o);
                });
            }
            if(rSel){
                rSel.innerHTML = '<option value="">Linked risk...</option>';
                risks.forEach(r => {
                    const o = document.createElement('option');
                    o.value = r.id;
                    o.textContent = r.title;
                    rSel.appendChild(o);
                });
            }
            if(incRSel){
                incRSel.innerHTML = '<option value="">Linked risk...</option>';
                risks.forEach(r => {
                    const o = document.createElement('option');
                    o.value = r.id;
                    o.textContent = r.title;
                    incRSel.appendChild(o);
                });
            }
            if(cSel){
                cSel.innerHTML = '<option value="">Linked control...</option>';
                controls.forEach(c => {
                    const o = document.createElement('option');
                    o.value = c.id;
                    o.textContent = c.name;
                    cSel.appendChild(o);
                });
            }
            if(incCSel){
                incCSel.innerHTML = '<option value="">Linked control...</option>';
                controls.forEach(c => {
                    const o = document.createElement('option');
                    o.value = c.id;
                    o.textContent = c.name;
                    incCSel.appendChild(o);
                });
            }
        }
        function renderAssetsTable(page = 1){
            currentAssetsPage = page;
            const tbody=qs('#assets-table-body'), empty=qs('#assets-empty'), count=qs('#assets-count');
            tbody.innerHTML='';
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedAssets = assets.slice(start, end);
            paginatedAssets.forEach(a=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${a.name}</td>
                    <td>${a.type}</td>
                    <td>${a.criticality}</td>
                    <td>${(a.dataTypes||[]).join(', ')}</td>
                    <td>${a.owner||''}</td>
                    <td>${a.location||''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-ae="${a.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-ad="${a.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display = assets.length ? 'none' : 'block';
            count.textContent = `${assets.length} asset(s)`;
            renderPagination('assets-pagination', assets.length, page, renderAssetsTable);
            populateRiskAssetOptions();
            populateIssueDropdowns();
            renderDashboard();
        }
        function resetAssetForm(){
            qs('#asset-form').reset();
            qs('#asset-id').value='';
            qs('#asset-form-submit').textContent='Save asset';
        }
        qs('#asset-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#asset-id').value;
            const name=qs('#asset-name').value.trim();
            const type=qs('#asset-type').value;
            const crit=qs('#asset-criticality').value;
            if(!name || !type || !crit) return alert('Fill name, type, criticality.');
            const obj={
                id: id || ('AST-'+Date.now()),
                name,
                type,
                criticality:crit,
                owner:qs('#asset-owner').value.trim(),
                dataTypes:selectedDataTypes(),
                location:qs('#asset-location').value.trim(),
                notes:qs('#asset-notes').value.trim()
            };
            const idx=assets.findIndex(x=>x.id===obj.id);
            if(idx>-1) assets[idx]=obj;
            else assets.push(obj);
            save(K.assets,assets);
            renderAssetsTable(currentAssetsPage);
            resetAssetForm();
            showToast('Asset saved successfully');
        });
        qs('#asset-form-cancel').addEventListener('click',resetAssetForm);
        qs('#assets-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-ae');
            const idD=e.target.getAttribute('data-ad');
            if(idE){
                const a=assets.find(x=>x.id===idE);
                if(!a) return;
                qs('#asset-id').value=a.id;
                qs('#asset-name').value=a.name;
                qs('#asset-type').value=a.type;
                qs('#asset-criticality').value=a.criticality;
                qs('#asset-owner').value=a.owner||'';
                qs('#asset-location').value=a.location||'';
                qs('#asset-notes').value=a.notes||'';
                setDataTypes(a.dataTypes||[]);
                qs('#asset-form-submit').textContent='Update asset';
            }
            if(idD){
                if(!confirm('Delete this asset?')) return;
                assets=assets.filter(x=>x.id!==idD);
                save(K.assets,assets);
                // Unlink from risks, issues, incidents, etc.
                risks.forEach(r => {
                    if (r.linked && r.linked === 'asset-' + idD) r.linked = '';
                });
                save(K.risks, risks);
                renderRisksTable();
                issues.forEach(i => {
                    if (i.assetId === idD) i.assetId = '';
                });
                save(K.issues, issues);
                renderIssuesTable();
                incidents.forEach(inc => {
                    if (inc.assetId === idD) inc.assetId = '';
                });
                save(K.incidents, incidents);
                renderIncidentsTable();
                renderAssetsTable(currentAssetsPage);
                showToast('Asset deleted');
            }
        });
        // ---------- Vendors ----------
        let currentVendorsPage = 1;
        function renderVendorsTable(page = 1){
            currentVendorsPage = page;
            const tbody=qs('#vendors-table-body'), empty=qs('#vendors-empty'), count=qs('#vendors-count');
            tbody.innerHTML='';
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedVendors = vendors.slice(start, end);
            paginatedVendors.forEach(v=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${v.name}</td>
                    <td>${v.type}</td>
                    <td>${v.criticality}</td>
                    <td>${v.dataAccess || ''}</td>
                    <td>${v.contract || ''}</td>
                    <td>${v.assessment || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-ve="${v.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-vd="${v.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display = vendors.length ? 'none' : 'block';
            count.textContent = `${vendors.length} vendor(s)`;
            renderPagination('vendors-pagination', vendors.length, page, renderVendorsTable);
            populateRiskAssetOptions();
            populateIssueDropdowns();
            renderDashboard();
        }
        function resetVendorForm(){
            qs('#vendor-form').reset();
            qs('#vendor-id').value='';
        }
        qs('#vendor-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#vendor-id').value;
            const name=qs('#vendor-name').value.trim();
            const type=qs('#vendor-type').value;
            const crit=qs('#vendor-criticality').value;
            if(!name || !type || !crit) return alert('Fill name, type, criticality.');
            const obj={
                id: id || ('VND-'+Date.now()),
                name,
                type,
                criticality:crit,
                dataAccess:qs('#vendor-data-access').value,
                contract:qs('#vendor-contract').value,
                assessment:qs('#vendor-assessment').value,
                notes:qs('#vendor-notes').value.trim()
            };
            const idx=vendors.findIndex(x=>x.id===obj.id);
            if(idx>-1) vendors[idx]=obj;
            else vendors.push(obj);
            save(K.vendors,vendors);
            renderVendorsTable(currentVendorsPage);
            resetVendorForm();
            showToast('Vendor saved successfully');
        });
        qs('#vendor-form-cancel').addEventListener('click',resetVendorForm);
        qs('#vendors-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-ve');
            const idD=e.target.getAttribute('data-vd');
            if(idE){
                const v=vendors.find(x=>x.id===idE);
                if(!v) return;
                qs('#vendor-id').value=v.id;
                qs('#vendor-name').value=v.name;
                qs('#vendor-type').value=v.type;
                qs('#vendor-criticality').value=v.criticality;
                qs('#vendor-data-access').value=v.dataAccess || '';
                qs('#vendor-contract').value=v.contract || '';
                qs('#vendor-assessment').value=v.assessment || '';
                qs('#vendor-notes').value=v.notes || '';
            }
            if(idD){
                if(!confirm('Delete this vendor?')) return;
                vendors=vendors.filter(x=>x.id!==idD);
                save(K.vendors,vendors);
                // Unlink similar to assets
                risks.forEach(r => {
                    if (r.linked && r.linked === 'vendor-' + idD) r.linked = '';
                });
                save(K.risks, risks);
                renderRisksTable();
                issues.forEach(i => {
                    if (i.vendorId === idD) i.vendorId = '';
                });
                save(K.issues, issues);
                renderIssuesTable();
                incidents.forEach(inc => {
                    if (inc.vendorId === idD) inc.vendorId = '';
                });
                save(K.incidents, incidents);
                renderIncidentsTable();
                renderVendorsTable(currentVendorsPage);
                showToast('Vendor deleted');
            }
        });
        // ---------- Risks ----------
        let currentRisksPage = 1;
        function resetRiskForm(){
            qs('#risk-form').reset();
            qs('#risk-id').value='';
            qs('#risk-form-submit').textContent='Save risk';
        }
        function populateControlRisks(){
            const sel=qs('#control-risks');
            if(!sel) return;
            const cur=getMulti(sel);
            sel.innerHTML='';
            risks.forEach(r=>{
                const o=document.createElement('option');
                o.value=r.id;
                o.textContent=r.title;
                sel.appendChild(o);
            });
            setMulti(sel,cur);
        }
        function getSoAEntry(fcId){
            let e = soa.find(x=>x.fcId===fcId);
            if(!e){
                e = { fcId: fcId, applicability:'Applicable', implementation:'Auto', owner:'', rationale:'', evidence:'' };
                soa.push(e);
            }
            return e;
        }
        function saveSoA(){
            save(K.soa, soa);
        }
        function riskCompare(a,b,field){
            switch(field){
                case 'score': return (a.score||0) - (b.score||0);
                case 'impact': return (a.impact||0) - (b.impact||0);
                case 'likelihood': return (a.likelihood||0) - (b.likelihood||0);
                case 'status': return (a.status||'').localeCompare(b.status||'');
                case 'asset': return (a.linkedName||'').localeCompare(b.linkedName||'');
                case 'title': default: return (a.title||'').localeCompare(b.title||'');
            }
        }
        function renderRisksTable(page = 1){
            currentRisksPage = page;
            const tbody=qs('#risks-table-body'), empty=qs('#risks-empty'), count=qs('#risks-count');
            let list = risks.slice();
            // filters
            if(riskFilterStatus !== 'all'){
                list = list.filter(r => (r.status||'') === riskFilterStatus);
            }
            if(riskFilterLevel !== 'all'){
                list = list.filter(r => rLevel(r.score) === riskFilterLevel);
            }
            if(riskFilterCategory !== 'all'){
                list = list.filter(r => (r.category||'') === riskFilterCategory);
            }
            // sort
            list.sort((a,b)=> riskCompare(a,b, riskSortField) * (riskSortDir === 'asc' ? 1 : -1));
            lastRiskView = list.slice();
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedList = list.slice(start, end);
            tbody.innerHTML='';
            paginatedList.forEach(r=>{
                const level=rLevel(r.score);
                const cls = level==='High'?'bg-danger text-white':level==='Medium'?'bg-warning':level==='Low'?'bg-success text-white':'';
                const resScore = rScore(r.resLikelihood, r.resImpact);
                const resLevel = rLevel(resScore);
                const resCls = resLevel==='High'?'bg-danger text-white':resLevel==='Medium'?'bg-warning':resLevel==='Low'?'bg-success text-white':'';
                const linkedName = r.linked ? r.linkedName : '';
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${r.title}</td>
                    <td>${linkedName||''}</td>
                    <td>${r.category}</td>
                    <td>${r.score?`<span class="badge ${cls} mr-1">${r.score}</span><span class="text-muted small">${level}</span>`:'-'}</td>
                    <td>${resScore?`<span class="badge ${resCls} mr-1">${resScore}</span><span class="text-muted small">${resLevel}</span>`:'-'}</td>
                    <td>${r.status}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-re="${r.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-rd="${r.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display=list.length?'none':'block';
            count.textContent=`${list.length} risk(s) shown of ${risks.length}`;
            renderPagination('risks-pagination', list.length, page, renderRisksTable);
            populateControlRisks();
            populateIssueDropdowns();
            populateTreatmentDropdownLinked();
            renderDashboard();
        }
        qs('#risk-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#risk-id').value;
            const title=qs('#risk-title').value.trim();
            const linked=qs('#risk-linked').value;
            let linkedId = '';
            let linkedName = '';
            let linkedType = '';
            if (linked) {
                [linkedType, linkedId] = linked.split('-');
                if (linkedType === 'asset') {
                    const asset = assets.find(a => a.id === linkedId);
                    linkedName = asset ? asset.name : '';
                } else if (linkedType === 'vendor') {
                    const vendor = vendors.find(v => v.id === linkedId);
                    linkedName = vendor ? vendor.name : '';
                }
            }
            const category=qs('#risk-category').value;
            const likelihood=Number(qs('#risk-likelihood').value);
            const impact=Number(qs('#risk-impact').value);
            const resLikelihood = Number(qs('#risk-res-likelihood').value) || likelihood;
            const resImpact = Number(qs('#risk-res-impact').value) || impact;
            const status=qs('#risk-status').value;
            if(!title || !linked || !category || !likelihood || !impact || !status) return alert('Fill all required risk fields.');
            const obj={
                id:id || ('RSK-'+Date.now()),
                title,
                linked,
                linkedType,
                linkedId,
                linkedName,
                category,
                likelihood,
                impact,
                score:rScore(likelihood,impact),
                resLikelihood,
                resImpact,
                resScore:rScore(resLikelihood, resImpact),
                status,
                owner:qs('#risk-owner').value.trim(),
                notes:qs('#risk-notes').value.trim()
            };
            const idx=risks.findIndex(x=>x.id===obj.id);
            if(idx>-1) risks[idx]=obj;
            else risks.push(obj);
            save(K.risks,risks);
            renderRisksTable(currentRisksPage);
            resetRiskForm();
            showToast('Risk saved successfully');
        });
        qs('#risk-form-cancel').addEventListener('click',resetRiskForm);
        qs('#risks-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-re');
            const idD=e.target.getAttribute('data-rd');
            if(idE){
                const r=risks.find(x=>x.id===idE);
                if(!r) return;
                qs('#risk-id').value=r.id;
                qs('#risk-title').value=r.title;
                qs('#risk-linked').value=r.linked;
                qs('#risk-category').value=r.category;
                qs('#risk-likelihood').value=String(r.likelihood);
                qs('#risk-impact').value=String(r.impact);
                qs('#risk-res-likelihood').value=String(r.resLikelihood);
                qs('#risk-res-impact').value=String(r.resImpact);
                qs('#risk-owner').value=r.owner||'';
                qs('#risk-status').value=r.status||'Open';
                qs('#risk-notes').value=r.notes||'';
                qs('#risk-form-submit').textContent='Update risk';
            }
            if(idD){
                if(!confirm('Delete this risk?')) return;
                risks=risks.filter(x=>x.id!==idD);
                save(K.risks,risks);
                // unlink from controls
                let changed=false;
                controls.forEach(c=>{
                    if(Array.isArray(c.linkedRiskIds) && c.linkedRiskIds.includes(idD)){
                        c.linkedRiskIds=c.linkedRiskIds.filter(z=>z!==idD);
                        changed=true;
                    }
                });
                if(changed){
                    save(K.controls,controls);
                    renderControlsTable();
                }
                // unlink from issues
                issues.forEach(i=>{
                    if(i.riskId===idD){
                        i.riskId='';
                        i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Risk: [^|]+/,'');
                    }
                });
                save(K.issues,issues);
                renderIssuesTable();
                // unlink from incidents
                incidents.forEach(inc=>{
                    if(inc.riskId===idD){
                        inc.riskId='';
                        inc.linkedSummary=(inc.linkedSummary||'').replace(/ *\| *Risk: [^|]+/,'');
                    }
                });
                save(K.incidents,incidents);
                renderIncidentsTable();
                // unlink from treatments
                treatments.forEach(t=>{
                    if(t.linked === idD) t.linked = '';
                });
                save(K.treats,treatments);
                renderTreatmentsTable();
                renderRisksTable(currentRisksPage);
                showToast('Risk deleted');
            }
        });
        function syncRiskThresholdInputs(){
            const h = qs('#risk-thres-high');
            const m = qs('#risk-thres-med');
            if(!h || !m) return;
            h.value = riskConfig.highMin;
            m.value = riskConfig.mediumMin;
        }
        function applyRiskThresholdInputs(){
            const h = qs('#risk-thres-high');
            const m = qs('#risk-thres-med');
            if(!h || !m) return;
            let high = Number(h.value) || defaultRiskConfig.highMin;
            let med = Number(m.value) || defaultRiskConfig.mediumMin;
            high = Math.max(1, Math.min(25, high));
            med = Math.max(1, Math.min(25, med));
            if(high <= med){
                med = Math.max(1, high - 1);
                m.value = med;
            }
            saveRiskConfig({ highMin: high, mediumMin: med });
            renderRisksTable(currentRisksPage);
            drawMatrix();
            renderDashboard();
        }
        // ---------- Controls ----------
        let currentControlsPage = 1;
        function populateControlFrameworks(){
            const sel=qs('#control-frameworks');
            if(!sel) return;
            sel.innerHTML='';
            FRAMEWORK_CONTROLS.forEach(fc=>{
                const o=document.createElement('option');
                o.value=fc.id;
                o.textContent=`${fc.id} – ${fc.name}`;
                sel.appendChild(o);
            });
        }
        function renderControlsTable(page = 1){
            currentControlsPage = page;
            const tbody=qs('#controls-table-body'), empty=qs('#controls-empty'), count=qs('#controls-count');
            tbody.innerHTML='';
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedControls = controls.slice(start, end);
            paginatedControls.forEach(c=>{
                const rc=(c.linkedRiskIds||[]).length;
                const fw=(c.linkedFrameworkControlIds||[]).length;
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${c.name}</td>
                    <td>${c.type}</td>
                    <td>${c.status}</td>
                    <td>${rc?rc+' linked':'-'}</td>
                    <td>${fw?fw+' mapped':'-'}</td>
                    <td>${c.evidence || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-ce="${c.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-cd="${c.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display=controls.length?'none':'block';
            count.textContent=`${controls.length} control(s)`;
            renderPagination('controls-pagination', controls.length, page, renderControlsTable);
            populateIssueDropdowns();
            populateTreatmentDropdownControls();
            renderGapTable();
            renderDashboard();
            renderSoATable();
        }
        function resetControlForm(){
            qs('#control-form').reset();
            qs('#control-id').value='';
            qs('#control-form-submit').textContent='Save control';
        }
        qs('#control-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#control-id').value;
            const name=qs('#control-name').value.trim();
            const type=qs('#control-type').value;
            const status=qs('#control-status').value;
            if(!name || !type || !status) return alert('Fill control name, type, status.');
            const obj={
                id:id || ('CTL-'+Date.now()),
                name,
                type,
                status,
                owner:qs('#control-owner').value.trim(),
                description:qs('#control-description').value.trim(),
                linkedRiskIds:getMulti(qs('#control-risks')),
                linkedFrameworkControlIds:getMulti(qs('#control-frameworks')),
                evidence:qs('#control-evidence').value.trim()
            };
            const idx=controls.findIndex(x=>x.id===obj.id);
            if(idx>-1) controls[idx]=obj;
            else controls.push(obj);
            save(K.controls,controls);
            renderControlsTable(currentControlsPage);
            resetControlForm();
            showToast('Control saved successfully');
        });
        qs('#control-form-cancel').addEventListener('click',resetControlForm);
        qs('#controls-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-ce');
            const idD=e.target.getAttribute('data-cd');
            if(idE){
                const c=controls.find(x=>x.id===idE);
                if(!c) return;
                qs('#control-id').value=c.id;
                qs('#control-name').value=c.name;
                qs('#control-type').value=c.type;
                qs('#control-status').value=c.status;
                qs('#control-owner').value=c.owner||'';
                qs('#control-description').value=c.description||'';
                setMulti(qs('#control-risks'),c.linkedRiskIds||[]);
                setMulti(qs('#control-frameworks'),c.linkedFrameworkControlIds||[]);
                qs('#control-evidence').value=c.evidence||'';
                qs('#control-form-submit').textContent='Update control';
            }
            if(idD){
                if(!confirm('Delete this control?')) return;
                controls=controls.filter(x=>x.id!==idD);
                save(K.controls,controls);
                // unlink from issues, incidents, treatments
                issues.forEach(i=>{
                    if(i.controlId===idD){
                        i.controlId='';
                        i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Control: [^|]+/,'');
                    }
                });
                save(K.issues,issues);
                renderIssuesTable();
                incidents.forEach(inc=>{
                    if(inc.controlId===idD){
                        inc.controlId='';
                        inc.linkedSummary=(inc.linkedSummary||'').replace(/ *\| *Control: [^|]+/,'');
                    }
                });
                save(K.incidents,incidents);
                renderIncidentsTable();
                treatments.forEach(t=>{
                    if(t.controlId===idD) t.controlId='';
                });
                save(K.treats,treatments);
                renderTreatmentsTable();
                renderControlsTable(currentControlsPage);
                showToast('Control deleted');
            }
        });
        // ---------- Issues ----------
        let currentIssuesPage = 1;
        function resetIssueForm(){
            qs('#issue-form').reset();
            qs('#issue-id').value='';
            qs('#issue-form-submit').textContent='Save issue';
        }
        function renderIssuesTable(page = 1){
            currentIssuesPage = page;
            const tbody=qs('#issues-table-body'), empty=qs('#issues-empty'), count=qs('#issues-count');
            tbody.innerHTML='';
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedIssues = issues.slice(start, end);
            paginatedIssues.forEach(i=>{
                const sev=i.severity||'';
                const cls = sev==='Critical'||sev==='High'?'bg-danger text-white':sev==='Medium'?'bg-warning':'bg-success text-white';
                const linkedSummary = [
                    i.assetId ? `Asset: ${assets.find(a => a.id === i.assetId)?.name || ''}` : '',
                    i.vendorId ? `Vendor: ${vendors.find(v => v.id === i.vendorId)?.name || ''}` : '',
                    i.riskId ? `Risk: ${risks.find(r => r.id === i.riskId)?.title || ''}` : '',
                    i.controlId ? `Control: ${controls.find(c => c.id === i.controlId)?.name || ''}` : ''
                ].filter(Boolean).join(' | ');
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${i.title}</td>
                    <td>${i.type}</td>
                    <td>${sev?`<span class="badge ${cls}">${sev}</span>`:'-'}</td>
                    <td>${i.status}</td>
                    <td>${linkedSummary || '-'}</td>
                    <td>${i.dueDate || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-ie="${i.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-id="${i.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display=issues.length?'none':'block';
            count.textContent=`${issues.length} issue(s)`;
            renderPagination('issues-pagination', issues.length, page, renderIssuesTable);
            renderDashboard();
        }
        qs('#issue-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#issue-id').value;
            const title=qs('#issue-title').value.trim();
            const type=qs('#issue-type').value;
            const severity=qs('#issue-severity').value;
            const status=qs('#issue-status').value;
            if(!title || !type || !severity || !status) return alert('Fill title, type, severity, status.');
            const assetId=qs('#issue-asset').value||'';
            const vendorId=qs('#issue-vendor').value||'';
            const riskId=qs('#issue-risk').value||'';
            const controlId=qs('#issue-control').value||'';
            const linkedSummary = [
                assetId ? `Asset: ${assets.find(a => a.id === assetId)?.name || ''}` : '',
                vendorId ? `Vendor: ${vendors.find(v => v.id === vendorId)?.name || ''}` : '',
                riskId ? `Risk: ${risks.find(r => r.id === riskId)?.title || ''}` : '',
                controlId ? `Control: ${controls.find(c => c.id === controlId)?.name || ''}` : ''
            ].filter(Boolean).join(' | ');
            const obj={
                id:id || ('ISS-'+Date.now()),
                title,
                type,
                severity,
                status,
                owner:qs('#issue-owner').value.trim(),
                dueDate:qs('#issue-due').value,
                notes:qs('#issue-notes').value.trim(),
                assetId,vendorId,riskId,controlId,
                linkedSummary
            };
            const idx=issues.findIndex(x=>x.id===obj.id);
            if(idx>-1) issues[idx]=obj;
            else issues.push(obj);
            save(K.issues,issues);
            renderIssuesTable(currentIssuesPage);
            resetIssueForm();
            showToast('Issue saved successfully');
        });
        qs('#issue-form-cancel').addEventListener('click',resetIssueForm);
        qs('#issues-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-ie');
            const idD=e.target.getAttribute('data-id');
            if(idE){
                const i=issues.find(x=>x.id===idE);
                if(!i) return;
                qs('#issue-id').value=i.id;
                qs('#issue-title').value=i.title;
                qs('#issue-type').value=i.type;
                qs('#issue-severity').value=i.severity;
                qs('#issue-status').value=i.status;
                qs('#issue-owner').value=i.owner||'';
                qs('#issue-due').value=i.dueDate||'';
                qs('#issue-notes').value=i.notes||'';
                qs('#issue-asset').value=i.assetId||'';
                qs('#issue-vendor').value=i.vendorId||'';
                qs('#issue-risk').value=i.riskId||'';
                qs('#issue-control').value=i.controlId||'';
                qs('#issue-form-submit').textContent='Update issue';
            }
            if(idD){
                if(!confirm('Delete this issue?')) return;
                issues=issues.filter(x=>x.id!==idD);
                save(K.issues,issues);
                // Unlink from treatments
                treatments.forEach(t=>{
                    if(t.linked === idD) t.linked = '';
                });
                save(K.treats,treatments);
                renderTreatmentsTable();
                renderIssuesTable(currentIssuesPage);
                showToast('Issue deleted');
            }
        });
        // ---------- Incidents ----------
        let currentIncidentsPage = 1;
        function resetIncidentForm(){
            qs('#incident-form').reset();
            qs('#incident-id').value='';
        }
        function renderIncidentsTable(page = 1){
            currentIncidentsPage = page;
            const tbody=qs('#incidents-table-body'), empty=qs('#incidents-empty'), count=qs('#incidents-count');
            tbody.innerHTML='';
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedIncidents = incidents.slice(start, end);
            paginatedIncidents.forEach(inc=>{
                const sev=inc.severity||'';
                const cls = sev==='Critical'||sev==='High'?'bg-danger text-white':sev==='Medium'?'bg-warning':'bg-success text-white';
                const linkedSummary = [
                    inc.assetId ? `Asset: ${assets.find(a => a.id === inc.assetId)?.name || ''}` : '',
                    inc.vendorId ? `Vendor: ${vendors.find(v => v.id === inc.vendorId)?.name || ''}` : '',
                    inc.riskId ? `Risk: ${risks.find(r => r.id === inc.riskId)?.title || ''}` : '',
                    inc.controlId ? `Control: ${controls.find(c => c.id === inc.controlId)?.name || ''}` : ''
                ].filter(Boolean).join(' | ');
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${inc.title}</td>
                    <td>${inc.type}</td>
                    <td>${sev?`<span class="badge ${cls}">${sev}</span>`:'-'}</td>
                    <td>${inc.status}</td>
                    <td>${inc.detected || '-'}</td>
                    <td>${linkedSummary || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-ince="${inc.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-incd="${inc.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display=incidents.length?'none':'block';
            count.textContent=`${incidents.length} incident(s)`;
            renderPagination('incidents-pagination', incidents.length, page, renderIncidentsTable);
            renderDashboard();
        }
        qs('#incident-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#incident-id').value;
            const title=qs('#incident-title').value.trim();
            const type=qs('#incident-type').value;
            const detected=qs('#incident-detected').value;
            const severity=qs('#incident-severity').value;
            const status=qs('#incident-status').value;
            if(!title || !type || !detected || !severity || !status) return alert('Fill title, type, detected date, severity, status.');
            const assetId=qs('#incident-asset').value||'';
            const vendorId=qs('#incident-vendor').value||'';
            const riskId=qs('#incident-risk').value||'';
            const controlId=qs('#incident-control').value||'';
            const linkedSummary = [
                assetId ? `Asset: ${assets.find(a => a.id === assetId)?.name || ''}` : '',
                vendorId ? `Vendor: ${vendors.find(v => v.id === vendorId)?.name || ''}` : '',
                riskId ? `Risk: ${risks.find(r => r.id === riskId)?.title || ''}` : '',
                controlId ? `Control: ${controls.find(c => c.id === controlId)?.name || ''}` : ''
            ].filter(Boolean).join(' | ');
            const obj={
                id:id || ('INC-'+Date.now()),
                title,
                type,
                detected,
                severity,
                status,
                owner:qs('#incident-owner').value.trim(),
                notes:qs('#incident-notes').value.trim(),
                assetId,vendorId,riskId,controlId,
                linkedSummary
            };
            const idx=incidents.findIndex(x=>x.id===obj.id);
            if(idx>-1) incidents[idx]=obj;
            else incidents.push(obj);
            save(K.incidents,incidents);
            renderIncidentsTable(currentIncidentsPage);
            resetIncidentForm();
            showToast('Incident saved successfully');
        });
        qs('#incident-form-cancel').addEventListener('click',resetIncidentForm);
        qs('#incidents-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-ince');
            const idD=e.target.getAttribute('data-incd');
            if(idE){
                const inc=incidents.find(x=>x.id===idE);
                if(!inc) return;
                qs('#incident-id').value=inc.id;
                qs('#incident-title').value=inc.title;
                qs('#incident-type').value=inc.type;
                qs('#incident-detected').value=inc.detected;
                qs('#incident-severity').value=inc.severity;
                qs('#incident-status').value=inc.status;
                qs('#incident-owner').value=inc.owner||'';
                qs('#incident-notes').value=inc.notes||'';
                qs('#incident-asset').value=inc.assetId||'';
                qs('#incident-vendor').value=inc.vendorId||'';
                qs('#incident-risk').value=inc.riskId||'';
                qs('#incident-control').value=inc.controlId||'';
            }
            if(idD){
                if(!confirm('Delete this incident?')) return;
                incidents=incidents.filter(x=>x.id!==idD);
                save(K.incidents,incidents);
                // Unlink from treatments if needed
                treatments.forEach(t=>{
                    if(t.linked === idD) t.linked = '';
                });
                save(K.treats,treatments);
                renderTreatmentsTable();
                renderIncidentsTable(currentIncidentsPage);
                showToast('Incident deleted');
            }
        });
        // ---------- Gap analysis ----------
        const heatClass = p => p>=80?'heat-good':p>=50?'heat-medium':p>0?'heat-low':'heat-none';
        function computeGapRows(){
            const byCat=new Map();
            FRAMEWORK_CONTROLS.forEach(fc=>{
                if(!byCat.has(fc.category)) byCat.set(fc.category,{category:fc.category,total:0,implemented:0,plannedOnly:0,notImplemented:0});
                const row=byCat.get(fc.category);
                row.total+=1;
                const linked=controls.filter(c=>Array.isArray(c.linkedFrameworkControlIds)&&c.linkedFrameworkControlIds.includes(fc.id));
                if(linked.length===0){
                    row.notImplemented+=1;
                    return;
                }
                const hasInPlace=linked.some(c=>c.status==='In place');
                const hasPlanned=linked.some(c=>c.status==='Planned');
                if(hasInPlace) row.implemented+=1;
                else if(hasPlanned) row.plannedOnly+=1;
                else row.notImplemented+=1;
            });
            return Array.from(byCat.values()).sort((a,b)=>a.category.localeCompare(b.category));
        }
        function overallCoverage(rows){
            let total=0, imp=0;
            rows.forEach(r=>{total+=r.total;imp+=r.implemented;});
            return total?Math.round((imp/total)*100):0;
        }
        function autoImplForFrameworkControl(fcId){
            const linked = controls.filter(c => Array.isArray(c.linkedFrameworkControlIds) && c.linkedFrameworkControlIds.includes(fcId) );
            if(linked.length === 0) return 'Not implemented';
            const anyInPlace = linked.some(c => c.status === 'In place');
            const anyPlanned = linked.some(c => c.status === 'Planned');
            if(anyInPlace) return 'In place';
            if(anyPlanned) return 'Planned';
            return 'Not applicable';
        }
        function renderGapTable(){
            const tbody=qs('#gap-table-body'), overall=qs('#gap-overall-coverage');
            const rows=computeGapRows();
            tbody.innerHTML='';
            rows.forEach(r=>{
                const pct=r.total?Math.round((r.implemented/r.total)*100):0;
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${r.category}</td>
                    <td>${r.total}</td>
                    <td>${r.implemented} / ${r.total}</td>
                    <td>${r.plannedOnly} / ${r.total}</td>
                    <td>${r.notImplemented} / ${r.total}</td>
                    <td class="heat-cell ${heatClass(pct)}">${pct}%<small>${r.implemented} of ${r.total} control(s) implemented</small></td>`;
                tbody.appendChild(tr);
            });
            const ov=overallCoverage(rows);
            overall.textContent = rows.length ? `Overall implemented coverage: ${ov}% of ${FRAMEWORK_CONTROLS.length} framework control(s).` : 'Add local controls and map them to framework controls to see coverage.';
            updateCoveragePill(ov);
        }
        // ---------- SoA with filters and bulk edit ----------
        function renderSoATable(){
            const tbody = qs('#soa-table-body');
            const count = qs('#soa-count');
            if(!tbody || !count) return;
            const f = qs('#soa-framework-filter') ? qs('#soa-framework-filter').value : 'all';
            const c = qs('#soa-category-filter') ? qs('#soa-category-filter').value : 'all';
            const appF = qs('#soa-applicability-filter') ? qs('#soa-applicability-filter').value : 'all';
            const implF = qs('#soa-implementation-filter') ? qs('#soa-implementation-filter').value : 'all';
            const filtered = FRAMEWORK_CONTROLS.filter(fc=>{
                const entry = getSoAEntry(fc.id);
                const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
                const okF = f === 'all' || fc.frameworks.includes(f);
                const okC = c === 'all' || fc.category === c;
                const okApp = appF === 'all' || entry.applicability === appF;
                const okImpl = implF === 'all' || resolvedImpl === implF;
                return okF && okC && okApp && okImpl;
            });
            tbody.innerHTML = '';
            filtered.forEach(fc=>{
                const entry = getSoAEntry(fc.id);
                const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
                const frameworksTxt = (fc.frameworks||[]).join(', ');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="form-check-input soa-checkbox" data-soa-id="${fc.id}"></td>
                    <td>${fc.id}</td>
                    <td>${fc.name}</td>
                    <td>${fc.category}</td>
                    <td>${frameworksTxt}</td>
                    <td>
                        <select class="form-select form-select-sm soa-select" data-soa-app="${fc.id}">
                            <option ${entry.applicability==='Applicable'?'selected':''}>Applicable</option>
                            <option ${entry.applicability==='Not Applicable'?'selected':''}>Not Applicable</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm soa-select" data-soa-impl="${fc.id}">
                            <option ${entry.implementation==='Auto'?'selected':''} value="Auto">Auto (from local controls)</option>
                            <option ${entry.implementation==='In place'?'selected':''}>In place</option>
                            <option ${entry.implementation==='Planned'?'selected':''}>Planned</option>
                            <option ${entry.implementation==='Not implemented'?'selected':''}>Not implemented</option>
                            <option ${entry.implementation==='Not applicable'?'selected':''}>Not applicable</option>
                        </select>
                        <div class="small text-muted">Resolved: <b>${resolvedImpl}</b></div>
                    </td>
                    <td><input class="form-control form-control-sm soa-input" data-soa-owner="${fc.id}" placeholder="Owner" value="${entry.owner||''}"></td>
                    <td>
                        <input class="form-control form-control-sm mb-1 soa-input" data-soa-rationale="${fc.id}" placeholder="Rationale (why status/applicability)" value="${entry.rationale||''}">
                        <input class="form-control form-control-sm soa-input soa-evidence" data-soa-evidence="${fc.id}" placeholder="Evidence URL(s), comma-separated" value="${entry.evidence||''}">
                    </td>
                `;
                tbody.appendChild(tr);
            });
            count.textContent = `${filtered.length} framework control(s) shown of ${FRAMEWORK_CONTROLS.length}`;
            // Delegate change events for all inputs/selects in table
            tbody.onchange = (e)=>{
                const t = e.target;
                const fcId = t.getAttribute('data-soa-app') || t.getAttribute('data-soa-impl') || t.getAttribute('data-soa-owner') || t.getAttribute('data-soa-rationale') || t.getAttribute('data-soa-evidence');
                if(!fcId) return;
                const entry = getSoAEntry(fcId);
                if(t.hasAttribute('data-soa-app')) entry.applicability = t.value;
                if(t.hasAttribute('data-soa-impl')) entry.implementation = t.value;
                if(t.hasAttribute('data-soa-owner')) entry.owner = t.value.trim();
                if(t.hasAttribute('data-soa-rationale')) entry.rationale = t.value.trim();
                if(t.hasAttribute('data-soa-evidence')) entry.evidence = t.value.trim();
                saveSoA();
                // Re-render to refresh the "Resolved" label if impl changed
                if(t.hasAttribute('data-soa-impl')){
                    renderSoATable();
                }
                showToast('SoA entry updated');
            };
            // Bulk edit logic
            const bulkBar = qs('#soa-bulk-bar');
            const selectAll = qs('#soa-select-all');
            selectAll.addEventListener('change', (e) => {
                qsa('.soa-checkbox[data-soa-id]').forEach(cb => cb.checked = e.target.checked);
                bulkBar.style.display = qsa('.soa-checkbox:checked[data-soa-id]').length > 0 ? 'block' : 'none';
            });
            tbody.addEventListener('change', (e) => {
                if (e.target.classList.contains('soa-checkbox')) {
                    bulkBar.style.display = qsa('.soa-checkbox:checked[data-soa-id]').length > 0 ? 'block' : 'none';
                }
            });
            qs('#bulk-apply').addEventListener('click', () => {
                const appVal = qs('#bulk-applicability').value;
                const implVal = qs('#bulk-implementation').value;
                if (!appVal && !implVal) return alert('Select a value to apply.');
                qsa('.soa-checkbox:checked[data-soa-id]').forEach(cb => {
                    const fcId = cb.getAttribute('data-soa-id');
                    const entry = getSoAEntry(fcId);
                    if (appVal) entry.applicability = appVal;
                    if (implVal) entry.implementation = implVal;
                });
                saveSoA();
                renderSoATable();
                qs('#bulk-clear').click();
                showToast('Bulk edit applied');
            });
            qs('#bulk-clear').addEventListener('click', () => {
                qsa('.soa-checkbox').forEach(cb => cb.checked = false);
                bulkBar.style.display = 'none';
            });
        }
        // ---------- Dashboard ----------
        function updateCoveragePill(p){
            const pill=qs('#dash-coverage-pill');
            pill.classList.remove('heat-good','heat-medium','heat-low','heat-none');
            pill.classList.add(heatClass(p));
            pill.textContent = p>=80?'Strong coverage':p>=50?'Moderate coverage':p>0?'Limited coverage':'No implemented coverage yet';
        }
        function renderDashboard(){
            qs('#dash-assets').textContent=assets.length;
            qs('#dash-vendors').textContent=vendors.length;
            qs('#dash-risks').textContent=risks.length;
            qs('#dash-controls').textContent=controls.filter(c=>c.status === 'In place').length;
            qs('#dash-issues').textContent=issues.length;
            qs('#dash-incidents').textContent=incidents.filter(i=>i.status !== 'Closed').length;
            qs('#dash-treatments').textContent=treatments.filter(t=>t.status === 'In progress').length;
            const high=risks.filter(r=>rLevel(r.score)==='High').length;
            qs('#dash-high').textContent=high;
            const today=new Date();
            const overdue=issues.filter(i=>{
                if(!i.dueDate) return false;
                const d=new Date(i.dueDate);
                if(isNaN(d)) return false;
                const st=i.status||'';
                return st!=='Resolved' && st!=='Accepted' && d<today;
            }).length;
            qs('#dash-overdue').textContent=overdue;
            const ov=overallCoverage(computeGapRows());
            qs('#dash-coverage').textContent=ov+'%';
            updateCoveragePill(ov);
        }
        // ---------- Risk Matrix ----------
        let showResidual=false;
        const canvas=qs('#risk-matrix-canvas');
        const ctx=canvas.getContext('2d');
        const legend=qs('#matrix-legend');
        function residualForRisk(r){
            const impl=controls.filter(c=>c.status==='In place' && (c.linkedRiskIds||[]).includes(r.id));
            const dropL=Math.min(2,impl.length);
            const dropI=impl.some(c=>c.type==='Preventive' || c.type==='Corrective')?1:0;
            return { likelihood:Math.max(1,(r.likelihood||1)-dropL), impact:Math.max(1,(r.impact||1)-dropI) };
        }
        function drawMatrix(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const size=110, off=90;
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#f8f9fa');
            gradient.addColorStop(1, '#e9ecef');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Grid
            ctx.strokeStyle="#dee2e6";
            ctx.lineWidth=1;
            for(let i=0;i<=5;i++){
                ctx.beginPath();
                ctx.moveTo(off,off+i*size);
                ctx.lineTo(off+5*size,off+i*size);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(off+i*size,off);
                ctx.lineTo(off+i*size,off+5*size);
                ctx.stroke();
            }
            // Labels
            ctx.font="bold 14px Roboto";
            ctx.fillStyle="#495057";
            ctx.textAlign = 'center';
            ctx.fillText("Impact →",off+225,off-25);
            ctx.save();
            ctx.translate(off-55,off+240);
            ctx.rotate(-Math.PI/2);
            ctx.fillText("Likelihood →",0,0);
            ctx.restore();
            // Axis labels
            const labels = ['1', '2', '3', '4', '5'];
            labels.forEach((label, idx) => {
                ctx.fillText(label, off + (idx + 0.5) * size, canvas.height - 60); // Impact
                ctx.fillText(label, 40, off + (4.5 - idx) * size); // Likelihood (reversed)
            });
            // Legend
            let high=0,med=0,low=0;
            risks.forEach(r=>{
                let L=r.likelihood, I=r.impact, score=rScore(L,I), level=rLevel(score);
                if(showResidual){
                    L = r.resLikelihood || L;
                    I = r.resImpact || I;
                    score = rScore(L,I);
                    level = rLevel(score);
                }
                let color="#28a745";
                if(level==='High'){ color="#dc3545"; high++; }
                else if(level==='Medium'){ color="#ffc107"; med++; }
                else if(level==='Low'){ color="#28a745"; low++; }
                ctx.beginPath();
                ctx.arc(off+(I-0.5)*size,off+(5-L+0.5)*size,12,0,2*Math.PI);
                ctx.fillStyle=color;
                ctx.shadowColor = 'rgba(0,0,0,0.2)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.shadowColor = 'transparent';
                ctx.fillStyle="#fff";
                ctx.font="bold 12px Roboto";
                ctx.textAlign="center";
                ctx.textBaseline="middle";
                ctx.fillText(String(score),off+(I-0.5)*size,off+(5-L+0.5)*size);
            });
            legend.innerHTML = `<b>${risks.length}</b> risks — <span style="color:#dc3545">High: ${high}</span> | <span style="color:#ffc107">Medium: ${med}</span> | <span style="color:#28a745">Low: ${low}</span>`;
        }
        // ---------- Treatments ----------
        let currentTreatmentsPage = 1;
        function populateTreatmentDropdownLinked(){
            const sel=qs('#treat-linked');
            if(!sel) return;
            const cur=sel.value;
            sel.innerHTML='<option value="">Select risk or issue...</option>';
            risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title + ' (Risk)';sel.appendChild(o);});
            issues.forEach(i=>{const o=document.createElement('option');o.value=i.id;o.textContent=i.title + ' (Issue)';sel.appendChild(o);});
            if(cur) sel.value=cur;
        }
        function populateTreatmentDropdownControls(){
            const sel=qs('#treat-control');
            if(!sel) return;
            const cur=sel.value;
            sel.innerHTML='<option value="">Select control...</option>';
            controls.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o);});
            if(cur && controls.some(c=>c.id===cur)) sel.value=cur;
        }
        function renderTreatmentsTable(page = 1){
            currentTreatmentsPage = page;
            const tbody=qs('#treat-table-body'), empty=qs('#treat-empty'), count=qs('#treat-count');
            tbody.innerHTML='';
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedTreatments = treatments.slice(start, end);
            paginatedTreatments.forEach(t=>{
                let linkedName = '';
                if (t.linked) {
                    const r = risks.find(x => x.id === t.linked);
                    const i = issues.find(x => x.id === t.linked);
                    linkedName = r ? r.title + ' (Risk)' : i ? i.title + ' (Issue)' : '';
                }
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${t.title}</td>
                    <td>${linkedName || '-'}</td>
                    <td>${t.status}</td>
                    <td>${t.targetDate||''}</td>
                    <td>${t.owner||''}</td>
                    <td>${t.budget||''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mb-1" data-te="${t.id}">EDIT</button>
                        <button class="btn btn-sm btn-outline-danger mb-1" data-td="${t.id}">DEL</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            empty.style.display=treatments.length?'none':'block';
            count.textContent=`${treatments.length} treatment action(s)`;
            renderPagination('treatments-pagination', treatments.length, page, renderTreatmentsTable);
        }
        function resetTreatForm(){
            qs('#treat-form').reset();
            qs('#treat-id').value='';
            qs('#treat-submit').textContent='Save action';
        }
        qs('#treat-form').addEventListener('submit',e=>{
            e.preventDefault();
            const id=qs('#treat-id').value;
            const title=qs('#treat-title').value.trim();
            const linked=qs('#treat-linked').value;
            if(!title || !linked) return alert('Action title and linked risk/issue are required.');
            const controlId=qs('#treat-control').value || '';
            const obj={
                id:id || ('TRT-'+Date.now()),
                title,
                linked,
                controlId,
                status:qs('#treat-status').value,
                targetDate:qs('#treat-date').value,
                owner:qs('#treat-owner').value.trim(),
                budget:qs('#treat-budget').value.trim(),
                notes:qs('#treat-notes').value.trim()
            };
            const idx=treatments.findIndex(x=>x.id===obj.id);
            if(idx>-1) treatments[idx]=obj;
            else treatments.push(obj);
            save(K.treats,treatments);
            renderTreatmentsTable(currentTreatmentsPage);
            resetTreatForm();
            showToast('Treatment saved successfully');
        });
        qs('#treat-cancel').addEventListener('click',resetTreatForm);
        qs('#treat-table-body').addEventListener('click',e=>{
            const idE=e.target.getAttribute('data-te');
            const idD=e.target.getAttribute('data-td');
            if(idE){
                const t=treatments.find(x=>x.id===idE);
                if(!t) return;
                qs('#treat-id').value=t.id;
                qs('#treat-title').value=t.title;
                populateTreatmentDropdownLinked();
                populateTreatmentDropdownControls();
                qs('#treat-linked').value=t.linked||'';
                qs('#treat-control').value=t.controlId||'';
                qs('#treat-status').value=t.status||'Open';
                qs('#treat-date').value=t.targetDate||'';
                qs('#treat-owner').value=t.owner||'';
                qs('#treat-budget').value=t.budget||'';
                qs('#treat-notes').value=t.notes||'';
                qs('#treat-submit').textContent='Update action';
            }
            if(idD){
                if(!confirm('Delete this treatment action?')) return;
                treatments=treatments.filter(x=>x.id!==idD);
                save(K.treats,treatments);
                renderTreatmentsTable(currentTreatmentsPage);
                showToast('Treatment deleted');
            }
        });
        // ---------- CSV Export helpers ----------
        function escapeCSVVal(v){
            if(v==null) return '';
            const s = String(v);
            if(/[",\n]/.test(s)){
                return '"' + s.replace(/"/g,'""') + '"';
            }
            return s;
        }
        function downloadCSV(filename, rows, columns){
            const header = columns.map(c=>escapeCSVVal(c.header)).join(',');
            const lines = [header];
            rows.forEach(r=>{
                const vals = columns.map(c=>{
                    if(typeof c.value === 'function') return escapeCSVVal(c.value(r));
                    if(c.key) return escapeCSVVal(r[c.key]);
                    return '';
                });
                lines.push(vals.join(','));
            });
            const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href=url;
            a.download=filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        function exportAssetsCSV(){
            const cols = [
                {header:'Name', key:'name'},
                {header:'Type', key:'type'},
                {header:'Criticality', key:'criticality'},
                {header:'Owner', key:'owner'},
                {header:'Data types', value:a=>(a.dataTypes||[]).join('; ')},
                {header:'Location', key:'location'},
                {header:'Notes', key:'notes'}
            ];
            downloadCSV('grc_assets.csv', assets, cols);
        }
        function exportVendorsCSV(){
            const cols = [
                {header:'Name', key:'name'},
                {header:'Type', key:'type'},
                {header:'Criticality', key:'criticality'},
                {header:'Data Access', key:'dataAccess'},
                {header:'Contract Status', key:'contract'},
                {header:'Last Assessment', key:'assessment'},
                {header:'Notes', key:'notes'}
            ];
            downloadCSV('grc_vendors.csv', vendors, cols);
        }
        function exportRisksCSV(){
            const rows = (lastRiskView && lastRiskView.length) ? lastRiskView : risks;
            const cols = [
                {header:'Title', key:'title'},
                {header:'Linked', value:r=>r.linkedName||''},
                {header:'Category', key:'category'},
                {header:'Likelihood', key:'likelihood'},
                {header:'Impact', key:'impact'},
                {header:'Score', key:'score'},
                {header:'Level', value:r=>rLevel(r.score)},
                {header:'Res Likelihood', key:'resLikelihood'},
                {header:'Res Impact', key:'resImpact'},
                {header:'Res Score', key:'resScore'},
                {header:'Res Level', value:r=>rLevel(r.resScore)},
                {header:'Status', key:'status'},
                {header:'Owner', key:'owner'},
                {header:'Notes', key:'notes'}
            ];
            downloadCSV('grc_risks.csv', rows, cols);
        }
        function exportControlsCSV(){
            const cols = [
                {header:'Name', key:'name'},
                {header:'Type', key:'type'},
                {header:'Status', key:'status'},
                {header:'Owner', key:'owner'},
                {header:'Description', key:'description'},
                {header:'Linked risks count', value:c=>(c.linkedRiskIds||[]).length},
                {header:'Mapped framework ctrl count', value:c=>(c.linkedFrameworkControlIds||[]).length},
                {header:'Evidence', key:'evidence'}
            ];
            downloadCSV('grc_controls.csv', controls, cols);
        }
        function exportSoACSV(){
            const rows = FRAMEWORK_CONTROLS.map(fc=>{
                const entry = getSoAEntry(fc.id);
                const resolvedImpl = entry.implementation === 'Auto' ? autoImplForFrameworkControl(fc.id) : entry.implementation;
                const mapped = controls
                    .filter(c => Array.isArray(c.linkedFrameworkControlIds) && c.linkedFrameworkControlIds.includes(fc.id))
                    .map(c => c.name)
                    .join('; ');
                return {
                    id: fc.id,
                    name: fc.name,
                    category: fc.category,
                    frameworks: (fc.frameworks||[]).join('; '),
                    applicability: entry.applicability || 'Applicable',
                    implementation_selected: entry.implementation || 'Auto',
                    implementation_resolved: resolvedImpl,
                    mapped_local_controls: mapped,
                    owner: entry.owner || '',
                    rationale: entry.rationale || '',
                    evidence: entry.evidence || ''
                };
            });
            const cols = [
                {header:'Framework Control ID', key:'id'},
                {header:'Name', key:'name'},
                {header:'Category', key:'category'},
                {header:'Frameworks', key:'frameworks'},
                {header:'Applicability', key:'applicability'},
                {header:'Implementation (Selected)', key:'implementation_selected'},
                {header:'Implementation (Resolved)', key:'implementation_resolved'},
                {header:'Mapped Local Controls', key:'mapped_local_controls'},
                {header:'Owner', key:'owner'},
                {header:'Rationale', key:'rationale'},
                {header:'Evidence URLs', key:'evidence'}
            ];
            downloadCSV('grc_soa.csv', rows, cols);
        }
        function exportIssuesCSV(){
            const cols = [
                {header:'Title', key:'title'},
                {header:'Type', key:'type'},
                {header:'Severity', key:'severity'},
                {header:'Status', key:'status'},
                {header:'Owner', key:'owner'},
                {header:'Due date', key:'dueDate'},
                {header:'Linked', key:'linkedSummary'},
                {header:'Notes', key:'notes'}
            ];
            downloadCSV('grc_issues.csv', issues, cols);
        }
        function exportIncidentsCSV(){
            const cols = [
                {header:'Title', key:'title'},
                {header:'Type', key:'type'},
                {header:'Detected', key:'detected'},
                {header:'Severity', key:'severity'},
                {header:'Status', key:'status'},
                {header:'Owner', key:'owner'},
                {header:'Linked', key:'linkedSummary'},
                {header:'Notes', key:'notes'}
            ];
            downloadCSV('grc_incidents.csv', incidents, cols);
        }
        function exportTreatmentsCSV(){
            const cols = [
                {header:'Title', key:'title'},
                {header:'Linked', value:t=>{
                    const r = risks.find(x => x.id === t.linked);
                    const i = issues.find(x => x.id === t.linked);
                    return r ? r.title + ' (Risk)' : i ? i.title + ' (Issue)' : '';
                }},
                {header:'Control', value:t=>{
                    const c=controls.find(x=>x.id===t.controlId);
                    return c?c.name:'';
                }},
                {header:'Status', key:'status'},
                {header:'Target date', key:'targetDate'},
                {header:'Owner', key:'owner'},
                {header:'Budget', key:'budget'},
                {header:'Notes', key:'notes'}
            ];
            downloadCSV('grc_treatments.csv', treatments, cols);
        }
        // ---------- Export / Import / Demo / Reset ----------
        function setImportStatus(msg,err){
            const el=qs('#import-status');
            el.textContent=msg||'';
            el.style.color=err?'#dc3545':'#6c757d';
        }
        function exportScenario(){
            const payload={ version:4, exportedAt:new Date().toISOString(), assets,risks,controls,issues,treatments,soa,vendors,incidents };
            const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;
            a.download=`grc-lab-scenario-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            setImportStatus('Exported current data as JSON.',false);
        }
        function importScenarioFile(file){
            if(!file) return;
            const reader=new FileReader();
            reader.onload=e=>{
                try{
                    const data=JSON.parse(e.target.result);
                    assets = Array.isArray(data.assets)?data.assets:[];
                    risks = Array.isArray(data.risks)?data.risks:[];
                    controls = Array.isArray(data.controls)?data.controls:[];
                    issues = Array.isArray(data.issues)?data.issues:[];
                    treatments = Array.isArray(data.treatments)?data.treatments:[];
                    soa = Array.isArray(data.soa)?data.soa:[];
                    vendors = Array.isArray(data.vendors)?data.vendors:[];
                    incidents = Array.isArray(data.incidents)?data.incidents:[];
                    save(K.assets,assets);
                    save(K.risks,risks);
                    save(K.controls,controls);
                    save(K.issues,issues);
                    save(K.treats,treatments);
                    save(K.soa,soa);
                    save(K.vendors,vendors);
                    save(K.incidents,incidents);
                    refreshAll();
                    setImportStatus(`Imported scenario: ${assets.length} assets, ${vendors.length} vendors, ${risks.length} risks, ${controls.length} controls, ${issues.length} issues, ${incidents.length} incidents, ${treatments.length} actions, ${soa.length} SoA entries.`,false);
                }catch(err){
                    console.error(err);
                    setImportStatus('Failed to import scenario. Check JSON file.',true);
                }
            };
            reader.onerror=()=>setImportStatus('Failed to read file.',true);
            reader.readAsText(file);
        }
        function loadDemoScenario(){
            assets = [
                {id:"AST-DEMO-APP",name:"MediCloud Web Application",type:"Application",criticality:"High",dataTypes:["PHI","PII","Card data"],owner:"DevOps Team",location:"AWS US-East-1",notes:"Main patient portal app, integrates with billing system", tags:["cloud","web"]},
                {id:"AST-DEMO-DB",name:"MediCloud Database",type:"Database",criticality:"High",dataTypes:["PHI","PII"],owner:"DBA Team",location:"AWS RDS",notes:"Stores patient records, encrypted", tags:["cloud","data"]},
                {id:"AST-DEMO-SERVER",name:"Internal File Server",type:"Server / Host",criticality:"Medium",dataTypes:["Internal data"],owner:"IT Ops",location:"On-prem",notes:"Employee files, access controlled", tags:["onprem"]},
                {id:"AST-DEMO-NET",name:"Network Firewall",type:"Network / Security Device",criticality:"High",dataTypes:[],owner:"Network Team",location:"Data Center",notes:"Protects perimeter", tags:["security"]},
                {id:"AST-DEMO-CLOUD",name:"Cloud Storage",type:"Cloud Service",criticality:"Medium",dataTypes:["Internal data"],owner:"Cloud Admin",location:"Azure West US",notes:"Backup storage", tags:["cloud"]},
            ];
            vendors = [
                {id:"VND-DEMO-AWS",name:"AWS",type:"Cloud Provider",criticality:"High",dataAccess:"Full",contract:"Active",assessment:"2025-01-01",notes:"Cloud hosting for app and DB", tags:["cloud"]},
                {id:"VND-DEMO-OKTA",name:"Okta",type:"SaaS",criticality:"Medium",dataAccess:"Read",contract:"Active",assessment:"2025-06-01",notes:"Identity management", tags:["iam"]},
                {id:"VND-DEMO-SLACK",name:"Slack",type:"SaaS",criticality:"Low",dataAccess:"None",contract:"Active",assessment:"2024-12-01",notes:"Team communication", tags:["comm"]},
                {id:"VND-DEMO-MICROSOFT",name:"Microsoft",type:"Cloud Provider",criticality:"High",dataAccess:"Full",contract:"Active",assessment:"2025-03-01",notes:"Office 365 and Azure", tags:["cloud"]},
                {id:"VND-DEMO-GOOGLE",name:"Google",type:"SaaS",criticality:"Medium",dataAccess:"Read/Write",contract:"Pending",assessment:"2025-02-01",notes:"Analytics and ads", tags:["analytics"]},
            ];
            risks = [
                {id:"RSK-DEMO-1",title:"Unauthorised access to MediCloud production",linked:"asset-AST-DEMO-APP",linkedType:"asset",linkedId:"AST-DEMO-APP",linkedName:"MediCloud Web Application",category:"Cybersecurity",likelihood:4,impact:5,score:20,resLikelihood:2,resImpact:4,resScore:8,status:"In progress",owner:"CISO",notes:"Potential data breach", tags:["access"]},
                {id:"RSK-DEMO-2",title:"Data leakage from database",linked:"asset-AST-DEMO-DB",linkedType:"asset",linkedId:"AST-DEMO-DB",linkedName:"MediCloud Database",category:"Privacy",likelihood:3,impact:5,score:15,resLikelihood:1,resImpact:5,resScore:5,status:"Open",owner:"DBA",notes:"Sensitive PHI exposure", tags:["data"]},
                {id:"RSK-DEMO-3",title:"Vendor data breach (AWS)",linked:"vendor-VND-DEMO-AWS",linkedType:"vendor",linkedId:"VND-DEMO-AWS",linkedName:"AWS",category:"Third-Party",likelihood:2,impact:5,score:10,resLikelihood:1,resImpact:4,resScore:4,status:"Accepted",owner:"Compliance",notes:"Cloud provider incident", tags:["vendor"]},
                {id:"RSK-DEMO-4",title:"Insider threat via file server",linked:"asset-AST-DEMO-SERVER",linkedType:"asset",linkedId:"AST-DEMO-SERVER",linkedName:"Internal File Server",category:"Operational",likelihood:3,impact:3,score:9,resLikelihood:2,resImpact:2,resScore:4,status:"Mitigated",owner:"HR",notes:"Employee data access", tags:["insider"]},
                {id:"RSK-DEMO-5",title:"Phishing attack on users",linked:"asset-AST-DEMO-APP",linkedType:"asset",linkedId:"AST-DEMO-APP",linkedName:"MediCloud Web Application",category:"Cybersecurity",likelihood:4,impact:4,score:16,resLikelihood:3,resImpact:3,resScore:9,status:"In progress",owner:"Security Team",notes:"User credentials compromise", tags:["phishing"]},
                {id:"RSK-DEMO-6",title:"Network intrusion via firewall misconfig",linked:"asset-AST-DEMO-NET",linkedType:"asset",linkedId:"AST-DEMO-NET",linkedName:"Network Firewall",category:"Cybersecurity",likelihood:3,impact:5,score:15,resLikelihood:1,resImpact:4,resScore:4,status:"Open",owner:"Network Team",notes:"Potential unauthorized access", tags:["network"]},
                {id:"RSK-DEMO-7",title:"Data loss in cloud storage",linked:"asset-AST-DEMO-CLOUD",linkedType:"asset",linkedId:"AST-DEMO-CLOUD",linkedName:"Cloud Storage",category:"Operational",likelihood:2,impact:4,score:8,resLikelihood:1,resImpact:3,resScore:3,status:"Mitigated",owner:"Cloud Admin",notes:"Backup failure", tags:["cloud"]},
            ];
            controls = [
                {id:"CTL-DEMO-MFA",name:"Multi-factor authentication for admins",type:"Preventive",status:"In place",owner:"DevSecOps",description:"Enforce MFA for all admin accounts",linkedRiskIds:["RSK-DEMO-1","RSK-DEMO-5"],linkedFrameworkControlIds:["CTRL-5.17","CTRL-8.5"],evidence:"Okta dashboard screenshot", tags:["iam"]},
                {id:"CTL-DEMO-ENC",name:"Data encryption at rest",type:"Technical",status:"In place",owner:"DBA",description:"Encrypt database with AES-256",linkedRiskIds:["RSK-DEMO-2"],linkedFrameworkControlIds:["CTRL-8.24"],evidence:"AWS RDS config", tags:["encryption"]},
                {id:"CTL-DEMO-VRA",name:"Vendor risk assessment",type:"Administrative",status:"Planned",owner:"Compliance",description:"Annual vendor reviews",linkedRiskIds:["RSK-DEMO-3"],linkedFrameworkControlIds:["CTRL-5.19","CTRL-5.21"],evidence:"Assessment report template", tags:["vendor"]},
                {id:"CTL-DEMO-LOG",name:"Centralized logging and monitoring",type:"Detective",status:"In place",owner:"Security Team",description:"SIEM for all systems",linkedRiskIds:["RSK-DEMO-1","RSK-DEMO-4"],linkedFrameworkControlIds:["CTRL-8.15","CTRL-8.16"],evidence:"Splunk setup", tags:["monitoring"]},
                {id:"CTL-DEMO-TRAIN",name:"Security awareness training",type:"Preventive",status:"In place",owner:"HR",description:"Quarterly phishing simulations",linkedRiskIds:["RSK-DEMO-5"],linkedFrameworkControlIds:["CTRL-6.3"],evidence:"Training records", tags:["training"]},
                {id:"CTL-DEMO-FIREWALL",name:"Firewall configuration management",type:"Technical",status:"In place",owner:"Network Team",description:"Regular review of firewall rules",linkedRiskIds:["RSK-DEMO-6"],linkedFrameworkControlIds:["CTRL-8.20"],evidence:"Firewall logs", tags:["network"]},
                {id:"CTL-DEMO-BACKUP",name:"Automated backup and recovery",type:"Corrective",status:"Planned",owner:"Cloud Admin",description:"Daily backups with testing",linkedRiskIds:["RSK-DEMO-7"],linkedFrameworkControlIds:["CTRL-8.13"],evidence:"Backup policy", tags:["recovery"]},
            ];
            issues = [
                {id:"ISS-DEMO-1",title:"Missing MFA on dev accounts",type:"Audit",severity:"High",status:"Open",owner:"Dev Lead",dueDate:"2025-12-31",notes:"From internal audit",assetId:"AST-DEMO-APP",vendorId:"",riskId:"RSK-DEMO-1",controlId:"CTL-DEMO-MFA",linkedSummary:"Asset: MediCloud Web Application | Risk: Unauthorised access to MediCloud production | Control: Multi-factor authentication for admins", tags:["audit"]},
                {id:"ISS-DEMO-2",title:"Outdated encryption keys",type:"Vulnerability Scan",severity:"Medium",status:"In progress",owner:"DBA",dueDate:"2025-11-15",notes:"Rotate keys",assetId:"AST-DEMO-DB",vendorId:"",riskId:"RSK-DEMO-2",controlId:"",linkedSummary:"Asset: MediCloud Database | Risk: Data leakage from database", tags:["vuln"]},
                {id:"ISS-DEMO-3",title:"Vendor contract expired",type:"Self-Assessment",severity:"Low",status:"Resolved",owner:"Compliance",dueDate:"2025-10-01",notes:"Renewed",assetId:"",vendorId:"VND-DEMO-SLACK",riskId:"",controlId:"",linkedSummary:"Vendor: Slack", tags:["vendor"]},
                {id:"ISS-DEMO-4",title:"Firewall rule anomaly",type:"Pen test",severity:"High",status:"Open",owner:"Network Lead",dueDate:"2025-11-30",notes:"Unexpected open ports",assetId:"AST-DEMO-NET",vendorId:"",riskId:"RSK-DEMO-6",controlId:"CTL-DEMO-FIREWALL",linkedSummary:"Asset: Network Firewall | Risk: Network intrusion via firewall misconfig | Control: Firewall configuration management", tags:["pen"]},
            ];
            incidents = [
                {id:"INC-DEMO-1",title:"Suspected phishing attempt",type:"Phishing",detected:"2025-10-01",severity:"Medium",status:"Contained",owner:"IR Team",notes:"User reported suspicious email",assetId:"AST-DEMO-APP",vendorId:"",riskId:"RSK-DEMO-5",controlId:"CTL-DEMO-TRAIN",linkedSummary:"Asset: MediCloud Web Application | Risk: Phishing attack on users | Control: Security awareness training", tags:["incident"]},
                {id:"INC-DEMO-2",title:"Database outage",type:"Denial of Service",detected:"2025-09-15",severity:"High",status:"Recovered",owner:"DBA",notes:"DDoS attack mitigated",assetId:"AST-DEMO-DB",vendorId:"VND-DEMO-AWS",riskId:"RSK-DEMO-2",controlId:"CTL-DEMO-ENC",linkedSummary:"Asset: MediCloud Database | Vendor: AWS | Risk: Data leakage from database | Control: Data encryption at rest", tags:["outage"]},
                {id:"INC-DEMO-3",title:"Unauthorized network access attempt",type:"Malware",detected:"2025-10-20",severity:"Critical",status:"Investigating",owner:"Security Team",notes:"Suspicious traffic detected",assetId:"AST-DEMO-NET",vendorId:"",riskId:"RSK-DEMO-6",controlId:"CTL-DEMO-LOG",linkedSummary:"Asset: Network Firewall | Risk: Network intrusion via firewall misconfig | Control: Centralized logging and monitoring", tags:["intrusion"]},
            ];
            treatments = [
                {id:"TRT-DEMO-1",title:"Implement MFA for all users",linked:"RSK-DEMO-1",controlId:"CTL-DEMO-MFA",status:"In progress",targetDate:"2025-12-01",owner:"DevOps Lead",budget:"1000 USD",notes:"Roll out Okta MFA", tags:["iam"]},
                {id:"TRT-DEMO-2",title:"Key rotation procedure",linked:"ISS-DEMO-2",controlId:"",status:"Open",targetDate:"2025-11-30",owner:"DBA",budget:"",notes:"Automate key rotation", tags:["encryption"]},
                {id:"TRT-DEMO-3",title:"Vendor reassessment",linked:"RSK-DEMO-3",controlId:"CTL-DEMO-VRA",status:"Closed",targetDate:"2025-10-15",owner:"Compliance",budget:"500 USD",notes:"Completed review", tags:["vendor"]},
                {id:"TRT-DEMO-4",title:"Firewall rule audit",linked:"ISS-DEMO-4",controlId:"CTL-DEMO-FIREWALL",status:"In progress",targetDate:"2025-12-15",owner:"Network Lead",budget:"800 USD",notes:"Review and update rules", tags:["network"]},
            ];
            soa = FRAMEWORK_CONTROLS.map(fc => ({ fcId: fc.id, applicability: 'Applicable', implementation: 'Auto', owner: '', rationale: '', evidence: '' }));
            save(K.assets,assets);
            save(K.vendors,vendors);
            save(K.risks,risks);
            save(K.controls,controls);
            save(K.issues,issues);
            save(K.incidents,incidents);
            save(K.treats,treatments);
            save(K.soa,soa);
            refreshAll();
            setImportStatus('Loaded full demo scenario (MediCloud Healthcare App). Explore tabs!',false);
        }
        function loadISOTemplate(){
            controls = [];
            soa = [];
            controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("ISO 27001")).map(fc => ({
                id: 'CTL-ISO-' + fc.id.split('-')[1],
                name: fc.name,
                type: "Technical",
                status: "Planned",
                owner: "Security Team",
                description: fc.description,
                linkedRiskIds: [],
                linkedFrameworkControlIds: [fc.id],
                evidence: ""
            }));
            soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("ISO 27001")).map(fc => ({
                fcId: fc.id,
                applicability: 'Applicable',
                implementation: 'Auto',
                owner: '',
                rationale: '',
                evidence: ''
            }));
            save(K.controls,controls);
            save(K.soa,soa);
            refreshAll();
            showToast('Loaded ISO 27001 template');
        }
        // Similar functions for other templates: loadNISTTemplate, loadPCITemplate, loadHIPAATemplate - clear and load specific

        function resetLab(){
            if(!confirm('This will clear all data in this browser. Continue?')) return;
            assets=[];risks=[];controls=[];issues=[];treatments=[];soa=[];vendors=[];incidents=[];
            Object.values(K).forEach(k=>localStorage.removeItem(k));
            localStorage.removeItem(RISK_CFG_KEY);
            riskConfig = {...defaultRiskConfig};
            refreshAll();
            syncRiskThresholdInputs();
            setImportStatus('Lab reset: all data cleared from this browser.',false);
        }
        // ---------- Tabs ----------
        function bindTabs(){
            const buttons=qsa('[data-grc-tab]');
            const mapping={};
            ['guidance','frameworks','assets','vendors','risks','controls','issues','incidents','treatments','gap','soa','dashboard','matrix','summary','reports','challenges']
            .forEach(id=>mapping[id]=qs('#tab-'+id));
            buttons.forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const tgt=btn.getAttribute('data-grc-tab');
                    buttons.forEach(b=>{
                        b.classList.remove('btn-primary');
                        b.classList.add('btn-outline-primary');
                    });
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-outline-primary');
                    Object.values(mapping).forEach(el=>el && el.classList.remove('active'));
                    if(mapping[tgt]) mapping[tgt].classList.add('active');
                    if(tgt==='dashboard') renderDashboard();
                    if(tgt==='gap') renderGapTable();
                    if(tgt==='matrix') drawMatrix();
                    if(tgt==='summary') generateAuditorSummary();
                    if(tgt==='soa') renderSoATable();
                    if(tgt==='reports') generateReport();
                });
            });
        }
        // ---------- Auditor-style Summary ----------
        function listPhrase(items,max){
            if(!items || !items.length) return '';
            const arr=items.slice(0,max);
            if(arr.length===1) return arr[0];
            if(arr.length===2) return `${arr[0]} and ${arr[1]}`;
            return `${arr.slice(0,-1).join(', ')} and ${arr[arr.length-1]}`;
        }
        function generateAuditorSummary(){
            const lines=[];
            const totalAssets=assets.length;
            const highAssets=assets.filter(a=>a.criticality==='High');
            const assetNames=assets.map(a=>a.name);
            const keyAssets=listPhrase(highAssets.map(a=>a.name),3) || listPhrase(assetNames,3) || 'key information assets';
            lines.push(`# Scope and context\nThe organisation is using the GRC Practice Lab to model approximately ${totalAssets||'0'} key information assets and services. High-criticality assets currently include ${keyAssets}.`);
            const totalVendors=vendors.length;
            const highVendors=vendors.filter(v=>v.criticality==='High');
            lines.push(`There are ${totalVendors} vendors tracked, with ${highVendors.length} high criticality.`);
            const totalRisks=risks.length;
            const highRisks=risks.filter(r=>rLevel(r.score)==='High');
            const medRisks=risks.filter(r=>rLevel(r.score)==='Medium');
            const exHigh=highRisks.slice(0,2).map(r=>{ const linkedName=r.linkedName ? ` (${r.linkedName})` : ''; return `${r.title}${linkedName}, score ${r.score}`; });
            let riskPara=`# Risk Register\nA total of ${totalRisks||'0'} risks have been documented in the register. `;
            riskPara+=`High risks: ${highRisks.length}; medium risks: ${medRisks.length}; remaining items are low or informational. `;
            if(exHigh.length){
                riskPara+=`Example high risks include ${listPhrase(exHigh,2)}.`;
            }
            lines.push(riskPara.trim());
            const rows=computeGapRows();
            const overall=overallCoverage(rows);
            const ctrlCount=controls.length;
            const catSnippets=rows.slice(0,4).map(r=>{ const pct=r.total?Math.round((r.implemented/r.total)*100):0; return `${r.category}: ${pct}% implemented (${r.implemented}/${r.total}).`; });
            let ctrlPara=`# Control environment and framework coverage\nLocal controls defined in the lab: ${ctrlCount}. Overall implemented coverage across the paraphrased framework library is approximately ${overall}% of ${FRAMEWORK_CONTROLS.length} controls. `;
            if(catSnippets.length){
                ctrlPara+=`Coverage by category (sample): ${catSnippets.join(' ')}`;
            }
            lines.push(ctrlPara.trim());
            const openIssues=issues.filter(i=>i.status==='Open' || i.status==='In progress');
            const critIssues=issues.filter(i=>i.severity==='Critical' || i.severity==='High');
            const exIssue=openIssues.slice(0,2).map(i=>i.title);
            const openIncidents=incidents.filter(inc=>inc.status !== 'Closed');
            const critIncidents=incidents.filter(inc=>inc.severity==='Critical' || inc.severity==='High');
            const openActions=treatments.filter(t=>t.status==='Open' || t.status==='In progress');
            const closedActions=treatments.filter(t=>t.status==='Closed');
            let issuePara=`# Issues, findings, incidents and action plans\nThere are ${issues.length} issue(s) recorded in the log, of which ${openIssues.length} are open or in progress and ${critIssues.length} are rated high or critical. `;
            if(exIssue.length){
                issuePara+=`Example open items include ${listPhrase(exIssue,2)}. `;
            }
            issuePara+=`There are ${incidents.length} incidents, with ${openIncidents.length} open and ${critIncidents.length} critical/high. `;
            issuePara+=`The treatment register currently contains ${treatments.length} action item(s), with ${openActions.length} open/in progress and ${closedActions.length} closed.`;
            lines.push(issuePara.trim());
            const highCount=highRisks.length;
            const ov=overallCoverage(computeGapRows());
            const covDesc=ov>=80?'strong, with most key controls implemented': ov>=50?'developing, with several controls implemented but notable gaps remaining': ov>0?'limited, with many controls still to be implemented': 'minimal, with framework controls largely not implemented yet';
            let obs=`# Overall observation\nSeveral high-impact risks have been identified${highCount?` (currently ${highCount} high-rated risk(s))`:''}. Control coverage is ${ov}% and is best described as ${covDesc}. `;
            if(openActions.length){
                obs+=`A formal treatment plan is in place, with ${openActions.length} active remediation action(s) tracked against the risk register.`;
            }else{
                obs+=`No active treatment actions are currently recorded against the risk register.`;
            }
            lines.push(obs.trim());
            qs('#summary-text').value = lines.join('\n\n');
        }
        // ---------- Reports ----------
        function generateReport(){
            const type = qs('#report-type').value;
            let content = '';
            switch(type){
                case 'full-audit':
                    content = generateFullAuditReport();
                    break;
                case 'risk-register':
                    content = generateRiskRegisterReport();
                    break;
                case 'control-coverage':
                    content = generateControlCoverageReport();
                    break;
                case 'issue-summary':
                    content = generateIssueSummaryReport();
                    break;
                case 'vendor-report':
                    content = generateVendorReport();
                    break;
                case 'incident-report':
                    content = generateIncidentReport();
                    break;
            }
            qs('#report-text').value = content;
        }
        function generateFullAuditReport(){
            let report = '# Full Audit Report\n\n';
            report += qs('#summary-text').value; // Include auditor summary
            report += '\n\n## Risk Register\n' + generateRiskRegisterReport(false);
            report += '\n\n## Control Coverage\n' + generateControlCoverageReport(false);
            report += '\n\n## Issue Summary\n' + generateIssueSummaryReport(false);
            report += '\n\n## Vendor Risk\n' + generateVendorReport(false);
            report += '\n\n## Incident Log\n' + generateIncidentReport(false);
            return report;
        }
        function generateRiskRegisterReport(full = true){
            let report = full ? '# Risk Register Report\n\n' : '';
            risks.forEach(r => {
                report += `### ${r.title}\n`;
                report += `- Linked: ${r.linkedName || '-'}\n`;
                report += `- Category: ${r.category}\n`;
                report += `- Inherent Score: ${r.score} (${rLevel(r.score)})\n`;
                report += `- Residual Score: ${r.resScore} (${rLevel(r.resScore)})\n`;
                report += `- Status: ${r.status}\n`;
                report += `- Notes: ${r.notes || '-'}\n\n`;
            });
            return report;
        }
        function generateControlCoverageReport(full = true){
            let report = full ? '# Control Coverage Report\n\n' : '';
            const rows = computeGapRows();
            rows.forEach(r => {
                const pct = r.total ? Math.round((r.implemented / r.total) * 100) : 0;
                report += `### ${r.category}\n`;
                report += `- Total: ${r.total}\n`;
                report += `- Implemented: ${r.implemented}\n`;
                report += `- Planned: ${r.plannedOnly}\n`;
                report += `- Not Implemented: ${r.notImplemented}\n`;
                report += `- Coverage: ${pct}%\n\n`;
            });
            return report;
        }
        function generateIssueSummaryReport(full = true){
            let report = full ? '# Issue Summary Report\n\n' : '';
            issues.forEach(i => {
                report += `### ${i.title}\n`;
                report += `- Type: ${i.type}\n`;
                report += `- Severity: ${i.severity}\n`;
                report += `- Status: ${i.status}\n`;
                report += `- Linked: ${i.linkedSummary || '-'}\n`;
                report += `- Due: ${i.dueDate || '-'}\n`;
                report += `- Notes: ${i.notes || '-'}\n\n`;
            });
            return report;
        }
        function generateVendorReport(full = true){
            let report = full ? '# Vendor Risk Report\n\n' : '';
            vendors.forEach(v => {
                report += `### ${v.name}\n`;
                report += `- Type: ${v.type}\n`;
                report += `- Criticality: ${v.criticality}\n`;
                report += `- Data Access: ${v.dataAccess || '-'}\n`;
                report += `- Contract: ${v.contract || '-'}\n`;
                report += `- Last Assessment: ${v.assessment || '-'}\n`;
                report += `- Notes: ${v.notes || '-'}\n\n`;
            });
            return report;
        }
        function generateIncidentReport(full = true){
            let report = full ? '# Incident Log Report\n\n' : '';
            incidents.forEach(inc => {
                report += `### ${inc.title}\n`;
                report += `- Type: ${inc.type}\n`;
                report += `- Detected: ${inc.detected}\n`;
                report += `- Severity: ${inc.severity}\n`;
                report += `- Status: ${inc.status}\n`;
                report += `- Linked: ${inc.linkedSummary || '-'}\n`;
                report += `- Notes: ${inc.notes || '-'}\n\n`;
            });
            return report;
        }
        function downloadMD(filename, content){
            const blob = new Blob([content], {type:'text/markdown;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        qs('#report-export-md').addEventListener('click', () => downloadMD('grc_report.md', qs('#report-text').value));
        qs('#summary-export-md').addEventListener('click', () => downloadMD('auditor_summary.md', qs('#summary-text').value));
        // PDF export
        function generatePDF(content, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const lines = doc.splitTextToSize(content, 180);
            doc.text(lines, 10, 10);
            doc.save(filename);
        }
        qs('#report-export-pdf').addEventListener('click', () => generatePDF(qs('#report-text').value, 'grc_report.pdf'));
        qs('#summary-export-pdf').addEventListener('click', () => generatePDF(qs('#summary-text').value, 'auditor_summary.pdf'));
        // ---------- Refresh all ----------
        function refreshAll(){
            renderFrameworkControls();
            renderAssetsTable();
            renderVendorsTable();
            renderRisksTable();
            populateControlFrameworks();
            renderControlsTable();
            populateIssueDropdowns();
            renderIssuesTable();
            renderIncidentsTable();
            renderGapTable();
            renderDashboard();
            populateTreatmentDropdownLinked();
            populateTreatmentDropdownControls();
            renderTreatmentsTable();
            drawMatrix();
            generateAuditorSummary();
            renderSoATable();
        }
        // ---------- Init ----------
        document.addEventListener('DOMContentLoaded',()=>{
            ['#framework-filter','#category-filter','#framework-search'].forEach(sel=>{
                const el=qs(sel);
                if(!el) return;
                el.addEventListener(sel==='#framework-search'?'input':'change',renderFrameworkControls);
            });
            ['#soa-framework-filter', '#soa-category-filter', '#soa-applicability-filter', '#soa-implementation-filter'].forEach(sel => {
                const el = qs(sel);
                if (el) el.addEventListener('change', renderSoATable);
            });
            bindTabs();
            populateControlFrameworks();
            populateControlRisks();
            populateRiskAssetOptions();
            populateIssueDropdowns();
            populateTreatmentDropdownLinked();
            populateTreatmentDropdownControls();
            qs('#btn-export').addEventListener('click',exportScenario);
            qs('#btn-import').addEventListener('click',()=>{
                setImportStatus('',false);
                const f=qs('#file-import');
                f.value='';
                f.click();
            });
            qs('#file-import').addEventListener('change',e=>{
                const file=e.target.files && e.target.files[0];
                if(file) importScenarioFile(file);
            });
            qs('#btn-load-demo').addEventListener('click',()=>{
                if(!confirm('Loading the demo will overwrite current lab data in this browser. Continue?')) return;
                loadDemoScenario();
            });
            qs('#btn-reset').addEventListener('click',resetLab);
            qs('#toggle-inherent').addEventListener('click',()=>{
                showResidual=false;
                qs('#toggle-inherent').classList.add('btn-primary');
                qs('#toggle-residual').classList.remove('btn-primary');
                drawMatrix();
            });
            qs('#toggle-residual').addEventListener('click',()=>{
                showResidual=true;
                qs('#toggle-residual').classList.add('btn-primary');
                qs('#toggle-inherent').classList.remove('btn-primary');
                drawMatrix();
            });
            qs('#matrix-export').addEventListener('click',()=>{
                const a=document.createElement('a');
                a.download='risk_matrix.png';
                a.href=canvas.toDataURL('image/png');
                a.click();
            });
            qs('#summary-refresh').addEventListener('click',generateAuditorSummary);
            qs('#summary-copy').addEventListener('click', () => {
                const text = qs('#summary-text');
                text.select();
                document.execCommand('copy');
                showToast('Copied to clipboard');
            });
            qs('#generate-report').addEventListener('click', generateReport);
            qs('#soa-export').addEventListener('click', exportSoACSV);
            // CSV buttons
            qs('#export-assets').addEventListener('click', exportAssetsCSV);
            qs('#export-vendors').addEventListener('click', exportVendorsCSV);
            qs('#export-risks').addEventListener('click', exportRisksCSV);
            qs('#export-controls').addEventListener('click', exportControlsCSV);
            qs('#export-issues').addEventListener('click', exportIssuesCSV);
            qs('#export-incidents').addEventListener('click', exportIncidentsCSV);
            qs('#export-treatments').addEventListener('click', exportTreatmentsCSV);
            // Threshold inputs
            qs('#risk-thres-high').addEventListener('change', applyRiskThresholdInputs);
            qs('#risk-thres-med').addEventListener('change', applyRiskThresholdInputs);
            qs('#risk-thres-reset').addEventListener('click', ()=>{
                riskConfig = {...defaultRiskConfig};
                saveRiskConfig(riskConfig);
                syncRiskThresholdInputs();
                renderRisksTable();
                drawMatrix();
                renderDashboard();
            });
            qs('#risk-filter-status').addEventListener('change', ()=>{
                riskFilterStatus = qs('#risk-filter-status').value;
                renderRisksTable();
            });
            qs('#risk-filter-level').addEventListener('change', ()=>{
                riskFilterLevel = qs('#risk-filter-level').value;
                renderRisksTable();
            });
            qs('#risk-filter-category').addEventListener('change', ()=>{
                riskFilterCategory = qs('#risk-filter-category').value;
                renderRisksTable();
            });
            qs('#risk-sort-field').addEventListener('change', ()=>{
                riskSortField = qs('#risk-sort-field').value || 'score';
                renderRisksTable();
            });
            qs('#risk-sort-dir').addEventListener('change', ()=>{
                riskSortDir = qs('#risk-sort-dir').value || 'desc';
                renderRisksTable();
            });
            // Template buttons
            qs('#load-iso-template').addEventListener('click', loadISOTemplate);
            qs('#load-nist-template').addEventListener('click', loadNISTTemplate);
            qs('#load-pci-template').addEventListener('click', loadPCITemplate);
            qs('#load-hipaa-template').addEventListener('click', loadHIPAATemplate);
            // sync thresholds into inputs
            syncRiskThresholdInputs();
            refreshAll();
        });
        // Challenge scoring (stub, implement as needed)
        function scoreChallenge(num){
            // Implement scoring logic based on current data
            let score = 0;
            // For example, for challenge 1
            if(num === 1){
                if(assets.length >= 2) score++;
                if(risks.length >= 5) score++;
                if(controls.length >= 3) score++;
                if(overallCoverage(computeGapRows()) >= 60) score++;
            }
            // Similar for others
            qs(`#challenge-${num}-score`).textContent = `${score}/5`;
        }
    </script>
</body>
</html>
