    <script>
        // ===== CORE APPLICATION =====

        // ---------- Expanded Framework library (over 200 paraphrased controls) ----------
        const FRAMEWORK_CONTROLS = [
            // ISO 27001 Annex A controls (93 controls)
            {id:"CTRL-5.1",name:"Policies for information security",category:"Organisational Controls",
              description:"Information security policy and topic-specific policies shall be defined, approved by management, published, communicated to and acknowledged by relevant personnel and relevant interested parties, and reviewed at planned intervals and if significant changes occur.",
              frameworks:["ISO 27001"],references:["ISO 27001 A.5.1"]},
            {id:"CTRL-5.2",name:"Information security roles and responsibilities",category:"Organisational Controls",
              description:"Information security roles and responsibilities shall be defined and allocated according to the organization needs.",
              frameworks:["ISO 27001"],references:["ISO 27001 A.5.2"]},
            {id:"CTRL-5.3",name:"Segregation of duties",category:"Organisational Controls",
              description:"Conflicting duties and conflicting areas of responsibility shall be segregated.",
              frameworks:["ISO 27001"],references:["ISO 27001 A.5.3"]},
            {id:"CTRL-5.4",name:"Management responsibilities",category:"Organisational Controls",
              description:"Management shall require all personnel to apply information security in accordance with the established information security policy, topic-specific policies and procedures of the organization.",
              frameworks:["ISO 27001"],references:["ISO 27001 A.5.4"]},
            // ... (all ISO 27001 controls from previous version)
            
            // NIST CSF controls
            {id:"CTRL-ID.AM-01",name:"Physical devices and systems inventory",category:"Asset Management",
              description:"Inventories of physical devices and systems within the organization are maintained.",
              frameworks:["NIST CSF"],references:["NIST ID.AM-01"]},
            {id:"CTRL-ID.AM-02",name:"Software platforms and applications inventory",category:"Asset Management",
              description:"Inventories of software platforms and applications within the organization are maintained.",
              frameworks:["NIST CSF"],references:["NIST ID.AM-02"]},
            {id:"CTRL-ID.AM-03",name:"Organizational communication and data flows mapping",category:"Asset Management",
              description:"Organizational communication and data flows are mapped.",
              frameworks:["NIST CSF"],references:["NIST ID.AM-03"]},
            // ... (all NIST CSF controls from previous version)
            
            // PCI DSS controls
            {id:"CTRL-PCI-1.1",name:"Processes for network security controls",category:"Network Security",
              description:"Processes and mechanisms for installing and maintaining network security controls are defined and understood.",
              frameworks:["PCI DSS"],references:["PCI DSS 1.1"]},
            {id:"CTRL-PCI-1.2",name:"Network security controls implementation",category:"Network Security",
              description:"Network security controls are implemented.",
              frameworks:["PCI DSS"],references:["PCI DSS 1.2"]},
            // ... (all PCI DSS controls from previous version)
            
            // HIPAA controls
            {id:"CTRL-HIPAA-164.308(a)(1)(i)",name:"Security management process",category:"Policy & Governance",
              description:"Implement policies and procedures to prevent, detect, contain, and correct security violations.",
              frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(i)"]},
            {id:"CTRL-HIPAA-164.308(a)(1)(ii)(A)",name:"Risk analysis",category:"Policy & Governance",
              description:"Conduct an accurate and thorough assessment of the potential risks and vulnerabilities to the confidentiality, integrity, and availability of electronic protected health information held by the covered entity.",
              frameworks:["HIPAA"],references:["HIPAA 164.308(a)(1)(ii)(A)"]},
            // ... (all HIPAA controls from previous version)
            
            // SOC 2 controls
            {id:"CTRL-SOC-CC1.1",name:"Commitment to integrity and ethical values",category:"Policy & Governance",
              description:"The entity demonstrates a commitment to integrity and ethical values.",
              frameworks:["SOC2"],references:["SOC2 CC1.1"]},
            {id:"CTRL-SOC-CC1.2",name:"Board independence",category:"Policy & Governance",
              description:"The board of directors demonstrates independence from management and exercises oversight of the development and performance of internal control.",
              frameworks:["SOC2"],references:["SOC2 CC1.2"]},
            // ... (all SOC 2 controls from previous version)
        ];

        class GRCApplication {
            constructor() {
                this.version = '2.0.0';
                this.storagePrefix = 'grc_lab_v2_';
                this.currentTab = 'dashboard';
                this.data = this.initializeData();
                this.frameworks = this.initializeFrameworks();
                this.currentEditId = null;
                this.currentEditType = null;
                this.init();
            }

            // ===== INITIALIZATION =====
            initializeData() {
                return {
                    assets: this.loadData('assets') || [],
                    vendors: this.loadData('vendors') || [],
                    risks: this.loadData('risks') || [],
                    controls: this.loadData('controls') || [],
                    issues: this.loadData('issues') || [],
                    incidents: this.loadData('incidents') || [],
                    treatments: this.loadData('treatments') || [],
                    soa: this.loadData('soa') || [],
                    challenges: this.loadData('challenges') || {
                        progress: {},
                        scores: {}
                    },
                    settings: this.loadData('settings') || {
                        riskThresholds: { high: 15, medium: 6 },
                        companyName: 'Your Organization',
                        complianceFramework: 'ISO 27001'
                    }
                };
            }

            
            initializeFrameworks() {
                // Build full framework libraries from the unified control list.
                // NOTE: Controls are paraphrased and intended for educational practice only.
                const map = {
                    iso:   { name: 'ISO 27001',   match: ['ISO 27001','ISO/IEC 27001'], controls: [] },
                    nist:  { name: 'NIST CSF',    match: ['NIST CSF','NIST CSF 2.0','NIST'], controls: [] },
                    pci:   { name: 'PCI DSS',     match: ['PCI DSS','PCI DSS v4.0','PCI'], controls: [] },
                    hipaa: { name: 'HIPAA',       match: ['HIPAA'], controls: [] },
                    soc2:  { name: 'SOC 2',       match: ['SOC2','SOC 2'], controls: [] },
                };

                if (typeof FRAMEWORK_CONTROLS === 'undefined' || !Array.isArray(FRAMEWORK_CONTROLS)) return map;

                const norm = (s) => String(s || '').toLowerCase();

                for (const c of FRAMEWORK_CONTROLS) {
                    const fws = Array.isArray(c.frameworks) ? c.frameworks : [c.frameworks].filter(Boolean);
                    const entry = {
                        id: c.id,
                        name: c.name,
                        category: c.category || 'General',
                        description: c.description || '',
                        references: Array.isArray(c.references) ? c.references : [],
                        frameworks: fws
                    };

                    // Add to each matching framework bucket
                    for (const [k, fw] of Object.entries(map)) {
                        const hits = fw.match.some(m => fws.some(x => norm(x).includes(norm(m))));
                        if (hits) fw.controls.push(entry);
                    }
                }

                return map;
            }


            init() {
                this.bindEvents();
                this.renderDashboard();
                this.showToast('GRC Practice Lab loaded successfully', 'success');
                
                // Check for first-time setup
                if (!this.loadData('firstRun')) {
                    this.showFirstTimeSetup();
                    this.saveData('firstRun', true);
                }
            }

            // ===== DATA MANAGEMENT =====
            loadData(key) {
                try {
                    const data = localStorage.getItem(this.storagePrefix + key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Error loading data:', e);
                    return null;
                }
            }

            saveData(key, data) {
                try {
                    localStorage.setItem(this.storagePrefix + key, JSON.stringify(data));
                    this.data[key] = data;
                    return true;
                } catch (e) {
                    this.showToast('Error saving data. Check storage space.', 'error');
                    return false;
                }
            }

            // ===== TAB MANAGEMENT =====
            switchTab(tabName) {
                // Update current tab
                this.currentTab = tabName;
                
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                const tabElement = document.getElementById('tab' + this.capitalize(tabName));
                if (tabElement) {
                    tabElement.classList.add('active');
                }
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('onclick')?.includes(`switchTab('${tabName}')`)) {
                        btn.classList.add('active');
                    }
                });
                
                // Render tab content
                this.renderTabContent(tabName);
            }

            renderTabContent(tabName) {
                switch(tabName) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'vendors':
                        this.renderVendors();
                        break;
                    case 'risks':
                        this.renderRisks();
                        break;
                    case 'assets':
                        this.renderAssets();
                        break;
                    case 'controls':
                        this.renderControls();
                        break;
                    case 'frameworks':
                        this.renderFrameworks();
                        break;
                    case 'issues':
                        this.renderIssues();
                        break;
                    case 'incidents':
                        this.renderIncidents();
                        break;
                    case 'treatments':
                        this.renderTreatments();
                        break;
                    case 'matrix':
                        this.renderRiskMatrix();
                        break;
                    case 'soa':
                        this.renderSOA();
                        break;
                    case 'reports':
                        this.renderReports();
                        break;
                    case 'challenges':
                        this.renderChallenges();
                        break;
                }
            }

            capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            // ===== BIND EVENTS =====
            bindEvents() {
                // Search functionality
                const searchInputs = ['riskSearch', 'assetSearch', 'controlSearch', 'frameworkSearch', 
                                     'vendorSearch', 'issueSearch', 'incidentSearch', 'treatmentSearch'];
                searchInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', (e) => this.handleSearch(e, id.replace('Search', '')));
                    }
                });

                // Filter functionality
                const filterInputs = ['riskFilter', 'controlStatusFilter', 'frameworkSelect', 'categorySelect',
                                     'vendorRiskFilter', 'issueStatusFilter', 'incidentSeverityFilter', 'treatmentStatusFilter',
                                     'soaFrameworkFilter'];
                filterInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', (e) => this.handleFilter(e, id));
                    }
                });

                // Risk matrix view toggle
                document.querySelectorAll('input[name="matrixView"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.toggleMatrixView(e.target.id));
                });
            }

            handleSearch(event, type) {
                // Debounce search
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.renderTabContent(type);
                }, 300);
            }

            handleFilter(event, filterId) {
                this.renderTabContent(this.currentTab);
            }

            // ===== DASHBOARD =====
            renderDashboard() {
                // Update metrics
                document.getElementById('metricAssets').textContent = this.data.assets.length;
                document.getElementById('metricRisks').textContent = this.data.risks.length;
                document.getElementById('metricControls').textContent = this.data.controls.length;
                
                // Calculate compliance coverage
                const totalControls = this.data.controls.length;
                const implemented = this.data.controls.filter(c => c.status === 'Implemented').length;
                const coverage = totalControls > 0 ? Math.round((implemented / totalControls) * 100) : 0;
                document.getElementById('metricCoverage').textContent = `${coverage}%`;
                
                // Update recent risks
                this.renderRecentRisks();
            }

            renderRecentRisks() {
                const container = document.getElementById('recentRisks');
                if (!container) return;
                
                const recentRisks = this.data.risks
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, 5);
                
                if (recentRisks.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                No risks yet. Add some to get started!
                            </td>
                        </tr>
                    `;
                } else {
                    container.innerHTML = recentRisks.map(risk => `
                        <tr>
                            <td>
                                <strong>${risk.title}</strong><br>
                                <small class="text-muted">${risk.category}</small>
                            </td>
                            <td>
                                <span class="badge bg-${risk.severity === 'High' ? 'danger' : risk.severity === 'Medium' ? 'warning' : 'success'}">
                                    ${risk.severity}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-${risk.status === 'Open' ? 'secondary' : 
                                                         risk.status === 'In Progress' ? 'info' : 
                                                         risk.status === 'Mitigated' ? 'success' : 'dark'}">
                                    ${risk.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-light" onclick="app.showRiskForm('${risk.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // ===== RISK MANAGEMENT =====
            showRiskForm(riskId = null) {
                this.currentEditId = riskId;
                this.currentEditType = 'risk';
                
                const risk = riskId ? this.data.risks.find(r => r.id === riskId) : null;
                
                const formHTML = `
                    <form id="riskForm" onsubmit="app.saveRisk(event)">
                        <input type="hidden" id="riskId" value="${risk?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Risk Title *</label>
                                <input type="text" class="form-control" id="riskTitle" 
                                       value="${risk?.title || ''}" required placeholder="e.g., Data breach via SQL injection">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="riskCategory" required>
                                    <option value="">Select...</option>
                                    <option value="Cybersecurity" ${risk?.category === 'Cybersecurity' ? 'selected' : ''}>Cybersecurity</option>
                                    <option value="Compliance" ${risk?.category === 'Compliance' ? 'selected' : ''}>Compliance</option>
                                    <option value="Operational" ${risk?.category === 'Operational' ? 'selected' : ''}>Operational</option>
                                    <option value="Privacy" ${risk?.category === 'Privacy' ? 'selected' : ''}>Privacy</option>
                                    <option value="Third-Party" ${risk?.category === 'Third-Party' ? 'selected' : ''}>Third-Party</option>
                                    <option value="Financial" ${risk?.category === 'Financial' ? 'selected' : ''}>Financial</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="riskStatus" required>
                                    <option value="Open" ${risk?.status === 'Open' ? 'selected' : ''}>Open</option>
                                    <option value="In Progress" ${risk?.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Mitigated" ${risk?.status === 'Mitigated' ? 'selected' : ''}>Mitigated</option>
                                    <option value="Accepted" ${risk?.status === 'Accepted' ? 'selected' : ''}>Accepted</option>
                                    <option value="Closed" ${risk?.status === 'Closed' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Likelihood (1-5) *</label>
                                <select class="form-select" id="riskLikelihood" required>
                                    <option value="">Select...</option>
                                    ${[1,2,3,4,5].map(n => `
                                        <option value="${n}" ${risk?.likelihood === n ? 'selected' : ''}>
                                            ${n} - ${this.getLikelihoodLabel(n)}
                                        </option>
                                    `).join('')}
                                </select>
                                <small class="text-muted">How likely is this risk to occur?</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Impact (1-5) *</label>
                                <select class="form-select" id="riskImpact" required>
                                    <option value="">Select...</option>
                                    ${[1,2,3,4,5].map(n => `
                                        <option value="${n}" ${risk?.impact === n ? 'selected' : ''}>
                                            ${n} - ${this.getImpactLabel(n)}
                                        </option>
                                    `).join('')}
                                </select>
                                <small class="text-muted">How severe would the impact be?</small>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="riskDescription" rows="3" 
                                          placeholder="Describe the risk scenario, potential causes, and business impact...">${risk?.description || ''}</textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" id="riskOwner" 
                                       value="${risk?.owner || ''}" placeholder="e.g., CISO, DevOps Team">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="riskDueDate" 
                                       value="${risk?.dueDate || ''}">
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Mitigation Notes</label>
                                <textarea class="form-control" id="riskMitigation" rows="2"
                                          placeholder="Current or planned mitigation controls...">${risk?.mitigation || ''}</textarea>
                            </div>
                            
                            <div class="col-12">
                                <div class="alert alert-info bg-dark border-info">
                                    <small>
                                        <strong>Risk Score:</strong> <span id="riskScorePreview">${risk ? risk.score : '0'}</span> 
                                        <span class="ms-3"><strong>Severity:</strong> <span id="riskSeverityPreview">${risk ? risk.severity : 'None'}</span></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${risk ? 'Update' : 'Save'} Risk</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('riskModalBody').innerHTML = formHTML;
                
                // Calculate initial score
                this.updateRiskScorePreview();
                
                // Add event listeners for score calculation
                document.getElementById('riskLikelihood')?.addEventListener('change', () => this.updateRiskScorePreview());
                document.getElementById('riskImpact')?.addEventListener('change', () => this.updateRiskScorePreview());
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('riskModal'));
                modal.show();
            }

            updateRiskScorePreview() {
                const likelihood = parseInt(document.getElementById('riskLikelihood')?.value) || 0;
                const impact = parseInt(document.getElementById('riskImpact')?.value) || 0;
                const score = likelihood * impact;
                const severity = this.calculateRiskSeverity(score);
                
                const scoreElement = document.getElementById('riskScorePreview');
                const severityElement = document.getElementById('riskSeverityPreview');
                
                if (scoreElement) scoreElement.textContent = score;
                if (severityElement) {
                    severityElement.textContent = severity;
                    severityElement.className = '';
                    severityElement.classList.add('badge', `bg-${severity === 'High' ? 'danger' : severity === 'Medium' ? 'warning' : 'success'}`);
                }
            }

            saveRisk(event) {
                event.preventDefault();
                
                const riskData = {
                    id: document.getElementById('riskId').value || 'RISK_' + Date.now(),
                    title: document.getElementById('riskTitle').value.trim(),
                    category: document.getElementById('riskCategory').value,
                    status: document.getElementById('riskStatus').value,
                    likelihood: parseInt(document.getElementById('riskLikelihood').value),
                    impact: parseInt(document.getElementById('riskImpact').value),
                    description: document.getElementById('riskDescription').value.trim(),
                    owner: document.getElementById('riskOwner').value.trim(),
                    dueDate: document.getElementById('riskDueDate').value,
                    mitigation: document.getElementById('riskMitigation').value.trim(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Calculate score and severity
                riskData.score = riskData.likelihood * riskData.impact;
                riskData.severity = this.calculateRiskSeverity(riskData.score);
                
                // Find index if editing
                const index = this.data.risks.findIndex(r => r.id === riskData.id);
                if (index > -1) {
                    this.data.risks[index] = riskData;
                    this.showToast('Risk updated successfully', 'success');
                } else {
                    this.data.risks.push(riskData);
                    this.showToast('Risk added successfully', 'success');
                }
                
                // Save and update UI
                this.saveData('risks', this.data.risks);
                this.renderRisks();
                this.renderDashboard();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('riskModal')).hide();
            }

            calculateRiskSeverity(score) {
                const thresholds = this.data.settings.riskThresholds;
                if (score >= thresholds.high) return 'High';
                if (score >= thresholds.medium) return 'Medium';
                return 'Low';
            }

            getLikelihoodLabel(score) {
                const labels = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];
                return labels[score - 1] || '';
            }

            getImpactLabel(score) {
                const labels = ['Insignificant', 'Minor', 'Moderate', 'Major', 'Severe'];
                return labels[score - 1] || '';
            }

            renderRisks() {
                const tableBody = document.getElementById('riskTableBody');
                if (!tableBody) return;

                // Get search and filter values
                const searchTerm = document.getElementById('riskSearch')?.value.toLowerCase() || '';
                const filterStatus = document.getElementById('riskFilter')?.value || 'all';
                
                // Filter risks
                let filteredRisks = this.data.risks;
                
                if (searchTerm) {
                    filteredRisks = filteredRisks.filter(risk =>
                        risk.title.toLowerCase().includes(searchTerm) ||
                        risk.category.toLowerCase().includes(searchTerm) ||
                        risk.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filterStatus !== 'all') {
                    filteredRisks = filteredRisks.filter(risk => 
                        risk.status.toLowerCase().replace(' ', '-') === filterStatus
                    );
                }
                
                // Sort by score (highest first)
                filteredRisks.sort((a, b) => b.score - a.score);
                
                // Render table
                if (filteredRisks.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
                                    No risks found. ${searchTerm ? 'Try a different search term.' : 'Add your first risk!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredRisks.map(risk => `
                        <tr>
                            <td data-label="Risk">
                                <strong>${risk.title}</strong><br>
                                <small class="text-muted">${risk.category}</small>
                            </td>
                            <td data-label="Category">${risk.category}</td>
                            <td data-label="Likelihood">
                                <span class="badge bg-info">${risk.likelihood}</span>
                                <small class="d-block text-muted">${this.getLikelihoodLabel(risk.likelihood)}</small>
                            </td>
                            <td data-label="Impact">
                                <span class="badge bg-warning">${risk.impact}</span>
                                <small class="d-block text-muted">${this.getImpactLabel(risk.impact)}</small>
                            </td>
                            <td data-label="Severity">
                                <span class="badge bg-${risk.severity === 'High' ? 'danger' : risk.severity === 'Medium' ? 'warning' : 'success'}">
                                    ${risk.severity} (${risk.score})
                                </span>
                            </td>
                            <td data-label="Status">
                                <span class="status-badge status-${risk.status.toLowerCase().replace(' ', '-')}">
                                    ${risk.status}
                                </span>
                            </td>
                            <td data-label="Actions">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-light" onclick="app.showRiskForm('${risk.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="app.deleteItem('risk', '${risk.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // ===== ASSET MANAGEMENT =====
            showAssetForm(assetId = null) {
                this.currentEditId = assetId;
                this.currentEditType = 'asset';
                
                const asset = assetId ? this.data.assets.find(a => a.id === assetId) : null;
                
                const formHTML = `
                    <form id="assetForm" onsubmit="app.saveAsset(event)">
                        <input type="hidden" id="assetId" value="${asset?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Asset Name *</label>
                                <input type="text" class="form-control" id="assetName" 
                                       value="${asset?.name || ''}" required placeholder="e.g., Customer Database">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Type *</label>
                                <select class="form-select" id="assetType" required>
                                    <option value="">Select...</option>
                                    <option value="Application" ${asset?.type === 'Application' ? 'selected' : ''}>Application</option>
                                    <option value="Database" ${asset?.type === 'Database' ? 'selected' : ''}>Database</option>
                                    <option value="Server" ${asset?.type === 'Server' ? 'selected' : ''}>Server</option>
                                    <option value="Network Device" ${asset?.type === 'Network Device' ? 'selected' : ''}>Network Device</option>
                                    <option value="Cloud Service" ${asset?.type === 'Cloud Service' ? 'selected' : ''}>Cloud Service</option>
                                    <option value="Data Store" ${asset?.type === 'Data Store' ? 'selected' : ''}>Data Store</option>
                                    <option value="Other" ${asset?.type === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Business Criticality *</label>
                                <select class="form-select" id="assetCriticality" required>
                                    <option value="">Select...</option>
                                    <option value="High" ${asset?.criticality === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${asset?.criticality === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${asset?.criticality === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" id="assetOwner" 
                                       value="${asset?.owner || ''}" placeholder="e.g., IT Department">
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Data Types</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dataPII" ${asset?.dataTypes?.includes('PII') ? 'checked' : ''}>
                                            <label class="form-check-label" for="dataPII">PII</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dataPHI" ${asset?.dataTypes?.includes('PHI') ? 'checked' : ''}>
                                            <label class="form-check-label" for="dataPHI">PHI</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dataFinancial" ${asset?.dataTypes?.includes('Financial') ? 'checked' : ''}>
                                            <label class="form-check-label" for="dataFinancial">Financial</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dataInternal" ${asset?.dataTypes?.includes('Internal') ? 'checked' : ''}>
                                            <label class="form-check-label" for="dataInternal">Internal</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="assetDescription" rows="3"
                                          placeholder="Describe the asset purpose, location, and importance...">${asset?.description || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${asset ? 'Update' : 'Save'} Asset</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('assetModalBody').innerHTML = formHTML;
                const modal = new bootstrap.Modal(document.getElementById('assetModal'));
                modal.show();
            }

            saveAsset(event) {
                event.preventDefault();
                
                // Collect data types
                const dataTypes = [];
                if (document.getElementById('dataPII')?.checked) dataTypes.push('PII');
                if (document.getElementById('dataPHI')?.checked) dataTypes.push('PHI');
                if (document.getElementById('dataFinancial')?.checked) dataTypes.push('Financial');
                if (document.getElementById('dataInternal')?.checked) dataTypes.push('Internal');
                
                const assetData = {
                    id: document.getElementById('assetId').value || 'AST_' + Date.now(),
                    name: document.getElementById('assetName').value.trim(),
                    type: document.getElementById('assetType').value,
                    criticality: document.getElementById('assetCriticality').value,
                    owner: document.getElementById('assetOwner').value.trim(),
                    description: document.getElementById('assetDescription').value.trim(),
                    dataTypes: dataTypes,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Find index if editing
                const index = this.data.assets.findIndex(a => a.id === assetData.id);
                if (index > -1) {
                    this.data.assets[index] = assetData;
                    this.showToast('Asset updated successfully', 'success');
                } else {
                    this.data.assets.push(assetData);
                    this.showToast('Asset added successfully', 'success');
                }
                
                // Save and update UI
                this.saveData('assets', this.data.assets);
                this.renderAssets();
                this.renderDashboard();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('assetModal')).hide();
            }

            renderAssets() {
                const tableBody = document.getElementById('assetTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('assetSearch')?.value.toLowerCase() || '';
                let filteredAssets = this.data.assets;
                
                if (searchTerm) {
                    filteredAssets = filteredAssets.filter(asset =>
                        asset.name.toLowerCase().includes(searchTerm) ||
                        asset.type.toLowerCase().includes(searchTerm) ||
                        asset.owner?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filteredAssets.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-hdd-stack fs-4 d-block mb-2"></i>
                                    No assets found. ${searchTerm ? 'Try a different search term.' : 'Add your first asset!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredAssets.map(asset => `
                        <tr>
                            <td data-label="Name">
                                <strong>${asset.name}</strong><br>
                                <small class="text-muted">ID: ${asset.id}</small>
                            </td>
                            <td data-label="Type">
                                <span class="badge bg-secondary">${asset.type}</span>
                            </td>
                            <td data-label="Criticality">
                                <span class="badge bg-${asset.criticality === 'High' ? 'danger' : asset.criticality === 'Medium' ? 'warning' : 'success'}">
                                    ${asset.criticality}
                                </span>
                            </td>
                            <td data-label="Data Types">
                                ${asset.dataTypes?.map(type => `<span class="badge bg-info me-1">${type}</span>`).join('') || '-'}
                            </td>
                            <td data-label="Owner">${asset.owner || '-'}</td>
                            <td data-label="Actions">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-light" onclick="app.showAssetForm('${asset.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="app.deleteItem('asset', '${asset.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // ===== CONTROL MANAGEMENT =====
            showControlForm(controlId = null) {
                this.currentEditId = controlId;
                this.currentEditType = 'control';
                
                const control = controlId ? this.data.controls.find(c => c.id === controlId) : null;
                
                const formHTML = `
                    <form id="controlForm" onsubmit="app.saveControl(event)">
                        <input type="hidden" id="controlId" value="${control?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Control Name *</label>
                                <input type="text" class="form-control" id="controlName" 
                                       value="${control?.name || ''}" required placeholder="e.g., Multi-Factor Authentication">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Type *</label>
                                <select class="form-select" id="controlType" required>
                                    <option value="">Select...</option>
                                    <option value="Preventive" ${control?.type === 'Preventive' ? 'selected' : ''}>Preventive</option>
                                    <option value="Detective" ${control?.type === 'Detective' ? 'selected' : ''}>Detective</option>
                                    <option value="Corrective" ${control?.type === 'Corrective' ? 'selected' : ''}>Corrective</option>
                                    <option value="Administrative" ${control?.type === 'Administrative' ? 'selected' : ''}>Administrative</option>
                                    <option value="Technical" ${control?.type === 'Technical' ? 'selected' : ''}>Technical</option>
                                    <option value="Physical" ${control?.type === 'Physical' ? 'selected' : ''}>Physical</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="controlStatus" required>
                                    <option value="">Select...</option>
                                    <option value="Implemented" ${control?.status === 'Implemented' ? 'selected' : ''}>Implemented</option>
                                    <option value="Planned" ${control?.status === 'Planned' ? 'selected' : ''}>Planned</option>
                                    <option value="Not Implemented" ${control?.status === 'Not Implemented' ? 'selected' : ''}>Not Implemented</option>
                                    <option value="Not Applicable" ${control?.status === 'Not Applicable' ? 'selected' : ''}>Not Applicable</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Framework Alignment</label>
                                <select class="form-select" id="controlFramework">
                                    <option value="">Select...</option>
                                    <option value="ISO 27001" ${control?.framework === 'ISO 27001' ? 'selected' : ''}>ISO 27001</option>
                                    <option value="NIST CSF" ${control?.framework === 'NIST CSF' ? 'selected' : ''}>NIST CSF</option>
                                    <option value="PCI DSS" ${control?.framework === 'PCI DSS' ? 'selected' : ''}>PCI DSS</option>
                                    <option value="HIPAA" ${control?.framework === 'HIPAA' ? 'selected' : ''}>HIPAA</option>
                                    <option value="SOC 2" ${control?.framework === 'SOC 2' ? 'selected' : ''}>SOC 2</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" id="controlOwner" 
                                       value="${control?.owner || ''}" placeholder="e.g., Security Team">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Implementation Date</label>
                                <input type="date" class="form-control" id="controlDate" 
                                       value="${control?.implementationDate || ''}">
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="controlDescription" rows="3"
                                          placeholder="Describe the control implementation, coverage, and evidence...">${control?.description || ''}</textarea>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Evidence / Notes</label>
                                <textarea class="form-control" id="controlEvidence" rows="2"
                                          placeholder="Links to documentation, screenshots, or other evidence...">${control?.evidence || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${control ? 'Update' : 'Save'} Control</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('controlModalBody').innerHTML = formHTML;
                const modal = new bootstrap.Modal(document.getElementById('controlModal'));
                modal.show();
            }

            saveControl(event) {
                event.preventDefault();
                
                const controlData = {
                    id: document.getElementById('controlId').value || 'CTL_' + Date.now(),
                    name: document.getElementById('controlName').value.trim(),
                    type: document.getElementById('controlType').value,
                    status: document.getElementById('controlStatus').value,
                    framework: document.getElementById('controlFramework').value,
                    owner: document.getElementById('controlOwner').value.trim(),
                    implementationDate: document.getElementById('controlDate').value,
                    description: document.getElementById('controlDescription').value.trim(),
                    evidence: document.getElementById('controlEvidence').value.trim(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Find index if editing
                const index = this.data.controls.findIndex(c => c.id === controlData.id);
                if (index > -1) {
                    this.data.controls[index] = controlData;
                    this.showToast('Control updated successfully', 'success');
                } else {
                    this.data.controls.push(controlData);
                    this.showToast('Control added successfully', 'success');
                }
                
                // Save and update UI
                this.saveData('controls', this.data.controls);
                this.renderControls();
                this.renderDashboard();
                this.renderSOA();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('controlModal')).hide();
            }

            renderControls() {
                const tableBody = document.getElementById('controlTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('controlSearch')?.value.toLowerCase() || '';
                const filterStatus = document.getElementById('controlStatusFilter')?.value || 'all';
                
                let filteredControls = this.data.controls;
                
                if (searchTerm) {
                    filteredControls = filteredControls.filter(control =>
                        control.name.toLowerCase().includes(searchTerm) ||
                        control.type.toLowerCase().includes(searchTerm) ||
                        control.framework?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filterStatus !== 'all') {
                    filteredControls = filteredControls.filter(control => 
                        control.status.toLowerCase().replace(' ', '-') === filterStatus
                    );
                }
                
                if (filteredControls.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-shield-check fs-4 d-block mb-2"></i>
                                    No controls found. ${searchTerm ? 'Try a different search term.' : 'Add your first control!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredControls.map(control => `
                        <tr>
                            <td data-label="Name">
                                <strong>${control.name}</strong><br>
                                <small class="text-muted">${control.type}</small>
                            </td>
                            <td data-label="Type">
                                <span class="badge bg-secondary">${control.type}</span>
                            </td>
                            <td data-label="Framework">
                                ${control.framework ? `<span class="badge bg-primary">${control.framework}</span>` : '-'}
                            </td>
                            <td data-label="Status">
                                <span class="status-badge status-${control.status.toLowerCase().replace(' ', '-')}">
                                    ${control.status}
                                </span>
                            </td>
                            <td data-label="Owner">${control.owner || '-'}</td>
                            <td data-label="Actions">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-light" onclick="app.showControlForm('${control.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="app.deleteItem('control', '${control.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // ===== VENDOR MANAGEMENT =====
            showVendorForm(vendorId = null) {
                this.currentEditId = vendorId;
                this.currentEditType = 'vendor';
                
                const vendor = vendorId ? this.data.vendors.find(v => v.id === vendorId) : null;
                
                const formHTML = `
                    <form id="vendorForm" onsubmit="app.saveVendor(event)">
                        <input type="hidden" id="vendorId" value="${vendor?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Vendor Name *</label>
                                <input type="text" class="form-control" id="vendorName" 
                                       value="${vendor?.name || ''}" required placeholder="e.g., Cloud Provider Inc.">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Service Type *</label>
                                <select class="form-select" id="vendorServiceType" required>
                                    <option value="">Select...</option>
                                    <option value="Cloud Services" ${vendor?.serviceType === 'Cloud Services' ? 'selected' : ''}>Cloud Services</option>
                                    <option value="Software" ${vendor?.serviceType === 'Software' ? 'selected' : ''}>Software</option>
                                    <option value="Managed Services" ${vendor?.serviceType === 'Managed Services' ? 'selected' : ''}>Managed Services</option>
                                    <option value="Consulting" ${vendor?.serviceType === 'Consulting' ? 'selected' : ''}>Consulting</option>
                                    <option value="Hardware" ${vendor?.serviceType === 'Hardware' ? 'selected' : ''}>Hardware</option>
                                    <option value="Other" ${vendor?.serviceType === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Risk Level *</label>
                                <select class="form-select" id="vendorRiskLevel" required>
                                    <option value="">Select...</option>
                                    <option value="High" ${vendor?.riskLevel === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${vendor?.riskLevel === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${vendor?.riskLevel === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contract Status</label>
                                <select class="form-select" id="vendorContractStatus">
                                    <option value="">Select...</option>
                                    <option value="Active" ${vendor?.contractStatus === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Pending Renewal" ${vendor?.contractStatus === 'Pending Renewal' ? 'selected' : ''}>Pending Renewal</option>
                                    <option value="Expired" ${vendor?.contractStatus === 'Expired' ? 'selected' : ''}>Expired</option>
                                    <option value="Terminated" ${vendor?.contractStatus === 'Terminated' ? 'selected' : ''}>Terminated</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Next Review Date</label>
                                <input type="date" class="form-control" id="vendorReviewDate" 
                                       value="${vendor?.nextReviewDate || ''}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Compliance Status</label>
                                <select class="form-select" id="vendorCompliance">
                                    <option value="">Select...</option>
                                    <option value="Compliant" ${vendor?.compliance === 'Compliant' ? 'selected' : ''}>Compliant</option>
                                    <option value="Partially Compliant" ${vendor?.compliance === 'Partially Compliant' ? 'selected' : ''}>Partially Compliant</option>
                                    <option value="Non-Compliant" ${vendor?.compliance === 'Non-Compliant' ? 'selected' : ''}>Non-Compliant</option>
                                    <option value="Not Assessed" ${vendor?.compliance === 'Not Assessed' ? 'selected' : ''}>Not Assessed</option>
                                </select>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description / Scope</label>
                                <textarea class="form-control" id="vendorDescription" rows="3"
                                          placeholder="Describe the vendor services, data access, and criticality...">${vendor?.description || ''}</textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Person</label>
                                <input type="text" class="form-control" id="vendorContact" 
                                       value="${vendor?.contact || ''}" placeholder="e.g., John Smith - Account Manager">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="vendorEmail" 
                                       value="${vendor?.email || ''}" placeholder="e.g., contact@vendor.com">
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Security Assessment Notes</label>
                                <textarea class="form-control" id="vendorAssessment" rows="2"
                                          placeholder="Key findings from security assessment, gaps, or concerns...">${vendor?.assessment || ''}</textarea>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vendorHasSLA" ${vendor?.hasSLA ? 'checked' : ''}>
                                    <label class="form-check-label" for="vendorHasSLA">
                                        Service Level Agreement (SLA) in place
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${vendor ? 'Update' : 'Save'} Vendor</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('vendorModalBody').innerHTML = formHTML;
                const modal = new bootstrap.Modal(document.getElementById('vendorModal'));
                modal.show();
            }

            saveVendor(event) {
                event.preventDefault();
                
                const vendorData = {
                    id: document.getElementById('vendorId').value || 'VDR_' + Date.now(),
                    name: document.getElementById('vendorName').value.trim(),
                    serviceType: document.getElementById('vendorServiceType').value,
                    riskLevel: document.getElementById('vendorRiskLevel').value,
                    contractStatus: document.getElementById('vendorContractStatus').value || 'Not Set',
                    nextReviewDate: document.getElementById('vendorReviewDate').value,
                    compliance: document.getElementById('vendorCompliance').value || 'Not Assessed',
                    description: document.getElementById('vendorDescription').value.trim(),
                    contact: document.getElementById('vendorContact').value.trim(),
                    email: document.getElementById('vendorEmail').value.trim(),
                    assessment: document.getElementById('vendorAssessment').value.trim(),
                    hasSLA: document.getElementById('vendorHasSLA')?.checked || false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const index = this.data.vendors.findIndex(v => v.id === vendorData.id);
                if (index > -1) {
                    this.data.vendors[index] = vendorData;
                    this.showToast('Vendor updated successfully', 'success');
                } else {
                    this.data.vendors.push(vendorData);
                    this.showToast('Vendor added successfully', 'success');
                }
                
                this.saveData('vendors', this.data.vendors);
                this.renderVendors();
                
                bootstrap.Modal.getInstance(document.getElementById('vendorModal')).hide();
            }

            renderVendors() {
                const tableBody = document.getElementById('vendorTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('vendorSearch')?.value.toLowerCase() || '';
                const riskFilter = document.getElementById('vendorRiskFilter')?.value || 'all';
                
                let filteredVendors = this.data.vendors;
                
                if (searchTerm) {
                    filteredVendors = filteredVendors.filter(vendor =>
                        vendor.name.toLowerCase().includes(searchTerm) ||
                        vendor.serviceType.toLowerCase().includes(searchTerm) ||
                        vendor.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (riskFilter !== 'all') {
                    filteredVendors = filteredVendors.filter(vendor => 
                        vendor.riskLevel.toLowerCase() === riskFilter.toLowerCase()
                    );
                }
                
                if (filteredVendors.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-people fs-4 d-block mb-2"></i>
                                    No vendors found. ${searchTerm ? 'Try a different search term.' : 'Add your first vendor!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredVendors.map(vendor => {
                        const riskBadge = vendor.riskLevel === 'High' ? 'danger' : 
                                        vendor.riskLevel === 'Medium' ? 'warning' : 'success';
                        const complianceBadge = vendor.compliance === 'Compliant' ? 'success' :
                                              vendor.compliance === 'Partially Compliant' ? 'warning' : 'secondary';
                        
                        return `
                            <tr>
                                <td data-label="Vendor Name">
                                    <strong>${vendor.name}</strong>
                                    ${vendor.hasSLA ? '<br><small class="text-success"><i class="bi bi-check-circle"></i> SLA in place</small>' : ''}
                                </td>
                                <td data-label="Service Type">
                                    <span class="badge bg-info">${vendor.serviceType}</span>
                                </td>
                                <td data-label="Risk Level">
                                    <span class="badge bg-${riskBadge}">${vendor.riskLevel}</span>
                                </td>
                                <td data-label="Contract Status">
                                    <span class="badge bg-secondary">${vendor.contractStatus || 'Not Set'}</span>
                                </td>
                                <td data-label="Next Review">
                                    ${vendor.nextReviewDate ? new Date(vendor.nextReviewDate).toLocaleDateString() : 'Not set'}
                                    ${vendor.nextReviewDate && new Date(vendor.nextReviewDate) < new Date() ? 
                                        '<br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Overdue</small>' : ''}
                                </td>
                                <td data-label="Compliance">
                                    <span class="badge bg-${complianceBadge}">${vendor.compliance}</span>
                                </td>
                                <td data-label="Actions">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-light" onclick="app.showVendorForm('${vendor.id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="app.deleteItem('vendor', '${vendor.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // ===== ISSUE MANAGEMENT =====
            showIssueForm(issueId = null) {
                this.currentEditId = issueId;
                this.currentEditType = 'issue';
                
                const issue = issueId ? this.data.issues.find(i => i.id === issueId) : null;
                
                const formHTML = `
                    <form id="issueForm" onsubmit="app.saveIssue(event)">
                        <input type="hidden" id="issueId" value="${issue?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Issue Title *</label>
                                <input type="text" class="form-control" id="issueTitle" 
                                       value="${issue?.title || ''}" required placeholder="e.g., Missing encryption on backup storage">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Source *</label>
                                <select class="form-select" id="issueSource" required>
                                    <option value="">Select...</option>
                                    <option value="Audit" ${issue?.source === 'Audit' ? 'selected' : ''}>Audit</option>
                                    <option value="Penetration Test" ${issue?.source === 'Penetration Test' ? 'selected' : ''}>Penetration Test</option>
                                    <option value="Vulnerability Scan" ${issue?.source === 'Vulnerability Scan' ? 'selected' : ''}>Vulnerability Scan</option>
                                    <option value="Compliance Review" ${issue?.source === 'Compliance Review' ? 'selected' : ''}>Compliance Review</option>
                                    <option value="Internal Review" ${issue?.source === 'Internal Review' ? 'selected' : ''}>Internal Review</option>
                                    <option value="Incident" ${issue?.source === 'Incident' ? 'selected' : ''}>Incident</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Severity *</label>
                                <select class="form-select" id="issueSeverity" required>
                                    <option value="">Select...</option>
                                    <option value="Critical" ${issue?.severity === 'Critical' ? 'selected' : ''}>Critical</option>
                                    <option value="High" ${issue?.severity === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${issue?.severity === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${issue?.severity === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="issueStatus" required>
                                    <option value="">Select...</option>
                                    <option value="Open" ${issue?.status === 'Open' ? 'selected' : ''}>Open</option>
                                    <option value="In Progress" ${issue?.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Resolved" ${issue?.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                    <option value="Closed" ${issue?.status === 'Closed' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="issueDueDate" 
                                       value="${issue?.dueDate || ''}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" id="issueOwner" 
                                       value="${issue?.owner || ''}" placeholder="e.g., Security Team">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Affected Asset/System</label>
                                <select class="form-select" id="issueAsset">
                                    <option value="">Select Asset...</option>
                                    ${this.data.assets.map(asset => `
                                        <option value="${asset.id}" ${issue?.assetId === asset.id ? 'selected' : ''}>
                                            ${asset.name} (${asset.type})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="issueDescription" rows="3"
                                          placeholder="Detailed description of the issue, including impact and scope...">${issue?.description || ''}</textarea>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Remediation Steps</label>
                                <textarea class="form-control" id="issueRemediation" rows="2"
                                          placeholder="Required actions to resolve the issue...">${issue?.remediation || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${issue ? 'Update' : 'Save'} Issue</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('issueModalBody').innerHTML = formHTML;
                const modal = new bootstrap.Modal(document.getElementById('issueModal'));
                modal.show();
            }

            saveIssue(event) {
                event.preventDefault();
                
                const issueData = {
                    id: document.getElementById('issueId').value || 'ISS_' + Date.now(),
                    title: document.getElementById('issueTitle').value.trim(),
                    source: document.getElementById('issueSource').value,
                    severity: document.getElementById('issueSeverity').value,
                    status: document.getElementById('issueStatus').value,
                    dueDate: document.getElementById('issueDueDate').value,
                    owner: document.getElementById('issueOwner').value.trim(),
                    assetId: document.getElementById('issueAsset').value,
                    description: document.getElementById('issueDescription').value.trim(),
                    remediation: document.getElementById('issueRemediation').value.trim(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const index = this.data.issues.findIndex(i => i.id === issueData.id);
                if (index > -1) {
                    this.data.issues[index] = issueData;
                    this.showToast('Issue updated successfully', 'success');
                } else {
                    this.data.issues.push(issueData);
                    this.showToast('Issue added successfully', 'success');
                }
                
                this.saveData('issues', this.data.issues);
                this.renderIssues();
                
                bootstrap.Modal.getInstance(document.getElementById('issueModal')).hide();
            }

            renderIssues() {
                const tableBody = document.getElementById('issueTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('issueSearch')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('issueStatusFilter')?.value || 'all';
                
                let filteredIssues = this.data.issues;
                
                if (searchTerm) {
                    filteredIssues = filteredIssues.filter(issue =>
                        issue.title.toLowerCase().includes(searchTerm) ||
                        issue.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (statusFilter !== 'all') {
                    filteredIssues = filteredIssues.filter(issue => 
                        issue.status.toLowerCase().replace(' ', '-') === statusFilter
                    );
                }
                
                if (filteredIssues.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-bug fs-4 d-block mb-2"></i>
                                    No issues found. ${searchTerm ? 'Try a different search term.' : 'Add your first issue!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredIssues.map(issue => {
                        const severityBadge = issue.severity === 'Critical' ? 'danger' : 
                                            issue.severity === 'High' ? 'danger' :
                                            issue.severity === 'Medium' ? 'warning' : 'secondary';
                        
                        const asset = issue.assetId ? this.data.assets.find(a => a.id === issue.assetId) : null;
                        
                        return `
                            <tr>
                                <td data-label="Issue Title">
                                    <strong>${issue.title}</strong><br>
                                    <small class="text-muted">${issue.source}</small>
                                </td>
                                <td data-label="Source">
                                    <span class="badge bg-info">${issue.source}</span>
                                </td>
                                <td data-label="Severity">
                                    <span class="badge bg-${severityBadge}">${issue.severity}</span>
                                </td>
                                <td data-label="Status">
                                    <span class="status-badge status-${issue.status.toLowerCase().replace(' ', '-')}">
                                        ${issue.status}
                                    </span>
                                </td>
                                <td data-label="Due Date">
                                    ${issue.dueDate ? new Date(issue.dueDate).toLocaleDateString() : 'Not set'}
                                    ${issue.dueDate && new Date(issue.dueDate) < new Date() && issue.status !== 'Resolved' ? 
                                        '<br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Overdue</small>' : ''}
                                </td>
                                <td data-label="Owner">${issue.owner || 'Unassigned'}</td>
                                <td data-label="Actions">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-light" onclick="app.showIssueForm('${issue.id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="app.deleteItem('issue', '${issue.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // ===== INCIDENT MANAGEMENT =====
            showIncidentForm(incidentId = null) {
                this.currentEditId = incidentId;
                this.currentEditType = 'incident';
                
                const incident = incidentId ? this.data.incidents.find(i => i.id === incidentId) : null;
                
                const formHTML = `
                    <form id="incidentForm" onsubmit="app.saveIncident(event)">
                        <input type="hidden" id="incidentId" value="${incident?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Incident Title *</label>
                                <input type="text" class="form-control" id="incidentTitle" 
                                       value="${incident?.title || ''}" required placeholder="e.g., Phishing attack targeting employees">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Incident Type *</label>
                                <select class="form-select" id="incidentType" required>
                                    <option value="">Select...</option>
                                    <option value="Malware" ${incident?.type === 'Malware' ? 'selected' : ''}>Malware</option>
                                    <option value="Phishing" ${incident?.type === 'Phishing' ? 'selected' : ''}>Phishing</option>
                                    <option value="Data Breach" ${incident?.type === 'Data Breach' ? 'selected' : ''}>Data Breach</option>
                                    <option value="DDoS" ${incident?.type === 'DDoS' ? 'selected' : ''}>DDoS Attack</option>
                                    <option value="Insider Threat" ${incident?.type === 'Insider Threat' ? 'selected' : ''}>Insider Threat</option>
                                    <option value="Physical Security" ${incident?.type === 'Physical Security' ? 'selected' : ''}>Physical Security</option>
                                    <option value="Other" ${incident?.type === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Severity *</label>
                                <select class="form-select" id="incidentSeverity" required>
                                    <option value="">Select...</option>
                                    <option value="Critical" ${incident?.severity === 'Critical' ? 'selected' : ''}>Critical</option>
                                    <option value="High" ${incident?.severity === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${incident?.severity === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${incident?.severity === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="incidentStatus" required>
                                    <option value="">Select...</option>
                                    <option value="Detected" ${incident?.status === 'Detected' ? 'selected' : ''}>Detected</option>
                                    <option value="Investigating" ${incident?.status === 'Investigating' ? 'selected' : ''}>Investigating</option>
                                    <option value="Contained" ${incident?.status === 'Contained' ? 'selected' : ''}>Contained</option>
                                    <option value="Resolved" ${incident?.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                    <option value="Closed" ${incident?.status === 'Closed' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Detection Date/Time</label>
                                <input type="datetime-local" class="form-control" id="incidentDetected" 
                                       value="${incident?.detected || ''}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Incident Owner</label>
                                <input type="text" class="form-control" id="incidentOwner" 
                                       value="${incident?.owner || ''}" placeholder="e.g., SOC Team">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Affected Systems</label>
                                <select class="form-select" id="incidentAffectedSystems" multiple>
                                    ${this.data.assets.map(asset => `
                                        <option value="${asset.id}" ${incident?.affectedSystems?.includes(asset.id) ? 'selected' : ''}>
                                            ${asset.name}
                                        </option>
                                    `).join('')}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="incidentDescription" rows="3"
                                          placeholder="Detailed description of the incident, timeline, and impact...">${incident?.description || ''}</textarea>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Response Actions</label>
                                <textarea class="form-control" id="incidentResponse" rows="2"
                                          placeholder="Actions taken to respond to the incident...">${incident?.response || ''}</textarea>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Lessons Learned</label>
                                <textarea class="form-control" id="incidentLessons" rows="2"
                                          placeholder="Key learnings and improvements identified...">${incident?.lessons || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${incident ? 'Update' : 'Log'} Incident</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('incidentModalBody').innerHTML = formHTML;
                const modal = new bootstrap.Modal(document.getElementById('incidentModal'));
                modal.show();
            }

            saveIncident(event) {
                event.preventDefault();
                
                const affectedSystems = Array.from(document.getElementById('incidentAffectedSystems').selectedOptions)
                    .map(option => option.value);
                
                const incidentData = {
                    id: document.getElementById('incidentId').value || 'INC_' + Date.now(),
                    title: document.getElementById('incidentTitle').value.trim(),
                    type: document.getElementById('incidentType').value,
                    severity: document.getElementById('incidentSeverity').value,
                    status: document.getElementById('incidentStatus').value,
                    detected: document.getElementById('incidentDetected').value,
                    owner: document.getElementById('incidentOwner').value.trim(),
                    affectedSystems: affectedSystems,
                    description: document.getElementById('incidentDescription').value.trim(),
                    response: document.getElementById('incidentResponse').value.trim(),
                    lessons: document.getElementById('incidentLessons').value.trim(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const index = this.data.incidents.findIndex(i => i.id === incidentData.id);
                if (index > -1) {
                    this.data.incidents[index] = incidentData;
                    this.showToast('Incident updated successfully', 'success');
                } else {
                    this.data.incidents.push(incidentData);
                    this.showToast('Incident logged successfully', 'success');
                }
                
                this.saveData('incidents', this.data.incidents);
                this.renderIncidents();
                
                bootstrap.Modal.getInstance(document.getElementById('incidentModal')).hide();
            }

            renderIncidents() {
                const tableBody = document.getElementById('incidentTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('incidentSearch')?.value.toLowerCase() || '';
                const severityFilter = document.getElementById('incidentSeverityFilter')?.value || 'all';
                
                let filteredIncidents = this.data.incidents;
                
                if (searchTerm) {
                    filteredIncidents = filteredIncidents.filter(incident =>
                        incident.title.toLowerCase().includes(searchTerm) ||
                        incident.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (severityFilter !== 'all') {
                    filteredIncidents = filteredIncidents.filter(incident => 
                        incident.severity.toLowerCase() === severityFilter.toLowerCase()
                    );
                }
                
                if (filteredIncidents.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-exclamation-octagon fs-4 d-block mb-2"></i>
                                    No incidents recorded yet. ${searchTerm ? 'Try a different search term.' : 'Log your first incident!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredIncidents.map(incident => {
                        const severityBadge = incident.severity === 'Critical' ? 'danger' : 
                                            incident.severity === 'High' ? 'danger' :
                                            incident.severity === 'Medium' ? 'warning' : 'secondary';
                        
                        return `
                            <tr>
                                <td data-label="Incident ID">
                                    <code>${incident.id}</code>
                                </td>
                                <td data-label="Title">
                                    <strong>${incident.title}</strong><br>
                                    <small class="text-muted">${incident.type}</small>
                                </td>
                                <td data-label="Type">
                                    <span class="badge bg-info">${incident.type}</span>
                                </td>
                                <td data-label="Severity">
                                    <span class="badge bg-${severityBadge}">${incident.severity}</span>
                                </td>
                                <td data-label="Status">
                                    <span class="status-badge status-${incident.status.toLowerCase()}">
                                        ${incident.status}
                                    </span>
                                </td>
                                <td data-label="Detected">
                                    ${incident.detected ? new Date(incident.detected).toLocaleDateString() : 'Unknown'}
                                </td>
                                <td data-label="Actions">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-light" onclick="app.showIncidentForm('${incident.id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="app.deleteItem('incident', '${incident.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // ===== TREATMENT MANAGEMENT =====
            showTreatmentForm(treatmentId = null) {
                this.currentEditId = treatmentId;
                this.currentEditType = 'treatment';
                
                const treatment = treatmentId ? this.data.treatments.find(t => t.id === treatmentId) : null;
                
                const formHTML = `
                    <form id="treatmentForm" onsubmit="app.saveTreatment(event)">
                        <input type="hidden" id="treatmentId" value="${treatment?.id || ''}">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Treatment Plan Title *</label>
                                <input type="text" class="form-control" id="treatmentTitle" 
                                       value="${treatment?.title || ''}" required placeholder="e.g., Implement MFA for all admin accounts">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Treatment Type *</label>
                                <select class="form-select" id="treatmentType" required>
                                    <option value="">Select...</option>
                                    <option value="Mitigate" ${treatment?.type === 'Mitigate' ? 'selected' : ''}>Mitigate</option>
                                    <option value="Transfer" ${treatment?.type === 'Transfer' ? 'selected' : ''}>Transfer</option>
                                    <option value="Accept" ${treatment?.type === 'Accept' ? 'selected' : ''}>Accept</option>
                                    <option value="Avoid" ${treatment?.type === 'Avoid' ? 'selected' : ''}>Avoid</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Related Risk</label>
                                <select class="form-select" id="treatmentRisk">
                                    <option value="">Select Risk...</option>
                                    ${this.data.risks.map(risk => `
                                        <option value="${risk.id}" ${treatment?.riskId === risk.id ? 'selected' : ''}>
                                            ${risk.title} (${risk.severity})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="treatmentStatus" required>
                                    <option value="">Select...</option>
                                    <option value="Planned" ${treatment?.status === 'Planned' ? 'selected' : ''}>Planned</option>
                                    <option value="In Progress" ${treatment?.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${treatment?.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Cancelled" ${treatment?.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" id="treatmentOwner" 
                                       value="${treatment?.owner || ''}" placeholder="e.g., Security Team">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="treatmentDueDate" 
                                       value="${treatment?.dueDate || ''}">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Progress (%)</label>
                                <input type="range" class="form-range" id="treatmentProgress" min="0" max="100" step="5"
                                       value="${treatment?.progress || 0}">
                                <div class="d-flex justify-content-between">
                                    <small>0%</small>
                                    <span id="progressValue" class="fw-bold">${treatment?.progress || 0}%</span>
                                    <small>100%</small>
                                </div>
                            </div>
                            
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Cost Estimate</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="treatmentCost" 
                                           value="${treatment?.cost || ''}" placeholder="Estimated cost">
                                    <span class="input-group-text">.00</span>
                                </div>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Action Steps</label>
                                <textarea class="form-control" id="treatmentActions" rows="3"
                                          placeholder="Detailed steps to implement this treatment...">${treatment?.actions || ''}</textarea>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Success Criteria</label>
                                <textarea class="form-control" id="treatmentCriteria" rows="2"
                                          placeholder="How will you know when this treatment is successful?...">${treatment?.criteria || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">${treatment ? 'Update' : 'Save'} Treatment</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('treatmentModalBody').innerHTML = formHTML;
                
                // Update progress value display
                const progressSlider = document.getElementById('treatmentProgress');
                const progressValue = document.getElementById('progressValue');
                if (progressSlider && progressValue) {
                    progressSlider.addEventListener('input', function() {
                        progressValue.textContent = this.value + '%';
                    });
                }
                
                const modal = new bootstrap.Modal(document.getElementById('treatmentModal'));
                modal.show();
            }

            saveTreatment(event) {
                event.preventDefault();
                
                const treatmentData = {
                    id: document.getElementById('treatmentId').value || 'TRT_' + Date.now(),
                    title: document.getElementById('treatmentTitle').value.trim(),
                    type: document.getElementById('treatmentType').value,
                    riskId: document.getElementById('treatmentRisk').value,
                    status: document.getElementById('treatmentStatus').value,
                    owner: document.getElementById('treatmentOwner').value.trim(),
                    dueDate: document.getElementById('treatmentDueDate').value,
                    progress: parseInt(document.getElementById('treatmentProgress').value) || 0,
                    cost: parseFloat(document.getElementById('treatmentCost').value) || 0,
                    actions: document.getElementById('treatmentActions').value.trim(),
                    criteria: document.getElementById('treatmentCriteria').value.trim(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const index = this.data.treatments.findIndex(t => t.id === treatmentData.id);
                if (index > -1) {
                    this.data.treatments[index] = treatmentData;
                    this.showToast('Treatment updated successfully', 'success');
                } else {
                    this.data.treatments.push(treatmentData);
                    this.showToast('Treatment added successfully', 'success');
                }
                
                this.saveData('treatments', this.data.treatments);
                this.renderTreatments();
                
                bootstrap.Modal.getInstance(document.getElementById('treatmentModal')).hide();
            }

            renderTreatments() {
                const tableBody = document.getElementById('treatmentTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('treatmentSearch')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('treatmentStatusFilter')?.value || 'all';
                
                let filteredTreatments = this.data.treatments;
                
                if (searchTerm) {
                    filteredTreatments = filteredTreatments.filter(treatment =>
                        treatment.title.toLowerCase().includes(searchTerm) ||
                        treatment.actions?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (statusFilter !== 'all') {
                    filteredTreatments = filteredTreatments.filter(treatment => 
                        treatment.status.toLowerCase().replace(' ', '-') === statusFilter
                    );
                }
                
                if (filteredTreatments.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-clipboard-check fs-4 d-block mb-2"></i>
                                    No treatment plans found. ${searchTerm ? 'Try a different search term.' : 'Add your first treatment plan!'}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredTreatments.map(treatment => {
                        const risk = treatment.riskId ? this.data.risks.find(r => r.id === treatment.riskId) : null;
                        const progressClass = treatment.progress < 30 ? 'bg-danger' : 
                                            treatment.progress < 70 ? 'bg-warning' : 'bg-success';
                        
                        return `
                            <tr>
                                <td data-label="Treatment Plan">
                                    <strong>${treatment.title}</strong><br>
                                    <small class="text-muted">${treatment.type}</small>
                                </td>
                                <td data-label="Risk">
                                    ${risk ? risk.title : 'Not linked'}
                                </td>
                                <td data-label="Type">
                                    <span class="badge bg-info">${treatment.type}</span>
                                </td>
                                <td data-label="Status">
                                    <span class="status-badge status-${treatment.status.toLowerCase().replace(' ', '-')}">
                                        ${treatment.status}
                                    </span>
                                </td>
                                <td data-label="Due Date">
                                    ${treatment.dueDate ? new Date(treatment.dueDate).toLocaleDateString() : 'Not set'}
                                    ${treatment.dueDate && new Date(treatment.dueDate) < new Date() && treatment.status !== 'Completed' ? 
                                        '<br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Overdue</small>' : ''}
                                </td>
                                <td data-label="Owner">${treatment.owner || 'Unassigned'}</td>
                                <td data-label="Progress">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                            <div class="progress-bar ${progressClass}" style="width: ${treatment.progress}%"></div>
                                        </div>
                                        <small>${treatment.progress}%</small>
                                    </div>
                                </td>
                                <td data-label="Actions">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-light" onclick="app.showTreatmentForm('${treatment.id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="app.deleteItem('treatment', '${treatment.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // ===== FRAMEWORK LIBRARY =====
            renderFrameworks() {
                const tableBody = document.getElementById('frameworkTableBody');
                if (!tableBody) return;

                const searchTerm = document.getElementById('frameworkSearch')?.value.toLowerCase() || '';
                const frameworkFilter = document.getElementById('frameworkSelect')?.value || 'all';
                const categoryFilter = document.getElementById('categorySelect')?.value || 'all';
                
                let allControls = [];
                
                // Combine all framework controls
                Object.values(this.frameworks).forEach(framework => {
                    framework.controls.forEach(control => {
                        allControls.push({
                            ...control,
                            framework: framework.name,
                            frameworkKey: Object.keys(this.frameworks).find(k => this.frameworks[k].name === framework.name)
                        });
                    });
                });
                
                // Apply filters
                let filteredControls = allControls;
                
                if (searchTerm) {
                    filteredControls = filteredControls.filter(control =>
                        control.name.toLowerCase().includes(searchTerm) ||
                        control.description.toLowerCase().includes(searchTerm) ||
                        control.id.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (frameworkFilter !== 'all') {
                    filteredControls = filteredControls.filter(control => 
                        control.frameworkKey === frameworkFilter
                    );
                }
                
                if (categoryFilter !== 'all') {
                    filteredControls = filteredControls.filter(control => 
                        control.category.toLowerCase().includes(categoryFilter.toLowerCase())
                    );
                }
                
                if (filteredControls.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-search fs-4 d-block mb-2"></i>
                                    No controls match your filters. Try adjusting your search.
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredControls.map(control => `
                        <tr>
                            <td data-label="Control ID">
                                <code>${control.id}</code>
                            </td>
                            <td data-label="Name">
                                <strong>${control.name}</strong><br>
                                <small class="text-muted">${control.category}</small>
                            </td>
                            <td data-label="Category">
                                <span class="badge bg-info">${control.category}</span>
                            </td>
                            <td data-label="Framework">
                                <span class="framework-badge badge-${control.frameworkKey}">${control.framework}</span>
                            </td>
                            <td data-label="Description">
                                <small>${control.description}</small>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // ===== RISK MATRIX =====
            renderRiskMatrix() {
                const container = document.getElementById('riskMatrix');
                if (!container) return;
                
                // Clear and create 5x5 grid
                container.innerHTML = '';
                
                for (let i = 5; i >= 1; i--) { // Likelihood (5 to 1)
                    for (let j = 1; j <= 5; j++) { // Impact (1 to 5)
                        const score = i * j;
                        const severity = this.calculateRiskSeverity(score);
                        
                        const cell = document.createElement('div');
                        cell.className = `matrix-cell ${severity.toLowerCase()}`;
                        cell.style.gridColumn = j;
                        cell.style.gridRow = 6 - i; // Reverse for visual display
                        cell.innerHTML = `
                            <div class="text-center p-2">
                                <small class="d-block text-muted">${this.getLikelihoodLabel(i)}/${this.getImpactLabel(j)}</small>
                                <strong class="d-block">${score}</strong>
                            </div>
                        `;
                        
                        // Add risk dots if any
                        const risksInCell = this.data.risks.filter(r => r.likelihood === i && r.impact === j);
                        if (risksInCell.length > 0) {
                            const dotContainer = document.createElement('div');
                            dotContainer.className = 'position-absolute top-0 start-0 w-100 h-100 p-1';
                            dotContainer.style.pointerEvents = 'none';
                            
                            risksInCell.forEach((risk, index) => {
                                const dot = document.createElement('div');
                                dot.className = 'position-absolute rounded-circle';
                                dot.style.width = '12px';
                                dot.style.height = '12px';
                                dot.style.background = risk.severity === 'High' ? '#ef4444' : 
                                                     risk.severity === 'Medium' ? '#f59e0b' : '#10b981';
                                dot.style.border = '2px solid white';
                                
                                // Position dots in a grid within the cell
                                const row = Math.floor(index / 3);
                                const col = index % 3;
                                dot.style.top = `${20 + row * 25}%`;
                                dot.style.left = `${20 + col * 25}%`;
                                
                                dotContainer.appendChild(dot);
                            });
                            
                            cell.appendChild(dotContainer);
                        }
                        
                        cell.addEventListener('click', () => this.showRisksInCell(i, j));
                        container.appendChild(cell);
                    }
                }
                
                // Add labels
                const labels = `
                    <div class="position-absolute top-0 start-0 w-100 d-flex justify-content-between px-4">
                        <div class="text-center">
                            <small class="text-muted">Impact </small>
                        </div>
                    </div>
                    <div class="position-absolute bottom-0 start-0 w-100 d-flex justify-content-between px-4">
                        ${[1,2,3,4,5].map(n => `<div><small class="text-muted">${n}</small></div>`).join('')}
                    </div>
                    <div class="position-absolute top-0 left-0 h-100 d-flex flex-column justify-content-between py-4">
                        <div class="text-center" style="transform: rotate(-90deg); transform-origin: center;">
                            <small class="text-muted">Likelihood </small>
                        </div>
                    </div>
                    <div class="position-absolute top-0 left-0 h-100 d-flex flex-column justify-content-between py-4">
                        ${[5,4,3,2,1].map(n => `<div class="text-center"><small class="text-muted">${n}</small></div>`).join('')}
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', labels);
            }

            showRisksInCell(likelihood, impact) {
                const risks = this.data.risks.filter(r => r.likelihood === likelihood && r.impact === impact);
                
                if (risks.length === 0) {
                    this.showToast(`No risks in this cell (Likelihood: ${likelihood}, Impact: ${impact})`, 'info');
                    return;
                }
                
                let message = `Risks in cell (Likelihood: ${likelihood}, Impact: ${impact}):\n\n`;
                risks.forEach(risk => {
                    message += ` ${risk.title} (${risk.severity})\n`;
                });
                
                alert(message);
            }

            toggleMatrixView(view) {
                // For now, just show inherent risk
                // Could be extended to show residual risk with controls applied
                this.renderRiskMatrix();
            }

            // ===== STATEMENT OF APPLICABILITY =====
            renderSOA() {
                const tableBody = document.getElementById('soaTableBody');
                if (!tableBody) return;

                // Build base SoA items from frameworks library
                let soaItems = [];
                Object.values(this.frameworks).forEach(framework => {
                    (framework.controls || []).forEach(control => {
                        // Determine implementation from Local Controls
                        const isImplemented = this.data.controls.some(c =>
                            c.framework === framework.name &&
                            c.controlId === control.id &&
                            c.status === 'Implemented'
                        );
                        const isPlanned = this.data.controls.some(c =>
                            c.framework === framework.name &&
                            c.controlId === control.id &&
                            c.status === 'Planned'
                        );

                        let implementationStatus = 'Not Implemented';
                        if (isImplemented) implementationStatus = 'Implemented';
                        else if (isPlanned) implementationStatus = 'Planned';

                        soaItems.push({
                            id: control.id,
                            name: control.name,
                            framework: framework.name,
                            category: control.category || '',
                            applicability: 'Applicable',
                            implementation: implementationStatus,
                            owner: '',
                            rationale: '',
                            evidence: ''
                        });
                    });
                });

                // Merge saved SoA edits (persisted locally)
                const keyOf = (fw, id) => `${fw}||${id}`;
                const saved = Array.isArray(this.data.soa) ? this.data.soa : [];
                const byKey = new Map(saved.map(r => [r.key || keyOf(r.framework, r.id), r]));
                soaItems = soaItems.map(item => {
                    const k = keyOf(item.framework, item.id);
                    const r = byKey.get(k);
                    if (!r) return item;
                    return {
                        ...item,
                        applicability: (r.applicability ?? item.applicability),
                        implementation: (r.implementation ?? item.implementation),
                        owner: (r.owner ?? item.owner),
                        rationale: (r.rationale ?? item.rationale),
                        evidence: (r.evidence ?? item.evidence)
                    };
                });

                // Apply framework filter
                const frameworkFilter = document.getElementById('soaFrameworkFilter')?.value || 'all';
                if (frameworkFilter !== 'all') {
                    const f = frameworkFilter.toLowerCase();
                    soaItems = soaItems.filter(item => item.framework.toLowerCase().includes(f));
                }

                if (soaItems.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="bi bi-file-text fs-4 d-block mb-2"></i>
                                    No SoA items found for the selected framework.
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Render editable rows
                tableBody.innerHTML = soaItems.map(item => {
                    const k = keyOf(item.framework, item.id);
                    const implBadge = item.implementation === 'Implemented' ? 'success'
                      : item.implementation === 'Planned' ? 'warning'
                      : 'danger';

                    return `
                        <tr data-soa-key="${this.escapeHtml(k)}">
                            <td data-label="Control ID"><code>${this.escapeHtml(item.id)}</code></td>
                            <td data-label="Control Name">
                                <strong>${this.escapeHtml(item.name)}</strong><br>
                                <small class="text-muted">${this.escapeHtml(item.category)}</small>
                            </td>
                            <td data-label="Framework">
                                <span class="badge bg-primary">${this.escapeHtml(item.framework)}</span>
                            </td>
                            <td data-label="Applicability">
                                <select class="form-select form-select-sm soa-app">
                                    <option value="Applicable" ${item.applicability === 'Applicable' ? 'selected' : ''}>Applicable</option>
                                    <option value="Not Applicable" ${item.applicability === 'Not Applicable' ? 'selected' : ''}>Not Applicable</option>
                                </select>
                            </td>
                            <td data-label="Implementation">
                                <select class="form-select form-select-sm soa-impl">
                                    <option value="Implemented" ${item.implementation === 'Implemented' ? 'selected' : ''}>Implemented</option>
                                    <option value="Planned" ${item.implementation === 'Planned' ? 'selected' : ''}>Planned</option>
                                    <option value="Not Implemented" ${item.implementation === 'Not Implemented' ? 'selected' : ''}>Not Implemented</option>
                                </select>
                                <div class="mt-1"><span class="badge bg-${implBadge}">${this.escapeHtml(item.implementation)}</span></div>
                            </td>
                            <td data-label="Rationale">
                                <textarea class="form-control form-control-sm soa-rat" rows="2" placeholder="Why applicable / not applicable...">${this.escapeHtml(item.rationale || '')}</textarea>
                                <input class="form-control form-control-sm mt-2 soa-owner" placeholder="Owner (optional)" value="${this.escapeHtml(item.owner || '')}">
                            </td>
                            <td data-label="Evidence">
                                <textarea class="form-control form-control-sm soa-evd" rows="2" placeholder="URLs, ticket IDs, policies, screenshots...">${this.escapeHtml(item.evidence || '')}</textarea>
                                <div class="small text-muted mt-1">Autosaved locally</div>
                            </td>
                        </tr>
                    `;
                }).join('');

                const upsert = (key, patch) => {
                    const [fw, id] = key.split('||');
                    const arr = Array.isArray(this.data.soa) ? [...this.data.soa] : [];
                    const idx = arr.findIndex(r => (r.key || `${r.framework}||${r.id}`) === key);
                    const base = {
                        key,
                        framework: fw,
                        id,
                        applicability: 'Applicable',
                        implementation: 'Not Implemented',
                        owner: '',
                        rationale: '',
                        evidence: '',
                        updatedAt: new Date().toISOString()
                    };
                    const next = { ...(idx >= 0 ? arr[idx] : base), ...patch, updatedAt: new Date().toISOString() };
                    if (idx >= 0) arr[idx] = next;
                    else arr.push(next);
                    this.saveData('soa', arr);
                };

                // bind once (delegated)
                if (!this._soaBound) {
                    tableBody.addEventListener('change', (e) => {
                        const tr = e.target.closest('tr[data-soa-key]');
                        if (!tr) return;
                        const key = tr.getAttribute('data-soa-key');
                        if (e.target.classList.contains('soa-app')) upsert(key, { applicability: e.target.value });
                        if (e.target.classList.contains('soa-impl')) upsert(key, { implementation: e.target.value });
                    });

                    let t;
                    tableBody.addEventListener('input', (e) => {
                        const tr = e.target.closest('tr[data-soa-key]');
                        if (!tr) return;
                        const key = tr.getAttribute('data-soa-key');
                        clearTimeout(t);
                        t = setTimeout(() => {
                            const rat = tr.querySelector('.soa-rat')?.value || '';
                            const evd = tr.querySelector('.soa-evd')?.value || '';
                            const owner = tr.querySelector('.soa-owner')?.value || '';
                            upsert(key, { rationale: rat, evidence: evd, owner });
                        }, 220);
                    });

                    this._soaBound = true;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // ===== REPORTS =====
            renderReports() {
                // Initialize report preview
                document.getElementById('reportContent').textContent = 
                    'Select a report type and click Generate to create a report.';
            }

            generateReport() {
                const reportType = document.getElementById('reportType')?.value || 'executive';
                let reportContent = '';
                let reportTitle = '';
                
                switch(reportType) {
                    case 'executive':
                        reportTitle = 'Executive Summary Report';
                        reportContent = this.generateExecutiveReport();
                        break;
                    case 'risk':
                        reportTitle = 'Risk Register Report';
                        reportContent = this.generateRiskReport();
                        break;
                    case 'compliance':
                        reportTitle = 'Compliance Gap Report';
                        reportContent = this.generateComplianceReport();
                        break;
                    case 'vendor':
                        reportTitle = 'Vendor Risk Report';
                        reportContent = this.generateVendorReport();
                        break;
                    case 'incident':
                        reportTitle = 'Incident Report';
                        reportContent = this.generateIncidentReport();
                        break;
                }
                
                document.getElementById('reportTitle').textContent = reportTitle;
                document.getElementById('reportContent').textContent = reportContent;
                this.showToast(`${reportTitle} generated successfully`, 'success');
            }

            generateExecutiveReport() {
                const totalRisks = this.data.risks.length;
                const highRisks = this.data.risks.filter(r => r.severity === 'High').length;
                const mediumRisks = this.data.risks.filter(r => r.severity === 'Medium').length;
                const implementedControls = this.data.controls.filter(c => c.status === 'Implemented').length;
                const totalControls = this.data.controls.length;
                const complianceRate = totalControls > 0 ? Math.round((implementedControls / totalControls) * 100) : 0;
                
                return `EXECUTIVE SUMMARY REPORT
Generated: ${new Date().toLocaleDateString()}

OVERVIEW
--------
Total Assets: ${this.data.assets.length}
Total Risks: ${totalRisks}
Total Controls: ${totalControls}
Compliance Rate: ${complianceRate}%

RISK SUMMARY
------------
 High Risks: ${highRisks}
 Medium Risks: ${mediumRisks}
 Low Risks: ${totalRisks - highRisks - mediumRisks}

TOP RISKS
---------
${this.data.risks
    .sort((a, b) => b.score - a.score)
    .slice(0, 5)
    .map((risk, i) => `${i + 1}. ${risk.title} (Score: ${risk.score}, Severity: ${risk.severity})`)
    .join('\n')}

RECOMMENDATIONS
---------------
1. Address high-risk items immediately
2. Implement planned controls
3. Regular risk assessments
4. Continuous monitoring

NEXT STEPS
----------
 Review and update risk register
 Implement control improvements
 Schedule next assessment
 Report to stakeholders`;
            }

            generateRiskReport() {
                return `RISK REGISTER REPORT
Generated: ${new Date().toLocaleDateString()}

TOTAL RISKS: ${this.data.risks.length}

RISK DETAILS
------------
${this.data.risks.map(risk => `
RISK: ${risk.title}
ID: ${risk.id}
Category: ${risk.category}
Severity: ${risk.severity} (Score: ${risk.score})
Status: ${risk.status}
Owner: ${risk.owner || 'Not assigned'}
Due Date: ${risk.dueDate || 'Not set'}
Description: ${risk.description || 'No description'}

`).join('---\n')}`;
            }

            copyReport() {
                const reportContent = document.getElementById('reportContent').textContent;
                navigator.clipboard.writeText(reportContent)
                    .then(() => this.showToast('Report copied to clipboard', 'success'))
                    .catch(() => this.showToast('Failed to copy report', 'error'));
            }

            exportReport() {
                const reportContent = document.getElementById('reportContent').textContent;
                const reportTitle = document.getElementById('reportTitle').textContent;
                
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportTitle.toLowerCase().replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('Report exported successfully', 'success');
            }

            // ===== CHALLENGES =====
            renderChallenges() {
                // Update challenge statuses
                this.updateChallengeStatus(1);
                this.updateChallengeStatus(2);
                this.updateChallengeStatus(3);
                this.updateChallengeStatus(4);
                
                // Calculate total points
                const totalPoints = Object.values(this.data.challenges.scores || {}).reduce((a, b) => a + b, 0);
                document.getElementById('totalPoints').textContent = totalPoints;
                
                // Update progress bar
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    const progress = Math.min(100, (totalPoints / 850) * 100); // 850 = max points
                    progressBar.style.width = `${progress}%`;
                }
            }

            updateChallengeStatus(challengeId) {
                const statusElement = document.getElementById(`challenge${challengeId}Status`);
                if (!statusElement) return;
                
                const progress = this.data.challenges.progress?.[challengeId] || {};
                const score = this.data.challenges.scores?.[challengeId] || 0;
                
                if (score > 0) {
                    statusElement.textContent = `Completed (${score} pts)`;
                    statusElement.className = 'text-success';
                } else if (Object.keys(progress).length > 0) {
                    statusElement.textContent = 'In Progress';
                    statusElement.className = 'text-warning';
                } else {
                    statusElement.textContent = 'Not Started';
                    statusElement.className = 'text-muted';
                }
            }

            startChallenge(challengeId) {
                this.switchTab('dashboard');
                this.showToast(`Starting Challenge ${challengeId}...`, 'info');
                
                // Set initial progress
                if (!this.data.challenges.progress) this.data.challenges.progress = {};
                if (!this.data.challenges.progress[challengeId]) {
                    this.data.challenges.progress[challengeId] = { started: new Date().toISOString() };
                }
                
                this.saveData('challenges', this.data.challenges);
                
                // Auto-load demo data for challenge 1
                if (challengeId === 1 && this.data.assets.length === 0) {
                    setTimeout(() => {
                        if (confirm('Load demo data for this challenge?')) {
                            this.loadDemoScenario();
                        }
                    }, 1000);
                }
            }

            resetChallenges() {
                if (confirm('Reset all challenge progress? This cannot be undone.')) {
                    this.data.challenges = { progress: {}, scores: {} };
                    this.saveData('challenges', this.data.challenges);
                    this.renderChallenges();
                    this.showToast('Challenge progress reset', 'info');
                }
            }

            // ===== DATA MANAGEMENT =====
            loadDemoScenario() {
                if (!confirm('Load demo scenario? This will replace your current data.')) {
                    return;
                }

                // Load comprehensive demo data
                this.data.assets = [
                    {
                        id: 'AST_001',
                        name: 'Customer Database',
                        type: 'Database',
                        criticality: 'High',
                        owner: 'IT Department',
                        description: 'Primary customer information database containing PII and financial data.',
                        dataTypes: ['PII', 'Financial'],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'AST_002',
                        name: 'Web Application',
                        type: 'Application',
                        criticality: 'High',
                        owner: 'Development Team',
                        description: 'Customer-facing web portal for account management.',
                        dataTypes: ['PII', 'Credentials'],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'AST_003',
                        name: 'Internal File Server',
                        type: 'Server',
                        criticality: 'Medium',
                        owner: 'IT Operations',
                        description: 'File server for internal documents and collaboration.',
                        dataTypes: ['Internal'],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                this.data.vendors = [
                    {
                        id: 'VDR_001',
                        name: 'Cloud Provider Inc.',
                        serviceType: 'Cloud Services',
                        riskLevel: 'Medium',
                        contractStatus: 'Active',
                        nextReviewDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        compliance: 'Compliant',
                        description: 'Primary cloud infrastructure provider for production workloads.',
                        contact: 'John Smith - Account Manager',
                        email: 'john.smith@cloudprovider.com',
                        assessment: 'Annual security assessment completed. Minor findings addressed.',
                        hasSLA: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                this.data.risks = [
                    {
                        id: 'RISK_001',
                        title: 'Data Breach via SQL Injection',
                        category: 'Cybersecurity',
                        status: 'Open',
                        likelihood: 4,
                        impact: 5,
                        score: 20,
                        severity: 'High',
                        description: 'Potential SQL injection vulnerability in web application could lead to data breach.',
                        owner: 'CISO',
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        mitigation: 'Implement WAF and regular security testing.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'RISK_002',
                        title: 'Insider Data Theft',
                        category: 'People',
                        status: 'In Progress',
                        likelihood: 3,
                        impact: 4,
                        score: 12,
                        severity: 'Medium',
                        description: 'Unauthorized access by privileged users could lead to data theft.',
                        owner: 'HR Director',
                        dueDate: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        mitigation: 'Implement privileged access management and monitoring.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'RISK_003',
                        title: 'Ransomware Attack',
                        category: 'Cybersecurity',
                        status: 'Open',
                        likelihood: 4,
                        impact: 4,
                        score: 16,
                        severity: 'High',
                        description: 'Ransomware could encrypt critical systems and data.',
                        owner: 'Security Team',
                        dueDate: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        mitigation: 'Implement endpoint protection and backup strategy.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                this.data.controls = [
                    {
                        id: 'CTL_001',
                        name: 'Multi-Factor Authentication',
                        type: 'Technical',
                        status: 'Implemented',
                        framework: 'ISO 27001',
                        owner: 'Security Team',
                        implementationDate: new Date().toISOString().split('T')[0],
                        description: 'MFA enforced for all administrative accounts.',
                        evidence: 'Okta dashboard configuration',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'CTL_002',
                        name: 'Web Application Firewall',
                        type: 'Technical',
                        status: 'Implemented',
                        framework: 'ISO 27001',
                        owner: 'Network Team',
                        implementationDate: new Date().toISOString().split('T')[0],
                        description: 'WAF protecting all web applications.',
                        evidence: 'Cloudflare WAF logs',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'CTL_003',
                        name: 'Security Awareness Training',
                        type: 'Administrative',
                        status: 'Planned',
                        framework: 'ISO 27001',
                        owner: 'HR Department',
                        implementationDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        description: 'Quarterly security awareness training for all employees.',
                        evidence: 'Training schedule and materials',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                this.data.issues = [
                    {
                        id: 'ISS_001',
                        title: 'Missing encryption on backup storage',
                        source: 'Audit',
                        severity: 'High',
                        status: 'Open',
                        dueDate: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        owner: 'Storage Team',
                        assetId: 'AST_003',
                        description: 'Backup storage does not have encryption at rest enabled, exposing sensitive data.',
                        remediation: 'Enable AES-256 encryption on all backup storage volumes.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                this.data.incidents = [
                    {
                        id: 'INC_001',
                        title: 'Phishing campaign targeting finance department',
                        type: 'Phishing',
                        severity: 'Medium',
                        status: 'Resolved',
                        detected: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                        owner: 'SOC Team',
                        affectedSystems: ['AST_002'],
                        description: 'Targeted phishing emails sent to finance employees pretending to be from CEO.',
                        response: 'Blocked malicious domains, conducted user awareness training.',
                        lessons: 'Need to implement advanced email filtering and regular phishing simulations.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                this.data.treatments = [
                    {
                        id: 'TRT_001',
                        title: 'Implement MFA for all admin accounts',
                        type: 'Mitigate',
                        riskId: 'RISK_002',
                        status: 'In Progress',
                        owner: 'Security Team',
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        progress: 65,
                        cost: 5000,
                        actions: '1. Evaluate MFA solutions\n2. Configure MFA for admin accounts\n3. Test and deploy\n4. Train users',
                        criteria: 'All admin accounts require MFA for authentication.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                // Save all data
                this.saveData('assets', this.data.assets);
                this.saveData('vendors', this.data.vendors);
                this.saveData('risks', this.data.risks);
                this.saveData('controls', this.data.controls);
                this.saveData('issues', this.data.issues);
                this.saveData('incidents', this.data.incidents);
                this.saveData('treatments', this.data.treatments);

                // Update all views
                this.renderDashboard();
                this.renderRisks();
                this.renderAssets();
                this.renderControls();
                this.renderVendors();
                this.renderIssues();
                this.renderIncidents();
                this.renderTreatments();
                this.renderFrameworks();
                this.renderRiskMatrix();
                this.renderSOA();
                
                this.showToast('Demo scenario loaded successfully!', 'success');
            }

            exportAllData() {
                const exportData = {
                    version: this.version,
                    exportedAt: new Date().toISOString(),
                    data: this.data,
                    frameworks: this.frameworks
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `grc_lab_export_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                this.showToast('All data exported successfully', 'success');
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Validate and merge data
                        if (importedData.data) {
                            Object.keys(importedData.data).forEach(key => {
                                if (this.data.hasOwnProperty(key)) {
                                    this.data[key] = importedData.data[key];
                                    this.saveData(key, this.data[key]);
                                }
                            });
                        }
                        
                        // Update all views
                        this.renderDashboard();
                        this.renderRisks();
                        this.renderAssets();
                        this.renderControls();
                        this.renderVendors();
                        this.renderIssues();
                        this.renderIncidents();
                        this.renderTreatments();
                        this.renderFrameworks();
                        this.renderRiskMatrix();
                        this.renderSOA();
                        
                        this.showToast('Data imported successfully', 'success');
                    } catch (error) {
                        this.showToast('Error importing data. Invalid file format.', 'error');
                    }
                };
                reader.readAsText(file);
            }

            // ===== UTILITIES =====
            deleteItem(type, id) {
                if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
                
                let collection = this.data[type + 's'];
                if (collection) {
                    this.data[type + 's'] = collection.filter(item => item.id !== id);
                    this.saveData(type + 's', this.data[type + 's']);
                    
                    // Update UI
                    this.renderDashboard();
                    if (this.currentTab === type + 's') {
                        this.renderTabContent(this.currentTab);
                    }
                    
                    this.showToast(`${type} deleted successfully`, 'info');
                }
            }

            showToast(message, type = 'info') {
                const toastEl = document.getElementById('liveToast');
                const toastMessage = document.getElementById('toastMessage');
                
                if (!toastEl || !toastMessage) return;
                
                // Set message
                toastMessage.textContent = message;
                
                // Set color based on type
                toastEl.className = 'toast';
                switch(type) {
                    case 'success':
                        toastEl.classList.add('bg-success', 'text-white');
                        break;
                    case 'error':
                        toastEl.classList.add('bg-danger', 'text-white');
                        break;
                    case 'warning':
                        toastEl.classList.add('bg-warning', 'text-dark');
                        break;
                    default:
                        toastEl.classList.add('bg-info', 'text-white');
                }
                
                // Show toast
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
            }

            showFirstTimeSetup() {
                const setupHTML = `
                    <div class="modal fade" id="firstTimeModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content bg-dark border border-light">
                                <div class="modal-header">
                                    <h5 class="modal-title">Welcome to GRC Practice Lab! </h5>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card-glass mb-3">
                                                <h6><i class="bi bi-rocket-takeoff me-2"></i> Quick Start</h6>
                                                <p>Load the demo scenario to see how the lab works with sample data.</p>
                                                <button class="btn btn-sm btn-primary w-100" onclick="app.loadDemoScenario(); bootstrap.Modal.getInstance(document.getElementById('firstTimeModal')).hide();">
                                                    Load Demo
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card-glass mb-3">
                                                <h6><i class="bi bi-plus-circle me-2"></i> Start Fresh</h6>
                                                <p>Begin with a clean slate and add your own data from scratch.</p>
                                                <button class="btn btn-sm btn-outline-light w-100" data-bs-dismiss="modal">
                                                    Start Fresh
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info bg-dark border-info mt-3">
                                        <h6><i class="bi bi-lightbulb me-2"></i> Tips for Getting Started:</h6>
                                        <ol class="mb-0">
                                            <li>Add your organization's assets first</li>
                                            <li>Identify risks for each asset</li>
                                            <li>Implement controls to mitigate risks</li>
                                            <li>Use the Risk Matrix to visualize risk levels</li>
                                            <li>Generate reports for stakeholders</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <small class="text-muted">This tool runs entirely in your browser. No data is sent to any server.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', setupHTML);
                const modal = new bootstrap.Modal(document.getElementById('firstTimeModal'));
                modal.show();
            }
        }

        // ===== INITIALIZE APPLICATION =====
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new GRCApplication();
            window.app = app; // Make available globally
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // File import handler
            document.getElementById('fileInput')?.addEventListener('change', (e) => app.importData(e));
        });

        // ===== GLOBAL HELPER FUNCTIONS =====
        function switchTab(tabName) {
            if (app) app.switchTab(tabName);
        }

        function loadDemoScenario() {
            if (app) app.loadDemoScenario();
        }

        function exportAllData() {
            if (app) app.exportAllData();
        }

        function generateReport() {
            if (app) app.generateReport();
        }

        function copyReport() {
            if (app) app.copyReport();
        }

        function exportReport() {
            if (app) app.exportReport();
        }

        function startChallenge(challengeId) {
            if (app) app.startChallenge(challengeId);
        }

        function resetChallenges() {
            if (app) app.resetChallenges();
        }

        // Make app available globally for inline event handlers
        window.GRCApp = app;
    </script>
</body>
</html>
