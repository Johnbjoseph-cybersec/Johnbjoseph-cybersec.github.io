<!DOCTYPE html>
<html lang="en">
<head>
  <title>GRC Practice Lab – John B Joseph</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

  <!-- Theme CSS from your site -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet"/>
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css"/>
  <link rel="stylesheet" href="css/animate.css"/>
  <link rel="stylesheet" href="css/owl.carousel.min.css"/>
  <link rel="stylesheet" href="css/owl.theme.default.min.css"/>
  <link rel="stylesheet" href="css/magnific-popup.css"/>
  <link rel="stylesheet" href="css/aos.css"/>
  <link rel="stylesheet" href="css/ionicons.min.css"/>
  <link rel="stylesheet" href="css/flaticon.css"/>
  <link rel="stylesheet" href="css/icomoon.css"/>
  <link rel="stylesheet" href="css/style.css"/>

  <style>
    .ftco-animate{opacity:1!important;visibility:visible!important;}
    .grc-lab-hero{padding-top:140px;padding-bottom:40px;}
    .grc-tab-buttons .btn{margin-right:8px;margin-bottom:8px;}
    .grc-tab{display:none;} .grc-tab.active{display:block;}
    .grc-lab-container{width:80vw;max-width:1600px;margin:0 auto;}
    @media (max-width:991.98px){.grc-lab-container{width:100vw;}}
    .dashboard-card{border:1px solid rgba(255,255,255,.06);border-radius:10px;background:#111827;color:#fff;}
    .dashboard-card .label{font-size:.75rem;letter-spacing:.06em;opacity:.7;text-transform:uppercase;}
    .dashboard-card .value{font-size:1.4rem;font-weight:600;}
    .dashboard-card .sub{font-size:.8rem;opacity:.8;}
    .heat-cell{color:#fff;font-weight:600;text-align:center;white-space:nowrap;}
    .heat-cell small{display:block;font-weight:400;opacity:.9;}
    .heat-good{background:#1f8f3b;} .heat-medium{background:#a96b1f;}
    .heat-low{background:#8f3b1f;} .heat-none{background:#7a1f1f;}
    .heat-pill{border-radius:999px;padding:4px 10px;font-size:.8rem;display:inline-block;}
    #risk-matrix-canvas{background:#0c0f12;border-radius:8px;width:100%;max-width:100%;}
    .table td,.table th{vertical-align:middle;}
    .small-muted{color:#9ca3af;font-size:.85rem;}
    textarea#summary-text{
      background:#020617;
      color:#e5e7eb;
      border:none;
      font-family:Menlo,Consolas,monospace;
      font-size:.9rem;
      white-space:pre-wrap;
    }
    th[data-risk-sort]{cursor:pointer;}
    th[data-risk-sort].sorted-asc::after{content:" ▲";font-size:.7rem;}
    th[data-risk-sort].sorted-desc::after{content:" ▼";font-size:.7rem;}
  </style>
</head>

<body data-spy="scroll" data-target=".site-navbar-target" data-offset="300">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar ftco-navbar-light site-navbar-target" id="ftco-navbar">
    <div class="container">
      <a class="navbar-brand" href="index.html">John B Joseph</a>
      <button class="navbar-toggler js-fh5co-nav-toggle fh5co-nav-toggle" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="oi oi-menu"></span> Menu
      </button>
      <div class="collapse navbar-collapse" id="ftco-nav">
        <ul class="navbar-nav nav ml-auto">
          <li class="nav-item"><a href="index.html#home-section" class="nav-link"><span>Home</span></a></li>
          <li class="nav-item"><a href="toolkit.html" class="nav-link"><span>Toolkit</span></a></li>
          <li class="nav-item active"><a href="grc-lab.html" class="nav-link"><span>GRC Practice Lab</span></a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Lab -->
  <section class="ftco-section grc-lab-hero">
    <div class="grc-lab-container container-fluid px-4 px-md-5">
      <!-- Header -->
      <div class="row justify-content-center mb-4">
        <div class="col-md-10 text-center ftco-animate">
          <h1 class="mb-3">GRC Practice Lab (v3)</h1>
          <p class="lead">Practice frameworks, assets, risks, controls, issues, actions and reporting — all in your browser (data stays local).</p>
          <p class="small-muted mb-0">Controls are paraphrased from ISO 27001, NIST CSF, PCI DSS, HIPAA for education only.</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="row mb-4">
        <div class="col-md-12 text-center grc-tab-buttons">
          <button class="btn btn-primary btn-sm" data-grc-tab="frameworks">Frameworks &amp; Controls</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="assets">Assets</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="risks">Risks</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="controls">Local Controls</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="issues">Issues / Findings</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="gap">Gap Analysis</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="dashboard">Dashboard</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="matrix">Risk Matrix</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="treatments">Treatments</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="summary">Auditor Summary</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="settings">Settings</button>
        </div>
      </div>

      <!-- Frameworks -->
      <div id="tab-frameworks" class="grc-tab active ftco-animate">
        <h3>Framework Library</h3>
        <p class="mb-3">Filter and review a unified control set aligned to ISO/NIST/PCI/HIPAA.</p>

        <div class="row mb-3">
          <div class="col-md-4 mb-2">
            <label class="text-muted small mb-1">Filter by Framework</label>
            <select id="framework-filter" class="form-control form-control-sm">
              <option value="all">All frameworks</option>
              <option value="ISO 27001">ISO 27001</option>
              <option value="NIST CSF">NIST CSF</option>
              <option value="PCI DSS">PCI DSS</option>
              <option value="HIPAA">HIPAA</option>
            </select>
          </div>
          <div class="col-md-4 mb-2">
            <label class="text-muted small mb-1">Filter by Category</label>
            <select id="category-filter" class="form-control form-control-sm">
              <option value="all">All categories</option>
              <option>Access Control</option>
              <option>Identity &amp; Authentication</option>
              <option>Logging &amp; Monitoring</option>
              <option>Encryption &amp; Key Management</option>
              <option>Backup &amp; Recovery</option>
              <option>Change Management</option>
              <option>Vulnerability Management</option>
              <option>Incident Response</option>
              <option>Vendor Risk</option>
              <option>Policy &amp; Governance</option>
              <option>Awareness &amp; Training</option>
            </select>
          </div>
          <div class="col-md-4 mb-2">
            <label class="text-muted small mb-1">Search</label>
            <input id="framework-search" class="form-control form-control-sm" placeholder="Search by name, ID, description...">
          </div>
        </div>

        <div class="table-responsive bg-dark p-3 rounded">
          <table class="table table-dark table-striped table-hover table-sm mb-0">
            <thead>
              <tr>
                <th style="width:10%">ID</th>
                <th style="width:20%">Name</th>
                <th style="width:18%">Category</th>
                <th style="width:20%">Based On</th>
                <th style="width:32%">Description</th>
              </tr>
            </thead>
            <tbody id="frameworks-table-body"></tbody>
          </table>
          <div class="mt-2 text-right">
            <small id="frameworks-count" class="text-muted"></small>
          </div>
        </div>
      </div>

      <!-- Assets -->
      <div id="tab-assets" class="grc-tab ftco-animate">
        <h3>Asset Inventory</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Asset</h5>
              <form id="asset-form">
                <input type="hidden" id="asset-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Name *</label>
                  <input id="asset-name" class="form-control form-control-sm" required placeholder="e.g. MediCloud Web App">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Type *</label>
                  <select id="asset-type" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Application</option><option>Database</option><option>Server / Host</option>
                    <option>Network / Security Device</option><option>Cloud Service</option>
                    <option>Vendor / Third Party</option><option>Data Store</option>
                    <option>People / Role</option><option>Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Business criticality *</label>
                  <select id="asset-criticality" class="form-control form-control-sm" required>
                    <option value="">Select level...</option>
                    <option>High</option><option>Medium</option><option>Low</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1 d-block">Data types</label>
                  <div class="d-flex flex-wrap">
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-phi" value="PHI">
                      <label class="custom-control-label" for="dt-phi">PHI</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-pii" value="PII">
                      <label class="custom-control-label" for="dt-pii">PII</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-pan" value="Card data">
                      <label class="custom-control-label" for="dt-pan">Card data</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-int" value="Internal data">
                      <label class="custom-control-label" for="dt-int">Internal data</label>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Owner</label>
                  <input id="asset-owner" class="form-control form-control-sm" placeholder="e.g. DevOps Team / CTO">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Notes</label>
                  <textarea id="asset-notes" class="form-control form-control-sm" rows="2" placeholder="Scope, region, integrations..."></textarea>
                </div>
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="asset-form-submit">Save asset</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="asset-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally in your browser.</small>
              </form>
            </div>
          </div>
          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
             <div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Assets</h5>
  <div>
    <button id="export-assets" class="btn btn-xs btn-outline-light mr-2">Export CSV</button>
    <small id="assets-count" class="text-muted"></small>
  </div>
</div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:22%">Name</th><th style="width:16%">Type</th><th style="width:14%">Criticality</th>
                      <th style="width:20%">Data types</th><th style="width:16%">Owner</th><th style="width:12%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="assets-table-body"></tbody>
                </table>
              </div>
              <div id="assets-empty" class="text-muted small mt-2">No assets yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risks -->
      <div id="tab-risks" class="grc-tab ftco-animate">
        <h3>Risk Register</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Risk</h5>
              <form id="risk-form">
                <input type="hidden" id="risk-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Title *</label>
                  <input id="risk-title" class="form-control form-control-sm" required placeholder="e.g. Unauthorised access to app">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Asset *</label>
                  <select id="risk-asset" class="form-control form-control-sm" required>
                    <option value="">Select asset...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Category *</label>
                  <select id="risk-category" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Cybersecurity</option><option>Compliance</option><option>Operational</option>
                    <option>Privacy</option><option>Third-Party</option><option>Other</option>
                  </select>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Likelihood (1–5) *</label>
                    <select id="risk-likelihood" class="form-control form-control-sm" required>
                      <option value="">Select...</option>
                      <option value="1">1 – Rare</option><option value="2">2 – Unlikely</option><option value="3">3 – Possible</option>
                      <option value="4">4 – Likely</option><option value="5">5 – Almost certain</option>
                    </select>
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Impact (1–5) *</label>
                    <select id="risk-impact" class="form-control form-control-sm" required>
                      <option value="">Select...</option>
                      <option value="1">1 – Insignificant</option><option value="2">2 – Minor</option><option value="3">3 – Moderate</option>
                      <option value="4">4 – Major</option><option value="5">5 – Severe</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Owner</label>
                  <input id="risk-owner" class="form-control form-control-sm" placeholder="e.g. CISO / Product Owner">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Status *</label>
                  <select id="risk-status" class="form-control form-control-sm" required>
                    <option>Open</option><option>In progress</option><option>Mitigated</option><option>Accepted</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Description / Notes</label>
                  <textarea id="risk-notes" class="form-control form-control-sm" rows="2"></textarea>
                </div>
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="risk-form-submit">Save risk</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="risk-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">
                  Score = Likelihood × Impact (1–25). High / Medium / Low thresholds are configurable in Settings.
                </small>
              </form>
            </div>
          </div>
          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
             <div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Risks</h5>
  <div>
    <button id="export-risks" class="btn btn-xs btn-outline-light mr-2">Export CSV</button>
    <small id="risks-count" class="text-muted"></small>
  </div>
</div>

              <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                <div class="form-inline mb-2">
                  <label class="text-muted small mr-1">Status</label>
                  <select id="risk-filter-status" class="form-control form-control-sm mr-2">
                    <option value="all">All</option>
                    <option>Open</option>
                    <option>In progress</option>
                    <option>Mitigated</option>
                    <option>Accepted</option>
                  </select>
                  <label class="text-muted small mr-1">Level</label>
                  <select id="risk-filter-level" class="form-control form-control-sm">
                    <option value="all">All</option>
                    <option>High</option>
                    <option>Medium</option>
                    <option>Low</option>
                  </select>
                </div>
                <small id="risks-filter-pill" class="text-muted mb-2">No filters applied</small>
              </div>

              <div class="table-responsive">
                <table id="risks-table" class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:26%" data-risk-sort="title">Title</th>
                      <th style="width:18%" data-risk-sort="asset">Asset</th>
                      <th style="width:16%" data-risk-sort="category">Category</th>
                      <th style="width:16%" data-risk-sort="score">Inherent</th>
                      <th style="width:14%" data-risk-sort="status">Status</th>
                      <th style="width:10%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="risks-table-body"></tbody>
                </table>
              </div>
              <div id="risks-empty" class="text-muted small mt-2">No risks yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Local Controls -->
      <div id="tab-controls" class="grc-tab ftco-animate">
        <h3>Local Controls (Org Library)</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Control</h5>
              <form id="control-form">
                <input type="hidden" id="control-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Control name *</label>
                  <input id="control-name" class="form-control form-control-sm" required placeholder="e.g. Enforce MFA for admins">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Type *</label>
                  <select id="control-type" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Preventive</option><option>Detective</option><option>Corrective</option>
                    <option>Administrative</option><option>Technical</option><option>Physical</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Status *</label>
                  <select id="control-status" class="form-control form-control-sm" required>
                    <option>In place</option><option>Planned</option><option>Not applicable</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Owner</label>
                  <input id="control-owner" class="form-control form-control-sm" placeholder="DevSecOps / IT Ops / Compliance">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Description</label>
                  <textarea id="control-description" class="form-control form-control-sm" rows="2" placeholder="Implementation details"></textarea>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Related risks</label>
                  <select id="control-risks" class="form-control form-control-sm" multiple></select>
                  <small class="text-muted">Hold Ctrl/Cmd to multi-select.</small>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Related framework controls</label>
                  <select id="control-frameworks" class="form-control form-control-sm" multiple></select>
                </div>
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="control-form-submit">Save control</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="control-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally with assets, risks and issues.</small>
              </form>
            </div>
          </div>
          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
             <div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Controls</h5>
  <div>
    <button id="export-controls" class="btn btn-xs btn-outline-light mr-2">Export CSV</button>
    <small id="controls-count" class="text-muted"></small>
  </div>
</div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:26%">Name</th><th style="width:16%">Type</th><th style="width:14%">Status</th>
                      <th style="width:22%">Linked risks</th><th style="width:12%">Frameworks</th><th style="width:10%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="controls-table-body"></tbody>
                </table>
              </div>
              <div id="controls-empty" class="text-muted small mt-2">No controls yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Issues / Findings -->
      <div id="tab-issues" class="grc-tab ftco-animate">
        <h3>Issues &amp; Findings</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Issue</h5>
              <form id="issue-form">
                <input type="hidden" id="issue-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Title *</label>
                  <input id="issue-title" class="form-control form-control-sm" required placeholder="e.g. Missing MFA for admins">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Type *</label>
                  <select id="issue-type" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Audit</option><option>Pen test</option><option>Incident</option><option>Risk review</option><option>Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Linked objects (optional)</label>
                  <select id="issue-asset" class="form-control form-control-sm mb-1"><option value="">Linked asset...</option></select>
                  <select id="issue-risk"  class="form-control form-control-sm mb-1"><option value="">Linked risk...</option></select>
                  <select id="issue-control" class="form-control form-control-sm"><option value="">Linked control...</option></select>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Severity *</label>
                    <select id="issue-severity" class="form-control form-control-sm" required>
                      <option value="">Select...</option>
                      <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
                    </select>
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Status *</label>
                    <select id="issue-status" class="form-control form-control-sm" required>
                      <option>Open</option><option>In progress</option><option>Resolved</option><option>Accepted</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Owner</label>
                    <input id="issue-owner" class="form-control form-control-sm" placeholder="e.g. Dev Lead">
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Due date</label>
                    <input type="date" id="issue-due" class="form-control form-control-sm">
                  </div>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Details / Recommendation</label>
                  <textarea id="issue-notes" class="form-control form-control-sm" rows="2"></textarea>
                </div>
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="issue-form-submit">Save issue</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="issue-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally in your browser.</small>
              </form>
            </div>
          </div>
          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
            <div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Issues / Findings</h5>
  <div>
    <button id="export-issues" class="btn btn-xs btn-outline-light mr-2">Export CSV</button>
    <small id="issues-count" class="text-muted"></small>
  </div>
</div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:24%">Title</th><th style="width:12%">Type</th><th style="width:14%">Severity</th>
                      <th style="width:16%">Status</th><th style="width:18%">Linked to</th><th style="width:16%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="issues-table-body"></tbody>
                </table>
              </div>
              <div id="issues-empty" class="text-muted small mt-2">No issues yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gap Analysis -->
      <div id="tab-gap" class="grc-tab ftco-animate">
        <h3>Gap analysis &amp; heatmap</h3>
        <p class="mb-3">Coverage is based on <b>local controls</b> mapped to framework controls. “In place” = implemented; “Planned” = planned-only.</p>
        <div class="table-responsive bg-dark p-3 rounded">
          <table class="table table-dark table-striped table-hover table-sm mb-0">
            <thead>
              <tr>
                <th style="width:24%">Category</th>
                <th style="width:12%">Total controls</th>
                <th style="width:16%">Implemented</th>
                <th style="width:16%">Planned only</th>
                <th style="width:16%">Not implemented</th>
                <th style="width:16%">Heatmap</th>
              </tr>
            </thead>
            <tbody id="gap-table-body"></tbody>
          </table>
          <div class="mt-2 text-right"><small id="gap-overall-coverage" class="text-muted"></small></div>
        </div>
      </div>

      <!-- Dashboard -->
      <div id="tab-dashboard" class="grc-tab ftco-animate">
        <h3>Dashboard</h3>
        <div class="row">
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100"><div class="label">Assets</div><div class="value" id="dash-assets">0</div><div class="sub">Tracked in inventory</div></div>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100"><div class="label">Risks</div><div class="value" id="dash-risks">0</div><div class="sub"><span id="dash-high">0</span> high risk(s)</div></div>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100"><div class="label">Controls</div><div class="value" id="dash-controls">0</div><div class="sub">Local org controls</div></div>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100"><div class="label">Issues</div><div class="value" id="dash-issues">0</div><div class="sub"><span id="dash-overdue">0</span> overdue</div></div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-4 mb-3">
            <div class="dashboard-card p-3 h-100 d-flex flex-column justify-content-between">
              <div>
                <div class="label">Framework coverage</div>
                <div class="value"><span id="dash-coverage">0%</span></div>
                <div class="sub">Implemented local controls mapped to framework controls.</div>
              </div>
              <div class="mt-2"><span id="dash-coverage-pill" class="heat-pill heat-none">Coverage heat</span></div>
            </div>
          </div>
          <div class="col-md-8 mb-3">
            <div class="dashboard-card p-3 h-100">
              <div class="label mb-1">Scenarios &amp; exports</div>
              <p class="sub">Export current lab to JSON, import saved scenarios, load a demo, or reset to blank.</p>
              <div class="d-flex flex-wrap">
                <button id="btn-export" class="btn btn-sm btn-primary mr-2 mb-2">Export current data (JSON)</button>
                <button id="btn-import" class="btn btn-sm btn-outline-light mr-2 mb-2">Import scenario (JSON)</button>
                <button id="btn-load-demo" class="btn btn-sm btn-outline-info mr-2 mb-2">Load demo: MediCloud scenario</button>
                <button id="btn-reset" class="btn btn-sm btn-outline-danger mb-2">Reset lab (clear all data)</button>
                <input type="file" id="file-import" accept="application/json" style="display:none">
              </div>
              <small id="import-status" class="text-muted d-block mt-2"></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Matrix -->
      <div id="tab-matrix" class="grc-tab ftco-animate">
        <h3>Risk Matrix (Inherent vs Residual)</h3>
        <p class="mb-3">Toggle to compare <b>Inherent</b> and a basic calculated <b>Residual</b> (reduced by implemented controls linked to a risk). Matrix thresholds follow your Settings.</p>
        <div class="bg-dark p-3 rounded mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-sm btn-primary active" id="toggle-inherent"><input type="radio" name="mx" checked> Inherent</label>
              <label class="btn btn-sm btn-outline-light" id="toggle-residual"><input type="radio" name="mx"> Residual</label>
            </div>
            <button id="matrix-export" class="btn btn-outline-light btn-sm">Export as PNG</button>
          </div>
          <canvas id="risk-matrix-canvas" width="920" height="640"></canvas>
          <div id="matrix-legend" class="mt-3 text-center text-muted small"></div>
        </div>
      </div>

      <!-- Treatments -->
      <div id="tab-treatments" class="grc-tab ftco-animate">
        <h3>Treatments (Mitigation Plan)</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Treatment</h5>
              <form id="treat-form">
                <input type="hidden" id="treat-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Action title *</label>
                  <input id="treat-title" class="form-control form-control-sm" required placeholder="e.g. Enforce SSO & MFA for admins">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Linked risk *</label>
                  <select id="treat-risk" class="form-control form-control-sm" required><option value="">Select risk...</option></select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Linked control (optional)</label>
                  <select id="treat-control" class="form-control form-control-sm"><option value="">Select control...</option></select>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Status *</label>
                    <select id="treat-status" class="form-control form-control-sm" required>
                      <option>Open</option><option>In progress</option><option>Closed</option><option>Deferred</option>
                    </select>
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Target date</label>
                    <input type="date" id="treat-date" class="form-control form-control-sm">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Owner</label>
                    <input id="treat-owner" class="form-control form-control-sm" placeholder="e.g. DevOps Lead">
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Budget (optional)</label>
                    <input id="treat-budget" class="form-control form-control-sm" placeholder="e.g. 2,500 USD">
                  </div>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Notes</label>
                  <textarea id="treat-notes" class="form-control form-control-sm" rows="2"></textarea>
                </div>
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="treat-submit">Save action</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="treat-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally. Link actions to risks to show progress in reports.</small>
              </form>
            </div>
          </div>
          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Treatment actions</h5>
  <div>
    <button id="export-treatments" class="btn btn-xs btn-outline-light mr-2">Export CSV</button>
    <small id="treat-count" class="text-muted"></small>
  </div>
</div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:28%">Title</th><th style="width:22%">Linked</th>
                      <th style="width:14%">Status</th><th style="width:16%">Target</th>
                      <th style="width:8%">Owner</th><th style="width:12%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="treat-table-body"></tbody>
                </table>
              </div>
              <div id="treat-empty" class="text-muted small mt-2">No treatment actions yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Auditor Summary -->
      <div id="tab-summary" class="grc-tab ftco-animate">
        <h3>Auditor-style summary</h3>
        <p class="mb-3">Automatically generate a narrative you can reuse in audit reports, board decks, or certifications.</p>
        <div class="bg-dark p-3 rounded mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small-muted">Summary is generated from your current assets, risks, controls, treatments and issues.</span>
            <button id="summary-refresh" class="btn btn-sm btn-primary">Refresh summary</button>
          </div>
          <textarea id="summary-text" class="form-control" rows="16"></textarea>
          <div class="small-muted mt-2">Tip: Copy–paste this into an audit report, SOC 2 narrative, or ISO 27001 SoA summary.</div>
        </div>
      </div>

      <!-- Settings -->
      <div id="tab-settings" class="grc-tab ftco-animate">
        <h3>Lab settings</h3>
        <p class="mb-3 small-muted">
          Tune how the lab scores risks and draws the matrix. Settings are stored only in this browser and will apply to the dashboard, matrix and summaries.
        </p>
        <div class="bg-dark p-3 rounded">
          <div class="row">
            <div class="col-md-6 mb-3">
              <h5 class="mb-2">Risk scoring thresholds</h5>
              <div class="form-group">
                <label class="text-muted small mb-1">High risk threshold (score ≥)</label>
                <input type="number" min="1" max="25" id="set-high" class="form-control form-control-sm">
              </div>
              <div class="form-group">
                <label class="text-muted small mb-1">Medium risk threshold (score ≥)</label>
                <input type="number" min="1" max="25" id="set-med" class="form-control form-control-sm">
              </div>
              <small class="small-muted d-block mb-2">Low risk is any score below the medium threshold.</small>
            </div>
            <div class="col-md-6 mb-3">
              <h5 class="mb-2">Risk matrix</h5>
              <div class="form-group">
                <label class="text-muted small mb-1">Matrix size</label>
                <select id="set-matrix" class="form-control form-control-sm">
                  <option value="5">5×5 (default)</option>
                  <option value="3">3×3</option>
                </select>
              </div>
              <small class="small-muted d-block mb-2">
                Likelihood and impact values (1–5) will be scaled to the selected grid when plotting risks.
              </small>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <button id="set-save" class="btn btn-sm btn-primary">Save settings</button>
            <small id="set-status" class="small-muted"></small>
          </div>
        </div>
      </div>

    </div>
  </section>

  <footer class="ftco-footer ftco-section">
    <div class="container">
      <div class="row"><div class="col-md-12 text-center">
        <p>Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | GRC Practice Lab by John B Joseph</p>
      </div></div>
    </div>
  </footer>

  <!-- Core scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/main.js"></script>

  <!-- GRC Lab App -->
  <script>
  // ---------- Framework library ----------
  const FRAMEWORK_CONTROLS = [
    {id:"CTRL-AC-01",name:"Manage user accounts",category:"Access Control",
      description:"Only approved users receive accounts; access removed quickly on role change or leaving.",
      frameworks:["ISO 27001","NIST CSF"],references:["ISO 27001 A.9","NIST PR.AC-1"]},
    {id:"CTRL-AC-02",name:"Limit privileged access",category:"Identity & Authentication",
      description:"Privileged roles are tightly controlled, logged and periodically reviewed.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS"],references:["ISO 27001 A.9.2","NIST PR.AC-4","PCI DSS 7"]},
    {id:"CTRL-AC-03",name:"Strong authentication",category:"Identity & Authentication",
      description:"Multi-factor authentication is used for admin accounts and remote access to critical systems.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS","HIPAA"],references:["ISO 27001 A.9.4","NIST PR.AC-7","PCI DSS 8","HIPAA 164.312(d)"]},
    {id:"CTRL-LOG-01",name:"Central activity logging",category:"Logging & Monitoring",
      description:"Security events from key systems are collected centrally for correlation and investigation.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS"],references:["ISO 27001 A.12.4","NIST DE.AE-1","PCI DSS 10"]},
    {id:"CTRL-LOG-02",name:"Regular log review",category:"Logging & Monitoring",
      description:"Important system logs are reviewed and suspicious events investigated and documented.",
      frameworks:["ISO 27001","NIST CSF","HIPAA"],references:["ISO 27001 A.12.4","NIST DE.CM-1","HIPAA 164.308(a)(1)"]},
    {id:"CTRL-ENC-01",name:"Encrypt data at rest",category:"Encryption & Key Management",
      description:"Sensitive data in databases, file systems and backups is encrypted using approved algorithms.",
      frameworks:["ISO 27001","PCI DSS","HIPAA"],references:["ISO 27001 A.10","PCI DSS 3","HIPAA 164.312(a)(2)(iv)"]},
    {id:"CTRL-ENC-02",name:"Encrypt data in transit",category:"Encryption & Key Management",
      description:"TLS is enforced for sensitive data in transit; weak ciphers and protocols are disabled.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS","HIPAA"],references:["ISO 27001 A.13","NIST PR.DS-2","PCI DSS 4","HIPAA 164.312(e)(1)"]},
    {id:"CTRL-BCP-01",name:"Backups & restore testing",category:"Backup & Recovery",
      description:"Critical systems are backed up and restore tests are performed and documented.",
      frameworks:["ISO 27001","NIST CSF"],references:["ISO 27001 A.12.3","NIST PR.IP-4"]},
    {id:"CTRL-CHG-01",name:"Controlled changes",category:"Change Management",
      description:"Changes follow an approved process including impact assessment, testing and rollback.",
      frameworks:["ISO 27001","NIST CSF"],references:["ISO 27001 A.12.1","NIST PR.IP-3"]},
    {id:"CTRL-CHG-02",name:"Separate environments",category:"Change Management",
      description:"Development and test environments are separated from production with restricted access.",
      frameworks:["ISO 27001","PCI DSS"],references:["ISO 27001 A.12.1.4","PCI DSS 6.4"]},
    {id:"CTRL-VULN-01",name:"Vulnerability management",category:"Vulnerability Management",
      description:"Regular scans are run; patches and fixes are applied according to defined timelines.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS"],references:["ISO 27001 A.12.6","NIST DE.CM-8","PCI DSS 11"]},
    {id:"CTRL-IR-01",name:"Incident response plan",category:"Incident Response",
      description:"A documented incident response plan defines roles, steps and communications.",
      frameworks:["ISO 27001","NIST CSF","HIPAA"],references:["ISO 27001 A.16","NIST RS.RP-1","HIPAA 164.308(a)(6)"]},
    {id:"CTRL-IR-02",name:"Detect and triage events",category:"Incident Response",
      description:"Events are detected, triaged and escalated based on documented procedures.",
      frameworks:["ISO 27001","NIST CSF"],references:["ISO 27001 A.16","NIST DE.CM-1"]},
    {id:"CTRL-VND-01",name:"Vendor due diligence",category:"Vendor Risk",
      description:"Third parties are assessed before onboarding and periodically thereafter.",
      frameworks:["ISO 27001","NIST CSF"],references:["ISO 27001 A.15","NIST ID.SC-1"]},
    {id:"CTRL-VND-02",name:"Data protection in contracts",category:"Vendor Risk",
      description:"Vendor contracts include data protection clauses, breach notification and audit rights.",
      frameworks:["ISO 27001","HIPAA"],references:["ISO 27001 A.15.1.2","HIPAA 164.308(b)"]},
    {id:"CTRL-POL-01",name:"Information security policy",category:"Policy & Governance",
      description:"Management-approved policies define security objectives, roles and responsibilities.",
      frameworks:["ISO 27001","NIST CSF"],references:["ISO 27001 A.5","NIST ID.GV-1"]},
    {id:"CTRL-AW-01",name:"Security awareness training",category:"Awareness & Training",
      description:"People receive regular training on security, privacy, phishing and incident reporting.",
      frameworks:["ISO 27001","NIST CSF","HIPAA"],references:["ISO 27001 A.7.2.2","NIST PR.AT-1","HIPAA 164.308(a)(5)"]}
  ];

  // ---------- Storage ----------
  const K = {
    assets:'grc_assets_v1',
    risks:'grc_risks_v1',
    controls:'grc_controls_v1',
    issues:'grc_issues_v1',
    treats:'grc_treatments_v1',
    settings:'grc_settings_v1'
  };
  const load = k => { try { const v = JSON.parse(localStorage.getItem(k)); return Array.isArray(v)?v:[]; } catch { return []; } };
  const save = (k,v) => localStorage.setItem(k,JSON.stringify(v));

  let assets = load(K.assets);
  let risks = load(K.risks);
  let controls = load(K.controls);
  let issues = load(K.issues);
  let treatments = load(K.treats);

  // ---------- Settings (risk thresholds + matrix) ----------
  function loadSettings(){
    try{
      const raw = JSON.parse(localStorage.getItem(K.settings)) || {};
      return {
        highThreshold: Number(raw.highThreshold) || 15,
        medThreshold: Number(raw.medThreshold) || 6,
        matrixSize: raw.matrixSize === 3 ? 3 : 5
      };
    }catch{
      return { highThreshold:15, medThreshold:6, matrixSize:5 };
    }
  }
  let settings = loadSettings();

  function applySettingsToUI(){
    const highEl = document.querySelector('#set-high');
    const medEl = document.querySelector('#set-med');
    const mxEl = document.querySelector('#set-matrix');
    if(highEl) highEl.value = settings.highThreshold;
    if(medEl) medEl.value = settings.medThreshold;
    if(mxEl) mxEl.value = String(settings.matrixSize || 5);
  }

  function bindSettings(){
    const btn = document.querySelector('#set-save');
    if(!btn) return;
    applySettingsToUI();
    btn.addEventListener('click', ()=>{
      const high = Number(document.querySelector('#set-high').value) || 0;
      const med  = Number(document.querySelector('#set-med').value) || 0;
      const mxVal = Number(document.querySelector('#set-matrix').value) === 3 ? 3 : 5;
      if(high <= med){
        alert('High threshold must be greater than medium threshold.');
        return;
      }
      settings.highThreshold = high;
      settings.medThreshold = med;
      settings.matrixSize = mxVal;
      localStorage.setItem(K.settings, JSON.stringify(settings));
      const st = document.querySelector('#set-status');
      if(st){
        st.textContent = 'Settings saved. Risk levels and matrix updated.';
        setTimeout(()=>{ st.textContent=''; }, 3000);
      }
      renderRisksTable();
      renderDashboard();
      drawMatrix();
      generateAuditorSummary();
    });
  }

  // ---------- Helpers ----------
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const getMulti = sel => {
    if(!sel) return [];
    const v=[]; Array.from(sel.options).forEach(o=>{ if(o.selected && o.value) v.push(o.value); });
    return v;
  };
  const setMulti = (sel,vals) => {
    if(!sel) return;
    const S=new Set(vals||[]);
    Array.from(sel.options).forEach(o=>o.selected=S.has(o.value));
  };
  const rScore = (l,i)=> (Number(l)||0)*(Number(i)||0);
  const rLevel = s => {
    const hi = settings.highThreshold || 15;
    const med = settings.medThreshold || 6;
    if(!s || s <= 0) return '-';
    if(s >= hi) return 'High';
    if(s >= med) return 'Medium';
    return 'Low';
  };

  // ---------- Framework render ----------
  function renderFrameworkControls(){
    const tbody=qs('#frameworks-table-body');
    const countEl=qs('#frameworks-count');
    const f=qs('#framework-filter').value;
    const c=qs('#category-filter').value;
    const s=(qs('#framework-search').value||'').trim().toLowerCase();
    const filtered = FRAMEWORK_CONTROLS.filter(x=>{
      const okF = f==='all' || x.frameworks.includes(f);
      const okC = c==='all' || x.category===c;
      const okS = !s || x.name.toLowerCase().includes(s) || x.description.toLowerCase().includes(s) || x.id.toLowerCase().includes(s);
      return okF && okC && okS;
    });
    tbody.innerHTML='';
    filtered.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${x.id}</td>
        <td>${x.name}</td>
        <td>${x.category}</td>
        <td>${x.references.join('<br>')}</td>
        <td>${x.description}</td>`;
      tbody.appendChild(tr);
    });
    countEl.textContent=`${filtered.length} control(s) shown of ${FRAMEWORK_CONTROLS.length}`;
  }

  // ---------- Assets ----------
  function selectedDataTypes(){ return qsa('.asset-dt').filter(cb=>cb.checked).map(cb=>cb.value); }
  function setDataTypes(vals){ qsa('.asset-dt').forEach(cb=>cb.checked=(vals||[]).includes(cb.value)); }

  function populateRiskAssetOptions(){
    const sel=qs('#risk-asset'); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Select asset...</option>';
    assets.forEach(a=>{ const o=document.createElement('option'); o.value=a.id; o.textContent=a.name; sel.appendChild(o); });
    if(cur && assets.some(a=>a.id===cur)) sel.value=cur;
  }

  function populateIssueDropdowns(){
    const aSel=qs('#issue-asset'), rSel=qs('#issue-risk'), cSel=qs('#issue-control');
    if(aSel){
      const cur=aSel.value;
      aSel.innerHTML='<option value="">Linked asset...</option>';
      assets.forEach(a=>{const o=document.createElement('option');o.value=a.id;o.textContent=a.name;aSel.appendChild(o);});
      if(cur && assets.some(a=>a.id===cur)) aSel.value=cur;
    }
    if(rSel){
      const cur=rSel.value;
      rSel.innerHTML='<option value="">Linked risk...</option>';
      risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title;rSel.appendChild(o);});
      if(cur && risks.some(r=>r.id===cur)) rSel.value=cur;
    }
    if(cSel){
      const cur=cSel.value;
      cSel.innerHTML='<option value="">Linked control...</option>';
      controls.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;cSel.appendChild(o);});
      if(cur && controls.some(c=>c.id===cur)) cSel.value=cur;
    }
  }

  function renderAssetsTable(){
    const tbody=qs('#assets-table-body'), empty=qs('#assets-empty'), count=qs('#assets-count');
    tbody.innerHTML='';
    assets.forEach(a=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${a.name}</td>
        <td>${a.type}</td>
        <td>${a.criticality}</td>
        <td>${(a.dataTypes||[]).join(', ')}</td>
        <td>${a.owner||''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ae="${a.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-ad="${a.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = assets.length?'none':'block';
    count.textContent=`${assets.length} asset(s)`;
    populateRiskAssetOptions();
    populateIssueDropdowns();
    renderDashboard();
  }

  function resetAssetForm(){
    qs('#asset-form').reset();
    qs('#asset-id').value='';
    qs('#asset-form-submit').textContent='Save asset';
  }

  qs('#asset-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#asset-id').value;
    const name=qs('#asset-name').value.trim();
    const type=qs('#asset-type').value;
    const crit=qs('#asset-criticality').value;
    if(!name || !type || !crit) return alert('Fill name, type, criticality.');
    const obj={
      id: id || ('AST-'+Date.now()),
      name,
      type,
      criticality:crit,
      owner:qs('#asset-owner').value.trim(),
      dataTypes:selectedDataTypes(),
      notes:qs('#asset-notes').value.trim()
    };
    const idx=assets.findIndex(x=>x.id===obj.id);
    if(idx>-1) assets[idx]=obj; else assets.push(obj);
    save(K.assets,assets);
    renderAssetsTable();
    resetAssetForm();
  });
  qs('#asset-form-cancel').addEventListener('click',resetAssetForm);
  qs('#assets-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ae');
    const idD=e.target.getAttribute('data-ad');
    if(idE){
      const a=assets.find(x=>x.id===idE); if(!a) return;
      qs('#asset-id').value=a.id;
      qs('#asset-name').value=a.name;
      qs('#asset-type').value=a.type;
      qs('#asset-criticality').value=a.criticality;
      qs('#asset-owner').value=a.owner||'';
      qs('#asset-notes').value=a.notes||'';
      setDataTypes(a.dataTypes||[]);
      qs('#asset-form-submit').textContent='Update asset';
    }
    if(idD){
      if(!confirm('Delete this asset?')) return;
      assets=assets.filter(x=>x.id!==idD);
      save(K.assets,assets);
      renderAssetsTable();
    }
  });

  // ---------- Risks ----------
  let riskFilterStatus = 'all';
  let riskFilterLevel = 'all';
  let riskSortField = 'title';
  let riskSortDir = 'asc';
  let lastRiskView = []; // stores current filtered + sorted risks for CSV export

  function resetRiskForm(){
    qs('#risk-form').reset();
    qs('#risk-id').value='';
    qs('#risk-form-submit').textContent='Save risk';
  }

  function populateControlRisks(){
    const sel=qs('#control-risks'); if(!sel) return;
    const cur=getMulti(sel);
    sel.innerHTML='';
    risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title;sel.appendChild(o);});
    setMulti(sel,cur);
  }

  function populateTreatmentDropdownRisks(){
    const sel=qs('#treat-risk'); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Select risk...</option>';
    risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title;sel.appendChild(o);});
    if(cur && risks.some(r=>r.id===cur)) sel.value=cur;
  }

  function riskCompare(a,b,field){
    let va,vb;
    switch(field){
      case 'title':   va=(a.title||'').toLowerCase(); vb=(b.title||'').toLowerCase(); break;
      case 'asset':   va=(a.assetName||'').toLowerCase(); vb=(b.assetName||'').toLowerCase(); break;
      case 'category':va=(a.category||'').toLowerCase(); vb=(b.category||'').toLowerCase(); break;
      case 'status':  va=(a.status||'').toLowerCase(); vb=(b.status||'').toLowerCase(); break;
      case 'score':
        va = a.score || 0;
        vb = b.score || 0;
        break;
      default:
        va=''; vb=''; 
    }
    if(va<vb) return -1;
    if(va>vb) return 1;
    return 0;
  }

  function updateRiskHeaderSortIndicators(){
    const ths = qsa('#risks-table thead th[data-risk-sort]');
    ths.forEach(th=>{
      th.classList.remove('sorted-asc','sorted-desc');
      const f = th.getAttribute('data-risk-sort');
      if(f === riskSortField){
        th.classList.add(riskSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      }
    });
  }

  function renderRisksTable(){
    const tbody=qs('#risks-table-body'), empty=qs('#risks-empty'), count=qs('#risks-count');
    const pill=qs('#risks-filter-pill');

    let list = risks.slice();

    if(riskFilterStatus !== 'all'){
      list = list.filter(r => (r.status||'') === riskFilterStatus);
    }
    if(riskFilterLevel !== 'all'){
      list = list.filter(r => rLevel(r.score) === riskFilterLevel);
    }

       list.sort((a,b)=> riskCompare(a,b,riskSortField) * (riskSortDir === 'asc' ? 1 : -1));

    // keep current view for CSV export
    lastRiskView = list.slice();

    tbody.innerHTML='';
    list.forEach(r=>{
      const level=rLevel(r.score);
      const cls = level==='High'?'badge-danger':level==='Medium'?'badge-warning':level==='Low'?'badge-success':'';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.title}</td>
        <td>${r.assetName||''}</td>
        <td>${r.category}</td>
        <td>${r.score?`<span class="badge ${cls} mr-1">${r.score}</span><span class="text-muted small">${level}</span>`:'-'}</td>
        <td>${r.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-re="${r.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-rd="${r.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=list.length?'none':'block';
    count.textContent=`${list.length} risk(s) shown of ${risks.length}`;

    const parts=[];
    if(riskFilterStatus!=='all') parts.push(`Status: ${riskFilterStatus}`);
    if(riskFilterLevel!=='all') parts.push(`Level: ${riskFilterLevel}`);
    pill.textContent = parts.length ? `Filters: ${parts.join(' | ')}` : 'No filters applied';

    populateControlRisks();
    populateIssueDropdowns();
    populateTreatmentDropdownRisks();
    renderDashboard();
    updateRiskHeaderSortIndicators();
  }

  qs('#risk-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#risk-id').value;
    const title=qs('#risk-title').value.trim();
    const assetId=qs('#risk-asset').value;
    const asset=assets.find(a=>a.id===assetId);
    const category=qs('#risk-category').value;
    const likelihood=Number(qs('#risk-likelihood').value);
    const impact=Number(qs('#risk-impact').value);
    const status=qs('#risk-status').value;
    if(!title || !assetId || !category || !likelihood || !impact || !status) return alert('Fill all required risk fields.');
    const obj={
      id:id || ('RSK-'+Date.now()),
      title,
      assetId,
      assetName:asset?asset.name:'',
      category,
      likelihood,
      impact,
      score:rScore(likelihood,impact),
      status,
      owner:qs('#risk-owner').value.trim(),
      notes:qs('#risk-notes').value.trim()
    };
    const idx=risks.findIndex(x=>x.id===obj.id);
    if(idx>-1) risks[idx]=obj; else risks.push(obj);
    save(K.risks,risks);
    renderRisksTable();
    resetRiskForm();
  });
  qs('#risk-form-cancel').addEventListener('click',resetRiskForm);
  qs('#risks-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-re');
    const idD=e.target.getAttribute('data-rd');
    if(idE){
      const r=risks.find(x=>x.id===idE); if(!r) return;
      qs('#risk-id').value=r.id;
      qs('#risk-title').value=r.title;
      qs('#risk-asset').value=r.assetId;
      qs('#risk-category').value=r.category;
      qs('#risk-likelihood').value=String(r.likelihood);
      qs('#risk-impact').value=String(r.impact);
      qs('#risk-owner').value=r.owner||'';
      qs('#risk-status').value=r.status||'Open';
      qs('#risk-notes').value=r.notes||'';
      qs('#risk-form-submit').textContent='Update risk';
    }
    if(idD){
      if(!confirm('Delete this risk?')) return;
      risks=risks.filter(x=>x.id!==idD);
      save(K.risks,risks);

      // unlink from controls
      let changed=false;
      controls.forEach(c=>{
        if(Array.isArray(c.linkedRiskIds) && c.linkedRiskIds.includes(idD)){
          c.linkedRiskIds=c.linkedRiskIds.filter(z=>z!==idD);
          changed=true;
        }
      });
      if(changed){ save(K.controls,controls); renderControlsTable(); }

      // unlink from issues
      issues.forEach(i=>{
        if(i.riskId===idD){
          i.riskId='';
          i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Risk: [^|]+/,'');
        }
      });
      save(K.issues,issues);
      renderIssuesTable();

      // unlink from treatments
      treatments.forEach(t=>{ if(t.riskId===idD) t.riskId=''; });
      save(K.treats,treatments);
      renderTreatmentsTable();

      renderRisksTable();
    }
  });

  function bindRiskFiltersAndSorting(){
    const fs = qs('#risk-filter-status');
    const fl = qs('#risk-filter-level');
    if(fs){
      fs.addEventListener('change', ()=>{
        riskFilterStatus = fs.value;
        renderRisksTable();
      });
    }
    if(fl){
      fl.addEventListener('change', ()=>{
        riskFilterLevel = fl.value;
        renderRisksTable();
      });
    }
    const head = qs('#risks-table thead');
    if(head){
      head.addEventListener('click', e=>{
        const th = e.target.closest('th[data-risk-sort]');
        if(!th) return;
        const field = th.getAttribute('data-risk-sort');
        if(riskSortField === field){
          riskSortDir = (riskSortDir === 'asc' ? 'desc' : 'asc');
        }else{
          riskSortField = field;
          riskSortDir = 'asc';
        }
        renderRisksTable();
      });
    }
  }

  // ---------- Controls ----------
  function populateControlFrameworks(){
    const sel=qs('#control-frameworks'); if(!sel) return;
    sel.innerHTML='';
    FRAMEWORK_CONTROLS.forEach(fc=>{
      const o=document.createElement('option');
      o.value=fc.id;
      o.textContent=`${fc.id} – ${fc.name}`;
      sel.appendChild(o);
    });
  }

  function renderControlsTable(){
    const tbody=qs('#controls-table-body'), empty=qs('#controls-empty'), count=qs('#controls-count');
    tbody.innerHTML='';
    controls.forEach(c=>{
      const rc=(c.linkedRiskIds||[]).length;
      const fw=(c.linkedFrameworkControlIds||[]).length;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${c.name}</td>
        <td>${c.type}</td>
        <td>${c.status}</td>
        <td>${rc?rc+' linked':'-'}</td>
        <td>${fw?fw+' mapped':'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ce="${c.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-cd="${c.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=controls.length?'none':'block';
    count.textContent=`${controls.length} control(s)`;
    populateIssueDropdowns();
    populateTreatmentDropdownControls();
    renderGapTable();
    renderDashboard();
  }

  function resetControlForm(){
    qs('#control-form').reset();
    qs('#control-id').value='';
    qs('#control-form-submit').textContent='Save control';
  }

  qs('#control-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#control-id').value;
    const name=qs('#control-name').value.trim();
    const type=qs('#control-type').value;
    const status=qs('#control-status').value;
    if(!name || !type || !status) return alert('Fill control name, type, status.');
    const obj={
      id:id || ('CTL-'+Date.now()),
      name,
      type,
      status,
      owner:qs('#control-owner').value.trim(),
      description:qs('#control-description').value.trim(),
      linkedRiskIds:getMulti(qs('#control-risks')),
      linkedFrameworkControlIds:getMulti(qs('#control-frameworks'))
    };
    const idx=controls.findIndex(x=>x.id===obj.id);
    if(idx>-1) controls[idx]=obj; else controls.push(obj);
    save(K.controls,controls);
    renderControlsTable();
    resetControlForm();
  });
  qs('#control-form-cancel').addEventListener('click',resetControlForm);
  qs('#controls-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ce');
    const idD=e.target.getAttribute('data-cd');
    if(idE){
      const c=controls.find(x=>x.id===idE); if(!c) return;
      qs('#control-id').value=c.id;
      qs('#control-name').value=c.name;
      qs('#control-type').value=c.type;
      qs('#control-status').value=c.status;
      qs('#control-owner').value=c.owner||'';
      qs('#control-description').value=c.description||'';
      setMulti(qs('#control-risks'),c.linkedRiskIds||[]);
      setMulti(qs('#control-frameworks'),c.linkedFrameworkControlIds||[]);
      qs('#control-form-submit').textContent='Update control';
    }
    if(idD){
      if(!confirm('Delete this control?')) return;
      controls=controls.filter(x=>x.id!==idD);
      save(K.controls,controls);

      // unlink from issues and treatments
      issues.forEach(i=>{
        if(i.controlId===idD){
          i.controlId='';
          i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Control: [^|]+/,'');
        }
      });
      save(K.issues,issues);
      renderIssuesTable();

      treatments.forEach(t=>{ if(t.controlId===idD) t.controlId=''; });
      save(K.treats,treatments);
      renderTreatmentsTable();

      renderControlsTable();
    }
  });

  // ---------- Issues ----------
  function resetIssueForm(){
    qs('#issue-form').reset();
    qs('#issue-id').value='';
    qs('#issue-form-submit').textContent='Save issue';
  }

  function renderIssuesTable(){
    const tbody=qs('#issues-table-body'), empty=qs('#issues-empty'), count=qs('#issues-count');
    tbody.innerHTML='';
    issues.forEach(i=>{
      const sev=i.severity||'';
      const cls = sev==='Critical'||sev==='High'?'badge-danger':sev==='Medium'?'badge-warning':'badge-success';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i.title}</td>
        <td>${i.type}</td>
        <td>${sev?`<span class="badge ${cls}">${sev}</span>`:'-'}</td>
        <td>${i.status}</td>
        <td>${i.linkedSummary||'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ie="${i.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-id="${i.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=issues.length?'none':'block';
    count.textContent=`${issues.length} issue(s)`;
    renderDashboard();
  }

  qs('#issue-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#issue-id').value;
    const title=qs('#issue-title').value.trim();
    const type=qs('#issue-type').value;
    const severity=qs('#issue-severity').value;
    const status=qs('#issue-status').value;
    if(!title || !type || !severity || !status) return alert('Fill title, type, severity, status.');
    const assetId=qs('#issue-asset').value||'';
    const riskId=qs('#issue-risk').value||'';
    const controlId=qs('#issue-control').value||'';
    const a=assets.find(x=>x.id===assetId);
    const r=risks.find(x=>x.id===riskId);
    const c=controls.find(x=>x.id===controlId);
    const linkedSummary=[
      a?`Asset: ${a.name}`:'',
      r?`Risk: ${r.title}`:'',
      c?`Control: ${c.name}`:''
    ].filter(Boolean).join(' | ');
    const obj={
      id:id || ('ISS-'+Date.now()),
      title,
      type,
      severity,
      status,
      owner:qs('#issue-owner').value.trim(),
      dueDate:qs('#issue-due').value,
      notes:qs('#issue-notes').value.trim(),
      assetId,riskId,controlId,
      linkedSummary
    };
    const idx=issues.findIndex(x=>x.id===obj.id);
    if(idx>-1) issues[idx]=obj; else issues.push(obj);
    save(K.issues,issues);
    renderIssuesTable();
    resetIssueForm();
  });
  qs('#issue-form-cancel').addEventListener('click',resetIssueForm);
  qs('#issues-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-ie');
    const idD=e.target.getAttribute('data-id');
    if(idE){
      const i=issues.find(x=>x.id===idE); if(!i) return;
      qs('#issue-id').value=i.id;
      qs('#issue-title').value=i.title;
      qs('#issue-type').value=i.type;
      qs('#issue-severity').value=i.severity;
      qs('#issue-status').value=i.status;
      qs('#issue-owner').value=i.owner||'';
      qs('#issue-due').value=i.dueDate||'';
      qs('#issue-notes').value=i.notes||'';
      populateIssueDropdowns();
      qs('#issue-asset').value=i.assetId||'';
      qs('#issue-risk').value=i.riskId||'';
      qs('#issue-control').value=i.controlId||'';
      qs('#issue-form-submit').textContent='Update issue';
    }
    if(idD){
      if(!confirm('Delete this issue?')) return;
      issues=issues.filter(x=>x.id!==idD);
      save(K.issues,issues);
      renderIssuesTable();
    }
  });

  // ---------- Gap analysis ----------
  const heatClass = p => p>=80?'heat-good':p>=50?'heat-medium':p>0?'heat-low':'heat-none';

  function computeGapRows(){
    const byCat=new Map();
    FRAMEWORK_CONTROLS.forEach(fc=>{
      if(!byCat.has(fc.category)) byCat.set(fc.category,{category:fc.category,total:0,implemented:0,plannedOnly:0,notImplemented:0});
      const row=byCat.get(fc.category);
      row.total+=1;
      const linked=controls.filter(c=>Array.isArray(c.linkedFrameworkControlIds)&&c.linkedFrameworkControlIds.includes(fc.id));
      if(linked.length===0){ row.notImplemented+=1; return; }
      const hasInPlace=linked.some(c=>c.status==='In place');
      const hasPlanned=linked.some(c=>c.status==='Planned');
      if(hasInPlace) row.implemented+=1;
      else if(hasPlanned) row.plannedOnly+=1;
      else row.notImplemented+=1;
    });
    return Array.from(byCat.values()).sort((a,b)=>a.category.localeCompare(b.category));
  }

  function overallCoverage(rows){
    let total=0, imp=0;
    rows.forEach(r=>{total+=r.total;imp+=r.implemented;});
    return total?Math.round((imp/total)*100):0;
  }

  function renderGapTable(){
    const tbody=qs('#gap-table-body'), overall=qs('#gap-overall-coverage');
    const rows=computeGapRows();
    tbody.innerHTML='';
    rows.forEach(r=>{
      const pct=r.total?Math.round((r.implemented/r.total)*100):0;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.category}</td>
        <td>${r.total}</td>
        <td>${r.implemented} / ${r.total}</td>
        <td>${r.plannedOnly} / ${r.total}</td>
        <td>${r.notImplemented} / ${r.total}</td>
        <td class="heat-cell ${heatClass(pct)}">${pct}%<small>${r.implemented} of ${r.total} control(s) implemented</small></td>`;
      tbody.appendChild(tr);
    });
    const ov=overallCoverage(rows);
    overall.textContent = rows.length
      ? `Overall implemented coverage: ${ov}% of ${FRAMEWORK_CONTROLS.length} framework control(s).`
      : 'Add local controls and map them to framework controls to see coverage.';
    updateCoveragePill(ov);
  }

  // ---------- Dashboard ----------
  function updateCoveragePill(p){
    const pill=qs('#dash-coverage-pill');
    pill.classList.remove('heat-good','heat-medium','heat-low','heat-none');
    pill.classList.add(heatClass(p));
    pill.textContent = p>=80?'Strong coverage':p>=50?'Moderate coverage':p>0?'Limited coverage':'No implemented coverage yet';
  }

  function renderDashboard(){
    qs('#dash-assets').textContent=assets.length;
    qs('#dash-risks').textContent=risks.length;
    qs('#dash-controls').textContent=controls.length;
    qs('#dash-issues').textContent=issues.length;
    const high=risks.filter(r=>rLevel(r.score)==='High').length;
    qs('#dash-high').textContent=high;
    const today=new Date();
    const overdue=issues.filter(i=>{
      if(!i.dueDate) return false;
      const d=new Date(i.dueDate);
      if(isNaN(d)) return false;
      const st=i.status||'';
      return st!=='Resolved' && st!=='Accepted' && d<today;
    }).length;
    qs('#dash-overdue').textContent=overdue;
    const ov=overallCoverage(computeGapRows());
    qs('#dash-coverage').textContent=ov+'%';
    updateCoveragePill(ov);
  }

  // ---------- Risk Matrix ----------
  let showResidual=false;
  const canvas=qs('#risk-matrix-canvas');
  const ctx=canvas.getContext('2d');
  const legend=qs('#matrix-legend');

  function residualForRisk(r){
    const impl=controls.filter(c=>c.status==='In place' && (c.linkedRiskIds||[]).includes(r.id));
    const dropL=Math.min(2,impl.length);
    const dropI=impl.some(c=>c.type==='Preventive' || c.type==='Corrective')?1:0;
    return {
      likelihood:Math.max(1,(r.likelihood||1)-dropL),
      impact:Math.max(1,(r.impact||1)-dropI)
    };
  }

  function drawMatrix(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const grid = settings.matrixSize === 3 ? 3 : 5;
    const size = grid === 5 ? 110 : 160;
    const off=90;
    ctx.strokeStyle="#2b3138"; ctx.lineWidth=1;
    for(let i=0;i<=grid;i++){
      ctx.beginPath(); ctx.moveTo(off,off+i*size); ctx.lineTo(off+grid*size,off+i*size); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(off+i*size,off); ctx.lineTo(off+i*size,off+grid*size); ctx.stroke();
    }
    ctx.font="14px Poppins"; ctx.fillStyle="#aab2bd";
    ctx.fillText("Impact →",off + (grid*size)/2 - 40,off-25);
    ctx.save(); ctx.translate(off-55,off+(grid*size)/2); ctx.rotate(-Math.PI/2); ctx.fillText("Likelihood →",0,0); ctx.restore();

    let high=0,med=0,low=0;
    risks.forEach(r=>{
      let L=r.likelihood, I=r.impact;
      if(showResidual){ const res=residualForRisk(r); L=res.likelihood; I=res.impact; }
      if(!L || !I) return;
      const score=rScore(L,I);
      const level = rLevel(score);
      let color="#27ae60";
      if(level==='High'){ color="#e63946"; high++; }
      else if(level==='Medium'){ color="#f1c40f"; med++; }
      else if(level==='Low'){ color="#27ae60"; low++; }

      let Lp=L, Ip=I;
      if(grid!==5){
        const factor = grid/5;
        Lp = Math.max(1, Math.min(grid, Math.round(L*factor)));
        Ip = Math.max(1, Math.min(grid, Math.round(I*factor)));
      }

      ctx.beginPath();
      ctx.arc(off+(Ip-0.5)*size,off+((grid-Lp)+0.5)*size,12,0,2*Math.PI);
      ctx.fillStyle=color; ctx.fill();
      ctx.fillStyle="#0c0f12"; ctx.font="bold 12px Poppins";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(String(score),off+(Ip-0.5)*size,off+((grid-Lp)+0.5)*size);
    });

    legend.innerHTML = `<b>${risks.length}</b> risks — 
      <span style="color:#e63946">High: ${high}</span> |
      <span style="color:#f1c40f">Medium: ${med}</span> |
      <span style="color:#27ae60">Low: ${low}</span>`;
  }

  // ---------- Treatments ----------
  function populateTreatmentDropdownControls(){
    const sel=qs('#treat-control'); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Select control...</option>';
    controls.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o);});
    if(cur && controls.some(c=>c.id===cur)) sel.value=cur;
  }

  function renderTreatmentsTable(){
    const tbody=qs('#treat-table-body'), empty=qs('#treat-empty'), count=qs('#treat-count');
    tbody.innerHTML='';
    treatments.forEach(t=>{
      const risk=risks.find(r=>r.id===t.riskId);
      const ctrl=controls.find(c=>c.id===t.controlId);
      const linked=[
        risk?`Risk: ${risk.title}`:'',
        ctrl?`Control: ${ctrl.name}`:''
      ].filter(Boolean).join(' | ');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${linked||'-'}</td>
        <td>${t.status}</td>
        <td>${t.targetDate||''}</td>
        <td>${t.owner||''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-te="${t.id}">EDIT</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-td="${t.id}">DEL</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display=treatments.length?'none':'block';
    count.textContent=`${treatments.length} treatment action(s)`;
  }

  function resetTreatForm(){
    qs('#treat-form').reset();
    qs('#treat-id').value='';
    qs('#treat-submit').textContent='Save action';
  }

  qs('#treat-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=qs('#treat-id').value;
    const title=qs('#treat-title').value.trim();
    const riskId=qs('#treat-risk').value;
    if(!title || !riskId) return alert('Action title and linked risk are required.');
    const controlId=qs('#treat-control').value || '';
    const obj={
      id:id || ('TRT-'+Date.now()),
      title,
      riskId,
      controlId,
      status:qs('#treat-status').value,
      targetDate:qs('#treat-date').value,
      owner:qs('#treat-owner').value.trim(),
      budget:qs('#treat-budget').value.trim(),
      notes:qs('#treat-notes').value.trim()
    };
    const idx=treatments.findIndex(x=>x.id===obj.id);
    if(idx>-1) treatments[idx]=obj; else treatments.push(obj);
    save(K.treats,treatments);
    renderTreatmentsTable();
    resetTreatForm();
  });
  qs('#treat-cancel').addEventListener('click',resetTreatForm);
  qs('#treat-table-body').addEventListener('click',e=>{
    const idE=e.target.getAttribute('data-te');
    const idD=e.target.getAttribute('data-td');
    if(idE){
      const t=treatments.find(x=>x.id===idE); if(!t) return;
      qs('#treat-id').value=t.id;
      qs('#treat-title').value=t.title;
      populateTreatmentDropdownRisks();
      populateTreatmentDropdownControls();
      qs('#treat-risk').value=t.riskId||'';
      qs('#treat-control').value=t.controlId||'';
      qs('#treat-status').value=t.status||'Open';
      qs('#treat-date').value=t.targetDate||'';
      qs('#treat-owner').value=t.owner||'';
      qs('#treat-budget').value=t.budget||'';
      qs('#treat-notes').value=t.notes||'';
      qs('#treat-submit').textContent='Update action';
    }
    if(idD){
      if(!confirm('Delete this treatment action?')) return;
      treatments=treatments.filter(x=>x.id!==idD);
      save(K.treats,treatments);
      renderTreatmentsTable();
    }
  });

  // ---------- Export / Import / Demo / Reset ----------
 
    // ---------- CSV helpers ----------
  function csvEscape(value){
    if(value == null) return '';
    const s = String(value);
    if(/[" ,\n]/.test(s)){
      return '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }

  function downloadCSV(filename, rows, columns){
    if(!rows || !rows.length) {
      alert('No rows to export.');
      return;
    }
    const header = columns.map(c => csvEscape(c.header)).join(',');
    const body = rows.map(row=>{
      return columns.map(c=>{
        const val = typeof c.value === 'function'
          ? c.value(row)
          : row[c.key];
        return csvEscape(val);
      }).join(',');
    }).join('\n');
    const blob = new Blob([header + '\n' + body], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportAssetsCSV(){
    const cols = [
      {header:'Name', key:'name'},
      {header:'Type', key:'type'},
      {header:'Criticality', key:'criticality'},
      {header:'Data types', value:a=>(a.dataTypes||[]).join('; ')},
      {header:'Owner', key:'owner'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_assets.csv', assets, cols);
  }

  function exportRisksCSV(){
    const rows = lastRiskView && lastRiskView.length ? lastRiskView : risks;
    const cols = [
      {header:'Title', key:'title'},
      {header:'Asset', value:r=>r.assetName||''},
      {header:'Category', key:'category'},
      {header:'Likelihood', key:'likelihood'},
      {header:'Impact', key:'impact'},
      {header:'Score', key:'score'},
      {header:'Level', value:r=>rLevel(r.score)},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_risks.csv', rows, cols);
  }

  function exportControlsCSV(){
    const cols = [
      {header:'Name', key:'name'},
      {header:'Type', key:'type'},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Description', key:'description'},
      {
        header:'Linked risks',
        value:c=>{
          const ids = c.linkedRiskIds || [];
          const names = ids.map(id=>{
            const r = risks.find(x=>x.id===id);
            return r ? r.title : id;
          }).filter(Boolean);
          return names.join('; ');
        }
      },
      {
        header:'Framework controls',
        value:c=>{
          const ids = c.linkedFrameworkControlIds || [];
          if(!ids.length) return '';
          return ids.join('; ');
        }
      }
    ];
    downloadCSV('grc_controls.csv', controls, cols);
  }

  function exportIssuesCSV(){
    const cols = [
      {header:'Title', key:'title'},
      {header:'Type', key:'type'},
      {header:'Severity', key:'severity'},
      {header:'Status', key:'status'},
      {header:'Owner', key:'owner'},
      {header:'Due date', key:'dueDate'},
      {
        header:'Linked asset',
        value:i=>{
          const a = assets.find(x=>x.id===i.assetId);
          return a ? a.name : '';
        }
      },
      {
        header:'Linked risk',
        value:i=>{
          const r = risks.find(x=>x.id===i.riskId);
          return r ? r.title : '';
        }
      },
      {
        header:'Linked control',
        value:i=>{
          const c = controls.find(x=>x.id===i.controlId);
          return c ? c.name : '';
        }
      },
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_issues.csv', issues, cols);
  }

  function exportTreatmentsCSV(){
    const cols = [
      {header:'Title', key:'title'},
      {header:'Status', key:'status'},
      {header:'Target date', key:'targetDate'},
      {header:'Owner', key:'owner'},
      {header:'Budget', key:'budget'},
      {
        header:'Linked risk',
        value:t=>{
          const r = risks.find(x=>x.id===t.riskId);
          return r ? r.title : '';
        }
      },
      {
        header:'Linked control',
        value:t=>{
          const c = controls.find(x=>x.id===t.controlId);
          return c ? c.name : '';
        }
      },
      {header:'Notes', key:'notes'}
    ];
    downloadCSV('grc_treatments.csv', treatments, cols);
  }
  
  function setImportStatus(msg,err){
    const el=qs('#import-status');
    el.textContent=msg||'';
    el.style.color=err?'#fca5a5':'#9ca3af';
  }

  function exportScenario(){
    const payload={
      version:3,
      exportedAt:new Date().toISOString(),
      settings,
      assets,risks,controls,issues,treatments
    };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`grc-lab-scenario-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setImportStatus('Exported current data as JSON.',false);
  }

  function importScenarioFile(file){
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=JSON.parse(e.target.result);
        assets = Array.isArray(data.assets)?data.assets:[];
        risks  = Array.isArray(data.risks)?data.risks:[];
        controls = Array.isArray(data.controls)?data.controls:[];
        issues = Array.isArray(data.issues)?data.issues:[];
        treatments = Array.isArray(data.treatments)?data.treatments:[];
        if(data.settings){
          settings = {
            highThreshold: Number(data.settings.highThreshold)||15,
            medThreshold: Number(data.settings.medThreshold)||6,
            matrixSize: data.settings.matrixSize===3?3:5
          };
          localStorage.setItem(K.settings, JSON.stringify(settings));
        }
        save(K.assets,assets); save(K.risks,risks); save(K.controls,controls);
        save(K.issues,issues); save(K.treats,treatments);
        refreshAll();
        setImportStatus(`Imported scenario: ${assets.length} assets, ${risks.length} risks, ${controls.length} controls, ${issues.length} issues, ${treatments.length} actions.`,false);
      }catch(err){
        console.error(err);
        setImportStatus('Failed to import scenario. Check JSON file.',true);
      }
    };
    reader.onerror=()=>setImportStatus('Failed to read file.',true);
    reader.readAsText(file);
  }

  function loadDemoScenario(){
    // Pre-built MediCloud example scenario
    assets = [
      {
        id:"AST-DEMO-APP",
        name:"MediCloud Web Application",
        type:"Application",
        criticality:"High",
        owner:"Product & Engineering",
        dataTypes:["PHI","PII"],
        notes:"Public-facing SaaS application used by clinics to access MediCloud services."
      },
      {
        id:"AST-DEMO-DB",
        name:"MediCloud Clinical Database",
        type:"Database",
        criticality:"High",
        owner:"Data Platform Team",
        dataTypes:["PHI"],
        notes:"Primary clinical data store containing patient records, results and care history."
      },
      {
        id:"AST-DEMO-API",
        name:"MediCloud Integration APIs",
        type:"Cloud Service",
        criticality:"Medium",
        owner:"Integration & Partnerships",
        dataTypes:["PHI","Internal data"],
        notes:"APIs used by partner systems and hospital EHR platforms."
      }
    ];

    risks = [
      {
        id:"RSK-DEMO-1",
        title:"Unauthorised access to MediCloud production",
        assetId:"AST-DEMO-APP",
        assetName:"MediCloud Web Application",
        category:"Cybersecurity",
        likelihood:4,
        impact:5,
        score:rScore(4,5),
        status:"Open",
        owner:"CISO",
        notes:"Risk of compromised admin account or weak access controls leading to production compromise."
      },
      {
        id:"RSK-DEMO-2",
        title:"Compromise of clinical database backups",
        assetId:"AST-DEMO-DB",
        assetName:"MediCloud Clinical Database",
        category:"Privacy",
        likelihood:3,
        impact:5,
        score:rScore(3,5),
        status:"In progress",
        owner:"Head of Data Platform",
        notes:"Backups stored in cloud storage; risk if encryption or access controls are misconfigured."
      },
      {
        id:"RSK-DEMO-3",
        title:"Vendor outage impacting MediCloud APIs",
        assetId:"AST-DEMO-API",
        assetName:"MediCloud Integration APIs",
        category:"Third-Party",
        likelihood:3,
        impact:4,
        score:rScore(3,4),
        status:"Open",
        owner:"Head of Operations",
        notes:"Availability dependency on upstream cloud and key integration vendors."
      }
    ];

    controls = [
      {
        id:"CTL-DEMO-SSO",
        name:"SSO and MFA enforced for staff",
        type:"Preventive",
        status:"In place",
        owner:"Security Engineering",
        description:"SSO via IdP with MFA for all staff and elevated roles, including production access.",
        linkedRiskIds:["RSK-DEMO-1"],
        linkedFrameworkControlIds:["CTRL-AC-02","CTRL-AC-03"]
      },
      {
        id:"CTL-DEMO-LOG",
        name:"Centralised security logging via SIEM",
        type:"Detective",
        status:"In place",
        owner:"Security Operations",
        description:"Application, database and infrastructure logs sent to SIEM with basic alerting.",
        linkedRiskIds:["RSK-DEMO-1","RSK-DEMO-2"],
        linkedFrameworkControlIds:["CTRL-LOG-01","CTRL-LOG-02"]
      },
      {
        id:"CTL-DEMO-BACKUP",
        name:"Encrypted backups with restore testing",
        type:"Corrective",
        status:"In place",
        owner:"Data Platform Team",
        description:"Backups encrypted at rest with KMS; quarterly restore tests documented.",
        linkedRiskIds:["RSK-DEMO-2"],
        linkedFrameworkControlIds:["CTRL-ENC-01","CTRL-BCP-01"]
      },
      {
        id:"CTL-DEMO-VENDOR",
        name:"Vendor due diligence and SLA review",
        type:"Administrative",
        status:"Planned",
        owner:"Vendor Management",
        description:"Formalised vendor risk assessments and SLA reviews for key cloud and integration vendors.",
        linkedRiskIds:["RSK-DEMO-3"],
        linkedFrameworkControlIds:["CTRL-VND-01","CTRL-VND-02"]
      }
    ];

    issues = [
      {
        id:"ISS-DEMO-1",
        title:"MFA not enforced for all privileged accounts",
        type:"Audit",
        severity:"High",
        status:"In progress",
        owner:"Platform Lead",
        dueDate:"",
        notes:"Legacy admin accounts still allowed without enforced MFA in some paths.",
        assetId:"AST-DEMO-APP",
        riskId:"RSK-DEMO-1",
        controlId:"CTL-DEMO-SSO",
        linkedSummary:"Asset: MediCloud Web Application | Risk: Unauthorised access to MediCloud production | Control: SSO and MFA enforced for staff"
      },
      {
        id:"ISS-DEMO-2",
        title:"Restore test evidence incomplete for Q2",
        type:"Audit",
        severity:"Medium",
        status:"Open",
        owner:"Data Platform Team",
        dueDate:"",
        notes:"Q2 restore test performed but evidence pack and sign-off not fully documented.",
        assetId:"AST-DEMO-DB",
        riskId:"RSK-DEMO-2",
        controlId:"CTL-DEMO-BACKUP",
        linkedSummary:"Asset: MediCloud Clinical Database | Risk: Compromise of clinical database backups | Control: Encrypted backups with restore testing"
      },
      {
        id:"ISS-DEMO-3",
        title:"No documented failover plan for core vendor outage",
        type:"Risk review",
        severity:"High",
        status:"Open",
        owner:"Head of Operations",
        dueDate:"",
        notes:"High-level plans exist, but no formally approved and tested failover procedure.",
        assetId:"AST-DEMO-API",
        riskId:"RSK-DEMO-3",
        controlId:"CTL-DEMO-VENDOR",
        linkedSummary:"Asset: MediCloud Integration APIs | Risk: Vendor outage impacting MediCloud APIs | Control: Vendor due diligence and SLA review"
      }
    ];

    treatments = [
      {
        id:"TRT-DEMO-1",
        title:"Roll out enforced SSO and MFA to all staff and partners",
        riskId:"RSK-DEMO-1",
        controlId:"CTL-DEMO-SSO",
        status:"In progress",
        targetDate:"",
        owner:"Security Engineering",
        budget:"3,000 USD",
        notes:"Expand SSO coverage to all admin and support consoles; remove legacy login paths."
      },
      {
        id:"TRT-DEMO-2",
        title:"Formalise quarterly backup restore testing playbook",
        riskId:"RSK-DEMO-2",
        controlId:"CTL-DEMO-BACKUP",
        status:"Open",
        targetDate:"",
        owner:"Data Platform Team",
        budget:"",
        notes:"Standardise evidence capture, sign-off and retention for restore exercises."
      },
      {
        id:"TRT-DEMO-3",
        title:"Document and test vendor outage runbook",
        riskId:"RSK-DEMO-3",
        controlId:"CTL-DEMO-VENDOR",
        status:"Open",
        targetDate:"",
        owner:"Head of Operations",
        budget:"",
        notes:"Create and test playbook covering communication, failover and rollback steps."
      }
    ];

    save(K.assets,assets);
    save(K.risks,risks);
    save(K.controls,controls);
    save(K.issues,issues);
    save(K.treats,treatments);

    refreshAll();
    setImportStatus('Loaded demo MediCloud scenario into this browser (previous lab data was overwritten).',false);
  }

  function resetLab(){
    if(!confirm('This will clear all assets, risks, controls, issues, treatments and settings in this browser. Continue?')) return;
    assets=[];risks=[];controls=[];issues=[];treatments=[];
    Object.values(K).forEach(k=>localStorage.removeItem(k));
    settings = loadSettings();
    refreshAll();
    setImportStatus('Lab reset: all data cleared from this browser.',false);
  }

  // ---------- Tabs ----------
  function bindTabs(){
    const buttons=qsa('[data-grc-tab]');
    const mapping={};
    ['frameworks','assets','risks','controls','issues','gap','dashboard','matrix','treatments','summary','settings']
      .forEach(id=>mapping[id]=qs('#tab-'+id));
    buttons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const tgt=btn.getAttribute('data-grc-tab');
        buttons.forEach(b=>{
          b.classList.remove('btn-primary');
          b.classList.add('btn-outline-light');
        });
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline-light');
        Object.values(mapping).forEach(el=>el && el.classList.remove('active'));
        if(mapping[tgt]) mapping[tgt].classList.add('active');
        if(tgt==='dashboard') renderDashboard();
        if(tgt==='gap') renderGapTable();
        if(tgt==='matrix') drawMatrix();
        if(tgt==='summary') generateAuditorSummary();
        if(tgt==='settings') applySettingsToUI();
      });
    });
  }

  // ---------- Auditor-style Summary ----------
  function listPhrase(items,max){
    if(!items || !items.length) return '';
    const arr=items.slice(0,max);
    if(arr.length===1) return arr[0];
    if(arr.length===2) return `${arr[0]} and ${arr[1]}`;
    return `${arr.slice(0,-1).join(', ')} and ${arr[arr.length-1]}`;
  }

  function generateAuditorSummary(){
    const lines=[];

    // Scope & assets
    const totalAssets=assets.length;
    const highAssets=assets.filter(a=>a.criticality==='High');
    const assetNames=assets.map(a=>a.name);
    const keyAssets=listPhrase(highAssets.map(a=>a.name),3) || listPhrase(assetNames,3) || 'key information assets';
    lines.push(`1. Scope and context\nThe organisation is using the GRC Practice Lab to model approximately ${totalAssets||'0'} key information assets and services. High-criticality assets currently include ${keyAssets}.`);

    // Risks
    const totalRisks=risks.length;
    const highRisks=risks.filter(r=>rLevel(r.score)==='High');
    const medRisks=risks.filter(r=>rLevel(r.score)==='Medium');
    const exHigh=highRisks.slice(0,2).map(r=>{
      const assetName=r.assetName ? ` (asset: ${r.assetName})` : '';
      return `${r.title}${assetName}, score ${r.score}`;
    });
    let riskPara=`2. Risk posture\nA total of ${totalRisks||'0'} risks have been documented in the register. `;
    riskPara+=`High risks: ${highRisks.length}; medium risks: ${medRisks.length}; remaining items are low or informational. `;
    if(exHigh.length){
      riskPara+=`Example high risks include ${listPhrase(exHigh,2)}.`;
    }
    lines.push(riskPara.trim());

    // Controls & framework coverage
    const rows=computeGapRows();
    const overall=overallCoverage(rows);
    const ctrlCount=controls.length;
    const catSnippets=rows.slice(0,4).map(r=>{
      const pct=r.total?Math.round((r.implemented/r.total)*100):0;
      return `${r.category}: ${pct}% implemented (${r.implemented}/${r.total}).`;
    });
    let ctrlPara=`3. Control environment and framework coverage\nLocal controls defined in the lab: ${ctrlCount}. Overall implemented coverage across the paraphrased framework library is approximately ${overall}% of ${FRAMEWORK_CONTROLS.length} controls. `;
    if(catSnippets.length){
      ctrlPara+=`Coverage by category (sample): ${catSnippets.join(' ')}`;
    }
    lines.push(ctrlPara.trim());

    // Issues & treatments
    const openIssues=issues.filter(i=>i.status==='Open' || i.status==='In progress');
    const critIssues=issues.filter(i=>i.severity==='Critical' || i.severity==='High');
    const exIssue=openIssues.slice(0,2).map(i=>i.title);
    const openActions=treatments.filter(t=>t.status==='Open' || t.status==='In progress');
    const closedActions=treatments.filter(t=>t.status==='Closed');
    let issuePara=`4. Issues, findings and action plans\nThere are ${issues.length} issue(s) recorded in the log, of which ${openIssues.length} are open or in progress and ${critIssues.length} are rated high or critical. `;
    if(exIssue.length){
      issuePara+=`Example open items include ${listPhrase(exIssue,2)}. `;
    }
    issuePara+=`The treatment register currently contains ${treatments.length} action item(s), with ${openActions.length} open/in progress and ${closedActions.length} closed.`;
    lines.push(issuePara.trim());

    // Overall observation
    const highCount=highRisks.length;
    const ov=overall;
    const covDesc=ov>=80?'strong, with most key controls implemented':
                  ov>=50?'developing, with several controls implemented but notable gaps remaining':
                  ov>0?'limited, with many controls still to be implemented':
                  'minimal, with framework controls largely not implemented yet';
    let obs=`5. Overall observation\nSeveral high-impact risks have been identified${highCount?` (currently ${highCount} high-rated risk(s))`:''}. Control coverage is ${ov}% and is best described as ${covDesc}. `;
    if(openActions.length){
      obs+=`A formal treatment plan is in place, with ${openActions.length} active remediation action(s) tracked against the risk register.`;
    }else{
      obs+=`No active treatment actions are currently recorded against the risk register.`;
    }
    lines.push(obs.trim());

    qs('#summary-text').value = lines.join('\n\n');
  }

  // ---------- Refresh all ----------
  function refreshAll(){
    renderFrameworkControls();
    renderAssetsTable();
    renderRisksTable();
    populateControlFrameworks();
    renderControlsTable();
    populateIssueDropdowns();
    renderIssuesTable();
    renderGapTable();
    renderDashboard();
    populateTreatmentDropdownRisks();
    populateTreatmentDropdownControls();
    renderTreatmentsTable();
    drawMatrix();
    generateAuditorSummary();
    applySettingsToUI();
  }

  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded',()=>{
    ['#framework-filter','#category-filter','#framework-search'].forEach(sel=>{
      const el=qs(sel);
      if(!el) return;
      el.addEventListener(sel==='#framework-search'?'input':'change',renderFrameworkControls);
    });

    bindTabs();
    bindSettings();
    bindRiskFiltersAndSorting();
    populateControlFrameworks();
    populateControlRisks();
    populateRiskAssetOptions();
    populateIssueDropdowns();
    populateTreatmentDropdownRisks();
    populateTreatmentDropdownControls();

    qs('#btn-export').addEventListener('click',exportScenario);
    qs('#btn-import').addEventListener('click',()=>{
      setImportStatus('',false);
      const f=qs('#file-import'); f.value=''; f.click();
    });
    qs('#file-import').addEventListener('change',e=>{
      const file=e.target.files && e.target.files[0];
      if(file) importScenarioFile(file);
    });
    qs('#btn-load-demo').addEventListener('click',()=>{
      if(!confirm('Loading the demo will overwrite current lab data in this browser. Continue?')) return;
      loadDemoScenario();
    });
    qs('#btn-reset').addEventListener('click',resetLab);

    qs('#toggle-inherent').addEventListener('click',()=>{
      showResidual=false;
      qs('#toggle-inherent').classList.add('btn-primary');
      qs('#toggle-residual').classList.remove('btn-primary');
      drawMatrix();
    });
    qs('#toggle-residual').addEventListener('click',()=>{
      showResidual=true;
      qs('#toggle-residual').classList.add('btn-primary');
      qs('#toggle-inherent').classList.remove('btn-primary');
      drawMatrix();
    });
    qs('#matrix-export').addEventListener('click',()=>{
      const a=document.createElement('a');
      a.download='risk_matrix.png';
      a.href=canvas.toDataURL('image/png');
      a.click();
    });

    qs('#summary-refresh').addEventListener('click',generateAuditorSummary);

    const btnExpAssets = qs('#export-assets');
    if(btnExpAssets) btnExpAssets.addEventListener('click', exportAssetsCSV);

    const btnExpRisks = qs('#export-risks');
    if(btnExpRisks) btnExpRisks.addEventListener('click', exportRisksCSV);

    const btnExpControls = qs('#export-controls');
    if(btnExpControls) btnExpControls.addEventListener('click', exportControlsCSV);

    const btnExpIssues = qs('#export-issues');
    if(btnExpIssues) btnExpIssues.addEventListener('click', exportIssuesCSV);

    const btnExpTreats = qs('#export-treatments');
    if(btnExpTreats) btnExpTreats.addEventListener('click', exportTreatmentsCSV);
    
    
    refreshAll();
  });
  </script>
</body>
</html>
