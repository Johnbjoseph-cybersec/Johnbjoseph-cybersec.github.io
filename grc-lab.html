<!DOCTYPE html>
<html lang="en">
  <head>
    <title>GRC Practice Lab – John B Joseph</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Reuse your existing fonts & styles -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/aos.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
      /* Simple lab-specific tweaks – we can expand later */
      .grc-lab-hero {
        padding-top: 140px;
        padding-bottom: 40px;
      }
      .grc-tab-buttons .btn {
        margin-right: 8px;
        margin-bottom: 8px;
      }
      .grc-tab {
        display: none;
      }
      .grc-tab.active {
        display: block;
      }
    </style>
  </head>

  <body data-spy="scroll" data-target=".site-navbar-target" data-offset="300">

    <!-- Same navbar as index.html, but link back to home & highlight Lab -->
    <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar ftco-navbar-light site-navbar-target" id="ftco-navbar">
      <div class="container">
        <a class="navbar-brand" href="index.html">John B Joseph</a>
        <button class="navbar-toggler js-fh5co-nav-toggle fh5co-nav-toggle" type="button"
                data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="oi oi-menu"></span> Menu
        </button>

        <div class="collapse navbar-collapse" id="ftco-nav">
          <ul class="navbar-nav nav ml-auto">
            <li class="nav-item"><a href="index.html#home-section" class="nav-link"><span>Home</span></a></li>
            <li class="nav-item"><a href="toolkit.html" class="nav-link"><span>Toolkit</span></a></li>
            <li class="nav-item active"><a href="grc-lab.html" class="nav-link"><span>GRC Practice Lab</span></a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Hero / Intro -->
    <section class="ftco-section grc-lab-hero">
      <div class="container">
        <div class="row justify-content-center mb-4">
          <div class="col-md-10 text-center ftco-animate">
            <h1 class="mb-3">GRC Practice Lab (Beta)</h1>
            <p class="lead">
              A free, browser-based sandbox to practice real GRC work – assets, risks, controls, and findings –
              built by John B Joseph. Data stays in your browser only.
            </p>
            <p class="mb-0"><small>
              Controls are paraphrased and inspired by ISO 27001, NIST CSF, HIPAA, and PCI DSS for educational use.
              Always refer to the official standards for authoritative text.
            </small></p>
          </div>
        </div>

        <!-- Tab buttons -->
        <div class="row mb-4">
  <div class="col-md-12 text-center grc-tab-buttons">
    <button class="btn btn-primary btn-sm" data-grc-tab="frameworks">Frameworks & Controls</button>
    <button class="btn btn-outline-light btn-sm" data-grc-tab="assets">Assets</button>
    <button class="btn btn-outline-light btn-sm" data-grc-tab="risks">Risks</button>
    <button class="btn btn-outline-light btn-sm" data-grc-tab="controls">Local Controls</button>
  </div>
</div>

        <!-- Tab: Frameworks -->
       <div id="tab-frameworks" class="grc-tab active ftco-animate">
  <h3>Framework Library</h3>
  <p class="mb-3">
    A unified, paraphrased control set inspired by ISO 27001, NIST CSF, PCI DSS & HIPAA.
    Use the filters to explore how controls align across frameworks.
  </p>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-4 mb-2">
      <label class="text-muted small mb-1">Filter by Framework</label>
      <select id="framework-filter" class="form-control form-control-sm">
        <option value="all">All frameworks</option>
        <option value="ISO 27001">ISO 27001</option>
        <option value="NIST CSF">NIST CSF</option>
        <option value="PCI DSS">PCI DSS</option>
        <option value="HIPAA">HIPAA</option>
      </select>
    </div>
    <div class="col-md-4 mb-2">
      <label class="text-muted small mb-1">Filter by Category</label>
      <select id="category-filter" class="form-control form-control-sm">
        <option value="all">All categories</option>
        <option value="Access Control">Access Control</option>
        <option value="Identity & Authentication">Identity & Authentication</option>
        <option value="Logging & Monitoring">Logging & Monitoring</option>
        <option value="Encryption & Key Management">Encryption & Key Management</option>
        <option value="Backup & Recovery">Backup & Recovery</option>
        <option value="Change Management">Change Management</option>
        <option value="Vulnerability Management">Vulnerability Management</option>
        <option value="Incident Response">Incident Response</option>
        <option value="Vendor Risk">Vendor Risk</option>
        <option value="Policy & Governance">Policy & Governance</option>
        <option value="Awareness & Training">Awareness & Training</option>
      </select>
    </div>
    <div class="col-md-4 mb-2">
      <label class="text-muted small mb-1">Search</label>
      <input id="framework-search" type="text" class="form-control form-control-sm"
             placeholder="Search by name or description...">
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive bg-dark p-3 rounded">
    <table class="table table-dark table-striped table-hover table-sm mb-0">
      <thead>
        <tr>
          <th style="width: 10%;">ID</th>
          <th style="width: 20%;">Name</th>
          <th style="width: 18%;">Category</th>
          <th style="width: 20%;">Based On</th>
          <th style="width: 32%;">Description</th>
        </tr>
      </thead>
      <tbody id="frameworks-table-body">
        <!-- rows will be injected by JS -->
      </tbody>
    </table>
    <div class="mt-2 text-right">
      <small id="frameworks-count" class="text-muted"></small>
    </div>
  </div>
</div>

        <!-- Tab: Assets -->
        <div id="tab-assets" class="grc-tab ftco-animate">
  <h3>Asset Inventory</h3>
  <p class="mb-3">
    Capture the key systems, data stores, vendors, and services that need protection. These assets
    will later be linked to risks, controls, and findings.
  </p>

  <div class="row">
    <!-- Form column -->
    <div class="col-md-5 mb-4">
      <div class="bg-dark p-3 rounded">
        <h5 class="mb-3">Add / Edit Asset</h5>
        <form id="asset-form">
          <input type="hidden" id="asset-id">

          <div class="form-group">
            <label for="asset-name" class="text-muted small mb-1">Asset name *</label>
            <input type="text" id="asset-name" class="form-control form-control-sm"
                   placeholder="e.g. MediCloud Web App" required>
          </div>

          <div class="form-group">
            <label for="asset-type" class="text-muted small mb-1">Type *</label>
            <select id="asset-type" class="form-control form-control-sm" required>
              <option value="">Select type...</option>
              <option value="Application">Application</option>
              <option value="Database">Database</option>
              <option value="Server / Host">Server / Host</option>
              <option value="Network / Security Device">Network / Security Device</option>
              <option value="Cloud Service">Cloud Service</option>
              <option value="Vendor / Third Party">Vendor / Third Party</option>
              <option value="Data Store">Data Store</option>
              <option value="People / Role">People / Role</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="asset-criticality" class="text-muted small mb-1">Business criticality *</label>
            <select id="asset-criticality" class="form-control form-control-sm" required>
              <option value="">Select level...</option>
              <option value="High">High – outage or compromise severely impacts the business</option>
              <option value="Medium">Medium – important but tolerable short outage</option>
              <option value="Low">Low – limited impact if unavailable</option>
            </select>
          </div>

          <div class="form-group">
            <label class="text-muted small mb-1 d-block">Data types (optional)</label>
            <div class="d-flex flex-wrap">
              <div class="custom-control custom-checkbox mr-3 mb-1">
                <input type="checkbox" class="custom-control-input asset-datatype" id="dt-phi" value="PHI">
                <label class="custom-control-label" for="dt-phi">PHI</label>
              </div>
              <div class="custom-control custom-checkbox mr-3 mb-1">
                <input type="checkbox" class="custom-control-input asset-datatype" id="dt-pii" value="PII">
                <label class="custom-control-label" for="dt-pii">PII</label>
              </div>
              <div class="custom-control custom-checkbox mr-3 mb-1">
                <input type="checkbox" class="custom-control-input asset-datatype" id="dt-pan" value="Card data">
                <label class="custom-control-label" for="dt-pan">Card data</label>
              </div>
              <div class="custom-control custom-checkbox mr-3 mb-1">
                <input type="checkbox" class="custom-control-input asset-datatype" id="dt-int" value="Internal data">
                <label class="custom-control-label" for="dt-int">Internal data</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="asset-owner" class="text-muted small mb-1">Owner (team or role)</label>
            <input type="text" id="asset-owner" class="form-control form-control-sm"
                   placeholder="e.g. DevOps Team / CTO">
          </div>

          <div class="form-group">
            <label for="asset-notes" class="text-muted small mb-1">Notes (optional)</label>
            <textarea id="asset-notes" class="form-control form-control-sm" rows="2"
                      placeholder="Scope, integrations, region, etc."></textarea>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <button type="submit" id="asset-form-submit" class="btn btn-primary btn-sm">
              Save asset
            </button>
            <button type="button" id="asset-form-cancel" class="btn btn-outline-light btn-sm">
              Clear form
            </button>
          </div>

          <small class="text-muted d-block mt-2">
            Assets are stored locally in your browser (no data is sent to any server).
          </small>
        </form>
      </div>
    </div>

    <!-- Table column -->
    <div class="col-md-7 mb-4">
      <div class="bg-dark p-3 rounded">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Assets</h5>
          <small id="assets-count" class="text-muted"></small>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover table-sm mb-0">
            <thead>
              <tr>
                <th style="width: 22%;">Name</th>
                <th style="width: 16%;">Type</th>
                <th style="width: 14%;">Criticality</th>
                <th style="width: 20%;">Data types</th>
                <th style="width: 16%;">Owner</th>
                <th style="width: 12%;">Actions</th>
              </tr>
            </thead>
            <tbody id="assets-table-body">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <div id="assets-empty-state" class="text-muted small mt-2">
          No assets yet. Add your first asset using the form on the left.
        </div>
      </div>
    </div>
  </div>
</div>
        <!-- Tab: Risks -->
       <div id="tab-risks" class="grc-tab ftco-animate">
  <h3>Risk Register</h3>
  <p class="mb-3">
    Log risks against your assets, score likelihood and impact, and track ownership. Controls and issues
    will later map to these risks.
  </p>
<div id="tab-controls" class="grc-tab ftco-animate">
  <h3>Local Controls (Org Control Library)</h3>
  <p class="mb-3">
    This section will store your organization-specific controls and map them to both risks and framework
    requirements. It becomes your bridge between day-to-day tasks and ISO/NIST/PCI/HIPAA language.
  </p>

  <div class="bg-dark p-4 rounded">
    <p class="mb-0 text-muted">
      Coming next: form to add controls, link them to risks and framework controls, and see coverage.
    </p>
  </div>
</div>
         
  <div class="row">
    <!-- Form column -->
    <div class="col-md-5 mb-4">
      <div class="bg-dark p-3 rounded">
        <h5 class="mb-3">Add / Edit Risk</h5>
        <form id="risk-form">
          <input type="hidden" id="risk-id">

          <div class="form-group">
            <label for="risk-title" class="text-muted small mb-1">Risk title *</label>
            <input type="text" id="risk-title" class="form-control form-control-sm"
                   placeholder="e.g. Unauthorised access to MediCloud app" required>
          </div>

          <div class="form-group">
            <label for="risk-asset" class="text-muted small mb-1">Asset *</label>
            <select id="risk-asset" class="form-control form-control-sm" required>
              <option value="">Select asset...</option>
              <!-- options injected from assets -->
            </select>
          </div>

          <div class="form-group">
            <label for="risk-category" class="text-muted small mb-1">Category *</label>
            <select id="risk-category" class="form-control form-control-sm" required>
              <option value="">Select category...</option>
              <option value="Cybersecurity">Cybersecurity</option>
              <option value="Compliance">Compliance</option>
              <option value="Operational">Operational</option>
              <option value="Privacy">Privacy</option>
              <option value="Third-Party">Third-Party</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group col-6">
              <label for="risk-likelihood" class="text-muted small mb-1">Likelihood (1–5) *</label>
              <select id="risk-likelihood" class="form-control form-control-sm" required>
                <option value="">Select...</option>
                <option value="1">1 – Rare</option>
                <option value="2">2 – Unlikely</option>
                <option value="3">3 – Possible</option>
                <option value="4">4 – Likely</option>
                <option value="5">5 – Almost certain</option>
              </select>
            </div>
            <div class="form-group col-6">
              <label for="risk-impact" class="text-muted small mb-1">Impact (1–5) *</label>
              <select id="risk-impact" class="form-control form-control-sm" required>
                <option value="">Select...</option>
                <option value="1">1 – Insignificant</option>
                <option value="2">2 – Minor</option>
                <option value="3">3 – Moderate</option>
                <option value="4">4">4 – Major</option>
                <option value="5">5 – Severe</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="risk-owner" class="text-muted small mb-1">Risk owner (team or role)</label>
            <input type="text" id="risk-owner" class="form-control form-control-sm"
                   placeholder="e.g. CISO / Product Owner">
          </div>

          <div class="form-group">
            <label for="risk-status" class="text-muted small mb-1">Status *</label>
            <select id="risk-status" class="form-control form-control-sm" required>
              <option value="Open">Open</option>
              <option value="In progress">In progress</option>
              <option value="Mitigated">Mitigated</option>
              <option value="Accepted">Accepted</option>
            </select>
          </div>

          <div class="form-group">
            <label for="risk-notes" class="text-muted small mb-1">Description / Notes</label>
            <textarea id="risk-notes" class="form-control form-control-sm" rows="2"
                      placeholder="Describe the scenario, cause, and potential impact."></textarea>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <button type="submit" id="risk-form-submit" class="btn btn-primary btn-sm">
              Save risk
            </button>
            <button type="button" id="risk-form-cancel" class="btn btn-outline-light btn-sm">
              Clear form
            </button>
          </div>

          <small class="text-muted d-block mt-2">
            Inherent risk score is calculated as Likelihood × Impact. Later we’ll add residual risk based on controls.
          </small>
        </form>
      </div>
    </div>

    <!-- Table column -->
    <div class="col-md-7 mb-4">
      <div class="bg-dark p-3 rounded">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Risks</h5>
          <small id="risks-count" class="text-muted"></small>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover table-sm mb-0">
            <thead>
              <tr>
                <th style="width: 26%;">Title</th>
                <th style="width: 18%;">Asset</th>
                <th style="width: 16%;">Category</th>
                <th style="width: 16%;">Inherent score</th>
                <th style="width: 14%;">Status</th>
                <th style="width: 10%;">Actions</th>
              </tr>
            </thead>
            <tbody id="risks-table-body">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <div id="risks-empty-state" class="text-muted small mt-2">
          No risks yet. Add at least one asset first, then log a risk against it.
        </div>

        <small class="text-muted d-block mt-2">
          Simple scale: 1–5 × 1–5 → 1–25. We’ll treat 1–5 = Low, 6–12 = Medium, 15+ = High.
        </small>
      </div>
    </div>
  </div>
</div>

      </div>
    </section>

    <footer class="ftco-footer ftco-section">
      <div class="container">
        <div class="row">
          <div class="col-md-12 text-center">
            <p>
              Copyright &copy;<script>document.write(new Date().getFullYear());</script>
              All rights reserved
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Scripts (same as index) -->
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/jquery.animateNumber.min.js"></script>
    <script src="js/scrollax.min.js"></script>
    <script src="js/main.js"></script>

    <!-- Tab switcher + Framework Library + Asset + Risk logic -->
    <script>
      // --- Unified, paraphrased control set ---
      const FRAMEWORK_CONTROLS = [
        {
          id: "CTRL-AC-01",
          name: "Manage user accounts",
          category: "Access Control",
          description: "Only approved users receive accounts, and access is removed quickly when people change roles or leave.",
          frameworks: ["ISO 27001", "NIST CSF"],
          references: ["ISO 27001 A.9", "NIST PR.AC-1"]
        },
        {
          id: "CTRL-AC-02",
          name: "Limit privileged access",
          category: "Identity & Authentication",
          description: "Privileged roles are tightly controlled, logged, and reviewed on a regular schedule.",
          frameworks: ["ISO 27001", "NIST CSF", "PCI DSS"],
          references: ["ISO 27001 A.9.2", "NIST PR.AC-4", "PCI DSS 7"]
        },
        {
          id: "CTRL-AC-03",
          name: "Strong authentication",
          category: "Identity & Authentication",
          description: "Multi-factor authentication is used for admin accounts and remote access to critical systems.",
          frameworks: ["ISO 27001", "NIST CSF", "PCI DSS", "HIPAA"],
          references: ["ISO 27001 A.9.4", "NIST PR.AC-7", "PCI DSS 8", "HIPAA 164.312(d)"]
        },
        {
          id: "CTRL-LOG-01",
          name: "Central activity logging",
          category: "Logging & Monitoring",
          description: "Security-relevant events from key systems are collected in a central logging solution.",
          frameworks: ["ISO 27001", "NIST CSF", "PCI DSS"],
          references: ["ISO 27001 A.12.4", "NIST DE.AE-1", "PCI DSS 10"]
        },
        {
          id: "CTRL-LOG-02",
          name: "Regular log review",
          category: "Logging & Monitoring",
          description: "Logs for important systems are reviewed, with suspicious events investigated and documented.",
          frameworks: ["ISO 27001", "NIST CSF", "HIPAA"],
          references: ["ISO 27001 A.12.4", "NIST DE.CM-1", "HIPAA 164.308(a)(1)"]
        },
        {
          id: "CTRL-ENC-01",
          name: "Encrypt data at rest",
          category: "Encryption & Key Management",
          description: "Sensitive data stored in databases, file systems, and backups is encrypted.",
          frameworks: ["ISO 27001", "PCI DSS", "HIPAA"],
          references: ["ISO 27001 A.10", "PCI DSS 3", "HIPAA 164.312(a)(2)(iv)"]
        },
        {
          id: "CTRL-ENC-02",
          name: "Encrypt data in transit",
          category: "Encryption & Key Management",
          description: "Connections carrying sensitive data use secure protocols such as TLS, with weak ciphers disabled.",
          frameworks: ["ISO 27001", "NIST CSF", "PCI DSS", "HIPAA"],
          references: ["ISO 27001 A.13", "NIST PR.DS-2", "PCI DSS 4", "HIPAA 164.312(e)(1)"]
        },
        {
          id: "CTRL-BCP-01",
          name: "Backups & restore testing",
          category: "Backup & Recovery",
          description: "Critical systems and data are backed up regularly and restore tests are performed and documented.",
          frameworks: ["ISO 27001", "NIST CSF"],
          references: ["ISO 27001 A.12.3", "NIST PR.IP-4"]
        },
        {
          id: "CTRL-CHG-01",
          name: "Controlled changes",
          category: "Change Management",
          description: "Changes to production systems follow an approved process with impact assessment and rollback plans.",
          frameworks: ["ISO 27001", "NIST CSF"],
          references: ["ISO 27001 A.12.1", "NIST PR.IP-3"]
        },
        {
          id: "CTRL-CHG-02",
          name: "Separate environments",
          category: "Change Management",
          description: "Development and testing environments are separated from production, with restricted access between them.",
          frameworks: ["ISO 27001", "PCI DSS"],
          references: ["ISO 27001 A.12.1.4", "PCI DSS 6.4"]
        },
        {
          id: "CTRL-VULN-01",
          name: "Vulnerability management",
          category: "Vulnerability Management",
          description: "Systems are regularly scanned for vulnerabilities and patches are applied according to defined timelines.",
          frameworks: ["ISO 27001", "NIST CSF", "PCI DSS"],
          references: ["ISO 27001 A.12.6", "NIST DE.CM-8", "PCI DSS 11"]
        },
        {
          id: "CTRL-IR-01",
          name: "Incident response plan",
          category: "Incident Response",
          description: "There is a documented incident response plan with clear roles, steps, and communication paths.",
          frameworks: ["ISO 27001", "NIST CSF", "HIPAA"],
          references: ["ISO 27001 A.16", "NIST RS.RP-1", "HIPAA 164.308(a)(6)"]
        },
        {
          id: "CTRL-IR-02",
          name: "Detect and triage events",
          category: "Incident Response",
          description: "Security events are detected, triaged, classified, and escalated according to defined procedures.",
          frameworks: ["ISO 27001", "NIST CSF"],
          references: ["ISO 27001 A.16", "NIST DE.CM-1"]
        },
        {
          id: "CTRL-VND-01",
          name: "Vendor due diligence",
          category: "Vendor Risk",
          description: "Third-party service providers are assessed for security and privacy risks before onboarding and periodically thereafter.",
          frameworks: ["ISO 27001", "NIST CSF"],
          references: ["ISO 27001 A.15", "NIST ID.SC-1"]
        },
        {
          id: "CTRL-VND-02",
          name: "Data protection in contracts",
          category: "Vendor Risk",
          description: "Contracts with vendors include requirements for protecting data, breach notification, and right to audit.",
          frameworks: ["ISO 27001", "HIPAA"],
          references: ["ISO 27001 A.15.1.2", "HIPAA 164.308(b)"]
        },
        {
          id: "CTRL-POL-01",
          name: "Information security policy",
          category: "Policy & Governance",
          description: "Management-approved information security policies define expectations, roles, and responsibilities.",
          frameworks: ["ISO 27001", "NIST CSF"],
          references: ["ISO 27001 A.5", "NIST ID.GV-1"]
        },
        {
          id: "CTRL-AW-01",
          name: "Security awareness training",
          category: "Awareness & Training",
          description: "Employees receive regular training on security, privacy, phishing, and how to report incidents.",
          frameworks: ["ISO 27001", "NIST CSF", "HIPAA"],
          references: ["ISO 27001 A.7.2.2", "NIST PR.AT-1", "HIPAA 164.308(a)(5)"]
        }
      ];

      function renderFrameworkControls() {
        const tbody = document.getElementById('frameworks-table-body');
        const countEl = document.getElementById('frameworks-count');
        const frameworkFilter = document.getElementById('framework-filter');
        const categoryFilter = document.getElementById('category-filter');
        const searchInput = document.getElementById('framework-search');

        if (!tbody || !frameworkFilter || !categoryFilter || !searchInput) return;

        const frameworkValue = frameworkFilter.value;
        const categoryValue = categoryFilter.value;
        const searchValue = searchInput.value.trim().toLowerCase();

        const filtered = FRAMEWORK_CONTROLS.filter(ctrl => {
          const matchesFramework =
            frameworkValue === 'all' || ctrl.frameworks.includes(frameworkValue);
          const matchesCategory =
            categoryValue === 'all' || ctrl.category === categoryValue;
          const matchesSearch =
            !searchValue ||
            ctrl.name.toLowerCase().includes(searchValue) ||
            ctrl.description.toLowerCase().includes(searchValue) ||
            ctrl.id.toLowerCase().includes(searchValue);

          return matchesFramework && matchesCategory && matchesSearch;
        });

        tbody.innerHTML = '';
        filtered.forEach(ctrl => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${ctrl.id}</td>
            <td>${ctrl.name}</td>
            <td>${ctrl.category}</td>
            <td>${ctrl.references.join('<br>')}</td>
            <td>${ctrl.description}</td>
          `;
          tbody.appendChild(tr);
        });

        if (countEl) {
          countEl.textContent = `${filtered.length} control(s) shown out of ${FRAMEWORK_CONTROLS.length}`;
        }
      }

      // --- Asset inventory state ---
      const ASSET_STORAGE_KEY = 'grc_assets_v1';
      let assets = [];

      function loadAssets() {
        try {
          const raw = localStorage.getItem(ASSET_STORAGE_KEY);
          assets = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(assets)) assets = [];
        } catch (e) {
          assets = [];
        }
      }

      function saveAssets() {
        try {
          localStorage.setItem(ASSET_STORAGE_KEY, JSON.stringify(assets));
        } catch (e) {
          console.warn('Could not save assets to localStorage', e);
        }
      }

      function resetAssetForm() {
        const form = document.getElementById('asset-form');
        if (!form) return;

        form.reset();
        document.getElementById('asset-id').value = '';
        const submitBtn = document.getElementById('asset-form-submit');
        if (submitBtn) submitBtn.textContent = 'Save asset';
      }

      function getSelectedDataTypes() {
        const checkboxes = document.querySelectorAll('.asset-datatype');
        const selected = [];
        checkboxes.forEach(cb => {
          if (cb.checked) selected.push(cb.value);
        });
        return selected;
      }

      function setSelectedDataTypes(values) {
        const checkboxes = document.querySelectorAll('.asset-datatype');
        checkboxes.forEach(cb => {
          cb.checked = values && values.includes(cb.value);
        });
      }

      function handleAssetFormSubmit(event) {
        event.preventDefault();
        const idField = document.getElementById('asset-id');
        const nameField = document.getElementById('asset-name');
        const typeField = document.getElementById('asset-type');
        const critField = document.getElementById('asset-criticality');
        const ownerField = document.getElementById('asset-owner');
        const notesField = document.getElementById('asset-notes');

        if (!nameField.value.trim() || !typeField.value || !critField.value) {
          alert('Please fill in name, type, and criticality.');
          return;
        }

        const dataTypes = getSelectedDataTypes();
        const existingId = idField.value;

        if (existingId) {
          const idx = assets.findIndex(a => a.id === existingId);
          if (idx !== -1) {
            assets[idx] = {
              ...assets[idx],
              name: nameField.value.trim(),
              type: typeField.value,
              criticality: critField.value,
              owner: ownerField.value.trim(),
              dataTypes,
              notes: notesField.value.trim()
            };
          }
        } else {
          const newAsset = {
            id: 'AST-' + Date.now(),
            name: nameField.value.trim(),
            type: typeField.value,
            criticality: critField.value,
            owner: ownerField.value.trim(),
            dataTypes,
            notes: notesField.value.trim()
          };
          assets.push(newAsset);
        }

        saveAssets();
        renderAssetsTable();
        resetAssetForm();
      }

      function populateRiskAssetOptions() {
        const select = document.getElementById('risk-asset');
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value=\"\">Select asset...</option>';
        assets.forEach(asset => {
          const opt = document.createElement('option');
          opt.value = asset.id;
          opt.textContent = asset.name;
          select.appendChild(opt);
        });

        // Try to preserve previous selection if still valid
        if (currentValue && assets.some(a => a.id === currentValue)) {
          select.value = currentValue;
        }
      }

      function renderAssetsTable() {
        const tbody = document.getElementById('assets-table-body');
        const emptyState = document.getElementById('assets-empty-state');
        const countEl = document.getElementById('assets-count');

        if (!tbody) return;

        tbody.innerHTML = '';

        assets.forEach(asset => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${asset.name}</td>
            <td>${asset.type}</td>
            <td>${asset.criticality}</td>
            <td>${(asset.dataTypes || []).join(', ')}</td>
            <td>${asset.owner || ''}</td>
            <td>
              <button type="button" class="btn btn-sm btn-outline-light mb-1" data-asset-edit="${asset.id}">Edit</button>
              <button type="button" class="btn btn-sm btn-outline-light mb-1" data-asset-delete="${asset.id}">Del</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        if (emptyState) {
          emptyState.style.display = assets.length ? 'none' : 'block';
        }
        if (countEl) {
          countEl.textContent = `${assets.length} asset(s)`;
        }

        // Keep risk asset dropdown in sync
        populateRiskAssetOptions();
      }

      function handleAssetsTableClick(event) {
        const editId = event.target.getAttribute('data-asset-edit');
        const deleteId = event.target.getAttribute('data-asset-delete');

        if (editId) {
          const asset = assets.find(a => a.id === editId);
          if (!asset) return;

          document.getElementById('asset-id').value = asset.id;
          document.getElementById('asset-name').value = asset.name;
          document.getElementById('asset-type').value = asset.type;
          document.getElementById('asset-criticality').value = asset.criticality;
          document.getElementById('asset-owner').value = asset.owner || '';
          document.getElementById('asset-notes').value = asset.notes || '';
          setSelectedDataTypes(asset.dataTypes || []);

          const submitBtn = document.getElementById('asset-form-submit');
          if (submitBtn) submitBtn.textContent = 'Update asset';
        }

        if (deleteId) {
          if (!confirm('Delete this asset?')) return;
          assets = assets.filter(a => a.id !== deleteId);
          saveAssets();
          renderAssetsTable();
        }
      }

      // --- Risk register state ---
      const RISK_STORAGE_KEY = 'grc_risks_v1';
      let risks = [];

      function loadRisks() {
        try {
          const raw = localStorage.getItem(RISK_STORAGE_KEY);
          risks = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(risks)) risks = [];
        } catch (e) {
          risks = [];
        }
      }

      function saveRisks() {
        try {
          localStorage.setItem(RISK_STORAGE_KEY, JSON.stringify(risks));
        } catch (e) {
          console.warn('Could not save risks to localStorage', e);
        }
      }

      function calcRiskScore(likelihood, impact) {
        const l = Number(likelihood) || 0;
        const i = Number(impact) || 0;
        return l * i;
      }

      function calcRiskLevel(score) {
        if (score >= 15) return 'High';
        if (score >= 6) return 'Medium';
        if (score > 0) return 'Low';
        return '-';
      }

      function resetRiskForm() {
        const form = document.getElementById('risk-form');
        if (!form) return;

        form.reset();
        document.getElementById('risk-id').value = '';
        const submitBtn = document.getElementById('risk-form-submit');
        if (submitBtn) submitBtn.textContent = 'Save risk';
      }

      function handleRiskFormSubmit(event) {
        event.preventDefault();
        const idField = document.getElementById('risk-id');
        const titleField = document.getElementById('risk-title');
        const assetField = document.getElementById('risk-asset');
        const categoryField = document.getElementById('risk-category');
        const likelihoodField = document.getElementById('risk-likelihood');
        const impactField = document.getElementById('risk-impact');
        const ownerField = document.getElementById('risk-owner');
        const statusField = document.getElementById('risk-status');
        const notesField = document.getElementById('risk-notes');

        if (!titleField.value.trim() || !assetField.value || !categoryField.value ||
            !likelihoodField.value || !impactField.value || !statusField.value) {
          alert('Please fill in all required fields.');
          return;
        }

        const score = calcRiskScore(likelihoodField.value, impactField.value);
        const assetId = assetField.value;
        const asset = assets.find(a => a.id === assetId);
        const assetName = asset ? asset.name : '';

        const existingId = idField.value;

        if (existingId) {
          const idx = risks.findIndex(r => r.id === existingId);
          if (idx !== -1) {
            risks[idx] = {
              ...risks[idx],
              title: titleField.value.trim(),
              assetId,
              assetName,
              category: categoryField.value,
              likelihood: Number(likelihoodField.value),
              impact: Number(impactField.value),
              score,
              status: statusField.value,
              owner: ownerField.value.trim(),
              notes: notesField.value.trim()
            };
          }
        } else {
          const newRisk = {
            id: 'RSK-' + Date.now(),
            title: titleField.value.trim(),
            assetId,
            assetName,
            category: categoryField.value,
            likelihood: Number(likelihoodField.value),
            impact: Number(impactField.value),
            score,
            status: statusField.value,
            owner: ownerField.value.trim(),
            notes: notesField.value.trim()
          };
          risks.push(newRisk);
        }

        saveRisks();
        renderRisksTable();
        resetRiskForm();
      }

      function renderRisksTable() {
        const tbody = document.getElementById('risks-table-body');
        const emptyState = document.getElementById('risks-empty-state');
        const countEl = document.getElementById('risks-count');

        if (!tbody) return;

        tbody.innerHTML = '';

        risks.forEach(risk => {
          const level = calcRiskLevel(risk.score);
          let levelBadgeClass = '';
          if (level === 'High') levelBadgeClass = 'badge-danger';
          else if (level === 'Medium') levelBadgeClass = 'badge-warning';
          else if (level === 'Low') levelBadgeClass = 'badge-success';

          const scoreHtml = risk.score
            ? `<span class="badge ${levelBadgeClass} mr-1">${risk.score}</span><span class="text-muted small">${level}</span>`
            : '-';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${risk.title}</td>
            <td>${risk.assetName || ''}</td>
            <td>${risk.category}</td>
            <td>${scoreHtml}</td>
            <td>${risk.status}</td>
            <td>
              <button type="button" class="btn btn-sm btn-outline-light mb-1" data-risk-edit="${risk.id}">Edit</button>
              <button type="button" class="btn btn-sm btn-outline-light mb-1" data-risk-delete="${risk.id}">Del</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        if (emptyState) {
          emptyState.style.display = risks.length ? 'none' : 'block';
        }
        if (countEl) {
          countEl.textContent = `${risks.length} risk(s)`;
        }
      }

      function handleRisksTableClick(event) {
        const editId = event.target.getAttribute('data-risk-edit');
        const deleteId = event.target.getAttribute('data-risk-delete');

        if (editId) {
          const risk = risks.find(r => r.id === editId);
          if (!risk) return;

          document.getElementById('risk-id').value = risk.id;
          document.getElementById('risk-title').value = risk.title;
          document.getElementById('risk-asset').value = risk.assetId;
          document.getElementById('risk-category').value = risk.category;
          document.getElementById('risk-likelihood').value = String(risk.likelihood);
          document.getElementById('risk-impact').value = String(risk.impact);
          document.getElementById('risk-owner').value = risk.owner || '';
          document.getElementById('risk-status').value = risk.status || 'Open';
          document.getElementById('risk-notes').value = risk.notes || '';

          const submitBtn = document.getElementById('risk-form-submit');
          if (submitBtn) submitBtn.textContent = 'Update risk';
        }

        if (deleteId) {
          if (!confirm('Delete this risk?')) return;
          risks = risks.filter(r => r.id !== deleteId);
          saveRisks();
          renderRisksTable();
        }
      }

      // --- DOM ready ---
      document.addEventListener('DOMContentLoaded', function () {
        // Tabs
        const buttons = document.querySelectorAll('[data-grc-tab]');
        const tabs = {
          frameworks: document.getElementById('tab-frameworks'),
          assets: document.getElementById('tab-assets'),
          risks: document.getElementById('tab-risks')
        };

        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-grc-tab');

            buttons.forEach(b => b.classList.remove('btn-primary'));
            buttons.forEach(b => b.classList.add('btn-outline-light'));
            btn.classList.remove('btn-outline-light');
            btn.classList.add('btn-primary');

            Object.values(tabs).forEach(t => t.classList.remove('active'));
            tabs[target].classList.add('active');
          });
        });

        // Framework filters
        const frameworkFilter = document.getElementById('framework-filter');
        const categoryFilter = document.getElementById('category-filter');
        const searchInput = document.getElementById('framework-search');

        if (frameworkFilter && categoryFilter && searchInput) {
          frameworkFilter.addEventListener('change', renderFrameworkControls);
          categoryFilter.addEventListener('change', renderFrameworkControls);
          searchInput.addEventListener('input', renderFrameworkControls);
        }
        renderFrameworkControls();

        // Assets
        loadAssets();
        renderAssetsTable();

        const assetForm = document.getElementById('asset-form');
        if (assetForm) assetForm.addEventListener('submit', handleAssetFormSubmit);

        const assetCancel = document.getElementById('asset-form-cancel');
        if (assetCancel) assetCancel.addEventListener('click', resetAssetForm);

        const assetsTableBody = document.getElementById('assets-table-body');
        if (assetsTableBody) assetsTableBody.addEventListener('click', handleAssetsTableClick);

        // Risks
        loadRisks();
        renderRisksTable();
        populateRiskAssetOptions();

        const riskForm = document.getElementById('risk-form');
        if (riskForm) riskForm.addEventListener('submit', handleRiskFormSubmit);

        const riskCancel = document.getElementById('risk-form-cancel');
        if (riskCancel) riskCancel.addEventListener('click', resetRiskForm);

        const risksTableBody = document.getElementById('risks-table-body');
        if (risksTableBody) risksTableBody.addEventListener('click', handleRisksTableClick);
      });
    </script>
  </body>
</html>
