







<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GRC Practice Lab | The Complete GRC Learning Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Google tag (gtag.js) — Analytics (GA4) -->
    <!-- Replace G-QYWFEQ2HTG with your Measurement ID from Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWFEQ2HTG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // SPA mode: we will send page_view events manually on tab changes
      gtag('config', 'G-QYWFEQ2HTG', { send_page_view: false });
    </script>
<style>
:root {
    --bg-base: #f8fafc;
    --bg-surface: #ffffff;
    --bg-elevated: #f1f5f9;
    --bg-hover: #e2e8f0;
    --border-subtle: rgba(0,0,0,0.06);
    --border-default: rgba(0,0,0,0.1);
    --border-strong: rgba(0,0,0,0.15);
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #64748b;
    --accent-blue: #2563eb;
    --accent-blue-soft: rgba(37,99,235,0.12);
    --accent-green: #16a34a;
    --accent-green-soft: rgba(22,163,74,0.12);
    --accent-amber: #d97706;
    --accent-amber-soft: rgba(217,119,6,0.12);
    --accent-red: #dc2626;
    --accent-red-soft: rgba(220,38,38,0.12);
    --accent-purple: #9333ea;
    --accent-purple-soft: rgba(147,51,234,0.12);
    --accent-cyan: #0891b2;
    --accent-cyan-soft: rgba(8,145,178,0.12);
    --accent-pink: #db2777;
    --accent-pink-soft: rgba(219,39,119,0.12);
    --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    --gradient-green: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    --gradient-purple: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
    --gradient-hero: linear-gradient(135deg, #1e3a8a 0%, #312e81 50%, #581c87 100%);
    --gradient-mesh: radial-gradient(at 40% 20%, rgba(59,130,246,0.08) 0px, transparent 50%),
                     radial-gradient(at 80% 0%, rgba(168,85,247,0.06) 0px, transparent 50%),
                     radial-gradient(at 0% 50%, rgba(34,197,94,0.05) 0px, transparent 50%);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
    --shadow-xl: 0 20px 50px rgba(0,0,0,0.15);
    --shadow-glow-blue: 0 0 40px rgba(59,130,246,0.15);
    --shadow-glow-green: 0 0 40px rgba(34,197,94,0.15);
    --shadow-glow-purple: 0 0 40px rgba(147,51,234,0.2);
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-2xl: 20px;
    --radius-full: 9999px;
    --font-sans: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
    --transition-fast: 0.15s ease;
    --transition-normal: 0.2s ease;
    --transition-slow: 0.3s ease;
}
/* ===== LANDING PAGE STYLES ===== */
.landing-page {
    min-height: 100vh;
    background: var(--gradient-hero);
    position: relative;
    overflow: hidden;
}
.landing-page::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(59,130,246,0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(168,85,247,0.25) 0%, transparent 40%),
        radial-gradient(circle at 40% 80%, rgba(34,197,94,0.2) 0%, transparent 40%);
    pointer-events: none;
}
.landing-page::after {
    content: '';
    position: absolute;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    opacity: 0.03;
    pointer-events: none;
}
.landing-container { max-width: 1200px; margin: 0 auto; padding: 0 24px; position: relative; z-index: 1; }
.landing-nav { display: flex; justify-content: space-between; align-items: center; padding: 24px 0; }
.landing-logo { display: flex; align-items: center; gap: 12px; }
.landing-logo-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid rgba(255,255,255,0.2); }
.landing-logo-text { font-size: 22px; font-weight: 800; color: white; letter-spacing: -0.02em; }
.landing-nav-links { display: flex; gap: 32px; }
.landing-nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; font-weight: 500; transition: color var(--transition-fast); }
.landing-nav-links a:hover { color: white; }
.landing-hero { text-align: center; padding: 80px 0 60px; }
.landing-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: var(--radius-full); font-size: 13px; font-weight: 600; color: white; margin-bottom: 24px; animation: fadeInUp 0.6s ease; }
.landing-badge i { color: #fbbf24; }
.landing-title { font-size: clamp(40px, 6vw, 72px); font-weight: 800; color: white; line-height: 1.1; letter-spacing: -0.03em; margin-bottom: 24px; animation: fadeInUp 0.6s ease 0.1s both; }
.landing-title span { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.landing-subtitle { font-size: clamp(16px, 2vw, 20px); color: rgba(255,255,255,0.8); max-width: 700px; margin: 0 auto 40px; line-height: 1.7; animation: fadeInUp 0.6s ease 0.2s both; }
.landing-cta { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; animation: fadeInUp 0.6s ease 0.3s both; }
.btn-landing-primary { display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: white; color: var(--text-primary); font-size: 16px; font-weight: 700; border-radius: var(--radius-lg); border: none; cursor: pointer; transition: all var(--transition-normal); box-shadow: var(--shadow-lg); }
.btn-landing-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-xl); }
.btn-landing-secondary { display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); color: white; font-size: 16px; font-weight: 600; border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: all var(--transition-normal); }
.btn-landing-secondary:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }
.landing-features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; padding: 60px 0; animation: fadeInUp 0.6s ease 0.4s both; }
.landing-feature-card { background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: var(--radius-xl); padding: 28px; transition: all var(--transition-normal); }
.landing-feature-card:hover { background: rgba(255,255,255,0.12); transform: translateY(-4px); border-color: rgba(255,255,255,0.25); }
.landing-feature-icon { width: 52px; height: 52px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 16px; }
.landing-feature-icon.blue { background: var(--accent-blue-soft); color: #60a5fa; }
.landing-feature-icon.green { background: var(--accent-green-soft); color: #4ade80; }
.landing-feature-icon.purple { background: var(--accent-purple-soft); color: #c084fc; }
.landing-feature-icon.amber { background: var(--accent-amber-soft); color: #fbbf24; }
.landing-feature-icon.red { background: var(--accent-red-soft); color: #f87171; }
.landing-feature-icon.cyan { background: var(--accent-cyan-soft); color: #22d3ee; }
.landing-feature-title { font-size: 18px; font-weight: 700; color: white; margin-bottom: 8px; }
.landing-feature-desc { font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.6; }
.landing-stats { display: flex; justify-content: center; gap: 60px; padding: 40px 0 80px; flex-wrap: wrap; animation: fadeInUp 0.6s ease 0.5s both; }
.landing-stat { text-align: center; }
.landing-stat-value { font-size: 48px; font-weight: 800; color: white; line-height: 1; margin-bottom: 4px; }
.landing-stat-label { font-size: 14px; color: rgba(255,255,255,0.6); font-weight: 500; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.landing-page{display:none !important;}
.app-wrapper{display:block !important;}
.app-wrapper.active{display:block !important;}
/* Interactive Flow Styles */
.flow-container { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 32px; background: var(--bg-elevated); border-radius: var(--radius-xl); overflow-x: auto; margin-bottom: 24px; }
.flow-node { background: var(--bg-surface); border: 2px solid var(--border-default); border-radius: var(--radius-lg); padding: 20px; min-width: 110px; text-align: center; cursor: pointer; transition: all var(--transition-normal); }
.flow-node:hover { border-color: var(--accent-blue); transform: translateY(-4px); box-shadow: var(--shadow-lg); }
.flow-node.active { border-color: var(--accent-blue); background: var(--accent-blue-soft); }
.flow-node-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 0 auto 12px; }
.flow-node-title { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
.flow-node-count { font-size: 22px; font-weight: 700; }
.flow-arrow { color: var(--text-muted); font-size: 24px; flex-shrink: 0; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: var(--font-sans);
    background: var(--bg-base);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}
.app-container { display: flex; min-height: 100vh; }
.sidebar {
    width: 260px;
    background: var(--bg-surface);
    border-right: 1px solid var(--border-default);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 64px; left: 0; bottom: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
}
.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-default);
}
.logo-container { display: flex; align-items: center; gap: 12px; }
.logo-icon {
    width: 40px; height: 40px;
    background: var(--gradient-blue);
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: var(--shadow-glow-blue);
}
.logo-text { font-size: 18px; font-weight: 700; }
.logo-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--accent-purple-soft);
    color: var(--accent-purple);
    border-radius: var(--radius-full);
    font-weight: 600;
    margin-left: auto;
}
.sidebar-nav { flex: 1; overflow-y: auto; padding: 12px; }
.nav-section { margin-bottom: 16px; }
.nav-section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    padding: 8px 12px;
}
.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}
.nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
.nav-item.active {
    background: var(--accent-blue-soft);
    color: var(--accent-blue);
}
.nav-item.active::before {
    content: '';
    position: absolute;
    left: 0; top: 50%;
    transform: translateY(-50%);
    width: 3px; height: 20px;
    background: var(--accent-blue);
    border-radius: 0 2px 2px 0;
}
.nav-item i { font-size: 18px; width: 20px; text-align: center; }
.nav-badge {
    margin-left: auto;
    font-size: 11px;
    padding: 2px 8px;
    background: var(--bg-elevated);
    border-radius: var(--radius-full);
    color: var(--text-muted);
    font-weight: 600;
}
.nav-item.active .nav-badge { background: var(--accent-blue); color: white; }

/* Collapsible Sidebar Sections */
.nav-section-title { cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; transition: color 0.2s; }
.nav-section-title:hover { color: var(--text-primary); }
.nav-section-title .section-chevron { font-size: 10px; transition: transform 0.2s ease; }
.nav-section.collapsed .section-chevron { transform: rotate(-90deg); }
.nav-section.collapsed .nav-item { display: none; }
.nav-section.collapsed .nav-item.active { display: flex; } /* Always show active item */

/* Coach Panel */
.coach-fab { position: fixed; bottom: 24px; right: 24px; width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; border: none; font-size: 22px; cursor: pointer; box-shadow: 0 4px 20px rgba(37,99,235,0.4); z-index: 1000; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
.coach-fab:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(37,99,235,0.5); }
.coach-fab .coach-pulse { position: absolute; inset: -4px; border-radius: 50%; border: 2px solid rgba(37,99,235,0.4); animation: coach-ping 2s infinite; }
@keyframes coach-ping { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
.coach-panel { position: fixed; right: -420px; top: 64px; bottom: 0; width: 400px; background: var(--bg-surface); border-left: 1px solid var(--border-default); box-shadow: -4px 0 24px rgba(0,0,0,0.1); z-index: 999; transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; overflow: hidden; }
.coach-panel.open { right: 0; }
.coach-panel-header { padding: 20px; background: linear-gradient(135deg, #1e40af, #7c3aed); color: white; display: flex; align-items: center; justify-content: space-between; }
.coach-panel-body { flex: 1; overflow-y: auto; padding: 20px; }
.coach-section { margin-bottom: 20px; }
.coach-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.coach-text { font-size: 13px; color: var(--text-secondary); line-height: 1.7; }
.coach-step { display: flex; gap: 10px; align-items: flex-start; padding: 8px 0; }
.coach-step-num { width: 22px; height: 22px; border-radius: 50%; background: var(--accent-blue-soft); color: var(--accent-blue); font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.coach-step-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
.coach-mistake { background: var(--accent-red-soft); border-radius: var(--radius-md); padding: 10px 12px; margin-bottom: 8px; font-size: 12px; color: var(--accent-red); display: flex; align-items: flex-start; gap: 8px; }
.coach-tip { background: var(--accent-green-soft); border-radius: var(--radius-md); padding: 10px 12px; margin-bottom: 8px; font-size: 12px; color: var(--accent-green); display: flex; align-items: flex-start; gap: 8px; }
.coach-next-btn { display: block; width: 100%; padding: 12px; background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; border: none; border-radius: var(--radius-md); font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; transition: opacity 0.2s; margin-top: 8px; }
.coach-next-btn:hover { opacity: 0.9; }

/* Workflow Chain Toast */
.workflow-toast { position: fixed; bottom: 80px; right: 24px; background: var(--bg-surface); border: 1px solid var(--accent-blue); border-radius: var(--radius-lg); padding: 16px 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); z-index: 1001; max-width: 360px; animation: slideInRight 0.3s ease; }
@keyframes slideInRight { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.workflow-toast-title { font-size: 13px; font-weight: 700; color: var(--accent-blue); margin-bottom: 4px; }
.workflow-toast-text { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; }
.workflow-toast-actions { display: flex; gap: 8px; }
.workflow-toast-btn { padding: 6px 14px; border-radius: var(--radius-md); font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
.workflow-toast-btn.primary { background: var(--accent-blue); color: white; }
.workflow-toast-btn.ghost { background: var(--bg-elevated); color: var(--text-secondary); }

/* Quality Coach Inline */
.quality-hint { font-size: 11px; padding: 6px 10px; border-radius: var(--radius-sm); margin-top: 4px; display: none; }
.quality-hint.warn { display: block; background: var(--accent-amber-soft); color: var(--accent-amber); }
.quality-hint.good { display: block; background: var(--accent-green-soft); color: var(--accent-green); }

/* Health Advisor Cards */
.health-gap { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); margin-bottom: 8px; border-left: 3px solid var(--accent-red); }
.health-gap.warning { border-left-color: var(--accent-amber); }
.health-gap.info { border-left-color: var(--accent-blue); }
.health-gap-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.health-gap-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
.health-gap-action { font-size: 11px; color: var(--accent-blue); font-weight: 600; cursor: pointer; margin-top: 4px; display: inline-block; }
.health-gap-action:hover { text-decoration: underline; }

/* Mode Toggles */
.mode-toggle-bar { display: flex; align-items: center; gap: 6px; }
.mode-pill { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-default); background: var(--bg-elevated); color: var(--text-muted); user-select: none; }
.mode-pill.active { background: var(--accent-purple-soft); color: var(--accent-purple); border-color: var(--accent-purple); }
.mode-pill:hover { border-color: var(--accent-blue); }

/* Beginner Mode — hide advanced fields */
body.beginner-mode .adv-field { display: none !important; }
body.beginner-mode .beginner-tip { display: block !important; }
.beginner-tip { display: none; font-size: 11px; color: var(--accent-blue); background: var(--accent-blue-soft); border-radius: var(--radius-sm); padding: 6px 10px; margin-top: 4px; line-height: 1.5; }

/* Developer Mode — show JSON panel */
.dev-panel { display: none; position: fixed; bottom: 0; left: 260px; right: 0; height: 220px; background: #0f172a; color: #a5f3fc; font-family: 'JetBrains Mono', monospace; font-size: 11px; z-index: 998; border-top: 2px solid #0891b2; overflow: auto; padding: 12px 16px; }
body.dev-mode .dev-panel { display: block; }
body.dev-mode .main-content { padding-bottom: 220px; }
.dev-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; color: #38bdf8; font-weight: 700; font-size: 12px; }
.dev-panel pre { margin: 0; white-space: pre-wrap; word-break: break-all; }

/* Glossary Popovers */
.help-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-blue-soft); color: var(--accent-blue); font-size: 10px; font-weight: 700; cursor: help; margin-left: 4px; position: relative; vertical-align: middle; }
.help-icon:hover .help-tooltip { display: block; }
.help-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); width: 240px; background: #0f172a; color: white; padding: 10px 12px; border-radius: var(--radius-md); font-size: 11px; font-weight: 400; line-height: 1.5; z-index: 1000; margin-bottom: 6px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); pointer-events: none; }
.help-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #0f172a; }

/* Decision Rationale */
.rationale-prompt { background: linear-gradient(135deg, var(--accent-amber-soft), var(--accent-purple-soft)); border-radius: var(--radius-md); padding: 10px 12px; margin-top: 8px; border-left: 3px solid var(--accent-amber); }
.rationale-prompt label { font-size: 11px; font-weight: 700; color: var(--accent-amber); display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
.rationale-prompt textarea { width: 100%; border: 1px solid var(--border-default); border-radius: var(--radius-sm); padding: 6px 8px; font-size: 12px; resize: vertical; min-height: 36px; font-family: inherit; }
.main-content {
    flex: 1;
    margin-left: 260px;
    min-height: 100vh;
    background: var(--bg-base);
    background-image: var(--gradient-mesh);
}
.content-header {
    position: sticky; top: 0; z-index: 50;
    background: rgba(248,250,252,0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border-default);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1400px;
}
.content-title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
.content-title i { color: var(--accent-blue); }
.header-actions { display: flex; gap: 12px; }
.content-body { 
    padding: 24px; 
    max-width: 1400px;
    margin: 0 auto;
}

/* ===== LARGE SCREEN FIXES ===== */
/* Apply max-width constraints on screens larger than 1400px */
@media (min-width: 1440px) {
    .content-body {
        max-width: 1320px;
        margin: 0 auto;
        padding: 24px 32px;
    }
    .content-header {
        max-width: 100%;
    }
}

@media (min-width: 1600px) {
    .content-body {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px 40px;
    }
}

@media (min-width: 1920px) {
    .content-body {
        max-width: 1400px;
        margin: 0 auto;
    }
    .main-content {
        background: var(--bg-base);
    }
}

/* Ensure grids don't stretch too wide */
.projects-grid,
.work-grid,
.unified-grid {
    max-width: 1200px;
}

/* Table responsiveness */
.data-table {
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
}

/* Chart containers - consistent sizing */
.card {
    max-width: 100%;
}

/* Grid constraints for dashboard - inline style overrides */
[style*="grid-template-columns: repeat(6"] {
    max-width: 1320px !important;
}

[style*="grid-template-columns: 1fr 1fr 1fr"] {
    max-width: 1320px !important;
}

[style*="grid-template-columns: 2fr 1fr"] {
    max-width: 1320px !important;
}

[style*="grid-template-columns: 1fr 1fr;"] {
    max-width: 1320px !important;
}

/* ===== CONSISTENT BUTTON STYLES ===== */
.btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 18px; font-size: 13px; font-weight: 600;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: var(--font-sans);
    line-height: 1;
    white-space: nowrap;
}
.btn-primary {
    background: var(--accent-blue);
    color: white; border: none;
    box-shadow: var(--shadow-sm);
}
.btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn-secondary {
    background: var(--bg-surface);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
}
.btn-secondary:hover { background: var(--bg-elevated); border-color: var(--border-strong); }
.btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid transparent; }
.btn-ghost:hover { background: var(--bg-elevated); color: var(--text-primary); }
.btn-sm { padding: 7px 14px; font-size: 12px; }
.btn-lg { padding: 12px 24px; font-size: 14px; }
.btn-xs { padding: 5px 10px; font-size: 11px; }

/* Filter/Toggle Button Group - Used everywhere for filters */
.btn-group { display: inline-flex; gap: 0; }
.btn-group .btn { border-radius: 0; margin: 0; }
.btn-group .btn:first-child { border-radius: var(--radius-md) 0 0 var(--radius-md); }
.btn-group .btn:last-child { border-radius: 0 var(--radius-md) var(--radius-md) 0; }
.btn-group .btn:not(:last-child) { border-right: none; }

.btn-filter {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 500;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}
.btn-filter:hover { background: var(--bg-elevated); color: var(--text-primary); }
.btn-filter.active {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
}

/* ===== CONSISTENT TYPOGRAPHY ===== */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-sans);
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
}
h1 { font-size: 24px; }
h2 { font-size: 20px; }
h3 { font-size: 16px; }
h4 { font-size: 14px; }
p { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
.text-sm { font-size: 13px; }
.text-xs { font-size: 12px; }
.text-lg { font-size: 16px; }

.card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-normal);
}
.card:hover { border-color: var(--border-default); box-shadow: var(--shadow-md); }
.card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
}
.card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; }
.metric-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 20px;
    position: relative;
    overflow: hidden;
}
.metric-card::before {
    content: ''; position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--gradient-blue);
    opacity: 0;
    transition: opacity var(--transition-normal);
}
.metric-card:hover::before { opacity: 1; }
.metric-icon {
    width: 48px; height: 48px;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    margin-bottom: 16px;
}
.metric-icon.blue { background: var(--accent-blue-soft); color: var(--accent-blue); }
.metric-icon.green { background: var(--accent-green-soft); color: var(--accent-green); }
.metric-icon.amber { background: var(--accent-amber-soft); color: var(--accent-amber); }
.metric-icon.red { background: var(--accent-red-soft); color: var(--accent-red); }
.metric-icon.purple { background: var(--accent-purple-soft); color: var(--accent-purple); }
.metric-icon.cyan { background: var(--accent-cyan-soft); color: var(--accent-cyan); }
.metric-value { font-size: 32px; font-weight: 700; line-height: 1; margin-bottom: 4px; }
.metric-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
.metric-change {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 12px; font-weight: 600; margin-top: 8px;
    padding: 2px 8px; border-radius: var(--radius-full);
}
.metric-change.positive { background: var(--accent-green-soft); color: var(--accent-green); }
.metric-change.negative { background: var(--accent-red-soft); color: var(--accent-red); }
.table-container {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}
.table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 12px;
}
.table-title { font-size: 15px; font-weight: 600; }
table { width: 100%; border-collapse: collapse; table-layout: auto; }
thead { background: var(--bg-elevated); }
th {
    padding: 12px 16px;
    font-size: 12px; font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    text-align: left;
    border-bottom: 1px solid var(--border-subtle);
    white-space: nowrap;
}
td {
    padding: 12px 16px;
    font-size: 14px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
}
/* Table container for horizontal scroll on small screens */
.table-wrapper {
    overflow-x: auto;
    max-width: 100%;
}
tbody tr { transition: background var(--transition-fast); }
tbody tr:hover { background: var(--bg-elevated); }
tbody tr:last-child td { border-bottom: none; }
.badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px;
    font-size: 12px; font-weight: 600;
    border-radius: var(--radius-full);
    white-space: nowrap;
}
.badge-blue { background: var(--accent-blue-soft); color: var(--accent-blue); }
.badge-green { background: var(--accent-green-soft); color: var(--accent-green); }
.badge-amber { background: var(--accent-amber-soft); color: var(--accent-amber); }
.badge-red { background: var(--accent-red-soft); color: var(--accent-red); }
.badge-purple { background: var(--accent-purple-soft); color: var(--accent-purple); }
.badge-cyan { background: var(--accent-cyan-soft); color: var(--accent-cyan); }
.badge-pink { background: var(--accent-pink-soft); color: var(--accent-pink); }
.badge-gray { background: var(--bg-elevated); color: var(--text-muted); }
.fw-badge {
    display: inline-flex; padding: 2px 8px;
    font-size: 11px; font-weight: 600;
    border-radius: var(--radius-sm);
    margin-right: 4px;
}
.fw-iso27001 { background: #1e40af; color: #93c5fd; }
.fw-nistcsf { background: #065f46; color: #6ee7b7; }
.fw-soc2 { background: #5b21b6; color: #c4b5fd; }
.fw-pcidss { background: #92400e; color: #fcd34d; }
.fw-hipaa { background: #831843; color: #f9a8d4; }
.fw-gdpr { background: #7f1d1d; color: #fca5a5; }
.fw-cis { background: #0e7490; color: #67e8f9; }
.severity-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.severity-critical { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
.severity-high { background: #f97316; }
.severity-medium { background: var(--accent-amber); }
.severity-low { background: var(--accent-green); }
.form-group { margin-bottom: 16px; }
.form-label {
    display: block;
    font-size: 13px; font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.form-input, .form-select, .form-textarea, .form-control {
    width: 100%;
    padding: 10px 14px;
    font-size: 14px;
    font-family: inherit;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    transition: all var(--transition-fast);
    box-sizing: border-box;
}
.form-input:focus, .form-select:focus, .form-textarea:focus, .form-control:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px var(--accent-blue-soft);
}
.form-input::placeholder, .form-control::placeholder { color: var(--text-muted); }
.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
}
.form-select option { background: var(--bg-surface); color: var(--text-primary); }
.form-textarea { min-height: 100px; resize: vertical; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
    opacity: 0; visibility: hidden;
    transition: all var(--transition-normal);
}
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    width: 100%; max-width: 560px;
    max-height: 90vh;
    overflow: hidden;
    display: flex; flex-direction: column;
    transform: scale(0.95) translateY(20px);
    transition: transform var(--transition-normal);
    box-shadow: var(--shadow-lg);
}
.modal-overlay.active .modal { transform: scale(1) translateY(0); }
.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close {
    width: 32px; height: 32px;
    border-radius: var(--radius-md);
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
}
.modal-close:hover { background: var(--bg-elevated); color: var(--text-primary); }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-subtle);
    display: flex; justify-content: flex-end; gap: 12px;
    background: var(--bg-elevated);
}
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.welcome-banner {
    background: linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: 32px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
}
.welcome-banner::before {
    content: ''; position: absolute;
    top: -50%; right: -20%;
    width: 500px; height: 500px;
    background: radial-gradient(circle, var(--accent-blue-soft) 0%, transparent 70%);
    pointer-events: none;
}
.welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; position: relative; }
.welcome-subtitle { font-size: 15px; color: var(--text-secondary); max-width: 600px; margin-bottom: 20px; position: relative; }
.welcome-actions { display: flex; gap: 12px; position: relative; }
.risk-matrix {
    display: grid;
    grid-template-columns: auto repeat(5, 1fr);
    gap: 2px;
    background: var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
    padding: 2px;
}
.risk-matrix-cell {
    padding: 12px;
    text-align: center;
    font-size: 12px; font-weight: 600;
    min-width: 55px; min-height: 45px;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-surface);
}
.risk-matrix-header { background: var(--bg-elevated); color: var(--text-muted); }
.risk-low { background: #dcfce7; color: #166534; }
.risk-medium { background: #fef3c7; color: #92400e; }
.risk-high { background: #fed7aa; color: #9a3412; }
.risk-critical { background: #fee2e2; color: #b91c1c; }
.progress-bar { height: 8px; background: var(--bg-elevated); border-radius: var(--radius-full); overflow: hidden; }
.progress-fill { height: 100%; border-radius: var(--radius-full); }
.progress-fill.blue { background: var(--gradient-blue); }
.progress-fill.green { background: var(--gradient-green); }
.progress-fill.amber { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.progress-fill.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.progress-fill.purple { background: var(--gradient-purple); }

/* ===== GLOBAL MODERN UI STYLES ===== */
@keyframes modern-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
@keyframes modern-float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
@keyframes modern-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
@keyframes modern-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes modern-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

.modern-page-hero {
    background: linear-gradient(-45deg, #0f172a, #1e3a5f, #312e81, #4c1d95);
    background-size: 400% 400%;
    animation: modern-gradient 15s ease infinite;
    border-radius: var(--radius-2xl);
    padding: 28px 32px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
}
.modern-page-hero::before {
    content: '';
    position: absolute;
    top: -100px; right: -100px;
    width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(59,130,246,0.3) 0%, transparent 70%);
    pointer-events: none;
}
.modern-page-hero::after {
    content: '';
    position: absolute;
    bottom: -50px; left: -50px;
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(168,85,247,0.2) 0%, transparent 70%);
    pointer-events: none;
}
.modern-page-hero-content { position: relative; z-index: 1; }
.modern-page-hero h1 { font-size: 24px; font-weight: 700; color: white; margin: 0 0 4px 0; }
.modern-page-hero p { font-size: 14px; color: rgba(255,255,255,0.7); margin: 0; }
.modern-page-hero-icon {
    width: 52px; height: 52px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.2);
    font-size: 24px; color: white;
}

.modern-kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.modern-kpi-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: modern-fade-in 0.5s ease-out;
}
.modern-kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    border-color: var(--accent-blue);
}
.modern-kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--kpi-color, var(--accent-blue)), transparent);
    opacity: 0;
    transition: opacity 0.3s;
}
.modern-kpi-card:hover::before { opacity: 1; }
.modern-kpi-icon {
    width: 44px; height: 44px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    margin-bottom: 12px;
}
.modern-kpi-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
.modern-kpi-label { font-size: 13px; color: var(--text-muted); }

.modern-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    overflow: hidden;
    transition: all 0.3s ease;
    animation: modern-fade-in 0.5s ease-out;
}
.modern-card:hover { box-shadow: var(--shadow-lg); }
.modern-card-header {
    padding: 18px 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.modern-card-title {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}
.modern-card-body { padding: 20px; }

.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}
.modern-table thead th {
    background: var(--bg-elevated);
    padding: 14px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
}
.modern-table tbody tr {
    transition: all 0.2s ease;
    cursor: pointer;
}
.modern-table tbody tr:hover {
    background: var(--bg-elevated);
}
.modern-table tbody td {
    padding: 14px 16px;
    font-size: 14px;
    border-bottom: 1px solid var(--border-subtle);
}
.modern-table tbody tr:last-child td {
    border-bottom: none;
}

.modern-list-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-subtle);
    cursor: pointer;
    transition: all 0.2s ease;
}
.modern-list-item:hover { background: var(--bg-elevated); }
.modern-list-item:last-child { border-bottom: none; }
.modern-list-icon {
    width: 44px; height: 44px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}
.modern-list-content { flex: 1; min-width: 0; }
.modern-list-title {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}
.modern-list-subtitle { font-size: 12px; color: var(--text-muted); }

.modern-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}
.modern-empty-icon {
    width: 80px; height: 80px;
    background: var(--bg-elevated);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    margin: 0 auto 20px;
    opacity: 0.6;
}
.modern-empty h3 { font-size: 18px; font-weight: 600; margin: 0 0 8px; color: var(--text-primary); }
.modern-empty p { font-size: 14px; margin: 0 0 20px; }

.modern-score-badge {
    min-width: 44px;
    height: 44px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
}
.modern-score-badge.critical { background: linear-gradient(135deg, #ef4444, #dc2626); }
.modern-score-badge.high { background: linear-gradient(135deg, #f97316, #ea580c); }
.modern-score-badge.medium { background: linear-gradient(135deg, #eab308, #ca8a04); }
.modern-score-badge.low { background: linear-gradient(135deg, #22c55e, #16a34a); }

.modern-stats-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
}
.modern-stat-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    font-size: 12px;
    color: rgba(255,255,255,0.9);
}
.modern-stat-pill i { font-size: 14px; }

/* ===== PROJECT CARDS ===== */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    max-width: 1200px;
}
@media (max-width: 900px) { .projects-grid { grid-template-columns: 1fr; } }

.project-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all 0.2s ease;
}
.project-card:hover { border-color: var(--accent-blue); box-shadow: var(--shadow-md); }
.project-card-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-subtle);
}
.project-card-icon {
    width: 48px; height: 48px;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    margin-bottom: 12px;
}
.project-card-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.project-card-subtitle { font-size: 13px; color: var(--text-muted); }
.project-card-body { padding: 16px 20px; }
.project-card-meta {
    display: flex; gap: 16px; margin-bottom: 16px;
    font-size: 12px; color: var(--text-muted);
}
.project-card-meta-item { display: flex; align-items: center; gap: 6px; }
.project-card-tasks { margin-bottom: 16px; }
.project-card-task {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 0;
    font-size: 13px;
    border-bottom: 1px solid var(--border-subtle);
}
.project-card-task:last-child { border-bottom: none; }
.project-card-task i { font-size: 14px; }
.project-card-task.complete i { color: var(--accent-green); }
.project-card-task.incomplete i { color: var(--text-muted); }
.project-card-footer {
    padding: 16px 20px;
    background: var(--bg-elevated);
    display: flex; justify-content: space-between; align-items: center;
}
.project-card-progress { flex: 1; margin-right: 16px; }
.project-card-progress-text { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: flex; justify-content: space-between; }

/* ===== ONBOARDING / START HERE ===== */
.onboarding-step {
    display: flex; gap: 20px; padding: 24px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
    transition: all 0.2s ease;
}
.onboarding-step:hover { border-color: var(--accent-blue); }
.onboarding-step-number {
    width: 48px; height: 48px;
    background: var(--accent-blue);
    color: white;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; font-weight: 700;
    flex-shrink: 0;
}
.onboarding-step.completed .onboarding-step-number { background: var(--accent-green); }
.onboarding-step-content { flex: 1; }
.onboarding-step-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.onboarding-step-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }
.onboarding-step-action { display: flex; gap: 8px; }

.workflow-chain {
    display: flex; align-items: center; justify-content: center;
    gap: 8px; padding: 24px;
    background: var(--bg-elevated);
    border-radius: var(--radius-lg);
    margin: 24px 0;
    flex-wrap: wrap;
}
.workflow-chain-item {
    display: flex; flex-direction: column; align-items: center;
    padding: 16px 20px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    min-width: 100px;
}
.workflow-chain-item i { font-size: 24px; margin-bottom: 8px; }
.workflow-chain-item span { font-size: 12px; font-weight: 500; }
.workflow-chain-arrow { font-size: 20px; color: var(--text-muted); }

/* ===== STANDARDIZED CHART SIZES ===== */
.chart-donut {
    width: 120px;
    height: 120px;
    flex-shrink: 0;
}
.chart-donut-lg {
    width: 140px;
    height: 140px;
}
.chart-gauge {
    width: 140px;
    height: 140px;
}
.chart-bar-horizontal {
    height: 12px;
    border-radius: 6px;
    background: var(--bg-elevated);
    overflow: hidden;
}
.chart-bar-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
}

.chart-container {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: 20px;
}
.chart-header { display: flex; justify-content: space-between; margin-bottom: 16px; }
.chart-title { font-size: 15px; font-weight: 600; }
.chart-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 16px; justify-content: center; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.empty-state { text-align: center; padding: 48px; }
.empty-state-icon {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: var(--bg-elevated);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px;
    font-size: 32px;
    color: var(--text-muted);
}
.empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
.empty-state-text { font-size: 14px; color: var(--text-muted); max-width: 400px; margin: 0 auto 20px; }
.tab-content { display: none; animation: fadeIn var(--transition-normal); }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.toast-container {
    position: fixed;
    bottom: 20px; right: 20px;
    z-index: 2000;
    display: flex; flex-direction: column; gap: 12px;
}
.toast {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: 16px;
    display: flex; align-items: center; gap: 12px;
    min-width: 300px;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.toast-icon {
    width: 32px; height: 32px;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
}
.toast-success .toast-icon { background: var(--accent-green-soft); color: var(--accent-green); }
.toast-error .toast-icon { background: var(--accent-red-soft); color: var(--accent-red); }
.toast-info .toast-icon { background: var(--accent-blue-soft); color: var(--accent-blue); }
.toast-content { flex: 1; }
.toast-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
.toast-message { font-size: 13px; color: var(--text-muted); }
.trace-flow {
    display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    padding: 16px;
    background: var(--bg-elevated);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
}
.trace-node {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    min-width: 100px;
    text-align: center;
}
.trace-node-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.trace-node-value { font-size: 14px; font-weight: 600; }
.trace-arrow { color: var(--text-muted); font-size: 20px; }
.font-mono { font-family: var(--font-mono); }
.font-semibold { font-weight: 600; }
.text-muted { color: var(--text-muted); }
.text-red { color: var(--accent-red); }
.text-amber { color: var(--accent-amber); }
.mt-4 { margin-top: 16px; }
.mt-6 { margin-top: 24px; }
.mb-4 { margin-bottom: 16px; }
.mb-6 { margin-bottom: 24px; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-base); }
::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: var(--radius-full); }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
@media (max-width: 1024px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .mobile-toggle { display: flex !important; }
    .form-row { grid-template-columns: 1fr; }
}
.mobile-toggle { display: none; }
    
/* ===== RESPONSIVE FIX: EDU BANNER + TABLES ===== */
#edu-banner{
    margin-left: 260px;
    width: calc(100% - 260px);
    box-sizing: border-box;
    flex-wrap: wrap;
    padding-right: 56px; /* space for close button */
    text-align: center;
}
#edu-banner span{ line-height: 1.4; }
#edu-banner button{ right: 16px; top: 50%; transform: translateY(-50%); }

.table-container{
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.table-container table{
    min-width: 920px; /* keeps “large screen” layout */
}
.table-container th,
.table-container td{
    white-space: nowrap;
}

/* On smaller screens (sidebar collapses), banner should be full width */
@media (max-width: 1024px){
    #edu-banner{ margin-left: 0 !important; width: 100% !important; }
}


/* ===== Learning Controls (Career Mode) ===== */
.learning-controls .badge { border: 1px solid var(--border-default); background: var(--bg-surface); }
#learning-progress-pill { background: var(--bg-surface); }
.switch { position: relative; display: inline-block; width: 42px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-elevated); transition: .2s; border-radius: 999px; border: 1px solid var(--border-default); }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 1px; background: white; transition: .2s; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.switch input:checked + .slider { background: var(--accent-purple-soft); border-color: var(--accent-purple); }
.switch input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 999px; }
@media (max-width: 1100px) {
  .learning-controls { justify-content: flex-end; }
}
@media (max-width: 780px) {
  #learning-controls { display:none !important; } /* Keep header clean on small screens */
}
/* Modal title with Example button */
#modal-title { display:flex; align-items:center; justify-content: space-between; gap: 12px; }

/* === Force white headers for new learning tabs === */
#tab-missions h2,
#tab-interview-prep h2,
#tab-audit-sim h2,
#tab-community-roadmap h2 {
    color: #ffffff !important;
}
</style>
</head>
<body>
    <!-- ==================== LANDING PAGE ==================== -->
    <div class="landing-page" id="landing-page">
        <div class="landing-container">
            <nav class="landing-nav">
                <div class="landing-logo">
                    <div class="landing-logo-icon"></div>

                    <span class="landing-logo-text">GRC Practice Lab</span>
                </div>
                <div class="landing-nav-links">
                    <a href="#features">Features</a>
                    <a href="#frameworks">Frameworks</a>
                    <a href="https://www.youtube.com/@GRCMadeSimple" target="_blank">YouTube</a>
                </div>
            </nav>

            <section class="landing-hero">
                <div class="landing-badge">
                    <i class="bi bi-star-fill"></i>
                    <span>The #1 Free GRC Learning Platform</span>
                </div>
                
                <h1 class="landing-title">
                    Master GRC with<br><span>Hands-On Practice</span>
                </h1>
                
                <p class="landing-subtitle">
                    The complete Governance, Risk & Compliance practice environment. Learn by doing — manage risks, implement controls, collect evidence, and build your GRC portfolio. No theory only. Real practice.
                </p>
                
                <div class="landing-cta">
                    <button class="btn-landing-primary" onclick="app.startLab()">
                        <i class="bi bi-rocket-takeoff"></i>
                        Get Started — It's Free
                    </button>
                    <button class="btn-landing-secondary" onclick="app.startLabWithDemo()">
                        <i class="bi bi-lightning-fill"></i>
                        Launch with Demo Data
                    </button>
                </div>
            </section>

            <section class="landing-features" id="features">
                <div class="landing-feature-card">
                    <div class="landing-feature-icon blue"><i class="bi bi-shield-lock"></i></div>
                    <h3 class="landing-feature-title">Risk Management</h3>
                    <p class="landing-feature-desc">Create risk registers, assess likelihood & impact, build heat maps, and track treatments. Learn the full risk lifecycle.</p>
                </div>
                <div class="landing-feature-card">
                    <div class="landing-feature-icon green"><i class="bi bi-check2-circle"></i></div>
                    <h3 class="landing-feature-title">Control Testing</h3>
                    <p class="landing-feature-desc">Design tests, document results, link to evidence. Practice control assessment like a real auditor.</p>
                </div>
                <div class="landing-feature-card">
                    <div class="landing-feature-icon purple"><i class="bi bi-journal-code"></i></div>
                    <h3 class="landing-feature-title">480+ Framework Controls</h3>
                    <p class="landing-feature-desc">ISO 27001, ISO 42001, NIST CSF, SOC 2, PCI DSS, HIPAA, GDPR, CIS — all pre-loaded and ready to map.</p>
                </div>
                <div class="landing-feature-card">
                    <div class="landing-feature-icon amber"><i class="bi bi-folder2-open"></i></div>
                    <h3 class="landing-feature-title">Evidence Collection</h3>
                    <p class="landing-feature-desc">Attach screenshots, documents, and logs. Build an audit-ready evidence repository.</p>
                </div>
                <div class="landing-feature-card">
                    <div class="landing-feature-icon red"><i class="bi bi-lightning"></i></div>
                    <h3 class="landing-feature-title">Incident Response</h3>
                    <p class="landing-feature-desc">Log incidents, track investigations, document lessons learned. Practice IR workflows.</p>
                </div>
                <div class="landing-feature-card">
                    <div class="landing-feature-icon cyan"><i class="bi bi-person-badge"></i></div>
                    <h3 class="landing-feature-title">Portfolio Builder</h3>
                    <p class="landing-feature-desc">Export your work, generate reports, and showcase your GRC skills to employers.</p>
                </div>
            </section>

            <section class="landing-stats" id="frameworks">
                <div class="landing-stat">
                    <div class="landing-stat-value">480+</div>
                    <div class="landing-stat-label">Framework Controls</div>
                </div>
                <div class="landing-stat">
                    <div class="landing-stat-value">7</div>
                    <div class="landing-stat-label">Major Frameworks</div>
                </div>
                <div class="landing-stat">
                    <div class="landing-stat-value">20+</div>
                    <div class="landing-stat-label">Practice Modules</div>
                </div>
                <div class="landing-stat">
                    <div class="landing-stat-value">100%</div>
                    <div class="landing-stat-label">Free Forever</div>
                </div>
            </section>
        </div>
    </div>

    <!-- ==================== MAIN APPLICATION ==================== -->
    <div class="app-wrapper" id="app-wrapper">
    <!-- Main Site Header - Full Width -->
    <header style="background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-default); position: fixed; top: 0; left: 0; right: 0; z-index: 1001; height: 64px;">
        <div style="padding: 0 24px; height: 100%;">
            <nav style="display: flex; align-items: center; justify-content: space-between; height: 100%;">
                <a href="#"  style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                    <div style="width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center; overflow:hidden;">
  <img src="logo.png" alt="GRC Practice Lab Logo" style="width:40px;height:40px;object-fit:contain;display:block;">
</div>


                    <span style="font-size: 15px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em;">GRC Practice Lab</span>
                </a>
                <div style="display: flex; gap: 32px; align-items: center;">
                    <a href="index.html" style="color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Home</a>
                    <a href="grc-lab.html" style="color: var(--text-primary); text-decoration: none; font-size: 14px; font-weight: 500; position: relative;">GRC Lab<span style="position: absolute; bottom: -4px; left: 0; right: 0; height: 2px; background: var(--accent-blue);"></span></a>
                    <a href="terms.html" style="color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Terms</a>
                    <a href="https://www.youtube.com/@GRCMadeSimple" target="_blank" style="color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">YouTube</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Spacer for fixed header -->
    <div style="height: 64px;"></div>

    <!-- Educational Disclaimer Banner -->
    <div id="edu-banner" style="background: linear-gradient(90deg, #1e40af, #7c3aed); color: white; padding: 10px 24px; font-size: 12px; display: flex; align-items: center; justify-content: flex-start; gap: 12px; position: relative;; margin-left: 260px; width: calc(100% - 260px); box-sizing: border-box; flex-wrap: wrap; padding-right: 56px;">
        <span style="flex: 1 1 auto; min-width: 260px; text-align: left; line-height: 1.4;"><strong>Educational / Practice Use Only</strong> — This is a learning simulator for portfolio building and skills practice. All control statements are paraphrased for educational purposes. Not for production compliance decisions or formal audits.</span>
        <button onclick="document.getElementById('edu-banner').style.display='none'" style="background: none; border: none; color: white; cursor: pointer; position: absolute; right: 16px; font-size: 18px; opacity: 0.7;; top: 50%; transform: translateY(-50%);">&times;</button>
    </div>
    
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Overview <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item active" data-tab="dashboard"><i class="bi bi-grid-1x2-fill"></i><span>Dashboard</span></div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Learn & Practice <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="start-here" style="background: linear-gradient(90deg, var(--accent-green-soft), transparent);"><i class="bi bi-rocket-takeoff"></i><span>Start Here</span><span class="nav-badge" style="background: var(--accent-green); color: white;">Guide</span></div>
                    <div class="nav-item" data-tab="frameworks"><i class="bi bi-journal-code"></i><span>Frameworks</span><span class="nav-badge" style="background: var(--accent-blue); color: white;">480+</span></div>
                    <div class="nav-item" data-tab="glossary"><i class="bi bi-book"></i><span>GRC Glossary</span></div>
                    <div class="nav-item" data-tab="scenarios"><i class="bi bi-play-circle"></i><span>Practice Scenarios</span></div>
                    <div class="nav-item" data-tab="missions"><i class="bi bi-flag-fill"></i><span>Guided Missions</span><span class="nav-badge" style="background: var(--accent-purple); color: white;">Lab</span></div>
                    <div class="nav-item" data-tab="interview-prep"><i class="bi bi-person-video3"></i><span>Interview Prep</span><span class="nav-badge" style="background: var(--accent-purple); color: white;">Lab</span></div>
                    <div class="nav-item" data-tab="projects"><i class="bi bi-briefcase"></i><span>Projects</span><span class="nav-badge" id="badge-projects">0</span></div>
                    <div class="nav-item" data-tab="portfolio"><i class="bi bi-person-badge"></i><span>Portfolio Builder</span></div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Inventory & Policies <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="assets"><i class="bi bi-hdd-stack"></i><span>Assets</span><span class="nav-badge" id="badge-assets">0</span></div>
                    <div class="nav-item" data-tab="vendors"><i class="bi bi-building"></i><span>Vendors</span><span class="nav-badge" id="badge-vendors">0</span></div>
                    <div class="nav-item" data-tab="vendor-risk"><i class="bi bi-clipboard2-pulse"></i><span>Vendor Risk Assessment</span></div>
                    <div class="nav-item" data-tab="policies"><i class="bi bi-file-earmark-text"></i><span>Policies</span><span class="nav-badge" id="badge-policies">0</span></div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Risk & Controls <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="risk-appetite"><i class="bi bi-speedometer2"></i><span>Risk Appetite</span></div>
                    <div class="nav-item" data-tab="risks"><i class="bi bi-exclamation-triangle"></i><span>Risk Register</span><span class="nav-badge" id="badge-risks">0</span></div>
                    <div class="nav-item" data-tab="kri"><i class="bi bi-graph-up-arrow"></i><span>Key Risk Indicators</span></div>
                    <div class="nav-item" data-tab="controls"><i class="bi bi-shield-lock"></i><span>Controls</span><span class="nav-badge" id="badge-controls">0</span></div>
                    <div class="nav-item" data-tab="treatments"><i class="bi bi-bandaid"></i><span>Treatments</span><span class="nav-badge" id="badge-treatments">0</span></div>
                    <div class="nav-item" data-tab="matrix"><i class="bi bi-grid-3x3"></i><span>Risk Matrix</span></div>
                    <div class="nav-item" data-tab="crosswalk"><i class="bi bi-intersect"></i><span>Control Crosswalk</span></div>
                    <div class="nav-item" data-tab="control-lifecycle"><i class="bi bi-arrow-repeat"></i><span>Control Lifecycle</span></div>
                    <div class="nav-item" data-tab="cloud-risks"><i class="bi bi-cloud-haze2"></i><span>Cloud Risk Scenarios</span></div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Audit & Compliance <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="audits"><i class="bi bi-clipboard-check"></i><span>Audits</span><span class="nav-badge" id="badge-audits">0</span></div>
                    <div class="nav-item" data-tab="evidence"><i class="bi bi-folder2-open"></i><span>Evidence</span><span class="nav-badge" id="badge-evidence">0</span></div>
                    <div class="nav-item" data-tab="evidence-scoring"><i class="bi bi-star-half"></i><span>Evidence Scoring</span></div>
                    <div class="nav-item" data-tab="testing"><i class="bi bi-card-checklist"></i><span>Control Testing</span><span class="nav-badge" id="badge-testing">0</span></div>
                    <div class="nav-item" data-tab="findings"><i class="bi bi-search"></i><span>Findings</span><span class="nav-badge" id="badge-findings">0</span></div>
                    <div class="nav-item" data-tab="soa"><i class="bi bi-file-earmark-check"></i><span>Statement of Applicability</span></div>
                    <div class="nav-item" data-tab="itgc"><i class="bi bi-bank2"></i><span>IT General Controls</span></div>
                    <div class="nav-item" data-tab="sox"><i class="bi bi-briefcase-fill"></i><span>SOX Compliance</span></div>
                    <div class="nav-item" data-tab="audit-sim"><i class="bi bi-clipboard2-data"></i><span>Audit Simulator</span><span class="nav-badge" style="background: var(--accent-purple); color: white;">Lab</span></div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Resilience & Continuity <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="bia"><i class="bi bi-heart-pulse"></i><span>Business Impact Analysis</span></div>
                    <div class="nav-item" data-tab="bcm"><i class="bi bi-shield-fill-plus"></i><span>BCM / DR Plans</span></div>
                    <div class="nav-item" data-tab="incidents"><i class="bi bi-lightning"></i><span>Incidents</span><span class="nav-badge" id="badge-incidents">0</span></div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Governance & Ops <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="requirements"><i class="bi bi-list-check"></i><span>Requirements</span><span class="nav-badge" id="badge-requirements">0</span></div>
                    <div class="nav-item" data-tab="exceptions"><i class="bi bi-shield-exclamation"></i><span>Exceptions</span><span class="nav-badge" id="badge-exceptions">0</span></div>
                    <div class="nav-item" data-tab="issues"><i class="bi bi-bug"></i><span>Issues</span><span class="nav-badge" id="badge-issues">0</span></div>
                    <div class="nav-item" data-tab="tasks"><i class="bi bi-check2-square"></i><span>Tasks</span><span class="nav-badge" id="badge-tasks">0</span></div>
                    <div class="nav-item" data-tab="reviews"><i class="bi bi-calendar2-check"></i><span>Due & Activity</span></div>
                    <div class="nav-item" data-tab="compliance-calendar"><i class="bi bi-calendar3-range"></i><span>Compliance Calendar</span></div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title" onclick="app.toggleSection(this)">Reporting <i class="bi bi-chevron-down section-chevron"></i></div>
                    <div class="nav-item" data-tab="traceability"><i class="bi bi-diagram-3"></i><span>Traceability</span></div>
                    <div class="nav-item" data-tab="reports"><i class="bi bi-file-earmark-bar-graph"></i><span>Reports</span></div>
                    <div class="nav-item" data-tab="roadmap"><i class="bi bi-kanban"></i><span>Community Roadmap</span></div>
                </div>
            </nav>
            <!-- Project Mode Indicator (shown when in project mode) -->
            <div id="sidebar-project-mode" style="display: none; padding: 12px 16px; background: linear-gradient(135deg, var(--accent-purple-soft), var(--accent-blue-soft)); border-top: 1px solid var(--accent-purple); border-bottom: 1px solid var(--accent-purple);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="bi bi-briefcase-fill" style="color: var(--accent-purple);"></i>
                    <span style="font-size: 11px; font-weight: 600; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 0.05em;">Project Mode</span>
                </div>
                <div id="sidebar-project-name" style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;"></div>
                <button class="btn btn-secondary btn-sm" style="width: 100%; background: white;" onclick="app.exitProjectMode()">
                    <i class="bi bi-box-arrow-left"></i> Exit Project
                </button>
            </div>
            <div style="padding: 16px; border-top: 1px solid var(--border-default);">
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="app.loadDemo()">
                    <i class="bi bi-lightning-fill"></i> Load Demo Data
                </button>
                <div style="display: flex; gap: 6px;">
                    <button class="btn btn-secondary btn-sm" style="flex: 1;" onclick="app.exportAllData()" title="Export all data as JSON"><i class="bi bi-download"></i> Export</button>
                    <button class="btn btn-secondary btn-sm" style="flex: 1;" onclick="app.importAllData()" title="Import data from JSON"><i class="bi bi-upload"></i> Import</button>
                </div>
            </div>
        </aside>

        <!-- Coach FAB Button -->
        <button class="coach-fab" onclick="app.toggleCoach()" title="GRC Coach"><i class="bi bi-mortarboard-fill"></i><div class="coach-pulse"></div></button>

        <!-- Coach Panel -->
        <div class="coach-panel" id="coach-panel">
            <div class="coach-panel-header">
                <div><i class="bi bi-mortarboard-fill" style="margin-right: 8px;"></i><strong>GRC Coach</strong></div>
                <button style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; opacity: 0.8;" onclick="app.toggleCoach()">&times;</button>
            </div>
            <div class="coach-panel-body" id="coach-body"></div>
        </div>

        <main class="main-content">
            <header class="content-header">
                <button class="btn btn-ghost mobile-toggle" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                <div class="content-title" id="page-title"><i class="bi bi-grid-1x2-fill"></i> Dashboard</div>
                <div class="header-actions">
                    
                    <div id="learning-controls" class="learning-controls" style="display:flex; align-items:center; gap:10px; margin-right:10px; flex-wrap:wrap;">
                        <div id="learning-progress-pill" class="badge badge-gray" style="display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 999px;">
                            <i class="bi bi-mortarboard-fill" style="color: var(--accent-purple);"></i>
                            <span id="learning-progress-text" style="font-weight:600; font-size:12px;">Learning: 0/9</span>
                        </div>
                        <div class="badge badge-blue" style="display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;">
                            <i class="bi bi-toggle2-off" id="learning-mode-icon"></i>
                            <span style="font-weight:600; font-size:12px;">Career Mode</span>
                            <label class="switch" style="margin:0;">
                                <input type="checkbox" id="learning-mode-toggle" />
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <button class="btn btn-secondary btn-sm" id="learning-continue-btn" style="display:none;" onclick="app.continueLearning()"><i class="bi bi-arrow-right-circle"></i> Continue</button>
                        <button class="btn btn-secondary btn-sm" id="learning-cert-btn" style="display:none;" onclick="app.generateLearningCertificate()"><i class="bi bi-award"></i> Certificate</button>
                    </div>
<button class="btn btn-secondary btn-sm" onclick="app.exportData()"><i class="bi bi-download"></i> Export</button>
                    <div class="mode-toggle-bar">
                        <div class="mode-pill" id="beginner-pill" onclick="app.toggleBeginnerMode()" title="Simplify interface for beginners"><i class="bi bi-mortarboard"></i> Beginner</div>
                        <div class="mode-pill" id="dev-pill" onclick="app.toggleDevMode()" title="Show JSON data models"><i class="bi bi-code-slash"></i> Dev</div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="app.clearAllData()"><i class="bi bi-trash3"></i> Clear</button>
                </div>
            </header>
            <!-- Developer Mode Panel -->
            <div class="dev-panel" id="dev-panel">
                <div class="dev-panel-header">
                    <span><i class="bi bi-terminal"></i> Developer Mode — Live Data Model</span>
                    <span style="font-weight: 400; color: #64748b;">Tab: <span id="dev-current-tab">dashboard</span> | Records: <span id="dev-record-count">0</span></span>
                </div>
                <pre id="dev-json-output" style="color: #e2e8f0;"></pre>
            </div>
            <div class="content-body">
                <div class="tab-content active" id="tab-dashboard"></div>
                <div class="tab-content" id="tab-start-here"></div>
                <div class="tab-content" id="tab-glossary"></div>
                <div class="tab-content" id="tab-scenarios"></div>
                <div class="tab-content" id="tab-assets"></div>
                <div class="tab-content" id="tab-vendors"></div>
                <div class="tab-content" id="tab-policies"></div>
                <div class="tab-content" id="tab-risks"></div>
                <div class="tab-content" id="tab-controls"></div>
                <div class="tab-content" id="tab-treatments"></div>
                <div class="tab-content" id="tab-matrix"></div>
                <div class="tab-content" id="tab-issues"></div>
                <div class="tab-content" id="tab-incidents"></div>
                <div class="tab-content" id="tab-tasks"></div>
                <div class="tab-content" id="tab-audits"></div>
                <div class="tab-content" id="tab-evidence"></div>
                <div class="tab-content" id="tab-testing"></div>
                <div class="tab-content" id="tab-findings"></div>
                <div class="tab-content" id="tab-requirements"></div>
                <div class="tab-content" id="tab-exceptions"></div>
                <div class="tab-content" id="tab-reviews"></div>
                <div class="tab-content" id="tab-soa"></div>
                <div class="tab-content" id="tab-itgc"></div>
                <div class="tab-content" id="tab-sox"></div>
                <div class="tab-content" id="tab-evidence-scoring"></div>
                <div class="tab-content" id="tab-crosswalk"></div>
                <div class="tab-content" id="tab-control-lifecycle"></div>
                <div class="tab-content" id="tab-cloud-risks"></div>
                <div class="tab-content" id="tab-risk-appetite"></div>
                <div class="tab-content" id="tab-kri"></div>
                <div class="tab-content" id="tab-bia"></div>
                <div class="tab-content" id="tab-bcm"></div>
                <div class="tab-content" id="tab-vendor-risk"></div>
                <div class="tab-content" id="tab-compliance-calendar"></div>
                <div class="tab-content" id="tab-traceability"></div>
                <div class="tab-content" id="tab-reports"></div>
                <div class="tab-content" id="tab-audit-sim"></div>
                <div class="tab-content" id="tab-missions"></div>
                <div class="tab-content" id="tab-interview-prep"></div>
                <div class="tab-content" id="tab-roadmap"></div>
                <div class="tab-content" id="tab-frameworks"></div>
                <div class="tab-content" id="tab-projects"></div>
                <div class="tab-content" id="tab-portfolio"></div>
            </div>
        </main>
    </div>
    <div class="toast-container" id="toast-container"></div>
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Modal</h3>
                <button class="modal-close" onclick="closeModal()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>
<script>
class GRCLabPro {
    constructor() {
        this.currentTab = 'dashboard';
        this.activeProject = null;
        this.traceabilityView = 'overview';
        this.selectedFlowNode = null;
        this.data = { assets: [], vendors: [], policies: [], risks: [], controls: [], treatments: [], issues: [], incidents: [], tasks: [], audits: [], evidence: [], controlTests: [], findings: [], soaEntries: [], requirements: [], exceptions: [], activityLog: [], itgcControls: [], evidenceScores: [], controlLifecycle: [], cloudRiskScenarios: [], biaEntries: [], vendorAssessments: [], soxEntries: [], riskAppetiteStatements: [], kriEntries: [], bcmPlans: [], crosswalkMappings: [] };
        this.projectData = {};
        this.init();
    }
    init() {
        // App-first: landing disabled
        try { this.hideLanding(); } catch(e) {}
        this.loadAllData();
        this.loadProjectData();
        this.bindEvents();
        this.renderCurrentTab();
        this.updateAllBadges();
            this.initLearningMode();
            this.initModes();
    }
    
    // ===== LANDING PAGE METHODS =====
    showLanding() {
        // Landing disabled
        this.hideLanding();
    }
    hideLanding() {
        document.getElementById('landing-page').style.display = 'none';
        document.getElementById('app-wrapper').classList.add('active');
    }
    startLab() {
        this.hideLanding();
        this.switchTab('start-here');
    }
    startLabWithDemo() {
        this.hideLanding();
        this.loadDemo();
        this.switchTab('dashboard');
        this.trackPageView('dashboard');
    }
    
    loadAllData() {
        Object.keys(this.data).forEach(key => {
            const stored = localStorage.getItem(`grc_${key}`);
            if (!stored) return;
            try {
                const parsed = JSON.parse(stored);
                this.data[key] = Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                this.data[key] = [];
            }
        });
    }
    loadProjectData() { 
        const stored = localStorage.getItem('grc_projectData'); 
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                if (parsed && typeof parsed === 'object') {
                    this.projectData = {};
                    Object.keys(parsed).forEach(projectId => {
                        this.projectData[projectId] = this.normalizeDataStore(parsed[projectId]);
                    });
                } else {
                    this.projectData = {};
                }
            } catch(e) {
                this.projectData = {};
            }
        }
    }
    saveProjectData() {
        localStorage.setItem('grc_projectData', JSON.stringify(this.projectData));
    }
    saveData(key) { 
        if (this.activeProject) {
            // Save to project-specific storage
            if (!this.projectData[this.activeProject]) this.initProjectData(this.activeProject);
            this.projectData[this.activeProject][key] = this.getActiveData()[key];
            this.saveProjectData();
        } else {
            localStorage.setItem(`grc_${key}`, JSON.stringify(this.data[key])); 
        }
        this.updateAllBadges(); 
    }
    createEmptyDataStore() {
        return Object.keys(this.data).reduce((acc, key) => {
            acc[key] = [];
            return acc;
        }, {});
    }
    normalizeDataStore(store) {
        const normalized = this.createEmptyDataStore();
        if (!store || typeof store !== 'object') return normalized;
        Object.keys(normalized).forEach(key => {
            if (Array.isArray(store[key])) normalized[key] = store[key];
        });
        return normalized;
    }
    initProjectData(projectId) {
        if (!this.projectData[projectId]) {
            this.projectData[projectId] = this.createEmptyDataStore();
            this.saveProjectData();
        }
    }
    getActiveData() {
        if (this.activeProject) {
            if (!this.projectData[this.activeProject]) this.initProjectData(this.activeProject);
            this.projectData[this.activeProject] = this.normalizeDataStore(this.projectData[this.activeProject]);
            return this.projectData[this.activeProject];
        }
        return this.data;
    }
    getProjectData(projectId) {
        if (!this.projectData[projectId]) this.initProjectData(projectId);
        this.projectData[projectId] = this.normalizeDataStore(this.projectData[projectId]);
        return this.projectData[projectId];
    }
    enterProjectMode(projectId) {
        this.activeProject = projectId;
        if (!this.projectData[projectId]) this.initProjectData(projectId);
        this.renderCurrentTab();
        this.updateAllBadges();
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        this.toast(`Entered project mode: ${project?.company || projectId}`, 'success');
    }
    exitProjectMode() {
        this.activeProject = null;
        this.switchTab('projects');
        this.updateAllBadges();
        this.toast('Exited project mode - back to general workspace', 'info');
    }
    generateId(prefix) { return `${prefix}-${Date.now().toString(36)}`; }
    esc(str) { return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    escapeHtml(str) { return this.esc(str); }
    // ===== Analytics Helpers (GA4) =====
    trackEvent(name, params = {}) {
        try {
            if (typeof window.gtag === 'function') window.gtag('event', name, params);
        } catch(e) {}
    }
    trackPageView(tab) {
        // Track SPA navigation as page_view + a custom tab_view event
        try {
            if (typeof window.gtag === 'function') {
                const page_path = `/grc-lab/${String(tab || '').replace(/[^a-z0-9\-]/gi,'')}`;
                window.gtag('event', 'page_view', {
                    page_title: `GRC Lab — ${tab}`,
                    page_path,
                    page_location: window.location.origin + window.location.pathname + '#' + tab
                });
                this.trackEvent('tab_view', { tab });
            }
        } catch(e) {}
    }

    bindEvents() { document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => this.switchTab(item.dataset.tab))); this.coachOpen = false; }
    toggleSection(el) { el.parentElement.classList.toggle('collapsed'); }
    toggleCoach() { this.coachOpen = !this.coachOpen; document.getElementById('coach-panel').classList.toggle('open', this.coachOpen); if (this.coachOpen) this.renderCoach(); }
    
    // ==================== BEGINNER MODE ====================
    toggleBeginnerMode() {
        this.beginnerMode = !this.beginnerMode;
        document.body.classList.toggle('beginner-mode', this.beginnerMode);
        document.getElementById('beginner-pill').classList.toggle('active', this.beginnerMode);
        localStorage.setItem('grc_beginnerMode', this.beginnerMode);
        this.toast(this.beginnerMode ? 'Beginner Mode ON — advanced fields hidden, tooltips shown' : 'Beginner Mode OFF — all fields visible', 'success');
        this.renderCurrentTab();
    }
    initModes() {
        if (localStorage.getItem('grc_beginnerMode') === 'true') { this.beginnerMode = true; document.body.classList.add('beginner-mode'); document.getElementById('beginner-pill')?.classList.add('active'); }
        if (localStorage.getItem('grc_devMode') === 'true') { this.devMode = true; document.body.classList.add('dev-mode'); document.getElementById('dev-pill')?.classList.add('active'); this.updateDevPanel(); }
    }
    
    // ==================== DEVELOPER MODE ====================
    toggleDevMode() {
        this.devMode = !this.devMode;
        document.body.classList.toggle('dev-mode', this.devMode);
        document.getElementById('dev-pill').classList.toggle('active', this.devMode);
        localStorage.setItem('grc_devMode', this.devMode);
        if (this.devMode) this.updateDevPanel();
        this.toast(this.devMode ? 'Developer Mode ON — JSON data panel visible' : 'Developer Mode OFF', 'success');
    }
    updateDevPanel() {
        if (!this.devMode) return;
        const tab = this.currentTab || 'dashboard';
        const d = this.getActiveData();
        const dataMap = { 'risks': d.risks, 'controls': d.controls, 'assets': d.assets, 'vendors': d.vendors, 'policies': d.policies, 'evidence': d.evidence, 'findings': d.findings, 'testing': d.controlTests, 'issues': d.issues, 'incidents': d.incidents, 'tasks': d.tasks, 'audits': d.audits, 'treatments': d.treatments, 'requirements': d.requirements, 'exceptions': d.exceptions, 'itgc': d.itgcControls, 'sox': d.soxEntries, 'risk-appetite': d.riskAppetiteStatements, 'kri': d.kriEntries, 'bia': d.biaEntries, 'bcm': d.bcmPlans, 'crosswalk': d.crosswalkMappings, 'vendor-risk': d.vendorAssessments, 'evidence-scoring': d.evidenceScores, 'control-lifecycle': d.controlLifecycle, 'cloud-risks': d.cloudRiskScenarios };
        const records = dataMap[tab] || [];
        document.getElementById('dev-current-tab').textContent = tab;
        document.getElementById('dev-record-count').textContent = Array.isArray(records) ? records.length : 0;
        const sample = Array.isArray(records) ? records.slice(0, 3) : records;
        let json = '';
        try { json = JSON.stringify(sample, null, 2); } catch(e) { json = '// No data for this tab'; }
        document.getElementById('dev-json-output').textContent = `// Data model for: ${tab}\n// Showing first 3 records of ${Array.isArray(records) ? records.length : 0} total\n// Full export: Use sidebar Export button\n\n${json}`;
    }
    switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.tab === tab));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-${tab}`));
        // Auto-expand sidebar section containing active tab
        const activeItem = document.querySelector(`.nav-item[data-tab="${tab}"]`);
        if (activeItem) { const section = activeItem.closest('.nav-section'); if (section && section.classList.contains('collapsed')) section.classList.remove('collapsed'); }
        const titles = { dashboard:'Dashboard', 'start-here':'Start Here', assets:'Asset Inventory', vendors:'Vendor Management', policies:'Policy Library', risks:'Risk Register', controls:'Control Catalog', treatments:'Risk Treatments', matrix:'Risk Matrix', issues:'Issue Tracker', incidents:'Incident Log', tasks:'Task Management', audits:'Audit Schedule', evidence:'Evidence Library', testing:'Control Testing', findings:'Audit Findings', soa:'Statement of Applicability', traceability:'Traceability Matrix', reports:'Reports & Analytics', frameworks:'Framework Library', projects:'GRC Projects', portfolio:'Portfolio Builder', requirements:'Compliance Requirements', exceptions:'Exceptions', reviews:'Due & Activity', 'itgc':'IT General Controls', 'sox':'SOX Compliance', 'evidence-scoring':'Evidence Scoring', 'control-lifecycle':'Control Lifecycle', 'cloud-risks':'Cloud Risk Scenarios', 'risk-appetite':'Risk Appetite Statement', 'kri':'Key Risk Indicators', 'bia':'Business Impact Analysis', 'bcm':'BCM / DR Plans', 'crosswalk':'Control Crosswalk', 'vendor-risk':'Vendor Risk Assessment', 'compliance-calendar':'Compliance Calendar', 'audit-sim':'Audit Simulator', 'missions':'Guided Missions', 'interview-prep':'Interview Prep', 'roadmap':'Community Roadmap' };
        const icons = { dashboard:'bi-grid-1x2-fill', 'start-here':'bi-rocket-takeoff', assets:'bi-hdd-stack', vendors:'bi-building', policies:'bi-file-earmark-text', risks:'bi-exclamation-triangle', controls:'bi-shield-lock', treatments:'bi-bandaid', matrix:'bi-grid-3x3', issues:'bi-bug', incidents:'bi-lightning', tasks:'bi-check2-square', audits:'bi-clipboard-check', evidence:'bi-folder2-open', testing:'bi-card-checklist', findings:'bi-search', soa:'bi-file-earmark-check', traceability:'bi-diagram-3', reports:'bi-file-earmark-bar-graph', frameworks:'bi-journal-code', projects:'bi-briefcase', portfolio:'bi-person-badge', requirements:'bi-list-check', exceptions:'bi-shield-exclamation', reviews:'bi-calendar2-check', 'itgc':'bi-bank2', 'sox':'bi-briefcase-fill', 'evidence-scoring':'bi-star-half', 'control-lifecycle':'bi-arrow-repeat', 'cloud-risks':'bi-cloud-haze2', 'risk-appetite':'bi-speedometer2', 'kri':'bi-graph-up-arrow', 'bia':'bi-heart-pulse', 'bcm':'bi-shield-fill-plus', 'crosswalk':'bi-intersect', 'vendor-risk':'bi-clipboard2-pulse', 'compliance-calendar':'bi-calendar3-range', 'audit-sim':'bi-clipboard2-data', 'missions':'bi-flag-fill', 'interview-prep':'bi-person-video3', 'roadmap':'bi-kanban' };
        
        let titleHtml = `<i class="bi ${icons[tab] || 'bi-circle'}"></i> ${titles[tab] || tab}`;
        if (this.activeProject) {
            const project = this.getProjectScenarios().find(p => p.id === this.activeProject);
            titleHtml += ` <span class="badge badge-purple" style="font-size: 11px; margin-left: 12px;"><i class="bi bi-briefcase-fill"></i> ${project?.company || 'Project'}</span>`;
        }
        document.getElementById('page-title').innerHTML = titleHtml;
        this.currentTab = tab;
        this.trackPageView(tab);
        this.renderCurrentTab();
        this.updateProjectModeIndicator();
        if (this.coachOpen) this.renderCoach();
        if (this.devMode) this.updateDevPanel();
    }
    updateProjectModeIndicator() {
        let indicator = document.getElementById('project-mode-indicator');
        const sidebarIndicator = document.getElementById('sidebar-project-mode');
        const sidebarProjectName = document.getElementById('sidebar-project-name');
        
        if (this.activeProject) {
            const project = this.getProjectScenarios().find(p => p.id === this.activeProject);
            
            // Update sidebar indicator
            if (sidebarIndicator) {
                sidebarIndicator.style.display = 'block';
                if (sidebarProjectName) {
                    sidebarProjectName.textContent = project?.company || 'Unknown Project';
                }
            }
            
            // Update top bar indicator
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'project-mode-indicator';
                indicator.style.cssText = 'position: fixed; top: 85px; left: 260px; right: 0; background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue)); color: white; padding: 10px 20px; font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; z-index: 999; box-shadow: var(--shadow-md);';
                document.body.appendChild(indicator);
            }
            indicator.innerHTML = `
                <div><i class="bi bi-briefcase-fill"></i> Project Mode: <strong>${project?.company || 'Unknown'}</strong> — ${project?.scenario || ''}</div>
                <button onclick="app.exitProjectMode()" style="background: rgba(255,255,255,0.25); border: none; color: white; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'"><i class="bi bi-box-arrow-left"></i> Exit Project</button>
            `;
            indicator.style.display = 'flex';
            document.querySelector('.main-content').style.paddingTop = '52px';
        } else {
            // Hide both indicators
            if (sidebarIndicator) sidebarIndicator.style.display = 'none';
            if (indicator) indicator.style.display = 'none';
            document.querySelector('.main-content').style.paddingTop = '0';
        }
    }
    renderCurrentTab() {
        const r = { dashboard: () => this.renderDashboard(), 'start-here': () => this.renderStartHere(), glossary: () => this.renderGlossary(), scenarios: () => this.renderScenarios(), assets: () => this.renderAssets(), vendors: () => this.renderVendors(), policies: () => this.renderPolicies(), risks: () => this.renderRisks(), controls: () => this.renderControls(), treatments: () => this.renderTreatments(), matrix: () => this.renderMatrix(), issues: () => this.renderIssues(), incidents: () => this.renderIncidents(), tasks: () => this.renderTasks(), audits: () => this.renderAudits(), evidence: () => this.renderEvidence(), testing: () => this.renderTesting(), findings: () => this.renderFindings(), soa: () => this.renderSoA(), traceability: () => this.renderTraceability(), reports: () => this.renderReports(), frameworks: () => this.renderFrameworks(), projects: () => this.renderProjects(), portfolio: () => this.renderPortfolio(), requirements: () => this.renderRequirements(), exceptions: () => this.renderExceptions(), reviews: () => this.renderReviews(), 'itgc': () => this.renderItgc(), 'sox': () => this.renderSox(), 'evidence-scoring': () => this.renderEvidenceScoring(), 'control-lifecycle': () => this.renderControlLifecycle(), 'cloud-risks': () => this.renderCloudRisks(), 'risk-appetite': () => this.renderRiskAppetite(), 'kri': () => this.renderKRI(), 'bia': () => this.renderBIA(), 'bcm': () => this.renderBCM(), 'crosswalk': () => this.renderCrosswalk(), 'vendor-risk': () => this.renderVendorRisk(), 'compliance-calendar': () => this.renderComplianceCalendar(), 'audit-sim': () => this.renderAuditSim(), 'missions': () => this.renderMissions(), 'interview-prep': () => this.renderInterviewPrep(), 'roadmap': () => this.renderRoadmap() };
        if (r[this.currentTab]) r[this.currentTab]();
        this.updateProjectModeIndicator();
    }
    updateAllBadges() {
        const d = this.getActiveData();
        const b = { assets: d.assets.length, vendors: d.vendors.length, policies: d.policies.length, risks: d.risks.length, controls: d.controls.length, treatments: d.treatments.length, issues: d.issues.length, incidents: d.incidents.length, tasks: d.tasks.length, audits: d.audits.length, evidence: d.evidence.length, testing: d.controlTests.length, findings: d.findings.length, requirements: (d.requirements||[]).length, exceptions: (d.exceptions||[]).length };
        Object.entries(b).forEach(([k, v]) => { const el = document.getElementById(`badge-${k}`); if (el) el.textContent = v; });
    }

    // ==================== GRC COACH SYSTEM ====================
    getCoachData() {
        return {
            'dashboard': { title: 'Your GRC Command Center', why: 'This is where a GRC Manager starts every morning. You scan for red flags: overdue items, breached KRIs, untested controls, and unresolved findings.', steps: ['Review critical/high risks in the heatmap', 'Check for overdue tasks and findings', 'Look at the Health Advisor for program gaps', 'Drill into any module from the Extended Coverage grid'], mistakes: ['Ignoring the dashboard and jumping straight to individual tabs', 'Treating risk scores as static — they should change as controls mature'], next: { text: 'Define your Risk Appetite first →', tab: 'risk-appetite' } },
            'risk-appetite': { title: 'Where Every GRC Program Starts', why: 'Before you can assess ANY risk, you need to know how much risk the organization accepts. Risk appetite is set by the Board and flows down to every risk decision. Without this, your risk register is meaningless.', steps: ['Click "Load Sample Statements" to see realistic examples', 'Customize appetite levels for each risk category', 'Set tolerance thresholds (the numeric boundary)', 'Mark statements as Board Approved'], mistakes: ['Skipping this step — it is the foundation', 'Setting all categories to "Averse" — no business can operate with zero risk', 'Confusing appetite (willingness) with tolerance (measurable limit)'], next: { text: 'Now build your Asset Inventory →', tab: 'assets' } },
            'assets': { title: 'Know What You Are Protecting', why: 'You cannot protect what you do not know exists. Asset inventory is the foundation of scoping — which systems are in scope for compliance, which hold sensitive data, which are critical to business operations.', steps: ['Add your most critical systems first (databases, payment systems, identity providers)', 'Classify each asset by criticality: Critical, High, Medium, Low', 'Assign ownership — every asset needs an owner accountable for its security', 'Note the environment: Production, Staging, Dev'], mistakes: ['Listing hardware only — include data stores, SaaS platforms, APIs', 'Not assigning owners — orphaned assets are the #1 audit finding', 'Skipping classification — auditors will ask "how did you determine scope?"'], next: { text: 'Now identify risks to these assets →', tab: 'risks' } },
            'risks': { title: 'Identify What Can Go Wrong', why: 'A risk register is the heart of GRC. Every control, treatment, evidence, and audit links back to a risk. A GRC analyst spends most of their day here.', steps: ['Write risk in this format: "[Threat] exploits [Vulnerability] causing [Impact] to [Asset]"', 'Score likelihood (1-5) and impact (1-5) — the product is your risk score', 'Compare the risk score to your Risk Appetite tolerance threshold', 'Assign a risk owner who is accountable for treatment'], mistakes: ['Writing vague risks like "cybersecurity risk" — be specific about the threat and impact', 'Scoring all risks as 5x5 — differentiation matters', 'Not linking risks to assets — auditors need the connection', 'Setting everything to "Mitigate" — sometimes Accept, Transfer, or Avoid is the right strategy'], next: { text: 'Now add controls to mitigate risks →', tab: 'controls' } },
            'controls': { title: 'Define How You Mitigate Risk', why: 'Controls are the safeguards that reduce risk to acceptable levels. Every risk needs at least one control. Controls must be testable, measurable, and owned.', steps: ['Link each control to the risk it mitigates', 'Map to a framework requirement (ISO 27001, NIST, SOC 2)', 'Set the effectiveness status — be honest, not aspirational', 'Define the testing frequency (how often you verify it works)'], mistakes: ['Creating controls with no link to a risk — controls exist to reduce risk', 'Writing aspirational controls ("we will implement MFA") — document what IS implemented', 'Not setting test frequency — an untested control provides zero assurance'], next: { text: 'Now collect evidence that controls work →', tab: 'evidence' } },
            'evidence': { title: 'Prove Your Controls Work', why: 'An auditor does not care what you SAY your controls do. They care what you can PROVE. Evidence is the documentation that demonstrates control effectiveness.', steps: ['Upload or document evidence for each control', 'Link evidence to the control it supports', 'Include screenshots, logs, policy documents, config exports', 'Record the collection date — evidence has a shelf life'], mistakes: ['Screenshots without dates or context — annotate what the auditor should see', 'Single evidence for multiple controls — each control needs its own proof', 'Outdated evidence — a screenshot from 6 months ago may not prove current state'], next: { text: 'Now test your controls →', tab: 'testing' } },
            'testing': { title: 'Verify Controls Actually Work', why: 'Control testing is where GRC meets reality. You are asking: does this control actually do what it claims to do? This is what auditors replicate during an audit.', steps: ['Select the control to test and define the sample size', 'Document the test procedure (what you checked)', 'Record the result: Effective, Partially Effective, Ineffective, or N/A', 'If ineffective, document the finding and required remediation'], mistakes: ['Testing without a defined procedure — how would someone replicate your test?', 'Testing everything annually — high-risk controls need quarterly or continuous testing', 'Not creating findings for failed tests — that defeats the purpose'], next: { text: 'Document any findings from testing →', tab: 'findings' } },
            'findings': { title: 'Document What Failed', why: 'A finding is a gap between what a control should do and what it actually does. Findings drive remediation — they are how your GRC program improves over time.', steps: ['Link each finding to the control test that discovered it', 'Rate severity: Critical, High, Medium, Low', 'Assign a remediation owner and due date', 'Track status: Open → In Progress → Remediated → Validated'], mistakes: ['Writing findings without clear remediation steps', 'Not tracking remediation to closure — open findings age poorly', 'Overdue findings with no escalation — this is a red flag for auditors'], next: { text: 'Review your full traceability →', tab: 'traceability' } },
            'traceability': { title: 'See the Full Chain', why: 'This is the single most important view in GRC. It shows how every risk links to controls, evidence, tests, and findings. Gaps in this chain are audit failures.', steps: ['Review each risk row — does it have linked controls?', 'Does each control have evidence and test results?', 'Look for gaps: risks with no controls, controls with no evidence', 'Use this view to prepare for audits and management reviews'], mistakes: ['Ignoring gaps — every broken link is a finding waiting to happen', 'Not using this view before audit prep — it shows exactly what is missing'], next: null },
            'kri': { title: 'Monitor Risk in Real Time', why: 'KRIs are your early warning system. They detect risk trends before they become incidents. This is what a GRC analyst checks every day.', steps: ['Define KRIs that link to your Risk Appetite categories', 'Set RAG thresholds: Green (within appetite), Amber (approaching), Red (breached)', 'Classify as Leading (predictive) or Lagging (reactive)', 'Update values regularly and track trends'], mistakes: ['All lagging indicators — you need leading indicators to predict, not just react', 'Thresholds not tied to appetite — KRI red should equal appetite breach', 'Not updating values — stale KRIs provide false assurance'], next: { text: 'Check your Risk Appetite alignment →', tab: 'risk-appetite' } },
            'sox': { title: 'SOX Section 302/404 Compliance', why: 'SOX applies to publicly traded companies. Understanding COSO and ICFR is essential for anyone working in financial services GRC. Even private companies adopt these frameworks.', steps: ['Load the SOX templates to see the COSO components', 'Understand the 5 COSO components and how they interact', 'Classify controls as Preventive, Detective, or Corrective', 'Map controls to financial assertions (Completeness, Existence, Valuation)'], mistakes: ['Treating SOX as an IT-only exercise — SOX is fundamentally about financial reporting', 'Not understanding material weakness vs significant deficiency', 'Skipping walkthrough documentation — auditors need this'], next: { text: 'Review IT General Controls that support SOX →', tab: 'itgc' } },
            'itgc': { title: 'IT General Controls', why: 'ITGCs are the foundation under application controls. If your ITGC environment is weak, auditors cannot rely on ANY automated controls. ITGCs are tested in every SOX and SOC 2 audit.', steps: ['Load the 16 ITGC templates across 4 domains', 'Understand each domain: Access, Change Management, Operations, SDLC', 'Test each control and record results', 'Failed ITGC tests have cascading impact on all dependent controls'], mistakes: ['Testing ITGCs in isolation — failed access management affects everything', 'Not documenting compensating controls when an ITGC fails'], next: { text: 'Map controls across frameworks with Crosswalk →', tab: 'crosswalk' } },
            'crosswalk': { title: 'The #1 Skill Employers Want', why: 'Control crosswalking maps one control to multiple framework requirements. This is how organizations reduce audit fatigue by 30-50%. Employers specifically hire for this skill.', steps: ['Select a control from your catalog', 'Check all frameworks it satisfies', 'Add reference IDs (e.g., ISO A.8.5, NIST PR.AC-7, SOC 2 CC6.1)', 'Document the rationale — why does this one control satisfy multiple requirements?'], mistakes: ['Forcing mappings that do not fit — a control should genuinely address each requirement', 'Not documenting reference IDs — auditors need the specific clause/section'], next: null },
            'bia': { title: 'What Breaks If Systems Go Down?', why: 'BIA determines which business processes are critical and how quickly they must be recovered. This drives your entire BCM/DR strategy.', steps: ['Identify critical business processes', 'Set RTO (Recovery Time Objective) and RPO (Recovery Point Objective)', 'Determine MTPD (Maximum Tolerable Period of Disruption)', 'Map dependencies between processes and assets'], mistakes: ['Setting all RTOs to 0 — even critical systems have some acceptable downtime', 'Not involving business stakeholders — IT cannot determine business criticality alone'], next: { text: 'Now create BCM/DR Plans for critical processes →', tab: 'bcm' } },
            'bcm': { title: 'Plans for When Things Go Wrong', why: 'BCM and DR plans define HOW you recover when disruptions happen. BIA tells you WHAT is critical and HOW FAST to recover — BCM plans define the actual recovery strategy.', steps: ['Create plans for your most critical BIA processes', 'Link each plan to a BIA entry', 'Define the recovery strategy in detail', 'Set test schedules and track results'], mistakes: ['Plans that have never been tested are not plans — they are documents', 'Not updating plans after organizational changes', 'No crisis communication plan — this is always forgotten'], next: null },
            'vendor-risk': { title: 'Assess Your Third-Party Risk', why: 'Your vendors are an extension of your risk surface. A breach at a critical vendor IS your breach. Vendor risk assessment scores vendors across 4 dimensions.', steps: ['Score each vendor on Security, Compliance, Financial, and Operational (0-25 each)', 'Focus on critical/high vendors first', 'Request SOC 2 reports, pentest results, and compliance certifications', 'Set review schedules — annual for low risk, quarterly for critical'], mistakes: ['Assessing vendors only at onboarding — risk changes over the contract lifecycle', 'Not considering fourth-party risk (your vendor\'s vendors)', 'Accepting self-assessment questionnaires without verification'], next: null },
            'audit-sim': { title: 'Practice the Full Audit Lifecycle', why: 'This is what separates GRC students from GRC practitioners. An audit simulation teaches you to PLAN, SCOPE, SAMPLE, TEST, and REPORT — the exact process an external auditor follows. If you can run this, you can handle a real audit.', steps: ['Start with Planning: define objective and criteria', 'Scope: select which controls to audit', 'Sampling: the system calculates sample sizes per control frequency', 'Fieldwork: test each control, classify deficiencies, write workpaper notes', 'Reporting: review the summary and deficiency classifications'], mistakes: ['Skipping planning — every audit has a defined objective and criteria', 'Not understanding sample sizes — daily controls need 25 samples, quarterly needs 2', 'Confusing Control Deficiency vs Significant Deficiency vs Material Weakness'], next: null },
            'missions': { title: 'Learn by Doing', why: 'Guided Missions are the core learning engine. Each mission walks you through a real GRC workflow step by step, checking your progress as you go. Complete all missions to build a portfolio-ready GRC program.', steps: ['Start with Mission 1: Build Your First Risk Register', 'Each step tells you exactly what to do and gives you a hint', 'Click "Go →" to jump to the right tab and complete the task', 'Return to Missions to check your progress'], mistakes: ['Skipping missions and just filling forms — missions teach the WHY, not just the HOW', 'Not reading the hints — they contain real-world context from GRC practitioners'], next: { text: 'Start Mission 1 →', tab: 'missions' } },
            'interview-prep': { title: 'Turn Your Lab Work Into Interview Answers', why: 'Every piece of data you create in this lab becomes fodder for interview responses. This generator creates personalized Q&A based on YOUR actual work — not generic answers. The more you build, the stronger your answers.', steps: ['Complete at least one Guided Mission first', 'Return here to see auto-generated Q&A', 'Practice answering WITHOUT looking at the suggested answer', 'Click "Show Answer" to compare your response'], mistakes: ['Using these as scripts — interviewers can tell when you are reciting memorized answers', 'Not customizing — adapt these to YOUR experience and add personal context'], next: { text: 'Build more data in Guided Missions →', tab: 'missions' } },
            'roadmap': { title: 'Shape the Future of This Lab', why: 'This lab is built by the GRC community, for the GRC community. Every feature was requested by a practitioner. Your feedback directly influences what gets built next.', steps: ['Browse Released features to see what is available', 'Check Planned features to see what is coming', 'Submit Feedback with structured categories', 'Suggest new Scenarios for your industry/region'], mistakes: [], next: null }
        };
    }
    renderCoach() {
        const body = document.getElementById('coach-body');
        const data = this.getCoachData()[this.currentTab];
        if (!data) {
            body.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: var(--text-muted);"><i class="bi bi-mortarboard" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p style="font-size: 14px; font-weight: 600;">Switch to any tab to get contextual coaching.</p><p style="font-size: 12px; margin-top: 8px;">The coach adapts to what you are working on and tells you exactly what to do, why it matters, and common mistakes to avoid.</p></div>`;
            return;
        }
        body.innerHTML = `
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 6px;">${data.title}</h3>
            </div>
            <div class="coach-section">
                <div class="coach-section-title"><i class="bi bi-lightbulb"></i> WHY THIS MATTERS</div>
                <div class="coach-text">${data.why}</div>
            </div>
            <div class="coach-section">
                <div class="coach-section-title"><i class="bi bi-list-ol"></i> STEPS TO PRACTICE</div>
                ${data.steps.map((s, i) => `<div class="coach-step"><div class="coach-step-num">${i + 1}</div><div class="coach-step-text">${s}</div></div>`).join('')}
            </div>
            <div class="coach-section">
                <div class="coach-section-title"><i class="bi bi-exclamation-triangle"></i> COMMON MISTAKES</div>
                ${data.mistakes.map(m => `<div class="coach-mistake"><i class="bi bi-x-circle-fill" style="flex-shrink:0; margin-top: 1px;"></i><span>${m}</span></div>`).join('')}
            </div>
            ${data.next ? `<div class="coach-section">
                <div class="coach-section-title"><i class="bi bi-arrow-right-circle"></i> NEXT STEP</div>
                <button class="coach-next-btn" onclick="app.switchTab('${data.next.tab}'); app.renderCoach();">${data.next.text}</button>
            </div>` : ''}
        `;
    }

    // ==================== WORKFLOW CHAIN PROMPTS ====================
    showWorkflowPrompt(title, text, nextTab, nextLabel) {
        const existing = document.querySelector('.workflow-toast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.className = 'workflow-toast';
        toast.innerHTML = `
            <div class="workflow-toast-title"><i class="bi bi-arrow-right-circle-fill"></i> ${title}</div>
            <div class="workflow-toast-text">${text}</div>
            <div class="workflow-toast-actions">
                <button class="workflow-toast-btn primary" onclick="app.switchTab('${nextTab}'); this.closest('.workflow-toast').remove();">${nextLabel}</button>
                <button class="workflow-toast-btn ghost" onclick="this.closest('.workflow-toast').remove();">Later</button>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => { if (toast.parentElement) toast.remove(); }, 12000);
    }

    // ==================== PROGRAM HEALTH ADVISOR ====================
    renderHealthAdvisor() {
        const d = this.getActiveData();
        const gaps = [];

        // Check Risk Appetite
        if ((d.riskAppetiteStatements || []).length === 0) gaps.push({ severity: 'critical', icon: 'bi-speedometer2', text: 'No Risk Appetite defined. This is the foundation — without it, your risk scores have no context.', action: 'Define Risk Appetite →', tab: 'risk-appetite' });
        // Risks without controls
        const risksNoCtrl = d.risks.filter(r => { const linked = d.controls.filter(c => c.riskId === r.id || c.linkedRisk === r.id); return linked.length === 0; });
        if (risksNoCtrl.length > 0) gaps.push({ severity: 'critical', icon: 'bi-exclamation-triangle', text: `${risksNoCtrl.length} risk(s) have no linked controls. Unmitigated risks are audit failures.`, action: 'Add Controls →', tab: 'controls' });
        // Controls without evidence
        const ctrlNoEv = d.controls.filter(c => { const ev = d.evidence.filter(e => e.controlId === c.id || e.linkedControl === c.id); return ev.length === 0; });
        if (ctrlNoEv.length > 0) gaps.push({ severity: 'warning', icon: 'bi-folder2-open', text: `${ctrlNoEv.length} control(s) have no linked evidence. An auditor will ask "prove it works."`, action: 'Add Evidence →', tab: 'evidence' });
        // Controls not tested
        const ctrlNotTested = d.controls.filter(c => !c.effectiveness || c.effectiveness === 'Not Tested');
        if (ctrlNotTested.length > 0) gaps.push({ severity: 'warning', icon: 'bi-card-checklist', text: `${ctrlNotTested.length} control(s) have not been tested. Untested controls provide zero assurance.`, action: 'Test Controls →', tab: 'testing' });
        // Overdue findings
        const now = new Date();
        const overdueFindings = d.findings.filter(f => f.status !== 'Closed' && f.dueDate && new Date(f.dueDate) < now);
        if (overdueFindings.length > 0) gaps.push({ severity: 'critical', icon: 'bi-clock-history', text: `${overdueFindings.length} finding(s) are overdue. Aging findings signal weak remediation practices.`, action: 'Review Findings →', tab: 'findings' });
        // BIA without BCM plans
        const biaNoPlans = (d.biaEntries || []).filter(b => b.criticality === 'Critical' && !(d.bcmPlans || []).some(p => p.biaId === b.id));
        if (biaNoPlans.length > 0) gaps.push({ severity: 'warning', icon: 'bi-shield-fill-plus', text: `${biaNoPlans.length} critical BIA process(es) have no BCM/DR plan. Recovery is undefined.`, action: 'Create Plans →', tab: 'bcm' });
        // KRI breaches
        const kriBreached = (d.kriEntries || []).filter(k => k.currentValue > k.redThreshold);
        if (kriBreached.length > 0) gaps.push({ severity: 'critical', icon: 'bi-graph-up-arrow', text: `${kriBreached.length} KRI(s) have breached red thresholds — risk tolerance exceeded. Escalation required.`, action: 'Review KRIs →', tab: 'kri' });
        // Risks exceeding appetite
        const appetiteMap = {};
        (d.riskAppetiteStatements || []).forEach(a => { appetiteMap[a.category] = a.toleranceMax; });
        const risksOverAppetite = d.risks.filter(r => { const score = (r.likelihood || 1) * (r.impact || 1); const tol = appetiteMap[r.category]; return tol && score > tol; });
        if (risksOverAppetite.length > 0) gaps.push({ severity: 'critical', icon: 'bi-speedometer2', text: `${risksOverAppetite.length} risk(s) exceed your stated risk appetite tolerance. Board-level escalation required.`, action: 'Review Risks →', tab: 'risks' });
        // No assets
        if (d.assets.length === 0) gaps.push({ severity: 'info', icon: 'bi-hdd-stack', text: 'No assets inventoried. Start by documenting what you are protecting.', action: 'Add Assets →', tab: 'assets' });
        // No crosswalk mappings
        if ((d.crosswalkMappings || []).length === 0 && d.controls.length > 0) gaps.push({ severity: 'info', icon: 'bi-intersect', text: 'No control crosswalk mappings. Map controls to multiple frameworks to demonstrate audit efficiency.', action: 'Create Crosswalk →', tab: 'crosswalk' });

        if (gaps.length === 0) return `<div class="card" style="margin-bottom: 20px; border-left: 4px solid var(--accent-green);"><div style="padding: 20px; display: flex; align-items: center; gap: 12px;"><i class="bi bi-patch-check-fill" style="font-size: 24px; color: var(--accent-green);"></i><div><div style="font-weight: 700; font-size: 14px; color: var(--accent-green);">Program Health: Strong</div><div style="font-size: 12px; color: var(--text-secondary);">No critical gaps detected. Keep monitoring KRIs and testing controls.</div></div></div></div>`;

        const critCount = gaps.filter(g => g.severity === 'critical').length;
        const warnCount = gaps.filter(g => g.severity === 'warning').length;
        const scoreColor = critCount > 0 ? 'red' : warnCount > 2 ? 'amber' : 'green';
        const scoreLabel = critCount > 0 ? 'Needs Attention' : warnCount > 2 ? 'Fair' : 'Good';

        return `<div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 16px; display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 700; display: flex; align-items: center; gap: 8px;"><i class="bi bi-heart-pulse-fill" style="color: var(--accent-${scoreColor});"></i> Program Health Advisor</span>
                <span class="badge badge-${scoreColor}">${scoreLabel} — ${gaps.length} gap${gaps.length > 1 ? 's' : ''} found</span>
            </div>
            <div class="card-body" style="padding: 16px;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">These are specific gaps in your GRC program, ranked by severity. Fix critical items first.</div>
                ${gaps.map(g => `<div class="health-gap ${g.severity === 'warning' ? 'warning' : g.severity === 'info' ? 'info' : ''}">
                    <i class="bi ${g.icon} health-gap-icon" style="color: var(--accent-${g.severity === 'critical' ? 'red' : g.severity === 'warning' ? 'amber' : 'blue'});"></i>
                    <div><div class="health-gap-text">${g.text}</div><span class="health-gap-action" onclick="app.switchTab('${g.tab}')">${g.action}</span></div>
                </div>`).join('')}
            </div>
        </div>`;
    }
    renderDashboard() {
        const c = document.getElementById('tab-dashboard');
        const d = this.getActiveData();
        const openRisks = d.risks.filter(r => r.status !== 'Closed').length;
        const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const highRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
        const mediumRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 6 && (r.likelihood * r.impact) < 12).length;
        const lowRisks = d.risks.filter(r => (r.likelihood * r.impact) < 6).length;
        const openIssues = d.issues.filter(i => i.status === 'Open').length;
        const pendingTasks = d.tasks.filter(t => t.status !== 'Completed').length;
        const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
        const partialControls = d.controls.filter(c => c.effectiveness === 'Partially Effective').length;
        const ineffectiveControls = d.controls.filter(c => c.effectiveness === 'Ineffective').length;
        const openFindings = d.findings.filter(f => f.status === 'Open').length;
        const closedFindings = d.findings.filter(f => f.status === 'Closed').length;
        const activeIncidents = d.incidents.filter(i => i.status !== 'Resolved').length;
        const criticalVendors = d.vendors.filter(v => v.criticality === 'Critical').length;
        
        // Calculate health score
        const riskScore = d.risks.length > 0 ? Math.max(0, 100 - (criticalRisks * 15 + highRisks * 8 + mediumRisks * 3)) : 100;
        const controlScore = d.controls.length > 0 ? Math.round((effectiveControls / d.controls.length) * 100) : 0;
        const overallHealth = d.risks.length > 0 || d.controls.length > 0 ? Math.round((riskScore + controlScore) / 2) : 0;
        const healthColor = overallHealth >= 70 ? 'green' : overallHealth >= 40 ? 'amber' : 'red';
        
        // Risk trend data (simulated based on current data)
        const riskTrend = [
            d.risks.length > 0 ? Math.max(1, d.risks.length - 3) : 0,
            d.risks.length > 0 ? Math.max(1, d.risks.length - 2) : 0,
            d.risks.length > 0 ? Math.max(1, d.risks.length - 1) : 0,
            d.risks.length,
            d.risks.length > 0 ? Math.max(0, d.risks.length - Math.floor(d.treatments.length * 0.5)) : 0,
            d.risks.length > 0 ? Math.max(0, d.risks.length - d.treatments.length) : 0
        ];
        const maxTrend = Math.max(...riskTrend, 1);
        
        const projectModeNote = this.activeProject ? `
            <div style="background: linear-gradient(135deg, var(--accent-purple-soft), var(--accent-blue-soft)); padding: 16px 20px; border-radius: var(--radius-lg); margin-bottom: 24px; border: 1px solid var(--accent-purple); display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; background: var(--accent-purple); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-briefcase-fill" style="font-size: 24px; color: white;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 15px;">Project Mode Active</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">All data is scoped to your current project. Click "Exit Project" in header to return to workspace.</div>
                </div>
            </div>
        ` : '';
        
        c.innerHTML = `
            <style>
                @keyframes dash-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                @keyframes dash-float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
                @keyframes dash-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
                @keyframes dash-glow { 0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); } 50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); } }
                @keyframes dash-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                @keyframes dash-wave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
                @keyframes dash-count { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                @keyframes dash-ring { 0% { stroke-dashoffset: 440; } 100% { stroke-dashoffset: var(--target-offset); } }
                @keyframes bar-grow { from { width: 0; } }
                @keyframes fade-slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
                
                .dash-hero { background: linear-gradient(-45deg, #0f172a, #1e3a5f, #312e81, #4c1d95, #1e3a5f); background-size: 400% 400%; animation: dash-gradient 15s ease infinite; border-radius: var(--radius-2xl); padding: 32px; position: relative; overflow: hidden; margin-bottom: 28px; }
                .dash-hero::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E"); }
                .dash-hero-orb { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.4; pointer-events: none; }
                .dash-hero-orb-1 { width: 300px; height: 300px; background: #60a5fa; top: -100px; right: -50px; animation: dash-float 8s ease-in-out infinite; }
                .dash-hero-orb-2 { width: 200px; height: 200px; background: #a78bfa; bottom: -50px; left: -30px; animation: dash-float 6s ease-in-out infinite reverse; }
                
                .dash-kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 28px; }
                .dash-kpi { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); padding: 20px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
                .dash-kpi:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.12); border-color: var(--accent-blue); }
                .dash-kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--kpi-color), transparent); opacity: 0; transition: opacity 0.3s; }
                .dash-kpi:hover::before { opacity: 1; }
                .dash-kpi-icon { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 14px; transition: transform 0.3s; }
                .dash-kpi:hover .dash-kpi-icon { transform: scale(1.1) rotate(-5deg); }
                .dash-kpi-value { font-size: 32px; font-weight: 800; margin-bottom: 4px; animation: dash-count 0.6s ease-out; }
                .dash-kpi-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
                .dash-kpi-trend { display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; }
                .dash-kpi-trend.up { color: var(--accent-green); }
                .dash-kpi-trend.down { color: var(--accent-red); }
                .dash-kpi-mini-chart { display: flex; align-items: flex-end; gap: 3px; height: 32px; margin-top: 12px; }
                .dash-kpi-mini-bar { width: 6px; background: var(--kpi-color); border-radius: 3px; opacity: 0.6; transition: height 0.5s ease, opacity 0.3s; }
                .dash-kpi:hover .dash-kpi-mini-bar { opacity: 1; }
                
                .dash-charts-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 20px; margin-bottom: 28px; }
                .dash-chart-card { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); overflow: hidden; transition: all 0.3s; cursor: pointer; }
                .dash-chart-card:hover { border-color: var(--accent-blue); box-shadow: var(--shadow-lg); transform: translateY(-4px); }
                .dash-chart-header { padding: 18px 20px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
                .dash-chart-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 10px; }
                .dash-chart-body { padding: 20px; }
                
                .dash-health-ring { position: relative; width: 180px; height: 180px; margin: 0 auto; }
                .dash-health-ring svg { transform: rotate(-90deg); filter: drop-shadow(0 4px 20px rgba(59, 130, 246, 0.3)); }
                .dash-health-ring circle { transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
                .dash-health-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
                .dash-health-value { font-size: 42px; font-weight: 800; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                .dash-health-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
                
                .dash-donut { position: relative; width: 140px; height: 140px; }
                .dash-donut svg { transform: rotate(-90deg); }
                .dash-donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
                .dash-donut-segment { transition: stroke-dashoffset 0.8s ease, opacity 0.3s; cursor: pointer; }
                .dash-donut-segment:hover { opacity: 0.8; }
                
                .dash-legend { display: flex; flex-direction: column; gap: 10px; }
                .dash-legend-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: var(--radius-md); cursor: pointer; transition: background 0.2s; }
                .dash-legend-item:hover { background: var(--bg-elevated); }
                .dash-legend-dot { width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0; }
                .dash-legend-label { font-size: 13px; flex: 1; }
                .dash-legend-value { font-size: 14px; font-weight: 700; }
                .dash-legend-bar { height: 6px; background: var(--bg-elevated); border-radius: 3px; flex: 1; max-width: 60px; overflow: hidden; }
                .dash-legend-bar-fill { height: 100%; border-radius: 3px; animation: bar-grow 0.8s ease-out; }
                
                .dash-bar-chart { display: flex; flex-direction: column; gap: 12px; }
                .dash-bar-row { display: flex; align-items: center; gap: 12px; }
                .dash-bar-label { width: 80px; font-size: 12px; color: var(--text-secondary); text-align: right; }
                .dash-bar-track { flex: 1; height: 24px; background: var(--bg-elevated); border-radius: 6px; overflow: hidden; position: relative; }
                .dash-bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; font-weight: 600; color: white; animation: bar-grow 1s ease-out; transition: width 0.5s ease; }
                .dash-bar-value { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: 600; }
                
                .dash-heatmap { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
                .dash-heatmap-cell { aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; cursor: pointer; transition: all 0.2s; position: relative; }
                .dash-heatmap-cell:hover { transform: scale(1.1); z-index: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
                .dash-heatmap-cell[data-risk="critical"] { background: linear-gradient(135deg, #dc2626, #b91c1c); }
                .dash-heatmap-cell[data-risk="high"] { background: linear-gradient(135deg, #f59e0b, #d97706); }
                .dash-heatmap-cell[data-risk="medium"] { background: linear-gradient(135deg, #3b82f6, #2563eb); }
                .dash-heatmap-cell[data-risk="low"] { background: linear-gradient(135deg, #22c55e, #16a34a); }
                .dash-heatmap-cell[data-risk="none"] { background: var(--bg-elevated); color: var(--text-muted); }
                
                .dash-activity-list { max-height: 320px; overflow-y: auto; }
                .dash-activity-item { display: flex; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background 0.2s; margin: 0 -20px; padding-left: 20px; padding-right: 20px; }
                .dash-activity-item:hover { background: var(--bg-elevated); }
                .dash-activity-item:last-child { border-bottom: none; }
                .dash-activity-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
                .dash-activity-content { flex: 1; min-width: 0; }
                .dash-activity-title { font-size: 13px; font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                .dash-activity-meta { font-size: 11px; color: var(--text-muted); }
                
                .dash-trend-chart { height: 120px; display: flex; align-items: flex-end; gap: 8px; padding: 10px 0; }
                .dash-trend-bar { flex: 1; background: linear-gradient(180deg, var(--accent-blue), var(--accent-blue-soft)); border-radius: 6px 6px 0 0; transition: height 0.5s ease; position: relative; min-height: 8px; }
                .dash-trend-bar:hover { opacity: 0.8; }
                .dash-trend-bar::after { content: attr(data-value); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 600; color: var(--text-secondary); padding-bottom: 4px; opacity: 0; transition: opacity 0.2s; }
                .dash-trend-bar:hover::after { opacity: 1; }
                .dash-trend-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); padding-top: 8px; }
                
                .dash-actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; }
                .dash-action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
                .dash-action-btn:hover { background: var(--accent-blue-soft); border-color: var(--accent-blue); transform: translateY(-2px); }
                .dash-action-btn i { font-size: 24px; color: var(--accent-blue); }
                .dash-action-btn span { font-size: 12px; font-weight: 500; }
                
                .dash-bottom-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
                .dash-risk-table { width: 100%; }
                .dash-risk-table-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background 0.2s; margin: 0 -20px; }
                .dash-risk-table-row:hover { background: var(--bg-elevated); }
                .dash-risk-score { min-width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 700; color: white; flex-shrink: 0; }
                
                @media (max-width: 1200px) {
                    .dash-kpi-grid { grid-template-columns: repeat(3, 1fr); }
                    .dash-charts-grid { grid-template-columns: 1fr 1fr; }
                    .dash-bottom-grid { grid-template-columns: 1fr; }
                }
            </style>
            
            ${projectModeNote}
            
            <!-- Hero Banner -->
            <div class="dash-hero">
                <div class="dash-hero-orb dash-hero-orb-1"></div>
                <div class="dash-hero-orb dash-hero-orb-2"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                        <div style="flex: 1; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                                <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2);">
                                    <i class="bi bi-shield-check" style="font-size: 28px; color: white;"></i>
                                </div>
                                <div>
                                    <h1 style="font-size: 26px; font-weight: 700; margin: 0; color: white;">${this.activeProject ? 'Project Dashboard' : 'GRC Command Center'}</h1>
                                    <p style="font-size: 14px; color: rgba(255,255,255,0.7); margin: 0;">Real-time security & compliance posture</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: dash-pulse 2s infinite;"></div>
                                    <span style="color: rgba(255,255,255,0.9); font-size: 13px;">${effectiveControls} Controls Active</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="bi bi-shield-exclamation" style="color: ${criticalRisks > 0 ? '#f87171' : '#4ade80'};"></i>
                                    <span style="color: rgba(255,255,255,0.9); font-size: 13px;">${criticalRisks} Critical Risks</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="bi bi-clock-history" style="color: #fbbf24;"></i>
                                    <span style="color: rgba(255,255,255,0.9); font-size: 13px;">Updated just now</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="text-align: center; padding: 16px 24px; background: rgba(255,255,255,0.1); border-radius: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                                <div style="font-size: 36px; font-weight: 800; color: white; line-height: 1;">${overallHealth}</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px;">Health Score</div>
                            </div>
                        </div>
                    </div>
                    
                    ${!this.activeProject ? `
                    <div style="display: flex; gap: 10px; margin-top: 24px; flex-wrap: wrap;">
                        <button class="btn" style="background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);" onclick="app.loadDemo()">
                            <i class="bi bi-lightning-fill"></i> Load Demo Data
                        </button>
                        <button class="btn" style="background: white; color: #1e3a8a;" onclick="app.switchTab('projects')">
                            <i class="bi bi-briefcase"></i> Start Project
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);" onclick="app.switchTab('start-here')">
                            <i class="bi bi-book"></i> Quick Start Guide
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="dash-kpi-grid">
                <div class="dash-kpi" style="--kpi-color: var(--accent-blue);" onclick="app.switchTab('assets')">
                    <div class="dash-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);">
                        <i class="bi bi-hdd-stack-fill"></i>
                    </div>
                    <div class="dash-kpi-value" style="color: var(--accent-blue);">${d.assets.length}</div>
                    <div class="dash-kpi-label">Total Assets</div>
                    <div class="dash-kpi-trend ${d.assets.length > 0 ? 'up' : ''}">
                        ${d.assets.length > 0 ? '<i class="bi bi-arrow-up-short"></i> Active' : '<i class="bi bi-dash"></i> None'}
                    </div>
                    <div class="dash-kpi-mini-chart">
                        ${[3,5,4,7,6,8,d.assets.length || 2].map((v,i) => `<div class="dash-kpi-mini-bar" style="height: ${Math.max(10, (v/10)*100)}%;"></div>`).join('')}
                    </div>
                </div>
                
                <div class="dash-kpi" style="--kpi-color: var(--accent-red);" onclick="app.switchTab('risks')">
                    <div class="dash-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <div class="dash-kpi-value" style="color: var(--accent-red);">${d.risks.length}</div>
                    <div class="dash-kpi-label">Active Risks</div>
                    <div class="dash-kpi-trend ${criticalRisks > 0 ? 'down' : 'up'}">
                        ${criticalRisks > 0 ? `<i class="bi bi-exclamation-circle"></i> ${criticalRisks} Critical` : '<i class="bi bi-check-circle"></i> Under control'}
                    </div>
                    <div class="dash-kpi-mini-chart">
                        ${riskTrend.map(v => `<div class="dash-kpi-mini-bar" style="height: ${Math.max(10, (v/maxTrend)*100)}%;"></div>`).join('')}
                    </div>
                </div>
                
                <div class="dash-kpi" style="--kpi-color: var(--accent-green);" onclick="app.switchTab('controls')">
                    <div class="dash-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="dash-kpi-value" style="color: var(--accent-green);">${d.controls.length}</div>
                    <div class="dash-kpi-label">Controls</div>
                    <div class="dash-kpi-trend up">
                        <i class="bi bi-graph-up"></i> ${controlScore}% Effective
                    </div>
                    <div class="dash-kpi-mini-chart">
                        ${[2,4,5,3,6,7,d.controls.length || 2].map((v,i) => `<div class="dash-kpi-mini-bar" style="height: ${Math.max(10, (v/10)*100)}%;"></div>`).join('')}
                    </div>
                </div>
                
                <div class="dash-kpi" style="--kpi-color: var(--accent-purple);" onclick="app.switchTab('vendors')">
                    <div class="dash-kpi-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="dash-kpi-value" style="color: var(--accent-purple);">${d.vendors.length}</div>
                    <div class="dash-kpi-label">Vendors</div>
                    <div class="dash-kpi-trend ${criticalVendors > 0 ? 'down' : 'up'}">
                        ${criticalVendors > 0 ? `<i class="bi bi-exclamation"></i> ${criticalVendors} Critical` : '<i class="bi bi-check"></i> Managed'}
                    </div>
                    <div class="dash-kpi-mini-chart">
                        ${[1,2,3,2,4,3,d.vendors.length || 1].map((v,i) => `<div class="dash-kpi-mini-bar" style="height: ${Math.max(10, (v/5)*100)}%;"></div>`).join('')}
                    </div>
                </div>
                
                <div class="dash-kpi" style="--kpi-color: var(--accent-amber);" onclick="app.switchTab('issues')">
                    <div class="dash-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);">
                        <i class="bi bi-flag-fill"></i>
                    </div>
                    <div class="dash-kpi-value" style="color: var(--accent-amber);">${openIssues}</div>
                    <div class="dash-kpi-label">Open Issues</div>
                    <div class="dash-kpi-trend ${openIssues > 3 ? 'down' : 'up'}">
                        ${openIssues > 0 ? `<i class="bi bi-hourglass-split"></i> Pending` : '<i class="bi bi-check-all"></i> All clear'}
                    </div>
                    <div class="dash-kpi-mini-chart">
                        ${[2,3,4,2,3,1,openIssues || 1].map((v,i) => `<div class="dash-kpi-mini-bar" style="height: ${Math.max(10, (v/5)*100)}%;"></div>`).join('')}
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="dash-charts-grid">
                <!-- GRC Health Score -->
                <div class="dash-chart-card" onclick="app.showHealthScoreModal()">
                    <div class="dash-chart-header">
                        <span class="dash-chart-title"><i class="bi bi-heart-pulse-fill" style="color: var(--accent-blue);"></i> GRC Health Score</span>
                        <span class="badge badge-${healthColor}">${overallHealth >= 70 ? 'Healthy' : overallHealth >= 40 ? 'At Risk' : 'Critical'}</span>
                    </div>
                    <div class="dash-chart-body">
                        <div class="dash-health-ring">
                            <svg width="180" height="180" viewBox="0 0 180 180">
                                <defs>
                                    <linearGradient id="healthGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#3b82f6"/>
                                        <stop offset="50%" stop-color="#8b5cf6"/>
                                        <stop offset="100%" stop-color="#06b6d4"/>
                                    </linearGradient>
                                </defs>
                                <circle cx="90" cy="90" r="70" fill="none" stroke="var(--bg-elevated)" stroke-width="14"/>
                                <circle cx="90" cy="90" r="70" fill="none" stroke="url(#healthGradient)" stroke-width="14" 
                                    stroke-dasharray="${overallHealth * 4.4} 440" stroke-linecap="round"
                                    style="transition: stroke-dasharray 1.5s ease;"/>
                            </svg>
                            <div class="dash-health-center">
                                <div class="dash-health-value">${overallHealth}</div>
                                <div class="dash-health-label">Score</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                            <div style="text-align: center; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md);">
                                <div style="font-size: 18px; font-weight: 700; color: var(--accent-blue);">${riskScore}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Risk Score</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md);">
                                <div style="font-size: 18px; font-weight: 700; color: var(--accent-green);">${controlScore}%</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Control Effectiveness</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Distribution Donut -->
                <div class="dash-chart-card" onclick="app.showRiskDistributionModal()">
                    <div class="dash-chart-header">
                        <span class="dash-chart-title"><i class="bi bi-pie-chart-fill" style="color: var(--accent-red);"></i> Risk Distribution</span>
                        <span class="badge badge-blue">${d.risks.length} Total</span>
                    </div>
                    <div class="dash-chart-body">
                        ${d.risks.length > 0 ? `
                        <div style="display: flex; align-items: center; gap: 24px;">
                            <div class="dash-donut">
                                <svg width="140" height="140" viewBox="0 0 140 140">
                                    ${this.renderAdvancedDonut([
                                        { value: criticalRisks, color: '#ef4444', label: 'Critical' },
                                        { value: highRisks, color: '#f59e0b', label: 'High' },
                                        { value: mediumRisks, color: '#3b82f6', label: 'Medium' },
                                        { value: lowRisks, color: '#22c55e', label: 'Low' }
                                    ], d.risks.length)}
                                </svg>
                                <div class="dash-donut-center">
                                    <div style="font-size: 28px; font-weight: 800;">${d.risks.length}</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">RISKS</div>
                                </div>
                            </div>
                            <div class="dash-legend">
                                <div class="dash-legend-item" onclick="event.stopPropagation(); app.filterRisksByLevel('critical')">
                                    <div class="dash-legend-dot" style="background: #ef4444;"></div>
                                    <span class="dash-legend-label">Critical</span>
                                    <div class="dash-legend-bar"><div class="dash-legend-bar-fill" style="width: ${(criticalRisks/Math.max(d.risks.length,1))*100}%; background: #ef4444;"></div></div>
                                    <span class="dash-legend-value">${criticalRisks}</span>
                                </div>
                                <div class="dash-legend-item" onclick="event.stopPropagation(); app.filterRisksByLevel('high')">
                                    <div class="dash-legend-dot" style="background: #f59e0b;"></div>
                                    <span class="dash-legend-label">High</span>
                                    <div class="dash-legend-bar"><div class="dash-legend-bar-fill" style="width: ${(highRisks/Math.max(d.risks.length,1))*100}%; background: #f59e0b;"></div></div>
                                    <span class="dash-legend-value">${highRisks}</span>
                                </div>
                                <div class="dash-legend-item" onclick="event.stopPropagation(); app.filterRisksByLevel('medium')">
                                    <div class="dash-legend-dot" style="background: #3b82f6;"></div>
                                    <span class="dash-legend-label">Medium</span>
                                    <div class="dash-legend-bar"><div class="dash-legend-bar-fill" style="width: ${(mediumRisks/Math.max(d.risks.length,1))*100}%; background: #3b82f6;"></div></div>
                                    <span class="dash-legend-value">${mediumRisks}</span>
                                </div>
                                <div class="dash-legend-item" onclick="event.stopPropagation(); app.filterRisksByLevel('low')">
                                    <div class="dash-legend-dot" style="background: #22c55e;"></div>
                                    <span class="dash-legend-label">Low</span>
                                    <div class="dash-legend-bar"><div class="dash-legend-bar-fill" style="width: ${(lowRisks/Math.max(d.risks.length,1))*100}%; background: #22c55e;"></div></div>
                                    <span class="dash-legend-value">${lowRisks}</span>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="bi bi-pie-chart" style="font-size: 48px; color: var(--text-muted); opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <p style="color: var(--text-muted); margin-bottom: 16px;">No risks recorded yet</p>
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); app.switchTab('risks')"><i class="bi bi-plus"></i> Add Risk</button>
                        </div>
                        `}
                    </div>
                </div>
                
                <!-- Control Effectiveness -->
                <div class="dash-chart-card" onclick="app.showControlEffectivenessModal()">
                    <div class="dash-chart-header">
                        <span class="dash-chart-title"><i class="bi bi-bar-chart-fill" style="color: var(--accent-green);"></i> Control Status</span>
                        <span class="badge badge-green">${effectiveControls} Effective</span>
                    </div>
                    <div class="dash-chart-body">
                        ${d.controls.length > 0 ? `
                        <div class="dash-bar-chart">
                            <div class="dash-bar-row">
                                <div class="dash-bar-label">Effective</div>
                                <div class="dash-bar-track">
                                    <div class="dash-bar-fill" style="width: ${(effectiveControls/d.controls.length)*100}%; background: linear-gradient(90deg, #22c55e, #16a34a);">${effectiveControls}</div>
                                </div>
                            </div>
                            <div class="dash-bar-row">
                                <div class="dash-bar-label">Partial</div>
                                <div class="dash-bar-track">
                                    <div class="dash-bar-fill" style="width: ${(partialControls/d.controls.length)*100}%; background: linear-gradient(90deg, #f59e0b, #d97706);">${partialControls}</div>
                                </div>
                            </div>
                            <div class="dash-bar-row">
                                <div class="dash-bar-label">Ineffective</div>
                                <div class="dash-bar-track">
                                    <div class="dash-bar-fill" style="width: ${(ineffectiveControls/d.controls.length)*100}%; background: linear-gradient(90deg, #ef4444, #dc2626);">${ineffectiveControls}</div>
                                </div>
                            </div>
                            <div class="dash-bar-row">
                                <div class="dash-bar-label">Not Tested</div>
                                <div class="dash-bar-track">
                                    <div class="dash-bar-fill" style="width: ${((d.controls.length - effectiveControls - partialControls - ineffectiveControls)/d.controls.length)*100}%; background: linear-gradient(90deg, #94a3b8, #64748b);">${d.controls.length - effectiveControls - partialControls - ineffectiveControls}</div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <span style="font-size: 12px; color: var(--text-muted);">Total: <strong>${d.controls.length}</strong> controls</span>
                        </div>
                        ` : `
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="bi bi-bar-chart" style="font-size: 48px; color: var(--text-muted); opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <p style="color: var(--text-muted); margin-bottom: 16px;">No controls recorded yet</p>
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); app.switchTab('controls')"><i class="bi bi-plus"></i> Add Control</button>
                        </div>
                        `}
                    </div>
                </div>
            </div>
            
            <!-- Bottom Section -->
            <div class="dash-bottom-grid">
                <!-- Risk Heatmap -->
                <div class="dash-chart-card" onclick="app.switchTab('matrix')">
                    <div class="dash-chart-header">
                        <span class="dash-chart-title"><i class="bi bi-grid-3x3-gap-fill" style="color: var(--accent-red);"></i> Risk Heatmap</span>
                        <span style="font-size: 11px; color: var(--text-muted);">Click to view matrix</span>
                    </div>
                    <div class="dash-chart-body">
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <div style="width: 30px;"></div>
                            <div style="flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; text-align: center; font-size: 10px; color: var(--text-muted);">
                                <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <div style="width: 30px; display: flex; flex-direction: column; justify-content: space-around; font-size: 10px; color: var(--text-muted); text-align: right;">
                                <span>5</span><span>4</span><span>3</span><span>2</span><span>1</span>
                            </div>
                            <div class="dash-heatmap" style="flex: 1;">
                                ${this.renderHeatmapCells(d.risks)}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 16px; margin-top: 16px; font-size: 10px;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 3px; vertical-align: middle; margin-right: 4px;"></span>Critical</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 3px; vertical-align: middle; margin-right: 4px;"></span>High</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #3b82f6; border-radius: 3px; vertical-align: middle; margin-right: 4px;"></span>Medium</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #22c55e; border-radius: 3px; vertical-align: middle; margin-right: 4px;"></span>Low</span>
                        </div>
                    </div>
                </div>
                
                <!-- Framework Coverage -->
                <div class="dash-chart-card">
                    <div class="dash-chart-header">
                        <span class="dash-chart-title"><i class="bi bi-collection-fill" style="color: var(--accent-purple);"></i> Framework Coverage</span>
                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.switchTab('frameworks')">Browse</button>
                    </div>
                    <div class="dash-chart-body">
                        ${(() => {
                            const frameworks = {};
                            d.controls.forEach(c => {
                                const fw = c.framework || 'Unassigned';
                                frameworks[fw] = (frameworks[fw] || 0) + 1;
                            });
                            const fwList = Object.entries(frameworks).sort((a,b) => b[1] - a[1]).slice(0, 5);
                            if (fwList.length === 0) {
                                return '<div style="text-align: center; padding: 30px; color: var(--text-muted);"><i class="bi bi-collection" style="font-size: 32px; opacity: 0.4; display: block; margin-bottom: 8px;"></i><p style="font-size: 13px;">Add controls to see coverage</p></div>';
                            }
                            const maxCount = Math.max(...fwList.map(f => f[1]));
                            return fwList.map(([fw, count]) => {
                                const colors = { 'ISO 27001': '#3b82f6', 'ISO 42001': '#a855f7', 'NIST CSF': '#22c55e', 'SOC 2': '#8b5cf6', 'PCI DSS': '#f59e0b', 'HIPAA': '#ef4444', 'GDPR': '#06b6d4', 'CIS': '#ec4899' };
                                const color = colors[fw] || '#6b7280';
                                return '<div style="margin-bottom: 14px;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;"><span style="font-size: 13px; font-weight: 500;">' + fw + '</span><span style="font-size: 12px; color: var(--text-muted);">' + count + ' controls</span></div><div style="height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden;"><div style="width: ' + (count/maxCount*100) + '%; height: 100%; background: ' + color + '; border-radius: 4px; transition: width 0.5s;"></div></div></div>';
                            }).join('');
                        })()}
                    </div>
                </div>
                
                <!-- Quick Actions & Activity -->
                <div class="dash-chart-card">
                    <div class="dash-chart-header">
                        <span class="dash-chart-title"><i class="bi bi-lightning-fill" style="color: var(--accent-amber);"></i> Quick Actions</span>
                    </div>
                    <div class="dash-chart-body">
                        <div class="dash-actions-grid">
                            <div class="dash-action-btn" onclick="app.switchTab('risks'); setTimeout(() => document.querySelector('[onclick*=addRisk]')?.click(), 100);">
                                <i class="bi bi-plus-circle"></i>
                                <span>Add Risk</span>
                            </div>
                            <div class="dash-action-btn" onclick="app.switchTab('controls'); setTimeout(() => document.querySelector('[onclick*=addControl]')?.click(), 100);">
                                <i class="bi bi-shield-plus"></i>
                                <span>Add Control</span>
                            </div>
                            <div class="dash-action-btn" onclick="app.switchTab('evidence')">
                                <i class="bi bi-file-earmark-plus"></i>
                                <span>Upload Evidence</span>
                            </div>
                            <div class="dash-action-btn" onclick="app.switchTab('reports')">
                                <i class="bi bi-file-bar-graph"></i>
                                <span>Generate Report</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Recent Activity</div>
                            ${this.renderRecentActivity(d)}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Program Health Advisor -->
            ${this.renderHealthAdvisor()}

            <!-- Extended Module Coverage -->
            <div style="margin-top: 20px;">
                <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;"><i class="bi bi-grid-3x3-gap-fill"></i> Extended Coverage</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px;">
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('itgc')" onmouseover="this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-bank2" style="color: var(--accent-blue); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">ITGC</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.itgcControls||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('sox')" onmouseover="this.style.borderColor='var(--accent-purple)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-briefcase-fill" style="color: var(--accent-purple); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">SOX</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.soxEntries||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('risk-appetite')" onmouseover="this.style.borderColor='var(--accent-red)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-speedometer2" style="color: var(--accent-red); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Appetite</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.riskAppetiteStatements||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('kri')" onmouseover="this.style.borderColor='var(--accent-green)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-graph-up-arrow" style="color: var(--accent-green); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">KRIs</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.kriEntries||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('bia')" onmouseover="this.style.borderColor='var(--accent-amber)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-heart-pulse" style="color: var(--accent-amber); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">BIA</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.biaEntries||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('bcm')" onmouseover="this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-shield-fill-plus" style="color: var(--accent-blue); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">BCM/DR</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.bcmPlans||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('crosswalk')" onmouseover="this.style.borderColor='var(--accent-purple)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-intersect" style="color: var(--accent-purple); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Crosswalk</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.crosswalkMappings||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('control-lifecycle')" onmouseover="this.style.borderColor='var(--accent-cyan)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-arrow-repeat" style="color: var(--accent-cyan); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Lifecycle</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.controlLifecycle||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('evidence-scoring')" onmouseover="this.style.borderColor='var(--accent-amber)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-star-half" style="color: var(--accent-amber); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Ev. Score</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.evidenceScores||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('cloud-risks')" onmouseover="this.style.borderColor='var(--accent-cyan)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-cloud-haze2" style="color: var(--accent-cyan); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Cloud Risk</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.cloudRiskScenarios||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('vendor-risk')" onmouseover="this.style.borderColor='var(--accent-green)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-clipboard2-pulse" style="color: var(--accent-green); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Vendor Risk</span></div>
                        <div style="font-size: 18px; font-weight: 700;">${(d.vendorAssessments||[]).length}</div>
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 12px; cursor: pointer; transition: all 0.2s;" onclick="app.switchTab('compliance-calendar')" onmouseover="this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.borderColor='var(--border-default)'">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="bi bi-calendar3-range" style="color: var(--accent-blue); font-size: 13px;"></i><span style="font-size: 10px; font-weight: 600;">Calendar</span></div>
                        <div style="font-size: 18px; font-weight: 700;"><i class="bi bi-arrow-right" style="font-size: 14px;"></i></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    renderAdvancedDonut(segments, total) {
        if (total === 0) return '';
        let offset = 0;
        const radius = 55;
        const circumference = 2 * Math.PI * radius;
        
        return segments.map((seg, i) => {
            const percentage = seg.value / total;
            const dashLength = percentage * circumference;
            const dashOffset = -offset * circumference;
            offset += percentage;
            
            return `<circle class="dash-donut-segment" cx="70" cy="70" r="${radius}" fill="none" 
                stroke="${seg.color}" stroke-width="20" 
                stroke-dasharray="${dashLength} ${circumference - dashLength}"
                stroke-dashoffset="${dashOffset}"
                style="transform-origin: center; transition: stroke-dasharray 0.8s ease ${i * 0.1}s;"/>`;
        }).join('');
    }
    
    renderHeatmapCells(risks) {
        const cells = [];
        for (let impact = 5; impact >= 1; impact--) {
            for (let likelihood = 1; likelihood <= 5; likelihood++) {
                const score = impact * likelihood;
                const count = risks.filter(r => r.likelihood === likelihood && r.impact === impact).length;
                let level = 'none';
                if (score >= 20) level = 'critical';
                else if (score >= 12) level = 'high';
                else if (score >= 6) level = 'medium';
                else if (count > 0) level = 'low';
                
                cells.push(`<div class="dash-heatmap-cell" data-risk="${count > 0 ? level : 'none'}" title="Impact: ${impact}, Likelihood: ${likelihood}, Count: ${count}">${count || ''}</div>`);
            }
        }
        return cells.join('');
    }
    
    renderRecentActivity(d) {
        const activities = [];
        
        // Gather recent items with proper title fallbacks
        d.risks.slice(-2).forEach(r => activities.push({ type: 'risk', title: r.title || 'Untitled Risk', time: 'Recently', icon: 'bi-exclamation-triangle', color: 'red' }));
        d.controls.slice(-2).forEach(c => activities.push({ type: 'control', title: c.title || c.name || 'Untitled Control', time: 'Recently', icon: 'bi-shield-check', color: 'green' }));
        d.assets.slice(-1).forEach(a => activities.push({ type: 'asset', title: a.name || 'Untitled Asset', time: 'Recently', icon: 'bi-hdd-stack', color: 'blue' }));
        
        if (activities.length === 0) {
            return `<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">
                <i class="bi bi-clock-history" style="font-size: 24px; opacity: 0.4; display: block; margin-bottom: 8px;"></i>
                No recent activity
            </div>`;
        }
        
        return activities.slice(0, 3).map(a => `
            <div style="display: flex; gap: 10px; align-items: center; padding: 8px 0; cursor: pointer;" onclick="app.switchTab('${a.type}s')">
                <div style="width: 32px; height: 32px; background: var(--accent-${a.color}-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi ${a.icon}" style="color: var(--accent-${a.color}); font-size: 14px;"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${a.title}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">${a.time}</div>
                </div>
            </div>
        `).join('');
    }
    
    filterRisksByLevel(level) {
        this.switchTab('risks');
        this.toast(`Showing ${level} risks`, 'info');
    }
    
    showHealthScoreModal() {
        const d = this.getActiveData();
        const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
        const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const highRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
        const riskScore = d.risks.length > 0 ? Math.max(0, 100 - (criticalRisks * 15 + highRisks * 8)) : 100;
        const controlScore = d.controls.length > 0 ? Math.round((effectiveControls / d.controls.length) * 100) : 0;
        
        openModal('GRC Health Score Breakdown', `
            <div style="padding: 10px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div style="text-align: center; padding: 24px; background: var(--accent-blue-soft); border-radius: var(--radius-lg);">
                        <div style="font-size: 36px; font-weight: 800; color: var(--accent-blue);">${riskScore}</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Risk Score</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">Based on ${d.risks.length} risks</div>
                    </div>
                    <div style="text-align: center; padding: 24px; background: var(--accent-green-soft); border-radius: var(--radius-lg);">
                        <div style="font-size: 36px; font-weight: 800; color: var(--accent-green);">${controlScore}%</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Control Effectiveness</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">${effectiveControls} of ${d.controls.length} effective</div>
                    </div>
                </div>
                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md);">
                    <div style="font-weight: 600; margin-bottom: 12px;">Score Factors</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                        • Critical risks: -15 points each (${criticalRisks} found)<br>
                        • High risks: -8 points each (${highRisks} found)<br>
                        • Effective controls: +${d.controls.length > 0 ? Math.round(100/d.controls.length) : 0} points each<br>
                        • Overall = (Risk Score + Control Score) / 2
                    </div>
                </div>
            </div>
        `, '<button class="btn btn-primary" onclick="closeModal()">Close</button>');
    }
    
    renderStartHere() {
        const c = document.getElementById('tab-start-here');
        if (!c) return;
        const d = this.getActiveData();
        
        // Calculate progress for each step
        const steps = [
            { id: 1, title: 'Load Sample Data or Start Fresh', desc: 'Get started by loading demo data to explore the lab, or start with a blank canvas to build from scratch.', complete: d.assets.length > 0 || d.risks.length > 0, action: "loadDemo()", actionLabel: 'Load Demo Data', icon: 'bi-lightning-fill' },
            { id: 2, title: 'Identify Your Assets', desc: 'List the systems, applications, and data that your organization needs to protect. Assets are the foundation of risk management.', complete: d.assets.length >= 3, action: "switchTab('assets')", actionLabel: 'Add Assets', icon: 'bi-hdd-stack', target: 3, current: d.assets.length },
            { id: 3, title: 'Assess Your Risks', desc: 'Identify what could go wrong. Think about threats, vulnerabilities, and potential business impacts for each asset.', complete: d.risks.length >= 3, action: "switchTab('risks')", actionLabel: 'Add Risks', icon: 'bi-exclamation-triangle', target: 3, current: d.risks.length },
            { id: 4, title: 'Implement Controls', desc: 'Controls are safeguards that reduce risk. Map controls to your risks - you can adopt from frameworks or create custom ones.', complete: d.controls.length >= 3, action: "switchTab('controls')", actionLabel: 'Add Controls', icon: 'bi-shield-check', target: 3, current: d.controls.length },
            { id: 5, title: 'Link Risks to Treatments', desc: 'Document how each risk will be addressed: mitigate with controls, transfer via insurance, accept, or avoid entirely.', complete: d.treatments.length >= 2, action: "switchTab('treatments')", actionLabel: 'Add Treatments', icon: 'bi-bandaid', target: 2, current: d.treatments.length },
            { id: 6, title: 'Test Your Controls', desc: 'Verify controls are working as intended. Document test results and collect evidence for audit readiness.', complete: d.controlTests.length >= 2, action: "switchTab('testing')", actionLabel: 'Test Controls', icon: 'bi-clipboard-check', target: 2, current: d.controlTests.length },
            { id: 7, title: 'Generate Reports', desc: 'Review your GRC program status, export reports, and build your portfolio of completed work.', complete: false, action: "switchTab('reports')", actionLabel: 'View Reports', icon: 'bi-file-earmark-bar-graph' }
        ];
        
        const completedSteps = steps.filter(s => s.complete).length;
        const progressPercent = Math.round((completedSteps / steps.length) * 100);
        const stepColors = ['blue', 'cyan', 'purple', 'green', 'amber', 'red', 'pink'];
        
        c.innerHTML = `
            <style>
                @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
                @keyframes pulse-ring { 0% { transform: scale(0.9); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
                @keyframes gradient-shift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                @keyframes slide-in { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
                @keyframes count-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                .start-hero { background: linear-gradient(135deg, #1e3a8a 0%, #312e81 50%, #581c87 100%); background-size: 200% 200%; animation: gradient-shift 15s ease infinite; padding: 48px; border-radius: 24px; position: relative; overflow: hidden; margin-bottom: 32px; }
                .start-hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 20% 50%, rgba(59,130,246,0.3) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(168,85,247,0.25) 0%, transparent 40%); pointer-events: none; }
                .start-hero-icon { width: 100px; height: 100px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; animation: float 4s ease-in-out infinite; border: 2px solid rgba(255,255,255,0.2); }
                .start-hero-icon i { font-size: 48px; color: white; }
                .start-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 32px; }
                .start-stat-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.15); transition: all 0.3s ease; cursor: pointer; }
                .start-stat-card:hover { background: rgba(255,255,255,0.2); transform: translateY(-4px); }
                .start-stat-value { font-size: 36px; font-weight: 800; color: white; animation: count-up 0.5s ease-out; }
                .start-stat-label { font-size: 13px; color: rgba(255,255,255,0.8); margin-top: 4px; }
                .start-progress-ring { position: relative; width: 200px; height: 200px; margin: 0 auto; }
                .start-progress-ring svg { transform: rotate(-90deg); }
                .start-progress-ring .progress-circle { transition: stroke-dasharray 1s ease; }
                .start-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
                .workflow-visual { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 32px 16px; background: linear-gradient(180deg, var(--bg-surface) 0%, var(--bg-elevated) 100%); border-radius: 16px; margin-bottom: 32px; overflow-x: auto; }
                .workflow-node { display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.3s ease; }
                .workflow-node-icon { width: 64px; height: 64px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; transition: all 0.3s ease; position: relative; }
                .workflow-node-icon.active { box-shadow: 0 0 0 4px rgba(34,197,94,0.3); }
                .workflow-node-icon.active::after { content: ''; position: absolute; inset: -8px; border-radius: 20px; border: 2px solid var(--accent-green); animation: pulse-ring 2s infinite; }
                .workflow-node:hover .workflow-node-icon { transform: scale(1.1); }
                .workflow-node-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
                .workflow-connector { width: 40px; height: 3px; background: linear-gradient(90deg, var(--border-default), var(--accent-blue)); border-radius: 2px; position: relative; }
                .workflow-connector.active { background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); }
                .step-card { background: var(--bg-surface); border-radius: 16px; padding: 24px; margin-bottom: 16px; border: 1px solid var(--border-subtle); transition: all 0.3s ease; animation: slide-in 0.5s ease-out; animation-fill-mode: backwards; position: relative; overflow: hidden; }
                .step-card:nth-child(1) { animation-delay: 0.1s; }
                .step-card:nth-child(2) { animation-delay: 0.2s; }
                .step-card:nth-child(3) { animation-delay: 0.3s; }
                .step-card:nth-child(4) { animation-delay: 0.4s; }
                .step-card:nth-child(5) { animation-delay: 0.5s; }
                .step-card:nth-child(6) { animation-delay: 0.6s; }
                .step-card:nth-child(7) { animation-delay: 0.7s; }
                .step-card:hover { transform: translateX(8px); box-shadow: var(--shadow-lg); border-color: var(--accent-blue); }
                .step-card.completed { border-left: 4px solid var(--accent-green); background: linear-gradient(90deg, var(--accent-green-soft) 0%, var(--bg-surface) 20%); }
                .step-card.completed::before { content: '✓'; position: absolute; top: 16px; right: 16px; width: 28px; height: 28px; background: var(--accent-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
                .step-number { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; flex-shrink: 0; transition: all 0.3s ease; }
                .step-mini-progress { height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; margin-top: 12px; }
                .step-mini-progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
                .tips-card { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 24px; margin-top: 24px; position: relative; overflow: hidden; }
                .tips-card::before { content: '💡'; position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1; }
                .quick-action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 32px; }
                .quick-action-card { background: var(--bg-surface); border-radius: 16px; padding: 24px; text-align: center; border: 2px solid var(--border-subtle); cursor: pointer; transition: all 0.3s ease; }
                .quick-action-card:hover { border-color: var(--accent-blue); transform: translateY(-4px); box-shadow: var(--shadow-lg); }
                .quick-action-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 24px; }
            </style>
            
            <div style="max-width: 1000px; margin: 0 auto;">
                <!-- Hero Section -->
                <div class="start-hero">
                    <div style="position: relative; z-index: 1;">
                        <div class="start-hero-icon">
                            <i class="bi bi-rocket-takeoff-fill"></i>
                        </div>
                        <h1 style="font-size: 36px; font-weight: 800; color: white; text-align: center; margin-bottom: 12px; letter-spacing: -0.02em;">Welcome to GRC Practice Lab</h1>
                        <p style="font-size: 18px; color: rgba(255,255,255,0.85); text-align: center; max-width: 600px; margin: 0 auto; line-height: 1.6;">Build practical GRC skills through hands-on simulations. Follow the steps below to create your first risk management program.</p>
                        
                        <div class="start-stats-grid">
                            <div class="start-stat-card" onclick="app.switchTab('assets')">
                                <div class="start-stat-value">${d.assets.length}</div>
                                <div class="start-stat-label"><i class="bi bi-hdd-stack"></i> Assets</div>
                            </div>
                            <div class="start-stat-card" onclick="app.switchTab('risks')">
                                <div class="start-stat-value">${d.risks.length}</div>
                                <div class="start-stat-label"><i class="bi bi-exclamation-triangle"></i> Risks</div>
                            </div>
                            <div class="start-stat-card" onclick="app.switchTab('controls')">
                                <div class="start-stat-value">${d.controls.length}</div>
                                <div class="start-stat-label"><i class="bi bi-shield-check"></i> Controls</div>
                            </div>
                            <div class="start-stat-card" onclick="app.switchTab('treatments')">
                                <div class="start-stat-value">${d.treatments.length}</div>
                                <div class="start-stat-label"><i class="bi bi-bandaid"></i> Treatments</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Visual Progress Ring -->
                <div class="card" style="margin-bottom: 24px; padding: 32px;">
                    <div style="display: flex; align-items: center; gap: 48px;">
                        <div class="start-progress-ring">
                            <svg viewBox="0 0 100 100" width="200" height="200">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle class="progress-circle" cx="50" cy="50" r="42" fill="none" 
                                    stroke="${progressPercent === 100 ? 'var(--accent-green)' : progressPercent > 50 ? 'var(--accent-blue)' : 'var(--accent-amber)'}" 
                                    stroke-width="10" stroke-linecap="round"
                                    stroke-dasharray="${progressPercent * 2.64} 264"/>
                            </svg>
                            <div class="start-progress-text">
                                <div style="font-size: 48px; font-weight: 800; color: var(--text-primary);">${progressPercent}%</div>
                                <div style="font-size: 14px; color: var(--text-muted);">${completedSteps}/${steps.length} Steps</div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">Your GRC Journey</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6;">Complete each step to build a comprehensive risk management program. Your progress is saved automatically.</p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                ${progressPercent === 0 ? `
                                    <button class="btn btn-primary" onclick="app.loadDemo()" style="padding: 12px 24px;">
                                        <i class="bi bi-lightning-fill"></i> Quick Start with Demo Data
                                    </button>
                                ` : progressPercent < 100 ? `
                                    <button class="btn btn-primary" onclick="app.${steps.find(s => !s.complete)?.action}" style="padding: 12px 24px;">
                                        <i class="bi bi-arrow-right"></i> Continue: ${steps.find(s => !s.complete)?.title}
                                    </button>
                                ` : `
                                    <button class="btn btn-primary" onclick="app.switchTab('portfolio')" style="padding: 12px 24px; background: var(--accent-green);">
                                        <i class="bi bi-trophy-fill"></i> Build Your Portfolio
                                    </button>
                                `}
                                <button class="btn btn-secondary" onclick="app.switchTab('projects')" style="padding: 12px 24px;">
                                    <i class="bi bi-briefcase"></i> Try a Project
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- GRC Workflow Visualization -->
                <div class="workflow-visual">
                    ${[
                        { icon: 'bi-hdd-stack', label: 'Assets', active: d.assets.length > 0, color: 'blue' },
                        { icon: 'bi-exclamation-triangle', label: 'Risks', active: d.risks.length > 0, color: 'red' },
                        { icon: 'bi-shield-check', label: 'Controls', active: d.controls.length > 0, color: 'green' },
                        { icon: 'bi-bandaid', label: 'Treatments', active: d.treatments.length > 0, color: 'purple' },
                        { icon: 'bi-clipboard-check', label: 'Testing', active: d.controlTests.length > 0, color: 'amber' },
                        { icon: 'bi-file-earmark-check', label: 'Evidence', active: d.evidence.length > 0, color: 'cyan' }
                    ].map((node, i, arr) => `
                        <div class="workflow-node" onclick="app.switchTab('${node.label.toLowerCase()}')">
                            <div class="workflow-node-icon ${node.active ? 'active' : ''}" style="background: var(--accent-${node.color}-soft); color: var(--accent-${node.color});">
                                <i class="bi ${node.icon}"></i>
                            </div>
                            <div class="workflow-node-label">${node.label}</div>
                        </div>
                        ${i < arr.length - 1 ? `<div class="workflow-connector ${node.active ? 'active' : ''}"></div>` : ''}
                    `).join('')}
                </div>
                
                <!-- Step-by-Step Guide -->
                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-list-check" style="color: var(--accent-blue);"></i> Step-by-Step Guide
                </h3>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${steps.map((step, i) => `
                        <div class="step-card ${step.complete ? 'completed' : ''}">
                            <div style="display: flex; align-items: flex-start; gap: 20px;">
                                <div class="step-number" style="background: var(--accent-${stepColors[i]}-soft); color: var(--accent-${stepColors[i]});">
                                    ${step.complete ? '<i class="bi bi-check-lg"></i>' : step.id}
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
                                        <h4 style="font-size: 16px; font-weight: 600; margin: 0;">${step.title}</h4>
                                        ${step.complete ? '<span class="badge badge-green">Completed</span>' : ''}
                                    </div>
                                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5; margin-bottom: 12px;">${step.desc}</p>
                                    ${step.target ? `
                                        <div style="display: flex; align-items: center; gap: 16px;">
                                            <div class="step-mini-progress" style="flex: 1; max-width: 200px;">
                                                <div class="step-mini-progress-fill" style="width: ${Math.min(100, (step.current/step.target)*100)}%; background: var(--accent-${stepColors[i]});"></div>
                                            </div>
                                            <span style="font-size: 13px; font-weight: 600; color: var(--accent-${stepColors[i]});">${step.current}/${step.target}</span>
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                                        <button class="btn ${step.complete ? 'btn-secondary' : 'btn-primary'} btn-sm" onclick="app.${step.action}">
                                            <i class="bi ${step.icon}"></i> ${step.complete ? 'Review' : step.actionLabel}
                                        </button>
                                        ${step.id === 4 ? `<button class="btn btn-secondary btn-sm" onclick="app.switchTab('frameworks')"><i class="bi bi-journal-code"></i> Browse Frameworks</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Pro Tips -->
                <div class="tips-card">
                    <h4 style="font-size: 16px; font-weight: 700; color: #92400e; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-lightbulb-fill"></i> Pro Tips for GRC Success
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 32px; height: 32px; background: rgba(146, 64, 14, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="bi bi-1-circle-fill" style="color: #92400e;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 2px;">Start with assets</div>
                                <div style="font-size: 13px; color: #78350f;">You can't protect what you don't know. List your critical systems first.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 32px; height: 32px; background: rgba(146, 64, 14, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="bi bi-2-circle-fill" style="color: #92400e;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 2px;">Think like an attacker</div>
                                <div style="font-size: 13px; color: #78350f;">Ask "What could go wrong?" and "What's the worst case?"</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 32px; height: 32px; background: rgba(146, 64, 14, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="bi bi-3-circle-fill" style="color: #92400e;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 2px;">Use frameworks</div>
                                <div style="font-size: 13px; color: #78350f;">Don't reinvent the wheel. Adopt controls from ISO 27001, NIST, or SOC 2.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 32px; height: 32px; background: rgba(146, 64, 14, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="bi bi-4-circle-fill" style="color: #92400e;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 2px;">Document everything</div>
                                <div style="font-size: 13px; color: #78350f;">Evidence and audit trails are what auditors want to see.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-action-grid">
                    <div class="quick-action-card" onclick="app.switchTab('projects')">
                        <div class="quick-action-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);">
                            <i class="bi bi-briefcase-fill"></i>
                        </div>
                        <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">Real-World Projects</div>
                        <div style="font-size: 13px; color: var(--text-muted);">12 industry scenarios to practice</div>
                    </div>
                    <div class="quick-action-card" onclick="app.switchTab('frameworks')">
                        <div class="quick-action-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);">
                            <i class="bi bi-journal-code"></i>
                        </div>
                        <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">Framework Library</div>
                        <div style="font-size: 13px; color: var(--text-muted);">480+ controls from 10 frameworks</div>
                    </div>
                    <div class="quick-action-card" onclick="app.switchTab('scenarios')">
                        <div class="quick-action-icon" style="background: var(--accent-green-soft); color: var(--accent-green);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                        <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">Practice Scenarios</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Guided exercises with feedback</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ===== GLOSSARY =====
    renderGlossary() {
        const c = document.getElementById('tab-glossary');
        const terms = [
            // Core GRC Concepts (A-Z)
            { term: 'Access Control', def: 'Security measures that regulate who can view or use resources in a computing environment, including authentication, authorization, and accountability mechanisms.', category: 'Security' },
            { term: 'Accountability', def: 'The obligation to accept responsibility for one\'s actions and decisions. In GRC, it ensures individuals are answerable for their role in risk management and compliance.', category: 'Governance' },
            { term: 'Accreditation', def: 'Formal recognition that an organization meets specific standards or requirements, often granted by an authoritative body after assessment.', category: 'Compliance' },
            { term: 'ALE (Annual Loss Expectancy)', def: 'A risk metric calculated as SLE × ARO, representing the expected monetary loss from a risk over one year.', category: 'Risk' },
            { term: 'APT (Advanced Persistent Threat)', def: 'A sophisticated, long-term cyberattack in which an intruder gains access to a network and remains undetected for an extended period to steal data.', category: 'Security' },
            { term: 'ARO (Annualized Rate of Occurrence)', def: 'The estimated frequency with which a threat is expected to occur within a year, used in quantitative risk analysis.', category: 'Risk' },
            { term: 'Asset', def: 'Anything of value to an organization including data, systems, personnel, intellectual property, and physical resources that needs protection.', category: 'Security' },
            { term: 'Attestation', def: 'A formal declaration or certification that a statement, report, or condition is true, typically provided by an independent auditor.', category: 'Compliance' },
            { term: 'Audit', def: 'A systematic, independent examination of records, processes, and controls to determine compliance with policies, standards, and regulations.', category: 'Compliance' },
            { term: 'Audit Committee', def: 'A committee of a company\'s board of directors responsible for oversight of financial reporting, internal controls, and external auditor relationships.', category: 'Governance' },
            { term: 'Audit Trail', def: 'A chronological record of system activities that enables reconstruction of events related to security-relevant transactions and actions.', category: 'Compliance' },
            { term: 'Authentication', def: 'The process of verifying the identity of a user, system, or entity before granting access to resources.', category: 'Security' },
            { term: 'Authorization', def: 'The process of granting or denying access rights and permissions to resources based on authenticated identity.', category: 'Security' },
            { term: 'Availability', def: 'The property of being accessible and usable on demand by an authorized entity. One of the three pillars of the CIA triad.', category: 'Security' },
            { term: 'BAA (Business Associate Agreement)', def: 'A HIPAA-required contract between a covered entity and a business associate that handles PHI, ensuring proper safeguards.', category: 'Compliance' },
            { term: 'Baseline', def: 'A minimum set of security controls or configurations that must be implemented across systems to ensure consistent security posture.', category: 'Security' },
            { term: 'BCP (Business Continuity Plan)', def: 'A documented plan describing how an organization will continue critical functions during and after a disaster or disruption.', category: 'Resilience' },
            { term: 'BIA (Business Impact Analysis)', def: 'An assessment that identifies critical business functions, their dependencies, and the potential impact of disruption.', category: 'Resilience' },
            { term: 'Board of Directors', def: 'The governing body elected by shareholders to oversee management and make major decisions, including risk oversight and compliance strategy.', category: 'Governance' },
            { term: 'Breach', def: 'An incident that results in unauthorized access, disclosure, or loss of sensitive data or compromise of security controls.', category: 'Security' },
            { term: 'BYOD (Bring Your Own Device)', def: 'A policy allowing employees to use personal devices for work, requiring specific security controls and risk management.', category: 'Security' },
            { term: 'CAP (Corrective Action Plan)', def: 'A documented plan describing steps to address audit findings, control deficiencies, or compliance gaps with timelines and owners.', category: 'Compliance' },
            { term: 'CCPA (California Consumer Privacy Act)', def: 'California state privacy law granting consumers rights over their personal data and imposing obligations on businesses handling such data.', category: 'Privacy' },
            { term: 'CDR (Critical Detection and Response)', def: 'Security operations capability focused on identifying and responding to critical threats and security incidents.', category: 'Security' },
            { term: 'CIA Triad', def: 'The three core principles of information security: Confidentiality, Integrity, and Availability.', category: 'Security' },
            { term: 'CIS Controls', def: 'A prioritized set of cybersecurity best practices from the Center for Internet Security, formerly known as SANS Top 20.', category: 'Framework' },
            { term: 'CISO (Chief Information Security Officer)', def: 'Executive responsible for establishing and maintaining enterprise vision, strategy, and program to protect information assets.', category: 'Governance' },
            { term: 'CMMC (Cybersecurity Maturity Model Certification)', def: 'DoD framework measuring cybersecurity maturity of defense contractors across five levels.', category: 'Framework' },
            { term: 'COBIT', def: 'Control Objectives for Information and Related Technologies - a framework for IT governance and management from ISACA.', category: 'Framework' },
            { term: 'Compensating Control', def: 'An alternative control implemented when the primary control cannot be met, providing equivalent risk reduction.', category: 'Security' },
            { term: 'Compliance', def: 'The state of conforming to laws, regulations, standards, policies, and contractual obligations applicable to the organization.', category: 'Compliance' },
            { term: 'Compliance Risk', def: 'The potential for legal penalties, financial forfeiture, or reputational damage resulting from failure to comply with requirements.', category: 'Risk' },
            { term: 'Confidentiality', def: 'The property that information is not disclosed to unauthorized individuals, entities, or processes. Part of the CIA triad.', category: 'Security' },
            { term: 'Configuration Management', def: 'The process of systematically handling changes to systems to maintain integrity over time, including baseline standards.', category: 'Security' },
            { term: 'Continuous Monitoring', def: 'Ongoing awareness of information security, vulnerabilities, and threats to support organizational risk management decisions.', category: 'Security' },
            { term: 'Control', def: 'A safeguard or countermeasure designed to avoid, detect, counteract, or minimize security risks and compliance gaps.', category: 'Security' },
            { term: 'Control Effectiveness', def: 'The degree to which a control achieves its intended objective in reducing risk or ensuring compliance.', category: 'Security' },
            { term: 'Control Environment', def: 'The set of standards, processes, and structures that provide the basis for carrying out internal control across the organization.', category: 'Governance' },
            { term: 'Control Framework', def: 'A structured set of controls and guidelines that organizations use to manage risks and ensure compliance (e.g., NIST, ISO 27001).', category: 'Framework' },
            { term: 'Control Gap', def: 'A deficiency where a required control is missing, not implemented, or not operating effectively.', category: 'Security' },
            { term: 'Control Objective', def: 'A statement of the desired result or purpose to be achieved by implementing a control.', category: 'Security' },
            { term: 'Control Owner', def: 'The individual responsible for ensuring a control is properly designed, implemented, and operating effectively.', category: 'Governance' },
            { term: 'Control Testing', def: 'Procedures to evaluate whether controls are designed appropriately and operating effectively as intended.', category: 'Compliance' },
            { term: 'Corrective Control', def: 'A control designed to correct or remedy issues after an incident or error has occurred.', category: 'Security' },
            { term: 'COSO', def: 'Committee of Sponsoring Organizations - framework for enterprise risk management and internal control.', category: 'Framework' },
            { term: 'Crown Jewels', def: 'The most critical and valuable assets of an organization that require the highest level of protection.', category: 'Security' },
            { term: 'Cyber Insurance', def: 'Insurance coverage designed to protect businesses from internet-based risks and cyber incidents.', category: 'Risk' },
            { term: 'Cyber Risk', def: 'The potential for financial loss, disruption, or reputational damage from cyber threats and vulnerabilities.', category: 'Risk' },
            { term: 'Data Classification', def: 'The process of categorizing data based on sensitivity level (e.g., Public, Internal, Confidential, Restricted) to apply appropriate controls.', category: 'Security' },
            { term: 'Data Controller', def: 'Under GDPR, the entity that determines the purposes and means of processing personal data.', category: 'Privacy' },
            { term: 'Data Governance', def: 'The management of data availability, usability, integrity, and security across an organization.', category: 'Governance' },
            { term: 'Data Processor', def: 'Under GDPR, an entity that processes personal data on behalf of the data controller.', category: 'Privacy' },
            { term: 'Data Protection', def: 'Security measures and policies implemented to safeguard data from unauthorized access, corruption, or loss.', category: 'Security' },
            { term: 'Data Retention', def: 'Policies defining how long data is kept and when it must be destroyed, based on legal and business requirements.', category: 'Compliance' },
            { term: 'Defense in Depth', def: 'A security strategy employing multiple layers of controls to protect information and systems.', category: 'Security' },
            { term: 'Detective Control', def: 'A control designed to identify and detect when unwanted events, errors, or incidents have occurred.', category: 'Security' },
            { term: 'DLP (Data Loss Prevention)', def: 'Tools and processes to detect and prevent unauthorized data exfiltration or leakage.', category: 'Security' },
            { term: 'DPIA (Data Protection Impact Assessment)', def: 'GDPR-required assessment for processing activities likely to result in high risk to individuals\' rights and freedoms.', category: 'Privacy' },
            { term: 'DR (Disaster Recovery)', def: 'The process, policies, and procedures for recovering IT infrastructure and systems after a catastrophic event.', category: 'Resilience' },
            { term: 'DRP (Disaster Recovery Plan)', def: 'A documented process describing how to recover technology infrastructure and services after a disaster.', category: 'Resilience' },
            { term: 'Due Care', def: 'The effort made by a reasonable person to avoid harm to another party, demonstrating responsibility and prudence.', category: 'Governance' },
            { term: 'Due Diligence', def: 'The investigation or research done before making a decision, such as evaluating a vendor\'s security posture.', category: 'Governance' },
            { term: 'ERM (Enterprise Risk Management)', def: 'A holistic approach to identifying, assessing, and managing risks across the entire organization.', category: 'Risk' },
            { term: 'Escalation', def: 'The process of bringing an issue to higher levels of management when it exceeds defined thresholds or cannot be resolved at current level.', category: 'Governance' },
            { term: 'Exception', def: 'A formal approval to deviate from a policy or control requirement, typically with compensating controls and time limits.', category: 'Compliance' },
            { term: 'FAIR (Factor Analysis of Information Risk)', def: 'A quantitative risk analysis framework that defines risk in terms of probable frequency and magnitude of loss.', category: 'Framework' },
            { term: 'FedRAMP', def: 'Federal Risk and Authorization Management Program - US government program for cloud security authorization.', category: 'Framework' },
            { term: 'Finding', def: 'An identified weakness, deficiency, or non-compliance issue discovered during an audit or assessment.', category: 'Compliance' },
            { term: 'First Line of Defense', def: 'In the Three Lines Model, operational management responsible for maintaining internal controls and executing risk procedures.', category: 'Governance' },
            { term: 'Framework', def: 'A structured set of standards, guidelines, and best practices for organizing and prioritizing security and compliance activities.', category: 'Framework' },
            { term: 'Gap Analysis', def: 'A comparison between current state and desired state to identify what is needed to bridge the difference.', category: 'Compliance' },
            { term: 'GDPR (General Data Protection Regulation)', def: 'EU regulation protecting the personal data and privacy of EU residents, with extraterritorial scope.', category: 'Privacy' },
            { term: 'Governance', def: 'The framework of rules, relationships, systems, and processes by which authority is exercised and controlled in organizations.', category: 'Governance' },
            { term: 'GRC', def: 'Governance, Risk, and Compliance - an integrated approach to achieving reliable objectives, addressing uncertainty, and acting with integrity.', category: 'Core' },
            { term: 'Heat Map', def: 'A visual representation of risk data where values are depicted using color gradients, commonly used in risk matrices.', category: 'Risk' },
            { term: 'HIPAA', def: 'Health Insurance Portability and Accountability Act - US law protecting sensitive patient health information.', category: 'Compliance' },
            { term: 'IAM (Identity and Access Management)', def: 'The discipline of managing digital identities and controlling access to resources within an organization.', category: 'Security' },
            { term: 'ICS (Industrial Control Systems)', def: 'Systems used to control industrial processes such as manufacturing, power generation, and water treatment.', category: 'Security' },
            { term: 'Impact', def: 'The effect or consequence that a risk event would have on objectives if it materialized.', category: 'Risk' },
            { term: 'Incident', def: 'An event that actually or potentially jeopardizes the confidentiality, integrity, or availability of information systems.', category: 'Security' },
            { term: 'Incident Response', def: 'The organized approach to addressing and managing the aftermath of a security breach or cyberattack.', category: 'Security' },
            { term: 'Indicator of Compromise (IOC)', def: 'Evidence that suggests a system has been compromised or attacked, such as unusual network traffic or file changes.', category: 'Security' },
            { term: 'Information Security', def: 'The practice of protecting information by mitigating risks related to unauthorized access, use, disclosure, or destruction.', category: 'Security' },
            { term: 'Inherent Risk', def: 'The level of risk that exists in the absence of any controls or mitigating factors.', category: 'Risk' },
            { term: 'Integrity', def: 'The property that data has not been altered in an unauthorized manner. One of the three pillars of the CIA triad.', category: 'Security' },
            { term: 'Internal Audit', def: 'An independent function that provides assurance and consulting services to improve operations and governance.', category: 'Compliance' },
            { term: 'Internal Control', def: 'A process designed to provide reasonable assurance regarding achievement of objectives in operations, reporting, and compliance.', category: 'Governance' },
            { term: 'IRM (Integrated Risk Management)', def: 'A set of practices and processes for managing risks across the enterprise in a coordinated manner.', category: 'Risk' },
            { term: 'ISO 22301', def: 'International standard specifying requirements for a business continuity management system.', category: 'Framework' },
            { term: 'ISO 27001', def: 'International standard for information security management systems (ISMS), specifying requirements for establishing, implementing, and improving security.', category: 'Framework' },
            { term: 'ISO 27002', def: 'Code of practice providing guidelines for organizational information security standards and management practices.', category: 'Framework' },
            { term: 'ISO 27005', def: 'International standard providing guidelines for information security risk management.', category: 'Framework' },
            { term: 'ISO 31000', def: 'International standard providing principles and guidelines for risk management applicable to any organization.', category: 'Framework' },
            { term: 'Issue', def: 'A problem, concern, or matter requiring attention and resolution, often tracked alongside risks and findings.', category: 'Compliance' },
            { term: 'IT General Controls (ITGC)', def: 'Controls that support the operation and security of IT systems, including access, change management, and operations.', category: 'Security' },
            { term: 'KPI (Key Performance Indicator)', def: 'A measurable value demonstrating how effectively an organization is achieving key business objectives.', category: 'Governance' },
            { term: 'KRI (Key Risk Indicator)', def: 'A metric used to provide early warning signals about increasing risk exposures.', category: 'Risk' },
            { term: 'Least Privilege', def: 'The principle of providing only the minimum access rights necessary for users to perform their job functions.', category: 'Security' },
            { term: 'Likelihood', def: 'The probability or chance that a risk event will occur, typically rated on a scale (e.g., 1-5).', category: 'Risk' },
            { term: 'Logging', def: 'The process of recording events that occur in an operating system or application for monitoring and analysis.', category: 'Security' },
            { term: 'MAD (Maximum Allowable Downtime)', def: 'The longest period a business function can be unavailable before causing unacceptable consequences.', category: 'Resilience' },
            { term: 'Malware', def: 'Malicious software designed to harm, exploit, or otherwise compromise computer systems and networks.', category: 'Security' },
            { term: 'Management Override', def: 'The ability of management to circumvent controls, which represents a significant risk in any organization.', category: 'Governance' },
            { term: 'Materiality', def: 'The threshold above which missing or incorrect information could influence decisions of users of financial statements or compliance reports.', category: 'Compliance' },
            { term: 'MFA (Multi-Factor Authentication)', def: 'Authentication requiring two or more verification factors to gain access, enhancing security beyond passwords alone.', category: 'Security' },
            { term: 'MITRE ATT&CK', def: 'A knowledge base of adversary tactics and techniques based on real-world observations of cyberattacks.', category: 'Framework' },
            { term: 'MTBF (Mean Time Between Failures)', def: 'The average time between system failures, used to measure reliability.', category: 'Resilience' },
            { term: 'MTTR (Mean Time to Repair)', def: 'The average time required to repair a failed component or restore a system after failure.', category: 'Resilience' },
            { term: 'Need-to-Know', def: 'A security principle that access to sensitive information should be limited to those who require it for their duties.', category: 'Security' },
            { term: 'NIST', def: 'National Institute of Standards and Technology - US agency that develops cybersecurity frameworks and standards.', category: 'Framework' },
            { term: 'NIST CSF', def: 'NIST Cybersecurity Framework - a voluntary framework consisting of standards, guidelines, and practices to manage cybersecurity risk.', category: 'Framework' },
            { term: 'NIST SP 800-53', def: 'Security and Privacy Controls for Information Systems and Organizations - comprehensive catalog of security controls.', category: 'Framework' },
            { term: 'Non-Repudiation', def: 'The assurance that someone cannot deny the validity of their actions or transactions.', category: 'Security' },
            { term: 'Observation', def: 'A noted condition during an audit that may not rise to the level of a finding but warrants management attention.', category: 'Compliance' },
            { term: 'Operational Risk', def: 'The risk of loss resulting from inadequate or failed internal processes, people, systems, or external events.', category: 'Risk' },
            { term: 'Patch Management', def: 'The process of identifying, acquiring, testing, and installing software updates to address vulnerabilities.', category: 'Security' },
            { term: 'PCI DSS', def: 'Payment Card Industry Data Security Standard - security standard for organizations handling credit card data.', category: 'Framework' },
            { term: 'Penetration Testing', def: 'Authorized simulated cyberattacks to evaluate the security of systems and identify vulnerabilities.', category: 'Security' },
            { term: 'PHI (Protected Health Information)', def: 'Under HIPAA, individually identifiable health information transmitted or maintained in any form.', category: 'Privacy' },
            { term: 'PII (Personally Identifiable Information)', def: 'Information that can be used to identify, contact, or locate an individual, requiring protection under privacy laws.', category: 'Privacy' },
            { term: 'Policy', def: 'A high-level statement of management intent, direction, and expectations regarding a specific topic.', category: 'Governance' },
            { term: 'POA&M (Plan of Action and Milestones)', def: 'A document identifying tasks needed to remedy security weaknesses, with resources, timelines, and milestones.', category: 'Compliance' },
            { term: 'Preventive Control', def: 'A control designed to deter or prevent unwanted events from occurring in the first place.', category: 'Security' },
            { term: 'Privacy', def: 'The right of individuals to control their personal information and how it is collected, used, and disclosed.', category: 'Privacy' },
            { term: 'Privacy by Design', def: 'An approach requiring privacy to be considered throughout the engineering process and system lifecycle.', category: 'Privacy' },
            { term: 'Privacy Impact Assessment', def: 'An analysis of how personal information is collected, used, shared, and maintained to ensure privacy protection.', category: 'Privacy' },
            { term: 'Procedure', def: 'A detailed, step-by-step description of how to perform a specific task or process.', category: 'Governance' },
            { term: 'Qualitative Risk Analysis', def: 'Risk assessment using descriptive scales (e.g., Low/Medium/High) rather than numeric values.', category: 'Risk' },
            { term: 'Quantitative Risk Analysis', def: 'Risk assessment using numeric values to calculate probability and impact, often expressed in monetary terms.', category: 'Risk' },
            { term: 'RACI Matrix', def: 'A responsibility assignment matrix defining who is Responsible, Accountable, Consulted, and Informed for each task.', category: 'Governance' },
            { term: 'Ransomware', def: 'Malware that encrypts files and demands payment for the decryption key.', category: 'Security' },
            { term: 'Reasonable Assurance', def: 'A high but not absolute level of assurance that objectives will be achieved, recognizing inherent limitations.', category: 'Compliance' },
            { term: 'Regulatory Compliance', def: 'Adherence to laws, regulations, guidelines, and specifications relevant to the organization\'s business.', category: 'Compliance' },
            { term: 'Remediation', def: 'The process of correcting a deficiency, vulnerability, or non-compliance issue.', category: 'Compliance' },
            { term: 'Reputational Risk', def: 'The potential for negative publicity, public perception, or events to adversely impact an organization\'s standing.', category: 'Risk' },
            { term: 'Residual Risk', def: 'The risk that remains after controls have been applied. Must be within risk appetite to be acceptable.', category: 'Risk' },
            { term: 'Resilience', def: 'The ability of an organization to anticipate, prepare for, respond to, and adapt to change and disruption.', category: 'Resilience' },
            { term: 'Risk', def: 'The effect of uncertainty on objectives, often expressed as a combination of likelihood and impact.', category: 'Risk' },
            { term: 'Risk Acceptance', def: 'A risk treatment option where the organization acknowledges a risk and decides to retain it without further action.', category: 'Risk' },
            { term: 'Risk Appetite', def: 'The amount and type of risk an organization is willing to pursue or retain in pursuit of its objectives.', category: 'Risk' },
            { term: 'Risk Assessment', def: 'The overall process of risk identification, risk analysis, and risk evaluation.', category: 'Risk' },
            { term: 'Risk Avoidance', def: 'A risk treatment option where activities giving rise to the risk are discontinued or not undertaken.', category: 'Risk' },
            { term: 'Risk Matrix', def: 'A visual tool plotting risks by likelihood and impact to prioritize risk response activities.', category: 'Risk' },
            { term: 'Risk Mitigation', def: 'Actions taken to reduce the likelihood or impact of a risk to acceptable levels.', category: 'Risk' },
            { term: 'Risk Owner', def: 'An individual or entity with accountability and authority to manage a specific risk.', category: 'Risk' },
            { term: 'Risk Register', def: 'A document or system recording identified risks along with their analysis, treatment plans, and status.', category: 'Risk' },
            { term: 'Risk Tolerance', def: 'The acceptable variation in outcomes relative to achieving objectives; boundaries of acceptable risk.', category: 'Risk' },
            { term: 'Risk Transfer', def: 'Shifting the impact of a risk to a third party, such as through insurance or outsourcing.', category: 'Risk' },
            { term: 'Risk Treatment', def: 'The process of selecting and implementing measures to modify risk (Accept, Mitigate, Transfer, Avoid).', category: 'Risk' },
            { term: 'RMF (Risk Management Framework)', def: 'NIST\'s approach to integrating security and risk management into the system development lifecycle.', category: 'Framework' },
            { term: 'RPA (Robotic Process Automation)', def: 'Technology using software robots to automate routine tasks, creating new control and risk considerations.', category: 'Security' },
            { term: 'RPO (Recovery Point Objective)', def: 'The maximum acceptable amount of data loss measured in time; how much data can be lost before business impact.', category: 'Resilience' },
            { term: 'RTO (Recovery Time Objective)', def: 'The maximum acceptable time to restore a system or business process after a disaster.', category: 'Resilience' },
            { term: 'SABSA', def: 'Sherwood Applied Business Security Architecture - a framework for enterprise security architecture.', category: 'Framework' },
            { term: 'SDLC (Software Development Lifecycle)', def: 'The process of planning, creating, testing, and deploying software, with security integrated throughout.', category: 'Security' },
            { term: 'Second Line of Defense', def: 'In the Three Lines Model, risk management and compliance functions that provide oversight and expertise.', category: 'Governance' },
            { term: 'Security Awareness Training', def: 'Programs designed to educate employees about security threats, policies, and best practices.', category: 'Security' },
            { term: 'Security Control', def: 'A safeguard or countermeasure prescribed for an information system to protect the CIA of information.', category: 'Security' },
            { term: 'Segregation of Duties (SoD)', def: 'Dividing responsibilities among different people to reduce risk of error or inappropriate actions.', category: 'Security' },
            { term: 'SIEM (Security Information and Event Management)', def: 'Technology providing real-time analysis of security alerts generated by applications and network hardware.', category: 'Security' },
            { term: 'SLA (Service Level Agreement)', def: 'A contract defining the expected level of service, including availability, performance, and support.', category: 'Governance' },
            { term: 'SLE (Single Loss Expectancy)', def: 'The monetary value expected to be lost if a risk event occurs once, used in quantitative risk analysis.', category: 'Risk' },
            { term: 'SOA (Statement of Applicability)', def: 'A document listing all controls from a framework with their applicability status and justification.', category: 'Compliance' },
            { term: 'SOC 1', def: 'Service Organization Control report focused on controls relevant to user entities\' internal control over financial reporting.', category: 'Compliance' },
            { term: 'SOC 2', def: 'Service Organization Control report on controls relevant to security, availability, processing integrity, confidentiality, or privacy.', category: 'Compliance' },
            { term: 'SOC 3', def: 'A public version of the SOC 2 report that can be freely distributed for marketing purposes.', category: 'Compliance' },
            { term: 'SOX (Sarbanes-Oxley Act)', def: 'US law mandating certain practices in financial record keeping and reporting for public companies.', category: 'Compliance' },
            { term: 'SSAE 18', def: 'Statement on Standards for Attestation Engagements - the standard governing SOC examinations.', category: 'Compliance' },
            { term: 'Stakeholder', def: 'Any party that has an interest in, or may be affected by, the organization\'s activities or decisions.', category: 'Governance' },
            { term: 'Standard', def: 'Mandatory requirements providing specific implementation guidance for policies.', category: 'Governance' },
            { term: 'Strategic Risk', def: 'Risks that affect or are created by business strategy decisions and strategic objectives.', category: 'Risk' },
            { term: 'Tabletop Exercise', def: 'A discussion-based exercise to validate plans and procedures by walking through a simulated incident scenario.', category: 'Resilience' },
            { term: 'Technical Control', def: 'A control implemented through technology, such as firewalls, encryption, or access control systems.', category: 'Security' },
            { term: 'Third Line of Defense', def: 'In the Three Lines Model, internal audit providing independent assurance on governance and risk management.', category: 'Governance' },
            { term: 'Third-Party Risk', def: 'Risk arising from the organization\'s reliance on external parties such as vendors, suppliers, and partners.', category: 'Risk' },
            { term: 'Threat', def: 'Any potential cause of an unwanted incident that could result in harm to a system or organization.', category: 'Security' },
            { term: 'Threat Actor', def: 'An individual or group that poses a threat to an organization, including hackers, insiders, and nation-states.', category: 'Security' },
            { term: 'Threat Intelligence', def: 'Evidence-based knowledge about existing or emerging threats to inform security decisions.', category: 'Security' },
            { term: 'Threat Modeling', def: 'A structured approach for identifying and prioritizing potential threats and determining mitigations.', category: 'Security' },
            { term: 'TPRM (Third-Party Risk Management)', def: 'The process of identifying, assessing, and controlling risks associated with third-party relationships.', category: 'Risk' },
            { term: 'Trust Services Criteria (TSC)', def: 'AICPA criteria for evaluating controls relevant to security, availability, processing integrity, confidentiality, and privacy.', category: 'Framework' },
            { term: 'Vulnerability', def: 'A weakness in a system that could be exploited by a threat to cause harm.', category: 'Security' },
            { term: 'Vulnerability Assessment', def: 'The process of identifying, quantifying, and prioritizing vulnerabilities in systems.', category: 'Security' },
            { term: 'Walkthrough', def: 'A review technique where an auditor traces a transaction through the system to understand controls.', category: 'Compliance' },
            { term: 'Zero Trust', def: 'A security model based on "never trust, always verify" - requiring strict identity verification for every access request.', category: 'Security' }
        ];
        
        // Group terms by category
        const categories = [...new Set(terms.map(t => t.category))].sort();
        const selectedCat = this.glossaryFilter || 'all';
        const searchTerm = (this.glossarySearch || '').toLowerCase();
        
        // Filter terms
        let filteredTerms = terms;
        if (selectedCat !== 'all') {
            filteredTerms = filteredTerms.filter(t => t.category === selectedCat);
        }
        if (searchTerm) {
            filteredTerms = filteredTerms.filter(t => 
                t.term.toLowerCase().includes(searchTerm) || 
                t.def.toLowerCase().includes(searchTerm)
            );
        }
        
        const categoryColors = {
            'Core': 'blue', 'Governance': 'purple', 'Risk': 'red', 'Compliance': 'green',
            'Security': 'amber', 'Framework': 'cyan', 'Privacy': 'pink', 'Resilience': 'green'
        };
        
        c.innerHTML = `
            <div style="max-width: 1100px; margin: 0 auto;">
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-book" style="color: var(--accent-blue);"></i> GRC Glossary
                                <span class="badge badge-blue" style="font-size: 12px;">${terms.length} Terms</span>
                            </h2>
                            <p style="color: var(--text-muted); max-width: 600px;">Comprehensive reference of essential GRC terminology. Master these terms to communicate effectively with auditors, executives, and security teams.</p>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="position: relative;">
                                <i class="bi bi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                                <input type="text" class="form-input" placeholder="Search terms..." value="${this.glossarySearch || ''}"
                                    style="padding-left: 36px; width: 220px;" 
                                    oninput="app.glossarySearch = this.value; app.renderGlossary();">
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportGlossary()"><i class="bi bi-download"></i> Export</button>
                        </div>
                    </div>
                </div>
                
                <!-- Category Filter -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body" style="padding: 14px 16px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                            <span style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-right: 8px;">Filter by Category:</span>
                            <button class="btn btn-sm ${selectedCat === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="app.glossaryFilter = 'all'; app.renderGlossary();">All (${terms.length})</button>
                            ${categories.map(cat => `
                                <button class="btn btn-sm ${selectedCat === cat ? 'btn-primary' : 'btn-secondary'}" onclick="app.glossaryFilter = '${cat}'; app.renderGlossary();">
                                    ${cat} (${terms.filter(t => t.category === cat).length})
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Results Count -->
                <div style="margin-bottom: 16px; font-size: 13px; color: var(--text-muted);">
                    Showing ${filteredTerms.length} of ${terms.length} terms
                    ${searchTerm ? ` matching "${searchTerm}"` : ''}
                    ${selectedCat !== 'all' ? ` in ${selectedCat}` : ''}
                </div>
                
                <!-- Terms Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                    ${filteredTerms.map(t => `
                        <div class="card" style="cursor: pointer; transition: all 0.2s;" 
                            onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='var(--shadow-lg)'" 
                            onmouseout="this.style.transform='none';this.style.boxShadow='none'"
                            onclick="app.showGlossaryDetail('${t.term.replace(/'/g, "\\'")}')">
                            <div class="card-body" style="padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div style="font-size: 15px; font-weight: 700; color: var(--accent-blue);">${t.term}</div>
                                    <span class="badge badge-${categoryColors[t.category] || 'gray'}" style="font-size: 10px;">${t.category}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${t.def}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${filteredTerms.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="bi bi-search" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                        <p>No terms found matching your criteria</p>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="app.glossaryFilter = 'all'; app.glossarySearch = ''; app.renderGlossary();">Reset Filters</button>
                    </div>
                ` : ''}
                
                <!-- Quick Reference Section -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--accent-blue-soft), transparent);">
                        <span style="font-weight: 600;"><i class="bi bi-lightbulb"></i> Quick Reference: Key Acronyms</span>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">
                            ${[
                                { abbr: 'GRC', full: 'Governance, Risk & Compliance' },
                                { abbr: 'CIA', full: 'Confidentiality, Integrity, Availability' },
                                { abbr: 'ISMS', full: 'Information Security Management System' },
                                { abbr: 'ERM', full: 'Enterprise Risk Management' },
                                { abbr: 'BIA', full: 'Business Impact Analysis' },
                                { abbr: 'RTO', full: 'Recovery Time Objective' },
                                { abbr: 'RPO', full: 'Recovery Point Objective' },
                                { abbr: 'TPRM', full: 'Third-Party Risk Management' },
                                { abbr: 'SOC', full: 'Service Organization Control' },
                                { abbr: 'NIST', full: 'National Institute of Standards & Technology' },
                                { abbr: 'GDPR', full: 'General Data Protection Regulation' },
                                { abbr: 'PCI DSS', full: 'Payment Card Industry Data Security Standard' }
                            ].map(a => `
                                <div style="display: flex; gap: 8px; align-items: baseline; padding: 8px 12px; background: var(--bg-elevated); border-radius: var(--radius-sm);">
                                    <span style="font-weight: 700; color: var(--accent-blue); font-size: 13px; white-space: nowrap;">${a.abbr}</span>
                                    <span style="font-size: 11px; color: var(--text-muted);">${a.full}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    showGlossaryDetail(term) {
        const terms = this.getGlossaryTerms();
        const t = terms.find(x => x.term === term);
        if (!t) return;
        
        // Find related terms
        const keywords = t.def.toLowerCase().split(' ').filter(w => w.length > 4);
        const related = terms.filter(x => 
            x.term !== t.term && 
            (x.category === t.category || keywords.some(k => x.def.toLowerCase().includes(k)))
        ).slice(0, 5);
        
        const categoryColors = {
            'Core': 'blue', 'Governance': 'purple', 'Risk': 'red', 'Compliance': 'green',
            'Security': 'amber', 'Framework': 'cyan', 'Privacy': 'pink', 'Resilience': 'green'
        };
        
        openModal('Glossary Term', `
            <div style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <h3 style="font-size: 24px; font-weight: 700; color: var(--accent-blue); margin: 0;">${t.term}</h3>
                    <span class="badge badge-${categoryColors[t.category] || 'gray'}">${t.category}</span>
                </div>
                <p style="font-size: 15px; line-height: 1.7; color: var(--text-secondary);">${t.def}</p>
            </div>
            
            ${related.length > 0 ? `
                <div style="padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px;">Related Terms</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${related.map(r => `
                            <span class="badge badge-gray" style="cursor: pointer; padding: 6px 12px;" onclick="closeModal(); setTimeout(() => app.showGlossaryDetail('${r.term.replace(/'/g, "\\'")}'), 100);">
                                ${r.term}
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${t.term}: ${t.def.replace(/'/g, "\\'")}'); app.toast('Copied to clipboard!', 'success');">
                <i class="bi bi-clipboard"></i> Copy Definition
            </button>
        `);
    }
    
    getGlossaryTerms() {
        return [
            { term: 'GRC', def: 'Governance, Risk, and Compliance - an integrated approach to achieving reliable objectives, addressing uncertainty, and acting with integrity.', category: 'Core' },
            { term: 'Risk', def: 'The effect of uncertainty on objectives, often expressed as a combination of likelihood and impact.', category: 'Risk' },
            { term: 'Control', def: 'A safeguard or countermeasure designed to avoid, detect, counteract, or minimize security risks and compliance gaps.', category: 'Security' },
            { term: 'Compliance', def: 'The state of conforming to laws, regulations, standards, policies, and contractual obligations applicable to the organization.', category: 'Compliance' },
            { term: 'Governance', def: 'The framework of rules, relationships, systems, and processes by which authority is exercised and controlled in organizations.', category: 'Governance' }
        ];
    }
    
    exportGlossary() {
        const terms = this.getGlossaryTerms();
        const csv = 'Term,Category,Definition\n' + terms.map(t => 
            `"${t.term}","${t.category}","${t.def.replace(/"/g, '""')}"`
        ).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'grc-glossary.csv';
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Glossary exported!', 'success');
    }
    
    // ===== PRACTICE SCENARIOS - GUIDED LEARNING MODE =====
    renderScenarios() {
        const c = document.getElementById('tab-scenarios');
        const scenarios = this.getPracticeScenarioCatalog();
        const activeScenarioId = localStorage.getItem('grc_activeScenario');
        
        // Calculate progress for each scenario
        const getScenarioProgress = (s) => {
            const key = `grc_scenario_${s.id}`;
            const stored = localStorage.getItem(key);
            if (!stored) return { completed: 0, total: s.steps.length, percent: 0, started: false };
            try {
                const progress = JSON.parse(stored);
                const completed = progress.completedSteps?.length || 0;
                return { 
                    completed, 
                    total: s.steps.length, 
                    percent: Math.round((completed / s.steps.length) * 100),
                    started: !!progress.startedAt
                };
            } catch(e) { return { completed: 0, total: s.steps.length, percent: 0, started: false }; }
        };
        
        const categories = [...new Set(scenarios.map(s => s.category))];
        const selectedCat = this.scenarioFilter || 'all';
        const filteredScenarios = selectedCat === 'all' ? scenarios : scenarios.filter(s => s.category === selectedCat);
        
        const categoryIcons = {
            'Incident Response': 'bi-shield-exclamation',
            'Compliance': 'bi-clipboard-check',
            'Vendor Risk': 'bi-building',
            'Risk Management': 'bi-exclamation-triangle',
            'Governance': 'bi-file-earmark-text',
            'Access Control': 'bi-person-lock',
            'Business Continuity': 'bi-arrow-repeat'
        };
        
        c.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Header Section -->
                <div class="welcome-banner" style="margin-bottom: 24px; background: linear-gradient(135deg, var(--accent-purple-soft), var(--accent-blue-soft)); padding: 28px; border-radius: var(--radius-xl);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                        <div style="max-width: 600px;">
                            <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                <i class="bi bi-mortarboard-fill" style="color: var(--accent-purple);"></i>
                                Practice Scenarios
                                <span class="badge badge-purple">Guided Learning</span>
                            </h2>
                            <p style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 16px;">
                                <strong>Practice Scenarios are structured, step-by-step exercises</strong> designed to teach you real-world GRC skills. 
                                Each scenario walks you through a realistic situation with guided tasks, helping you build muscle memory for actual GRC work.
                            </p>
                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="bi bi-check-circle-fill" style="color: var(--accent-green);"></i>
                                    <span style="font-size: 13px;">Step-by-step guidance</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="bi bi-briefcase-fill" style="color: var(--accent-amber);"></i>
                                    <span style="font-size: 13px;">Interview-ready skills</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="bi bi-graph-up" style="color: var(--accent-blue);"></i>
                                    <span style="font-size: 13px;">Track your progress</span>
                                </div>
                            </div>
                        </div>
                        <div style="background: var(--bg-surface); padding: 20px; border-radius: var(--radius-lg); text-align: center; min-width: 180px;">
                            <div style="font-size: 42px; font-weight: 800; color: var(--accent-purple);">${scenarios.length}</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Scenarios Available</div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
                                <div style="font-size: 18px; font-weight: 700; color: var(--accent-green);">
                                    ${scenarios.filter(s => getScenarioProgress(s).percent === 100).length}
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">Completed</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Scenario Banner (if any) -->
                ${activeScenarioId ? (() => {
                    const activeScenario = scenarios.find(s => String(s.id) === activeScenarioId);
                    if (!activeScenario) return '';
                    const prog = getScenarioProgress(activeScenario);
                    return `
                        <div class="card" style="margin-bottom: 24px; border: 2px solid var(--accent-purple); background: var(--accent-purple-soft);">
                            <div class="card-body" style="padding: 16px 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="bi bi-play-circle-fill" style="font-size: 24px; color: var(--accent-purple);"></i>
                                        <div>
                                            <div style="font-size: 12px; color: var(--text-muted); font-weight: 600;">ACTIVE SCENARIO</div>
                                            <div style="font-size: 15px; font-weight: 700;">${activeScenario.title}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <div style="text-align: right;">
                                            <div style="font-size: 13px; font-weight: 600;">${prog.completed}/${prog.total} steps</div>
                                            <div class="progress-bar" style="width: 120px; height: 6px; margin-top: 4px;">
                                                <div class="progress-fill purple" style="width: ${prog.percent}%;"></div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary btn-sm" onclick="app.startScenario(${activeScenario.id})">
                                            <i class="bi bi-arrow-right"></i> Continue
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })() : ''}
                
                <!-- Category Filter -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body" style="padding: 14px 16px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                            <span style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-right: 8px;">Filter by Category:</span>
                            <button class="btn btn-sm ${selectedCat === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="app.scenarioFilter = 'all'; app.renderScenarios();">
                                All (${scenarios.length})
                            </button>
                            ${categories.map(cat => `
                                <button class="btn btn-sm ${selectedCat === cat ? 'btn-primary' : 'btn-secondary'}" onclick="app.scenarioFilter = '${cat}'; app.renderScenarios();">
                                    <i class="bi ${categoryIcons[cat] || 'bi-folder'}" style="margin-right: 4px;"></i>
                                    ${cat} (${scenarios.filter(s => s.category === cat).length})
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Scenarios Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    ${filteredScenarios.map(s => {
                        const prog = getScenarioProgress(s);
                        const isActive = String(s.id) === activeScenarioId;
                        const statusClass = prog.percent === 100 ? 'green' : prog.percent > 0 ? 'purple' : 'gray';
                        
                        return `
                            <div class="card scenario-card" style="transition: all 0.2s; ${isActive ? 'border: 2px solid var(--accent-purple);' : ''}" 
                                 onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" 
                                 onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                                <div class="card-header" style="padding: 16px; background: ${prog.percent === 100 ? 'var(--accent-green-soft)' : prog.percent > 0 ? 'var(--accent-purple-soft)' : 'var(--bg-elevated)'};">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 44px; height: 44px; background: var(--bg-surface); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                            <i class="bi ${s.icon}" style="font-size: 20px; color: var(--accent-${statusClass});"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="display: flex; gap: 6px; margin-bottom: 4px;">
                                                <span class="badge badge-${s.difficulty === 'Easy' ? 'green' : s.difficulty === 'Medium' ? 'amber' : 'red'}">${s.difficulty}</span>
                                                <span class="badge badge-gray">${s.category}</span>
                                                ${isActive ? '<span class="badge badge-purple">Active</span>' : ''}
                                            </div>
                                            <h4 style="font-size: 15px; font-weight: 700; margin: 0;">${s.title}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body" style="padding: 16px;">
                                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.6;">${s.desc}</p>
                                    
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                        <i class="bi bi-list-check" style="color: var(--text-muted);"></i>
                                        <span style="font-size: 12px; color: var(--text-muted);">${s.steps.length} guided steps</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                            <span style="font-size: 12px; font-weight: 600;">Progress</span>
                                            <span style="font-size: 12px; font-weight: 600; color: var(--accent-${statusClass});">${prog.percent}%</span>
                                        </div>
                                        <div class="progress-bar" style="height: 8px;">
                                            <div class="progress-fill ${statusClass}" style="width: ${prog.percent}%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn ${prog.percent > 0 ? 'btn-primary' : 'btn-secondary'} btn-sm" style="flex: 1;" onclick="app.startScenario(${s.id})">
                                            <i class="bi bi-${prog.percent === 100 ? 'arrow-repeat' : prog.percent > 0 ? 'play-fill' : 'play'}"></i>
                                            ${prog.percent === 100 ? 'Review' : prog.percent > 0 ? 'Continue' : 'Start'}
                                        </button>
                                        ${prog.started ? `
                                            <button class="btn btn-ghost btn-sm" onclick="app.resetScenarioProgress(${s.id})" title="Reset Progress">
                                                <i class="bi bi-arrow-counterclockwise"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Bottom Tips Section -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--accent-blue-soft), transparent);">
                        <span style="font-weight: 600;"><i class="bi bi-lightbulb"></i> Pro Tips for Practice Scenarios</span>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <div style="display: flex; gap: 12px;">
                                <div style="width: 32px; height: 32px; background: var(--accent-green-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bi bi-1-circle" style="color: var(--accent-green);"></i>
                                </div>
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">Follow the Steps</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Each step builds on the previous one. Complete them in order for best results.</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <div style="width: 32px; height: 32px; background: var(--accent-amber-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bi bi-2-circle" style="color: var(--accent-amber);"></i>
                                </div>
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">Use the Hints</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Hints tell you exactly what to do. They're designed to teach you best practices.</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <div style="width: 32px; height: 32px; background: var(--accent-purple-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bi bi-3-circle" style="color: var(--accent-purple);"></i>
                                </div>
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">Practice for Interviews</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Each scenario includes interview tips. Use them to explain your work to employers.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    resetScenarioProgress(id) {
        if (!confirm('Reset all progress for this scenario? This cannot be undone.')) return;
        const key = `grc_scenario_${id}`;
        localStorage.removeItem(key);
        const activeScenarioId = localStorage.getItem('grc_activeScenario');
        if (activeScenarioId === String(id)) {
            localStorage.removeItem('grc_activeScenario');
        }
        this.renderScenarios();
        this.toast('Scenario progress reset', 'success');
        try { this.updateLearningUI(); } catch(e) {}
    }

    startScenario(id) {
        const scenarios = this.getPracticeScenarioCatalog();
        const s = scenarios.find(x => x.id === id);
        if (!s) { this.toast('Scenario not found', 'error'); return; }

        // Load progress
        const key = `grc_scenario_${s.id}`;
        let progress = { startedAt: null, completedSteps: [], notes: {} };
        const stored = localStorage.getItem(key);
        if (stored) {
            try { progress = JSON.parse(stored); } catch(e) {}
        }

        const stepRows = s.steps.map((step, idx) => {
            const done = progress.completedSteps.includes(idx);
            const tabLabel = step.goTo ? ` · Go to: <span class="badge badge-gray">${step.goToLabel}</span>` : '';
            return `
              <div class="card" style="border:1px solid var(--border-subtle); margin-bottom:12px;">
                <div class="card-body" style="padding:14px 16px;">
                  <div style="display:flex; align-items:flex-start; gap:12px;">
                    <div style="width:28px; height:28px; border-radius:9999px; background:${done ? 'var(--accent-green-soft)' : 'var(--bg-elevated)'}; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                      <i class="bi ${done ? 'bi-check2' : 'bi-circle'}" style="color:${done ? 'var(--accent-green)' : 'var(--text-muted)'};"></i>
                    </div>
                    <div style="flex:1;">
                      <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;">
                        <div style="font-weight:700; color:var(--text-primary); font-size:13px;">
                          Step ${idx+1}: ${step.title}${tabLabel}
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                          ${step.goTo ? `<button class="btn btn-secondary btn-xs" onclick="app.switchTab('${step.goTo}'); closeModal();"><i class="bi bi-box-arrow-in-right"></i> Go</button>` : ''}
                          <button class="btn ${done ? 'btn-secondary' : 'btn-primary'} btn-xs" onclick="app.toggleScenarioStep(${s.id}, ${idx});">
                            <i class="bi ${done ? 'bi-arrow-counterclockwise' : 'bi-check2'}"></i> ${done ? 'Undo' : 'Mark Done'}
                          </button>
                        </div>
                      </div>
                      <div class="text-sm" style="margin-top:6px; color:var(--text-secondary);">${step.hint}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
        }).join('');

        const completed = progress.completedSteps.length;
        const total = s.steps.length;
        const pct = Math.round((completed / total) * 100);

        const body = `
          <div style="display:flex; align-items:flex-start; gap:14px; margin-bottom:14px;">
            <div style="width:44px; height:44px; border-radius: var(--radius-md); background: var(--accent-purple-soft); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i class="bi ${s.icon}" style="font-size:20px; color: var(--accent-purple);"></i>
            </div>
            <div style="flex:1;">
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
                <span class="badge badge-${s.difficulty.toLowerCase() === 'hard' ? 'red' : (s.difficulty.toLowerCase() === 'easy' ? 'green' : 'amber')}">${s.difficulty}</span>
                <span class="badge badge-gray">${s.category}</span>
              </div>
              <h3 style="font-size:18px; font-weight:800; margin:0; color:var(--text-primary);">${s.title}</h3>
              <p style="margin-top:6px; margin-bottom:0; color:var(--text-secondary);">${s.desc}</p>
            </div>
          </div>

          <div class="card" style="margin-bottom:16px;">
            <div class="card-body" style="padding:14px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
              <div style="font-size:13px; font-weight:700; color:var(--text-primary);">
                Progress: ${completed}/${total} (${pct}%)
              </div>
              <div style="min-width:220px; flex:1; max-width:420px;">
                <div class="progress-bar"><div class="progress-fill purple" style="width:${pct}%;"></div></div>
              </div>
              <button class="btn btn-ghost btn-xs" onclick="app.resetScenario(${s.id})"><i class="bi bi-trash3"></i> Reset</button>
            </div>
          </div>

          <div>${stepRows}</div>

          <div style="margin-top:14px; padding:12px 14px; border:1px dashed var(--border-default); border-radius: var(--radius-lg); background: var(--bg-elevated);">
            <div style="font-weight:700; font-size:12px; margin-bottom:6px;">How this helps in interviews</div>
            <div class="text-sm" style="color:var(--text-secondary);">${s.interview}</div>
          </div>
        `;

        const footer = `
          <button class="btn btn-secondary" onclick="closeModal()"><i class="bi bi-x-lg"></i> Close</button>
          <button class="btn btn-primary" onclick="app.beginScenario(${s.id})"><i class="bi bi-flag-fill"></i> Start / Resume</button>
        `;

        openModal('Practice Scenario', body, footer);
    }

    beginScenario(id){
        const scenarios = this.getPracticeScenarioCatalog();
        const s = scenarios.find(x => x.id === id);
        if (!s) return;

        const key = `grc_scenario_${s.id}`;
        let progress = { startedAt: null, completedSteps: [], notes: {} };
        const stored = localStorage.getItem(key);
        if (stored) { try { progress = JSON.parse(stored); } catch(e) {} }
        if (!progress.startedAt) progress.startedAt = new Date().toISOString();
        localStorage.setItem(key, JSON.stringify(progress));
        try { this.updateLearningUI(); } catch(e) {}
        localStorage.setItem('grc_activeScenario', String(s.id));

        try { this.updateLearningUI(); } catch(e) {}
        // Take user to first relevant tab
        const first = s.steps.find(st => !!st.goTo);
        if (first && first.goTo) {
            this.switchTab(first.goTo);
            this.toast(`Scenario started: ${s.title}`, 'success');
        } else {
            this.toast(`Scenario started: ${s.title}`, 'success');
        }
    }

    toggleScenarioStep(scenarioId, stepIdx){
        const scenarios = this.getPracticeScenarioCatalog();
        const s = scenarios.find(x => x.id === scenarioId);
        if (!s) return;

        const key = `grc_scenario_${s.id}`;
        let progress = { startedAt: null, completedSteps: [], notes: {} };
        const stored = localStorage.getItem(key);
        if (stored) { try { progress = JSON.parse(stored); } catch(e) {} }

        const i = progress.completedSteps.indexOf(stepIdx);
        if (i >= 0) progress.completedSteps.splice(i, 1);
        else progress.completedSteps.push(stepIdx);

        localStorage.setItem(key, JSON.stringify(progress));
        // Re-open modal with updated state
        this.startScenario(s.id);
    }

    resetScenario(scenarioId){
        if (!confirm('Reset this scenario progress?')) return;
        localStorage.removeItem(`grc_scenario_${scenarioId}`);
        if (localStorage.getItem('grc_activeScenario') === String(scenarioId)) {
            localStorage.removeItem('grc_activeScenario');
        }
        this.toast('Scenario progress reset', 'success');
        this.startScenario(scenarioId);
    }

    getPracticeScenarioCatalog(){
        return [
           // === Guided Missions (Core Learning Path) ===
           {
             id: 101,
             isMission: true,
             title: 'Mission 1: Build Your First Risk Register',
             desc: 'Create a starter risk register by adding assets, identifying risks, and validating the heatmap.',
             difficulty: 'Easy',
             category: 'Guided Missions',
             icon: 'bi-flag-fill',
             interview: 'You practiced core GRC fundamentals: asset inventory, risk identification, scoring, and prioritization using a risk matrix.',
             steps: [
               { title:'Add 3 assets', hint:'Add at least 3 assets (systems/data) you need to protect.', goTo:'assets', goToLabel:'Assets', verify:{ type:'minCount', key:'assets', min:3 } },
               { title:'Identify 5 risks', hint:'Create 5 risks tied to those assets with clear business impact.', goTo:'risks', goToLabel:'Risks', verify:{ type:'minCount', key:'risks', min:5 } },
               { title:'Assign likelihood & impact', hint:'Ensure each risk has likelihood and impact selected (scoring matters!).', goTo:'risks', goToLabel:'Risks', verify:{ type:'riskScored', min:5 } },
               { title:'Observe the heatmap', hint:'Open the Risk Matrix and confirm risks appear in the right severity zones.', goTo:'matrix', goToLabel:'Risk Matrix' }
             ]
           },
           {
             id: 102,
             isMission: true,
             title: 'Mission 2: Control Mapping (ISO 27001)',
             desc: 'Map ISO 27001 controls to your risks and attach supporting evidence.',
             difficulty: 'Medium',
             category: 'Guided Missions',
             icon: 'bi-link-45deg',
             interview: 'You mapped controls to risks, aligned to ISO 27001 references, and collected evidence to support audit readiness.',
             steps: [
               { title:'Pick ISO 27001 controls', hint:'Create at least 3 controls aligned to ISO 27001 (use Annex A refs like A.5.xx).', goTo:'controls', goToLabel:'Controls', verify:{ type:'minCount', key:'controls', min:3, framework:'ISO 27001' } },
               { title:'Map controls to risks', hint:'Ensure your risks reference controls (or at minimum, document the mapping in descriptions).', goTo:'controls', goToLabel:'Controls' },
               { title:'Attach evidence', hint:'Add at least 1 evidence item linked to a control (policy, screenshot, report).', goTo:'evidence', goToLabel:'Evidence', verify:{ type:'minCount', key:'evidence', min:1 } }
             ]
           },
           {
             id: 103,
             isMission: true,
             title: 'Mission 3: Statement of Applicability (SoA)',
             desc: 'Practice SoA decisions: applicability + justification for ISO 27001 Annex A controls.',
             difficulty: 'Medium',
             category: 'Guided Missions',
             icon: 'bi-file-earmark-check-fill',
             interview: 'You practiced SoA thinking: applicability decisions and justifications for Annex A controls.',
             steps: [
               { title:'Mark controls applicable / not applicable', hint:'Open SoA and mark at least 3 controls as Not Applicable (with valid reasoning).', goTo:'soa', goToLabel:'SoA', verify:{ type:'soaNotApplicable', min:3 } },
               { title:'Add justification', hint:'For each SoA decision, add a clear justification (scope, systems, risk).', goTo:'soa', goToLabel:'SoA' }
             ]
           },

          {
            id: 1,
            title: 'Ransomware Attack Response',
            desc: 'Practice incident response when ransomware encrypts production databases.',
            difficulty: 'Hard',
            category: 'Incident Response',
            icon: 'bi-shield-exclamation',
            interview: 'You can explain your incident handling workflow: triage → containment → eradication → recovery → lessons learned, plus evidence and reporting.',
            steps: [
              { title:'Log the incident', hint:'Create a new incident entry with summary, severity, and initial impact.', goTo:'incidents', goToLabel:'Incidents' },
              { title:'Capture investigation notes', hint:'Add timeline notes and suspected entry vector in the incident description.', goTo:'incidents', goToLabel:'Incidents' },
              { title:'Create response tasks', hint:'Add tasks for containment, backups validation, comms, and forensics.', goTo:'tasks', goToLabel:'Tasks' },
              { title:'Attach evidence', hint:'Add evidence items (screenshots/logs) linked to the incident.', goTo:'evidence', goToLabel:'Evidence' },
              { title:'Document lessons learned', hint:'Create a finding or issue capturing root cause and preventive actions.', goTo:'findings', goToLabel:'Findings' }
            ]
          },
          {
            id: 2,
            title: 'SOC 2 Type II Preparation',
            desc: 'Prepare for a SOC 2 audit by implementing and testing required controls.',
            difficulty: 'Medium',
            category: 'Compliance',
            icon: 'bi-clipboard-check',
            interview: 'You can describe how you mapped controls to SOC 2 criteria, collected evidence, tested operating effectiveness, and tracked findings.',
            steps: [
              { title:'Confirm audit scope', hint:'List key systems/services in scope and major assumptions.', goTo:'audits', goToLabel:'Audits' },
              { title:'Select controls to test', hint:'Add control tests tied to SOC 2 criteria.', goTo:'testing', goToLabel:'Control Testing' },
              { title:'Collect evidence', hint:'Add evidence records and describe what each proves.', goTo:'evidence', goToLabel:'Evidence' },
              { title:'Record findings', hint:'Log any gaps as findings with remediation recommendations.', goTo:'findings', goToLabel:'Findings' },
              { title:'Update SoA (optional)', hint:'Document applicability/coverage for key controls.', goTo:'soa', goToLabel:'SoA' }
            ]
          },
          {
            id: 3,
            title: 'Vendor Risk Assessment',
            desc: 'Evaluate a new cloud vendor\'s security posture before onboarding.',
            difficulty: 'Easy',
            category: 'Vendor Risk',
            icon: 'bi-building',
            interview: 'You can show that you ran a vendor assessment, identified risks, validated evidence (SOC 2/ISO), and documented remediation.',
            steps: [
              { title:'Create vendor profile', hint:'Add vendor name, service type, and criticality.', goTo:'vendors', goToLabel:'Vendors' },
              { title:'Identify vendor risks', hint:'Add risks like data residency, access controls, incident notifications.', goTo:'risks', goToLabel:'Risks' },
              { title:'Select mitigating controls', hint:'Add controls (e.g., MFA, logging, contractual requirements).', goTo:'controls', goToLabel:'Controls' },
              { title:'Request/record evidence', hint:'Attach SOC 2 report, ISO cert, or security questionnaire outcomes.', goTo:'evidence', goToLabel:'Evidence' }
            ]
          },
          {
            id: 4,
            title: 'Data Breach Investigation',
            desc: 'Investigate a potential data breach and document findings.',
            difficulty: 'Hard',
            category: 'Incident Response',
            icon: 'bi-bug',
            interview: 'You can demonstrate investigation discipline: what happened, what data was impacted, containment, notifications, and closure actions.',
            steps: [
              { title:'Open a breach incident', hint:'Log severity, affected systems, and current status.', goTo:'incidents', goToLabel:'Incidents' },
              { title:'Collect evidence', hint:'Add logs/screenshots and describe relevance.', goTo:'evidence', goToLabel:'Evidence' },
              { title:'Document findings', hint:'Create a finding with root cause hypothesis and impact.', goTo:'findings', goToLabel:'Findings' },
              { title:'Create remediation tasks', hint:'Add tasks for patching, access review, monitoring.', goTo:'tasks', goToLabel:'Tasks' }
            ]
          },
          {
            id: 5,
            title: 'Risk Register Creation',
            desc: 'Build a risk register from scratch for a healthcare startup.',
            difficulty: 'Medium',
            category: 'Risk Management',
            icon: 'bi-exclamation-triangle',
            interview: 'You can discuss how you built a risk register, scored likelihood/impact, selected controls, and tracked treatments.',
            steps: [
              { title:'Add critical assets', hint:'Add PHI systems, EMR, backups, endpoints.', goTo:'assets', goToLabel:'Assets' },
              { title:'Add top risks', hint:'Create risks with clear threat/vuln and business impact.', goTo:'risks', goToLabel:'Risks' },
              { title:'Add controls', hint:'Create controls mapped to risks (access, logging, encryption).', goTo:'controls', goToLabel:'Controls' },
              { title:'Create treatments', hint:'Add treatment plans with owner, due date, status.', goTo:'treatments', goToLabel:'Treatments' },
              { title:'Review matrix', hint:'Confirm risk placement and prioritize remediation.', goTo:'matrix', goToLabel:'Risk Matrix' }
            ]
          },
          {
            id: 6,
            title: 'Policy Development',
            desc: 'Write an Information Security Policy aligned with ISO 27001.',
            difficulty: 'Medium',
            category: 'Governance',
            icon: 'bi-file-earmark-text',
            interview: 'You can show policy drafting skills and how you tied policies to controls and evidence.',
            steps: [
              { title:'Draft the policy', hint:'Create a policy record with scope, purpose, and requirements.', goTo:'policies', goToLabel:'Policies' },
              { title:'Map to controls', hint:'Add key controls the policy supports (access control, logging).', goTo:'controls', goToLabel:'Controls' },
              { title:'Set review cadence', hint:'Add due dates/owners and update governance activity.', goTo:'reviews', goToLabel:'Due & Activity' }
            ]
          },
          {
            id: 7,
            title: 'Access Review Process',
            desc: 'Design and execute a quarterly access review for privileged accounts.',
            difficulty: 'Easy',
            category: 'Access Control',
            icon: 'bi-person-lock',
            interview: 'You can explain the access review workflow, evidence collection, and how you tracked exceptions and remediation.',
            steps: [
              { title:'Define the control', hint:'Create the access review control with frequency and scope.', goTo:'controls', goToLabel:'Controls' },
              { title:'Create review tasks', hint:'Add tasks to collect access lists and approvals.', goTo:'tasks', goToLabel:'Tasks' },
              { title:'Record exceptions', hint:'Log any access exceptions and risk rationale.', goTo:'exceptions', goToLabel:'Exceptions' },
              { title:'Attach evidence', hint:'Upload screenshots/exports as evidence.', goTo:'evidence', goToLabel:'Evidence' }
            ]
          },
          {
            id: 8,
            title: 'Business Impact Analysis',
            desc: 'Conduct a BIA to identify critical systems and recovery objectives.',
            difficulty: 'Medium',
            category: 'Business Continuity',
            icon: 'bi-graph-down-arrow',
            interview: 'You can demonstrate continuity thinking: critical services, RTO/RPO, dependencies, and recovery planning.',
            steps: [
              { title:'Identify critical assets/services', hint:'Add core systems and dependencies.', goTo:'assets', goToLabel:'Assets' },
              { title:'Document requirements', hint:'Add BIA requirements (RTO/RPO) as requirements.', goTo:'requirements', goToLabel:'Requirements' },
              { title:'Create recovery tasks', hint:'Add tasks for backups, DR drills, runbooks.', goTo:'tasks', goToLabel:'Tasks' }
            ]
          },
          {
            id: 9,
            title: 'AI Governance Framework (ISO 42001)',
            desc: 'Implement AI governance controls for a machine learning platform using ISO 42001.',
            difficulty: 'Hard',
            category: 'AI Governance',
            icon: 'bi-robot',
            interview: 'You can demonstrate AI governance maturity: AI system inventory, bias testing, explainability, human oversight, and regulatory compliance (EU AI Act, ISO 42001).',
            steps: [
              { title:'Create AI system inventory', hint:'Add AI models/systems to your asset inventory with classification (high-risk, limited-risk).', goTo:'assets', goToLabel:'Assets' },
              { title:'Identify AI-specific risks', hint:'Add risks like algorithmic bias, model drift, privacy violations, adversarial attacks.', goTo:'risks', goToLabel:'Risks' },
              { title:'Implement AI controls', hint:'Add ISO 42001 controls covering bias testing, explainability, human oversight, monitoring.', goTo:'controls', goToLabel:'Controls' },
              { title:'Document AI policies', hint:'Create policies for responsible AI, model validation, data quality, stakeholder engagement.', goTo:'policies', goToLabel:'Policies' },
              { title:'Establish monitoring', hint:'Add control tests for AI performance metrics, bias detection, drift monitoring.', goTo:'testing', goToLabel:'Control Testing' }
            ]
          }
        ];
    }

renderDonutChart(segments, total) {
        if (total === 0) return '';
        let currentAngle = 0;
        return segments.map(seg => {
            if (seg.value === 0) return '';
            const angle = (seg.value / total) * 360;
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;
            currentAngle = endAngle;
            
            const startRad = (startAngle - 90) * Math.PI / 180;
            const endRad = (endAngle - 90) * Math.PI / 180;
            const largeArc = angle > 180 ? 1 : 0;
            
            const x1 = 50 + 35 * Math.cos(startRad);
            const y1 = 50 + 35 * Math.sin(startRad);
            const x2 = 50 + 35 * Math.cos(endRad);
            const y2 = 50 + 35 * Math.sin(endRad);
            
            return `<path d="M 50 50 L ${x1} ${y1} A 35 35 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${seg.color}" opacity="0.9"/>`;
        }).join('');
    }
    
    // ==================== INTERACTIVE DASHBOARD MODALS ====================
    showRiskDistributionModal() {
        const d = this.getActiveData();
        const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20);
        const highRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20);
        const mediumRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 6 && (r.likelihood * r.impact) < 12);
        const lowRisks = d.risks.filter(r => (r.likelihood * r.impact) < 6);
        
        const renderRiskList = (risks, severity, color) => {
            if (risks.length === 0) return `<div style="padding: 12px; color: var(--text-muted); font-style: italic;">No ${severity.toLowerCase()} risks</div>`;
            return risks.map(r => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer;" 
                     onclick="closeModal(); app.editRisk('${r.id}');" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                    <div style="width: 32px; height: 32px; background: ${color}20; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 12px; font-weight: 700; color: ${color};">${r.likelihood * r.impact}</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600;">${r.title}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${r.category} • ${r.owner || 'Unassigned'}</div>
                    </div>
                    <span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'red'}">${r.status}</span>
                </div>
            `).join('');
        };
        
        openModal('Risk Distribution Details', `
            <div style="margin-bottom: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Click on any risk to view or edit details. Risks are categorized by severity score (Likelihood × Impact).</p>
            </div>
            
            <!-- Critical Risks -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header" style="background: rgba(239, 68, 68, 0.1); padding: 12px 16px;">
                    <span style="font-weight: 600; color: #ef4444;"><i class="bi bi-exclamation-octagon-fill"></i> Critical Risks (Score 20-25)</span>
                    <span class="badge badge-red">${criticalRisks.length}</span>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">${renderRiskList(criticalRisks, 'Critical', '#ef4444')}</div>
            </div>
            
            <!-- High Risks -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header" style="background: rgba(245, 158, 11, 0.1); padding: 12px 16px;">
                    <span style="font-weight: 600; color: #f59e0b;"><i class="bi bi-exclamation-triangle-fill"></i> High Risks (Score 12-19)</span>
                    <span class="badge badge-amber">${highRisks.length}</span>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">${renderRiskList(highRisks, 'High', '#f59e0b')}</div>
            </div>
            
            <!-- Medium Risks -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header" style="background: rgba(59, 130, 246, 0.1); padding: 12px 16px;">
                    <span style="font-weight: 600; color: #3b82f6;"><i class="bi bi-info-circle-fill"></i> Medium Risks (Score 6-11)</span>
                    <span class="badge badge-blue">${mediumRisks.length}</span>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">${renderRiskList(mediumRisks, 'Medium', '#3b82f6')}</div>
            </div>
            
            <!-- Low Risks -->
            <div class="card">
                <div class="card-header" style="background: rgba(34, 197, 94, 0.1); padding: 12px 16px;">
                    <span style="font-weight: 600; color: #22c55e;"><i class="bi bi-check-circle-fill"></i> Low Risks (Score 1-5)</span>
                    <span class="badge badge-green">${lowRisks.length}</span>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">${renderRiskList(lowRisks, 'Low', '#22c55e')}</div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="closeModal(); app.switchTab('risks');"><i class="bi bi-plus"></i> Add Risk</button>
        `);
    }
    
    showControlEffectivenessModal() {
        const d = this.getActiveData();
        const effective = d.controls.filter(c => c.effectiveness === 'Effective');
        const partial = d.controls.filter(c => c.effectiveness === 'Partially Effective');
        const ineffective = d.controls.filter(c => c.effectiveness === 'Ineffective');
        const notTested = d.controls.filter(c => c.effectiveness === 'Not Tested');
        
        const renderControlList = (controls, status, color) => {
            if (controls.length === 0) return `<div style="padding: 12px; color: var(--text-muted); font-style: italic;">No controls with this status</div>`;
            return controls.map(c => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer;" 
                     onclick="closeModal(); app.editControl('${c.id}');" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600;">${c.name}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${c.framework} • ${c.ref || 'No ref'}</div>
                    </div>
                    <span class="badge badge-${this.getFrameworkColor(c.framework)}" style="font-size: 10px;">${c.framework}</span>
                </div>
            `).join('');
        };
        
        openModal('Control Effectiveness Details', `
            <div style="margin-bottom: 20px;">
                <p style="color: var(--text-muted);">Click on any control to view or edit. Effectiveness is determined through control testing.</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="card">
                    <div class="card-header" style="background: var(--accent-green-soft); padding: 12px 16px;">
                        <span style="font-weight: 600; color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i> Effective</span>
                        <span class="badge badge-green">${effective.length}</span>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto;">${renderControlList(effective, 'Effective', 'green')}</div>
                </div>
                
                <div class="card">
                    <div class="card-header" style="background: var(--accent-amber-soft); padding: 12px 16px;">
                        <span style="font-weight: 600; color: var(--accent-amber);"><i class="bi bi-dash-circle-fill"></i> Partial</span>
                        <span class="badge badge-amber">${partial.length}</span>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto;">${renderControlList(partial, 'Partial', 'amber')}</div>
                </div>
                
                <div class="card">
                    <div class="card-header" style="background: var(--accent-red-soft); padding: 12px 16px;">
                        <span style="font-weight: 600; color: var(--accent-red);"><i class="bi bi-x-circle-fill"></i> Ineffective</span>
                        <span class="badge badge-red">${ineffective.length}</span>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto;">${renderControlList(ineffective, 'Ineffective', 'red')}</div>
                </div>
                
                <div class="card">
                    <div class="card-header" style="background: var(--bg-elevated); padding: 12px 16px;">
                        <span style="font-weight: 600; color: var(--text-muted);"><i class="bi bi-question-circle-fill"></i> Not Tested</span>
                        <span class="badge badge-gray">${notTested.length}</span>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto;">${renderControlList(notTested, 'Not Tested', 'gray')}</div>
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="closeModal(); app.switchTab('testing');"><i class="bi bi-clipboard-check"></i> Test Controls</button>
        `);
    }
    
    showGRCHealthModal() {
        const d = this.getActiveData();
        
        // Calculate detailed metrics
        const openRisks = d.risks.filter(r => r.status !== 'Closed').length;
        const totalRisks = d.risks.length;
        const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
        const totalControls = d.controls.length;
        const openFindings = d.findings.filter(f => f.status === 'Open').length;
        const openIssues = d.issues.filter(i => i.status === 'Open').length;
        const pendingTasks = d.tasks.filter(t => t.status !== 'Completed').length;
        const overdueFindings = d.findings.filter(f => f.dueDate && new Date(f.dueDate) < new Date() && f.status !== 'Closed').length;
        
        // Calculate component scores
        const riskScore = totalRisks > 0 ? Math.max(0, 100 - (criticalRisks * 20) - (openRisks * 5)) : 100;
        const controlScore = totalControls > 0 ? Math.round((effectiveControls / totalControls) * 100) : 0;
        const findingScore = Math.max(0, 100 - (openFindings * 10) - (overdueFindings * 15));
        const complianceScore = Math.max(0, 100 - (openIssues * 8));
        const overallHealth = Math.round((riskScore * 0.35 + controlScore * 0.35 + findingScore * 0.15 + complianceScore * 0.15));
        
        const getScoreColor = (score) => score >= 80 ? 'green' : score >= 60 ? 'amber' : 'red';
        
        openModal('GRC Health Score Breakdown', `
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
                    <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                        <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg-elevated)" stroke-width="12"/>
                        <circle cx="50" cy="50" r="42" fill="none" stroke="var(--accent-${getScoreColor(overallHealth)})" stroke-width="12" 
                            stroke-dasharray="${overallHealth * 2.64} 264" stroke-linecap="round" style="transition: stroke-dasharray 0.5s ease;"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 42px; font-weight: 800; color: var(--accent-${getScoreColor(overallHealth)});">${overallHealth}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Overall Score</div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div class="card">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-${getScoreColor(riskScore)});">${riskScore}%</div>
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Risk Management</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${openRisks} open • ${criticalRisks} critical</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Weight: 35%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-${getScoreColor(controlScore)});">${controlScore}%</div>
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Control Effectiveness</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${effectiveControls}/${totalControls} effective</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Weight: 35%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-${getScoreColor(findingScore)});">${findingScore}%</div>
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Findings & Remediation</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${openFindings} open • ${overdueFindings} overdue</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Weight: 15%</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-${getScoreColor(complianceScore)});">${complianceScore}%</div>
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Compliance Posture</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${openIssues} open issues</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Weight: 15%</div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-lg);">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">Improvement Recommendations</div>
                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-secondary);">
                    ${criticalRisks > 0 ? '<li style="margin-bottom: 4px;">Address critical risks immediately to improve risk score</li>' : ''}
                    ${effectiveControls < totalControls * 0.8 ? '<li style="margin-bottom: 4px;">Test and remediate controls to improve effectiveness rate</li>' : ''}
                    ${overdueFindings > 0 ? '<li style="margin-bottom: 4px;">Close overdue findings to improve remediation score</li>' : ''}
                    ${openIssues > 3 ? '<li style="margin-bottom: 4px;">Prioritize issue resolution to improve compliance posture</li>' : ''}
                    ${criticalRisks === 0 && effectiveControls >= totalControls * 0.8 && overdueFindings === 0 && openIssues <= 3 ? '<li style="color: var(--accent-green);">Excellent GRC posture! Continue maintaining current practices.</li>' : ''}
                </ul>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="closeModal(); app.switchTab('reports');"><i class="bi bi-file-earmark-text"></i> Generate Report</button>
        `);
    }
    
    renderRiskByCategoryChart() {
        const d = this.getActiveData();
        const cats = {};
        d.risks.forEach(r => cats[r.category] = (cats[r.category] || 0) + 1);
        const maxCount = Math.max(...Object.values(cats));
        const colors = ['#3b82f6', '#a855f7', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899'];
        
        return `
            <div style="display: flex; flex-direction: column; gap: 14px;">
                ${Object.entries(cats).sort((a, b) => b[1] - a[1]).map(([cat, count], i) => `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 13px; font-weight: 500;">${cat}</span>
                            <span style="font-size: 13px; font-weight: 600; color: ${colors[i % colors.length]};">${count}</span>
                        </div>
                        <div style="height: 24px; background: var(--bg-elevated); border-radius: 6px; overflow: hidden; position: relative;">
                            <div style="height: 100%; width: ${(count/maxCount)*100}%; background: linear-gradient(90deg, ${colors[i % colors.length]}dd, ${colors[i % colors.length]}99); border-radius: 6px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    renderAssets() {
        const c = document.getElementById('tab-assets');
        const d = this.getActiveData();
        const assets = d.assets;
        const critical = assets.filter(a => a.classification === 'Critical').length;
        const high = assets.filter(a => a.classification === 'High').length;
        
        c.innerHTML = `
            <!-- Hero Banner -->
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #1e3a8a, #1e40af, #3b82f6, #60a5fa); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-hdd-stack-fill"></i></div>
                        <div style="flex: 1;">
                            <h1>Asset Inventory</h1>
                            <p>Track and classify organizational assets</p>
                        </div>
                        <button class="btn" style="background: white; color: #1e40af; font-weight: 600;" onclick="app.showAssetModal()">
                            <i class="bi bi-plus-lg"></i> Add Asset
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-hdd-stack"></i> ${assets.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-exclamation-octagon"></i> ${critical} Critical</div>
                        <div class="modern-stat-pill" style="background: rgba(249,115,22,0.3);"><i class="bi bi-exclamation-diamond"></i> ${high} High</div>
                    </div>
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);">
                    <div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-hdd-stack-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-blue);">${assets.length}</div>
                    <div class="modern-kpi-label">Total Assets</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);">
                    <div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-octagon-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-red);">${critical}</div>
                    <div class="modern-kpi-label">Critical</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-exclamation-diamond-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">${high}</div>
                    <div class="modern-kpi-label">High</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-cloud-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${assets.filter(a => a.environment === 'Production').length}</div>
                    <div class="modern-kpi-label">Production</div>
                </div>
            </div>
            
            <!-- Assets List -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-blue);"></i> All Assets</span>
                    <span class="badge badge-blue">${assets.length} items</span>
                </div>
                ${assets.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Classification</th>
                                <th>Owner</th>
                                <th>Environment</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assets.map(a => `
                                <tr onclick="app.editAsset('${a.id}')">
                                    <td style="font-weight: 500;">${this.esc(a.name)}</td>
                                    <td><span class="badge badge-blue">${a.type}</span></td>
                                    <td><span class="badge badge-${a.classification === 'Critical' ? 'red' : a.classification === 'High' ? 'amber' : 'green'}">${a.classification}</span></td>
                                    <td style="color: var(--text-secondary);">${a.owner || '-'}</td>
                                    <td style="color: var(--text-secondary);">${a.environment || '-'}</td>
                                    <td>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editAsset('${a.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('assets','${a.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-hdd-stack"></i></div>
                    <h3>No Assets Yet</h3>
                    <p>Assets are systems and data you need to protect.</p>
                    <button class="btn btn-primary" onclick="app.showAssetModal()"><i class="bi bi-plus-lg"></i> Add Your First Asset</button>
                </div>
                `}
            </div>
        `;
    }
    showAssetModal(a = null) {
        const isEdit = a !== null;
        this.setModalContext('asset', { isEdit, item: a });
        openModal(isEdit ? 'Edit Asset' : 'Add Asset', `<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="f-name" value="${a?.name || ''}" placeholder="e.g., Customer Database"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Application', 'Database', 'Server', 'Cloud Account', 'Network Device', 'Data Store', 'Endpoint'].map(t => `<option value="${t}" ${a?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Classification</label><select class="form-select" id="f-class">${['Critical', 'High', 'Medium', 'Low'].map(c => `<option value="${c}" ${a?.classification === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${a?.owner || ''}"></div><div class="form-group"><label class="form-label">Environment</label><select class="form-select" id="f-env">${['Production', 'Staging', 'Development', 'DR'].map(e => `<option value="${e}" ${a?.environment === e ? 'selected' : ''}>${e}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${a?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveAsset('${a?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveAsset(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const d = this.getActiveData();
        const item = { id: editId || this.generateId('AST'), name, type: document.getElementById('f-type').value, classification: document.getElementById('f-class').value, owner: document.getElementById('f-owner').value, environment: document.getElementById('f-env').value, description: document.getElementById('f-desc').value, createdAt: editId ? d.assets.find(a => a.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = d.assets.findIndex(a => a.id === editId); if (idx !== -1) d.assets[idx] = item; } else { d.assets.push(item); }
        this.saveData('assets'); closeModal(); this.renderAssets(); this.toast(editId ? 'Asset updated' : 'Asset created', 'success');
        if (!editId) this.showWorkflowPrompt('Asset Registered — Next Step', 'Now identify what risks threaten this asset. Think: what threats could exploit vulnerabilities in this system?', 'risks', 'Identify Risks →');
    }
    editAsset(id) { const d = this.getActiveData(); const a = d.assets.find(x => x.id === id); if (a) this.showAssetModal(a); }
    renderVendors() {
        const c = document.getElementById('tab-vendors');
        const vendors = this.getActiveData().vendors;
        const critical = vendors.filter(v => v.criticality === 'Critical').length;
        const active = vendors.filter(v => v.status === 'Active').length;
        
        c.innerHTML = `
            <!-- Hero Banner -->
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #581c87, #7c3aed, #8b5cf6, #a78bfa); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-building"></i></div>
                        <div style="flex: 1;">
                            <h1>Vendor Management</h1>
                            <p>Track third-party vendors and their risk profiles</p>
                        </div>
                        <button class="btn" style="background: white; color: #7c3aed; font-weight: 600;" onclick="app.showVendorModal()">
                            <i class="bi bi-plus-lg"></i> Add Vendor
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-building"></i> ${vendors.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-exclamation-octagon"></i> ${critical} Critical</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${active} Active</div>
                    </div>
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-purple);">
                    <div class="modern-kpi-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-building-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-purple);">${vendors.length}</div>
                    <div class="modern-kpi-label">Total Vendors</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);">
                    <div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-octagon-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-red);">${critical}</div>
                    <div class="modern-kpi-label">Critical</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${active}</div>
                    <div class="modern-kpi-label">Active</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-hourglass-split"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">${vendors.filter(v => v.status === 'Under Review').length}</div>
                    <div class="modern-kpi-label">Under Review</div>
                </div>
            </div>
            
            <!-- Vendors List -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-purple);"></i> All Vendors</span>
                    <span class="badge badge-purple">${vendors.length} items</span>
                </div>
                ${vendors.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Vendor Name</th>
                                <th>Service</th>
                                <th>Criticality</th>
                                <th>Status</th>
                                <th>Owner</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vendors.map(v => `
                                <tr onclick="app.editVendor('${v.id}')">
                                    <td style="font-weight: 500;">${this.esc(v.name)}</td>
                                    <td style="color: var(--text-secondary);">${v.service || '-'}</td>
                                    <td><span class="badge badge-${v.criticality === 'Critical' ? 'red' : v.criticality === 'High' ? 'amber' : 'green'}">${v.criticality}</span></td>
                                    <td><span class="badge badge-${v.status === 'Active' ? 'green' : v.status === 'Under Review' ? 'amber' : 'gray'}">${v.status}</span></td>
                                    <td style="color: var(--text-secondary);">${v.owner || '-'}</td>
                                    <td>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editVendor('${v.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('vendors','${v.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-building"></i></div>
                    <h3>No Vendors Yet</h3>
                    <p>Track third-party vendors and their risk profiles.</p>
                    <button class="btn btn-primary" onclick="app.showVendorModal()"><i class="bi bi-plus-lg"></i> Add Your First Vendor</button>
                </div>
                `}
            </div>
        `;
    }
    showVendorModal(v = null) {
        const isEdit = v !== null;
        openModal(isEdit ? 'Edit Vendor' : 'Add Vendor', `<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="f-name" value="${v?.name || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Service</label><input type="text" class="form-input" id="f-service" value="${v?.service || ''}"></div><div class="form-group"><label class="form-label">Criticality</label><select class="form-select" id="f-crit">${['Critical', 'High', 'Medium', 'Low'].map(c => `<option value="${c}" ${v?.criticality === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${v?.owner || ''}"></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Active', 'Under Review', 'Inactive'].map(s => `<option value="${s}" ${v?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes">${v?.notes || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveVendor('${v?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveVendor(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const item = { id: editId || this.generateId('VND'), name, service: document.getElementById('f-service').value, criticality: document.getElementById('f-crit').value, owner: document.getElementById('f-owner').value, status: document.getElementById('f-status').value, notes: document.getElementById('f-notes').value, createdAt: editId ? this.getActiveData().vendors.find(v => v.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().vendors.findIndex(v => v.id === editId); if (idx !== -1) this.getActiveData().vendors[idx] = item; } else { this.getActiveData().vendors.push(item); }
        this.saveData('vendors'); closeModal(); this.renderVendors(); this.toast(editId ? 'Vendor updated' : 'Vendor created', 'success');
    }
    editVendor(id) { const v = this.getActiveData().vendors.find(x => x.id === id); if (v) this.showVendorModal(v); }
    renderPolicies() {
        const c = document.getElementById('tab-policies');
        const policies = this.getActiveData().policies;
        const approved = policies.filter(p => p.status === 'Approved').length;
        const draft = policies.filter(p => p.status === 'Draft').length;
        
        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #0c4a6e, #0369a1, #0284c7, #0ea5e9); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-file-earmark-text-fill"></i></div>
                        <div style="flex: 1;">
                            <h1>Policy Library</h1>
                            <p>Document and manage organizational security policies</p>
                        </div>
                        <button class="btn" style="background: white; color: #0369a1; font-weight: 600;" onclick="app.showPolicyModal()">
                            <i class="bi bi-plus-lg"></i> Add Policy
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-file-text"></i> ${policies.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${approved} Approved</div>
                        <div class="modern-stat-pill"><i class="bi bi-pencil"></i> ${draft} Draft</div>
                    </div>
                </div>
            </div>
            
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);"><div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-file-text-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-blue);">${policies.length}</div><div class="modern-kpi-label">Total Policies</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);"><div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-green);">${approved}</div><div class="modern-kpi-label">Approved</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);"><div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-hourglass-split"></i></div><div class="modern-kpi-value" style="color: var(--accent-amber);">${policies.filter(p => p.status === 'Under Review').length}</div><div class="modern-kpi-label">Under Review</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-purple);"><div class="modern-kpi-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-pencil-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-purple);">${draft}</div><div class="modern-kpi-label">Draft</div></div>
            </div>
            
            <div class="modern-card">
                <div class="modern-card-header"><span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-blue);"></i> All Policies</span><span class="badge badge-blue">${policies.length} items</span></div>
                ${policies.length > 0 ? `<div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>Title</th><th>Status</th><th>Owner</th><th>Review Date</th><th style="width: 100px;">Actions</th></tr></thead><tbody>${policies.map(p => `<tr onclick="app.editPolicy('${p.id}')"><td style="font-weight: 500;">${this.esc(p.title)}</td><td><span class="badge badge-${p.status === 'Approved' ? 'green' : p.status === 'Draft' ? 'gray' : 'amber'}">${p.status}</span></td><td style="color: var(--text-secondary);">${p.owner || '-'}</td><td style="color: var(--text-secondary);">${p.reviewDate ? new Date(p.reviewDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editPolicy('${p.id}')" title="Edit"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('policies','${p.id}')" title="Delete"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table></div>` : `<div class="modern-empty"><div class="modern-empty-icon"><i class="bi bi-file-earmark-text"></i></div><h3>No Policies Yet</h3><p>Document your security policies.</p><button class="btn btn-primary" onclick="app.showPolicyModal()"><i class="bi bi-plus-lg"></i> Add Your First Policy</button></div>`}
            </div>
        `;
    }
    showPolicyModal(p = null) {
        const isEdit = p !== null;
        openModal(isEdit ? 'Edit Policy' : 'Add Policy', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${p?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Draft', 'Under Review', 'Approved', 'Retired'].map(s => `<option value="${s}" ${p?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${p?.owner || ''}"></div></div><div class="form-group"><label class="form-label">Review Date</label><input type="date" class="form-input" id="f-review" value="${p?.reviewDate?.split('T')[0] || ''}"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.savePolicy('${p?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    savePolicy(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('POL'), title, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, reviewDate: document.getElementById('f-review').value || null, createdAt: editId ? this.getActiveData().policies.find(p => p.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().policies.findIndex(p => p.id === editId); if (idx !== -1) this.getActiveData().policies[idx] = item; } else { this.getActiveData().policies.push(item); }
        this.saveData('policies'); closeModal(); this.renderPolicies(); this.toast(editId ? 'Policy updated' : 'Policy created', 'success');
    }
    editPolicy(id) { const p = this.getActiveData().policies.find(x => x.id === id); if (p) this.showPolicyModal(p); }
    renderRisks() {
        const c = document.getElementById('tab-risks');
        const d = this.getActiveData();
        const risks = d.risks;
        const criticalRisks = risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const highRisks = risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
        const mediumRisks = risks.filter(r => (r.likelihood * r.impact) >= 6 && (r.likelihood * r.impact) < 12).length;
        const openRisks = risks.filter(r => r.status !== 'Closed').length;
        
        c.innerHTML = `
            <!-- Hero Banner -->
            <div class="modern-page-hero">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                        <div style="flex: 1;">
                            <h1>Risk Register</h1>
                            <p>Identify, assess, and track organizational risks</p>
                        </div>
                        <button class="btn" style="background: white; color: #1e3a8a; font-weight: 600;" onclick="app.showRiskModal()">
                            <i class="bi bi-plus-lg"></i> Add Risk
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-collection"></i> ${risks.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-exclamation-octagon"></i> ${criticalRisks} Critical</div>
                        <div class="modern-stat-pill" style="background: rgba(249,115,22,0.3);"><i class="bi bi-exclamation-diamond"></i> ${highRisks} High</div>
                        <div class="modern-stat-pill"><i class="bi bi-clock"></i> ${openRisks} Open</div>
                    </div>
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);">
                    <div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-collection-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-blue);">${risks.length}</div>
                    <div class="modern-kpi-label">Total Risks</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);" onclick="app.filterRisksByLevel('critical')">
                    <div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-octagon-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-red);">${criticalRisks}</div>
                    <div class="modern-kpi-label">Critical</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);" onclick="app.filterRisksByLevel('high')">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-exclamation-diamond-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">${highRisks}</div>
                    <div class="modern-kpi-label">High</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${risks.filter(r => r.status === 'Closed').length}</div>
                    <div class="modern-kpi-label">Closed</div>
                </div>
            </div>
            
            <!-- Risk List -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-blue);"></i> All Risks</span>
                    <span class="badge badge-blue">${risks.length} items</span>
                </div>
                ${risks.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Score</th>
                                <th>Risk Title</th>
                                <th>Category</th>
                                <th>L × I</th>
                                <th>Status</th>
                                <th>Owner</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${risks.sort((a,b) => (b.likelihood * b.impact) - (a.likelihood * a.impact)).map(r => {
                                const score = r.likelihood * r.impact;
                                const level = score >= 20 ? 'critical' : score >= 12 ? 'high' : score >= 6 ? 'medium' : 'low';
                                return `
                                <tr onclick="app.editRisk('${r.id}')">
                                    <td><div class="modern-score-badge ${level}">${score}</div></td>
                                    <td style="font-weight: 500;">${this.esc(r.title)}</td>
                                    <td><span class="badge badge-blue">${r.category}</span></td>
                                    <td><span style="font-family: var(--font-mono); color: var(--text-muted);">${r.likelihood} × ${r.impact}</span></td>
                                    <td><span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'red'}">${r.status}</span></td>
                                    <td style="color: var(--text-secondary);">${r.owner || '-'}</td>
                                    <td>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editRisk('${r.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('risks','${r.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <h3>No Risks Yet</h3>
                    <p>Start identifying and assessing risks to your organization.</p>
                    <button class="btn btn-primary" onclick="app.showRiskModal()"><i class="bi bi-plus-lg"></i> Add Your First Risk</button>
                </div>
                `}
            </div>
        `;
    }
    showRiskModal(r = null) {
        const isEdit = r !== null;
        this.setModalContext('risk', { isEdit, item: r });
        const coachBanner = !isEdit ? `<div style="background: linear-gradient(135deg, var(--accent-blue-soft), var(--accent-purple-soft)); border-radius: var(--radius-md); padding: 12px; margin-bottom: 16px; border-left: 3px solid var(--accent-blue);"><div style="font-size: 11px; font-weight: 700; color: var(--accent-blue); margin-bottom: 4px;"><i class="bi bi-mortarboard-fill"></i> COACH TIP</div><div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">Write risks in this format: <strong>[Threat] exploits [Vulnerability] causing [Impact] to [Asset]</strong><br>Example: &quot;External attacker exploits weak MFA causing unauthorized access to customer database&quot;</div></div>` : '';
        const ht = (t) => `<span class="help-icon">?<span class="help-tooltip">${t}</span></span>`;
        openModal(isEdit ? 'Edit Risk' : 'Add Risk', `${coachBanner}<div class="form-group"><label class="form-label">Title * ${ht('A concise risk statement. Best: [Threat] exploits [Vulnerability] causing [Impact] to [Asset].')}</label><input type="text" class="form-input" id="f-title" value="${r?.title || ''}" placeholder="e.g. External attacker exploits weak MFA causing data breach"><div class="beginner-tip"><i class="bi bi-lightbulb"></i> Think: What could go wrong? Who or what causes it? What gets damaged?</div></div><div class="form-row"><div class="form-group"><label class="form-label">Category ${ht('Should match your Risk Appetite categories for threshold comparison.')}</label><select class="form-select" id="f-category">${['Access Control', 'Application Security', 'Data Protection', 'Availability', 'Compliance', 'Vendor Risk', 'Physical Security', 'Human Error', 'Other'].map(c => `<option value="${c}" ${r?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Open', 'In Progress', 'Closed'].map(s => `<option value="${s}" ${r?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Likelihood (1-5) ${ht('1=Rare (once in 10+ yrs), 3=Possible (annually), 5=Almost Certain (multiple/yr)')}</label><select class="form-select" id="f-likelihood" onchange="app.updateRiskScorePreview()">${[1,2,3,4,5].map(l => `<option value="${l}" ${r?.likelihood === l ? 'selected' : ''}>${l} - ${['Rare','Unlikely','Possible','Likely','Almost Certain'][l-1]}</option>`).join('')}</select><div class="beginner-tip"><i class="bi bi-lightbulb"></i> How often could this happen? Once a decade = 1. Multiple times a year = 5.</div></div><div class="form-group"><label class="form-label">Impact (1-5) ${ht('1=Negligible (<$10K), 3=Moderate ($100K-$1M), 5=Severe (>$10M or regulatory)')}</label><select class="form-select" id="f-impact" onchange="app.updateRiskScorePreview()">${[1,2,3,4,5].map(i => `<option value="${i}" ${r?.impact === i ? 'selected' : ''}>${i} - ${['Negligible','Minor','Moderate','Major','Severe'][i-1]}</option>`).join('')}</select></div></div><div id="risk-score-preview" style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 8px 12px; font-size: 12px; margin-bottom: 12px;"></div><div class="form-group"><label class="form-label">Owner ${ht('The person ACCOUNTABLE for this risk. Not the fixer — the person who ensures it gets fixed.')}</label><input type="text" class="form-input" id="f-owner" value="${r?.owner || ''}" placeholder="e.g. CISO, Security Lead"></div><div class="form-group adv-field"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc" placeholder="Describe the threat scenario, affected systems, and potential business impact">${r?.description || ''}</textarea></div><div class="rationale-prompt"><label><i class="bi bi-chat-square-text"></i> Decision Rationale — WHY did you rate it this way?</label><textarea id="f-rationale" placeholder="e.g. We have no MFA on admin accounts, so likelihood is high. Impact is major because the DB holds 500K PII records.">${r?.rationale || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveRisk('${r?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
        setTimeout(() => this.updateRiskScorePreview(), 50);
    }
    updateRiskScorePreview() {
        const l = parseInt(document.getElementById('f-likelihood')?.value || 1);
        const im = parseInt(document.getElementById('f-impact')?.value || 1);
        const score = l * im;
        const level = score >= 20 ? 'Critical' : score >= 12 ? 'High' : score >= 6 ? 'Medium' : 'Low';
        const color = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
        const el = document.getElementById('risk-score-preview');
        if (el) el.innerHTML = `<span style="font-weight: 700; color: var(--accent-${color});">Risk Score: ${score}</span> (${l} × ${im}) — <span class="badge badge-${color}">${level}</span>`;
    }
    saveRisk(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        // Quality coaching feedback
        if (!editId) {
            const words = title.split(' ').length;
            if (words < 5) { this.toast('Coach: Your risk title is too brief. Try: [Threat] exploits [Vulnerability] causing [Impact]', 'error'); return; }
        }
        const item = { id: editId || this.generateId('RSK'), title, category: document.getElementById('f-category').value, status: document.getElementById('f-status').value, likelihood: parseInt(document.getElementById('f-likelihood').value), impact: parseInt(document.getElementById('f-impact').value), owner: document.getElementById('f-owner').value, description: document.getElementById('f-desc')?.value || '', rationale: document.getElementById('f-rationale')?.value || '', createdAt: editId ? this.getActiveData().risks.find(r => r.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().risks.findIndex(r => r.id === editId); if (idx !== -1) this.getActiveData().risks[idx] = item; } else { this.getActiveData().risks.push(item); }
        this.saveData('risks'); closeModal(); this.renderRisks(); this.toast(editId ? 'Risk updated' : 'Risk created', 'success');
        if (!editId) this.showWorkflowPrompt('Risk Created — Next Step', 'Every risk needs at least one control to mitigate it. Add a control now while the risk is fresh in your mind.', 'controls', 'Add a Control →');
    }
    editRisk(id) { const r = this.getActiveData().risks.find(x => x.id === id); if (r) this.showRiskModal(r); }
    renderControls() {
        const c = document.getElementById('tab-controls');
        const controls = this.getActiveData().controls;
        const effective = controls.filter(c => c.effectiveness === 'Effective').length;
        const partial = controls.filter(c => c.effectiveness === 'Partially Effective').length;
        const ineffective = controls.filter(c => c.effectiveness === 'Ineffective').length;
        
        c.innerHTML = `
            <!-- Hero Banner -->
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #064e3b, #065f46, #047857, #059669); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-shield-check"></i></div>
                        <div style="flex: 1;">
                            <h1>Control Catalog</h1>
                            <p>Manage security controls and track effectiveness</p>
                        </div>
                        <button class="btn" style="background: white; color: #065f46; font-weight: 600;" onclick="app.showControlModal()">
                            <i class="bi bi-plus-lg"></i> Add Control
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-shield-fill"></i> ${controls.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${effective} Effective</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-dash-circle"></i> ${partial} Partial</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-x-circle"></i> ${ineffective} Ineffective</div>
                    </div>
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-shield-fill-check"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${controls.length}</div>
                    <div class="modern-kpi-label">Total Controls</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${effective}</div>
                    <div class="modern-kpi-label">Effective</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-dash-circle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">${partial}</div>
                    <div class="modern-kpi-label">Partially Effective</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);">
                    <div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-percent"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-blue);">${controls.length > 0 ? Math.round((effective/controls.length)*100) : 0}%</div>
                    <div class="modern-kpi-label">Effectiveness Rate</div>
                </div>
            </div>
            
            <!-- Controls List -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-green);"></i> All Controls</span>
                    <span class="badge badge-green">${controls.length} items</span>
                </div>
                ${controls.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Control Name</th>
                                <th>Framework</th>
                                <th>Reference</th>
                                <th>Effectiveness</th>
                                <th>Frequency</th>
                                <th>Owner</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${controls.map(ctrl => `
                                <tr onclick="app.editControl('${ctrl.id}')">
                                    <td style="font-weight: 500;">${this.esc(ctrl.name)}</td>
                                    <td><span class="fw-badge fw-${ctrl.framework?.toLowerCase().replace(/\\s/g, '')}">${ctrl.framework}</span></td>
                                    <td><span style="font-family: var(--font-mono); color: var(--text-muted);">${ctrl.ref || '-'}</span></td>
                                    <td><span class="badge badge-${ctrl.effectiveness === 'Effective' ? 'green' : ctrl.effectiveness === 'Partially Effective' ? 'amber' : ctrl.effectiveness === 'Ineffective' ? 'red' : 'gray'}">${ctrl.effectiveness}</span></td>
                                    <td style="color: var(--text-secondary);">${ctrl.frequency || '-'}</td>
                                    <td style="color: var(--text-secondary);">${ctrl.owner || '-'}</td>
                                    <td>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editControl('${ctrl.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('controls','${ctrl.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-shield-lock"></i></div>
                    <h3>No Controls Yet</h3>
                    <p>Define security controls to mitigate your identified risks.</p>
                    <button class="btn btn-primary" onclick="app.showControlModal()"><i class="bi bi-plus-lg"></i> Add Your First Control</button>
                </div>
                `}
            </div>
        `;
    }
    showControlModal(ctrl = null) {
        const isEdit = ctrl !== null;
        this.setModalContext('control', { isEdit, item: ctrl });
        const coachBanner = !isEdit ? `<div style="background: linear-gradient(135deg, var(--accent-green-soft), var(--accent-blue-soft)); border-radius: var(--radius-md); padding: 12px; margin-bottom: 16px; border-left: 3px solid var(--accent-green);"><div style="font-size: 11px; font-weight: 700; color: var(--accent-green); margin-bottom: 4px;"><i class="bi bi-mortarboard-fill"></i> COACH TIP</div><div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">A good control is <strong>specific, measurable, and testable</strong>. Not &quot;implement security&quot; but &quot;Enforce MFA on all admin accounts using Okta with hardware keys.&quot;</div></div>` : '';
        openModal(isEdit ? 'Edit Control' : 'Add Control', `${coachBanner}<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="f-name" value="${ctrl?.name || ''}" placeholder="e.g. Enforce MFA on all privileged accounts"><div class="beginner-tip"><i class="bi bi-lightbulb"></i> A control is a safeguard. What specific action reduces a risk? Be precise enough that someone could test it.</div></div><div class="form-row"><div class="form-group"><label class="form-label">Framework</label><select class="form-select" id="f-framework">${['ISO 27001', 'ISO 42001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR', 'CIS'].map(f => `<option value="${f}" ${ctrl?.framework === f ? 'selected' : ''}>${f}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Reference</label><input type="text" class="form-input" id="f-ref" value="${ctrl?.ref || ''}" placeholder="e.g., A.5.17"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Effectiveness</label><select class="form-select" id="f-effectiveness">${['Effective', 'Partially Effective', 'Ineffective', 'Not Tested'].map(e => `<option value="${e}" ${ctrl?.effectiveness === e ? 'selected' : ''}>${e}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Frequency</label><select class="form-select" id="f-frequency">${['Continuous', 'Monthly', 'Quarterly', 'Annual'].map(f => `<option value="${f}" ${ctrl?.frequency === f ? 'selected' : ''}>${f}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${ctrl?.owner || ''}" placeholder="e.g. IAM Team, Security Operations"></div><div class="form-group adv-field"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc" placeholder="Describe exactly what this control does, how it is implemented, and how you would test it">${ctrl?.description || ''}</textarea></div><div class="rationale-prompt"><label><i class="bi bi-chat-square-text"></i> Decision Rationale — WHY this effectiveness rating?</label><textarea id="f-ctrl-rationale" placeholder="e.g. Rated Effective because MFA is enforced via Okta SSO. Last tested 2025-01-15 with 100% pass rate.">${ctrl?.rationale || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveControl('${ctrl?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveControl(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const item = { id: editId || this.generateId('CTL'), name, framework: document.getElementById('f-framework').value, ref: document.getElementById('f-ref').value, effectiveness: document.getElementById('f-effectiveness').value, frequency: document.getElementById('f-frequency').value, owner: document.getElementById('f-owner').value, description: document.getElementById('f-desc')?.value || '', rationale: document.getElementById('f-ctrl-rationale')?.value || '', createdAt: editId ? this.getActiveData().controls.find(c => c.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().controls.findIndex(c => c.id === editId); if (idx !== -1) this.getActiveData().controls[idx] = item; } else { this.getActiveData().controls.push(item); }
        this.saveData('controls'); closeModal(); this.renderControls(); this.toast(editId ? 'Control updated' : 'Control created', 'success');
        if (!editId) this.showWorkflowPrompt('Control Created — Next Step', 'Now collect evidence that proves this control works. Screenshots, logs, policy docs — whatever an auditor would need to see.', 'evidence', 'Add Evidence →');
    }
    editControl(id) { const c = this.getActiveData().controls.find(x => x.id === id); if (c) this.showControlModal(c); }
    renderTreatments() {
        const c = document.getElementById('tab-treatments');
        const treatments = this.getActiveData().treatments;
        const completed = treatments.filter(t => t.status === 'Completed').length;
        const inProgress = treatments.filter(t => t.status === 'In Progress').length;
        
        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #701a75, #86198f, #a21caf, #c026d3); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-bandaid-fill"></i></div>
                        <div style="flex: 1;">
                            <h1>Risk Treatment Plans</h1>
                            <p>Create and track risk mitigation strategies</p>
                        </div>
                        <button class="btn" style="background: white; color: #86198f; font-weight: 600;" onclick="app.showTreatmentModal()">
                            <i class="bi bi-plus-lg"></i> Add Treatment
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-bandaid"></i> ${treatments.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${completed} Completed</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-arrow-repeat"></i> ${inProgress} In Progress</div>
                    </div>
                </div>
            </div>
            
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-purple);"><div class="modern-kpi-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-bandaid-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-purple);">${treatments.length}</div><div class="modern-kpi-label">Total Treatments</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);"><div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-green);">${completed}</div><div class="modern-kpi-label">Completed</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);"><div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-arrow-repeat"></i></div><div class="modern-kpi-value" style="color: var(--accent-amber);">${inProgress}</div><div class="modern-kpi-label">In Progress</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);"><div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-percent"></i></div><div class="modern-kpi-value" style="color: var(--accent-blue);">${treatments.length > 0 ? Math.round((completed/treatments.length)*100) : 0}%</div><div class="modern-kpi-label">Completion Rate</div></div>
            </div>
            
            <div class="modern-card">
                <div class="modern-card-header"><span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-purple);"></i> All Treatments</span><span class="badge badge-purple">${treatments.length} items</span></div>
                ${treatments.length > 0 ? `<div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>Risk</th><th>Type</th><th>Status</th><th>Owner</th><th>Due Date</th><th style="width: 100px;">Actions</th></tr></thead><tbody>${treatments.map(t => { const risk = this.getActiveData().risks.find(r => r.id === t.riskId); return `<tr onclick="app.editTreatment('${t.id}')"><td style="font-weight: 500;">${risk?.title || t.riskId}</td><td><span class="badge badge-${t.type === 'Mitigate' ? 'blue' : t.type === 'Accept' ? 'green' : t.type === 'Transfer' ? 'purple' : 'amber'}">${t.type}</span></td><td><span class="badge badge-${t.status === 'Completed' ? 'green' : t.status === 'In Progress' ? 'amber' : 'gray'}">${t.status}</span></td><td style="color: var(--text-secondary);">${t.owner || '-'}</td><td style="color: var(--text-secondary);">${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editTreatment('${t.id}')" title="Edit"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('treatments','${t.id}')" title="Delete"><i class="bi bi-trash3"></i></button></td></tr>`; }).join('')}</tbody></table></div>` : `<div class="modern-empty"><div class="modern-empty-icon"><i class="bi bi-bandaid"></i></div><h3>No Treatments Yet</h3><p>Create treatment plans to address identified risks.</p><button class="btn btn-primary" onclick="app.showTreatmentModal()"><i class="bi bi-plus-lg"></i> Add Your First Treatment</button></div>`}
            </div>
        `;
    }
    showTreatmentModal(t = null) {
        const isEdit = t !== null;
        this.setModalContext('treatment', { isEdit, item: t });
        openModal(isEdit ? 'Edit Treatment' : 'Add Treatment', `<div class="form-group"><label class="form-label">Related Risk *</label><select class="form-select" id="f-risk"><option value="">-- Select Risk --</option>${this.getActiveData().risks.map(r => `<option value="${r.id}" ${t?.riskId === r.id ? 'selected' : ''}>${r.title}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Mitigate', 'Accept', 'Transfer', 'Avoid'].map(ty => `<option value="${ty}" ${t?.type === ty ? 'selected' : ''}>${ty}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Planned', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${t?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${t?.owner || ''}"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${t?.dueDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Plan</label><textarea class="form-textarea" id="f-plan">${t?.plan || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveTreatment('${t?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveTreatment(editId) {
        const riskId = document.getElementById('f-risk').value;
        if (!riskId) { this.toast('Please select a risk', 'error'); return; }
        const item = { id: editId || this.generateId('TRT'), riskId, type: document.getElementById('f-type').value, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, dueDate: document.getElementById('f-due').value || null, plan: document.getElementById('f-plan').value, createdAt: editId ? this.getActiveData().treatments.find(t => t.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().treatments.findIndex(t => t.id === editId); if (idx !== -1) this.getActiveData().treatments[idx] = item; } else { this.getActiveData().treatments.push(item); }
        this.saveData('treatments'); closeModal(); this.renderTreatments(); this.toast(editId ? 'Treatment updated' : 'Treatment created', 'success');
    }
    editTreatment(id) { const t = this.getActiveData().treatments.find(x => x.id === id); if (t) this.showTreatmentModal(t); }
    renderMatrix() {
        const c = document.getElementById('tab-matrix');
        
        // Build inherent risk matrix (original risk scores)
        const inherentMatrix = Array(5).fill(null).map(() => Array(5).fill(null).map(() => []));
        this.getActiveData().risks.forEach(r => { 
            if (r.likelihood >= 1 && r.likelihood <= 5 && r.impact >= 1 && r.impact <= 5) {
                inherentMatrix[5 - r.impact][r.likelihood - 1].push(r); 
            }
        });
        
        // Build residual risk matrix (after treatments)
        const residualMatrix = Array(5).fill(null).map(() => Array(5).fill(null).map(() => []));
        this.getActiveData().risks.forEach(r => {
            const treatment = this.getActiveData().treatments.find(t => t.riskId === r.id && t.status === 'Completed');
            let resLikelihood = r.likelihood;
            let resImpact = r.impact;
            
            if (treatment) {
                if (treatment.type === 'Mitigate' || treatment.type === 'Transfer') {
                    resLikelihood = Math.max(1, r.likelihood - 1);
                    resImpact = Math.max(1, r.impact - 1);
                } else if (treatment.type === 'Avoid') {
                    resLikelihood = Math.max(1, r.likelihood - 2);
                    resImpact = Math.max(1, r.impact - 2);
                }
            }
            
            if (resLikelihood >= 1 && resLikelihood <= 5 && resImpact >= 1 && resImpact <= 5) {
                residualMatrix[5 - resImpact][resLikelihood - 1].push({...r, resLikelihood, resImpact});
            }
        });
        
        // Calculate statistics
        const totalRisks = this.getActiveData().risks.length;
        const criticalRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const highRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
        const mediumRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 6 && (r.likelihood * r.impact) < 12).length;
        const lowRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) < 6).length;
        
        const treatedRiskIds = new Set(this.getActiveData().treatments.filter(t => t.status === 'Completed').map(t => t.riskId));
        const treatedRisks = this.getActiveData().risks.filter(r => treatedRiskIds.has(r.id)).length;
        
        const avgInherentScore = totalRisks > 0 ? 
            (this.getActiveData().risks.reduce((sum, r) => sum + (r.likelihood * r.impact), 0) / totalRisks).toFixed(1) : 0;
        
        let totalResidualScore = 0;
        this.getActiveData().risks.forEach(r => {
            const treatment = this.getActiveData().treatments.find(t => t.riskId === r.id && t.status === 'Completed');
            let resL = r.likelihood, resI = r.impact;
            if (treatment) {
                if (treatment.type === 'Mitigate' || treatment.type === 'Transfer') {
                    resL = Math.max(1, r.likelihood - 1);
                    resI = Math.max(1, r.impact - 1);
                } else if (treatment.type === 'Avoid') {
                    resL = Math.max(1, r.likelihood - 2);
                    resI = Math.max(1, r.impact - 2);
                }
            }
            totalResidualScore += resL * resI;
        });
        const avgResidualScore = totalRisks > 0 ? (totalResidualScore / totalRisks).toFixed(1) : 0;
        const riskReduction = avgInherentScore > 0 ? Math.round((1 - avgResidualScore/avgInherentScore) * 100) : 0;
        
        c.innerHTML = `
            <style>
                @keyframes matrix-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
                .matrix-hero { background: linear-gradient(-45deg, #0f172a, #1e3a5f, #312e81, #4c1d95); background-size: 400% 400%; animation: dash-gradient 15s ease infinite; border-radius: var(--radius-2xl); padding: 32px; position: relative; overflow: hidden; margin-bottom: 28px; }
                .matrix-kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 28px; }
                .matrix-kpi { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; }
                .matrix-kpi:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--accent-blue); }
                .matrix-kpi-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 0 auto 12px; }
                .matrix-kpi-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
                .matrix-kpi-label { font-size: 12px; color: var(--text-muted); }
                
                .matrix-heatmap-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 28px; }
                .matrix-card { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); overflow: hidden; transition: all 0.3s; }
                .matrix-card:hover { box-shadow: var(--shadow-lg); }
                .matrix-card-header { padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
                .matrix-card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
                .matrix-card-body { padding: 24px; }
                
                .modern-heatmap { display: flex; gap: 12px; }
                .modern-heatmap-labels { display: flex; flex-direction: column; justify-content: space-around; padding: 32px 0 8px; }
                .modern-heatmap-label { font-size: 12px; color: var(--text-muted); font-weight: 500; height: 48px; display: flex; align-items: center; }
                .modern-heatmap-grid { flex: 1; }
                .modern-heatmap-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 6px; text-align: center; }
                .modern-heatmap-header span { font-size: 12px; color: var(--text-muted); font-weight: 500; padding: 8px 0; }
                .modern-heatmap-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 6px; }
                .modern-heatmap-cell { height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; color: white; cursor: pointer; transition: all 0.2s; position: relative; }
                .modern-heatmap-cell:hover { transform: scale(1.08); z-index: 2; box-shadow: 0 8px 25px rgba(0,0,0,0.25); }
                .modern-heatmap-cell[data-risk="critical"] { background: linear-gradient(135deg, #ef4444, #dc2626); }
                .modern-heatmap-cell[data-risk="high"] { background: linear-gradient(135deg, #f97316, #ea580c); }
                .modern-heatmap-cell[data-risk="medium"] { background: linear-gradient(135deg, #eab308, #ca8a04); }
                .modern-heatmap-cell[data-risk="low"] { background: linear-gradient(135deg, #22c55e, #16a34a); }
                .modern-heatmap-cell[data-risk="none"] { background: var(--bg-elevated); color: var(--text-muted); }
                .modern-heatmap-cell[data-risk="none"]:hover { background: var(--bg-hover); }
                
                .matrix-legend { display: flex; justify-content: center; gap: 24px; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-lg); margin-top: 16px; }
                .matrix-legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
                .matrix-legend-dot { width: 16px; height: 16px; border-radius: 4px; }
                
                .matrix-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 28px; }
                .matrix-stat-card { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); padding: 24px; }
                .matrix-stat-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
                .matrix-stat-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
                .matrix-stat-title { font-size: 14px; font-weight: 600; }
                
                .matrix-risk-list { max-height: 400px; overflow-y: auto; }
                .matrix-risk-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: all 0.2s; }
                .matrix-risk-item:hover { background: var(--bg-elevated); }
                .matrix-risk-score { min-width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 700; color: white; }
            </style>
            
            <!-- Hero Banner -->
            <div class="matrix-hero">
                <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(239,68,68,0.3) 0%, transparent 70%); pointer-events: none;"></div>
                <div style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(34,197,94,0.2) 0%, transparent 70%); pointer-events: none;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                        <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2);">
                            <i class="bi bi-grid-3x3-gap-fill" style="font-size: 26px; color: white;"></i>
                        </div>
                        <div>
                            <h1 style="font-size: 24px; font-weight: 700; margin: 0; color: white;">Risk Matrix & Analytics</h1>
                            <p style="font-size: 14px; color: rgba(255,255,255,0.7); margin: 0;">Visualize inherent vs residual risk with interactive heatmaps</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="matrix-kpi-grid">
                <div class="matrix-kpi" onclick="app.switchTab('risks')">
                    <div class="matrix-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    <div class="matrix-kpi-value" style="color: var(--accent-blue);">${totalRisks}</div>
                    <div class="matrix-kpi-label">Total Risks</div>
                </div>
                <div class="matrix-kpi" onclick="app.filterRisksByLevel('critical')">
                    <div class="matrix-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-octagon-fill"></i></div>
                    <div class="matrix-kpi-value" style="color: var(--accent-red);">${criticalRisks}</div>
                    <div class="matrix-kpi-label">Critical</div>
                </div>
                <div class="matrix-kpi" onclick="app.filterRisksByLevel('high')">
                    <div class="matrix-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-exclamation-diamond-fill"></i></div>
                    <div class="matrix-kpi-value" style="color: var(--accent-amber);">${highRisks}</div>
                    <div class="matrix-kpi-label">High</div>
                </div>
                <div class="matrix-kpi" onclick="app.switchTab('treatments')">
                    <div class="matrix-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-shield-check"></i></div>
                    <div class="matrix-kpi-value" style="color: var(--accent-green);">${treatedRisks}/${totalRisks}</div>
                    <div class="matrix-kpi-label">Treated</div>
                </div>
                <div class="matrix-kpi">
                    <div class="matrix-kpi-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-graph-down-arrow"></i></div>
                    <div class="matrix-kpi-value" style="color: var(--accent-purple);">${avgInherentScore} → ${avgResidualScore}</div>
                    <div class="matrix-kpi-label">Avg Score Change</div>
                </div>
            </div>
            
            <!-- Heatmaps Side by Side -->
            <div class="matrix-heatmap-container">
                <!-- Inherent Risk Heatmap -->
                <div class="matrix-card">
                    <div class="matrix-card-header" style="background: linear-gradient(135deg, var(--accent-red-soft), transparent);">
                        <span class="matrix-card-title"><i class="bi bi-grid-3x3-gap" style="color: var(--accent-red);"></i> Inherent Risk Heatmap</span>
                        <span class="badge badge-red">Before Controls</span>
                    </div>
                    <div class="matrix-card-body">
                        <div class="modern-heatmap">
                            <div class="modern-heatmap-labels">
                                <div class="modern-heatmap-label">5</div>
                                <div class="modern-heatmap-label">4</div>
                                <div class="modern-heatmap-label">3</div>
                                <div class="modern-heatmap-label">2</div>
                                <div class="modern-heatmap-label">1</div>
                            </div>
                            <div class="modern-heatmap-grid">
                                <div class="modern-heatmap-header">
                                    <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                                </div>
                                ${[5,4,3,2,1].map(impact => `
                                    <div class="modern-heatmap-row">
                                        ${[1,2,3,4,5].map(likelihood => {
                                            const risks = inherentMatrix[5-impact][likelihood-1];
                                            const score = likelihood * impact;
                                            const level = score >= 20 ? 'critical' : score >= 12 ? 'high' : score >= 6 ? 'medium' : 'low';
                                            return `<div class="modern-heatmap-cell" data-risk="${risks.length > 0 ? level : 'none'}" 
                                                onclick="app.showMatrixCellRisks(${likelihood}, ${impact}, 'inherent')"
                                                title="L${likelihood} x I${impact} = ${score}${risks.length > 0 ? ' | ' + risks.length + ' risk(s)' : ''}">
                                                ${risks.length > 0 ? risks.length : ''}
                                            </div>`;
                                        }).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 11px; color: var(--text-muted);">
                            <span><strong>Impact</strong> (vertical)</span>
                            <span><strong>Likelihood</strong> (horizontal)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Residual Risk Heatmap -->
                <div class="matrix-card">
                    <div class="matrix-card-header" style="background: linear-gradient(135deg, var(--accent-green-soft), transparent);">
                        <span class="matrix-card-title"><i class="bi bi-grid-3x3-gap" style="color: var(--accent-green);"></i> Residual Risk Heatmap</span>
                        <span class="badge badge-green">After Treatments</span>
                    </div>
                    <div class="matrix-card-body">
                        <div class="modern-heatmap">
                            <div class="modern-heatmap-labels">
                                <div class="modern-heatmap-label">5</div>
                                <div class="modern-heatmap-label">4</div>
                                <div class="modern-heatmap-label">3</div>
                                <div class="modern-heatmap-label">2</div>
                                <div class="modern-heatmap-label">1</div>
                            </div>
                            <div class="modern-heatmap-grid">
                                <div class="modern-heatmap-header">
                                    <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                                </div>
                                ${[5,4,3,2,1].map(impact => `
                                    <div class="modern-heatmap-row">
                                        ${[1,2,3,4,5].map(likelihood => {
                                            const risks = residualMatrix[5-impact][likelihood-1];
                                            const score = likelihood * impact;
                                            const level = score >= 20 ? 'critical' : score >= 12 ? 'high' : score >= 6 ? 'medium' : 'low';
                                            return `<div class="modern-heatmap-cell" data-risk="${risks.length > 0 ? level : 'none'}" 
                                                onclick="app.showMatrixCellRisks(${likelihood}, ${impact}, 'residual')"
                                                title="L${likelihood} x I${impact} = ${score}${risks.length > 0 ? ' | ' + risks.length + ' risk(s)' : ''}">
                                                ${risks.length > 0 ? risks.length : ''}
                                            </div>`;
                                        }).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 11px; color: var(--text-muted);">
                            <span><strong>Impact</strong> (vertical)</span>
                            <span><strong>Likelihood</strong> (horizontal)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="matrix-legend">
                <div class="matrix-legend-item"><div class="matrix-legend-dot" style="background: linear-gradient(135deg, #ef4444, #dc2626);"></div> Critical (20-25)</div>
                <div class="matrix-legend-item"><div class="matrix-legend-dot" style="background: linear-gradient(135deg, #f97316, #ea580c);"></div> High (12-19)</div>
                <div class="matrix-legend-item"><div class="matrix-legend-dot" style="background: linear-gradient(135deg, #eab308, #ca8a04);"></div> Medium (6-11)</div>
                <div class="matrix-legend-item"><div class="matrix-legend-dot" style="background: linear-gradient(135deg, #22c55e, #16a34a);"></div> Low (1-5)</div>
                <div class="matrix-legend-item" style="margin-left: auto; color: var(--text-muted);"><i class="bi bi-hand-index"></i> Click cells to view risks</div>
            </div>
            
            <!-- Stats Cards -->
            <div class="matrix-stats-grid" style="margin-top: 28px;">
                <!-- Risk Distribution -->
                <div class="matrix-stat-card">
                    <div class="matrix-stat-header">
                        <div class="matrix-stat-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-pie-chart-fill"></i></div>
                        <span class="matrix-stat-title">Risk Distribution</span>
                    </div>
                    ${totalRisks > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; border-radius: 3px; background: #ef4444;"></div>
                            <span style="flex: 1; font-size: 13px;">Critical</span>
                            <div style="width: 80px; height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${(criticalRisks/totalRisks)*100}%; height: 100%; background: #ef4444; border-radius: 4px;"></div>
                            </div>
                            <span style="font-size: 13px; font-weight: 600; width: 24px; text-align: right;">${criticalRisks}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; border-radius: 3px; background: #f97316;"></div>
                            <span style="flex: 1; font-size: 13px;">High</span>
                            <div style="width: 80px; height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${(highRisks/totalRisks)*100}%; height: 100%; background: #f97316; border-radius: 4px;"></div>
                            </div>
                            <span style="font-size: 13px; font-weight: 600; width: 24px; text-align: right;">${highRisks}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; border-radius: 3px; background: #eab308;"></div>
                            <span style="flex: 1; font-size: 13px;">Medium</span>
                            <div style="width: 80px; height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${(mediumRisks/totalRisks)*100}%; height: 100%; background: #eab308; border-radius: 4px;"></div>
                            </div>
                            <span style="font-size: 13px; font-weight: 600; width: 24px; text-align: right;">${mediumRisks}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; border-radius: 3px; background: #22c55e;"></div>
                            <span style="flex: 1; font-size: 13px;">Low</span>
                            <div style="width: 80px; height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${(lowRisks/totalRisks)*100}%; height: 100%; background: #22c55e; border-radius: 4px;"></div>
                            </div>
                            <span style="font-size: 13px; font-weight: 600; width: 24px; text-align: right;">${lowRisks}</span>
                        </div>
                    </div>
                    ` : `<div style="text-align: center; padding: 20px; color: var(--text-muted);"><i class="bi bi-pie-chart" style="font-size: 32px; opacity: 0.3;"></i><p style="margin-top: 8px;">No risks yet</p></div>`}
                </div>
                
                <!-- Treatment Coverage -->
                <div class="matrix-stat-card">
                    <div class="matrix-stat-header">
                        <div class="matrix-stat-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-bandaid-fill"></i></div>
                        <span class="matrix-stat-title">Treatment Coverage</span>
                    </div>
                    ${totalRisks > 0 ? `
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 42px; font-weight: 800; color: var(--accent-green);">${Math.round(treatedRisks/totalRisks*100)}%</div>
                        <div style="font-size: 13px; color: var(--text-muted);">${treatedRisks} of ${totalRisks} risks treated</div>
                    </div>
                    <div style="height: 12px; background: var(--bg-elevated); border-radius: 6px; overflow: hidden;">
                        <div style="width: ${(treatedRisks/totalRisks)*100}%; height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 6px; transition: width 0.5s;"></div>
                    </div>
                    ` : `<div style="text-align: center; padding: 20px; color: var(--text-muted);"><i class="bi bi-bandaid" style="font-size: 32px; opacity: 0.3;"></i><p style="margin-top: 8px;">No risks yet</p></div>`}
                </div>
                
                <!-- Risk Reduction -->
                <div class="matrix-stat-card">
                    <div class="matrix-stat-header">
                        <div class="matrix-stat-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-graph-down-arrow"></i></div>
                        <span class="matrix-stat-title">Risk Reduction</span>
                    </div>
                    ${totalRisks > 0 ? `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${avgInherentScore}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Inherent</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${avgResidualScore}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Residual</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--accent-green-soft); border-radius: var(--radius-md);">
                        <span style="font-size: 18px; font-weight: 700; color: var(--accent-green);">${riskReduction}% Reduction</span>
                    </div>
                    ` : `<div style="text-align: center; padding: 20px; color: var(--text-muted);"><i class="bi bi-graph-down" style="font-size: 32px; opacity: 0.3;"></i><p style="margin-top: 8px;">No risks yet</p></div>`}
                </div>
            </div>
            
            <!-- Top Risks Table -->
            <div class="matrix-card" style="margin-top: 28px;">
                <div class="matrix-card-header">
                    <span class="matrix-card-title"><i class="bi bi-list-ol" style="color: var(--accent-red);"></i> Top Risks by Score</span>
                    <button class="btn btn-secondary btn-sm" onclick="app.switchTab('risks')"><i class="bi bi-arrow-right"></i> View All</button>
                </div>
                <div class="matrix-card-body" style="padding: 0;">
                    <div class="matrix-risk-list">
                        ${this.getActiveData().risks.sort((a,b) => (b.likelihood * b.impact) - (a.likelihood * a.impact)).slice(0, 8).map(r => {
                            const score = r.likelihood * r.impact;
                            const bg = score >= 20 ? '#ef4444' : score >= 12 ? '#f97316' : score >= 6 ? '#eab308' : '#22c55e';
                            return `
                                <div class="matrix-risk-item" onclick="app.switchTab('risks')">
                                    <div class="matrix-risk-score" style="background: ${bg};">${score}</div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${this.esc(r.title)}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${r.category} • L${r.likelihood} × I${r.impact}</div>
                                    </div>
                                    <span class="badge badge-${r.status === 'Open' ? 'amber' : r.status === 'In Progress' ? 'blue' : 'green'}">${r.status}</span>
                                    <i class="bi bi-chevron-right" style="color: var(--text-muted);"></i>
                                </div>
                            `;
                        }).join('') || '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="bi bi-shield-check" style="font-size: 32px; color: var(--accent-green);"></i><p style="margin-top: 8px;">No risks recorded yet</p></div>'}
                    </div>
                </div>
            </div>
        `;
    }
    
    showMatrixCellRisks(likelihood, impact, type) {
        const score = likelihood * impact;
        const level = score >= 20 ? 'Critical' : score >= 12 ? 'High' : score >= 6 ? 'Medium' : 'Low';
        
        let risks = [];
        if (type === 'inherent') {
            risks = this.getActiveData().risks.filter(r => r.likelihood === likelihood && r.impact === impact);
        } else {
            // For residual, we need to calculate the residual position
            this.getActiveData().risks.forEach(r => {
                const treatment = this.getActiveData().treatments.find(t => t.riskId === r.id && t.status === 'Completed');
                let resL = r.likelihood, resI = r.impact;
                if (treatment) {
                    if (treatment.type === 'Mitigate' || treatment.type === 'Transfer') {
                        resL = Math.max(1, r.likelihood - 1);
                        resI = Math.max(1, r.impact - 1);
                    } else if (treatment.type === 'Avoid') {
                        resL = Math.max(1, r.likelihood - 2);
                        resI = Math.max(1, r.impact - 2);
                    }
                }
                if (resL === likelihood && resI === impact) {
                    risks.push(r);
                }
            });
        }
        
        if (risks.length === 0) {
            this.toast(`No risks at L${likelihood} × I${impact}`, 'info');
            return;
        }
        
        const levelColor = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
        
        openModal(`${level} Risks (L${likelihood} × I${impact} = ${score})`, `
            <div style="max-height: 400px; overflow-y: auto;">
                ${risks.map(r => `
                    <div style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-elevated); border-radius: var(--radius-md); margin-bottom: 10px;">
                        <div style="min-width: 40px; height: 40px; background: var(--accent-${levelColor}-soft); color: var(--accent-${levelColor}); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">${r.likelihood * r.impact}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 2px;">${this.esc(r.title)}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${r.category} • ${r.status}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" onclick="closeModal(); app.switchTab('risks')"><i class="bi bi-arrow-right"></i> Go to Risks</button>
        `);
    }
    renderIssues() {
        const c = document.getElementById('tab-issues');
        const issues = this.getActiveData().issues;
        const critical = issues.filter(i => i.severity === 'Critical').length;
        const open = issues.filter(i => i.status === 'Open').length;
        
        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #7f1d1d, #991b1b, #b91c1c, #dc2626); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-bug-fill"></i></div>
                        <div style="flex: 1;"><h1>Issue Tracker</h1><p>Track compliance and security issues</p></div>
                        <button class="btn" style="background: white; color: #991b1b; font-weight: 600;" onclick="app.showIssueModal()"><i class="bi bi-plus-lg"></i> Add Issue</button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-bug"></i> ${issues.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-exclamation-octagon"></i> ${critical} Critical</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-clock"></i> ${open} Open</div>
                    </div>
                </div>
            </div>
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);"><div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-bug-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-red);">${issues.length}</div><div class="modern-kpi-label">Total Issues</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);"><div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-octagon-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-red);">${critical}</div><div class="modern-kpi-label">Critical</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);"><div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-clock-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-amber);">${open}</div><div class="modern-kpi-label">Open</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);"><div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-green);">${issues.filter(i => i.status === 'Closed').length}</div><div class="modern-kpi-label">Closed</div></div>
            </div>
            <div class="modern-card">
                <div class="modern-card-header"><span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-red);"></i> All Issues</span><span class="badge badge-red">${issues.length} items</span></div>
                ${issues.length > 0 ? `<div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>Title</th><th>Category</th><th>Severity</th><th>Status</th><th>Owner</th><th style="width: 100px;">Actions</th></tr></thead><tbody>${issues.map(i => `<tr onclick="app.editIssue('${i.id}')"><td style="font-weight: 500;">${this.esc(i.title)}</td><td><span class="badge badge-blue">${i.category}</span></td><td><span class="badge badge-${i.severity === 'Critical' ? 'red' : i.severity === 'High' ? 'amber' : 'green'}">${i.severity}</span></td><td><span class="badge badge-${i.status === 'Closed' ? 'green' : i.status === 'In Progress' ? 'amber' : 'red'}">${i.status}</span></td><td style="color: var(--text-secondary);">${i.owner || '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editIssue('${i.id}')" title="Edit"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('issues','${i.id}')" title="Delete"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table></div>` : `<div class="modern-empty"><div class="modern-empty-icon"><i class="bi bi-bug"></i></div><h3>No Issues Yet</h3><p>Track compliance and security issues.</p><button class="btn btn-primary" onclick="app.showIssueModal()"><i class="bi bi-plus-lg"></i> Add Your First Issue</button></div>`}
            </div>
        `;
    }
    showIssueModal(i = null) {
        const isEdit = i !== null;
        openModal(isEdit ? 'Edit Issue' : 'Add Issue', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${i?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="f-category">${['Process Gap', 'Compliance Issue', 'Technical Debt', 'Security Gap'].map(c => `<option value="${c}" ${i?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="f-severity">${['Critical', 'High', 'Medium', 'Low'].map(s => `<option value="${s}" ${i?.severity === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Open', 'In Progress', 'Closed'].map(s => `<option value="${s}" ${i?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${i?.owner || ''}"></div></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${i?.dueDate?.split('T')[0] || ''}"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${i?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveIssue('${i?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveIssue(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('ISS'), title, category: document.getElementById('f-category').value, severity: document.getElementById('f-severity').value, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, dueDate: document.getElementById('f-due').value || null, description: document.getElementById('f-desc').value, createdAt: editId ? this.getActiveData().issues.find(i => i.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().issues.findIndex(i => i.id === editId); if (idx !== -1) this.getActiveData().issues[idx] = item; } else { this.getActiveData().issues.push(item); }
        this.saveData('issues'); closeModal(); this.renderIssues(); this.toast(editId ? 'Issue updated' : 'Issue created', 'success');
    }
    editIssue(id) { const i = this.getActiveData().issues.find(x => x.id === id); if (i) this.showIssueModal(i); }
    renderIncidents() {
        const c = document.getElementById('tab-incidents');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Incident Log</h3><button class="btn btn-primary btn-sm" onclick="app.showIncidentModal()"><i class="bi bi-plus-lg"></i> Add Incident</button></div>${this.getActiveData().incidents.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Severity</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().incidents.map(i => `<tr><td><span class="font-mono text-muted">${i.id}</span></td><td class="font-semibold">${i.title}</td><td><span class="badge badge-blue">${i.type}</span></td><td><span class="badge badge-${i.severity === 'Critical' ? 'red' : i.severity === 'High' ? 'amber' : 'green'}">${i.severity}</span></td><td><span class="badge badge-${i.status === 'Resolved' ? 'green' : 'amber'}">${i.status}</span></td><td>${i.date ? new Date(i.date).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editIncident('${i.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('incidents','${i.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-lightning', 'No Incidents Yet', 'Log security and operational incidents.', 'showIncidentModal')}</div>`;
    }
    showIncidentModal(i = null) {
        const isEdit = i !== null;
        openModal(isEdit ? 'Edit Incident' : 'Add Incident', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${i?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Security', 'Availability', 'Phishing', 'Data Breach', 'Other'].map(t => `<option value="${t}" ${i?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="f-severity">${['Critical', 'High', 'Medium', 'Low'].map(s => `<option value="${s}" ${i?.severity === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Investigating', 'Resolved'].map(s => `<option value="${s}" ${i?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="f-date" value="${i?.date?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${i?.owner || ''}"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${i?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveIncident('${i?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveIncident(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('INC'), title, type: document.getElementById('f-type').value, severity: document.getElementById('f-severity').value, status: document.getElementById('f-status').value, date: document.getElementById('f-date').value || null, owner: document.getElementById('f-owner').value, description: document.getElementById('f-desc').value, createdAt: editId ? this.getActiveData().incidents.find(i => i.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().incidents.findIndex(i => i.id === editId); if (idx !== -1) this.getActiveData().incidents[idx] = item; } else { this.getActiveData().incidents.push(item); }
        this.saveData('incidents'); closeModal(); this.renderIncidents(); this.toast(editId ? 'Incident updated' : 'Incident logged', 'success');
    }
    editIncident(id) { const i = this.getActiveData().incidents.find(x => x.id === id); if (i) this.showIncidentModal(i); }
    renderTasks() {
        const c = document.getElementById('tab-tasks');
        const tasks = this.getActiveData().tasks;
        const completed = tasks.filter(t => t.status === 'Completed').length;
        const inProgress = tasks.filter(t => t.status === 'In Progress').length;
        
        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #14532d, #166534, #15803d, #22c55e); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-check2-square"></i></div>
                        <div style="flex: 1;"><h1>Task Management</h1><p>Track remediation and action items</p></div>
                        <button class="btn" style="background: white; color: #166534; font-weight: 600;" onclick="app.showTaskModal()"><i class="bi bi-plus-lg"></i> Add Task</button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-list-task"></i> ${tasks.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${completed} Completed</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-arrow-repeat"></i> ${inProgress} In Progress</div>
                    </div>
                </div>
            </div>
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);"><div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-list-task"></i></div><div class="modern-kpi-value" style="color: var(--accent-green);">${tasks.length}</div><div class="modern-kpi-label">Total Tasks</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);"><div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-green);">${completed}</div><div class="modern-kpi-label">Completed</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);"><div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-arrow-repeat"></i></div><div class="modern-kpi-value" style="color: var(--accent-amber);">${inProgress}</div><div class="modern-kpi-label">In Progress</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);"><div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-percent"></i></div><div class="modern-kpi-value" style="color: var(--accent-blue);">${tasks.length > 0 ? Math.round((completed/tasks.length)*100) : 0}%</div><div class="modern-kpi-label">Completion Rate</div></div>
            </div>
            <div class="modern-card">
                <div class="modern-card-header"><span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-green);"></i> All Tasks</span><span class="badge badge-green">${tasks.length} items</span></div>
                ${tasks.length > 0 ? `<div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>Title</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Due Date</th><th style="width: 100px;">Actions</th></tr></thead><tbody>${tasks.map(t => `<tr onclick="app.editTask('${t.id}')"><td style="font-weight: 500;">${this.esc(t.title)}</td><td><span class="badge badge-${t.priority === 'Critical' ? 'red' : t.priority === 'High' ? 'amber' : 'blue'}">${t.priority}</span></td><td><span class="badge badge-${t.status === 'Completed' ? 'green' : t.status === 'In Progress' ? 'amber' : 'gray'}">${t.status}</span></td><td style="color: var(--text-secondary);">${t.assignee || '-'}</td><td style="color: var(--text-secondary);">${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editTask('${t.id}')" title="Edit"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('tasks','${t.id}')" title="Delete"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table></div>` : `<div class="modern-empty"><div class="modern-empty-icon"><i class="bi bi-check2-square"></i></div><h3>No Tasks Yet</h3><p>Track remediation and action items.</p><button class="btn btn-primary" onclick="app.showTaskModal()"><i class="bi bi-plus-lg"></i> Add Your First Task</button></div>`}
            </div>
        `;
    }
    showTaskModal(t = null) {
        const isEdit = t !== null;
        openModal(isEdit ? 'Edit Task' : 'Add Task', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${t?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="f-priority">${['Critical', 'High', 'Medium', 'Low'].map(p => `<option value="${p}" ${t?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Not Started', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${t?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Assignee</label><input type="text" class="form-input" id="f-assignee" value="${t?.assignee || ''}"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${t?.dueDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes">${t?.notes || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveTask('${t?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveTask(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('TSK'), title, priority: document.getElementById('f-priority').value, status: document.getElementById('f-status').value, assignee: document.getElementById('f-assignee').value, dueDate: document.getElementById('f-due').value || null, notes: document.getElementById('f-notes').value, createdAt: editId ? this.getActiveData().tasks.find(t => t.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().tasks.findIndex(t => t.id === editId); if (idx !== -1) this.getActiveData().tasks[idx] = item; } else { this.getActiveData().tasks.push(item); }
        this.saveData('tasks'); closeModal(); this.renderTasks(); this.toast(editId ? 'Task updated' : 'Task created', 'success');
    }
    editTask(id) { const t = this.getActiveData().tasks.find(x => x.id === id); if (t) this.showTaskModal(t); }
    renderAudits() {
        const c = document.getElementById('tab-audits');
        const audits = this.getActiveData().audits;
        const completed = audits.filter(a => a.status === 'Completed').length;
        const inProgress = audits.filter(a => a.status === 'In Progress').length;
        
        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #1e3a8a, #1e40af, #2563eb, #3b82f6); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-clipboard-check-fill"></i></div>
                        <div style="flex: 1;"><h1>Audit Schedule</h1><p>Schedule and track compliance audits</p></div>
                        <button class="btn" style="background: white; color: #1e40af; font-weight: 600;" onclick="app.showAuditModal()"><i class="bi bi-plus-lg"></i> Add Audit</button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-clipboard-check"></i> ${audits.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${completed} Completed</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-arrow-repeat"></i> ${inProgress} In Progress</div>
                    </div>
                </div>
            </div>
            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);"><div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-clipboard-check-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-blue);">${audits.length}</div><div class="modern-kpi-label">Total Audits</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);"><div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div><div class="modern-kpi-value" style="color: var(--accent-green);">${completed}</div><div class="modern-kpi-label">Completed</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);"><div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-arrow-repeat"></i></div><div class="modern-kpi-value" style="color: var(--accent-amber);">${inProgress}</div><div class="modern-kpi-label">In Progress</div></div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-purple);"><div class="modern-kpi-icon" style="background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-calendar-event"></i></div><div class="modern-kpi-value" style="color: var(--accent-purple);">${audits.filter(a => a.status === 'Planned').length}</div><div class="modern-kpi-label">Planned</div></div>
            </div>
            <div class="modern-card">
                <div class="modern-card-header"><span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-blue);"></i> All Audits</span><span class="badge badge-blue">${audits.length} items</span></div>
                ${audits.length > 0 ? `<div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>Audit Name</th><th>Type</th><th>Status</th><th>Lead</th><th>Start Date</th><th style="width: 100px;">Actions</th></tr></thead><tbody>${audits.map(a => `<tr onclick="app.editAudit('${a.id}')"><td style="font-weight: 500;">${this.esc(a.name)}</td><td><span class="fw-badge fw-${a.type?.toLowerCase().replace(/\\s/g, '')}">${a.type}</span></td><td><span class="badge badge-${a.status === 'Completed' ? 'green' : a.status === 'In Progress' ? 'amber' : 'blue'}">${a.status}</span></td><td style="color: var(--text-secondary);">${a.lead || '-'}</td><td style="color: var(--text-secondary);">${a.startDate ? new Date(a.startDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editAudit('${a.id}')" title="Edit"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItem('audits','${a.id}')" title="Delete"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table></div>` : `<div class="modern-empty"><div class="modern-empty-icon"><i class="bi bi-clipboard-check"></i></div><h3>No Audits Yet</h3><p>Schedule and track compliance audits.</p><button class="btn btn-primary" onclick="app.showAuditModal()"><i class="bi bi-plus-lg"></i> Add Your First Audit</button></div>`}
            </div>
        `;
    }
    showAuditModal(a = null) {
        const isEdit = a !== null;
        openModal(isEdit ? 'Edit Audit' : 'Add Audit', `<div class="form-group"><label class="form-label">Audit Name *</label><input type="text" class="form-input" id="f-name" value="${a?.name || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['SOC 2', 'ISO 27001', 'PCI DSS', 'HIPAA', 'Internal', 'GDPR'].map(t => `<option value="${t}" ${a?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Planned', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${a?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Lead</label><input type="text" class="form-input" id="f-lead" value="${a?.lead || ''}"></div><div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="f-start" value="${a?.startDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Scope</label><textarea class="form-textarea" id="f-scope">${a?.scope || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveAudit('${a?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveAudit(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const item = { id: editId || this.generateId('AUD'), name, type: document.getElementById('f-type').value, status: document.getElementById('f-status').value, lead: document.getElementById('f-lead').value, startDate: document.getElementById('f-start').value || null, scope: document.getElementById('f-scope').value, createdAt: editId ? this.getActiveData().audits.find(a => a.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().audits.findIndex(a => a.id === editId); if (idx !== -1) this.getActiveData().audits[idx] = item; } else { this.getActiveData().audits.push(item); }
        this.saveData('audits'); closeModal(); this.renderAudits(); this.toast(editId ? 'Audit updated' : 'Audit scheduled', 'success');
    }
    editAudit(id) { const a = this.getActiveData().audits.find(x => x.id === id); if (a) this.showAuditModal(a); }
    renderEvidence() {
        const c = document.getElementById('tab-evidence');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Evidence Library</h3><button class="btn btn-primary btn-sm" onclick="app.showEvidenceModal()"><i class="bi bi-plus-lg"></i> Add Evidence</button></div>${this.getActiveData().evidence.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Related To</th><th>Owner</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().evidence.map(e => `<tr><td><span class="font-mono text-muted">${e.id}</span></td><td class="font-semibold">${e.title}</td><td><span class="badge badge-blue">${e.type}</span></td><td>${e.relatedTo || '-'}</td><td>${e.owner}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editEvidence('${e.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('evidence','${e.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-folder2-open', 'No Evidence Yet', 'Upload and organize audit evidence.', 'showEvidenceModal')}</div>`;
    }
    showEvidenceModal(e = null) {
        const isEdit = e !== null;
        this.setModalContext('evidence', { isEdit, item: e });
        openModal(isEdit ? 'Edit Evidence' : 'Add Evidence', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${e?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Screenshot', 'Document', 'Report', 'Export', 'Configuration', 'Log'].map(t => `<option value="${t}" ${e?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Related Control</label><select class="form-select" id="f-related"><option value="">-- None --</option>${this.getActiveData().controls.map(c => `<option value="${c.id}" ${e?.relatedTo === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${e?.owner || ''}"></div><div class="form-group"><label class="form-label">URL/Location</label><input type="text" class="form-input" id="f-url" value="${e?.url || ''}"></div><div class="form-group">
            <label class="form-label">Attachment (optional — stored locally in your browser)</label>
            <input type="file" class="form-input" id="f-file" accept=".pdf,.png,.jpg,.jpeg,.webp,.doc,.docx,.xls,.xlsx,.txt">
            <div class="text-muted" style="margin-top:6px;">
                ${e?.attachment?.name ? `Current: <span class="font-mono">${e.attachment.name}</span> (${Math.round((e.attachment.size||0)/1024)} KB)` : 'No attachment yet.'}
            </div>
            ${e?.attachment ? `<label style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                <input type="checkbox" id="f-file-remove"> Remove current attachment
            </label>` : ``}
        </div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes">${e?.notes || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveEvidence('${e?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    
saveEvidence(editId) {
        const d = this.getActiveData();
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }

        const existing = editId ? d.evidence.find(x => x.id === editId) : null;

        const baseItem = {
            id: editId || this.generateId('EVD'),
            title,
            type: document.getElementById('f-type').value,
            related: document.getElementById('f-related').value,
            owner: document.getElementById('f-owner').value.trim(),
            url: document.getElementById('f-url').value.trim(),
            notes: document.getElementById('f-notes').value.trim(),
            createdAt: editId ? (existing?.createdAt || new Date().toISOString()) : new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            uploadedAt: editId ? (existing?.uploadedAt || new Date().toISOString()) : new Date().toISOString(),
            attachment: existing?.attachment || null
        };

        const fileInput = document.getElementById('f-file');
        const removeFlag = document.getElementById('f-file-remove')?.checked;

        const finalizeSave = (item) => {
            if (editId) {
                const idx = d.evidence.findIndex(x => x.id === editId);
                if (idx >= 0) d.evidence[idx] = item;
            } else {
                d.evidence.push(item);
            }
            this.saveData('evidence');
            this.logEvent?.('evidence', `${editId ? 'Updated' : 'Added'} evidence ${item.id}`, { id: item.id });
            closeModal();
            this.renderEvidence();
            this.toast(editId ? 'Evidence updated' : 'Evidence added', 'success');
            if (!editId) this.showWorkflowPrompt('Evidence Collected — Next Step', 'Great, now test the control this evidence supports. Does the control actually work as intended?', 'testing', 'Run Control Test →');
        };

        // Handle removal
        if (removeFlag) baseItem.attachment = null;

        // Handle new file (optional)
        const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
        if (!file) {
            finalizeSave(baseItem);
            return;
        }

        // Guard: avoid huge localStorage entries
        const maxBytes = 2.5 * 1024 * 1024; // ~2.5MB
        if (file.size > maxBytes) {
            this.toast('File too large for in-browser storage (max ~2.5MB). Use URL/Location instead.', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = () => {
            baseItem.attachment = {
                name: file.name,
                mime: file.type || 'application/octet-stream',
                size: file.size,
                dataUrl: String(reader.result || '')
            };
            baseItem.uploadedAt = new Date().toISOString();
            finalizeSave(baseItem);
        };
        reader.onerror = () => this.toast('Failed to read file attachment', 'error');
        reader.readAsDataURL(file);
    }

    editEvidence(id) { const e = this.getActiveData().evidence.find(x => x.id === id); if (e) this.showEvidenceModal(e); }
    renderTesting() {
        const c = document.getElementById('tab-testing');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Control Testing</h3><button class="btn btn-primary btn-sm" onclick="app.showTestModal()"><i class="bi bi-plus-lg"></i> Add Test</button></div>${this.getActiveData().controlTests.length > 0 ? `<table><thead><tr><th>ID</th><th>Control</th><th>Test Date</th><th>Result</th><th>Tester</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().controlTests.map(t => { const ctrl = this.getActiveData().controls.find(c => c.id === t.controlId); return `<tr><td><span class="font-mono text-muted">${t.id}</span></td><td>${ctrl?.name || t.controlId}</td><td>${t.testDate ? new Date(t.testDate).toLocaleDateString() : '-'}</td><td><span class="badge badge-${t.result === 'Pass' ? 'green' : t.result === 'Fail' ? 'red' : 'amber'}">${t.result}</span></td><td>${t.tester}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editTest('${t.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('controlTests','${t.id}')"><i class="bi bi-trash3"></i></button></td></tr>`; }).join('')}</tbody></table>` : this.renderEmpty('bi-card-checklist', 'No Tests Yet', 'Document control testing results.', 'showTestModal')}</div>`;
    }
    showTestModal(t = null) {
        const isEdit = t !== null;
        openModal(isEdit ? 'Edit Test' : 'Record Test', `<div class="form-group"><label class="form-label">Control *</label><select class="form-select" id="test-control"><option value="">-- Select Control --</option>${this.getActiveData().controls.map(c => `<option value="${c.id}" ${t?.controlId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Test Date</label><input type="date" class="form-input" id="test-date" value="${t?.testDate?.split('T')[0] || ''}"></div><div class="form-group"><label class="form-label">Result</label><select class="form-select" id="test-result">${['Pass', 'Partial', 'Fail'].map(r => `<option value="${r}" ${t?.result === r ? 'selected' : ''}>${r}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Tester</label><input type="text" class="form-input" id="test-tester" value="${t?.tester || ''}"></div><div class="form-group"><label class="form-label">Procedure/Notes</label><textarea class="form-textarea" id="test-procedure">${t?.procedure || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveTest('${t?.id || ''}')">${isEdit ? 'Update' : 'Save'}</button>`);
    }
    saveTest(editId) {
        const controlId = document.getElementById('test-control').value;
        if (!controlId) { this.toast('Please select a control', 'error'); return; }
        const item = { id: editId || this.generateId('TST'), controlId, testDate: document.getElementById('test-date').value || null, result: document.getElementById('test-result').value, tester: document.getElementById('test-tester').value, procedure: document.getElementById('test-procedure').value, createdAt: editId ? this.getActiveData().controlTests.find(t => t.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().controlTests.findIndex(t => t.id === editId); if (idx !== -1) this.getActiveData().controlTests[idx] = item; } else { this.getActiveData().controlTests.push(item); }
        this.saveData('controlTests'); closeModal(); this.renderTesting(); this.toast(editId ? 'Test updated' : 'Test saved', 'success');
        if (!editId) this.showWorkflowPrompt('Test Completed — Next Step', 'If the test found issues, document a finding with severity, remediation plan, and due date. This closes the loop.', 'findings', 'Create Finding →');
    }
    editTest(id) { const t = this.getActiveData().controlTests.find(x => x.id === id); if (t) this.showTestModal(t); }
    renderFindings() {
        const c = document.getElementById('tab-findings');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Audit Findings</h3><button class="btn btn-primary btn-sm" onclick="app.showFindingModal()"><i class="bi bi-plus-lg"></i> Add Finding</button></div>${this.getActiveData().findings.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Severity</th><th>Status</th><th>Owner</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().findings.map(f => `<tr><td><span class="font-mono text-muted">${f.id}</span></td><td class="font-semibold">${f.title}</td><td><span class="badge badge-${f.severity === 'Critical' ? 'red' : f.severity === 'High' ? 'amber' : 'green'}">${f.severity}</span></td><td><span class="badge badge-${f.status === 'Closed' ? 'green' : f.status === 'In Progress' ? 'amber' : 'red'}">${f.status}</span></td><td>${f.owner}</td><td>${f.dueDate ? new Date(f.dueDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editFinding('${f.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('findings','${f.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-search', 'No Findings Yet', 'Document audit findings.', 'showFindingModal')}</div>`;
    }
    showFindingModal(f = null) {
        const isEdit = f !== null;
        openModal(isEdit ? 'Edit Finding' : 'Add Finding', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${f?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="f-severity">${['Critical', 'High', 'Medium', 'Low'].map(s => `<option value="${s}" ${f?.severity === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Open', 'In Progress', 'Closed'].map(s => `<option value="${s}" ${f?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${f?.owner || ''}"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${f?.dueDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${f?.description || ''}</textarea></div><div class="form-group"><label class="form-label">Recommendation</label><textarea class="form-textarea" id="f-rec">${f?.recommendation || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveFinding('${f?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveFinding(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('FND'), title, severity: document.getElementById('f-severity').value, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, dueDate: document.getElementById('f-due').value || null, description: document.getElementById('f-desc').value, recommendation: document.getElementById('f-rec').value, createdAt: editId ? this.getActiveData().findings.find(f => f.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().findings.findIndex(f => f.id === editId); if (idx !== -1) this.getActiveData().findings[idx] = item; } else { this.getActiveData().findings.push(item); }
        this.saveData('findings'); closeModal(); this.renderFindings(); this.toast(editId ? 'Finding updated' : 'Finding created', 'success');
        if (!editId) this.showWorkflowPrompt('Finding Documented — Next Step', 'Create a remediation task with an owner and due date. Track it to closure — aging findings are red flags for auditors.', 'tasks', 'Create Remediation Task →');
    }
    editFinding(id) { const f = this.getActiveData().findings.find(x => x.id === id); if (f) this.showFindingModal(f); }
    
    // ==================== STATEMENT OF APPLICABILITY ====================
    renderSoA() {
        const c = document.getElementById('tab-soa');
        
        // Get ISO 27001 Annex A controls from the control library
        const annexAControls = this.getAnnexAControls();
        
        // Map implemented controls to Annex A
        const implementedControlIds = new Set(this.getActiveData().controls.map(ctrl => ctrl.controlId || ctrl.id));
        
        // Calculate SoA statistics - DEFAULT TO NOT APPLICABLE
        const totalAnnexA = annexAControls.length;
        const applicable = annexAControls.filter(ac => {
            const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
            return soaEntry ? soaEntry.applicable : false; // Default to NOT applicable
        }).length;
        const implemented = annexAControls.filter(ac => {
            const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
            const isApplicable = soaEntry ? soaEntry.applicable : false;
            return isApplicable && this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name);
        }).length;
        const notApplicable = totalAnnexA - applicable;
        
        // Group controls by category
        const controlsByCategory = {};
        annexAControls.forEach(ac => {
            const cat = ac.category || 'Other';
            if (!controlsByCategory[cat]) controlsByCategory[cat] = [];
            controlsByCategory[cat].push(ac);
        });
        
        const categories = Object.keys(controlsByCategory).sort();
        const selectedCategory = this.soaSelectedCategory || ''; // Default to ALL categories
        
        c.innerHTML = `
            <div class="welcome-banner" style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 8px;"><i class="bi bi-file-earmark-check-fill"></i> Statement of Applicability (SoA)</h2>
                <p style="color: var(--text-secondary);">The SoA documents which ISO 27001 Annex A controls are applicable to your organization, their implementation status, and justification. Required for ISO 27001 certification.</p>
            </div>
            
            <!-- SoA Overview Stats -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-icon blue"><i class="bi bi-list-check"></i></div>
                    <div class="metric-value">${totalAnnexA}</div>
                    <div class="metric-label">Total Annex A Controls</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon green"><i class="bi bi-check-circle"></i></div>
                    <div class="metric-value">${applicable}</div>
                    <div class="metric-label">Applicable</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon purple"><i class="bi bi-shield-fill-check"></i></div>
                    <div class="metric-value">${implemented}</div>
                    <div class="metric-label">Implemented</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon amber"><i class="bi bi-x-circle"></i></div>
                    <div class="metric-value">${notApplicable}</div>
                    <div class="metric-label">Not Applicable</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon cyan"><i class="bi bi-percent"></i></div>
                    <div class="metric-value">${applicable > 0 ? Math.round(implemented/applicable*100) : 0}%</div>
                    <div class="metric-label">Implementation Rate</div>
                </div>
            </div>
            
            <!-- Implementation Progress by Category -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title"><i class="bi bi-bar-chart"></i> Implementation Progress by Category</div>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        ${categories.map(cat => {
                            const catControls = controlsByCategory[cat];
                            const catTotal = catControls.length;
                            const catImplemented = catControls.filter(ac => 
                                this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name)
                            ).length;
                            const catPercent = catTotal > 0 ? Math.round(catImplemented/catTotal*100) : 0;
                            const colorClass = catPercent >= 80 ? 'green' : catPercent >= 50 ? 'amber' : 'red';
                            return `
                                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 500;">${cat}</span>
                                        <span class="badge badge-${colorClass}">${catImplemented}/${catTotal}</span>
                                    </div>
                                    <div class="progress-bar" style="height: 8px;">
                                        <div class="progress-fill ${colorClass}" style="width: ${catPercent}%;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            <!-- SoA Table -->
            <div class="card">
                <div class="card-header" style="position: sticky; top: 0; z-index: 20; background: var(--bg-surface); flex-wrap: wrap; gap: 12px;">
                    <div class="card-title"><i class="bi bi-table"></i> Annex A Controls</div>
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-sm ${selectedCategory === '' ? 'btn-primary' : 'btn-secondary'}" onclick="app.filterSoACategory('')">All</button>
                        ${categories.map(cat => `<button class="btn btn-sm ${selectedCategory === cat ? 'btn-primary' : 'btn-secondary'}" onclick="app.filterSoACategory('${cat}')">${cat}</button>`).join('')}
                        <button class="btn btn-sm btn-secondary" onclick="app.exportSoA()" style="margin-left: 8px;"><i class="bi bi-download"></i> Export</button>
                    </div>
                </div>
                <div style="max-height: 600px; overflow-y: auto;">
                    <table style="width: 100%;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr style="background: var(--bg-surface);">
                                <th style="width: 100px; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Control ID</th>
                                <th style="background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Control Name</th>
                                <th style="width: 150px; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Category</th>
                                <th style="width: 100px; text-align: center; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Applicable</th>
                                <th style="width: 120px; text-align: center; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Status</th>
                                <th style="width: 80px; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(selectedCategory ? controlsByCategory[selectedCategory] : annexAControls).map(ac => {
                                const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
                                const isApplicable = soaEntry ? soaEntry.applicable : false; // Default to NOT applicable
                                const isImplemented = isApplicable && this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name);
                                const justification = soaEntry?.justification || '';
                                
                                let statusBadge = '';
                                if (!isApplicable) {
                                    statusBadge = '<span class="badge" style="background: var(--bg-elevated);">N/A</span>';
                                } else if (isImplemented) {
                                    statusBadge = '<span class="badge badge-green">Implemented</span>';
                                } else {
                                    statusBadge = '<span class="badge badge-amber">Gap</span>';
                                }
                                
                                return `
                                    <tr>
                                        <td><span class="font-mono text-muted">${ac.id}</span></td>
                                        <td>
                                            <div class="font-semibold">${ac.name}</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${ac.description?.substring(0, 80) || ''}${ac.description?.length > 80 ? '...' : ''}</div>
                                        </td>
                                        <td><span class="badge badge-blue" style="font-size: 11px;">${ac.category}</span></td>
                                        <td style="text-align: center;">
                                            <button class="btn btn-ghost btn-sm" onclick="app.toggleSoAApplicability('${ac.id}')" title="Toggle applicability">
                                                <i class="bi ${isApplicable ? 'bi-check-circle-fill' : 'bi-x-circle'}" style="color: ${isApplicable ? 'var(--accent-green)' : 'var(--text-muted)'}; font-size: 18px;"></i>
                                            </button>
                                        </td>
                                        <td style="text-align: center;">${statusBadge}</td>
                                        <td>
                                            <button class="btn btn-ghost btn-sm" onclick="app.editSoAEntry('${ac.id}')" title="Edit justification">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            ${!isImplemented && isApplicable ? `
                                                <button class="btn btn-ghost btn-sm" onclick="app.addControlFromSoA('${ac.id}')" title="Add control">
                                                    <i class="bi bi-plus-lg"></i>
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- SoA Legend -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 24px; align-items: center;">
                        <div style="font-size: 13px; font-weight: 600;">Legend:</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-check-circle-fill" style="color: var(--accent-green);"></i>
                            <span style="font-size: 13px;">Applicable</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-x-circle" style="color: var(--text-muted);"></i>
                            <span style="font-size: 13px;">Not Applicable</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="badge badge-green">Implemented</span>
                            <span style="font-size: 13px;">Control is in place</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="badge badge-amber">Gap</span>
                            <span style="font-size: 13px;">Control not yet implemented</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    getAnnexAControls() {
        // ISO 27001:2022 Annex A Controls (93 controls across 4 themes)
        return [
            // Organizational Controls (A.5)
            { id: 'A.5.1', name: 'Policies for information security', category: 'Organizational', description: 'Information security policy and topic-specific policies shall be defined.' },
            { id: 'A.5.2', name: 'Information security roles and responsibilities', category: 'Organizational', description: 'Information security roles and responsibilities shall be defined and allocated.' },
            { id: 'A.5.3', name: 'Segregation of duties', category: 'Organizational', description: 'Conflicting duties and areas of responsibility shall be segregated.' },
            { id: 'A.5.4', name: 'Management responsibilities', category: 'Organizational', description: 'Management shall require personnel to apply information security.' },
            { id: 'A.5.5', name: 'Contact with authorities', category: 'Organizational', description: 'Appropriate contacts with relevant authorities shall be maintained.' },
            { id: 'A.5.6', name: 'Contact with special interest groups', category: 'Organizational', description: 'Contacts with special interest groups shall be maintained.' },
            { id: 'A.5.7', name: 'Threat intelligence', category: 'Organizational', description: 'Information about threats shall be collected and analyzed.' },
            { id: 'A.5.8', name: 'Information security in project management', category: 'Organizational', description: 'Information security shall be integrated into project management.' },
            { id: 'A.5.9', name: 'Inventory of information and assets', category: 'Organizational', description: 'An inventory of information and associated assets shall be maintained.' },
            { id: 'A.5.10', name: 'Acceptable use of information', category: 'Organizational', description: 'Rules for acceptable use shall be identified and documented.' },
            { id: 'A.5.11', name: 'Return of assets', category: 'Organizational', description: 'Personnel shall return assets upon termination.' },
            { id: 'A.5.12', name: 'Classification of information', category: 'Organizational', description: 'Information shall be classified according to security needs.' },
            { id: 'A.5.13', name: 'Labelling of information', category: 'Organizational', description: 'Appropriate labelling procedures shall be developed.' },
            { id: 'A.5.14', name: 'Information transfer', category: 'Organizational', description: 'Information transfer rules and procedures shall be in place.' },
            { id: 'A.5.15', name: 'Access control', category: 'Organizational', description: 'Access control rules shall be established and implemented.' },
            { id: 'A.5.16', name: 'Identity management', category: 'Organizational', description: 'The full lifecycle of identities shall be managed.' },
            { id: 'A.5.17', name: 'Authentication information', category: 'Organizational', description: 'Allocation of authentication information shall be controlled.' },
            { id: 'A.5.18', name: 'Access rights', category: 'Organizational', description: 'Access rights shall be provisioned, reviewed, modified and removed.' },
            { id: 'A.5.19', name: 'Information security in supplier relationships', category: 'Organizational', description: 'Security requirements for supplier relationships shall be defined.' },
            { id: 'A.5.20', name: 'Addressing security in supplier agreements', category: 'Organizational', description: 'Security requirements shall be established with suppliers.' },
            { id: 'A.5.21', name: 'Managing information security in ICT supply chain', category: 'Organizational', description: 'Security in ICT supply chain shall be managed.' },
            { id: 'A.5.22', name: 'Monitoring and review of supplier services', category: 'Organizational', description: 'Supplier service delivery shall be monitored and reviewed.' },
            { id: 'A.5.23', name: 'Information security for cloud services', category: 'Organizational', description: 'Cloud service security shall be managed.' },
            { id: 'A.5.24', name: 'Information security incident management planning', category: 'Organizational', description: 'Incident management shall be planned and prepared.' },
            { id: 'A.5.25', name: 'Assessment and decision on information security events', category: 'Organizational', description: 'Security events shall be assessed and decided upon.' },
            { id: 'A.5.26', name: 'Response to information security incidents', category: 'Organizational', description: 'Information security incidents shall be responded to.' },
            { id: 'A.5.27', name: 'Learning from information security incidents', category: 'Organizational', description: 'Knowledge from incidents shall be used to strengthen controls.' },
            { id: 'A.5.28', name: 'Collection of evidence', category: 'Organizational', description: 'Evidence collection procedures shall be defined and applied.' },
            { id: 'A.5.29', name: 'Information security during disruption', category: 'Organizational', description: 'Security shall be maintained during disruption.' },
            { id: 'A.5.30', name: 'ICT readiness for business continuity', category: 'Organizational', description: 'ICT readiness shall be planned and implemented.' },
            { id: 'A.5.31', name: 'Legal, statutory, regulatory and contractual requirements', category: 'Organizational', description: 'Legal and regulatory requirements shall be identified.' },
            { id: 'A.5.32', name: 'Intellectual property rights', category: 'Organizational', description: 'Intellectual property rights shall be protected.' },
            { id: 'A.5.33', name: 'Protection of records', category: 'Organizational', description: 'Records shall be protected from loss and unauthorized access.' },
            { id: 'A.5.34', name: 'Privacy and protection of PII', category: 'Organizational', description: 'Privacy and PII protection shall be ensured.' },
            { id: 'A.5.35', name: 'Independent review of information security', category: 'Organizational', description: 'Information security shall be independently reviewed.' },
            { id: 'A.5.36', name: 'Compliance with policies, rules and standards', category: 'Organizational', description: 'Compliance shall be regularly reviewed.' },
            { id: 'A.5.37', name: 'Documented operating procedures', category: 'Organizational', description: 'Operating procedures shall be documented and available.' },
            // People Controls (A.6)
            { id: 'A.6.1', name: 'Screening', category: 'People', description: 'Background verification checks shall be carried out.' },
            { id: 'A.6.2', name: 'Terms and conditions of employment', category: 'People', description: 'Employment agreements shall state security responsibilities.' },
            { id: 'A.6.3', name: 'Information security awareness, education and training', category: 'People', description: 'Personnel shall receive appropriate security awareness.' },
            { id: 'A.6.4', name: 'Disciplinary process', category: 'People', description: 'A disciplinary process shall be formalized.' },
            { id: 'A.6.5', name: 'Responsibilities after termination or change', category: 'People', description: 'Security responsibilities shall remain valid after changes.' },
            { id: 'A.6.6', name: 'Confidentiality or non-disclosure agreements', category: 'People', description: 'Confidentiality agreements shall be identified and reviewed.' },
            { id: 'A.6.7', name: 'Remote working', category: 'People', description: 'Security measures for remote working shall be implemented.' },
            { id: 'A.6.8', name: 'Information security event reporting', category: 'People', description: 'Personnel shall report security events promptly.' },
            // Physical Controls (A.7)
            { id: 'A.7.1', name: 'Physical security perimeters', category: 'Physical', description: 'Security perimeters shall be defined and used.' },
            { id: 'A.7.2', name: 'Physical entry', category: 'Physical', description: 'Secure areas shall be protected by entry controls.' },
            { id: 'A.7.3', name: 'Securing offices, rooms and facilities', category: 'Physical', description: 'Physical security shall be designed and implemented.' },
            { id: 'A.7.4', name: 'Physical security monitoring', category: 'Physical', description: 'Premises shall be continuously monitored.' },
            { id: 'A.7.5', name: 'Protecting against physical and environmental threats', category: 'Physical', description: 'Protection against threats shall be designed.' },
            { id: 'A.7.6', name: 'Working in secure areas', category: 'Physical', description: 'Security measures for working in secure areas shall apply.' },
            { id: 'A.7.7', name: 'Clear desk and clear screen', category: 'Physical', description: 'Clear desk and screen rules shall be defined.' },
            { id: 'A.7.8', name: 'Equipment siting and protection', category: 'Physical', description: 'Equipment shall be sited and protected.' },
            { id: 'A.7.9', name: 'Security of assets off-premises', category: 'Physical', description: 'Off-site assets shall be protected.' },
            { id: 'A.7.10', name: 'Storage media', category: 'Physical', description: 'Storage media shall be managed through lifecycle.' },
            { id: 'A.7.11', name: 'Supporting utilities', category: 'Physical', description: 'Supporting utilities shall be protected.' },
            { id: 'A.7.12', name: 'Cabling security', category: 'Physical', description: 'Cables shall be protected from interference.' },
            { id: 'A.7.13', name: 'Equipment maintenance', category: 'Physical', description: 'Equipment shall be maintained correctly.' },
            { id: 'A.7.14', name: 'Secure disposal or re-use of equipment', category: 'Physical', description: 'Equipment shall be securely disposed or re-used.' },
            // Technological Controls (A.8)
            { id: 'A.8.1', name: 'User endpoint devices', category: 'Technological', description: 'Information on endpoint devices shall be protected.' },
            { id: 'A.8.2', name: 'Privileged access rights', category: 'Technological', description: 'Privileged access shall be restricted and managed.' },
            { id: 'A.8.3', name: 'Information access restriction', category: 'Technological', description: 'Access to information shall be restricted.' },
            { id: 'A.8.4', name: 'Access to source code', category: 'Technological', description: 'Read and write access to source code shall be managed.' },
            { id: 'A.8.5', name: 'Secure authentication', category: 'Technological', description: 'Secure authentication technologies shall be implemented.' },
            { id: 'A.8.6', name: 'Capacity management', category: 'Technological', description: 'Resources shall be monitored and adjusted.' },
            { id: 'A.8.7', name: 'Protection against malware', category: 'Technological', description: 'Protection against malware shall be implemented.' },
            { id: 'A.8.8', name: 'Management of technical vulnerabilities', category: 'Technological', description: 'Technical vulnerabilities shall be identified and addressed.' },
            { id: 'A.8.9', name: 'Configuration management', category: 'Technological', description: 'Configurations shall be defined and managed.' },
            { id: 'A.8.10', name: 'Information deletion', category: 'Technological', description: 'Information shall be deleted when no longer required.' },
            { id: 'A.8.11', name: 'Data masking', category: 'Technological', description: 'Data masking shall be used based on access control policy.' },
            { id: 'A.8.12', name: 'Data leakage prevention', category: 'Technological', description: 'Data leakage prevention measures shall be applied.' },
            { id: 'A.8.13', name: 'Information backup', category: 'Technological', description: 'Backup copies shall be maintained and tested.' },
            { id: 'A.8.14', name: 'Redundancy of information processing facilities', category: 'Technological', description: 'Facilities shall have sufficient redundancy.' },
            { id: 'A.8.15', name: 'Logging', category: 'Technological', description: 'Logs shall record activities and security events.' },
            { id: 'A.8.16', name: 'Monitoring activities', category: 'Technological', description: 'Networks, systems and applications shall be monitored.' },
            { id: 'A.8.17', name: 'Clock synchronization', category: 'Technological', description: 'Clocks shall be synchronized to approved time sources.' },
            { id: 'A.8.18', name: 'Use of privileged utility programs', category: 'Technological', description: 'Use of utility programs shall be restricted and controlled.' },
            { id: 'A.8.19', name: 'Installation of software on operational systems', category: 'Technological', description: 'Software installation shall be controlled.' },
            { id: 'A.8.20', name: 'Networks security', category: 'Technological', description: 'Networks shall be managed and controlled.' },
            { id: 'A.8.21', name: 'Security of network services', category: 'Technological', description: 'Security of network services shall be identified.' },
            { id: 'A.8.22', name: 'Segregation of networks', category: 'Technological', description: 'Groups shall be segregated in networks.' },
            { id: 'A.8.23', name: 'Web filtering', category: 'Technological', description: 'Access to external websites shall be managed.' },
            { id: 'A.8.24', name: 'Use of cryptography', category: 'Technological', description: 'Rules for cryptography shall be defined and implemented.' },
            { id: 'A.8.25', name: 'Secure development life cycle', category: 'Technological', description: 'Rules for secure development shall be established.' },
            { id: 'A.8.26', name: 'Application security requirements', category: 'Technological', description: 'Security requirements shall be identified and specified.' },
            { id: 'A.8.27', name: 'Secure system architecture and engineering principles', category: 'Technological', description: 'Secure engineering principles shall be established.' },
            { id: 'A.8.28', name: 'Secure coding', category: 'Technological', description: 'Secure coding principles shall be applied.' },
            { id: 'A.8.29', name: 'Security testing in development and acceptance', category: 'Technological', description: 'Security testing processes shall be defined.' },
            { id: 'A.8.30', name: 'Outsourced development', category: 'Technological', description: 'Outsourced development shall be directed and monitored.' },
            { id: 'A.8.31', name: 'Separation of development, test and production environments', category: 'Technological', description: 'Environments shall be separated and protected.' },
            { id: 'A.8.32', name: 'Change management', category: 'Technological', description: 'Changes shall be subject to change management.' },
            { id: 'A.8.33', name: 'Test information', category: 'Technological', description: 'Test information shall be appropriately protected.' },
            { id: 'A.8.34', name: 'Protection of information systems during audit testing', category: 'Technological', description: 'Audit tests shall be planned and agreed.' }
        ];
    }
    
    filterSoACategory(category) {
        this.soaSelectedCategory = category;
        this.renderSoA();
    }
    
    toggleSoAApplicability(controlId) {
        if (!this.data.soaEntries) this.data.soaEntries = [];
        
        const existing = this.data.soaEntries.find(e => e.controlId === controlId);
        if (existing) {
            existing.applicable = !existing.applicable;
        } else {
            this.data.soaEntries.push({ controlId, applicable: false, justification: '' });
        }
        
        localStorage.setItem('grc_soaEntries', JSON.stringify(this.data.soaEntries));
        this.renderSoA();
    }
    
    editSoAEntry(controlId) {
        const annexAControl = this.getAnnexAControls().find(ac => ac.id === controlId);
        if (!this.data.soaEntries) this.data.soaEntries = [];
        
        const existing = this.data.soaEntries.find(e => e.controlId === controlId);
        const justification = existing?.justification || '';
        const applicable = existing ? existing.applicable : true;
        
        this.setModalContext('soa', { controlId, isEdit: true });
        openModal('Edit SoA Entry', `
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--text-muted);">Control ID</div>
                <div style="font-weight: 600;">${controlId}</div>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--text-muted);">Control Name</div>
                <div>${annexAControl?.name || 'Unknown'}</div>
            </div>
            <div class="form-group">
                <label class="form-label">Applicable</label>
                <select class="form-select" id="f-applicable">
                    <option value="true" ${applicable ? 'selected' : ''}>Yes - Applicable</option>
                    <option value="false" ${!applicable ? 'selected' : ''}>No - Not Applicable</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Justification / Notes</label>
                <textarea class="form-textarea" id="f-justification" placeholder="Explain why this control is or is not applicable, implementation notes, etc.">${justification}</textarea>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="app.saveSoAEntry('${controlId}')">Save</button>
        `);
    }
    
    saveSoAEntry(controlId) {
        if (!this.data.soaEntries) this.data.soaEntries = [];
        
        const applicable = document.getElementById('f-applicable').value === 'true';
        const justification = document.getElementById('f-justification').value;
        
        const existing = this.data.soaEntries.find(e => e.controlId === controlId);
        if (existing) {
            existing.applicable = applicable;
            existing.justification = justification;
        } else {
            this.data.soaEntries.push({ controlId, applicable, justification });
        }
        
        localStorage.setItem('grc_soaEntries', JSON.stringify(this.data.soaEntries));
        closeModal();
        this.renderSoA();
        this.toast('SoA entry updated', 'success');
    }
    
    addControlFromSoA(annexAControlId) {
        const annexAControl = this.getAnnexAControls().find(ac => ac.id === annexAControlId);
        if (!annexAControl) return;
        
        // Pre-fill the control modal with Annex A data
        this.showControlModal({
            controlId: annexAControlId,
            name: annexAControl.name,
            framework: 'ISO 27001',
            ref: annexAControlId,
            description: annexAControl.description,
            effectiveness: 'Not Tested'
        });
    }
    
    exportSoA() {
        const annexAControls = this.getAnnexAControls();
        let csv = 'Control ID,Control Name,Category,Applicable,Status,Justification\n';
        
        annexAControls.forEach(ac => {
            const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
            const isApplicable = soaEntry ? soaEntry.applicable : true;
            const isImplemented = this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name);
            const justification = soaEntry?.justification || '';
            
            const status = !isApplicable ? 'Not Applicable' : (isImplemented ? 'Implemented' : 'Gap');
            
            csv += `"${ac.id}","${ac.name}","${ac.category}","${isApplicable ? 'Yes' : 'No'}","${status}","${justification.replace(/"/g, '""')}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `soa-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Statement of Applicability exported', 'success');
    }
    
    renderTraceability() {
        const c = document.getElementById('tab-traceability');
        const d = this.getActiveData();
        
        // Calculate traceability metrics
        const risksWithTreatments = d.risks.filter(r => d.treatments.some(t => t.riskId === r.id)).length;
        const risksWithoutTreatments = d.risks.length - risksWithTreatments;
        const controlsWithEvidence = d.controls.filter(c => d.evidence.some(e => e.controlId === c.id)).length;
        const controlsWithoutEvidence = d.controls.length - controlsWithEvidence;
        const controlsTested = d.controls.filter(c => d.controlTests.some(t => t.controlId === c.id)).length;
        const findingsWithOwner = d.findings.filter(f => f.owner).length;
        
        // Calculate coverage percentages
        const riskCoverage = d.risks.length > 0 ? Math.round((risksWithTreatments / d.risks.length) * 100) : 0;
        const evidenceCoverage = d.controls.length > 0 ? Math.round((controlsWithEvidence / d.controls.length) * 100) : 0;
        const testCoverage = d.controls.length > 0 ? Math.round((controlsTested / d.controls.length) * 100) : 0;
        
        const selectedView = this.traceabilityView || 'overview';
        
        c.innerHTML = `
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-diagram-3"></i> Traceability Matrix</h2>
                <p style="color: var(--text-muted); font-size: 13px;">Track relationships between risks, controls, evidence, and findings across your GRC program.</p>
            </div>
            
            <!-- View Selector Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 16px;">
                <button class="btn ${selectedView === 'overview' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('overview')">
                    <i class="bi bi-grid-3x3-gap"></i> Overview
                </button>
                <button class="btn ${selectedView === 'risk-control' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('risk-control')">
                    <i class="bi bi-arrow-right-circle"></i> Risk → Control
                </button>
                <button class="btn ${selectedView === 'control-evidence' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('control-evidence')">
                    <i class="bi bi-file-earmark-check"></i> Control → Evidence
                </button>
                <button class="btn ${selectedView === 'gaps' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('gaps')">
                    <i class="bi bi-exclamation-triangle"></i> Gap Analysis
                </button>
                <button class="btn ${selectedView === 'flow' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('flow')">
                    <i class="bi bi-bezier2"></i> Full Flow
                </button>
            </div>
            
            ${this.renderTraceabilityView(selectedView, d, { riskCoverage, evidenceCoverage, testCoverage, risksWithTreatments, risksWithoutTreatments, controlsWithEvidence, controlsWithoutEvidence, controlsTested })}
        `;
    }
    
    setTraceabilityView(view) {
        this.traceabilityView = view;
        this.renderTraceability();
    }
    
    renderTraceabilityView(view, d, stats) {
        switch(view) {
            case 'overview':
                return this.renderTraceabilityOverview(d, stats);
            case 'risk-control':
                return this.renderRiskControlMatrix(d);
            case 'control-evidence':
                return this.renderControlEvidenceMatrix(d);
            case 'gaps':
                return this.renderGapAnalysis(d, stats);
            case 'flow':
                return this.renderFullFlowView(d);
            default:
                return this.renderTraceabilityOverview(d, stats);
        }
    }
    
    renderTraceabilityOverview(d, stats) {
        const vendorAssessed = (d.vendorAssessments||[]).length;
        const vendorTotal = d.vendors.length;
        const vendorCoverage = vendorTotal > 0 ? Math.round((vendorAssessed / vendorTotal) * 100) : 0;
        const itgcTotal = (d.itgcControls||[]).length;
        const itgcPassed = (d.itgcControls||[]).filter(i => i.testStatus === 'Passed').length;
        const itgcCoverage = itgcTotal > 0 ? Math.round((itgcPassed / itgcTotal) * 100) : 0;
        return `
            <!-- Coverage Metrics -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 12px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent-blue)" stroke-width="10" stroke-dasharray="${stats.riskCoverage * 2.51} 251" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700;">${stats.riskCoverage}%</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Risk Treatment Coverage</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${stats.risksWithTreatments} of ${d.risks.length} risks treated</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 12px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent-green)" stroke-width="10" stroke-dasharray="${stats.evidenceCoverage * 2.51} 251" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700;">${stats.evidenceCoverage}%</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Evidence Coverage</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${stats.controlsWithEvidence} of ${d.controls.length} controls documented</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 12px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent-purple)" stroke-width="10" stroke-dasharray="${stats.testCoverage * 2.51} 251" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700;">${stats.testCoverage}%</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Testing Coverage</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${stats.controlsTested} of ${d.controls.length} controls tested</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 12px; background: var(--bg-elevated); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-amber);">${d.findings.filter(f => f.status === 'Open').length}</div>
                            </div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Open Findings</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${d.findings.length} total findings</div>
                    </div>
                </div>
            </div>

            <!-- Extended Coverage Bars -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-size: 13px; font-weight: 600;"><i class="bi bi-clipboard2-pulse" style="color: var(--accent-green);"></i> Vendor Risk Assessment</span><span style="font-size: 13px; font-weight: 700;">${vendorCoverage}%</span></div>
                    <div style="height: 8px; background: var(--bg-elevated); border-radius: 4px;"><div style="height: 100%; width: ${vendorCoverage}%; background: var(--accent-green); border-radius: 4px; transition: width 0.5s;"></div></div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${vendorAssessed} of ${vendorTotal} vendors assessed</div>
                </div></div>
                <div class="card"><div class="card-body" style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-size: 13px; font-weight: 600;"><i class="bi bi-bank2" style="color: var(--accent-blue);"></i> ITGC Test Pass Rate</span><span style="font-size: 13px; font-weight: 700;">${itgcCoverage}%</span></div>
                    <div style="height: 8px; background: var(--bg-elevated); border-radius: 4px;"><div style="height: 100%; width: ${itgcCoverage}%; background: var(--accent-blue); border-radius: 4px; transition: width 0.5s;"></div></div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${itgcPassed} of ${itgcTotal} ITGC controls passed</div>
                </div></div>
            </div>
            
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <!-- Relationships Summary -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-link-45deg"></i> Relationship Summary</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table style="margin: 0;">
                            <tbody>
                                <tr onclick="app.setTraceabilityView('risk-control')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-blue);"></i> Risks → Treatments</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-blue">${d.treatments.length} links</span></td>
                                </tr>
                                <tr onclick="app.setTraceabilityView('control-evidence')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-green);"></i> Controls → Evidence</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-green">${d.evidence.filter(e => e.controlId).length} links</span></td>
                                </tr>
                                <tr onclick="app.setTraceabilityView('control-evidence')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-purple);"></i> Controls → Tests</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-purple">${d.controlTests.length} links</span></td>
                                </tr>
                                <tr onclick="app.setTraceabilityView('gaps')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-amber);"></i> Audits → Findings</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-amber">${d.findings.length} items</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-lightning"></i> Quick Actions</span>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-secondary" onclick="app.setTraceabilityView('gaps')" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-search"></i> Run Gap Analysis
                            </button>
                            <button class="btn btn-secondary" onclick="app.exportTraceabilityMatrix()" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-download"></i> Export Traceability Matrix
                            </button>
                            <button class="btn btn-secondary" onclick="app.setTraceabilityView('flow')" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-diagram-3"></i> View Full Flow Diagram
                            </button>
                            <button class="btn btn-secondary" onclick="app.switchTab('reports')" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-file-text"></i> Generate Compliance Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    renderRiskControlMatrix(d) {
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-table"></i> Risk → Treatment → Control Mapping</span>
                    <button class="btn btn-secondary btn-sm" onclick="app.exportTraceabilityMatrix()"><i class="bi bi-download"></i> Export</button>
                </div>
                <div class="card-body" style="padding: 0; max-height: 600px; overflow-y: auto;">
                    ${d.risks.length > 0 ? `
                        <table style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: var(--bg-surface); z-index: 10;">
                                <tr>
                                    <th style="padding: 14px 16px; width: 120px;">Risk ID</th>
                                    <th style="padding: 14px 16px;">Risk Title</th>
                                    <th style="padding: 14px 16px; width: 100px; text-align: center;">Score</th>
                                    <th style="padding: 14px 16px;">Treatments</th>
                                    <th style="padding: 14px 16px;">Linked Controls</th>
                                    <th style="padding: 14px 16px; width: 100px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${d.risks.map(risk => {
                                    const treatments = d.treatments.filter(t => t.riskId === risk.id);
                                    const linkedControls = treatments.map(t => d.controls.find(c => c.id === t.controlId)).filter(Boolean);
                                    const score = risk.likelihood * risk.impact;
                                    const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                    const hasTreatment = treatments.length > 0;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                                            <td style="padding: 14px 16px;"><span class="font-mono text-muted">${risk.id}</span></td>
                                            <td style="padding: 14px 16px;">
                                                <div class="font-semibold">${risk.title}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${risk.category}</div>
                                            </td>
                                            <td style="padding: 14px 16px; text-align: center;">
                                                <span class="badge badge-${scoreClass}">${score}</span>
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${treatments.length > 0 ? treatments.map(t => `
                                                    <div style="font-size: 12px; padding: 4px 8px; background: var(--accent-blue-soft); border-radius: 4px; margin-bottom: 4px;">
                                                        <span class="badge badge-${t.type === 'Mitigate' ? 'green' : t.type === 'Transfer' ? 'purple' : t.type === 'Avoid' ? 'amber' : 'gray'}" style="font-size: 9px; margin-right: 4px;">${t.type}</span>
                                                        ${t.description?.substring(0, 30) || 'No description'}...
                                                    </div>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;"><i class="bi bi-exclamation-circle" style="color: var(--accent-red);"></i> No treatment</span>`}
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${linkedControls.length > 0 ? linkedControls.map(c => `
                                                    <span class="badge badge-green" style="margin-right: 4px; margin-bottom: 4px; font-size: 10px;">${c.name.substring(0, 20)}...</span>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;">-</span>`}
                                            </td>
                                            <td style="padding: 14px 16px; text-align: center;">
                                                <span class="badge badge-${hasTreatment ? 'green' : 'red'}">${hasTreatment ? 'Mapped' : 'Gap'}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <i class="bi bi-diagram-3" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <p style="font-size: 14px; margin-bottom: 16px;">No risks to display</p>
                            <button class="btn btn-primary" onclick="app.switchTab('risks')"><i class="bi bi-plus"></i> Add Risks</button>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    renderControlEvidenceMatrix(d) {
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-table"></i> Control → Evidence → Test Mapping</span>
                    <button class="btn btn-secondary btn-sm" onclick="app.exportTraceabilityMatrix()"><i class="bi bi-download"></i> Export</button>
                </div>
                <div class="card-body" style="padding: 0; max-height: 600px; overflow-y: auto;">
                    ${d.controls.length > 0 ? `
                        <table style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: var(--bg-surface); z-index: 10;">
                                <tr>
                                    <th style="padding: 14px 16px; width: 120px;">Control ID</th>
                                    <th style="padding: 14px 16px;">Control Name</th>
                                    <th style="padding: 14px 16px; width: 120px;">Framework</th>
                                    <th style="padding: 14px 16px;">Evidence</th>
                                    <th style="padding: 14px 16px;">Tests</th>
                                    <th style="padding: 14px 16px; width: 120px; text-align: center;">Effectiveness</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${d.controls.map(ctrl => {
                                    const evidence = d.evidence.filter(e => e.controlId === ctrl.id);
                                    const tests = d.controlTests.filter(t => t.controlId === ctrl.id);
                                    const hasEvidence = evidence.length > 0;
                                    const hasTested = tests.length > 0;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                                            <td style="padding: 14px 16px;"><span class="font-mono text-muted">${ctrl.id}</span></td>
                                            <td style="padding: 14px 16px;">
                                                <div class="font-semibold">${ctrl.name}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${ctrl.ref || 'No reference'}</div>
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                <span class="badge badge-${this.getFrameworkColor(ctrl.framework)}">${ctrl.framework}</span>
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${evidence.length > 0 ? evidence.map(e => `
                                                    <div style="font-size: 12px; padding: 4px 8px; background: var(--accent-green-soft); border-radius: 4px; margin-bottom: 4px;">
                                                        <i class="bi bi-file-earmark" style="margin-right: 4px;"></i> ${e.name.substring(0, 25)}...
                                                    </div>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;"><i class="bi bi-exclamation-circle" style="color: var(--accent-amber);"></i> No evidence</span>`}
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${tests.length > 0 ? tests.map(t => `
                                                    <div style="font-size: 12px; padding: 4px 8px; background: var(--accent-purple-soft); border-radius: 4px; margin-bottom: 4px;">
                                                        <span class="badge badge-${t.result === 'Pass' ? 'green' : t.result === 'Fail' ? 'red' : 'amber'}" style="font-size: 9px; margin-right: 4px;">${t.result}</span>
                                                        ${t.testType || 'Test'}
                                                    </div>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;"><i class="bi bi-exclamation-circle" style="color: var(--accent-amber);"></i> Not tested</span>`}
                                            </td>
                                            <td style="padding: 14px 16px; text-align: center;">
                                                <span class="badge badge-${ctrl.effectiveness === 'Effective' ? 'green' : ctrl.effectiveness === 'Partially Effective' ? 'amber' : ctrl.effectiveness === 'Ineffective' ? 'red' : 'gray'}">${ctrl.effectiveness}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <i class="bi bi-shield-check" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <p style="font-size: 14px; margin-bottom: 16px;">No controls to display</p>
                            <button class="btn btn-primary" onclick="app.switchTab('controls')"><i class="bi bi-plus"></i> Add Controls</button>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    renderGapAnalysis(d, stats) {
        const untreatedRisks = d.risks.filter(r => !d.treatments.some(t => t.riskId === r.id));
        const controlsWithoutEvidence = d.controls.filter(c => !d.evidence.some(e => e.controlId === c.id));
        const untestedControls = d.controls.filter(c => !d.controlTests.some(t => t.controlId === c.id));
        const findingsOpen = d.findings.filter(f => f.status === 'Open');
        const itgcUntested = (d.itgcControls||[]).filter(i => !i.testStatus || i.testStatus === 'Pending');
        const unscoredEvidence = d.evidence.filter(e => !(d.evidenceScores||[]).some(s => s.evidenceId === e.id));
        const vendorsUnassessed = d.vendors.filter(v => !(d.vendorAssessments||[]).some(a => a.vendorId === v.id));
        
        return `
            <!-- Gap Summary -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card" style="border-left: 4px solid var(--accent-red);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-red);">${untreatedRisks.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Untreated Risks</div>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-amber);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-amber);">${controlsWithoutEvidence.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Controls Without Evidence</div>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-purple);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-purple);">${untestedControls.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Untested Controls</div>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-cyan);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-cyan);">${findingsOpen.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Open Findings</div>
                    </div>
                </div>
            </div>

            <!-- Extended Gap Indicators -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card" style="border-left: 4px solid var(--accent-blue);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${itgcUntested.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">ITGC Pending Test</div>
                        <button class="btn btn-ghost btn-sm" style="margin-top: 6px; font-size: 11px;" onclick="app.switchTab('itgc')">Review &rarr;</button>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-amber);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${unscoredEvidence.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Evidence Unscored</div>
                        <button class="btn btn-ghost btn-sm" style="margin-top: 6px; font-size: 11px;" onclick="app.switchTab('evidence-scoring')">Score &rarr;</button>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-purple);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-purple);">${vendorsUnassessed.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Vendors Unassessed</div>
                        <button class="btn btn-ghost btn-sm" style="margin-top: 6px; font-size: 11px;" onclick="app.switchTab('vendor-risk')">Assess &rarr;</button>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Untreated Risks -->
                <div class="card">
                    <div class="card-header" style="padding: 16px; background: var(--accent-red-soft);">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-exclamation-triangle"></i> Untreated Risks</span>
                        <span class="badge badge-red">${untreatedRisks.length}</span>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 300px; overflow-y: auto;">
                        ${untreatedRisks.length > 0 ? untreatedRisks.map(r => {
                            const score = r.likelihood * r.impact;
                            const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : 'blue';
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);">
                                    <span class="badge badge-${scoreClass}">${score}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.title}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">${r.category}</div>
                                    </div>
                                    <button class="btn btn-ghost btn-sm" onclick="app.switchTab('treatments')" title="Add Treatment"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            `;
                        }).join('') : `<div style="padding: 30px; text-align: center; color: var(--text-muted);"><i class="bi bi-check-circle" style="color: var(--accent-green); font-size: 24px; display: block; margin-bottom: 8px;"></i>All risks have treatments!</div>`}
                    </div>
                </div>
                
                <!-- Controls Without Evidence -->
                <div class="card">
                    <div class="card-header" style="padding: 16px; background: var(--accent-amber-soft);">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-file-earmark-x"></i> Controls Missing Evidence</span>
                        <span class="badge badge-amber">${controlsWithoutEvidence.length}</span>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 300px; overflow-y: auto;">
                        ${controlsWithoutEvidence.length > 0 ? controlsWithoutEvidence.map(c => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);">
                                <span class="badge badge-${this.getFrameworkColor(c.framework)}" style="font-size: 10px;">${c.framework}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${c.ref || 'No reference'}</div>
                                </div>
                                <button class="btn btn-ghost btn-sm" onclick="app.switchTab('evidence')" title="Add Evidence"><i class="bi bi-plus-lg"></i></button>
                            </div>
                        `).join('') : `<div style="padding: 30px; text-align: center; color: var(--text-muted);"><i class="bi bi-check-circle" style="color: var(--accent-green); font-size: 24px; display: block; margin-bottom: 8px;"></i>All controls have evidence!</div>`}
                    </div>
                </div>
            </div>
        `;
    }
    
    renderFullFlowView(d) {
        const itgc = d.itgcControls || [];
        const lifecycle = d.controlLifecycle || [];
        const evScores = d.evidenceScores || [];
        const cloudRisks = d.cloudRiskScenarios || [];
        const bia = d.biaEntries || [];
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-bezier2"></i> End-to-End GRC Flow</span>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <!-- Primary Flow Diagram -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding: 24px; background: var(--bg-elevated); border-radius: var(--radius-lg);">
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-blue-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-hdd-stack" style="font-size: 24px; color: var(--accent-blue);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Assets</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-blue);">${d.assets.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-red-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-exclamation-triangle" style="font-size: 24px; color: var(--accent-red);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Risks</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${d.risks.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-amber-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-bandaid" style="font-size: 24px; color: var(--accent-amber);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Treatments</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${d.treatments.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-green-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-shield-check" style="font-size: 24px; color: var(--accent-green);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Controls</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${d.controls.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-purple-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-clipboard-check" style="font-size: 24px; color: var(--accent-purple);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Tests</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-purple);">${d.controlTests.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-cyan-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-file-earmark-check" style="font-size: 24px; color: var(--accent-cyan);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Evidence</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-cyan);">${d.evidence.length}</div>
                        </div>
                    </div>

                    <!-- Extended Coverage Row -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 14px; text-align: center; cursor: pointer;" onclick="app.switchTab('itgc')">
                            <i class="bi bi-bank2" style="font-size: 20px; color: var(--accent-blue);"></i>
                            <div style="font-size: 18px; font-weight: 700; margin-top: 4px;">${itgc.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">ITGC Controls</div>
                            <div style="font-size: 10px; color: var(--accent-green); margin-top: 2px;">${itgc.filter(i => i.testStatus === 'Passed').length} passed</div>
                        </div>
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 14px; text-align: center; cursor: pointer;" onclick="app.switchTab('control-lifecycle')">
                            <i class="bi bi-arrow-repeat" style="font-size: 20px; color: var(--accent-purple);"></i>
                            <div style="font-size: 18px; font-weight: 700; margin-top: 4px;">${lifecycle.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">Lifecycle Tracked</div>
                            <div style="font-size: 10px; color: var(--accent-green); margin-top: 2px;">${lifecycle.filter(l => l.phase === 'Operating').length} operating</div>
                        </div>
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 14px; text-align: center; cursor: pointer;" onclick="app.switchTab('evidence-scoring')">
                            <i class="bi bi-star-half" style="font-size: 20px; color: var(--accent-amber);"></i>
                            <div style="font-size: 18px; font-weight: 700; margin-top: 4px;">${evScores.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">Evidence Scored</div>
                            <div style="font-size: 10px; color: var(--accent-green); margin-top: 2px;">${evScores.filter(e => (e.totalScore||0) >= 80).length} strong</div>
                        </div>
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 14px; text-align: center; cursor: pointer;" onclick="app.switchTab('cloud-risks')">
                            <i class="bi bi-cloud-haze2" style="font-size: 20px; color: var(--accent-cyan);"></i>
                            <div style="font-size: 18px; font-weight: 700; margin-top: 4px;">${cloudRisks.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">Cloud Scenarios</div>
                            <div style="font-size: 10px; color: var(--accent-red); margin-top: 2px;">${cloudRisks.filter(c => c.riskLevel === 'Critical').length} critical</div>
                        </div>
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 14px; text-align: center; cursor: pointer;" onclick="app.switchTab('bia')">
                            <i class="bi bi-heart-pulse" style="font-size: 20px; color: var(--accent-pink);"></i>
                            <div style="font-size: 18px; font-weight: 700; margin-top: 4px;">${bia.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">BIA Entries</div>
                            <div style="font-size: 10px; color: var(--accent-red); margin-top: 2px;">${bia.filter(b => b.criticality === 'Critical').length} critical</div>
                        </div>
                    </div>
                    
                    <!-- Detailed Flow Table -->
                    <h4 style="font-size: 14px; margin-bottom: 16px;"><i class="bi bi-list-columns-reverse"></i> Detailed Traceability Chain <span style="font-size: 11px; color: var(--text-muted);">(Click any item to view/edit)</span></h4>
                    ${d.risks.length > 0 ? `
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${d.risks.slice(0, 10).map(risk => {
                                const treatments = d.treatments.filter(t => t.riskId === risk.id);
                                const linkedControls = treatments.map(t => d.controls.find(c => c.id === t.controlId)).filter(Boolean);
                                const allEvidence = linkedControls.flatMap(c => d.evidence.filter(e => e.controlId === c.id));
                                const score = risk.likelihood * risk.impact;
                                const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                
                                return `
                                    <div style="display: flex; align-items: stretch; gap: 2px; margin-bottom: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); overflow: hidden;">
                                        <div style="flex: 1; padding: 12px; border-left: 3px solid var(--accent-${scoreClass}); min-width: 0; cursor: pointer; transition: all 0.15s;" 
                                             onclick="app.showTraceabilityDetail('risk', '${risk.id}')"
                                             onmouseover="this.style.background='var(--accent-${scoreClass}-soft)'" 
                                             onmouseout="this.style.background='transparent'">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">RISK <i class="bi bi-box-arrow-up-right" style="font-size: 9px;"></i></div>
                                            <div style="font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${risk.title}</div>
                                            <span class="badge badge-${scoreClass}" style="font-size: 9px; margin-top: 4px;">${score}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; padding: 0 8px;"><i class="bi bi-chevron-right" style="color: var(--text-muted);"></i></div>
                                        <div style="flex: 1; padding: 12px; background: var(--bg-surface); min-width: 0; cursor: pointer; transition: all 0.15s;" 
                                             onclick="app.showTraceabilityDetail('treatment', '${risk.id}')"
                                             onmouseover="this.style.background='var(--accent-amber-soft)'" 
                                             onmouseout="this.style.background='var(--bg-surface)'">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">TREATMENTS <i class="bi bi-box-arrow-up-right" style="font-size: 9px;"></i></div>
                                            ${treatments.length > 0 ? `<div style="font-size: 12px;">${treatments.length} treatment(s)</div>` : `<div style="font-size: 11px; color: var(--accent-red);">No treatment</div>`}
                                        </div>
                                        <div style="display: flex; align-items: center; padding: 0 8px;"><i class="bi bi-chevron-right" style="color: var(--text-muted);"></i></div>
                                        <div style="flex: 1; padding: 12px; background: var(--bg-surface); min-width: 0; cursor: pointer; transition: all 0.15s;" 
                                             onclick="app.showTraceabilityDetail('control', '${risk.id}')"
                                             onmouseover="this.style.background='var(--accent-green-soft)'" 
                                             onmouseout="this.style.background='var(--bg-surface)'">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">CONTROLS <i class="bi bi-box-arrow-up-right" style="font-size: 9px;"></i></div>
                                            ${linkedControls.length > 0 ? `<div style="font-size: 12px;">${linkedControls.length} control(s)</div>` : `<div style="font-size: 11px; color: var(--text-muted);">-</div>`}
                                        </div>
                                        <div style="display: flex; align-items: center; padding: 0 8px;"><i class="bi bi-chevron-right" style="color: var(--text-muted);"></i></div>
                                        <div style="flex: 1; padding: 12px; background: var(--bg-surface); min-width: 0; cursor: pointer; transition: all 0.15s;" 
                                             onclick="app.showTraceabilityDetail('evidence', '${risk.id}')"
                                             onmouseover="this.style.background='var(--accent-cyan-soft)'" 
                                             onmouseout="this.style.background='var(--bg-surface)'">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">EVIDENCE <i class="bi bi-box-arrow-up-right" style="font-size: 9px;"></i></div>
                                            ${allEvidence.length > 0 ? `<div style="font-size: 12px; color: var(--accent-green);">${allEvidence.length} item(s)</div>` : `<div style="font-size: 11px; color: var(--text-muted);">-</div>`}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="bi bi-diagram-3" style="font-size: 40px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                            <p>Add risks and controls to see the traceability flow</p>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    showTraceabilityDetail(type, riskId) {
        const d = this.getActiveData();
        const risk = d.risks.find(r => r.id === riskId);
        if (!risk) return;
        
        const treatments = d.treatments.filter(t => t.riskId === riskId);
        const linkedControls = treatments.map(t => d.controls.find(c => c.id === t.controlId)).filter(Boolean);
        const allEvidence = linkedControls.flatMap(c => d.evidence.filter(e => e.controlId === c.id));
        const score = risk.likelihood * risk.impact;
        const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
        
        let content = '';
        let title = '';
        let actionButtons = '';
        
        if (type === 'risk') {
            title = 'Risk Details';
            content = `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header" style="background: var(--accent-${scoreClass}-soft);">
                        <span style="font-weight: 600;">${risk.title}</span>
                        <span class="badge badge-${scoreClass}">Score: ${score}</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                            <div><strong>Category:</strong> ${risk.category}</div>
                            <div><strong>Status:</strong> <span class="badge badge-${risk.status === 'Closed' ? 'green' : 'amber'}">${risk.status}</span></div>
                            <div><strong>Likelihood:</strong> ${risk.likelihood}/5</div>
                            <div><strong>Impact:</strong> ${risk.impact}/5</div>
                            <div><strong>Owner:</strong> ${risk.owner || 'Unassigned'}</div>
                        </div>
                        <div><strong>Description:</strong><br>${risk.description || 'No description provided.'}</div>
                    </div>
                </div>
            `;
            actionButtons = `<button class="btn btn-primary" onclick="closeModal(); app.editRisk('${risk.id}');"><i class="bi bi-pencil"></i> Edit Risk</button>`;
        } else if (type === 'treatment') {
            title = 'Treatments for: ' + risk.title;
            content = treatments.length > 0 ? `
                ${treatments.map(t => `
                    <div class="card" style="margin-bottom: 12px;">
                        <div class="card-body" style="padding: 14px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="badge badge-${t.type === 'Mitigate' ? 'green' : t.type === 'Transfer' ? 'purple' : t.type === 'Avoid' ? 'amber' : 'gray'}">${t.type}</span>
                                <span class="badge badge-${t.status === 'Completed' ? 'green' : t.status === 'In Progress' ? 'amber' : 'gray'}">${t.status}</span>
                            </div>
                            <p style="font-size: 13px; margin: 0;">${t.plan || 'No plan documented'}</p>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Owner: ${t.owner || 'Unassigned'}</div>
                        </div>
                    </div>
                `).join('')}
            ` : `<div style="text-align: center; padding: 30px; color: var(--text-muted);"><i class="bi bi-bandaid" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.3;"></i>No treatments defined for this risk</div>`;
            actionButtons = `<button class="btn btn-primary" onclick="closeModal(); app.switchTab('treatments');"><i class="bi bi-plus"></i> Add Treatment</button>`;
        } else if (type === 'control') {
            title = 'Controls for: ' + risk.title;
            content = linkedControls.length > 0 ? `
                ${linkedControls.map(c => `
                    <div class="card" style="margin-bottom: 12px; cursor: pointer;" onclick="closeModal(); app.editControl('${c.id}');">
                        <div class="card-body" style="padding: 14px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 600;">${c.name}</span>
                                <span class="badge badge-${c.effectiveness === 'Effective' ? 'green' : c.effectiveness === 'Partially Effective' ? 'amber' : 'red'}">${c.effectiveness}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">${c.framework} • ${c.ref || 'No ref'}</div>
                        </div>
                    </div>
                `).join('')}
            ` : `<div style="text-align: center; padding: 30px; color: var(--text-muted);"><i class="bi bi-shield" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.3;"></i>No controls linked to treatments for this risk</div>`;
            actionButtons = `<button class="btn btn-primary" onclick="closeModal(); app.switchTab('controls');"><i class="bi bi-plus"></i> Add Control</button>`;
        } else if (type === 'evidence') {
            title = 'Evidence for: ' + risk.title;
            content = allEvidence.length > 0 ? `
                ${allEvidence.map(e => `
                    <div class="card" style="margin-bottom: 12px;">
                        <div class="card-body" style="padding: 14px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 600;">${e.title}</span>
                                <span class="badge badge-blue">${e.type || 'Document'}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">${e.notes || 'No notes'}</div>
                            ${e.url ? `<a href="${e.url}" target="_blank" style="font-size: 11px; color: var(--accent-blue);"><i class="bi bi-link-45deg"></i> View attachment</a>` : ''}
                        </div>
                    </div>
                `).join('')}
            ` : `<div style="text-align: center; padding: 30px; color: var(--text-muted);"><i class="bi bi-file-earmark" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.3;"></i>No evidence linked to controls for this risk</div>`;
            actionButtons = `<button class="btn btn-primary" onclick="closeModal(); app.switchTab('evidence');"><i class="bi bi-plus"></i> Add Evidence</button>`;
        }
        
        openModal(title, content, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            ${actionButtons}
        `);
    }
    
    exportTraceabilityMatrix() {
        const d = this.getActiveData();
        let csv = 'Risk ID,Risk Title,Risk Score,Treatment Type,Control ID,Control Name,Evidence Count,Test Result\\n';
        
        d.risks.forEach(risk => {
            const treatments = d.treatments.filter(t => t.riskId === risk.id);
            const score = risk.likelihood * risk.impact;
            
            if (treatments.length > 0) {
                treatments.forEach(t => {
                    const ctrl = d.controls.find(c => c.id === t.controlId);
                    const evidenceCount = ctrl ? d.evidence.filter(e => e.controlId === ctrl.id).length : 0;
                    const tests = ctrl ? d.controlTests.filter(ct => ct.controlId === ctrl.id) : [];
                    const testResult = tests.length > 0 ? tests[tests.length - 1].result : 'Not Tested';
                    
                    csv += `"${risk.id}","${risk.title}",${score},"${t.type}","${ctrl?.id || ''}","${ctrl?.name || ''}",${evidenceCount},"${testResult}"\\n`;
                });
            } else {
                csv += `"${risk.id}","${risk.title}",${score},"No Treatment","","",0,"N/A"\\n`;
            }
        });
        
        const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `traceability-matrix-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Traceability matrix exported!', 'success');
    }
    renderReports() {
        const c = document.getElementById('tab-reports');
        const d = this.getActiveData();
        
        // Calculate statistics
        const totalRisks = d.risks.length;
        const criticalRisks = d.risks.filter(r => r.likelihood * r.impact >= 20).length;
        const highRisks = d.risks.filter(r => r.likelihood * r.impact >= 12 && r.likelihood * r.impact < 20).length;
        const openRisks = d.risks.filter(r => r.status !== 'Closed').length;
        const totalControls = d.controls.length;
        const effectiveControls = d.controls.filter(ct => ct.effectiveness === 'Effective').length;
        const partialControls = d.controls.filter(ct => ct.effectiveness === 'Partially Effective').length;
        const openFindings = d.findings.filter(f => f.status === 'Open').length;
        const closedFindings = d.findings.filter(f => f.status === 'Closed').length;
        const openIssues = d.issues.filter(i => i.status === 'Open').length;
        const criticalVendors = d.vendors.filter(v => v.criticality === 'Critical').length;
        
        const selectedReport = this.selectedReport || null;
        
        c.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-file-earmark-bar-graph"></i> Reports & Analytics</h2>
                    <p style="color: var(--text-muted); font-size: 13px;">Generate detailed reports for compliance, audits, and management review.</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="app.exportAllReports()" style="white-space: nowrap;"><i class="bi bi-download"></i> Export All</button>
                    <button class="btn btn-primary" onclick="app.printReport()" style="white-space: nowrap;"><i class="bi bi-printer"></i> Print to PDF</button>
                </div>
            </div>
            
            <!-- Report Cards Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
                
                <!-- Risk Report Card -->
                <div class="card" onclick="app.showReport('risk')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-red-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-exclamation-triangle" style="font-size: 24px; color: var(--accent-red);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Risk Assessment Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Complete risk register analysis</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${totalRisks}</div><div style="font-size: 11px; color: var(--text-muted);">Total</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${criticalRisks}</div><div style="font-size: 11px; color: var(--text-muted);">Critical</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${highRisks}</div><div style="font-size: 11px; color: var(--text-muted);">High</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Control Report Card -->
                <div class="card" onclick="app.showReport('control')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-green-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-shield-check" style="font-size: 24px; color: var(--accent-green);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Control Effectiveness Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Control status and testing results</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${totalControls}</div><div style="font-size: 11px; color: var(--text-muted);">Total</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${effectiveControls}</div><div style="font-size: 11px; color: var(--text-muted);">Effective</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${partialControls}</div><div style="font-size: 11px; color: var(--text-muted);">Partial</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Compliance Report Card -->
                <div class="card" onclick="app.showReport('compliance')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-blue-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-clipboard-check" style="font-size: 24px; color: var(--accent-blue);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Compliance Status Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Framework compliance overview</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${d.audits.length}</div><div style="font-size: 11px; color: var(--text-muted);">Audits</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${closedFindings}</div><div style="font-size: 11px; color: var(--text-muted);">Closed</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${openFindings}</div><div style="font-size: 11px; color: var(--text-muted);">Open</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Vendor Report Card -->
                <div class="card" onclick="app.showReport('vendor')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-purple-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-building" style="font-size: 24px; color: var(--accent-purple);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Third-Party Risk Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Vendor risk assessment summary</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${d.vendors.length}</div><div style="font-size: 11px; color: var(--text-muted);">Vendors</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${criticalVendors}</div><div style="font-size: 11px; color: var(--text-muted);">Critical</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${d.vendors.filter(v => v.status === 'Active').length}</div><div style="font-size: 11px; color: var(--text-muted);">Active</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Incident Report Card -->
                <div class="card" onclick="app.showReport('incident')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-amber-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-lightning" style="font-size: 24px; color: var(--accent-amber);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Incident Summary Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Security incident analysis</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${d.incidents.length}</div><div style="font-size: 11px; color: var(--text-muted);">Total</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${d.incidents.filter(i => i.status === 'Resolved').length}</div><div style="font-size: 11px; color: var(--text-muted);">Resolved</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${d.incidents.filter(i => i.status === 'Investigating').length}</div><div style="font-size: 11px; color: var(--text-muted);">Active</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Executive Summary Card -->
                <div class="card" onclick="app.showReport('executive')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-cyan-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-graph-up" style="font-size: 24px; color: var(--accent-cyan);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Executive Summary</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">High-level GRC overview</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${this.data.assets.length}</div><div style="font-size: 11px; color: var(--text-muted);">Assets</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-blue);">${d.policies.length}</div><div style="font-size: 11px; color: var(--text-muted);">Policies</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-purple);">${openIssues}</div><div style="font-size: 11px; color: var(--text-muted);">Issues</div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Detail View -->
            <div id="report-detail-container">
                ${selectedReport ? this.renderReportDetail(selectedReport) : `
                    <div class="card">
                        <div class="card-body" style="padding: 60px; text-align: center;">
                            <i class="bi bi-file-earmark-text" style="font-size: 48px; color: var(--text-muted); opacity: 0.4; margin-bottom: 16px; display: block;"></i>
                            <h4 style="font-size: 16px; margin-bottom: 8px;">Select a Report</h4>
                            <p style="color: var(--text-muted); font-size: 13px;">Click on any report card above to view detailed information.</p>
                        </div>
                    </div>
                `}
            </div>
        `;
    }
    
    showReport(reportType) {
        this.selectedReport = reportType;
        const container = document.getElementById('report-detail-container');
        if (container) {
            container.innerHTML = this.renderReportDetail(reportType);
        }
    }
    
    renderReportDetail(reportType) {
        const d = this.getActiveData();
        const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const reports = {
            'risk': () => {
                const criticalRisks = d.risks.filter(r => r.likelihood * r.impact >= 20);
                const highRisks = d.risks.filter(r => r.likelihood * r.impact >= 12 && r.likelihood * r.impact < 20);
                const mediumRisks = d.risks.filter(r => r.likelihood * r.impact >= 6 && r.likelihood * r.impact < 12);
                const lowRisks = d.risks.filter(r => r.likelihood * r.impact < 6);
                const risksByCategory = {};
                d.risks.forEach(r => { risksByCategory[r.category] = (risksByCategory[r.category] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-red-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-exclamation-triangle"></i> Risk Assessment Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('risk')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Risk Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${criticalRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Critical (20-25)</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${highRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">High (12-19)</div>
                                </div>
                                <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${mediumRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Medium (6-11)</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${lowRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Low (1-5)</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Risks by Category</h4>
                            <div style="margin-bottom: 24px;">
                                ${Object.entries(risksByCategory).map(([cat, count]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                                        <span style="font-size: 13px;">${cat}</span>
                                        <span class="badge badge-blue">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${criticalRisks.length > 0 ? `
                                <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle); color: var(--accent-red);">⚠️ Critical Risks Requiring Immediate Attention</h4>
                                <table style="margin-bottom: 24px;">
                                    <thead><tr><th>ID</th><th>Risk</th><th>Category</th><th>Score</th><th>Owner</th><th>Status</th></tr></thead>
                                    <tbody>
                                        ${criticalRisks.map(r => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${r.id}</span></td>
                                                <td class="font-semibold">${r.title}</td>
                                                <td>${r.category}</td>
                                                <td><span class="badge badge-red">${r.likelihood * r.impact}</span></td>
                                                <td>${r.owner || '-'}</td>
                                                <td><span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'red'}">${r.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : ''}
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Complete Risk Register</h4>
                            ${d.risks.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Risk</th><th>Category</th><th>L</th><th>I</th><th>Score</th><th>Status</th></tr></thead>
                                    <tbody>
                                        ${d.risks.map(r => {
                                            const score = r.likelihood * r.impact;
                                            const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                            return `
                                                <tr>
                                                    <td><span class="font-mono text-muted">${r.id}</span></td>
                                                    <td class="font-semibold">${r.title}</td>
                                                    <td><span class="badge badge-blue" style="font-size: 10px;">${r.category}</span></td>
                                                    <td>${r.likelihood}</td>
                                                    <td>${r.impact}</td>
                                                    <td><span class="badge badge-${scoreClass}">${score}</span></td>
                                                    <td><span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'gray'}">${r.status}</span></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No risks recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'control': () => {
                const byFramework = {};
                d.controls.forEach(c => { byFramework[c.framework] = (byFramework[c.framework] || 0) + 1; });
                const byEffectiveness = { 'Effective': 0, 'Partially Effective': 0, 'Ineffective': 0, 'Not Tested': 0 };
                d.controls.forEach(c => { byEffectiveness[c.effectiveness] = (byEffectiveness[c.effectiveness] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-green-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-shield-check"></i> Control Effectiveness Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('control')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Control Effectiveness Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${byEffectiveness['Effective']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Effective</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${byEffectiveness['Partially Effective']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Partial</div>
                                </div>
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${byEffectiveness['Ineffective']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Ineffective</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--text-muted);">${byEffectiveness['Not Tested']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Not Tested</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Controls by Framework</h4>
                            <div style="margin-bottom: 24px;">
                                ${Object.entries(byFramework).map(([fw, count]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                                        <span style="font-size: 13px;">${fw}</span>
                                        <span class="badge badge-${this.getFrameworkColor(fw)}">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Control Catalog</h4>
                            ${d.controls.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Control</th><th>Framework</th><th>Ref</th><th>Effectiveness</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        ${d.controls.map(c => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${c.id}</span></td>
                                                <td class="font-semibold">${c.name}</td>
                                                <td><span class="badge badge-${this.getFrameworkColor(c.framework)}" style="font-size: 10px;">${c.framework}</span></td>
                                                <td><span class="font-mono">${c.ref || '-'}</span></td>
                                                <td><span class="badge badge-${c.effectiveness === 'Effective' ? 'green' : c.effectiveness === 'Partially Effective' ? 'amber' : c.effectiveness === 'Ineffective' ? 'red' : 'gray'}">${c.effectiveness}</span></td>
                                                <td>${c.owner || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No controls recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'compliance': () => {
                const auditsByStatus = { 'In Progress': 0, 'Planned': 0, 'Completed': 0 };
                d.audits.forEach(a => { auditsByStatus[a.status] = (auditsByStatus[a.status] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-blue-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-clipboard-check"></i> Compliance Status Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('compliance')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Audit Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${auditsByStatus['In Progress']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">In Progress</div>
                                </div>
                                <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${auditsByStatus['Planned']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Planned</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${auditsByStatus['Completed']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Completed</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Findings Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${d.findings.filter(f => f.status === 'Open').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Open Findings</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${d.findings.filter(f => f.status === 'Closed').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Closed Findings</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Active Audits</h4>
                            ${d.audits.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Audit Name</th><th>Type</th><th>Status</th><th>Lead</th><th>Scope</th></tr></thead>
                                    <tbody>
                                        ${d.audits.map(a => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${a.id}</span></td>
                                                <td class="font-semibold">${a.name}</td>
                                                <td><span class="badge badge-blue">${a.type}</span></td>
                                                <td><span class="badge badge-${a.status === 'Completed' ? 'green' : a.status === 'In Progress' ? 'amber' : 'gray'}">${a.status}</span></td>
                                                <td>${a.lead || '-'}</td>
                                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${a.scope || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No audits recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'vendor': () => {
                const byCriticality = { 'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0 };
                d.vendors.forEach(v => { byCriticality[v.criticality] = (byCriticality[v.criticality] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-purple-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-building"></i> Third-Party Risk Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('vendor')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Vendor Criticality Breakdown</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${byCriticality['Critical']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Critical</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${byCriticality['High']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">High</div>
                                </div>
                                <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${byCriticality['Medium']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Medium</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${byCriticality['Low']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Low</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Vendor Inventory</h4>
                            ${d.vendors.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Vendor</th><th>Service</th><th>Criticality</th><th>Status</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        ${d.vendors.map(v => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${v.id}</span></td>
                                                <td class="font-semibold">${v.name}</td>
                                                <td>${v.service || '-'}</td>
                                                <td><span class="badge badge-${v.criticality === 'Critical' ? 'red' : v.criticality === 'High' ? 'amber' : 'green'}">${v.criticality}</span></td>
                                                <td><span class="badge badge-${v.status === 'Active' ? 'green' : 'gray'}">${v.status}</span></td>
                                                <td>${v.owner || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No vendors recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'incident': () => {
                const byType = {};
                d.incidents.forEach(i => { byType[i.type] = (byType[i.type] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-amber-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-lightning"></i> Incident Summary Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('incident')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Incident Status</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${d.incidents.filter(i => i.status === 'Investigating').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Investigating</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${d.incidents.filter(i => i.status === 'Contained').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Contained</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${d.incidents.filter(i => i.status === 'Resolved').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Resolved</div>
                                </div>
                            </div>
                            
                            ${Object.keys(byType).length > 0 ? `
                                <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Incidents by Type</h4>
                                <div style="margin-bottom: 24px;">
                                    ${Object.entries(byType).map(([type, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                                            <span style="font-size: 13px;">${type}</span>
                                            <span class="badge badge-amber">${count}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Incident Log</h4>
                            ${d.incidents.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Incident</th><th>Type</th><th>Severity</th><th>Status</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        ${d.incidents.map(i => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${i.id}</span></td>
                                                <td class="font-semibold">${i.title}</td>
                                                <td><span class="badge badge-blue">${i.type}</span></td>
                                                <td><span class="badge badge-${i.severity === 'Critical' ? 'red' : i.severity === 'High' ? 'amber' : 'green'}">${i.severity}</span></td>
                                                <td><span class="badge badge-${i.status === 'Resolved' ? 'green' : i.status === 'Investigating' ? 'red' : 'amber'}">${i.status}</span></td>
                                                <td>${i.owner || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No incidents recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'executive': () => {
                const criticalRisks = d.risks.filter(r => r.likelihood * r.impact >= 20).length;
                const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
                const controlEffectiveness = d.controls.length > 0 ? Math.round((effectiveControls / d.controls.length) * 100) : 0;
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-cyan-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-graph-up"></i> Executive Summary Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('executive')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">GRC Program Overview</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-blue);">${this.data.assets.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Assets</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-red);">${d.risks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Risks</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-green);">${d.controls.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Controls</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-purple);">${d.vendors.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Vendors</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Key Metrics</h4>
                            <table style="margin-bottom: 24px;">
                                <tbody>
                                    <tr><td style="padding: 12px;">Critical Risks</td><td style="padding: 12px;"><span class="badge badge-red">${criticalRisks}</span></td><td style="padding: 12px; color: var(--text-muted);">${criticalRisks > 0 ? 'Requires immediate attention' : 'No critical risks'}</td></tr>
                                    <tr><td style="padding: 12px;">Control Effectiveness</td><td style="padding: 12px;"><span class="badge badge-${controlEffectiveness >= 80 ? 'green' : controlEffectiveness >= 50 ? 'amber' : 'red'}">${controlEffectiveness}%</span></td><td style="padding: 12px; color: var(--text-muted);">${effectiveControls} of ${d.controls.length} controls effective</td></tr>
                                    <tr><td style="padding: 12px;">Open Findings</td><td style="padding: 12px;"><span class="badge badge-${d.findings.filter(f => f.status === 'Open').length > 0 ? 'amber' : 'green'}">${d.findings.filter(f => f.status === 'Open').length}</span></td><td style="padding: 12px; color: var(--text-muted);">Pending remediation</td></tr>
                                    <tr><td style="padding: 12px;">Open Issues</td><td style="padding: 12px;"><span class="badge badge-${d.issues.filter(i => i.status === 'Open').length > 0 ? 'amber' : 'green'}">${d.issues.filter(i => i.status === 'Open').length}</span></td><td style="padding: 12px; color: var(--text-muted);">Require follow-up</td></tr>
                                    <tr><td style="padding: 12px;">Active Audits</td><td style="padding: 12px;"><span class="badge badge-blue">${d.audits.filter(a => a.status === 'In Progress').length}</span></td><td style="padding: 12px; color: var(--text-muted);">Currently in progress</td></tr>
                                    <tr><td style="padding: 12px;">Evidence Items</td><td style="padding: 12px;"><span class="badge badge-green">${d.evidence.length}</span></td><td style="padding: 12px; color: var(--text-muted);">Collected for audits</td></tr>
                                </tbody>
                            </table>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Policy Compliance</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${d.policies.filter(p => p.status === 'Approved').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Approved Policies</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${d.policies.filter(p => p.status === 'Under Review' || p.status === 'Draft').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">In Review/Draft</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">${d.policies.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Policies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };
        
        return reports[reportType] ? reports[reportType]() : '<p>Report not found.</p>';
    }
    
    printReport() {
        const reportEl = document.getElementById('printable-report');
        if (!reportEl) {
            this.toast('Please select a report first', 'error');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>GRC Report - ${new Date().toLocaleDateString()}</title>
                <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1a1a2e; }
                    h3, h4 { margin-top: 0; }
                    table { width: 100%; border-collapse: collapse; margin: 16px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 12px; }
                    th { background: #f5f5f5; font-weight: 600; }
                    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
                    .badge-red { background: #fee2e2; color: #dc2626; }
                    .badge-amber { background: #fef3c7; color: #d97706; }
                    .badge-green { background: #dcfce7; color: #16a34a; }
                    .badge-blue { background: #dbeafe; color: #2563eb; }
                    .badge-gray { background: #f3f4f6; color: #6b7280; }
                    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 16px 0; }
                    .stat-box { background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center; }
                    .stat-value { font-size: 24px; font-weight: 700; }
                    .stat-label { font-size: 11px; color: #6b7280; }
                    @media print { body { padding: 20px; } }
                
</style>
            </head>
            <body>
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1a1a2e; padding-bottom: 20px;">
                    <h1 style="margin: 0; font-size: 24px;">GRC Lab Pro Report</h1>
                    <p style="color: #6b7280; margin: 8px 0 0 0;">Generated: ${new Date().toLocaleString()}</p>
                </div>
                ${reportEl.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
    
    exportAllReports() {
        const d = this.getActiveData();
        const allData = {
            exportDate: new Date().toISOString(),
            summary: {
                totalAssets: this.data.assets.length,
                totalRisks: d.risks.length,
                totalControls: d.controls.length,
                totalVendors: d.vendors.length,
                totalPolicies: d.policies.length,
                totalAudits: d.audits.length
            },
            assets: this.data.assets,
            risks: d.risks,
            controls: d.controls,
            vendors: d.vendors,
            policies: d.policies,
            audits: d.audits,
            findings: d.findings,
            incidents: d.incidents,
            evidence: d.evidence
        };
        
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `grc-complete-report-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Complete report exported!', 'success');
    }
    
    exportReportCSV(reportType) {
        const d = this.getActiveData();
        let csv = '';
        let filename = '';
        
        const csvEscape = (val) => `"${String(val || '').replace(/"/g, '""')}"`;
        
        switch(reportType) {
            case 'risk':
                csv = 'ID,Title,Category,Likelihood,Impact,Score,Status,Owner\\n';
                d.risks.forEach(r => {
                    csv += `${csvEscape(r.id)},${csvEscape(r.title)},${csvEscape(r.category)},${r.likelihood},${r.impact},${r.likelihood * r.impact},${csvEscape(r.status)},${csvEscape(r.owner)}\\n`;
                });
                filename = 'risk-report';
                break;
            case 'control':
                csv = 'ID,Name,Framework,Reference,Effectiveness,Frequency,Owner\\n';
                d.controls.forEach(c => {
                    csv += `${csvEscape(c.id)},${csvEscape(c.name)},${csvEscape(c.framework)},${csvEscape(c.ref)},${csvEscape(c.effectiveness)},${csvEscape(c.frequency)},${csvEscape(c.owner)}\\n`;
                });
                filename = 'control-report';
                break;
            case 'vendor':
                csv = 'ID,Name,Service,Criticality,Status,Owner\\n';
                d.vendors.forEach(v => {
                    csv += `${csvEscape(v.id)},${csvEscape(v.name)},${csvEscape(v.service)},${csvEscape(v.criticality)},${csvEscape(v.status)},${csvEscape(v.owner)}\\n`;
                });
                filename = 'vendor-report';
                break;
            case 'incident':
                csv = 'ID,Title,Type,Severity,Status,Owner,Date\\n';
                d.incidents.forEach(i => {
                    csv += `${csvEscape(i.id)},${csvEscape(i.title)},${csvEscape(i.type)},${csvEscape(i.severity)},${csvEscape(i.status)},${csvEscape(i.owner)},${csvEscape(i.date)}\\n`;
                });
                filename = 'incident-report';
                break;
            default:
                csv = 'Metric,Value\\n';
                csv += `Total Assets,${this.data.assets.length}\\n`;
                csv += `Total Risks,${d.risks.length}\\n`;
                csv += `Total Controls,${d.controls.length}\\n`;
                csv += `Total Vendors,${d.vendors.length}\\n`;
                filename = 'executive-summary';
        }
        
        const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Report exported as CSV!', 'success');
    }
    renderEmpty(icon, title, text, action) { return `<div class="empty-state"><div class="empty-state-icon"><i class="bi ${icon}"></i></div><h3 class="empty-state-title">${title}</h3><p class="empty-state-text">${text}</p>${action ? `<button class="btn btn-primary" onclick="app.${action}()"><i class="bi bi-plus-lg"></i> Get Started</button>` : ''}</div>`; }
    deleteItem(key, id) {
        if (!confirm('Delete this item?')) return;
        const activeData = this.getActiveData();
        if (!Array.isArray(activeData[key])) {
            this.toast('Unable to delete item from this section', 'error');
            return;
        }
        activeData[key] = activeData[key].filter(x => x.id !== id);
        this.saveData(key);
        this.renderCurrentTab();
        this.toast('Item deleted', 'success');
    }
    toast(message, type = 'info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast toast-${type}`; t.innerHTML = `<div class="toast-icon"><i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : 'bi-info-circle'}"></i></div><div class="toast-content"><div class="toast-message">${message}</div></div>`; c.appendChild(t); setTimeout(() => t.remove(), 4000); }
    exportData() { const d = JSON.stringify(this.data, null, 2); const b = new Blob([d], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `grc-export-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(u); this.toast('Data exported', 'success'); }
    clearAllData() { if (confirm('Clear ALL data? This cannot be undone.')) { Object.keys(this.data).forEach(k => { this.data[k] = []; localStorage.removeItem(`grc_${k}`); }); this.renderCurrentTab(); this.updateAllBadges(); this.toast('All data cleared', 'success'); } }
    loadDemo() {
        const now = new Date();
        const daysAgo = (n) => new Date(now.getTime() - n*24*60*60*1000).toISOString();
        const daysFromNow = (n) => new Date(now.getTime() + n*24*60*60*1000).toISOString();
        
        // ASSETS (10)
        this.data.assets = [
            { id: 'AST-001', name: 'Customer Portal', type: 'Application', classification: 'Critical', owner: 'Engineering', environment: 'Production', description: 'Public-facing SaaS app for 50K+ customers', createdAt: daysAgo(60), updatedAt: daysAgo(2) },
            { id: 'AST-002', name: 'Patient Database', type: 'Database', classification: 'Critical', owner: 'Data Team', environment: 'Production', description: 'PostgreSQL with PHI and medical records', createdAt: daysAgo(60), updatedAt: daysAgo(1) },
            { id: 'AST-003', name: 'AWS Production', type: 'Cloud Account', classification: 'Critical', owner: 'Cloud Team', environment: 'Production', description: 'Primary AWS account us-east-1', createdAt: daysAgo(60), updatedAt: daysAgo(3) },
            { id: 'AST-004', name: 'Admin Dashboard', type: 'Application', classification: 'High', owner: 'Engineering', environment: 'Production', description: 'Internal admin tools', createdAt: daysAgo(45), updatedAt: daysAgo(5) },
            { id: 'AST-005', name: 'API Gateway', type: 'Application', classification: 'High', owner: 'Platform', environment: 'Production', description: 'Kong gateway, 10M req/day', createdAt: daysAgo(40), updatedAt: daysAgo(7) },
            { id: 'AST-006', name: 'Corporate VPN', type: 'Network Device', classification: 'High', owner: 'IT Security', environment: 'Production', description: 'Cisco AnyConnect infrastructure', createdAt: daysAgo(90), updatedAt: daysAgo(10) },
            { id: 'AST-007', name: 'Data Warehouse', type: 'Database', classification: 'High', owner: 'Analytics', environment: 'Production', description: 'Snowflake for BI/reporting', createdAt: daysAgo(30), updatedAt: daysAgo(4) },
            { id: 'AST-008', name: 'Backup Storage', type: 'Data Store', classification: 'Critical', owner: 'Infrastructure', environment: 'DR', description: 'S3 Glacier for DR', createdAt: daysAgo(60), updatedAt: daysAgo(15) },
            { id: 'AST-009', name: 'CI/CD Pipeline', type: 'Application', classification: 'High', owner: 'DevOps', environment: 'Production', description: 'GitHub Actions deployment', createdAt: daysAgo(35), updatedAt: daysAgo(2) },
            { id: 'AST-010', name: 'Employee Laptops', type: 'Endpoint', classification: 'Medium', owner: 'IT', environment: 'Production', description: 'MacBook fleet with MDM', createdAt: daysAgo(30), updatedAt: daysAgo(8) }
        ];
        
        // VENDORS (8)
        this.data.vendors = [
            { id: 'VND-001', name: 'Amazon Web Services', service: 'Cloud Infrastructure', criticality: 'Critical', status: 'Active', owner: 'Cloud Team', contractRenewal: daysFromNow(180), notes: 'SOC 2 Type II, ISO 27001', createdAt: daysAgo(365), updatedAt: daysAgo(30) },
            { id: 'VND-002', name: 'Stripe', service: 'Payment Processing', criticality: 'Critical', status: 'Active', owner: 'Finance', contractRenewal: daysFromNow(90), notes: 'PCI DSS Level 1', createdAt: daysAgo(200), updatedAt: daysAgo(14) },
            { id: 'VND-003', name: 'Okta', service: 'Identity Management', criticality: 'Critical', status: 'Active', owner: 'IT Security', contractRenewal: daysFromNow(120), notes: 'SSO/MFA provider', createdAt: daysAgo(180), updatedAt: daysAgo(7) },
            { id: 'VND-004', name: 'Datadog', service: 'Monitoring', criticality: 'High', status: 'Active', owner: 'DevOps', contractRenewal: daysFromNow(60), notes: 'APM and log management', createdAt: daysAgo(150), updatedAt: daysAgo(21) },
            { id: 'VND-005', name: 'SendGrid', service: 'Email Delivery', criticality: 'Medium', status: 'Active', owner: 'Marketing', contractRenewal: daysFromNow(45), notes: 'Transactional email', createdAt: daysAgo(100), updatedAt: daysAgo(35) },
            { id: 'VND-006', name: 'Salesforce', service: 'CRM', criticality: 'High', status: 'Active', owner: 'Sales Ops', contractRenewal: daysFromNow(200), notes: 'Customer data with encryption', createdAt: daysAgo(400), updatedAt: daysAgo(10) },
            { id: 'VND-007', name: 'GitHub', service: 'Code Repository', criticality: 'High', status: 'Active', owner: 'Engineering', contractRenewal: daysFromNow(240), notes: 'Source code and CI/CD', createdAt: daysAgo(300), updatedAt: daysAgo(5) },
            { id: 'VND-008', name: 'Snyk', service: 'Security Scanning', criticality: 'Medium', status: 'Active', owner: 'SecOps', contractRenewal: daysFromNow(150), notes: 'Dependency scanning', createdAt: daysAgo(120), updatedAt: daysAgo(12) }
        ];
        
        // POLICIES (8)
        this.data.policies = [
            { id: 'POL-001', title: 'Information Security Policy', status: 'Approved', owner: 'CISO', reviewDate: daysFromNow(90), createdAt: daysAgo(365), updatedAt: daysAgo(30) },
            { id: 'POL-002', title: 'Access Control Policy', status: 'Approved', owner: 'IT Security', reviewDate: daysFromNow(60), createdAt: daysAgo(300), updatedAt: daysAgo(45) },
            { id: 'POL-003', title: 'Data Classification Policy', status: 'Approved', owner: 'Data Gov', reviewDate: daysFromNow(120), createdAt: daysAgo(200), updatedAt: daysAgo(60) },
            { id: 'POL-004', title: 'Incident Response Policy', status: 'Review', owner: 'SecOps', reviewDate: daysFromNow(14), createdAt: daysAgo(180), updatedAt: daysAgo(5) },
            { id: 'POL-005', title: 'Backup & Recovery Policy', status: 'Approved', owner: 'Infrastructure', reviewDate: daysFromNow(150), createdAt: daysAgo(250), updatedAt: daysAgo(90) },
            { id: 'POL-006', title: 'Acceptable Use Policy', status: 'Approved', owner: 'HR', reviewDate: daysFromNow(180), createdAt: daysAgo(400), updatedAt: daysAgo(120) },
            { id: 'POL-007', title: 'Vendor Management Policy', status: 'Draft', owner: 'Procurement', reviewDate: daysFromNow(30), createdAt: daysAgo(30), updatedAt: daysAgo(2) },
            { id: 'POL-008', title: 'Encryption Policy', status: 'Approved', owner: 'IT Security', reviewDate: daysFromNow(100), createdAt: daysAgo(150), updatedAt: daysAgo(75) }
        ];
        
        // RISKS (12)
        this.data.risks = [
            { id: 'RSK-001', title: 'Unauthorized access via compromised credentials', category: 'Access Control', status: 'In Progress', likelihood: 4, impact: 5, owner: 'IT Security', assetId: 'AST-003', description: 'Credential stuffing or phishing could grant unauthorized AWS access', createdAt: daysAgo(45), updatedAt: daysAgo(2) },
            { id: 'RSK-002', title: 'Data breach through application vulnerability', category: 'Application Security', status: 'In Progress', likelihood: 3, impact: 5, owner: 'AppSec', assetId: 'AST-001', description: 'OWASP Top 10 vulnerabilities could expose customer data', createdAt: daysAgo(40), updatedAt: daysAgo(3) },
            { id: 'RSK-003', title: 'Extended outage from failed disaster recovery', category: 'Availability', status: 'Open', likelihood: 3, impact: 4, owner: 'Infrastructure', assetId: 'AST-008', description: 'Backup restoration procedures untested for 6 months', createdAt: daysAgo(35), updatedAt: daysAgo(1) },
            { id: 'RSK-004', title: 'PHI exposure via S3 misconfiguration', category: 'Data Protection', status: 'In Progress', likelihood: 2, impact: 5, owner: 'Cloud Team', assetId: 'AST-003', description: 'IAM or bucket policy errors could expose patient data', createdAt: daysAgo(30), updatedAt: daysAgo(5) },
            { id: 'RSK-005', title: 'Vendor data breach affecting customers', category: 'Vendor Risk', status: 'Open', likelihood: 3, impact: 4, owner: 'Procurement', assetId: null, description: 'Critical vendor breach could expose shared data', createdAt: daysAgo(28), updatedAt: daysAgo(7) },
            { id: 'RSK-006', title: 'Ransomware encrypting production databases', category: 'Application Security', status: 'In Progress', likelihood: 3, impact: 5, owner: 'SecOps', assetId: 'AST-002', description: 'Ransomware could cause extended downtime and data loss', createdAt: daysAgo(25), updatedAt: daysAgo(4) },
            { id: 'RSK-007', title: 'Insider threat data exfiltration', category: 'Access Control', status: 'Open', likelihood: 2, impact: 4, owner: 'HR Security', assetId: null, description: 'Malicious insider could steal sensitive data', createdAt: daysAgo(20), updatedAt: daysAgo(10) },
            { id: 'RSK-008', title: 'API abuse causing service degradation', category: 'Availability', status: 'In Progress', likelihood: 4, impact: 3, owner: 'Platform', assetId: 'AST-005', description: 'DDoS or API abuse could overwhelm gateway', createdAt: daysAgo(18), updatedAt: daysAgo(6) },
            { id: 'RSK-009', title: 'HIPAA non-compliance penalties', category: 'Compliance', status: 'In Progress', likelihood: 2, impact: 5, owner: 'Compliance', assetId: null, description: 'Control gaps could result in $1.5M+ fines', createdAt: daysAgo(15), updatedAt: daysAgo(3) },
            { id: 'RSK-010', title: 'VPN compromise enabling lateral movement', category: 'Access Control', status: 'Open', likelihood: 3, impact: 4, owner: 'Network', assetId: 'AST-006', description: 'VPN vulnerability could enable network intrusion', createdAt: daysAgo(12), updatedAt: daysAgo(8) },
            { id: 'RSK-011', title: 'Supply chain attack via dependencies', category: 'Vendor Risk', status: 'Open', likelihood: 2, impact: 4, owner: 'Engineering', assetId: 'AST-009', description: 'Compromised npm/pip packages could introduce backdoors', createdAt: daysAgo(10), updatedAt: daysAgo(5) },
            { id: 'RSK-012', title: 'Phishing attacks targeting employees', category: 'Human Error', status: 'In Progress', likelihood: 4, impact: 3, owner: 'IT Security', assetId: 'AST-010', description: 'Sophisticated phishing campaigns', createdAt: daysAgo(8), updatedAt: daysAgo(2) }
        ];
        
        // CONTROLS (15)
        this.data.controls = [
            { id: 'CTL-001', name: 'Multi-Factor Authentication (MFA)', framework: 'ISO 27001', ref: 'A.5.17', effectiveness: 'Effective', frequency: 'Continuous', owner: 'IT Security', description: 'MFA via Okta for all admin access', createdAt: daysAgo(90), updatedAt: daysAgo(5) },
            { id: 'CTL-002', name: 'Centralized Log Monitoring', framework: 'SOC 2', ref: 'CC7.2', effectiveness: 'Effective', frequency: 'Continuous', owner: 'SecOps', description: 'Datadog SIEM with 90-day retention', createdAt: daysAgo(85), updatedAt: daysAgo(3) },
            { id: 'CTL-003', name: 'Automated Backup & Encryption', framework: 'ISO 27001', ref: 'A.8.13', effectiveness: 'Partially Effective', frequency: 'Daily', owner: 'Infrastructure', description: 'Daily AES-256 encrypted backups', createdAt: daysAgo(80), updatedAt: daysAgo(10) },
            { id: 'CTL-004', name: 'Vulnerability Scanning', framework: 'NIST CSF', ref: 'DE.CM-8', effectiveness: 'Effective', frequency: 'Weekly', owner: 'AppSec', description: 'Weekly Snyk scans, 7-day critical SLA', createdAt: daysAgo(75), updatedAt: daysAgo(7) },
            { id: 'CTL-005', name: 'Network Segmentation', framework: 'PCI DSS', ref: '1.3', effectiveness: 'Effective', frequency: 'Quarterly', owner: 'Network', description: 'VPC isolation between environments', createdAt: daysAgo(70), updatedAt: daysAgo(15) },
            { id: 'CTL-006', name: 'Access Review Process', framework: 'SOC 2', ref: 'CC6.1', effectiveness: 'Partially Effective', frequency: 'Quarterly', owner: 'IT Security', description: 'Quarterly privileged access reviews', createdAt: daysAgo(65), updatedAt: daysAgo(20) },
            { id: 'CTL-007', name: 'Data Encryption at Rest', framework: 'HIPAA', ref: '164.312(a)', effectiveness: 'Effective', frequency: 'Continuous', owner: 'Data Team', description: 'AES-256 for all PHI databases', createdAt: daysAgo(60), updatedAt: daysAgo(12) },
            { id: 'CTL-008', name: 'Security Awareness Training', framework: 'ISO 27001', ref: 'A.6.3', effectiveness: 'Effective', frequency: 'Annual', owner: 'HR', description: 'Annual training + monthly phishing sims', createdAt: daysAgo(55), updatedAt: daysAgo(30) },
            { id: 'CTL-009', name: 'Incident Response Plan', framework: 'NIST CSF', ref: 'RS.RP-1', effectiveness: 'Partially Effective', frequency: 'Annual', owner: 'SecOps', description: 'Documented IR playbooks', createdAt: daysAgo(50), updatedAt: daysAgo(8) },
            { id: 'CTL-010', name: 'API Rate Limiting', framework: 'CIS', ref: '13.1', effectiveness: 'Effective', frequency: 'Continuous', owner: 'Platform', description: '1000 req/min via Kong', createdAt: daysAgo(45), updatedAt: daysAgo(4) },
            { id: 'CTL-011', name: 'Vendor Security Assessment', framework: 'ISO 27001', ref: 'A.5.19', effectiveness: 'Ineffective', frequency: 'Annual', owner: 'Procurement', description: 'Security questionnaires (incomplete)', createdAt: daysAgo(40), updatedAt: daysAgo(25) },
            { id: 'CTL-012', name: 'Endpoint Detection & Response', framework: 'NIST CSF', ref: 'DE.CM-4', effectiveness: 'Effective', frequency: 'Continuous', owner: 'SecOps', description: 'CrowdStrike on all endpoints', createdAt: daysAgo(35), updatedAt: daysAgo(2) },
            { id: 'CTL-013', name: 'WAF Protection', framework: 'CIS', ref: '13.6', effectiveness: 'Effective', frequency: 'Continuous', owner: 'Platform', description: 'AWS WAF with OWASP rules', createdAt: daysAgo(30), updatedAt: daysAgo(6) },
            { id: 'CTL-014', name: 'Change Management', framework: 'COBIT', ref: 'BAI06', effectiveness: 'Effective', frequency: 'Per Change', owner: 'DevOps', description: 'PR reviews and deployment approvals', createdAt: daysAgo(25), updatedAt: daysAgo(1) },
            { id: 'CTL-015', name: 'Data Loss Prevention', framework: 'GDPR', ref: 'Art. 32', effectiveness: 'Ineffective', frequency: 'Continuous', owner: 'IT Security', description: 'DLP tool currently disabled', createdAt: daysAgo(20), updatedAt: daysAgo(5) }
        ];
        
        // TREATMENTS (6)
        this.data.treatments = [
            { id: 'TRT-001', riskId: 'RSK-003', type: 'Mitigate', status: 'In Progress', owner: 'Infrastructure', dueDate: daysFromNow(14), plan: '1. Document restore procedures\n2. Schedule monthly tests\n3. Create DR runbook', createdAt: daysAgo(20), updatedAt: daysAgo(3) },
            { id: 'TRT-002', riskId: 'RSK-001', type: 'Mitigate', status: 'In Progress', owner: 'IT Security', dueDate: daysFromNow(30), plan: '1. Deploy hardware security keys\n2. Enable impossible travel detection\n3. Phishing campaign', createdAt: daysAgo(18), updatedAt: daysAgo(5) },
            { id: 'TRT-003', riskId: 'RSK-005', type: 'Transfer', status: 'Planned', owner: 'Legal', dueDate: daysFromNow(45), plan: '1. Review cyber insurance\n2. Require SOC 2 from vendors\n3. Update contracts', createdAt: daysAgo(15), updatedAt: daysAgo(7) },
            { id: 'TRT-004', riskId: 'RSK-006', type: 'Mitigate', status: 'In Progress', owner: 'SecOps', dueDate: daysFromNow(21), plan: '1. Deploy ransomware detection\n2. Implement immutable backups\n3. Create response playbook', createdAt: daysAgo(12), updatedAt: daysAgo(2) },
            { id: 'TRT-005', riskId: 'RSK-007', type: 'Mitigate', status: 'Planned', owner: 'HR Security', dueDate: daysFromNow(60), plan: '1. Deploy DLP\n2. USB restrictions\n3. User behavior analytics', createdAt: daysAgo(10), updatedAt: daysAgo(4) },
            { id: 'TRT-006', riskId: 'RSK-009', type: 'Mitigate', status: 'In Progress', owner: 'Compliance', dueDate: daysFromNow(28), plan: '1. HIPAA gap assessment\n2. Remediate findings\n3. Update BAAs', createdAt: daysAgo(8), updatedAt: daysAgo(1) }
        ];
        
        // ISSUES (5)
        this.data.issues = [
            { id: 'ISS-001', title: 'Q3 access reviews incomplete', category: 'Process Gap', severity: 'High', status: 'Open', owner: 'IT Security', dueDate: daysFromNow(7), description: '45 privileged accounts pending review', createdAt: daysAgo(21), updatedAt: daysAgo(1) },
            { id: 'ISS-002', title: 'Missing BAA with analytics vendor', category: 'Compliance Issue', severity: 'Critical', status: 'In Progress', owner: 'Legal', dueDate: daysFromNow(3), description: 'Datadog processes PHI without BAA - HIPAA violation', createdAt: daysAgo(14), updatedAt: daysAgo(2) },
            { id: 'ISS-003', title: 'Outdated IR playbooks', category: 'Process Gap', severity: 'Medium', status: 'Open', owner: 'SecOps', dueDate: daysFromNow(21), description: 'Last updated 14 months ago', createdAt: daysAgo(10), updatedAt: daysAgo(5) },
            { id: 'ISS-004', title: 'Backup restore test documentation missing', category: 'Technical Debt', severity: 'High', status: 'In Progress', owner: 'Infrastructure', dueDate: daysFromNow(14), description: 'Last documented test was 8 months ago', createdAt: daysAgo(7), updatedAt: daysAgo(3) },
            { id: 'ISS-005', title: 'Encryption key rotation overdue', category: 'Security Gap', severity: 'Medium', status: 'Open', owner: 'Cloud Team', dueDate: daysFromNow(10), description: 'KMS keys not rotated in 120 days (policy: 90 days)', createdAt: daysAgo(5), updatedAt: daysAgo(2) }
        ];
        
        // INCIDENTS (4)
        this.data.incidents = [
            { id: 'INC-001', title: 'Customer portal 5xx errors', type: 'Availability', severity: 'High', status: 'Resolved', owner: 'SRE', date: daysAgo(5), description: '15-minute outage due to DB connection pool exhaustion', createdAt: daysAgo(5), updatedAt: daysAgo(4) },
            { id: 'INC-002', title: 'Phishing campaign targeting finance', type: 'Phishing', severity: 'Medium', status: 'Resolved', owner: 'SecOps', date: daysAgo(12), description: '23 employees received emails, 2 clicked, MFA blocked compromise', createdAt: daysAgo(12), updatedAt: daysAgo(10) },
            { id: 'INC-003', title: 'Unauthorized access attempt detected', type: 'Security', severity: 'High', status: 'Investigating', owner: 'SecOps', date: daysAgo(2), description: 'Multiple failed logins from suspicious IPs, accounts locked', createdAt: daysAgo(2), updatedAt: daysAgo(1) },
            { id: 'INC-004', title: 'Accidental staging data exposure', type: 'Data Breach', severity: 'Medium', status: 'Resolved', owner: 'DevOps', date: daysAgo(20), description: 'Prod data copied to staging, accessible by contractors for 2 hours', createdAt: daysAgo(20), updatedAt: daysAgo(18) }
        ];
        
        // TASKS (8)
        this.data.tasks = [
            { id: 'TSK-001', title: 'Complete Q3 access review', priority: 'High', status: 'In Progress', assignee: 'IT Security', dueDate: daysFromNow(7), notes: 'Review 45 privileged accounts', createdAt: daysAgo(21), updatedAt: daysAgo(2) },
            { id: 'TSK-002', title: 'Execute database restore test', priority: 'High', status: 'Not Started', assignee: 'DBA Team', dueDate: daysFromNow(14), notes: 'Full restore to DR environment', createdAt: daysAgo(14), updatedAt: daysAgo(7) },
            { id: 'TSK-003', title: 'Deploy hardware security keys', priority: 'Critical', status: 'In Progress', assignee: 'IT Security', dueDate: daysFromNow(21), notes: 'YubiKeys for 15 admins', createdAt: daysAgo(10), updatedAt: daysAgo(3) },
            { id: 'TSK-004', title: 'Update IR playbooks', priority: 'Medium', status: 'Not Started', assignee: 'SOC Manager', dueDate: daysFromNow(30), notes: 'Add cloud-specific scenarios', createdAt: daysAgo(7), updatedAt: daysAgo(5) },
            { id: 'TSK-005', title: 'Rotate KMS keys', priority: 'Medium', status: 'Not Started', assignee: 'Cloud Engineer', dueDate: daysFromNow(10), notes: 'All keys older than 90 days', createdAt: daysAgo(5), updatedAt: daysAgo(2) },
            { id: 'TSK-006', title: 'Finalize Datadog BAA', priority: 'Critical', status: 'In Progress', assignee: 'Legal', dueDate: daysFromNow(3), notes: 'Execute BAA for PHI processing', createdAt: daysAgo(10), updatedAt: daysAgo(1) },
            { id: 'TSK-007', title: 'Vendor security assessment - Stripe', priority: 'High', status: 'Not Started', assignee: 'Procurement', dueDate: daysFromNow(45), notes: 'Review SOC 2 and PCI compliance', createdAt: daysAgo(3), updatedAt: daysAgo(1) },
            { id: 'TSK-008', title: 'Schedule ransomware tabletop', priority: 'Medium', status: 'Not Started', assignee: 'CISO', dueDate: daysFromNow(60), notes: 'Include IT, Legal, Comms teams', createdAt: daysAgo(2), updatedAt: daysAgo(1) }
        ];
        
        // AUDITS (4)
        this.data.audits = [
            { id: 'AUD-001', name: 'SOC 2 Type II Annual', type: 'SOC 2', status: 'In Progress', lead: 'Deloitte', startDate: daysAgo(30), scope: 'Security, Availability, Confidentiality', createdAt: daysAgo(60), updatedAt: daysAgo(2) },
            { id: 'AUD-002', name: 'HIPAA Assessment', type: 'HIPAA', status: 'Planned', lead: 'Compliance Officer', startDate: daysFromNow(45), scope: 'PHI processing systems and procedures', createdAt: daysAgo(30), updatedAt: daysAgo(10) },
            { id: 'AUD-003', name: 'Internal Control Testing Q4', type: 'Internal', status: 'Planned', lead: 'Internal Audit', startDate: daysFromNow(14), scope: 'Access management, change management, IR', createdAt: daysAgo(14), updatedAt: daysAgo(5) },
            { id: 'AUD-004', name: 'PCI DSS v4.0 Gap Assessment', type: 'PCI DSS', status: 'Completed', lead: 'Coalfire', startDate: daysAgo(90), scope: 'Cardholder data environment', createdAt: daysAgo(120), updatedAt: daysAgo(60) }
        ];
        
        // EVIDENCE (10)
        this.data.evidence = [
            { id: 'EVD-001', title: 'MFA Configuration Screenshot', type: 'Screenshot', relatedTo: 'CTL-001', owner: 'IT Security', url: 'https://drive.company.com/mfa-config.png', notes: 'Okta MFA enforcement for admin groups', createdAt: daysAgo(30), updatedAt: daysAgo(5) },
            { id: 'EVD-002', title: 'SIEM Alert Rules Export', type: 'Export', relatedTo: 'CTL-002', owner: 'SecOps', url: 'https://drive.company.com/siem-rules.json', notes: '47 detection rules from Datadog', createdAt: daysAgo(25), updatedAt: daysAgo(10) },
            { id: 'EVD-003', title: 'Backup Job Report', type: 'Report', relatedTo: 'CTL-003', owner: 'Infrastructure', url: 'https://drive.company.com/backup-dec.pdf', notes: '99.2% backup completion rate', createdAt: daysAgo(20), updatedAt: daysAgo(15) },
            { id: 'EVD-004', title: 'Vulnerability Scan Results', type: 'Report', relatedTo: 'CTL-004', owner: 'AppSec', url: 'https://drive.company.com/snyk-q4.pdf', notes: '0 critical, 3 high findings', createdAt: daysAgo(15), updatedAt: daysAgo(7) },
            { id: 'EVD-005', title: 'Firewall Rule Review', type: 'Document', relatedTo: 'CTL-005', owner: 'Network', url: 'https://drive.company.com/fw-review.xlsx', notes: 'Quarterly review with approvals', createdAt: daysAgo(45), updatedAt: daysAgo(40) },
            { id: 'EVD-006', title: 'Access Review Report Q2', type: 'Report', relatedTo: 'CTL-006', owner: 'IT Security', url: 'https://drive.company.com/access-q2.pdf', notes: '98% completion rate', createdAt: daysAgo(90), updatedAt: daysAgo(85) },
            { id: 'EVD-007', title: 'KMS Key Rotation Log', type: 'Log', relatedTo: 'CTL-007', owner: 'Cloud Team', url: 'https://drive.company.com/kms.log', notes: 'CloudTrail rotation events', createdAt: daysAgo(60), updatedAt: daysAgo(55) },
            { id: 'EVD-008', title: 'Security Training Report', type: 'Report', relatedTo: 'CTL-008', owner: 'HR', url: 'https://drive.company.com/training.pdf', notes: '100% completion', createdAt: daysAgo(30), updatedAt: daysAgo(25) },
            { id: 'EVD-009', title: 'IR Plan Document', type: 'Document', relatedTo: 'CTL-009', owner: 'SecOps', url: 'https://drive.company.com/ir-plan.pdf', notes: 'v2.3 current plan', createdAt: daysAgo(240), updatedAt: daysAgo(240) },
            { id: 'EVD-010', title: 'WAF Configuration', type: 'Configuration', relatedTo: 'CTL-013', owner: 'Platform', url: 'https://drive.company.com/waf.yaml', notes: 'AWS WAF rule set', createdAt: daysAgo(45), updatedAt: daysAgo(4) }
        ];
        
        // CONTROL TESTS (6)
        this.data.controlTests = [
            { id: 'TST-001', controlId: 'CTL-001', testDate: daysAgo(14), result: 'Pass', tester: 'External Auditor', procedure: 'Verified MFA for 20 admin accounts, all required MFA', createdAt: daysAgo(14), updatedAt: daysAgo(14) },
            { id: 'TST-002', controlId: 'CTL-002', testDate: daysAgo(10), result: 'Pass', tester: 'Internal Audit', procedure: 'Generated test events, alerts triggered within SLA', createdAt: daysAgo(10), updatedAt: daysAgo(10) },
            { id: 'TST-003', controlId: 'CTL-003', testDate: daysAgo(7), result: 'Partial', tester: 'Internal Audit', procedure: 'Backups running but restore test incomplete', createdAt: daysAgo(7), updatedAt: daysAgo(7) },
            { id: 'TST-004', controlId: 'CTL-006', testDate: daysAgo(30), result: 'Fail', tester: 'External Auditor', procedure: 'Only 60% of accounts reviewed by deadline', createdAt: daysAgo(30), updatedAt: daysAgo(30) },
            { id: 'TST-005', controlId: 'CTL-013', testDate: daysAgo(12), result: 'Pass', tester: 'SecOps', procedure: 'OWASP Top 10 attacks blocked successfully', createdAt: daysAgo(12), updatedAt: daysAgo(12) },
            { id: 'TST-006', controlId: 'CTL-015', testDate: daysAgo(5), result: 'Fail', tester: 'IT Security', procedure: 'DLP tool disabled, control not operational', createdAt: daysAgo(5), updatedAt: daysAgo(5) }
        ];
        
        // FINDINGS (5)
        this.data.findings = [
            { id: 'FND-001', title: 'Backup restore testing not performed', severity: 'High', status: 'Open', owner: 'Infrastructure', dueDate: daysFromNow(14), description: 'No evidence of restore testing in 6 months', recommendation: 'Implement quarterly restore tests with documentation', createdAt: daysAgo(20), updatedAt: daysAgo(5) },
            { id: 'FND-002', title: 'DLP controls not operational', severity: 'High', status: 'Open', owner: 'IT Security', dueDate: daysFromNow(21), description: 'DLP disabled due to performance issues', recommendation: 'Optimize and re-enable DLP', createdAt: daysAgo(5), updatedAt: daysAgo(3) },
            { id: 'FND-003', title: 'Access reviews incomplete', severity: 'Medium', status: 'In Progress', owner: 'IT Security', dueDate: daysFromNow(7), description: '40% of accounts reviewed late', recommendation: 'Implement automated review workflow', createdAt: daysAgo(30), updatedAt: daysAgo(2) },
            { id: 'FND-004', title: 'Vendor SOC 2 reports expired', severity: 'Medium', status: 'In Progress', owner: 'Procurement', dueDate: daysFromNow(7), description: '2 critical vendors have expired reports', recommendation: 'Request updated reports immediately', createdAt: daysAgo(15), updatedAt: daysAgo(5) },
            { id: 'FND-005', title: 'Missing Business Associate Agreement', severity: 'Critical', status: 'In Progress', owner: 'Legal', dueDate: daysFromNow(3), description: 'BAA not executed with Datadog for PHI', recommendation: 'Execute BAA immediately, review all PHI vendors', createdAt: daysAgo(14), updatedAt: daysAgo(1) }
        ];
        


        // REQUIREMENTS (8) - lightweight compliance tracking
        this.data.requirements = [
            { id: 'REQ-001', framework: 'ISO 27001', reqCode: 'A.5.15', title: 'Access control rules', statement: 'Define and enforce access control rules including least privilege, approvals, and periodic review for systems and data.', priority: 'High', status: 'Partial', mappedControls: ['CTL-001','CTL-006'], evidenceIds: ['EVD-001','EVD-006'], findingIds: ['FND-003'], notes: 'Access review process exists but completion is inconsistent.', createdAt: daysAgo(40), updatedAt: daysAgo(3) },
            { id: 'REQ-002', framework: 'ISO 27001', reqCode: 'A.5.23', title: 'Cloud services security', statement: 'Establish security requirements for use of cloud services including shared responsibility, IAM guardrails, and configuration baselines.', priority: 'High', status: 'Partial', mappedControls: ['CTL-011','CTL-012'], evidenceIds: ['EVD-010'], findingIds: [], notes: 'Baseline is in place; tighten data protection for PHI workloads.', createdAt: daysAgo(35), updatedAt: daysAgo(4) },
            { id: 'REQ-003', framework: 'SOC 2', reqCode: 'CC6.1', title: 'Logical access security', statement: 'Implement logical access controls including authentication, authorization, and monitoring to restrict access to systems and data.', priority: 'High', status: 'Partial', mappedControls: ['CTL-001','CTL-002','CTL-006'], evidenceIds: ['EVD-001','EVD-002','EVD-006'], findingIds: ['FND-003'], notes: 'Improve timeliness and completeness of access reviews.', createdAt: daysAgo(30), updatedAt: daysAgo(2) },
            { id: 'REQ-004', framework: 'SOC 2', reqCode: 'CC7.2', title: 'Monitoring for anomalies', statement: 'Detect and respond to anomalous activity using monitoring, alerting, and investigation procedures.', priority: 'Medium', status: 'Met', mappedControls: ['CTL-002'], evidenceIds: ['EVD-002'], findingIds: [], notes: 'Alert rules tested and within SLA.', createdAt: daysAgo(25), updatedAt: daysAgo(10) },
            { id: 'REQ-005', framework: 'PCI DSS', reqCode: '10.2', title: 'Audit logging for in-scope systems', statement: 'Enable audit logging to track user activities and system events for systems in scope of the cardholder data environment.', priority: 'High', status: 'Not met', mappedControls: ['CTL-002'], evidenceIds: ['EVD-002'], findingIds: [], notes: 'Logging exists; PCI scope + retention/integrity controls not validated.', createdAt: daysAgo(20), updatedAt: daysAgo(7) },
            { id: 'REQ-006', framework: 'HIPAA', reqCode: '164.308(a)(7)', title: 'Contingency plan', statement: 'Establish and implement procedures for responding to emergencies that damage systems containing ePHI, including backup and disaster recovery.', priority: 'Critical', status: 'Partial', mappedControls: ['CTL-003'], evidenceIds: ['EVD-003'], findingIds: ['FND-001'], notes: 'Restore testing evidence is missing for the last 6 months.', createdAt: daysAgo(18), updatedAt: daysAgo(5) },
            { id: 'REQ-007', framework: 'HIPAA', reqCode: '164.308(a)(1)', title: 'Risk management', statement: 'Implement security measures to reduce risks and vulnerabilities to a reasonable and appropriate level.', priority: 'High', status: 'Partial', mappedControls: ['CTL-004'], evidenceIds: ['EVD-004'], findingIds: ['FND-002'], notes: 'Scanning exists; remediation SLAs and DLP operationalization need improvement.', createdAt: daysAgo(15), updatedAt: daysAgo(3) },
            { id: 'REQ-008', framework: 'ISO 27001', reqCode: 'A.5.24', title: 'Incident planning & readiness', statement: 'Maintain an incident response capability including roles, escalation, communication, and readiness activities such as tabletop exercises.', priority: 'High', status: 'Partial', mappedControls: ['CTL-009'], evidenceIds: ['EVD-009'], findingIds: [], notes: 'IR plan exists; tabletop exercise evidence pending.', createdAt: daysAgo(14), updatedAt: daysAgo(1) }
        ];

        // EXCEPTIONS (3) - risk acceptance with expiry
        const toDateInput = (iso) => (iso || '').slice(0, 10);
        this.data.exceptions = [
            { id: 'EXC-001', exCode: 'EX-2026-001', title: 'Temporary acceptance: DLP disabled for performance', status: 'Approved', reason: 'DLP agent caused performance issues on key endpoints. Risk accepted short-term while tuning and staged rollout is completed.', scopeType: 'Control', scopeId: 'CTL-015', compensatingControls: ['CTL-002'], owner: 'IT Security', approver: 'CISO', reviewDate: toDateInput(daysFromNow(14)), expiryDate: toDateInput(daysFromNow(45)), notes: 'Increase alerting on data egress and review weekly until DLP re-enabled.', createdAt: daysAgo(10), updatedAt: daysAgo(2) },
            { id: 'EXC-002', exCode: 'EX-2026-002', title: 'Acceptance: Restore test delayed due to DR maintenance', status: 'Draft', reason: 'DR environment maintenance window delayed the quarterly restore test. Seeking approval to extend deadline by 30 days.', scopeType: 'Finding', scopeId: 'FND-001', compensatingControls: ['CTL-003'], owner: 'Infrastructure', approver: 'CISO', reviewDate: toDateInput(daysFromNow(7)), expiryDate: toDateInput(daysFromNow(30)), notes: 'Schedule restore test immediately after maintenance window; attach report as evidence.', createdAt: daysAgo(6), updatedAt: daysAgo(1) },
            { id: 'EXC-003', exCode: 'EX-2026-003', title: 'Exception: Pending BAA with monitoring vendor', status: 'In Review', reason: 'BAA execution is in progress with the monitoring vendor; legal review underway. Risk accepted for limited PHI telemetry until agreement is signed.', scopeType: 'Requirement', scopeId: 'REQ-006', compensatingControls: ['CTL-002'], owner: 'Legal', approver: 'Compliance Officer', reviewDate: toDateInput(daysFromNow(3)), expiryDate: toDateInput(daysFromNow(10)), notes: 'Limit PHI fields in logs and confirm vendor redaction before sending PHI telemetry.', createdAt: daysAgo(4), updatedAt: daysAgo(1) }
        ];

        // STATEMENT OF APPLICABILITY (SoA) - ISO 27001 Annex A Controls
        this.data.soa = [
            { controlId: 'A.5.1', name: 'Policies for information security', applicable: true, justification: 'Required for all organizations handling sensitive data', implementation: 'Implemented', evidence: 'POL-001, POL-002', notes: 'Annual review scheduled' },
            { controlId: 'A.5.2', name: 'Information security roles and responsibilities', applicable: true, justification: 'Critical for accountability', implementation: 'Implemented', evidence: 'RACI Matrix, Org Chart', notes: 'CISO appointed' },
            { controlId: 'A.5.3', name: 'Segregation of duties', applicable: true, justification: 'Prevents fraud and errors', implementation: 'Partially Implemented', evidence: 'Access review reports', notes: 'Improvements needed in finance' },
            { controlId: 'A.5.7', name: 'Threat intelligence', applicable: true, justification: 'Proactive security posture', implementation: 'Implemented', evidence: 'CTL-002, SIEM dashboards', notes: 'Using commercial threat feeds' },
            { controlId: 'A.5.15', name: 'Access control', applicable: true, justification: 'Core security requirement', implementation: 'Implemented', evidence: 'CTL-001, CTL-006', notes: 'MFA enforced for all users' },
            { controlId: 'A.5.16', name: 'Identity management', applicable: true, justification: 'User lifecycle management', implementation: 'Implemented', evidence: 'Okta configuration', notes: 'Automated provisioning' },
            { controlId: 'A.5.17', name: 'Authentication information', applicable: true, justification: 'Password and credential security', implementation: 'Implemented', evidence: 'Password policy', notes: 'Complexity requirements enforced' },
            { controlId: 'A.5.23', name: 'Information security for cloud services', applicable: true, justification: 'AWS cloud infrastructure', implementation: 'Partially Implemented', evidence: 'CTL-011, CTL-012', notes: 'Additional hardening needed' },
            { controlId: 'A.5.24', name: 'Incident management planning', applicable: true, justification: 'Mandatory for response readiness', implementation: 'Implemented', evidence: 'CTL-009, IR Plan', notes: 'Tabletop exercise pending' },
            { controlId: 'A.5.29', name: 'Information security during disruption', applicable: true, justification: 'Business continuity', implementation: 'Partially Implemented', evidence: 'BCP Document', notes: 'DR testing overdue' },
            { controlId: 'A.5.30', name: 'ICT readiness for business continuity', applicable: true, justification: 'System recovery capability', implementation: 'Partially Implemented', evidence: 'CTL-003', notes: 'Restore testing needed' },
            { controlId: 'A.5.34', name: 'Privacy and protection of PII', applicable: true, justification: 'GDPR and CCPA compliance', implementation: 'Implemented', evidence: 'Privacy Policy, DPIAs', notes: 'DPO appointed' },
            { controlId: 'A.6.3', name: 'Information security awareness training', applicable: true, justification: 'Human firewall development', implementation: 'Implemented', evidence: 'CTL-008, Training records', notes: '100% completion rate' },
            { controlId: 'A.7.1', name: 'Physical security perimeters', applicable: false, justification: 'Cloud-only infrastructure, no physical data centers', implementation: 'Not Applicable', evidence: 'N/A', notes: 'AWS handles physical security' },
            { controlId: 'A.7.2', name: 'Physical entry', applicable: false, justification: 'Remote workforce, co-working spaces only', implementation: 'Not Applicable', evidence: 'N/A', notes: 'Office security managed by building' },
            { controlId: 'A.8.1', name: 'User endpoint devices', applicable: true, justification: 'BYOD and corporate devices', implementation: 'Implemented', evidence: 'MDM Policy, Jamf config', notes: 'Encryption enforced' },
            { controlId: 'A.8.7', name: 'Protection against malware', applicable: true, justification: 'Endpoint protection', implementation: 'Implemented', evidence: 'CrowdStrike deployment', notes: 'EDR active on all endpoints' },
            { controlId: 'A.8.8', name: 'Management of technical vulnerabilities', applicable: true, justification: 'Vulnerability management program', implementation: 'Implemented', evidence: 'CTL-004, Snyk scans', notes: 'Weekly scanning schedule' },
            { controlId: 'A.8.9', name: 'Configuration management', applicable: true, justification: 'System hardening', implementation: 'Partially Implemented', evidence: 'Terraform configs', notes: 'Baseline documentation in progress' },
            { controlId: 'A.8.12', name: 'Data leakage prevention', applicable: true, justification: 'Protect sensitive data', implementation: 'Not Implemented', evidence: 'N/A', notes: 'DLP disabled - performance issues (EXC-001)' },
            { controlId: 'A.8.15', name: 'Logging', applicable: true, justification: 'Audit trail and forensics', implementation: 'Implemented', evidence: 'CTL-002, CloudTrail', notes: '90-day retention' },
            { controlId: 'A.8.16', name: 'Monitoring activities', applicable: true, justification: 'Security monitoring', implementation: 'Implemented', evidence: 'SIEM dashboards', notes: '24/7 SOC monitoring' },
            { controlId: 'A.8.20', name: 'Networks security', applicable: true, justification: 'Network segmentation', implementation: 'Implemented', evidence: 'CTL-005, VPC configs', notes: 'Zero trust network' },
            { controlId: 'A.8.24', name: 'Use of cryptography', applicable: true, justification: 'Data encryption requirements', implementation: 'Implemented', evidence: 'CTL-007, KMS config', notes: 'AES-256 encryption' },
            { controlId: 'A.8.25', name: 'Secure development lifecycle', applicable: true, justification: 'Secure coding practices', implementation: 'Implemented', evidence: 'SDLC documentation', notes: 'Code review required' }
        ];
        
        // SoA ENTRIES - for toggling applicability in the SoA tab
        this.data.soaEntries = [
            { controlId: 'A.5.1', applicable: true, justification: 'Required for all organizations handling sensitive data. Our Information Security Policy establishes the foundation for our security program.' },
            { controlId: 'A.5.2', applicable: true, justification: 'Critical for accountability and clear ownership of security responsibilities across the organization.' },
            { controlId: 'A.5.3', applicable: true, justification: 'Essential to prevent fraud, errors, and unauthorized activities through proper separation of critical functions.' },
            { controlId: 'A.5.4', applicable: true, justification: 'Management commitment is fundamental to driving security culture and resource allocation.' },
            { controlId: 'A.5.5', applicable: true, justification: 'Regulatory contacts established for HIPAA (HHS), state AGs, and law enforcement.' },
            { controlId: 'A.5.6', applicable: true, justification: 'Active membership in ISACs and industry security working groups.' },
            { controlId: 'A.5.7', applicable: true, justification: 'Proactive threat intelligence essential for healthcare sector targeting.' },
            { controlId: 'A.5.8', applicable: true, justification: 'Security integrated into SDLC and project management processes.' },
            { controlId: 'A.5.9', applicable: true, justification: 'Comprehensive asset inventory required for risk management.' },
            { controlId: 'A.5.10', applicable: true, justification: 'Acceptable use policies define employee responsibilities.' },
            { controlId: 'A.5.11', applicable: true, justification: 'Asset return procedures ensure data protection on termination.' },
            { controlId: 'A.5.12', applicable: true, justification: 'Data classification drives protection measures for PHI and PII.' },
            { controlId: 'A.5.13', applicable: true, justification: 'Proper labeling enables consistent handling of classified information.' },
            { controlId: 'A.5.14', applicable: true, justification: 'Information transfer controls protect data in transit.' },
            { controlId: 'A.5.15', applicable: true, justification: 'Core security requirement - access control is fundamental to all operations.' },
            { controlId: 'A.5.16', applicable: true, justification: 'Identity management through Okta SSO for lifecycle management.' },
            { controlId: 'A.5.17', applicable: true, justification: 'Strong authentication with MFA enforced organization-wide.' },
            { controlId: 'A.5.18', applicable: true, justification: 'Role-based access controls implemented across all systems.' },
            { controlId: 'A.5.19', applicable: true, justification: 'Third-party security requirements in all vendor contracts.' },
            { controlId: 'A.5.20', applicable: true, justification: 'Vendor security obligations clearly defined and monitored.' },
            { controlId: 'A.5.21', applicable: true, justification: 'ICT supply chain risks assessed for all critical vendors.' },
            { controlId: 'A.5.22', applicable: true, justification: 'Ongoing vendor monitoring and performance assessment.' },
            { controlId: 'A.5.23', applicable: true, justification: 'AWS cloud infrastructure requires specific security controls.' },
            { controlId: 'A.5.24', applicable: true, justification: 'HIPAA requires formal incident response procedures.' },
            { controlId: 'A.5.25', applicable: true, justification: 'Security event assessment processes defined and tested.' },
            { controlId: 'A.5.26', applicable: true, justification: 'Incident response playbooks cover all major scenarios.' },
            { controlId: 'A.5.27', applicable: true, justification: 'Post-incident learning drives continuous improvement.' },
            { controlId: 'A.5.28', applicable: true, justification: 'Evidence collection procedures ensure forensic readiness.' },
            { controlId: 'A.5.29', applicable: true, justification: 'Business continuity planning essential for healthcare operations.' },
            { controlId: 'A.5.30', applicable: true, justification: 'ICT systems must support defined RTO/RPO requirements.' },
            { controlId: 'A.5.31', applicable: true, justification: 'Legal, regulatory, and contractual requirements tracked.' },
            { controlId: 'A.5.32', applicable: true, justification: 'Intellectual property protection for proprietary systems.' },
            { controlId: 'A.5.33', applicable: true, justification: 'Records management for compliance and audit purposes.' },
            { controlId: 'A.5.34', applicable: true, justification: 'GDPR and CCPA compliance for customer privacy.' },
            { controlId: 'A.5.35', applicable: true, justification: 'Regular security reviews and independent assessments.' },
            { controlId: 'A.5.36', applicable: true, justification: 'Compliance monitoring against policies and standards.' },
            { controlId: 'A.5.37', applicable: true, justification: 'Operating procedures documented and maintained.' },
            { controlId: 'A.6.1', applicable: true, justification: 'Background checks for all employees with data access.' },
            { controlId: 'A.6.2', applicable: true, justification: 'Security responsibilities in employment contracts.' },
            { controlId: 'A.6.3', applicable: true, justification: 'Annual security awareness training mandatory.' },
            { controlId: 'A.6.4', applicable: true, justification: 'Disciplinary process for security violations defined.' },
            { controlId: 'A.6.5', applicable: true, justification: 'Termination procedures protect against data theft.' },
            { controlId: 'A.6.6', applicable: true, justification: 'NDAs required for employees and contractors.' },
            { controlId: 'A.6.7', applicable: true, justification: 'Remote work security controls implemented.' },
            { controlId: 'A.6.8', applicable: true, justification: 'Security event reporting procedures established.' },
            { controlId: 'A.7.1', applicable: false, justification: 'Cloud-only infrastructure - AWS manages physical data center security under shared responsibility model.' },
            { controlId: 'A.7.2', applicable: false, justification: 'Remote-first company with no owned facilities requiring physical entry controls.' },
            { controlId: 'A.7.3', applicable: false, justification: 'No dedicated office space requiring physical security measures.' },
            { controlId: 'A.7.4', applicable: false, justification: 'Physical security monitoring handled by cloud providers and co-working facilities.' },
            { controlId: 'A.7.5', applicable: false, justification: 'Environmental protections managed by AWS data centers.' },
            { controlId: 'A.7.6', applicable: false, justification: 'No secure areas requiring specific working procedures.' },
            { controlId: 'A.7.7', applicable: true, justification: 'Clear desk policy enforced for remote workers handling sensitive data.' },
            { controlId: 'A.7.8', applicable: false, justification: 'Equipment siting managed by cloud infrastructure providers.' },
            { controlId: 'A.7.9', applicable: true, justification: 'Remote device security policies for off-premises equipment.' },
            { controlId: 'A.7.10', applicable: true, justification: 'Storage media handling and sanitization procedures defined.' },
            { controlId: 'A.7.11', applicable: false, justification: 'Utility support managed by cloud providers.' },
            { controlId: 'A.7.12', applicable: false, justification: 'Cabling security managed by cloud providers.' },
            { controlId: 'A.7.13', applicable: true, justification: 'Laptop and device maintenance procedures defined.' },
            { controlId: 'A.7.14', applicable: true, justification: 'Secure disposal procedures for decommissioned equipment.' },
            { controlId: 'A.8.1', applicable: true, justification: 'Endpoint security with MDM and encryption enforced.' },
            { controlId: 'A.8.2', applicable: true, justification: 'Privileged access management with PAM solution.' },
            { controlId: 'A.8.3', applicable: true, justification: 'Information access restrictions based on classification.' },
            { controlId: 'A.8.4', applicable: true, justification: 'Source code access limited to authorized developers.' },
            { controlId: 'A.8.5', applicable: true, justification: 'Strong authentication required for all systems.' },
            { controlId: 'A.8.6', applicable: true, justification: 'Capacity management for cloud resources.' },
            { controlId: 'A.8.7', applicable: true, justification: 'CrowdStrike EDR deployed on all endpoints.' },
            { controlId: 'A.8.8', applicable: true, justification: 'Vulnerability management with regular scanning.' },
            { controlId: 'A.8.9', applicable: true, justification: 'Configuration management with IaC templates.' },
            { controlId: 'A.8.10', applicable: true, justification: 'Secure data deletion per retention policies.' },
            { controlId: 'A.8.11', applicable: true, justification: 'Data masking for non-production environments.' },
            { controlId: 'A.8.12', applicable: true, justification: 'DLP controls for sensitive data protection.' },
            { controlId: 'A.8.13', applicable: true, justification: 'Backup procedures with tested restoration.' },
            { controlId: 'A.8.14', applicable: true, justification: 'System redundancy for critical infrastructure.' },
            { controlId: 'A.8.15', applicable: true, justification: 'Comprehensive logging with CloudTrail and SIEM.' },
            { controlId: 'A.8.16', applicable: true, justification: '24/7 security monitoring and alerting.' },
            { controlId: 'A.8.17', applicable: true, justification: 'NTP synchronization across all systems.' },
            { controlId: 'A.8.18', applicable: true, justification: 'Privileged utility programs restricted.' },
            { controlId: 'A.8.19', applicable: true, justification: 'Software installation controls enforced.' },
            { controlId: 'A.8.20', applicable: true, justification: 'Network security with VPC segmentation.' },
            { controlId: 'A.8.21', applicable: true, justification: 'Network services security requirements defined.' },
            { controlId: 'A.8.22', applicable: true, justification: 'Network segmentation isolates sensitive zones.' },
            { controlId: 'A.8.23', applicable: true, justification: 'Web filtering for corporate endpoints.' },
            { controlId: 'A.8.24', applicable: true, justification: 'AES-256 encryption for data at rest and in transit.' },
            { controlId: 'A.8.25', applicable: true, justification: 'Security integrated throughout SDLC.' },
            { controlId: 'A.8.26', applicable: true, justification: 'Security requirements in application design.' },
            { controlId: 'A.8.27', applicable: true, justification: 'Secure architecture principles followed.' },
            { controlId: 'A.8.28', applicable: true, justification: 'Secure coding standards and training.' },
            { controlId: 'A.8.29', applicable: true, justification: 'Security testing in CI/CD pipeline.' },
            { controlId: 'A.8.30', applicable: true, justification: 'Third-party development security requirements.' },
            { controlId: 'A.8.31', applicable: true, justification: 'Separate dev/test/prod environments.' },
            { controlId: 'A.8.32', applicable: true, justification: 'Change management procedures enforced.' },
            { controlId: 'A.8.33', applicable: true, justification: 'Test data protection with anonymization.' },
            { controlId: 'A.8.34', applicable: true, justification: 'Audit system protection measures in place.' }
        ];

        // BIA ENTRIES (5)
        this.data.biaEntries = [
            { id: 'BIA-001', processName: 'Payment Processing', owner: 'Finance', criticality: 'Critical', rto: '1', rpo: '0.5', mtpd: '4', dependencies: 'Stripe, AWS, Customer Portal', impact: 'Revenue loss of $50K/hour, customer churn, regulatory notification', assetId: 'AST-001', createdAt: daysAgo(30) },
            { id: 'BIA-002', processName: 'Patient Data Access', owner: 'Clinical Ops', criticality: 'Critical', rto: '2', rpo: '1', mtpd: '8', dependencies: 'Patient Database, AWS, Okta', impact: 'Patient safety risk, HIPAA violation, litigation exposure', assetId: 'AST-002', createdAt: daysAgo(28) },
            { id: 'BIA-003', processName: 'API Gateway Services', owner: 'Platform', criticality: 'High', rto: '4', rpo: '2', mtpd: '12', dependencies: 'AWS, Kong, CI/CD Pipeline', impact: 'All downstream services impacted, partner SLA breach', assetId: 'AST-005', createdAt: daysAgo(25) },
            { id: 'BIA-004', processName: 'Employee Authentication', owner: 'IT Security', criticality: 'High', rto: '2', rpo: '4', mtpd: '8', dependencies: 'Okta, Corporate VPN, Active Directory', impact: 'Workforce lockout, productivity loss across all departments', assetId: 'AST-006', createdAt: daysAgo(20) },
            { id: 'BIA-005', processName: 'Business Intelligence Reporting', owner: 'Analytics', criticality: 'Medium', rto: '24', rpo: '12', mtpd: '72', dependencies: 'Snowflake, Data Warehouse, Salesforce', impact: 'Management decision delays, missed reporting deadlines', assetId: 'AST-007', createdAt: daysAgo(15) }
        ];

        // VENDOR RISK ASSESSMENTS (5)
        this.data.vendorAssessments = [
            { id: 'VRA-001', vendorId: 'VND-001', securityScore: 23, complianceScore: 24, financialScore: 22, operationalScore: 21, overallScore: 90, riskRating: 'Low', assessmentDate: daysAgo(30), findings: 'Strong security posture. SOC 2 Type II current. Minor: improve key rotation docs.', nextReview: daysFromNow(150), createdAt: daysAgo(30) },
            { id: 'VRA-002', vendorId: 'VND-002', securityScore: 22, complianceScore: 25, financialScore: 20, operationalScore: 19, overallScore: 86, riskRating: 'Low', assessmentDate: daysAgo(25), findings: 'PCI DSS Level 1 certified. Excellent compliance controls.', nextReview: daysFromNow(60), createdAt: daysAgo(25) },
            { id: 'VRA-003', vendorId: 'VND-003', securityScore: 21, complianceScore: 22, financialScore: 18, operationalScore: 20, overallScore: 81, riskRating: 'Medium', assessmentDate: daysAgo(20), findings: 'SSO provider - critical dependency. Recent breach history noted. Enhanced monitoring recommended.', nextReview: daysFromNow(90), createdAt: daysAgo(20) },
            { id: 'VRA-004', vendorId: 'VND-004', securityScore: 18, complianceScore: 15, financialScore: 20, operationalScore: 17, overallScore: 70, riskRating: 'Medium', assessmentDate: daysAgo(14), findings: 'Processes PHI without BAA. Compliance gap identified. BAA execution in progress.', nextReview: daysFromNow(30), createdAt: daysAgo(14) },
            { id: 'VRA-005', vendorId: 'VND-005', securityScore: 14, complianceScore: 12, financialScore: 18, operationalScore: 15, overallScore: 59, riskRating: 'High', assessmentDate: daysAgo(7), findings: 'Limited security certifications. No SOC 2 report. Email contains PII. Review contract terms.', nextReview: daysFromNow(45), createdAt: daysAgo(7) }
        ];

        // ACTIVITY LOG (10) - sample work trail
        // SOX ENTRIES (6 demo)
        this.data.soxEntries = [
            { id: 'SOX-001', cosoComponent: 'Control Environment', ref: 'SOX-CE-01', name: 'Tone at the Top', desc: 'Board demonstrates commitment to integrity.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Effective', walkthroughDate: daysAgo(45).split('T')[0], notes: 'Reviewed board minutes and code of conduct.', createdAt: daysAgo(60) },
            { id: 'SOX-002', cosoComponent: 'Risk Assessment', ref: 'SOX-RA-01', name: 'Financial Reporting Risk Identification', desc: 'Risks to reliable financial reporting are identified.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Effective', walkthroughDate: daysAgo(30).split('T')[0], notes: '', createdAt: daysAgo(55) },
            { id: 'SOX-003', cosoComponent: 'Control Activities', ref: 'SOX-CA-01', name: 'Journal Entry Review', desc: 'Manual journal entries require documented approval.', controlType: 'Preventive', assertion: 'Completeness', effectiveness: 'Effective', walkthroughDate: daysAgo(20).split('T')[0], notes: 'Sampled 25 entries, all properly approved.', createdAt: daysAgo(50) },
            { id: 'SOX-004', cosoComponent: 'Control Activities', ref: 'SOX-CA-02', name: 'Account Reconciliation', desc: 'Key accounts reconciled monthly.', controlType: 'Detective', assertion: 'Valuation', effectiveness: 'Deficient', walkthroughDate: daysAgo(15).split('T')[0], notes: 'Two months missing sign-off for accounts receivable.', createdAt: daysAgo(45) },
            { id: 'SOX-005', cosoComponent: 'Info & Communication', ref: 'SOX-IC-02', name: 'Whistleblower Mechanism', desc: 'Anonymous reporting channel for irregularities.', controlType: 'Detective', assertion: 'All', effectiveness: 'Effective', walkthroughDate: '', notes: 'Hotline operational, tested annually.', createdAt: daysAgo(40) },
            { id: 'SOX-006', cosoComponent: 'Monitoring', ref: 'SOX-MO-01', name: 'Ongoing ICFR Monitoring', desc: 'Management evaluates ICFR effectiveness.', controlType: 'Detective', assertion: 'All', effectiveness: 'Not Tested', walkthroughDate: '', notes: 'Scheduled for Q2 walkthrough.', createdAt: daysAgo(35) }
        ];

        // RISK APPETITE STATEMENTS (5 demo)
        this.data.riskAppetiteStatements = [
            { id: 'RA-001', category: 'Cybersecurity', appetiteLevel: 'Averse', toleranceMax: 6, statement: 'The organization has zero tolerance for cyber breaches impacting customer data. All critical systems must maintain residual risk scores at or below 6.', boardApproved: true, reviewDate: daysFromNow(90), createdAt: daysAgo(90) },
            { id: 'RA-002', category: 'Compliance/Regulatory', appetiteLevel: 'Averse', toleranceMax: 4, statement: 'Zero appetite for regulatory non-compliance. All regulatory requirements must be fully met.', boardApproved: true, reviewDate: daysFromNow(90), createdAt: daysAgo(90) },
            { id: 'RA-003', category: 'Operational', appetiteLevel: 'Cautious', toleranceMax: 12, statement: 'Moderate operational disruptions are tolerable if recovery occurs within defined RTO.', boardApproved: true, reviewDate: daysFromNow(60), createdAt: daysAgo(85) },
            { id: 'RA-004', category: 'Reputational', appetiteLevel: 'Cautious', toleranceMax: 8, statement: 'The organization will not pursue initiatives that could significantly damage public trust.', boardApproved: true, reviewDate: daysFromNow(120), createdAt: daysAgo(80) },
            { id: 'RA-005', category: 'Third-Party', appetiteLevel: 'Moderate', toleranceMax: 12, statement: 'Third-party risk accepted where vendors meet minimum security and compliance standards.', boardApproved: false, reviewDate: '', createdAt: daysAgo(60) }
        ];

        // KRI ENTRIES (6 demo)
        this.data.kriEntries = [
            { id: 'KRI-001', name: 'Mean Time to Patch Critical Vulns', category: 'Cybersecurity', indicatorType: 'Leading', currentValue: 12, unit: 'days', amberThreshold: 14, redThreshold: 30, trend: 'stable', owner: 'CISO', createdAt: daysAgo(60) },
            { id: 'KRI-002', name: 'Phishing Click Rate', category: 'Cybersecurity', indicatorType: 'Leading', currentValue: 8, unit: '%', amberThreshold: 10, redThreshold: 20, trend: 'decreasing', owner: 'Security Awareness', createdAt: daysAgo(55) },
            { id: 'KRI-003', name: 'Overdue Audit Findings', category: 'Compliance', indicatorType: 'Lagging', currentValue: 3, unit: 'count', amberThreshold: 5, redThreshold: 10, trend: 'stable', owner: 'Compliance Manager', createdAt: daysAgo(50) },
            { id: 'KRI-004', name: 'Vendor SLA Breaches (Quarterly)', category: 'Third-Party', indicatorType: 'Lagging', currentValue: 2, unit: 'count', amberThreshold: 3, redThreshold: 7, trend: 'increasing', owner: 'Vendor Manager', createdAt: daysAgo(45) },
            { id: 'KRI-005', name: 'System Availability', category: 'Operational', indicatorType: 'Lagging', currentValue: 99.7, unit: '%', amberThreshold: 99.5, redThreshold: 99, trend: 'stable', owner: 'IT Operations', createdAt: daysAgo(40) },
            { id: 'KRI-006', name: 'Regulatory Change Backlog', category: 'Compliance', indicatorType: 'Leading', currentValue: 5, unit: 'count', amberThreshold: 8, redThreshold: 15, trend: 'stable', owner: 'Compliance Manager', createdAt: daysAgo(30) }
        ];

        // BCM PLANS (3 demo)
        this.data.bcmPlans = [
            { id: 'BCM-001', planName: 'Payment Processing DR Plan', planType: 'DRP', status: 'Approved', biaId: 'BIA-001', recoveryStrategy: 'Failover to secondary AWS region (us-west-2) within 1 hour. Payment queue buffered in SQS with replay on recovery.', owner: 'Platform Lead', contact: 'On-call rotation', lastTestDate: daysAgo(45).split('T')[0], nextTestDate: daysFromNow(45).split('T')[0], createdAt: daysAgo(60) },
            { id: 'BCM-002', planName: 'Clinical Data Continuity Plan', planType: 'BCP', status: 'Approved', biaId: 'BIA-002', recoveryStrategy: 'Read-only access via DR replica within 2 hours. Paper-based fallback procedures for critical patient operations.', owner: 'Clinical IT Director', contact: 'Clinical Ops hotline', lastTestDate: daysAgo(90).split('T')[0], nextTestDate: daysFromNow(30).split('T')[0], createdAt: daysAgo(90) },
            { id: 'BCM-003', planName: 'Enterprise Crisis Communication Plan', planType: 'Crisis Communication', status: 'Draft', biaId: '', recoveryStrategy: 'Notification chain: CISO > CEO > Board > Customers within 72 hours per breach notification requirements.', owner: 'VP Communications', contact: 'Crisis line', lastTestDate: '', nextTestDate: daysFromNow(60).split('T')[0], createdAt: daysAgo(30) }
        ];

        // CROSSWALK MAPPINGS (4 demo - linked to existing controls)
        this.data.crosswalkMappings = [
            { id: 'CW-001', controlId: 'CTL-001', controlName: 'Multi-Factor Authentication', frameworks: ['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA'], references: 'A.8.5, PR.AC-7, CC6.1, 8.3.1, 164.312(d)', rationale: 'MFA satisfies authentication requirements across all 5 frameworks.', createdAt: daysAgo(30) },
            { id: 'CW-002', controlId: 'CTL-002', controlName: 'SIEM Monitoring', frameworks: ['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS'], references: 'A.8.15, DE.CM-1, CC7.2, 10.6', rationale: 'Centralized logging and monitoring satisfies detection requirements.', createdAt: daysAgo(28) },
            { id: 'CW-003', controlId: 'CTL-003', controlName: 'Encrypted Backups', frameworks: ['ISO 27001', 'NIST CSF', 'HIPAA', 'SOC 2'], references: 'A.8.13, PR.DS-1, 164.312(a)(2)(iv), CC6.7', rationale: 'Encrypted backup controls map to data protection and recovery requirements.', createdAt: daysAgo(25) },
            { id: 'CW-004', controlId: 'CTL-004', controlName: 'Access Reviews (Quarterly)', frameworks: ['ISO 27001', 'NIST CSF', 'SOC 2', 'HIPAA', 'GDPR', 'CIS Controls'], references: 'A.5.18, PR.AC-1, CC6.3, 164.312(a)(1), Art.25, 5.3', rationale: 'Periodic access reviews satisfy identity governance across 6 frameworks.', createdAt: daysAgo(20) }
        ];

        this.data.activityLog = [
            { id: 'LOG-001', ts: daysAgo(7), type: 'demo', message: 'Loaded demo dataset', meta: {}, project: null },
            { id: 'LOG-002', ts: daysAgo(6), type: 'controls', message: 'Created control CTL-002 (SIEM monitoring)', meta: { id: 'CTL-002' }, project: null },
            { id: 'LOG-003', ts: daysAgo(5), type: 'evidence', message: 'Added evidence EVD-002 (SIEM rules export)', meta: { id: 'EVD-002' }, project: null },
            { id: 'LOG-004', ts: daysAgo(5), type: 'testing', message: 'Recorded test TST-003 for CTL-003 (Partial)', meta: { id: 'TST-003' }, project: null },
            { id: 'LOG-005', ts: daysAgo(4), type: 'findings', message: 'Created finding FND-001 (restore testing missing)', meta: { id: 'FND-001' }, project: null },
            { id: 'LOG-006', ts: daysAgo(3), type: 'requirements', message: 'Created requirement A.5.15 and mapped to access controls', meta: { id: 'REQ-001' }, project: null },
            { id: 'LOG-007', ts: daysAgo(2), type: 'exceptions', message: 'Drafted exception EX-2026-002 for restore test delay', meta: { id: 'EXC-002' }, project: null },
            { id: 'LOG-008', ts: daysAgo(2), type: 'policies', message: 'Set Incident Response Policy to Review', meta: { id: 'POL-004' }, project: null },
            { id: 'LOG-009', ts: daysAgo(1), type: 'tasks', message: 'Created task TSK-002 to execute restore test', meta: { id: 'TSK-002' }, project: null },
            { id: 'LOG-010', ts: daysAgo(1), type: 'demo', message: 'Demo ready: explore Requirements, Exceptions, and Due & Activity', meta: {}, project: null }
        ];
        Object.keys(this.data).forEach(k => this.saveData(k));
        this.renderCurrentTab();
        this.updateAllBadges();
        this.toast('🎉 Complete demo data loaded! Explore all tabs.', 'success');
    }
    
    // ==================== FRAMEWORK LIBRARY (480+ Controls) ====================
    renderFrameworks() {
        const c = document.getElementById('tab-frameworks');
        const frameworks = this.getFrameworkControls();
        const selectedFw = this.fwFilter || 'all';
        const selectedCat = this.catFilter || 'all';
        
        c.innerHTML = `
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-journal-code"></i> Framework Control Library</h2>
                <p style="font-size: 13px; color: var(--text-secondary);">480+ security and AI controls from 10 major compliance frameworks. Use these as reference when implementing your own controls.</p>
            </div>
            
            <!-- Filters Section -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Framework</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                <button class="btn btn-sm ${selectedFw === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('all')">All</button>
                                <button class="btn btn-sm ${selectedFw === 'ISO 27001' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('ISO 27001')">ISO 27001</button>
                                <button class="btn btn-sm ${selectedFw === 'NIST CSF' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('NIST CSF')">NIST CSF</button>
                                <button class="btn btn-sm ${selectedFw === 'SOC 2' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('SOC 2')">SOC 2</button>
                                <button class="btn btn-sm ${selectedFw === 'PCI DSS' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('PCI DSS')">PCI DSS</button>
                                <button class="btn btn-sm ${selectedFw === 'HIPAA' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('HIPAA')">HIPAA</button>
                                <button class="btn btn-sm ${selectedFw === 'GDPR' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('GDPR')">GDPR</button>
                                <button class="btn btn-sm ${selectedFw === 'CIS Controls' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('CIS Controls')">CIS</button>
                                <button class="btn btn-sm ${selectedFw === 'CMMC' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('CMMC')">CMMC</button>
                                <button class="btn btn-sm ${selectedFw === 'COBIT' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('COBIT')">COBIT</button>
                                <button class="btn btn-sm ${selectedFw === 'ISO 42001' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('ISO 42001')">ISO 42001</button>
                            </div>
                        </div>
                        <div style="margin-left: auto;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Search</label>
                            <input type="text" class="form-input" id="fw-search" placeholder="Search controls..." oninput="app.filterFrameworks()" style="width: 220px; padding: 8px 12px; font-size: 13px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                        <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Category</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            <button class="btn btn-sm ${selectedCat === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('all')">All Categories</button>
                            <button class="btn btn-sm ${selectedCat === 'Access Control' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Access Control')">Access Control</button>
                            <button class="btn btn-sm ${selectedCat === 'Asset Management' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Asset Management')">Asset Management</button>
                            <button class="btn btn-sm ${selectedCat === 'Data Protection' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Data Protection')">Data Protection</button>
                            <button class="btn btn-sm ${selectedCat === 'Network Security' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Network Security')">Network Security</button>
                            <button class="btn btn-sm ${selectedCat === 'Incident Management' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Incident Management')">Incident Mgmt</button>
                            <button class="btn btn-sm ${selectedCat === 'Risk Management' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Risk Management')">Risk Management</button>
                            <button class="btn btn-sm ${selectedCat === 'Compliance' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Compliance')">Compliance</button>
                            <button class="btn btn-sm ${selectedCat === 'Logging & Monitoring' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Logging & Monitoring')">Logging</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Controls</div>
                    <span class="badge badge-blue" id="fw-count">0 controls</span>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead style="position: sticky; top: 0; background: var(--bg-surface); z-index: 10;">
                            <tr>
                                <th style="width: 120px;">Control ID</th>
                                <th>Name</th>
                                <th style="width: 140px;">Category</th>
                                <th style="width: 150px;">Framework</th>
                                <th>Description</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="fw-table-body"></tbody>
                    </table>
                </div>
            </div>`;
        setTimeout(() => this.filterFrameworks(), 0);
    }
    
    setFwFilter(fw) {
        this.fwFilter = fw;
        this.renderFrameworks();
    }
    
    setCatFilter(cat) {
        this.catFilter = cat;
        this.renderFrameworks();
    }
    
    filterFrameworks() {
        const fw = this.fwFilter || 'all';
        const cat = this.catFilter || 'all';
        const search = (document.getElementById('fw-search')?.value || '').toLowerCase();
        let controls = this.getFrameworkControls();
        if (fw !== 'all') controls = controls.filter(c => c.frameworks.includes(fw));
        if (cat !== 'all') controls = controls.filter(c => c.category === cat);
        if (search) controls = controls.filter(c => c.name.toLowerCase().includes(search) || c.description.toLowerCase().includes(search) || c.id.toLowerCase().includes(search));
        
        const countEl = document.getElementById('fw-count');
        if (countEl) countEl.textContent = `${controls.length} controls`;
        
        const tbody = document.getElementById('fw-table-body');
        if (!tbody) return;
        if (controls.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="bi bi-search" style="font-size: 32px; display: block; margin-bottom: 8px; opacity: 0.3;"></i>No matching controls found</td></tr>';
        } else {
            tbody.innerHTML = controls.slice(0, 100).map(c => `
                <tr>
                    <td><code style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${this.esc(c.id)}</code></td>
                    <td style="font-weight: 500;">${this.esc(c.name)}</td>
                    <td><span class="badge badge-gray" style="font-size: 10px;">${this.esc(c.category)}</span></td>
                    <td>${c.frameworks.map(f => `<span class="badge badge-${this.getFrameworkColor(f)}" style="font-size: 10px;">${f}</span>`).join(' ')}</td>
                    <td style="max-width: 280px; font-size: 12px; color: var(--text-muted);">${this.esc(c.description.substring(0, 100))}${c.description.length > 100 ? '...' : ''}</td>
                    <td><button class="btn btn-sm btn-secondary" onclick="app.adoptControl('${c.id}')"><i class="bi bi-plus"></i> Add</button></td>
                </tr>`).join('');
            if (controls.length > 100) {
                tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Showing 100 of ${controls.length} controls. Refine your search to see more.</td></tr>`;
            }
        }
    }
    
    adoptControl(ctrlId) {
        const fwCtrl = this.getFrameworkControls().find(c => c.id === ctrlId);
        if (!fwCtrl) return;
        const newCtrl = {
            id: this.generateId('CTL'),
            name: fwCtrl.name,
            type: 'Preventive',
            status: 'Planned',
            owner: 'TBD',
            effectiveness: 'Not Tested',
            frameworks: fwCtrl.frameworks,
            description: fwCtrl.description,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        this.getActiveData().controls.push(newCtrl);
        this.saveData('controls');
        this.toast(`Control "${fwCtrl.name}" adopted to your Control Catalog`, 'success');
    }
    
    getFrameworkColor(fw) {
        const colors = { 'ISO 27001': 'blue', 'ISO 42001': 'purple', 'NIST CSF': 'purple', 'PCI DSS': 'amber', 'HIPAA': 'pink', 'SOC 2': 'green', 'CIS Controls': 'cyan', 'GDPR': 'red', 'CMMC': 'amber', 'COBIT': 'purple' };
        return colors[fw] || 'blue';
    }
    
    getFrameworkControls() {
        return [
            // ISO 27001:2022 (93 controls)
            {id:"ISO-5.1",name:"Security policies",category:"Policy & Governance",description:"Define, approve, communicate, and periodically review this policy to guide information security.",frameworks:["ISO 27001"]},
            {id:"ISO-5.2",name:"Info security roles",category:"Policy & Governance",description:"Implement and maintain measures for info security roles to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.3",name:"Segregation of duties",category:"Policy & Governance",description:"Implement and maintain measures for segregation of duties to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.4",name:"Management responsibilities",category:"Policy & Governance",description:"Implement and maintain measures for management responsibilities to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.5",name:"Authority contacts",category:"Compliance",description:"Implement and maintain measures for authority contacts to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.6",name:"Special interest contacts",category:"Compliance",description:"Implement and maintain measures for special interest contacts to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.7",name:"Threat intel",category:"Risk Management",description:"Implement and maintain measures for threat intel to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.8",name:"Project security",category:"Policy & Governance",description:"Implement and maintain measures for project security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.9",name:"Asset inventory",category:"Asset Management",description:"Maintain an accurate, up-to-date inventory including ownership, classification, and lifecycle status.",frameworks:["ISO 27001"]},
            {id:"ISO-5.10",name:"Acceptable use",category:"Asset Management",description:"Implement and maintain measures for acceptable use to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.11",name:"Asset return",category:"Asset Management",description:"Implement and maintain measures for asset return to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.12",name:"Information classification",category:"Data Protection",description:"Implement and maintain measures for information classification to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.13",name:"Information labeling",category:"Data Protection",description:"Implement and maintain measures for information labeling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.14",name:"Information transfer",category:"Data Protection",description:"Implement and maintain measures for information transfer to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.15",name:"Access control rules",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-5.16",name:"Identity lifecycle",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-5.17",name:"Authentication info handling",category:"Access Control",description:"Implement and maintain measures for authentication info handling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.18",name:"Access rights",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-5.19",name:"Supplier security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.20",name:"Supplier security requirements",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.21",name:"Supplier agreements security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.22",name:"Supplier service monitoring",category:"Vendor Management",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-5.23",name:"Cloud services security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.24",name:"Incident planning & readiness",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
            {id:"ISO-5.25",name:"Incident assessment & decision",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
            {id:"ISO-5.26",name:"Incident response & communication",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
            {id:"ISO-5.27",name:"Lessons learned",category:"Incident Management",description:"Implement and maintain measures for lessons learned to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.28",name:"Evidence handling",category:"Incident Management",description:"Implement and maintain measures for evidence handling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.29",name:"Security during disruption",category:"Business Continuity",description:"Implement and maintain measures for security during disruption to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.30",name:"ICT continuity readiness",category:"Business Continuity",description:"Plan, implement, and test continuity arrangements to meet recovery objectives during disruption.",frameworks:["ISO 27001"]},
            {id:"ISO-5.31",name:"Legal/regulatory/contract",category:"Compliance",description:"Implement and maintain measures for legal/regulatory/contract to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.32",name:"Intellectual property",category:"Compliance",description:"Implement and maintain measures for intellectual property to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.33",name:"Records protection",category:"Compliance",description:"Implement and maintain measures for records protection to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.34",name:"Privacy & personal data",category:"Data Protection",description:"Identify privacy/PII requirements and implement measures to protect personal data appropriately.",frameworks:["ISO 27001"]},
            {id:"ISO-5.35",name:"Independent security review",category:"Compliance",description:"Implement and maintain measures for independent security review to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.36",name:"Compliance with policies/standards",category:"Compliance",description:"Define, approve, communicate, and periodically review this policy to guide information security.",frameworks:["ISO 27001"]},
            {id:"ISO-5.37",name:"Documented operating procedures",category:"Policy & Governance",description:"Implement and maintain measures for documented operating procedures to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.1",name:"Screening checks",category:"Policy & Governance",description:"Implement and maintain measures for screening checks to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.2",name:"Terms & conditions",category:"Policy & Governance",description:"Implement and maintain measures for terms & conditions to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.3",name:"Awareness and training",category:"Policy & Governance",description:"Provide role-based awareness and training to ensure personnel understand responsibilities and threats.",frameworks:["ISO 27001"]},
            {id:"ISO-6.4",name:"Disciplinary process",category:"Policy & Governance",description:"Implement and maintain measures for disciplinary process to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.5",name:"Responsibilities after termination",category:"Policy & Governance",description:"Control changes through authorization, testing, documentation, and rollback where appropriate.",frameworks:["ISO 27001"]},
            {id:"ISO-6.6",name:"Confidentiality/NDA",category:"Policy & Governance",description:"Implement and maintain measures for confidentiality/nda to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.7",name:"Remote working security",category:"Access Control",description:"Implement and maintain measures for remote working security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.8",name:"Event reporting",category:"Incident Management",description:"Implement and maintain measures for event reporting to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-7.1",name:"Physical security perimeters",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.2",name:"Physical entry controls",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.3",name:"Securing offices/rooms",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.4",name:"Physical monitoring",category:"Physical Security",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-7.5",name:"Protection against threats",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.6",name:"Working in secure areas",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.7",name:"Clear desk / clear screen",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.8",name:"Equipment siting & protection",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.9",name:"Off-premises asset security",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.10",name:"Storage media",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.11",name:"Supporting utilities",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.12",name:"Cabling security",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.13",name:"Equipment maintenance",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.14",name:"Secure disposal / reuse",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-8.1",name:"Endpoint devices",category:"Asset Management",description:"Implement and maintain measures for endpoint devices to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.2",name:"Privileged access",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.3",name:"Information access restrictions",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.4",name:"Source code access",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.5",name:"Secure authentication",category:"Access Control",description:"Implement and maintain measures for secure authentication to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.6",name:"Capacity management",category:"Business Continuity",description:"Implement and maintain measures for capacity management to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.7",name:"Malware protection",category:"Network Security",description:"Deploy preventive and detective measures to reduce malware infection and impact.",frameworks:["ISO 27001"]},
            {id:"ISO-8.8",name:"Vulnerability management",category:"Risk Management",description:"Identify, assess, prioritize, and remediate technical vulnerabilities within defined timelines.",frameworks:["ISO 27001"]},
            {id:"ISO-8.9",name:"Configuration management",category:"Asset Management",description:"Define secure configuration baselines and manage changes to reduce unintended exposure and drift.",frameworks:["ISO 27001"]},
            {id:"ISO-8.10",name:"Information deletion",category:"Data Protection",description:"Ensure information and media are securely deleted/disposed to prevent unauthorized recovery.",frameworks:["ISO 27001"]},
            {id:"ISO-8.11",name:"Data masking",category:"Data Protection",description:"Implement and maintain measures for data masking to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.12",name:"Data leakage prevention",category:"Data Protection",description:"Implement and maintain measures for data leakage prevention to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.13",name:"Backups",category:"Business Continuity",description:"Perform backups at defined intervals, protect backup media, and regularly test restoration.",frameworks:["ISO 27001"]},
            {id:"ISO-8.14",name:"Redundancy",category:"Business Continuity",description:"Implement and maintain measures for redundancy to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.15",name:"Logging",category:"Logging & Monitoring",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-8.16",name:"Monitoring",category:"Logging & Monitoring",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-8.17",name:"Clock synchronization",category:"Logging & Monitoring",description:"Implement and maintain measures for clock synchronization to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.18",name:"Admin utilities",category:"Access Control",description:"Implement and maintain measures for admin utilities to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.19",name:"Software installation controls",category:"Asset Management",description:"Implement and maintain measures for software installation controls to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.20",name:"Network security",category:"Network Security",description:"Implement and maintain measures for network security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.21",name:"Network services security",category:"Network Security",description:"Implement and maintain measures for network services security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.22",name:"Network segmentation",category:"Network Security",description:"Implement and maintain measures for network segmentation to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.23",name:"Web filtering",category:"Network Security",description:"Implement and maintain measures for web filtering to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.24",name:"Cryptography use",category:"Data Protection",description:"Use cryptography appropriately and manage keys securely throughout their lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.25",name:"Secure development lifecycle",category:"Asset Management",description:"Integrate security into the SDLC, including requirements, design, coding, testing, and release controls.",frameworks:["ISO 27001"]},
            {id:"ISO-8.26",name:"Application security requirements",category:"Asset Management",description:"Implement and maintain measures for application security requirements to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.27",name:"Secure system architecture",category:"Asset Management",description:"Implement and maintain measures for secure system architecture to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.28",name:"Secure coding",category:"Asset Management",description:"Implement and maintain measures for secure coding to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.29",name:"Security testing in development",category:"Asset Management",description:"Implement and maintain measures for security testing in development to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.30",name:"Outsourced development",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-8.31",name:"Separation of environments",category:"Asset Management",description:"Implement and maintain measures for separation of dev/test/prod to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.32",name:"Change management",category:"Asset Management",description:"Control changes through authorization, testing, documentation, and rollback where appropriate.",frameworks:["ISO 27001"]},
            {id:"ISO-8.33",name:"Test data protection",category:"Data Protection",description:"Implement and maintain measures for test data protection to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.34",name:"Audit system protection",category:"Compliance",description:"Implement and maintain measures for protection of info systems during audits to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            // NIST CSF 2.0 (20 key controls)
            {id:"NIST-ID.AM-01",name:"Physical devices inventory",category:"Asset Management",description:"Inventories of physical devices maintained.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-02",name:"Software inventory",category:"Asset Management",description:"Inventories of software platforms maintained.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-01",name:"Cybersecurity policy",category:"Policy & Governance",description:"Organizational cybersecurity policy established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-01",name:"Asset vulnerabilities",category:"Risk Management",description:"Asset vulnerabilities identified and documented.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-02",name:"Cyber threat intelligence",category:"Risk Management",description:"Cyber threat intelligence received from sharing forums.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RM-01",name:"Risk management processes",category:"Risk Management",description:"Risk management processes established and managed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-01",name:"Supply chain risk management",category:"Vendor Management",description:"Cyber supply chain risk processes established.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-01",name:"Identity management",category:"Access Control",description:"Identities and credentials managed for authorized access.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-01",name:"Security awareness",category:"Policy & Governance",description:"All users informed and trained on cybersecurity responsibilities.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-01",name:"Data-at-rest protection",category:"Data Protection",description:"Data-at-rest is protected.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-02",name:"Data-in-transit protection",category:"Data Protection",description:"Data-in-transit is protected.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-01",name:"Baseline configuration",category:"Asset Management",description:"Baseline configuration of IT systems created and maintained.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-04",name:"Backups maintained",category:"Business Continuity",description:"Backups of information conducted and tested.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.PT-01",name:"Audit records",category:"Logging & Monitoring",description:"Audit/log records determined and reviewed.",frameworks:["NIST CSF"]},
            {id:"NIST-DE.CM-01",name:"Network monitoring",category:"Logging & Monitoring",description:"Network monitored to detect cybersecurity events.",frameworks:["NIST CSF"]},
            {id:"NIST-DE.CM-04",name:"Malicious code detection",category:"Network Security",description:"Malicious code is detected.",frameworks:["NIST CSF"]},
            {id:"NIST-RS.RP-01",name:"Response plan execution",category:"Incident Management",description:"Response plan executed during incidents.",frameworks:["NIST CSF"]},
            {id:"NIST-RS.MI-01",name:"Incident containment",category:"Incident Management",description:"Incidents are contained.",frameworks:["NIST CSF"]},
            {id:"NIST-RC.RP-01",name:"Recovery plan execution",category:"Business Continuity",description:"Recovery plan executed after incidents.",frameworks:["NIST CSF"]},
            {id:"NIST-RC.IM-01",name:"Recovery improvements",category:"Business Continuity",description:"Recovery plans incorporate lessons learned.",frameworks:["NIST CSF"]},
            // PCI DSS v4.0 (20 key controls)
            {id:"PCI-1.1.1",name:"Firewall standards",category:"Network Security",description:"Formal standards for firewall and router configurations.",frameworks:["PCI DSS"]},
            {id:"PCI-1.2.1",name:"Configuration standards",category:"Network Security",description:"Configuration standards for network security controls.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.1",name:"System configuration standards",category:"Asset Management",description:"Configuration standards for all system components.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.2",name:"Vendor defaults management",category:"Access Control",description:"Vendor default accounts managed before deployment.",frameworks:["PCI DSS"]},
            {id:"PCI-3.2.1",name:"Account data minimization",category:"Data Protection",description:"Account data storage kept to minimum.",frameworks:["PCI DSS"]},
            {id:"PCI-3.3.1",name:"PAN masking",category:"Data Protection",description:"PAN masked when displayed.",frameworks:["PCI DSS"]},
            {id:"PCI-3.4.1",name:"Cryptographic keys storage",category:"Data Protection",description:"Cryptographic keys stored securely.",frameworks:["PCI DSS"]},
            {id:"PCI-4.2.1",name:"Strong cryptography",category:"Data Protection",description:"Strong cryptography for PAN transmission.",frameworks:["PCI DSS"]},
            {id:"PCI-5.2.1",name:"Anti-malware deployed",category:"Network Security",description:"Anti-malware mechanisms deployed.",frameworks:["PCI DSS"]},
            {id:"PCI-5.2.2",name:"Phishing protection",category:"Network Security",description:"Technical mechanisms protect against phishing.",frameworks:["PCI DSS"]},
            {id:"PCI-6.3.1",name:"System component inventory",category:"Asset Management",description:"Inventory of in-scope system components maintained.",frameworks:["PCI DSS"]},
            {id:"PCI-6.4.1",name:"Public-facing applications",category:"Asset Management",description:"Public-facing web applications protected.",frameworks:["PCI DSS"]},
            {id:"PCI-7.2.1",name:"User access management",category:"Access Control",description:"User access to system components managed.",frameworks:["PCI DSS"]},
            {id:"PCI-8.2.1",name:"Unique user IDs",category:"Access Control",description:"Unique user IDs assigned to each user.",frameworks:["PCI DSS"]},
            {id:"PCI-8.3.1",name:"Multi-factor authentication",category:"Access Control",description:"MFA for remote network access.",frameworks:["PCI DSS"]},
            {id:"PCI-9.1.1",name:"Physical access controls",category:"Physical Security",description:"Physical access to cardholder data controlled.",frameworks:["PCI DSS"]},
            {id:"PCI-10.2.1",name:"Audit trails",category:"Logging & Monitoring",description:"Audit trails implemented to track user activities.",frameworks:["PCI DSS"]},
            {id:"PCI-11.3.1",name:"External penetration testing",category:"Risk Management",description:"External penetration testing performed.",frameworks:["PCI DSS"]},
            {id:"PCI-12.1.1",name:"Security policy",category:"Policy & Governance",description:"Overall information security policy established.",frameworks:["PCI DSS"]},
            {id:"PCI-12.6.1",name:"Security awareness program",category:"Policy & Governance",description:"Formal security awareness program implemented.",frameworks:["PCI DSS"]},
            // HIPAA (15 key controls)
            {id:"HIPAA-164.308(a)(1)",name:"Security management",category:"Policy & Governance",description:"Policies to prevent, detect and correct security violations.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(1)(ii)(A)",name:"Risk analysis",category:"Risk Management",description:"Assess potential risks to ePHI confidentiality, integrity, availability.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(1)(ii)(B)",name:"Risk management",category:"Risk Management",description:"Implement measures to reduce risks to reasonable level.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)",name:"Workforce security",category:"Policy & Governance",description:"Ensure workforce has appropriate access to ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)",name:"Access management",category:"Access Control",description:"Policies for authorizing access to ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)",name:"Security awareness",category:"Policy & Governance",description:"Security awareness and training program for workforce.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(6)",name:"Security incidents",category:"Incident Management",description:"Policies to address security incidents.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)",name:"Contingency plan",category:"Business Continuity",description:"Policies for responding to emergencies.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(1)",name:"Facility access controls",category:"Physical Security",description:"Limit physical access to systems with ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(d)(1)",name:"Device controls",category:"Physical Security",description:"Govern receipt and removal of hardware/media.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(a)(1)",name:"Access control",category:"Access Control",description:"Allow access only to authorized persons/software.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(a)(2)(iv)",name:"Encryption",category:"Data Protection",description:"Mechanism to encrypt and decrypt ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(b)",name:"Audit controls",category:"Logging & Monitoring",description:"Record and examine activity in systems with ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(d)",name:"Person authentication",category:"Access Control",description:"Verify person seeking access is the one claimed.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(e)(1)",name:"Transmission security",category:"Network Security",description:"Guard against unauthorized access to ePHI in transit.",frameworks:["HIPAA"]},
            // SOC 2 (20 key controls)
            {id:"SOC2-CC1.1",name:"Integrity and ethics",category:"Policy & Governance",description:"Demonstrates commitment to integrity and ethical values.",frameworks:["SOC 2"]},
            {id:"SOC2-CC1.2",name:"Board oversight",category:"Policy & Governance",description:"Board exercises oversight of internal control.",frameworks:["SOC 2"]},
            {id:"SOC2-CC2.1",name:"Risk assessment objectives",category:"Risk Management",description:"Objectives specified with sufficient clarity.",frameworks:["SOC 2"]},
            {id:"SOC2-CC2.2",name:"Risk identification",category:"Risk Management",description:"Identifies and analyzes risks across entity.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.1",name:"Policies and procedures",category:"Policy & Governance",description:"Establishes policies and procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC4.1",name:"Monitoring activities",category:"Logging & Monitoring",description:"Performs ongoing evaluations of internal control.",frameworks:["SOC 2"]},
            {id:"SOC2-CC5.1",name:"Control activities",category:"Policy & Governance",description:"Selects control activities to mitigate risks.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.1",name:"Logical and physical access",category:"Access Control",description:"Implements access controls to protect data.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.2",name:"User registration",category:"Access Control",description:"Registers and authorizes new users.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.6",name:"Data classification",category:"Data Protection",description:"Implements logical access security measures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.1",name:"System operations",category:"Logging & Monitoring",description:"Uses detection and monitoring procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.2",name:"Incident response",category:"Incident Management",description:"Monitors system components for anomalies.",frameworks:["SOC 2"]},
            {id:"SOC2-CC8.1",name:"Change management",category:"Asset Management",description:"Authorizes, tests and implements changes.",frameworks:["SOC 2"]},
            {id:"SOC2-CC9.1",name:"Risk mitigation",category:"Risk Management",description:"Identifies and develops risk mitigation activities.",frameworks:["SOC 2"]},
            {id:"SOC2-A1.1",name:"Availability commitments",category:"Business Continuity",description:"Maintains and monitors processing capacity.",frameworks:["SOC 2"]},
            {id:"SOC2-C1.1",name:"Confidentiality commitments",category:"Data Protection",description:"Identifies and maintains confidential information.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.1",name:"Processing integrity",category:"Data Protection",description:"Obtains and uses quality information for processing.",frameworks:["SOC 2"]},
            {id:"SOC2-P1.1",name:"Privacy notice",category:"Data Protection",description:"Provides notice about privacy practices.",frameworks:["SOC 2"]},
            {id:"SOC2-P2.1",name:"Choice and consent",category:"Data Protection",description:"Communicates choices about personal information.",frameworks:["SOC 2"]},
            {id:"SOC2-P4.1",name:"Access to personal info",category:"Data Protection",description:"Grants data subjects access to their information.",frameworks:["SOC 2"]},
            // CIS Controls v8 (20 key controls)
            {id:"CIS-1.1",name:"Enterprise asset inventory",category:"Asset Management",description:"Maintain accurate inventory of enterprise assets.",frameworks:["CIS Controls"]},
            {id:"CIS-2.1",name:"Software inventory",category:"Asset Management",description:"Maintain detailed inventory of authorized software.",frameworks:["CIS Controls"]},
            {id:"CIS-3.1",name:"Data management",category:"Data Protection",description:"Establish data management process.",frameworks:["CIS Controls"]},
            {id:"CIS-3.3",name:"Data access control",category:"Access Control",description:"Configure data access control lists.",frameworks:["CIS Controls"]},
            {id:"CIS-3.10",name:"Encrypt data in transit",category:"Data Protection",description:"Encrypt sensitive data in transit.",frameworks:["CIS Controls"]},
            {id:"CIS-3.11",name:"Encrypt data at rest",category:"Data Protection",description:"Encrypt sensitive data at rest.",frameworks:["CIS Controls"]},
            {id:"CIS-4.1",name:"Secure configuration",category:"Asset Management",description:"Establish secure configuration process.",frameworks:["CIS Controls"]},
            {id:"CIS-5.1",name:"Account inventory",category:"Access Control",description:"Maintain inventory of accounts.",frameworks:["CIS Controls"]},
            {id:"CIS-5.3",name:"Disable dormant accounts",category:"Access Control",description:"Delete or disable dormant accounts.",frameworks:["CIS Controls"]},
            {id:"CIS-5.4",name:"Restrict admin privileges",category:"Access Control",description:"Restrict administrator privileges.",frameworks:["CIS Controls"]},
            {id:"CIS-6.1",name:"Access granting process",category:"Access Control",description:"Establish access granting process.",frameworks:["CIS Controls"]},
            {id:"CIS-6.3",name:"MFA for external apps",category:"Access Control",description:"Require MFA for externally-exposed applications.",frameworks:["CIS Controls"]},
            {id:"CIS-6.4",name:"MFA for remote access",category:"Access Control",description:"Require MFA for remote network access.",frameworks:["CIS Controls"]},
            {id:"CIS-7.1",name:"Vulnerability management",category:"Risk Management",description:"Establish vulnerability management process.",frameworks:["CIS Controls"]},
            {id:"CIS-7.3",name:"Automated OS patching",category:"Asset Management",description:"Perform automated OS patch management.",frameworks:["CIS Controls"]},
            {id:"CIS-7.4",name:"Automated app patching",category:"Asset Management",description:"Perform automated application patching.",frameworks:["CIS Controls"]},
            {id:"CIS-8.1",name:"Audit log management",category:"Logging & Monitoring",description:"Establish audit log management process.",frameworks:["CIS Controls"]},
            {id:"CIS-10.1",name:"Malware defenses",category:"Network Security",description:"Deploy and maintain anti-malware software.",frameworks:["CIS Controls"]},
            {id:"CIS-11.1",name:"Data recovery capability",category:"Business Continuity",description:"Establish data recovery processes.",frameworks:["CIS Controls"]},
            {id:"CIS-16.1",name:"Application security",category:"Asset Management",description:"Establish secure application development.",frameworks:["CIS Controls"]},
            // GDPR (10 key controls)
            {id:"GDPR-5.1",name:"Lawfulness of processing",category:"Data Protection",description:"Personal data processed lawfully, fairly, transparently.",frameworks:["GDPR"]},
            {id:"GDPR-5.2",name:"Purpose limitation",category:"Data Protection",description:"Data collected for specified, legitimate purposes.",frameworks:["GDPR"]},
            {id:"GDPR-5.3",name:"Data minimization",category:"Data Protection",description:"Data adequate, relevant, limited to what is necessary.",frameworks:["GDPR"]},
            {id:"GDPR-5.4",name:"Accuracy",category:"Data Protection",description:"Personal data kept accurate and up to date.",frameworks:["GDPR"]},
            {id:"GDPR-5.5",name:"Storage limitation",category:"Data Protection",description:"Data kept no longer than necessary.",frameworks:["GDPR"]},
            {id:"GDPR-5.6",name:"Integrity and confidentiality",category:"Data Protection",description:"Appropriate security for personal data.",frameworks:["GDPR"]},
            {id:"GDPR-12",name:"Transparent communication",category:"Data Protection",description:"Clear communication about data processing.",frameworks:["GDPR"]},
            {id:"GDPR-15",name:"Right of access",category:"Data Protection",description:"Data subjects can access their personal data.",frameworks:["GDPR"]},
            {id:"GDPR-17",name:"Right to erasure",category:"Data Protection",description:"Data subjects can request data deletion.",frameworks:["GDPR"]},
            {id:"GDPR-32",name:"Security of processing",category:"Data Protection",description:"Implement appropriate technical and organizational measures.",frameworks:["GDPR"]},
            // CMMC (10 key controls)
            {id:"CMMC-AC.1.001",name:"Limit system access",category:"Access Control",description:"Limit information system access to authorized users.",frameworks:["CMMC"]},
            {id:"CMMC-AC.1.002",name:"Limit transactions",category:"Access Control",description:"Limit access to types of transactions and functions.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.007",name:"Least privilege",category:"Access Control",description:"Employ least privilege principle.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.008",name:"Privileged functions",category:"Access Control",description:"Use non-privileged accounts for non-security functions.",frameworks:["CMMC"]},
            {id:"CMMC-IA.1.076",name:"Identify users",category:"Access Control",description:"Identify information system users.",frameworks:["CMMC"]},
            {id:"CMMC-IA.1.077",name:"Authenticate users",category:"Access Control",description:"Authenticate users as prerequisite to access.",frameworks:["CMMC"]},
            {id:"CMMC-SC.1.175",name:"Monitor communications",category:"Network Security",description:"Monitor, control, protect communications at boundaries.",frameworks:["CMMC"]},
            {id:"CMMC-SC.1.176",name:"Subnetworks",category:"Network Security",description:"Implement subnetworks for publicly accessible components.",frameworks:["CMMC"]},
            {id:"CMMC-SI.1.210",name:"Flaw remediation",category:"Risk Management",description:"Identify, report, correct information flaws timely.",frameworks:["CMMC"]},
            {id:"CMMC-SI.1.211",name:"Malicious code protection",category:"Network Security",description:"Provide protection from malicious code.",frameworks:["CMMC"]},
            // COBIT (10 key controls)
            {id:"COBIT-APO01.03",name:"Management framework",category:"Policy & Governance",description:"Maintain enablers of the management system.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.01",name:"Data collection",category:"Risk Management",description:"Collect data on risk management activities.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.02",name:"Risk analysis",category:"Risk Management",description:"Develop useful information to support risk decisions.",frameworks:["COBIT"]},
            {id:"COBIT-APO13.01",name:"ISMS establishment",category:"Policy & Governance",description:"Establish and maintain an ISMS.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.01",name:"Change evaluation",category:"Asset Management",description:"Evaluate and authorize change requests.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.01",name:"Malware protection",category:"Network Security",description:"Protect information systems from malware.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.02",name:"Network security",category:"Network Security",description:"Maintain network security mechanisms.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.04",name:"User access management",category:"Access Control",description:"Manage user identity and logical access.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.05",name:"Physical access",category:"Physical Security",description:"Manage physical access to IT assets.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.07",name:"Security monitoring",category:"Logging & Monitoring",description:"Monitor infrastructure for security events.",frameworks:["COBIT"]},
            // Additional NIST CSF Controls (40 more)
            {id:"NIST-ID.AM-03",name:"Data flow mapping",category:"Asset Management",description:"Organizational communication and data flows mapped.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-04",name:"External information systems",category:"Asset Management",description:"External information systems catalogued.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-05",name:"Resource prioritization",category:"Asset Management",description:"Resources prioritized based on classification and business value.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-06",name:"Cybersecurity roles",category:"Policy & Governance",description:"Cybersecurity roles and responsibilities established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-01",name:"Supply chain role",category:"Risk Management",description:"Organization's role in supply chain identified.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-02",name:"Critical infrastructure",category:"Asset Management",description:"Organization's place in critical infrastructure identified.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-03",name:"Organizational mission",category:"Policy & Governance",description:"Priorities for organizational mission established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-04",name:"Dependencies",category:"Risk Management",description:"Dependencies and critical functions established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-05",name:"Resilience requirements",category:"Business Continuity",description:"Resilience requirements established for delivery of services.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-02",name:"Legal requirements",category:"Compliance",description:"Cybersecurity roles coordinated with external partners.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-03",name:"Regulatory requirements",category:"Compliance",description:"Legal and regulatory requirements understood and managed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-04",name:"Governance processes",category:"Policy & Governance",description:"Governance and risk management processes address cybersecurity.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-03",name:"Internal threats",category:"Risk Management",description:"Threats, internal and external, identified and documented.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-04",name:"Business impacts",category:"Risk Management",description:"Potential business impacts and likelihoods identified.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-05",name:"Risk responses",category:"Risk Management",description:"Threats, vulnerabilities, likelihoods used to determine risk.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-06",name:"Risk response selection",category:"Risk Management",description:"Risk responses identified and prioritized.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RM-02",name:"Risk tolerance",category:"Risk Management",description:"Organizational risk tolerance determined and expressed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RM-03",name:"Risk-informed decisions",category:"Risk Management",description:"Risk tolerance informed by role in critical infrastructure.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-02",name:"Supplier identification",category:"Vendor Management",description:"Suppliers and partners identified and prioritized.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-03",name:"Supplier contracts",category:"Vendor Management",description:"Contracts with suppliers address cybersecurity.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-04",name:"Supplier assessments",category:"Vendor Management",description:"Suppliers and partners routinely assessed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-05",name:"Supplier testing",category:"Vendor Management",description:"Response and recovery planning tested with suppliers.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-02",name:"Physical access management",category:"Physical Security",description:"Physical access to assets managed and protected.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-03",name:"Remote access management",category:"Access Control",description:"Remote access managed.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-04",name:"Access permissions",category:"Access Control",description:"Access permissions managed with least privilege.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-05",name:"Network integrity",category:"Network Security",description:"Network integrity protected with segregation.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-06",name:"Identity proofing",category:"Access Control",description:"Identities proofed, bound to credentials, and authenticated.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-07",name:"Strong authentication",category:"Access Control",description:"Users, devices authenticated commensurate with risk.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-02",name:"Privileged user training",category:"Policy & Governance",description:"Privileged users understand roles and responsibilities.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-03",name:"Third-party training",category:"Vendor Management",description:"Third-party stakeholders understand roles.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-04",name:"Senior executive awareness",category:"Policy & Governance",description:"Senior executives understand roles and responsibilities.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-05",name:"Physical security training",category:"Physical Security",description:"Physical and cybersecurity personnel understand roles.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-03",name:"Asset management",category:"Asset Management",description:"Assets formally managed throughout lifecycle.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-04",name:"Availability maintained",category:"Business Continuity",description:"Adequate capacity ensures availability.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-05",name:"Data leakage prevention",category:"Data Protection",description:"Protections against data leaks implemented.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-06",name:"Integrity checking",category:"Data Protection",description:"Integrity checking mechanisms verify software integrity.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-07",name:"Development environments",category:"Asset Management",description:"Development and testing environments separate from production.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-08",name:"Hardware integrity",category:"Asset Management",description:"Integrity checking mechanisms verify hardware integrity.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-02",name:"SDLC management",category:"Asset Management",description:"System development life cycle implemented.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-03",name:"Configuration management",category:"Asset Management",description:"Configuration change control processes in place.",frameworks:["NIST CSF"]},
            // Additional PCI DSS Controls (30 more)
            {id:"PCI-1.3.1",name:"DMZ implementation",category:"Network Security",description:"DMZ implemented to limit inbound traffic.",frameworks:["PCI DSS"]},
            {id:"PCI-1.3.2",name:"Inbound traffic restriction",category:"Network Security",description:"Inbound internet traffic limited to DMZ.",frameworks:["PCI DSS"]},
            {id:"PCI-1.3.3",name:"Anti-spoofing measures",category:"Network Security",description:"Anti-spoofing measures implemented.",frameworks:["PCI DSS"]},
            {id:"PCI-1.3.4",name:"Outbound traffic authorization",category:"Network Security",description:"Outbound traffic from CDE explicitly authorized.",frameworks:["PCI DSS"]},
            {id:"PCI-1.4.1",name:"Personal firewall software",category:"Network Security",description:"Personal firewall software installed on mobile devices.",frameworks:["PCI DSS"]},
            {id:"PCI-2.1.1",name:"Wireless defaults changed",category:"Network Security",description:"Wireless vendor defaults changed at installation.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.3",name:"Security features enabled",category:"Asset Management",description:"Primary security features configured.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.4",name:"Non-essential removed",category:"Asset Management",description:"Unnecessary functionality removed.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.5",name:"Security parameters documented",category:"Asset Management",description:"System security parameters configured.",frameworks:["PCI DSS"]},
            {id:"PCI-2.3.1",name:"Encrypted admin access",category:"Access Control",description:"All non-console administrative access encrypted.",frameworks:["PCI DSS"]},
            {id:"PCI-3.1.1",name:"Data retention policy",category:"Data Protection",description:"Data retention and disposal policies implemented.",frameworks:["PCI DSS"]},
            {id:"PCI-3.2.2",name:"Data after authorization",category:"Data Protection",description:"Data not stored after authorization.",frameworks:["PCI DSS"]},
            {id:"PCI-3.5.1",name:"Key access restriction",category:"Data Protection",description:"Access to cryptographic keys restricted.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.1",name:"Key generation",category:"Data Protection",description:"Strong cryptographic key generation.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.2",name:"Key distribution",category:"Data Protection",description:"Secure cryptographic key distribution.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.3",name:"Key storage",category:"Data Protection",description:"Secure cryptographic key storage.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.4",name:"Key changes",category:"Data Protection",description:"Cryptographic key changes for end of cryptoperiod.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.5",name:"Key retirement",category:"Data Protection",description:"Retirement of old keys.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.6",name:"Split knowledge",category:"Data Protection",description:"Split knowledge and dual control for key management.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.7",name:"Key substitution prevention",category:"Data Protection",description:"Prevention of unauthorized key substitution.",frameworks:["PCI DSS"]},
            {id:"PCI-4.1.1",name:"Trusted keys/certificates",category:"Network Security",description:"Only trusted keys and certificates accepted.",frameworks:["PCI DSS"]},
            {id:"PCI-5.1.1",name:"Anti-malware capability",category:"Network Security",description:"Anti-malware capable of detecting all malware.",frameworks:["PCI DSS"]},
            {id:"PCI-5.3.1",name:"Anti-malware mechanisms active",category:"Network Security",description:"Anti-malware mechanisms actively running.",frameworks:["PCI DSS"]},
            {id:"PCI-5.3.2",name:"Anti-malware logs retained",category:"Logging & Monitoring",description:"Anti-malware logs retained per policy.",frameworks:["PCI DSS"]},
            {id:"PCI-6.2.1",name:"Custom software security",category:"Asset Management",description:"Custom software developed securely.",frameworks:["PCI DSS"]},
            {id:"PCI-6.3.2",name:"Code review",category:"Asset Management",description:"Custom code reviewed before release.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.1",name:"Injection flaws",category:"Asset Management",description:"Injection flaws addressed in development.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.2",name:"Buffer overflows",category:"Asset Management",description:"Buffer overflow addressed in development.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.3",name:"Insecure storage",category:"Data Protection",description:"Insecure cryptographic storage addressed.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.4",name:"Insecure communications",category:"Network Security",description:"Insecure communications addressed.",frameworks:["PCI DSS"]},
            // Additional HIPAA Controls (25 more)
            {id:"HIPAA-164.308(a)(1)(ii)(C)",name:"Sanction policy",category:"Policy & Governance",description:"Apply appropriate sanctions against workforce members who fail to comply.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(1)(ii)(D)",name:"Information system activity review",category:"Logging & Monitoring",description:"Implement procedures to regularly review records of activity.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)(ii)(A)",name:"Authorization supervision",category:"Access Control",description:"Implement procedures for authorization and supervision.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)(ii)(B)",name:"Workforce clearance",category:"Policy & Governance",description:"Implement procedures to determine access appropriateness.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)(ii)(C)",name:"Termination procedures",category:"Access Control",description:"Implement procedures for terminating access.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)(ii)(A)",name:"Isolating healthcare function",category:"Access Control",description:"Isolate healthcare clearinghouse functions.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)(ii)(B)",name:"Access authorization",category:"Access Control",description:"Implement policies for granting access to ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)(ii)(C)",name:"Access establishment",category:"Access Control",description:"Implement policies for access establishment and modification.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(A)",name:"Security reminders",category:"Policy & Governance",description:"Periodic security updates.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(B)",name:"Malicious software protection",category:"Network Security",description:"Procedures for guarding against malicious software.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(C)",name:"Log-in monitoring",category:"Logging & Monitoring",description:"Procedures for monitoring log-in attempts.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(D)",name:"Password management",category:"Access Control",description:"Procedures for creating, changing, and safeguarding passwords.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(6)(ii)",name:"Response and reporting",category:"Incident Management",description:"Identify and respond to suspected security incidents.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(A)",name:"Data backup plan",category:"Business Continuity",description:"Establish procedures to create and maintain exact copies of ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(B)",name:"Disaster recovery plan",category:"Business Continuity",description:"Establish procedures to restore lost data.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(C)",name:"Emergency mode operations",category:"Business Continuity",description:"Establish procedures for emergency mode operation.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(D)",name:"Testing and revision",category:"Business Continuity",description:"Implement procedures for periodic testing of contingency plans.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(E)",name:"Applications and data criticality",category:"Business Continuity",description:"Assess relative criticality of applications and data.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(8)",name:"Evaluation",category:"Compliance",description:"Perform periodic technical and non-technical evaluation.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(i)",name:"Contingency operations",category:"Physical Security",description:"Establish procedures for facility access during emergency.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(ii)",name:"Facility security plan",category:"Physical Security",description:"Implement policies to safeguard the facility.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(iii)",name:"Access control and validation",category:"Physical Security",description:"Implement procedures to control and validate access.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(iv)",name:"Maintenance records",category:"Physical Security",description:"Implement policies to document repairs and modifications.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(b)",name:"Workstation use",category:"Physical Security",description:"Implement policies for proper workstation use.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(c)",name:"Workstation security",category:"Physical Security",description:"Implement physical safeguards for workstations.",frameworks:["HIPAA"]},
            // Additional SOC 2 Controls (30 more)
            {id:"SOC2-CC1.3",name:"Structure and authority",category:"Policy & Governance",description:"Management establishes organizational structure.",frameworks:["SOC 2"]},
            {id:"SOC2-CC1.4",name:"Competence commitment",category:"Policy & Governance",description:"Demonstrates commitment to competence.",frameworks:["SOC 2"]},
            {id:"SOC2-CC1.5",name:"Accountability",category:"Policy & Governance",description:"Holds individuals accountable for responsibilities.",frameworks:["SOC 2"]},
            {id:"SOC2-CC2.3",name:"Internal communication",category:"Policy & Governance",description:"Internally communicates necessary information.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.2",name:"Change identification",category:"Risk Management",description:"Identifies and assesses changes.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.3",name:"Fraud risk",category:"Risk Management",description:"Considers potential for fraud.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.4",name:"Risk assessment update",category:"Risk Management",description:"Risk assessment updated for changes.",frameworks:["SOC 2"]},
            {id:"SOC2-CC4.2",name:"Deficiency evaluation",category:"Compliance",description:"Evaluates and communicates deficiencies.",frameworks:["SOC 2"]},
            {id:"SOC2-CC5.2",name:"Technology controls",category:"Asset Management",description:"Selects and develops technology controls.",frameworks:["SOC 2"]},
            {id:"SOC2-CC5.3",name:"Policy deployment",category:"Policy & Governance",description:"Deploys control activities through policies.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.3",name:"Authorization removal",category:"Access Control",description:"Removes access when no longer required.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.4",name:"Access review",category:"Access Control",description:"Reviews access rights periodically.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.5",name:"Physical restrictions",category:"Physical Security",description:"Restricts physical access to facilities.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.7",name:"Transmission protection",category:"Network Security",description:"Restricts transmission of data.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.8",name:"Malware prevention",category:"Network Security",description:"Implements controls to prevent malware.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.3",name:"Security event evaluation",category:"Incident Management",description:"Evaluates security events.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.4",name:"Incident response",category:"Incident Management",description:"Responds to identified security incidents.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.5",name:"Incident recovery",category:"Incident Management",description:"Identifies and executes recovery procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC9.2",name:"Vendor risk management",category:"Vendor Management",description:"Assesses and manages vendor risk.",frameworks:["SOC 2"]},
            {id:"SOC2-A1.2",name:"Environmental protections",category:"Physical Security",description:"Protects against environmental threats.",frameworks:["SOC 2"]},
            {id:"SOC2-A1.3",name:"Recovery testing",category:"Business Continuity",description:"Tests recovery procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-C1.2",name:"Confidential data disposal",category:"Data Protection",description:"Disposes of confidential information.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.2",name:"Input validation",category:"Data Protection",description:"Implements input validation.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.3",name:"Processing accuracy",category:"Data Protection",description:"Implements processing accuracy checks.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.4",name:"Output completeness",category:"Data Protection",description:"Implements output completeness checks.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.5",name:"Input/output reconciliation",category:"Data Protection",description:"Implements reconciliation procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-P3.1",name:"Personal info collection",category:"Data Protection",description:"Collects personal information for stated purposes.",frameworks:["SOC 2"]},
            {id:"SOC2-P4.2",name:"Personal info correction",category:"Data Protection",description:"Corrects personal information upon request.",frameworks:["SOC 2"]},
            {id:"SOC2-P5.1",name:"Disclosure to third parties",category:"Data Protection",description:"Discloses personal information to third parties appropriately.",frameworks:["SOC 2"]},
            {id:"SOC2-P6.1",name:"Personal info quality",category:"Data Protection",description:"Personal information quality maintained.",frameworks:["SOC 2"]},
            // Additional CIS Controls (30 more)
            {id:"CIS-1.2",name:"Address unauthorized assets",category:"Asset Management",description:"Ensure unauthorized assets are addressed.",frameworks:["CIS Controls"]},
            {id:"CIS-1.3",name:"DHCP logging",category:"Logging & Monitoring",description:"Utilize DHCP logging to update inventory.",frameworks:["CIS Controls"]},
            {id:"CIS-1.4",name:"Detailed asset inventory",category:"Asset Management",description:"Use detailed asset inventory.",frameworks:["CIS Controls"]},
            {id:"CIS-1.5",name:"Asset information quality",category:"Asset Management",description:"Ensure asset inventory information quality.",frameworks:["CIS Controls"]},
            {id:"CIS-2.2",name:"Authorized software inventory",category:"Asset Management",description:"Ensure authorized software is currently supported.",frameworks:["CIS Controls"]},
            {id:"CIS-2.3",name:"Address unauthorized software",category:"Asset Management",description:"Ensure unauthorized software is addressed.",frameworks:["CIS Controls"]},
            {id:"CIS-2.4",name:"Software inventory tool",category:"Asset Management",description:"Utilize automated software inventory tools.",frameworks:["CIS Controls"]},
            {id:"CIS-2.5",name:"Allowlisting software",category:"Asset Management",description:"Use application allowlisting technology.",frameworks:["CIS Controls"]},
            {id:"CIS-2.6",name:"Allowlist libraries",category:"Asset Management",description:"Allowlist authorized libraries.",frameworks:["CIS Controls"]},
            {id:"CIS-2.7",name:"Allowlist scripts",category:"Asset Management",description:"Allowlist authorized scripts.",frameworks:["CIS Controls"]},
            {id:"CIS-3.2",name:"Data inventory",category:"Data Protection",description:"Maintain data inventory.",frameworks:["CIS Controls"]},
            {id:"CIS-3.4",name:"Data classification enforcement",category:"Data Protection",description:"Enforce data classification policies.",frameworks:["CIS Controls"]},
            {id:"CIS-3.5",name:"Sensitive data documentation",category:"Data Protection",description:"Document data flows.",frameworks:["CIS Controls"]},
            {id:"CIS-3.6",name:"Encrypt mobile device data",category:"Data Protection",description:"Encrypt data on mobile devices.",frameworks:["CIS Controls"]},
            {id:"CIS-3.7",name:"Removable media encryption",category:"Data Protection",description:"Encrypt data on removable media.",frameworks:["CIS Controls"]},
            {id:"CIS-3.8",name:"Removable media management",category:"Data Protection",description:"Manage removable storage devices.",frameworks:["CIS Controls"]},
            {id:"CIS-3.9",name:"Remote storage encryption",category:"Data Protection",description:"Encrypt data on remote storage.",frameworks:["CIS Controls"]},
            {id:"CIS-3.12",name:"Network data segmentation",category:"Network Security",description:"Segment data processing and storage.",frameworks:["CIS Controls"]},
            {id:"CIS-3.13",name:"Data disposal process",category:"Data Protection",description:"Deploy secure disposal process.",frameworks:["CIS Controls"]},
            {id:"CIS-3.14",name:"Data disposal logging",category:"Data Protection",description:"Log sensitive data access.",frameworks:["CIS Controls"]},
            {id:"CIS-4.2",name:"Secure image maintenance",category:"Asset Management",description:"Maintain secure configuration images.",frameworks:["CIS Controls"]},
            {id:"CIS-4.3",name:"Secure configuration for portable devices",category:"Asset Management",description:"Configure devices to use secure configuration.",frameworks:["CIS Controls"]},
            {id:"CIS-4.4",name:"Firewall host-based",category:"Network Security",description:"Implement and manage host-based firewall.",frameworks:["CIS Controls"]},
            {id:"CIS-4.5",name:"Unused services and ports",category:"Network Security",description:"Uninstall unnecessary services.",frameworks:["CIS Controls"]},
            {id:"CIS-4.6",name:"DNS filtering",category:"Network Security",description:"Configure DNS filtering services.",frameworks:["CIS Controls"]},
            {id:"CIS-4.7",name:"Email filtering",category:"Network Security",description:"Configure email filtering services.",frameworks:["CIS Controls"]},
            {id:"CIS-4.8",name:"DMARC implementation",category:"Network Security",description:"Implement DMARC.",frameworks:["CIS Controls"]},
            {id:"CIS-4.9",name:"Block unnecessary file types",category:"Network Security",description:"Block unnecessary file types.",frameworks:["CIS Controls"]},
            {id:"CIS-4.10",name:"Wireless client isolation",category:"Network Security",description:"Enforce wireless client isolation.",frameworks:["CIS Controls"]},
            {id:"CIS-4.11",name:"Browser extensions",category:"Asset Management",description:"Manage default and approved browser extensions.",frameworks:["CIS Controls"]},
            // Additional GDPR Controls (20 more)
            {id:"GDPR-6",name:"Lawful basis",category:"Compliance",description:"Processing has a lawful basis.",frameworks:["GDPR"]},
            {id:"GDPR-7",name:"Conditions for consent",category:"Data Protection",description:"Conditions for consent met.",frameworks:["GDPR"]},
            {id:"GDPR-8",name:"Child consent",category:"Data Protection",description:"Conditions for child consent met.",frameworks:["GDPR"]},
            {id:"GDPR-9",name:"Special categories",category:"Data Protection",description:"Processing of special categories of data.",frameworks:["GDPR"]},
            {id:"GDPR-10",name:"Criminal convictions",category:"Data Protection",description:"Processing relating to criminal convictions.",frameworks:["GDPR"]},
            {id:"GDPR-13",name:"Information provision",category:"Data Protection",description:"Information provided when collecting personal data.",frameworks:["GDPR"]},
            {id:"GDPR-14",name:"Information when not obtained",category:"Data Protection",description:"Information provided when data not obtained from subject.",frameworks:["GDPR"]},
            {id:"GDPR-16",name:"Right to rectification",category:"Data Protection",description:"Data subjects can rectify inaccurate data.",frameworks:["GDPR"]},
            {id:"GDPR-18",name:"Right to restriction",category:"Data Protection",description:"Data subjects can restrict processing.",frameworks:["GDPR"]},
            {id:"GDPR-19",name:"Notification obligation",category:"Data Protection",description:"Notification of rectification or erasure.",frameworks:["GDPR"]},
            {id:"GDPR-20",name:"Right to portability",category:"Data Protection",description:"Data subjects can receive data in portable format.",frameworks:["GDPR"]},
            {id:"GDPR-21",name:"Right to object",category:"Data Protection",description:"Data subjects can object to processing.",frameworks:["GDPR"]},
            {id:"GDPR-22",name:"Automated decision-making",category:"Data Protection",description:"Rights related to automated decision-making.",frameworks:["GDPR"]},
            {id:"GDPR-25",name:"Data protection by design",category:"Data Protection",description:"Data protection by design and default implemented.",frameworks:["GDPR"]},
            {id:"GDPR-28",name:"Processor requirements",category:"Vendor Management",description:"Only processors with sufficient guarantees used.",frameworks:["GDPR"]},
            {id:"GDPR-30",name:"Records of processing",category:"Compliance",description:"Records of processing activities maintained.",frameworks:["GDPR"]},
            {id:"GDPR-33",name:"Breach notification authority",category:"Incident Management",description:"Personal data breaches notified to authority.",frameworks:["GDPR"]},
            {id:"GDPR-34",name:"Breach notification subject",category:"Incident Management",description:"Data subjects notified of high risk breaches.",frameworks:["GDPR"]},
            {id:"GDPR-35",name:"Impact assessments",category:"Risk Management",description:"Data protection impact assessments conducted.",frameworks:["GDPR"]},
            {id:"GDPR-37",name:"DPO designation",category:"Policy & Governance",description:"Data Protection Officer designated when required.",frameworks:["GDPR"]},
            // Additional CMMC Controls (20 more)
            {id:"CMMC-AC.2.005",name:"Separation of duties",category:"Access Control",description:"Separate duties of individuals to reduce risk.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.006",name:"Remote access",category:"Access Control",description:"Limit use of portable storage devices.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.009",name:"Wireless access",category:"Access Control",description:"Limit wireless access.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.010",name:"Session control",category:"Access Control",description:"Limit unsuccessful logon attempts.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.011",name:"Session termination",category:"Access Control",description:"Terminate sessions after defined periods.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.013",name:"Remote session control",category:"Access Control",description:"Monitor and control remote access sessions.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.015",name:"Privileged remote access",category:"Access Control",description:"Route privileged access through managed access points.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.016",name:"Wireless protection",category:"Network Security",description:"Protect wireless access using authentication and encryption.",frameworks:["CMMC"]},
            {id:"CMMC-AT.2.056",name:"Awareness training",category:"Policy & Governance",description:"Ensure security awareness and training.",frameworks:["CMMC"]},
            {id:"CMMC-AT.2.057",name:"Insider threat awareness",category:"Policy & Governance",description:"Provide insider threat awareness.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.041",name:"Audit content",category:"Logging & Monitoring",description:"Ensure audit logs contain required information.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.042",name:"Audit review",category:"Logging & Monitoring",description:"Review and update audited events.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.043",name:"Audit alerts",category:"Logging & Monitoring",description:"Alert in event of audit process failure.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.044",name:"Audit correlation",category:"Logging & Monitoring",description:"Correlate audit review and analysis.",frameworks:["CMMC"]},
            {id:"CMMC-CA.2.157",name:"Security assessments",category:"Compliance",description:"Develop and implement security assessment plans.",frameworks:["CMMC"]},
            {id:"CMMC-CA.2.158",name:"Assessment findings",category:"Compliance",description:"Assess security controls periodically.",frameworks:["CMMC"]},
            {id:"CMMC-CA.2.159",name:"Remediation plans",category:"Compliance",description:"Develop plans of action to correct deficiencies.",frameworks:["CMMC"]},
            {id:"CMMC-CM.2.061",name:"Configuration baselines",category:"Asset Management",description:"Establish and maintain configuration baselines.",frameworks:["CMMC"]},
            {id:"CMMC-CM.2.062",name:"Security configuration",category:"Asset Management",description:"Employ security configuration settings.",frameworks:["CMMC"]},
            {id:"CMMC-CM.2.063",name:"User software installation",category:"Asset Management",description:"Track and control user-installed software.",frameworks:["CMMC"]},
            // Additional COBIT Controls (20 more)
            {id:"COBIT-APO01.01",name:"IT management framework",category:"Policy & Governance",description:"Define and communicate the management framework.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.02",name:"Organizational positioning",category:"Policy & Governance",description:"Establish organizational positioning of IT.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.04",name:"Communication mechanisms",category:"Policy & Governance",description:"Communicate management philosophy and direction.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.05",name:"Culture development",category:"Policy & Governance",description:"Define and develop a culture and ethics.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.06",name:"Data and system ownership",category:"Asset Management",description:"Define data and system ownership.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.03",name:"Risk profile maintenance",category:"Risk Management",description:"Maintain a risk profile.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.04",name:"Risk expression",category:"Risk Management",description:"Express risk in business-relevant terms.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.05",name:"Risk response portfolio",category:"Risk Management",description:"Define a risk management action portfolio.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.06",name:"Risk response execution",category:"Risk Management",description:"Respond to risk.",frameworks:["COBIT"]},
            {id:"COBIT-APO13.02",name:"ISMS plan",category:"Policy & Governance",description:"Define and manage an information security plan.",frameworks:["COBIT"]},
            {id:"COBIT-APO13.03",name:"ISMS monitoring",category:"Logging & Monitoring",description:"Monitor and review the ISMS.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.02",name:"Change impact assessment",category:"Asset Management",description:"Assess and prioritize change requests.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.03",name:"Emergency changes",category:"Asset Management",description:"Manage emergency changes.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.04",name:"Change closure",category:"Asset Management",description:"Close and document changes.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.03",name:"Endpoint security",category:"Network Security",description:"Manage endpoint security.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.06",name:"Sensitive documents",category:"Data Protection",description:"Manage sensitive documents and devices.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.01",name:"Logical access controls",category:"Access Control",description:"Manage access to information and data.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.02",name:"Privileged access controls",category:"Access Control",description:"Manage privileged access rights.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.03",name:"Access profiles",category:"Access Control",description:"Manage user access entitlements.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.04",name:"Access segregation",category:"Access Control",description:"Segregate and manage privileged user accounts.",frameworks:["COBIT"]},
            // ISO 42001:2023 AI Management System - Complete Control Set (Clauses 4-10 + Annex A)
            // Clause 4: Context of the organization
            {id:"ISO42-4.1",name:"Understanding the organization",category:"Policy & Governance",description:"Understand internal and external context relevant to AI management system.",frameworks:["ISO 42001"]},
            {id:"ISO42-4.2",name:"Understanding stakeholder needs",category:"Policy & Governance",description:"Determine stakeholders and their requirements for AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-4.3",name:"AI management system scope",category:"Policy & Governance",description:"Determine boundaries and applicability of AI management system.",frameworks:["ISO 42001"]},
            {id:"ISO42-4.4",name:"AI management system establishment",category:"Policy & Governance",description:"Establish, implement, maintain and continually improve AI management system.",frameworks:["ISO 42001"]},
            // Clause 5: Leadership
            {id:"ISO42-5.1",name:"Leadership and commitment",category:"Policy & Governance",description:"Demonstrate leadership and commitment to AI management system.",frameworks:["ISO 42001"]},
            {id:"ISO42-5.2",name:"AI management system policy",category:"Policy & Governance",description:"Establish AI policy aligned with organizational purpose and strategic direction.",frameworks:["ISO 42001"]},
            {id:"ISO42-5.3",name:"Organizational roles & responsibilities",category:"Policy & Governance",description:"Assign roles, responsibilities and authorities for AI governance.",frameworks:["ISO 42001"]},
            // Clause 6: Planning
            {id:"ISO42-6.1",name:"Actions to address risks",category:"Risk Management",description:"Plan actions to address AI-related risks and opportunities.",frameworks:["ISO 42001"]},
            {id:"ISO42-6.2",name:"AI system objectives",category:"Policy & Governance",description:"Establish AI system objectives and plans to achieve them.",frameworks:["ISO 42001"]},
            {id:"ISO42-6.3",name:"Planning of changes",category:"Policy & Governance",description:"Plan changes to AI management system in controlled manner.",frameworks:["ISO 42001"]},
            // Clause 7: Support
            {id:"ISO42-7.1",name:"Resources for AI management",category:"Policy & Governance",description:"Provide resources needed for AI management system.",frameworks:["ISO 42001"]},
            {id:"ISO42-7.2",name:"Competence in AI",category:"Policy & Governance",description:"Ensure personnel have competence in AI systems and responsible AI.",frameworks:["ISO 42001"]},
            {id:"ISO42-7.3",name:"Awareness of AI impacts",category:"Policy & Governance",description:"Ensure awareness of AI policy, objectives, and individual contributions.",frameworks:["ISO 42001"]},
            {id:"ISO42-7.4",name:"Communication about AI",category:"Policy & Governance",description:"Determine internal and external communications on AI management.",frameworks:["ISO 42001"]},
            {id:"ISO42-7.5",name:"Documented information",category:"Policy & Governance",description:"Include documented information required by AI management system.",frameworks:["ISO 42001"]},
            // Clause 8: Operation
            {id:"ISO42-8.1",name:"Operational planning & control",category:"Policy & Governance",description:"Plan, implement and control processes needed for AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-8.2",name:"AI system risk assessment",category:"Risk Management",description:"Conduct comprehensive risk assessment for AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-8.3",name:"AI system risk treatment",category:"Risk Management",description:"Implement risk treatment plans for identified AI risks.",frameworks:["ISO 42001"]},
            // Clause 9: Performance evaluation
            {id:"ISO42-9.1",name:"Monitoring & measurement",category:"Logging & Monitoring",description:"Monitor, measure, analyze and evaluate AI management system.",frameworks:["ISO 42001"]},
            {id:"ISO42-9.2",name:"Internal audit of AI systems",category:"Compliance",description:"Conduct internal audits at planned intervals.",frameworks:["ISO 42001"]},
            {id:"ISO42-9.3",name:"Management review",category:"Policy & Governance",description:"Review AI management system at planned intervals.",frameworks:["ISO 42001"]},
            // Clause 10: Improvement
            {id:"ISO42-10.1",name:"Nonconformity & corrective action",category:"Incident Management",description:"React to nonconformity and take corrective action.",frameworks:["ISO 42001"]},
            {id:"ISO42-10.2",name:"Continual improvement",category:"Policy & Governance",description:"Continually improve suitability, adequacy and effectiveness.",frameworks:["ISO 42001"]},
            // Annex A: AI System-Specific Controls
            {id:"ISO42-A.1",name:"AI system inventory",category:"Asset Management",description:"Maintain inventory of AI systems with classification and lifecycle stage.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.2",name:"AI system classification",category:"Risk Management",description:"Classify AI systems by risk level, application domain, and impact.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.3",name:"AI impact assessment",category:"Risk Management",description:"Assess societal, ethical, legal and business impacts of AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.4",name:"Stakeholder identification",category:"Policy & Governance",description:"Identify all stakeholders affected by or affecting AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.5",name:"AI system documentation",category:"Policy & Governance",description:"Document AI system design, development, validation and operations.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.6",name:"Data governance for AI",category:"Data Protection",description:"Establish data governance for quality, provenance and appropriateness.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.7",name:"Data quality management",category:"Data Protection",description:"Ensure data quality, accuracy, completeness and representativeness.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.8",name:"Data labeling practices",category:"Data Protection",description:"Implement consistent and accurate data labeling procedures.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.9",name:"Training data management",category:"Data Protection",description:"Manage training datasets including versioning and documentation.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.10",name:"Data privacy in AI",category:"Data Protection",description:"Protect privacy throughout AI system lifecycle per regulations.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.11",name:"AI model selection",category:"Risk Management",description:"Select appropriate AI models based on objectives and constraints.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.12",name:"AI model development",category:"Policy & Governance",description:"Develop AI models following secure and responsible practices.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.13",name:"AI model training",category:"Policy & Governance",description:"Train AI models with appropriate data, techniques and validation.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.14",name:"AI model validation",category:"Risk Management",description:"Validate AI models through testing, benchmarking and evaluation.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.15",name:"Bias detection & mitigation",category:"Risk Management",description:"Detect and mitigate bias in data, models and AI system outputs.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.16",name:"Fairness testing",category:"Risk Management",description:"Test AI systems for fairness across demographics and use cases.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.17",name:"AI explainability",category:"Policy & Governance",description:"Implement explainability mechanisms for AI decisions.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.18",name:"AI transparency",category:"Policy & Governance",description:"Maintain transparency about AI system capabilities and limitations.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.19",name:"Human oversight mechanisms",category:"Policy & Governance",description:"Establish human oversight for AI decisions and operations.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.20",name:"Human-in-the-loop controls",category:"Policy & Governance",description:"Implement human intervention points for critical decisions.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.21",name:"AI system security",category:"Network Security",description:"Protect AI systems from adversarial attacks and unauthorized access.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.22",name:"Adversarial robustness",category:"Network Security",description:"Test and improve resilience against adversarial inputs.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.23",name:"Model poisoning prevention",category:"Network Security",description:"Prevent malicious manipulation of training data and models.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.24",name:"AI access controls",category:"Access Control",description:"Control access to AI systems, models and training data.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.25",name:"AI supply chain security",category:"Vendor Management",description:"Secure third-party AI components, models and data sources.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.26",name:"Third-party AI assessment",category:"Vendor Management",description:"Assess security and reliability of external AI services.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.27",name:"AI system deployment",category:"Policy & Governance",description:"Deploy AI systems with appropriate controls and monitoring.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.28",name:"AI performance monitoring",category:"Logging & Monitoring",description:"Monitor AI system performance, accuracy and reliability.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.29",name:"Model drift detection",category:"Logging & Monitoring",description:"Detect and respond to model performance degradation over time.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.30",name:"Concept drift monitoring",category:"Logging & Monitoring",description:"Monitor for changes in data distributions affecting predictions.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.31",name:"AI output validation",category:"Logging & Monitoring",description:"Validate AI outputs for accuracy, safety and appropriateness.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.32",name:"AI system logging",category:"Logging & Monitoring",description:"Log AI decisions, inputs, outputs and human interventions.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.33",name:"AI audit trails",category:"Compliance",description:"Maintain audit trails for AI system actions and decisions.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.34",name:"AI incident response",category:"Incident Management",description:"Establish procedures for AI system failures and harms.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.35",name:"AI harm mitigation",category:"Incident Management",description:"Mitigate and remediate harms caused by AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.36",name:"Model retraining procedures",category:"Policy & Governance",description:"Establish controlled procedures for model updates and retraining.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.37",name:"AI version control",category:"Policy & Governance",description:"Maintain version control for AI models, data and configurations.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.38",name:"AI change management",category:"Policy & Governance",description:"Manage changes to AI systems through controlled process.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.39",name:"AI testing procedures",category:"Risk Management",description:"Test AI systems before deployment and after updates.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.40",name:"Performance metrics definition",category:"Logging & Monitoring",description:"Define metrics including accuracy, precision, recall, F1 score.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.41",name:"AI accountability framework",category:"Policy & Governance",description:"Establish accountability for AI decisions and outcomes.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.42",name:"AI ethics principles",category:"Policy & Governance",description:"Define and apply ethical principles for AI development and use.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.43",name:"Stakeholder engagement",category:"Policy & Governance",description:"Engage stakeholders to understand AI impacts and concerns.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.44",name:"AI user training",category:"Policy & Governance",description:"Train users on proper AI system use and limitations.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.45",name:"AI operator competence",category:"Policy & Governance",description:"Ensure operators have competence to manage AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.46",name:"Environmental impact assessment",category:"Compliance",description:"Assess environmental impact including energy consumption and carbon footprint.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.47",name:"Energy efficiency optimization",category:"Compliance",description:"Optimize AI systems for energy efficiency and sustainability.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.48",name:"AI system retirement",category:"Policy & Governance",description:"Plan retirement including data deletion and transition.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.49",name:"Data retention for AI",category:"Data Protection",description:"Define retention periods for AI training data and outputs.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.50",name:"AI data deletion",category:"Data Protection",description:"Securely delete AI-related data when no longer needed.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.51",name:"Regulatory compliance tracking",category:"Compliance",description:"Track compliance with AI regulations (EU AI Act, GDPR, sector laws).",frameworks:["ISO 42001"]},
            {id:"ISO42-A.52",name:"AI Act conformity assessment",category:"Compliance",description:"Conduct conformity assessments for high-risk AI systems per EU AI Act.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.53",name:"Fundamental rights impact",category:"Compliance",description:"Assess impact on fundamental rights and freedoms.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.54",name:"AI intellectual property",category:"Compliance",description:"Manage IP rights for models, training data and generated content.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.55",name:"AI licensing compliance",category:"Compliance",description:"Ensure compliance with open source and commercial AI licenses.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.56",name:"AI risk register",category:"Risk Management",description:"Maintain register of AI-specific risks and treatment plans.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.57",name:"Automated decision-making controls",category:"Policy & Governance",description:"Control automated decisions affecting individuals per GDPR Article 22.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.58",name:"AI safety assurance",category:"Risk Management",description:"Provide assurance that AI systems operate safely within defined bounds.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.59",name:"Continuous learning management",category:"Policy & Governance",description:"Manage AI systems that learn and adapt post-deployment.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.60",name:"Multi-model governance",category:"Policy & Governance",description:"Govern AI systems using multiple models or ensemble approaches.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.61",name:"AI feedback loops",category:"Logging & Monitoring",description:"Monitor and manage feedback loops that can amplify bias or errors.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.62",name:"Contestability mechanisms",category:"Policy & Governance",description:"Allow individuals to contest AI decisions affecting them.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.63",name:"AI redress procedures",category:"Policy & Governance",description:"Establish procedures for redress when AI causes harm.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.64",name:"Cross-border AI compliance",category:"Compliance",description:"Manage compliance across jurisdictions for global AI deployments.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.65",name:"AI procurement standards",category:"Vendor Management",description:"Define standards for procuring AI systems and services.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.66",name:"AI benchmark testing",category:"Risk Management",description:"Test against industry benchmarks and standard datasets.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.67",name:"Synthetic data governance",category:"Data Protection",description:"Govern use of synthetic data for training and testing.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.68",name:"Federated learning controls",category:"Data Protection",description:"Control federated learning to protect privacy while enabling collaboration.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.69",name:"Edge AI security",category:"Network Security",description:"Secure AI systems deployed on edge devices.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.70",name:"AI interoperability",category:"Policy & Governance",description:"Ensure AI systems can interoperate with other systems securely.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.71",name:"Generative AI controls",category:"Risk Management",description:"Control risks specific to generative AI including hallucinations and misuse.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.72",name:"Prompt injection prevention",category:"Network Security",description:"Prevent prompt injection attacks on LLMs and generative AI.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.73",name:"AI content authenticity",category:"Policy & Governance",description:"Mark and verify authenticity of AI-generated content.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.74",name:"Deepfake detection",category:"Network Security",description:"Detect and prevent malicious use of deepfakes.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.75",name:"AI crisis management",category:"Incident Management",description:"Prepare for and respond to AI-related crises and emergencies.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.76",name:"AI insurance & liability",category:"Compliance",description:"Address insurance and liability considerations for AI systems.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.77",name:"AI innovation balance",category:"Policy & Governance",description:"Balance innovation with responsible AI practices and risk management.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.78",name:"AI system scalability",category:"Policy & Governance",description:"Ensure AI systems can scale while maintaining performance and safety.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.79",name:"Real-time AI monitoring",category:"Logging & Monitoring",description:"Monitor AI systems in real-time for anomalies and failures.",frameworks:["ISO 42001"]},
            {id:"ISO42-A.80",name:"AI whistleblower protection",category:"Policy & Governance",description:"Protect whistleblowers reporting AI safety or ethics concerns.",frameworks:["ISO 42001"]}
        ];
    }
    
    // ==================== GRC PROJECTS ====================
    renderProjects() {
        const c = document.getElementById('tab-projects');
        const projects = this.getProjectScenarios();
        
        // Calculate overall stats
        let totalCompleted = 0;
        let totalInProgress = 0;
        projects.forEach(p => {
            const prog = this.getProjectProgress(p.id);
            if (prog.percent === 100) totalCompleted++;
            else if (prog.started || prog.percent > 0) totalInProgress++;
        });
        
        c.innerHTML = `
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-briefcase-fill"></i> GRC Practice Projects</h2>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">Complete real-world GRC scenarios to build your skills and portfolio. Each project simulates enterprise challenges across different industries and frameworks.</p>
                
                <div style="display: flex; gap: 16px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-md);">
                        <span style="font-size: 20px; font-weight: 700; color: var(--accent-blue);">${projects.length}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Total Projects</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-md);">
                        <span style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${totalInProgress}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">In Progress</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-md);">
                        <span style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${totalCompleted}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Completed</span>
                    </div>
                </div>
            </div>
            
            <div class="projects-grid">
                ${projects.map(p => this.renderProjectCard(p)).join('')}
            </div>`;
    }
    
    renderProjectCard(p) {
        const progress = this.getProjectProgress(p.id);
        const statusClass = progress.percent === 100 ? 'green' : (progress.started || progress.percent > 0) ? 'amber' : 'blue';
        const self = this;
        
        return `
            <div class="project-card">
                <div class="project-card-header" style="border-left: 4px solid var(--accent-${statusClass});">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div class="project-card-icon" style="background: var(--accent-${statusClass}-soft); color: var(--accent-${statusClass});">
                            <i class="bi bi-building"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="project-card-title">${this.esc(p.company)}</div>
                            <div class="project-card-subtitle">${p.industry}</div>
                        </div>
                        <span class="badge badge-${statusClass}">${progress.percent}%</span>
                    </div>
                    <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">${this.esc(p.scenario)}</div>
                </div>
                
                <div class="project-card-body">
                    <div class="project-card-meta">
                        <span class="project-card-meta-item"><i class="bi bi-people"></i> ${p.size}</span>
                        <span class="project-card-meta-item"><i class="bi bi-check2-square"></i> ${progress.completed}/${progress.total} tasks</span>
                    </div>
                    
                    <div class="project-description-wrapper" id="desc-${p.id}">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.6;">${this.esc(p.description)}</p>
                    </div>
                    
                    <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px;">
                        ${p.frameworks.map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="font-size: 10px;">${fw}</span>`).join('')}
                    </div>
                    
                    <div class="project-card-tasks">
                        ${p.tasks.slice(0, 3).map(t => {
                            const isComplete = self.checkTaskComplete(p.id, t);
                            return `
                                <div class="project-card-task ${isComplete ? 'complete' : 'incomplete'}">
                                    <i class="bi ${isComplete ? 'bi-check-circle-fill' : 'bi-circle'}"></i>
                                    <span style="${isComplete ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${t.label}</span>
                                </div>
                            `;
                        }).join('')}
                        ${p.tasks.length > 3 ? `<div style="font-size: 11px; color: var(--text-muted); padding: 4px 0;">+${p.tasks.length - 3} more tasks</div>` : ''}
                    </div>
                </div>
                
                <div class="project-card-footer">
                    <div class="project-card-progress">
                        <div class="project-card-progress-text">
                            <span>Progress</span>
                            <span>${progress.percent}%</span>
                        </div>
                        <div class="progress-bar" style="height: 6px;">
                            <div class="progress-fill ${statusClass}" style="width: ${progress.percent}%;"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        ${progress.started ? `
                            <button class="btn btn-secondary btn-sm" onclick="app.resetProject('${p.id}')" title="Reset project progress and data">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-primary btn-sm" onclick="app.startProject('${p.id}')">
                            <i class="bi bi-${progress.started ? 'arrow-right' : 'play-fill'}"></i> 
                            ${progress.percent === 100 ? 'Review' : progress.started ? 'Continue' : 'Start'}
                        </button>
                    </div>
                </div>
            </div>`;
    }
    
    getProjectScenarios() {
        const self = this;
        return [
            {
                id: 'iso-risk-assessment', company: 'TechStart Inc', industry: 'SaaS / Cloud Services', size: '500 employees',
                location: 'San Francisco, CA, USA', region: 'North America',
                scenario: 'ISO 27001 Risk Assessment for Cloud Migration',
                description: 'TechStart Inc, a B2B SaaS company, is migrating their customer database containing 5M+ records from on-premises to AWS. They are pursuing ISO 27001:2022 certification to meet enterprise client requirements. As GRC Analyst, identify critical assets, assess migration risks, and implement security controls aligned with Annex A.',
                frameworks: ['ISO 27001', 'NIST CSF'],
                tasks: [
                    { id: 'assets', label: 'Add 3 critical assets', tab: 'assets', required: 3, type: 'assets' },
                    { id: 'risks', label: 'Identify 5 risks', tab: 'risks', required: 5, type: 'risks' },
                    { id: 'controls', label: 'Implement 5 controls', tab: 'controls', required: 5, type: 'controls' },
                    { id: 'treatments', label: 'Create 5 treatments', tab: 'treatments', required: 5, type: 'treatments' }
                ]
            },
            {
                id: 'vendor-tprm', company: 'FinSecure Banking', industry: 'Financial Services', size: '1,200 employees',
                location: 'New York, NY, USA', region: 'North America',
                scenario: 'Third-Party Risk Management for Payment Processor',
                description: 'FinSecure Banking is integrating a third-party payment processor with direct access to cardholder data environments. Subject to OCC regulations and PCI DSS requirements, the bank must conduct thorough vendor due diligence. As TPRM Lead, assess the vendor\'s security posture and verify SOC 2 Type II attestation.',
                frameworks: ['PCI DSS', 'SOC 2'],
                tasks: [
                    { id: 'vendor', label: 'Add vendor profile', tab: 'vendors', required: 1, type: 'vendors' },
                    { id: 'risks', label: 'Assess 4 vendor risks', tab: 'risks', required: 4, type: 'risks' },
                    { id: 'controls', label: 'Verify 6 controls', tab: 'controls', required: 6, type: 'controls' },
                    { id: 'issues', label: 'Document 3 issues', tab: 'issues', required: 3, type: 'issues' }
                ]
            },
            {
                id: 'soc2-audit', company: 'DataFlow Analytics', industry: 'Data Analytics Platform', size: '300 employees',
                location: 'Austin, TX, USA', region: 'North America',
                scenario: 'SOC 2 Type II Audit Preparation',
                description: 'DataFlow Analytics provides AI-powered business intelligence to Fortune 500 clients. Their enterprise customers now require SOC 2 Type II attestation as a contractual obligation. As Compliance Manager, document controls against Trust Services Criteria and prepare for the audit observation period.',
                frameworks: ['SOC 2', 'NIST CSF'],
                tasks: [
                    { id: 'controls', label: 'Document 12 SOC 2 controls', tab: 'controls', required: 12, type: 'controls' },
                    { id: 'assets', label: 'Catalog 4 systems', tab: 'assets', required: 4, type: 'assets' },
                    { id: 'evidence', label: 'Collect 5 evidence items', tab: 'evidence', required: 5, type: 'evidence' },
                    { id: 'testing', label: 'Complete 4 control tests', tab: 'testing', required: 4, type: 'controlTests' }
                ]
            },
            {
                id: 'gdpr-compliance', company: 'EuroShop GmbH', industry: 'E-commerce', size: '800 employees',
                location: 'Berlin, Germany', region: 'European Union',
                scenario: 'GDPR Compliance Program Implementation',
                description: 'EuroShop GmbH is expanding e-commerce operations across all 27 EU member states. Processing personal data for 3M+ customers, they must comply with GDPR requirements. As Data Protection Officer, map data processing activities, conduct DPIAs, and establish DSAR response procedures.',
                frameworks: ['GDPR', 'ISO 27001'],
                tasks: [
                    { id: 'assets', label: 'Map 5 data processing assets', tab: 'assets', required: 5, type: 'assets' },
                    { id: 'risks', label: 'Assess 6 privacy risks', tab: 'risks', required: 6, type: 'risks' },
                    { id: 'controls', label: 'Implement 10 controls', tab: 'controls', required: 10, type: 'controls' },
                    { id: 'policies', label: 'Create 3 policies', tab: 'policies', required: 3, type: 'policies' }
                ]
            },
            {
                id: 'incident-response', company: 'HealthTech Systems', industry: 'Healthcare Technology', size: '600 employees',
                location: 'Boston, MA, USA', region: 'North America',
                scenario: 'Incident Response Program Development',
                description: 'HealthTech Systems provides EHR systems to 200+ hospitals, storing PHI for over 2 million patients. Subject to HIPAA Security Rule requirements, they must establish formal incident response procedures. As Security Operations Manager, develop IR playbooks and ensure HHS breach notification compliance.',
                frameworks: ['HIPAA', 'NIST CSF'],
                tasks: [
                    { id: 'incidents', label: 'Document 3 incident scenarios', tab: 'incidents', required: 3, type: 'incidents' },
                    { id: 'controls', label: 'Define 8 IR controls', tab: 'controls', required: 8, type: 'controls' },
                    { id: 'assets', label: 'Identify 4 critical systems', tab: 'assets', required: 4, type: 'assets' },
                    { id: 'tasks', label: 'Create 5 response tasks', tab: 'tasks', required: 5, type: 'tasks' }
                ]
            },
            {
                id: 'cloud-security', company: 'CloudNative Corp', industry: 'Cloud Infrastructure', size: '400 employees',
                location: 'Seattle, WA, USA', region: 'North America',
                scenario: 'AWS Security Assessment and Hardening',
                description: 'CloudNative Corp operates AWS infrastructure for 50+ enterprise clients, managing over $15M in annual cloud spend. A recent audit revealed critical misconfigurations including public S3 buckets and overly permissive IAM policies. As Cloud Security Engineer, conduct a CIS AWS Benchmark assessment and create a security hardening roadmap.',
                frameworks: ['CIS Controls', 'NIST CSF'],
                tasks: [
                    { id: 'assets', label: 'Inventory 6 cloud assets', tab: 'assets', required: 6, type: 'assets' },
                    { id: 'findings', label: 'Document 5 findings', tab: 'findings', required: 5, type: 'findings' },
                    { id: 'risks', label: 'Assess 4 cloud risks', tab: 'risks', required: 4, type: 'risks' },
                    { id: 'controls', label: 'Implement 10 controls', tab: 'controls', required: 10, type: 'controls' }
                ]
            },
            {
                id: 'bcdr-planning', company: 'CriticalOps Inc', industry: 'Critical Infrastructure', size: '900 employees',
                location: 'Houston, TX, USA', region: 'North America',
                scenario: 'Business Continuity & Disaster Recovery Planning',
                description: 'CriticalOps Inc operates SCADA systems for water treatment facilities and power grid substations serving 10M+ citizens. Classified as critical infrastructure under CISA guidelines, they must maintain operational resilience. As Business Continuity Manager, conduct Business Impact Analysis and define RTO/RPO requirements.',
                frameworks: ['COBIT', 'ISO 27001'],
                tasks: [
                    { id: 'assets', label: 'Identify 5 critical assets', tab: 'assets', required: 5, type: 'assets' },
                    { id: 'risks', label: 'Assess 4 continuity risks', tab: 'risks', required: 4, type: 'risks' },
                    { id: 'controls', label: 'Document 8 BC controls', tab: 'controls', required: 8, type: 'controls' },
                    { id: 'audits', label: 'Plan 2 BC exercises', tab: 'audits', required: 2, type: 'audits' }
                ]
            },
            {
                id: 'compliance-gap', company: 'RegTech Solutions', industry: 'Regulatory Technology', size: '350 employees',
                location: 'Chicago, IL, USA', region: 'North America',
                scenario: 'Multi-Framework Compliance Gap Analysis',
                description: 'RegTech Solutions provides compliance automation software to clients in healthcare, financial services, and retail payments. Their platform must meet PCI DSS v4.0, SOC 2 Type II, and HIPAA requirements simultaneously. As Compliance Architect, perform gap analysis and create a prioritized remediation roadmap.',
                frameworks: ['PCI DSS', 'SOC 2', 'HIPAA'],
                tasks: [
                    { id: 'controls', label: 'Assess 15 controls', tab: 'controls', required: 15, type: 'controls' },
                    { id: 'issues', label: 'Identify 5 gaps', tab: 'issues', required: 5, type: 'issues' },
                    { id: 'treatments', label: 'Plan 5 remediations', tab: 'treatments', required: 5, type: 'treatments' },
                    { id: 'audits', label: 'Schedule 2 audits', tab: 'audits', required: 2, type: 'audits' }
                ]
            },
            {
                id: 'zero-trust', company: 'SecureBank Digital', industry: 'Digital Banking', size: '750 employees',
                location: 'Charlotte, NC, USA', region: 'North America',
                scenario: 'Zero Trust Architecture Implementation',
                description: 'SecureBank Digital, a challenger bank headquartered in Charlotte\'s financial district, offers mobile-first banking services to 500K+ customers across the US. Following high-profile breaches at competitor institutions and new FFIEC guidance on authentication, the board has mandated a Zero Trust transformation. As Security Architect, assess the current perimeter-based security model, design identity-centric access controls using NIST SP 800-207 principles, implement microsegmentation for the core banking platform, deploy continuous verification mechanisms, and establish metrics to measure Zero Trust maturity.',
                frameworks: ['NIST CSF', 'CIS Controls'],
                tasks: [
                    { id: 'assets', label: 'Map 6 critical assets', tab: 'assets', required: 6, type: 'assets' },
                    { id: 'risks', label: 'Assess 5 access risks', tab: 'risks', required: 5, type: 'risks' },
                    { id: 'controls', label: 'Implement 12 ZT controls', tab: 'controls', required: 12, type: 'controls' },
                    { id: 'policies', label: 'Create 4 ZT policies', tab: 'policies', required: 4, type: 'policies' }
                ]
            },
            {
                id: 'ai-governance', company: 'MindfulAI Labs', industry: 'Artificial Intelligence', size: '200 employees',
                location: 'Toronto, ON, Canada', region: 'North America',
                scenario: 'AI Governance & ISO 42001 Implementation',
                description: 'MindfulAI Labs, headquartered in Toronto\'s tech hub, develops machine learning models for healthcare diagnostics and financial risk scoring, serving clients across Canada and the EU. With the EU AI Act classifying their healthcare models as "high-risk AI systems" and Canada\'s AIDA on the horizon, they need robust AI governance. As AI Governance Lead, implement an AI Management System aligned with ISO/IEC 42001:2023, document model risk assessments including bias and fairness testing, establish human oversight mechanisms for automated decisions, create an AI asset inventory with lifecycle tracking, and develop policies for responsible AI development and deployment.',
                frameworks: ['ISO 42001', 'NIST AI RMF'],
                tasks: [
                    { id: 'assets', label: 'Inventory 5 AI systems', tab: 'assets', required: 5, type: 'assets' },
                    { id: 'risks', label: 'Assess 6 AI risks', tab: 'risks', required: 6, type: 'risks' },
                    { id: 'controls', label: 'Implement 10 AI controls', tab: 'controls', required: 10, type: 'controls' },
                    { id: 'policies', label: 'Create 4 AI policies', tab: 'policies', required: 4, type: 'policies' }
                ]
            },
            {
                id: 'supply-chain', company: 'GlobalParts Manufacturing', industry: 'Manufacturing', size: '2,500 employees',
                location: 'Detroit, MI, USA', region: 'North America',
                scenario: 'Supply Chain Security & CMMC Compliance',
                description: 'GlobalParts Manufacturing, headquartered in Detroit with production facilities across Michigan and Ohio, is a Tier 2 supplier to major defense contractors, producing precision components for military vehicles and aircraft. To maintain DoD contracts worth $50M annually, they must achieve CMMC Level 2 certification protecting Controlled Unclassified Information (CUI). As Compliance Manager, assess current security posture against 110 NIST SP 800-171 practices, implement controls for CUI handling and marking, secure the supply chain including sub-tier suppliers, prepare System Security Plan (SSP) documentation, and coordinate with the CMMC Third-Party Assessment Organization (C3PAO).',
                frameworks: ['CMMC', 'NIST 800-171'],
                tasks: [
                    { id: 'assets', label: 'Identify 6 CUI systems', tab: 'assets', required: 6, type: 'assets' },
                    { id: 'controls', label: 'Implement 14 CMMC controls', tab: 'controls', required: 14, type: 'controls' },
                    { id: 'vendors', label: 'Assess 3 suppliers', tab: 'vendors', required: 3, type: 'vendors' },
                    { id: 'evidence', label: 'Collect 6 evidence items', tab: 'evidence', required: 6, type: 'evidence' }
                ]
            },
            {
                id: 'privacy-program', company: 'ConsumerFirst Retail', industry: 'Retail & E-commerce', size: '5,000 employees',
                location: 'Los Angeles, CA, USA', region: 'North America (with EU operations)',
                scenario: 'Global Privacy Program & CCPA/GDPR Compliance',
                description: 'ConsumerFirst Retail, a lifestyle brand headquartered in Los Angeles with 150 stores across the US and an e-commerce platform serving customers in 40 countries including the EU, processes personal data for 8M+ customers including behavioral analytics, purchase history, and loyalty program data. Subject to CCPA/CPRA in California, state privacy laws in Virginia, Colorado, and Connecticut, plus GDPR for EU customers, they need a unified privacy program. As Privacy Program Manager, conduct a comprehensive data inventory and mapping exercise, implement consent management across jurisdictions, establish data subject request workflows meeting varying response timelines (45 days CCPA, 30 days GDPR), deploy privacy impact assessments for new marketing initiatives, and create a cross-border data transfer framework using SCCs and binding corporate rules.',
                frameworks: ['GDPR', 'CCPA', 'ISO 27701'],
                tasks: [
                    { id: 'assets', label: 'Map 8 data processing activities', tab: 'assets', required: 8, type: 'assets' },
                    { id: 'risks', label: 'Assess 5 privacy risks', tab: 'risks', required: 5, type: 'risks' },
                    { id: 'policies', label: 'Create 5 privacy policies', tab: 'policies', required: 5, type: 'policies' },
                    { id: 'controls', label: 'Implement 8 privacy controls', tab: 'controls', required: 8, type: 'controls' }
                ]
            }
        ];
    }
    
    checkTaskComplete(projectId, task) {
        const pData = this.getProjectData(projectId);
        return pData[task.type]?.length >= task.required;
    }
    
    getProjectProgress(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return { completed: 0, total: 0, percent: 0, started: false };
        const pData = this.getProjectData(projectId);
        const completed = project.tasks.filter(t => this.checkTaskComplete(projectId, t)).length;
        const total = project.tasks.length;
        const progressUnits = project.tasks.reduce((sum, t) => {
            const current = Array.isArray(pData[t.type]) ? pData[t.type].length : 0;
            const required = Math.max(parseInt(t.required, 10) || 1, 1);
            return sum + Math.min(current / required, 1);
        }, 0);
        const hasTaskData = project.tasks.some(t => (Array.isArray(pData[t.type]) ? pData[t.type].length : 0) > 0);
        const started = this.activeProject === projectId || hasTaskData;
        const percent = total > 0 ? Math.round((progressUnits / total) * 100) : 0;
        return { completed, total, percent, started };
    }
    
    startProject(projectId) {
        // Enter project mode first
        this.enterProjectMode(projectId);
        
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (project && project.tasks.length > 0) {
            const firstIncomplete = project.tasks.find(t => !this.checkTaskComplete(projectId, t));
            if (firstIncomplete) {
                this.switchTab(firstIncomplete.tab);
                this.toast(`Started "${project.company}" - Complete: ${firstIncomplete.label}`, 'info');
            } else {
                const reviewTab = project.tasks[0]?.tab || 'dashboard';
                this.switchTab(reviewTab);
                this.toast(`"${project.company}" already complete - review or reset to practice again.`, 'info');
            }
        }
    }
    
    resetProject(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) {
            this.toast('Project not found', 'error');
            return;
        }
        if (!confirm(`Reset "${project.company}" and clear all project data? This cannot be undone.`)) return;
        
        this.projectData[projectId] = this.createEmptyDataStore();
        this.saveProjectData();
        
        if (this.portfolioEvidence?.[projectId]) delete this.portfolioEvidence[projectId];
        if (this.portfolioNotes?.[projectId]) delete this.portfolioNotes[projectId];
        
        if (this.activeProject === projectId) {
            this.activeProject = null;
            this.switchTab('projects');
        } else {
            this.updateAllBadges();
            if (this.currentTab === 'projects') this.renderProjects();
        }
        
        this.toast(`Project reset: ${project.company}`, 'success');
    }
    
    // ==================== PORTFOLIO BUILDER ====================
    renderPortfolio() {
        const c = document.getElementById('tab-portfolio');
        const projects = this.getProjectScenarios();
        const selectedProject = this.selectedPortfolioProject || null;
        this.portfolioEvidence = this.portfolioEvidence || {};
        this.portfolioNotes = this.portfolioNotes || {};
        this.portfolioProfile = this.portfolioProfile || {};
        
        // Calculate total stats across all projects
        let totalStats = { assets: 0, risks: 0, controls: 0, vendors: 0, audits: 0, evidence: 0, projectsCompleted: 0, totalEvidence: 0 };
        projects.forEach(p => {
            const pd = this.getProjectData(p.id);
            totalStats.assets += pd.assets.length;
            totalStats.risks += pd.risks.length;
            totalStats.controls += pd.controls.length;
            totalStats.vendors += pd.vendors.length;
            totalStats.totalEvidence += (this.portfolioEvidence[p.id] || []).length;
            if (this.getProjectProgress(p.id).percent === 100) totalStats.projectsCompleted++;
        });
        
        c.innerHTML = `
            <style>
                @keyframes portfolio-gradient { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
                @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }
                .portfolio-hero { background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 25%, #312e81 50%, #4c1d95 75%, #1e3a5f 100%); background-size: 300% 300%; animation: portfolio-gradient 12s ease infinite; border-radius: var(--radius-xl); padding: 40px; position: relative; overflow: hidden; margin-bottom: 24px; }
                .portfolio-hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); opacity: 0.5; }
                .portfolio-hero-content { position: relative; z-index: 1; }
                .portfolio-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 6px 14px; border-radius: 20px; font-size: 12px; color: white; font-weight: 500; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.2); }
                .portfolio-title { font-size: 32px; font-weight: 800; color: white; margin-bottom: 12px; line-height: 1.2; }
                .portfolio-subtitle { font-size: 16px; color: rgba(255,255,255,0.8); max-width: 600px; line-height: 1.6; margin-bottom: 24px; }
                .portfolio-stats-row { display: flex; gap: 32px; flex-wrap: wrap; }
                .portfolio-stat { text-align: left; }
                .portfolio-stat-value { font-size: 28px; font-weight: 700; color: white; }
                .portfolio-stat-label { font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; }
                .share-btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 24px; }
                .share-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: var(--radius-lg); font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; position: relative; overflow: hidden; }
                .share-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
                .share-btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: 0.5s; }
                .share-btn:hover::after { animation: shine 0.75s; }
                .share-btn-github { background: #24292e; color: white; }
                .share-btn-linkedin { background: #0077b5; color: white; }
                .share-btn-download { background: linear-gradient(135deg, #10b981, #059669); color: white; }
                .share-btn-preview { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); }
                .share-btn-link { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
                .project-card-portfolio { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); overflow: hidden; transition: all 0.2s; cursor: pointer; }
                .project-card-portfolio:hover { border-color: var(--accent-blue); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
                .project-card-portfolio.selected { border-color: var(--accent-blue); box-shadow: 0 0 0 3px var(--accent-blue-soft); }
                .evidence-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
                .evidence-thumb { aspect-ratio: 16/10; background: var(--bg-elevated); border-radius: var(--radius-md); overflow: hidden; position: relative; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
                .evidence-thumb:hover { border-color: var(--accent-blue); transform: scale(1.02); }
                .evidence-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .evidence-thumb-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); gap: 4px; }
                .evidence-add-btn { border: 2px dashed var(--border-default); background: transparent; }
                .evidence-add-btn:hover { border-color: var(--accent-blue); background: var(--accent-blue-soft); }
                .rationale-card { background: linear-gradient(135deg, var(--accent-purple-soft), var(--accent-blue-soft)); border-radius: var(--radius-lg); padding: 20px; margin-top: 16px; }
                .tab-pills { display: flex; gap: 4px; background: var(--bg-elevated); padding: 4px; border-radius: var(--radius-md); margin-bottom: 20px; }
                .tab-pill { flex: 1; padding: 10px 16px; border: none; background: transparent; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--text-secondary); }
                .tab-pill.active { background: var(--bg-surface); color: var(--text-primary); box-shadow: var(--shadow-sm); }
                .metric-ring { width: 80px; height: 80px; position: relative; }
                .metric-ring svg { transform: rotate(-90deg); }
                .metric-ring-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700; }
                .profile-card { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 24px; }
                .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; font-weight: 700; cursor: pointer; transition: all 0.2s; border: 3px solid var(--bg-surface); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
                .profile-avatar:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
                .profile-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
                .profile-input { background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 10px 14px; font-size: 14px; width: 100%; transition: all 0.2s; color: var(--text-primary); }
                .profile-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px var(--accent-blue-soft); }
                .profile-input::placeholder { color: var(--text-muted); }
                .share-modal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 20px; }
                .share-option-card { background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; }
                .share-option-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); background: var(--bg-surface); }
                .share-option-icon { width: 56px; height: 56px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 24px; }
                .theme-selector { display: flex; gap: 12px; margin-top: 16px; }
                .theme-option { width: 60px; height: 40px; border-radius: var(--radius-md); cursor: pointer; border: 3px solid transparent; transition: all 0.2s; position: relative; overflow: hidden; }
                .theme-option.active { border-color: var(--accent-blue); }
                .theme-option:hover { transform: scale(1.05); }
            </style>
            
            <!-- Hero Section -->
            <div class="portfolio-hero">
                <div class="portfolio-hero-content">
                    <div class="portfolio-badge">
                        <i class="bi bi-patch-check-fill"></i>
                        Built for GRC Professionals
                    </div>
                    <h1 class="portfolio-title">A hands-on GRC portfolio designed to show how you think<br>— not just what you know.</h1>
                    <p class="portfolio-subtitle">
                        Explore real-world governance, risk, and compliance scenarios with documented decisions, risk tradeoffs, and implementation logic. Created for professionals building practical readiness for GRC roles, not just collecting credentials.
                    </p>
                    <div class="portfolio-stats-row">
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-value">${totalStats.projectsCompleted}</div>
                            <div class="portfolio-stat-label">Projects Completed</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-value">${totalStats.risks}</div>
                            <div class="portfolio-stat-label">Risks Assessed</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-value">${totalStats.controls}</div>
                            <div class="portfolio-stat-label">Controls Implemented</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="portfolio-stat-value">${totalStats.totalEvidence}</div>
                            <div class="portfolio-stat-label">Evidence Items</div>
                        </div>
                    </div>
                    <div class="share-btn-group">
                        <button class="share-btn share-btn-link" onclick="app.openShareModal()">
                            <i class="bi bi-share-fill"></i> Share Portfolio
                        </button>
                        <button class="share-btn share-btn-github" onclick="app.exportToGitHub()">
                            <i class="bi bi-github"></i> Export to GitHub
                        </button>
                        <button class="share-btn share-btn-linkedin" onclick="app.shareToLinkedIn()">
                            <i class="bi bi-linkedin"></i> Share on LinkedIn
                        </button>
                        <button class="share-btn share-btn-download" onclick="app.downloadPortfolio()">
                            <i class="bi bi-download"></i> Download
                        </button>
                        <button class="share-btn share-btn-preview" onclick="app.previewPortfolio()">
                            <i class="bi bi-eye"></i> Preview
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-pills">
                <button class="tab-pill ${this.portfolioTab !== 'evidence' ? 'active' : ''}" onclick="app.setPortfolioTab('projects')">
                    <i class="bi bi-briefcase"></i> Projects & Bullets
                </button>
                <button class="tab-pill ${this.portfolioTab === 'evidence' ? 'active' : ''}" onclick="app.setPortfolioTab('evidence')">
                    <i class="bi bi-images"></i> Evidence Gallery
                </button>
            </div>
            
            ${this.portfolioTab === 'evidence' ? this.renderEvidenceGalleryTab() : `
            <!-- Main Layout -->
            <div style="display: grid; grid-template-columns: 340px 1fr; gap: 24px; align-items: start;">
                
                <!-- Left Sidebar - Project List -->
                <div>
                    <div class="card" style="position: sticky; top: 20px;">
                        <div class="card-header" style="padding: 16px; border-bottom: 1px solid var(--border-subtle);">
                            <div>
                                <span style="font-weight: 600; font-size: 14px;">Your Projects</span>
                                <div style="font-size: 12px; color: var(--text-muted);">Select to view details</div>
                            </div>
                            <span class="badge badge-green" style="font-size: 11px;">${totalStats.projectsCompleted} Complete</span>
                        </div>
                        <div style="max-height: 520px; overflow-y: auto;">
                            ${projects.map(p => {
                                const progress = this.getProjectProgress(p.id);
                                const isSelected = selectedProject === p.id;
                                const pData = this.getProjectData(p.id);
                                const hasData = pData.assets.length > 0 || pData.risks.length > 0 || pData.controls.length > 0;
                                const evidenceCount = (this.portfolioEvidence[p.id] || []).length;
                                return `
                                    <div onclick="app.selectPortfolioProject('${p.id}')" 
                                         class="project-card-portfolio ${isSelected ? 'selected' : ''}"
                                         style="padding: 16px; margin: 8px; border-radius: var(--radius-md);">
                                        <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">${p.company}</div>
                                                <div style="font-size: 12px; color: var(--text-muted); line-height: 1.4;">${p.scenario}</div>
                                            </div>
                                            <div class="metric-ring" style="width: 48px; height: 48px; flex-shrink: 0; margin-left: 12px;">
                                                <svg width="48" height="48" viewBox="0 0 48 48">
                                                    <circle cx="24" cy="24" r="20" fill="none" stroke="var(--bg-elevated)" stroke-width="4"/>
                                                    <circle cx="24" cy="24" r="20" fill="none" stroke="${progress.percent === 100 ? 'var(--accent-green)' : progress.percent > 0 ? 'var(--accent-amber)' : 'var(--border-default)'}" stroke-width="4" stroke-dasharray="${progress.percent * 1.256} 125.6" stroke-linecap="round"/>
                                                </svg>
                                                <div class="metric-ring-value" style="font-size: 11px;">${progress.percent}%</div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                                            ${p.frameworks.slice(0, 2).map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="font-size: 10px;">${fw}</span>`).join('')}
                                            ${evidenceCount > 0 ? `<span class="badge" style="font-size: 10px; background: var(--accent-purple-soft); color: var(--accent-purple);"><i class="bi bi-image"></i> ${evidenceCount}</span>` : ''}
                                            ${!hasData ? '<span class="badge" style="font-size: 10px; background: var(--bg-elevated);">Not Started</span>' : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Right Content - Portfolio Details -->
                <div>
                    ${selectedProject ? this.renderPortfolioContent(selectedProject) : `
                        <div class="card" style="min-height: 500px; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center; padding: 60px; max-width: 400px;">
                                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--accent-blue-soft), var(--accent-purple-soft)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                                    <i class="bi bi-folder2-open" style="font-size: 40px; color: var(--accent-blue);"></i>
                                </div>
                                <h3 style="font-size: 20px; margin-bottom: 12px;">Select a Project</h3>
                                <p style="color: var(--text-muted); font-size: 14px; line-height: 1.6; margin-bottom: 24px;">
                                    Choose a project from the list to view resume bullet points, add evidence screenshots, and generate professional portfolio content.
                                </p>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button class="btn btn-primary" onclick="app.switchTab('projects')">
                                        <i class="bi bi-play-fill"></i> Start a Project
                                    </button>
                                    <button class="btn btn-secondary" onclick="app.loadDemo()">
                                        <i class="bi bi-lightning"></i> Load Demo
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            </div>
            `}
            
            <!-- Skills & Frameworks Summary -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600;"><i class="bi bi-stars"></i> Skills & Frameworks Demonstrated</span>
                </div>
                <div class="card-body" style="padding: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${['Risk Assessment', 'Control Testing', 'Audit Support', 'Compliance Management', 'Vendor Risk', 'Incident Response', 'Policy Development', 'Cloud Security', 'Data Privacy', 'Security Architecture'].map(s => `<span class="badge" style="padding: 8px 14px; background: var(--bg-elevated); font-size: 13px;">${s}</span>`).join('')}
                    </div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle); display: flex; flex-wrap: wrap; gap: 10px;">
                        ${['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR', 'CMMC', 'CIS Controls', 'COBIT'].map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="padding: 8px 14px; font-size: 13px;">${fw}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    setPortfolioTab(tab) {
        this.portfolioTab = tab;
        this.renderPortfolio();
    }
    
    renderEvidenceGalleryTab() {
        const projects = this.getProjectScenarios();
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600;"><i class="bi bi-images"></i> Evidence Gallery</span>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('bulk-evidence-upload').click()">
                        <i class="bi bi-cloud-upload"></i> Upload Evidence
                    </button>
                    <input type="file" id="bulk-evidence-upload" accept="image/*" multiple style="display: none;" onchange="app.handleBulkEvidenceUpload(event)">
                </div>
                <div class="card-body" style="padding: 20px;">
                    <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 24px;">
                        Upload screenshots and evidence from your GRC work. These will be included in your shareable portfolio and GitHub export.
                    </p>
                    
                    ${projects.map(p => {
                        const evidence = this.portfolioEvidence[p.id] || [];
                        const progress = this.getProjectProgress(p.id);
                        if (progress.percent === 0) return '';
                        return `
                            <div style="margin-bottom: 32px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <div>
                                        <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 2px;">${p.company}</h4>
                                        <div style="font-size: 12px; color: var(--text-muted);">${p.scenario}</div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('evidence-upload-${p.id}').click()">
                                        <i class="bi bi-plus"></i> Add Evidence
                                    </button>
                                    <input type="file" id="evidence-upload-${p.id}" accept="image/*" multiple style="display: none;" onchange="app.handleEvidenceUpload(event, '${p.id}')">
                                </div>
                                <div class="evidence-gallery">
                                    ${evidence.map((ev, idx) => `
                                        <div class="evidence-thumb" onclick="app.viewEvidence('${p.id}', ${idx})">
                                            <img src="${ev.data}" alt="${ev.name}">
                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 8px; color: white; font-size: 10px;">
                                                ${ev.name.substring(0, 20)}${ev.name.length > 20 ? '...' : ''}
                                            </div>
                                            <button onclick="event.stopPropagation(); app.deleteEvidence('${p.id}', ${idx})" style="position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                    <div class="evidence-thumb evidence-add-btn" onclick="document.getElementById('evidence-upload-${p.id}').click()">
                                        <div class="evidence-thumb-placeholder">
                                            <i class="bi bi-plus-lg" style="font-size: 24px;"></i>
                                            <span style="font-size: 11px;">Add Screenshot</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') || '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Start a project to begin adding evidence.</p>'}
                </div>
            </div>
        `;
    }
    
    // Portfolio Profile Methods
    uploadAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            if (!this.portfolioProfile) this.portfolioProfile = {};
            this.portfolioProfile.avatar = e.target.result;
            this.renderPortfolio();
            this.toast('Profile photo updated!', 'success');
        };
        reader.readAsDataURL(file);
    }
    
    updateProfile(field, value) {
        if (!this.portfolioProfile) this.portfolioProfile = {};
        this.portfolioProfile[field] = value;
    }
    
    openShareModal() {
        const projects = this.getProjectScenarios();
        let completedCount = 0;
        let totalRisks = 0;
        let totalControls = 0;
        
        projects.forEach(p => {
            const progress = this.getProjectProgress(p.id);
            const pData = this.getProjectData(p.id);
            if (progress.percent > 0) {
                completedCount++;
                totalRisks += pData.risks.length;
                totalControls += pData.controls.length;
            }
        });
        
        const profileName = this.portfolioProfile?.name || 'GRC Professional';
        const avatarHtml = this.portfolioProfile?.avatar 
            ? '<img src="' + this.portfolioProfile.avatar + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">'
            : profileName.charAt(0).toUpperCase();
        
        openModal('Share Your Portfolio', `
            <div style="padding: 10px;">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="width: 72px; height: 72px; margin: 0 auto 12px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; font-weight: 700;">
                        ${avatarHtml}
                    </div>
                    <h3 style="font-size: 18px; margin-bottom: 4px;">${profileName}'s GRC Portfolio</h3>
                    <p style="color: var(--text-muted); font-size: 13px;">${completedCount} projects • ${totalRisks} risks assessed • ${totalControls} controls</p>
                </div>
                
                <div class="share-modal-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div class="share-option-card" onclick="closeModal(); app.exportToGitHub()" style="background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 48px; height: 48px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 22px; background: #24292e; color: white;">
                            <i class="bi bi-github"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">GitHub Repository</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Export README + evidence</div>
                    </div>
                    
                    <div class="share-option-card" onclick="closeModal(); app.shareToLinkedIn()" style="background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 48px; height: 48px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 22px; background: #0077b5; color: white;">
                            <i class="bi bi-linkedin"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">LinkedIn Post</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Share accomplishments</div>
                    </div>
                    
                    <div class="share-option-card" onclick="closeModal(); app.downloadPortfolio()" style="background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 48px; height: 48px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 22px; background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            <i class="bi bi-file-earmark-code"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">Download HTML</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Standalone portfolio page</div>
                    </div>
                    
                    <div class="share-option-card" onclick="closeModal(); app.downloadPortfolioPDF()" style="background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 48px; height: 48px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 22px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                            <i class="bi bi-file-pdf"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">Print / PDF</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Print-friendly version</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, var(--accent-blue-soft), var(--accent-purple-soft)); border-radius: var(--radius-lg);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="bi bi-lightbulb-fill" style="color: var(--accent-amber);"></i>
                        <span style="font-weight: 600; font-size: 13px;">Pro Tip for Job Applications</span>
                    </div>
                    <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                        Export to GitHub and add the link to your resume. Hiring managers love seeing real project work with evidence and clear decision rationale. It sets you apart from candidates who only list certifications.
                    </p>
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        `);
    }
    
    downloadPortfolioPDF() {
        // Generate a print-friendly version and trigger print dialog
        const projects = this.getProjectScenarios();
        const profileName = this.portfolioProfile?.name || 'GRC Professional';
        const role = this.portfolioProfile?.role || 'GRC Professional';
        const email = this.portfolioProfile?.email || '';
        const linkedin = this.portfolioProfile?.linkedin || '';
        const summary = this.portfolioProfile?.summary || '';
        
        let html = '<!DOCTYPE html><html><head><title>GRC Portfolio - ' + profileName + '</title>';
        html += '<style>@media print { @page { margin: 0.5in; } }';
        html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
        html += 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #1a1a2e; padding: 40px; max-width: 800px; margin: 0 auto; }';
        html += '.header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e2e8f0; }';
        html += '.header h1 { font-size: 28px; color: #1e3a8a; margin-bottom: 4px; }';
        html += '.header p { color: #64748b; font-size: 14px; }';
        html += '.contact-info { display: flex; justify-content: center; gap: 20px; margin-top: 12px; font-size: 12px; color: #64748b; }';
        html += '.stats-row { display: flex; justify-content: center; gap: 32px; margin-bottom: 32px; }';
        html += '.stat { text-align: center; }';
        html += '.stat-value { font-size: 24px; font-weight: 700; color: #1e3a8a; }';
        html += '.stat-label { font-size: 11px; color: #64748b; text-transform: uppercase; }';
        html += '.section { margin-bottom: 32px; }';
        html += '.section-title { font-size: 16px; font-weight: 700; color: #1e3a8a; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; }';
        html += '.project { margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; }';
        html += '.project-header { display: flex; justify-content: space-between; margin-bottom: 8px; }';
        html += '.project-title { font-weight: 600; font-size: 15px; }';
        html += '.project-frameworks { font-size: 11px; color: #64748b; }';
        html += '.project-desc { font-size: 13px; color: #64748b; margin-bottom: 12px; }';
        html += '.project-metrics { display: flex; gap: 16px; font-size: 12px; color: #64748b; margin-bottom: 12px; }';
        html += '.bullets { padding-left: 20px; }';
        html += '.bullet { font-size: 13px; margin-bottom: 6px; }';
        html += '.skills { display: flex; flex-wrap: wrap; gap: 8px; }';
        html += '.skill { background: #e2e8f0; padding: 4px 12px; border-radius: 16px; font-size: 12px; }';
        html += '</style></head><body>';
        html += '<div class="header"><h1>' + profileName + '</h1><p>' + role + '</p>';
        html += '<div class="contact-info">';
        if (email) html += '<span>📧 ' + email + '</span>';
        if (linkedin) html += '<span>🔗 ' + linkedin + '</span>';
        html += '</div>';
        if (summary) html += '<p style="margin-top: 16px; font-size: 13px; color: #475569;">' + summary + '</p>';
        html += '</div>';
        
        let totalAssets = 0, totalRisks = 0, totalControls = 0, completedProjects = 0;
        projects.forEach(p => {
            const pd = this.getProjectData(p.id);
            const progress = this.getProjectProgress(p.id);
            if (progress.percent > 0) {
                totalAssets += pd.assets.length;
                totalRisks += pd.risks.length;
                totalControls += pd.controls.length;
                if (progress.percent === 100) completedProjects++;
            }
        });
        
        html += '<div class="stats-row">';
        html += '<div class="stat"><div class="stat-value">' + completedProjects + '</div><div class="stat-label">Projects</div></div>';
        html += '<div class="stat"><div class="stat-value">' + totalAssets + '</div><div class="stat-label">Assets</div></div>';
        html += '<div class="stat"><div class="stat-value">' + totalRisks + '</div><div class="stat-label">Risks</div></div>';
        html += '<div class="stat"><div class="stat-value">' + totalControls + '</div><div class="stat-label">Controls</div></div>';
        html += '</div>';
        
        html += '<div class="section"><div class="section-title">Projects</div>';
        
        projects.forEach(p => {
            const progress = this.getProjectProgress(p.id);
            const pData = this.getProjectData(p.id);
            const bullets = this.generateProjectSpecificBullets(p, pData);
            const notes = this.portfolioNotes?.[p.id] || {};
            
            if (progress.percent === 0) return;
            
            html += '<div class="project">';
            html += '<div class="project-header"><span class="project-title">' + p.company + '</span>';
            html += '<span class="project-frameworks">' + p.frameworks.join(' • ') + '</span></div>';
            html += '<div class="project-desc">' + p.scenario + '</div>';
            html += '<div class="project-metrics">';
            html += '<span>📦 ' + pData.assets.length + ' Assets</span>';
            html += '<span>⚠️ ' + pData.risks.length + ' Risks</span>';
            html += '<span>🔒 ' + pData.controls.length + ' Controls</span>';
            html += '</div>';
            if (bullets.length > 0) {
                html += '<ul class="bullets">';
                bullets.forEach(b => { html += '<li class="bullet">' + b + '</li>'; });
                html += '</ul>';
            }
            if (notes.context) html += '<p style="font-size: 12px; margin-top: 8px;"><strong>Context:</strong> ' + notes.context + '</p>';
            if (notes.outcomes) html += '<p style="font-size: 12px;"><strong>Outcomes:</strong> ' + notes.outcomes + '</p>';
            html += '</div>';
        });
        
        html += '</div>';
        html += '<div class="section"><div class="section-title">Skills & Frameworks</div>';
        html += '<div class="skills">';
        ['Risk Assessment', 'Control Testing', 'Compliance Management', 'Vendor Risk', 'Policy Development', 'ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA'].forEach(s => {
            html += '<span class="skill">' + s + '</span>';
        });
        html += '</div></div>';
        html += '<div style="text-align: center; margin-top: 32px; padding-top: 16px; border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;">';
        html += 'Generated with GRC Practice Lab • ' + new Date().toLocaleDateString();
        html += '</div></body></html>';
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => {
            printWindow.print();
        };
        
        this.toast('Print dialog opened! Save as PDF to keep a copy.', 'success');
    }
    
    handleEvidenceUpload(event, projectId) {
        const files = event.target.files;
        if (!files.length) return;
        
        if (!this.portfolioEvidence[projectId]) {
            this.portfolioEvidence[projectId] = [];
        }
        
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.portfolioEvidence[projectId].push({
                    name: file.name,
                    data: e.target.result,
                    date: new Date().toISOString(),
                    caption: ''
                });
                this.renderPortfolio();
                this.toast(`Added ${file.name}`, 'success');
            };
            reader.readAsDataURL(file);
        });
    }
    
    handleBulkEvidenceUpload(event) {
        const files = event.target.files;
        if (!files.length) return;
        this.toast(`Select a project to add ${files.length} file(s) to`, 'info');
    }
    
    deleteEvidence(projectId, index) {
        if (this.portfolioEvidence[projectId]) {
            this.portfolioEvidence[projectId].splice(index, 1);
            this.renderPortfolio();
            this.toast('Evidence removed', 'success');
        }
    }
    
    viewEvidence(projectId, index) {
        const evidence = this.portfolioEvidence[projectId]?.[index];
        if (!evidence) return;
        
        openModal('Evidence Preview', `
            <div style="text-align: center;">
                <img src="${evidence.data}" style="max-width: 100%; max-height: 60vh; border-radius: var(--radius-md);">
                <div style="margin-top: 16px;">
                    <input type="text" class="form-control" placeholder="Add a caption..." value="${evidence.caption || ''}" 
                           onchange="app.updateEvidenceCaption('${projectId}', ${index}, this.value)" style="text-align: center;">
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <a href="${evidence.data}" download="${evidence.name}" class="btn btn-primary"><i class="bi bi-download"></i> Download</a>
        `);
    }
    
    updateEvidenceCaption(projectId, index, caption) {
        if (this.portfolioEvidence[projectId]?.[index]) {
            this.portfolioEvidence[projectId][index].caption = caption;
        }
    }
    
    renderPortfolioContent(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return '';
        
        const progress = this.getProjectProgress(projectId);
        const pData = this.getProjectData(projectId);
        const bullets = this.generateProjectSpecificBullets(project, pData);
        const evidence = this.portfolioEvidence?.[projectId] || [];
        const notes = this.portfolioNotes?.[projectId] || { context: '', decisions: '', challenges: '', outcomes: '' };
        
        return `
            <div class="card" style="margin-bottom: 20px;">
                <!-- Project Header -->
                <div style="padding: 24px; background: linear-gradient(135deg, var(--accent-blue-soft) 0%, var(--accent-purple-soft) 100%); border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
                        <div style="flex: 1; min-width: 250px;">
                            <div style="font-weight: 700; font-size: 20px; margin-bottom: 6px;">${project.company}</div>
                            <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px;">${project.scenario}</div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                ${project.frameworks.map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}">${fw}</span>`).join('')}
                                <span class="badge badge-${progress.percent === 100 ? 'green' : progress.percent > 0 ? 'amber' : 'blue'}">${progress.percent}% Complete</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" onclick="app.copyProjectBullets('${projectId}')">
                                <i class="bi bi-clipboard"></i> Copy Bullets
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="app.shareProjectToLinkedIn('${projectId}')">
                                <i class="bi bi-linkedin"></i> Share
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body" style="padding: 24px;">
                    <!-- Quick Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 28px; padding-bottom: 24px; border-bottom: 1px solid var(--border-subtle);">
                        <div style="text-align: center; padding: 16px; background: var(--accent-blue-soft); border-radius: var(--radius-md);">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${pData.assets.length}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Assets</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--accent-red-soft); border-radius: var(--radius-md);">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${pData.risks.length}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Risks</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--accent-green-soft); border-radius: var(--radius-md);">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${pData.controls.length}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Controls</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--accent-purple-soft); border-radius: var(--radius-md);">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-purple);">${evidence.length}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Evidence</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--accent-amber-soft); border-radius: var(--radius-md);">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${progress.completed}/${progress.total}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Tasks</div>
                        </div>
                    </div>
                    
                    <!-- Resume Bullets Section -->
                    <div style="margin-bottom: 28px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                            <span style="font-weight: 600; font-size: 15px;"><i class="bi bi-card-text"></i> Resume Bullet Points</span>
                        </div>
                        
                        ${bullets.length > 0 ? `
                            <div id="portfolio-bullets" style="background: var(--bg-elevated); padding: 20px 24px; border-radius: var(--radius-md); font-size: 14px; line-height: 1.8; border-left: 4px solid var(--accent-blue);">
                                ${bullets.map(b => `<div style="margin-bottom: 12px; padding-left: 16px; position: relative;"><span style="position: absolute; left: 0; color: var(--accent-blue); font-weight: 600;">•</span>${b}</div>`).join('')}
                            </div>
                        ` : `
                            <div style="background: var(--bg-elevated); padding: 40px; border-radius: var(--radius-md); text-align: center;">
                                <i class="bi bi-info-circle" style="font-size: 32px; color: var(--text-muted); opacity: 0.5; margin-bottom: 16px; display: block;"></i>
                                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">No content yet. Start the project and add data to generate resume bullets.</p>
                                <button class="btn btn-primary" onclick="app.startProject('${projectId}')"><i class="bi bi-play-fill"></i> Start Project</button>
                            </div>
                        `}
                    </div>
                    
                    <!-- Decision Rationale Section -->
                    <div class="rationale-card" style="margin-bottom: 28px;">
                        <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-lightbulb-fill" style="color: var(--accent-purple);"></i> 
                            Decision Rationale & Context
                            <span style="font-size: 11px; font-weight: 400; color: var(--text-muted);">— Show hiring managers your thinking</span>
                        </h4>
                        <div style="display: grid; gap: 16px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: block;">Project Context</label>
                                <textarea class="form-control" rows="2" placeholder="What was the business situation? Why was this project needed?" 
                                    style="background: rgba(255,255,255,0.5); resize: vertical;"
                                    onchange="app.updateProjectNotes('${projectId}', 'context', this.value)">${notes.context}</textarea>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: block;">Key Decisions Made</label>
                                <textarea class="form-control" rows="2" placeholder="What decisions did you make and why? What alternatives did you consider?"
                                    style="background: rgba(255,255,255,0.5); resize: vertical;"
                                    onchange="app.updateProjectNotes('${projectId}', 'decisions', this.value)">${notes.decisions}</textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: block;">Challenges Overcome</label>
                                    <textarea class="form-control" rows="2" placeholder="What obstacles did you face?"
                                        style="background: rgba(255,255,255,0.5); resize: vertical;"
                                        onchange="app.updateProjectNotes('${projectId}', 'challenges', this.value)">${notes.challenges}</textarea>
                                </div>
                                <div>
                                    <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: block;">Business Outcomes</label>
                                    <textarea class="form-control" rows="2" placeholder="What was the result? Any metrics?"
                                        style="background: rgba(255,255,255,0.5); resize: vertical;"
                                        onchange="app.updateProjectNotes('${projectId}', 'outcomes', this.value)">${notes.outcomes}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evidence Section -->
                    <div style="margin-bottom: 28px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                            <span style="font-weight: 600; font-size: 15px;"><i class="bi bi-images"></i> Supporting Evidence</span>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('evidence-upload-inline-${projectId}').click()">
                                <i class="bi bi-plus"></i> Add Screenshot
                            </button>
                            <input type="file" id="evidence-upload-inline-${projectId}" accept="image/*" multiple style="display: none;" onchange="app.handleEvidenceUpload(event, '${projectId}')">
                        </div>
                        
                        ${evidence.length > 0 ? `
                            <div class="evidence-gallery">
                                ${evidence.map((ev, idx) => `
                                    <div class="evidence-thumb" onclick="app.viewEvidence('${projectId}', ${idx})">
                                        <img src="${ev.data}" alt="${ev.name}">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 8px 10px; color: white; font-size: 11px;">
                                            ${ev.caption || ev.name.substring(0, 18)}
                                        </div>
                                    </div>
                                `).join('')}
                                <div class="evidence-thumb evidence-add-btn" onclick="document.getElementById('evidence-upload-inline-${projectId}').click()">
                                    <div class="evidence-thumb-placeholder">
                                        <i class="bi bi-plus-lg" style="font-size: 20px;"></i>
                                        <span>Add More</span>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="background: var(--bg-elevated); padding: 32px; border-radius: var(--radius-md); text-align: center; border: 2px dashed var(--border-default);">
                                <i class="bi bi-camera" style="font-size: 32px; color: var(--text-muted); opacity: 0.5; margin-bottom: 12px; display: block;"></i>
                                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">Add screenshots of your work — risk registers, control matrices, dashboards, etc.</p>
                                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('evidence-upload-inline-${projectId}').click()">
                                    <i class="bi bi-upload"></i> Upload Evidence
                                </button>
                            </div>
                        `}
                    </div>
                    
                    <!-- Project Summary -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                            <span style="font-weight: 600; font-size: 15px;"><i class="bi bi-file-text"></i> Project Summary</span>
                            <button class="btn btn-ghost btn-sm" onclick="app.copyProjectSummary('${projectId}')"><i class="bi bi-clipboard"></i> Copy</button>
                        </div>
                        <div id="project-summary-${projectId}" style="background: var(--bg-elevated); padding: 20px 24px; border-radius: var(--radius-md); font-size: 14px; line-height: 1.7; color: var(--text-secondary);">
                            ${this.generateProjectSummary(project, pData)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    updateProjectNotes(projectId, field, value) {
        if (!this.portfolioNotes) this.portfolioNotes = {};
        if (!this.portfolioNotes[projectId]) {
            this.portfolioNotes[projectId] = { context: '', decisions: '', challenges: '', outcomes: '' };
        }
        this.portfolioNotes[projectId][field] = value;
    }
    
    selectPortfolioProject(projectId) {
        this.selectedPortfolioProject = projectId || null;
        this.renderPortfolio();
    }
    
    generateProjectSpecificBullets(project, pData = null) {
        const bullets = [];

        const p = project;
        const progress = this.getProjectProgress(p.id);
        const d = pData || this.getProjectData(p.id);
        
        // Project-specific bullet generation based on project type
        const projectBullets = {
            'iso-risk-assessment': () => {
                if (d.assets.length > 0) bullets.push(`Conducted comprehensive asset inventory and classification for ${d.assets.length} information assets supporting ISO 27001 ISMS implementation`);
                if (d.risks.length > 0) {
                    const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20).length;
                    const highRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
                    bullets.push(`Performed risk assessment identifying ${d.risks.length} risks across cloud migration scope${criticalRisks > 0 ? `, including ${criticalRisks} critical and ${highRisks} high-severity risks requiring immediate attention` : ''}`);
                }
                if (d.controls.length > 0) {
                    const iso27001Controls = d.controls.filter(c => c.frameworks?.includes('ISO 27001')).length || d.controls.length;
                    bullets.push(`Implemented ${iso27001Controls} security controls aligned with ISO 27001 Annex A requirements and NIST CSF`);
                }
                if (d.treatments.length > 0) bullets.push(`Developed ${d.treatments.length} risk treatment plans with documented mitigation strategies, acceptance criteria, and residual risk calculations`);
                if (progress.percent === 100) bullets.push(`Completed ISO 27001 risk assessment documentation supporting certification readiness for cloud infrastructure`);
            },
            'vendor-tprm': () => {
                if (d.vendors.length > 0) bullets.push(`Conducted third-party security assessments for ${d.vendors.length} vendor(s), evaluating security posture against PCI DSS and SOC 2 requirements`);
                if (d.risks.length > 0) bullets.push(`Identified and documented ${d.risks.length} vendor-related security risks impacting payment card data environment`);
                if (d.controls.length > 0) bullets.push(`Verified implementation of ${d.controls.length} compensating controls for third-party payment processor integration`);
                if (d.issues.length > 0) {
                    const closedIssues = d.issues.filter(i => i.status === 'Closed').length;
                    bullets.push(`Documented ${d.issues.length} compliance gaps and coordinated remediation efforts${closedIssues > 0 ? ` with ${Math.round(closedIssues/d.issues.length*100)}% resolution rate` : ''}`);
                }
                if (progress.percent === 100) bullets.push(`Established ongoing vendor monitoring program with quarterly security assessments and contract compliance reviews`);
            },
            'soc2-audit': () => {
                if (d.controls.length > 0) {
                    const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
                    bullets.push(`Documented ${d.controls.length} Trust Services Criteria controls for SOC 2 Type II audit${effectiveControls > 0 ? ` with ${Math.round(effectiveControls/d.controls.length*100)}% operating effectiveness` : ''}`);
                }
                if (d.assets.length > 0) bullets.push(`Cataloged ${d.assets.length} in-scope systems and infrastructure components for SOC 2 boundary definition`);
                if (d.evidence.length > 0) bullets.push(`Managed evidence collection and organization of ${d.evidence.length} audit artifacts supporting Trust Services Criteria`);
                if (d.controlTests.length > 0) {
                    const passedTests = d.controlTests.filter(t => t.result === 'Pass').length;
                    bullets.push(`Executed ${d.controlTests.length} control testing procedures${passedTests > 0 ? ` achieving ${Math.round(passedTests/d.controlTests.length*100)}% pass rate` : ''}`);
                }
                if (progress.percent === 100) bullets.push(`Coordinated successful SOC 2 Type II audit preparation ensuring all Trust Services Criteria requirements were addressed`);
            },
            'gdpr-compliance': () => {
                if (d.assets.length > 0) bullets.push(`Mapped ${d.assets.length} data processing activities documenting personal data flows, legal basis, and retention periods per GDPR Article 30`);
                if (d.risks.length > 0) bullets.push(`Conducted Data Protection Impact Assessments (DPIAs) for ${d.risks.length} high-risk processing activities per GDPR Article 35`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} privacy-by-design controls addressing GDPR principles and data subject rights`);
                if (d.policies.length > 0) bullets.push(`Developed ${d.policies.length} privacy policies and procedures including data retention, breach notification, and DSAR handling`);
                if (progress.percent === 100) bullets.push(`Established GDPR compliance program enabling EU market expansion with documented accountability framework`);
            },
            'incident-response': () => {
                if (d.incidents.length > 0) bullets.push(`Developed ${d.incidents.length} incident response playbooks covering security, availability, and data breach scenarios`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} detection, response, and recovery controls aligned with HIPAA Security Rule requirements`);
                if (d.assets.length > 0) bullets.push(`Identified ${d.assets.length} critical systems containing PHI requiring enhanced monitoring and rapid response capabilities`);
                if (d.tasks.length > 0) bullets.push(`Created ${d.tasks.length} incident response tasks defining roles, escalation procedures, and communication protocols`);
                if (progress.percent === 100) bullets.push(`Established incident response program with HIPAA breach notification procedures and post-incident review process`);
            },
            'cloud-security': () => {
                if (d.assets.length > 0) bullets.push(`Inventoried ${d.assets.length} AWS cloud assets including EC2, S3, RDS, and IAM configurations for CIS Benchmark assessment`);
                if (d.findings.length > 0) {
                    const closedFindings = d.findings.filter(f => f.status === 'Closed').length;
                    bullets.push(`Identified ${d.findings.length} security misconfigurations and vulnerabilities${closedFindings > 0 ? ` with ${Math.round(closedFindings/d.findings.length*100)}% remediated` : ''}`);
                }
                if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} cloud-specific risks including data exposure, misconfiguration, and privilege escalation vectors`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} CIS Benchmark controls for AWS hardening including encryption, logging, and network segmentation`);
                if (progress.percent === 100) bullets.push(`Delivered cloud security assessment report with prioritized remediation roadmap and ongoing monitoring recommendations`);
            },
            'bcdr-planning': () => {
                if (d.assets.length > 0) bullets.push(`Conducted Business Impact Analysis (BIA) for ${d.assets.length} critical systems defining RTO/RPO requirements`);
                if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} business continuity risks including infrastructure failure, natural disaster, and cyber attack scenarios`);
                if (d.controls.length > 0) bullets.push(`Documented ${d.controls.length} BC/DR controls including backup procedures, failover mechanisms, and recovery runbooks`);
                if (d.audits.length > 0) bullets.push(`Planned and coordinated ${d.audits.length} tabletop exercises and disaster recovery tests validating plan effectiveness`);
                if (progress.percent === 100) bullets.push(`Delivered comprehensive BC/DR program aligned with COBIT and ISO 22301 requirements for critical infrastructure protection`);
            },
            'compliance-gap': () => {
                if (d.controls.length > 0) bullets.push(`Assessed ${d.controls.length} controls across PCI DSS, SOC 2, and HIPAA frameworks creating unified control matrix`);
                if (d.issues.length > 0) bullets.push(`Identified ${d.issues.length} compliance gaps requiring remediation across multiple regulatory frameworks`);
                if (d.treatments.length > 0) bullets.push(`Developed ${d.treatments.length} remediation plans with prioritization based on risk severity and compliance deadlines`);
                if (d.audits.length > 0) bullets.push(`Scheduled ${d.audits.length} compliance audits coordinating evidence collection and stakeholder preparation`);
                if (progress.percent === 100) bullets.push(`Completed multi-framework gap analysis enabling efficient compliance management across healthcare, finance, and payment processing requirements`);
            },
            'zero-trust': () => {
                if (d.assets.length > 0) bullets.push(`Mapped ${d.assets.length} critical assets identifying protect surfaces for Zero Trust Architecture implementation`);
                if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} identity and access risks supporting "never trust, always verify" security model`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} Zero Trust controls including microsegmentation, continuous verification, and least privilege access`);
                if (d.policies.length > 0) bullets.push(`Developed ${d.policies.length} identity-centric security policies governing authentication, authorization, and session management`);
                if (progress.percent === 100) bullets.push(`Delivered Zero Trust Architecture roadmap aligned with NIST SP 800-207 and CIS Controls for modern security transformation`);
            }
        };
        
        // Execute the project-specific bullet generator
        if (projectBullets[p.id]) {
            projectBullets[p.id]();
        } else {
            // Fallback for unknown projects
            if (d.assets.length > 0) bullets.push(`Managed ${d.assets.length} assets for ${p.company} GRC project`);
            if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} risks across ${p.frameworks.join(', ')} frameworks`);
            if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} security controls`);
        }
        
        return bullets;
    }
    
    copyProjectBullets(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return;
        
        const pData = this.getProjectData(projectId);
        const bullets = this.generateProjectSpecificBullets(project, pData);
        const text = bullets.map(b => `• ${b}`).join('\n');
        navigator.clipboard.writeText(text).then(() => this.toast(`${project.company} bullets copied to clipboard!`, 'success'));
    }
    
    renderProjectPortfolioCard(p) {
        const progress = this.getProjectProgress(p.id);
        const statusClass = progress.percent === 100 ? 'green' : progress.percent > 0 ? 'amber' : 'blue';
        const summary = this.generateProjectSummary(p);
        
        return `
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, var(--accent-${statusClass}-soft), transparent);">
                    <div class="card-title"><i class="bi bi-building"></i> ${this.esc(p.company)}</div>
                    <span class="badge badge-${statusClass}">${progress.percent}%</span>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                        <span class="badge" style="background: var(--bg-elevated);"><i class="bi bi-diagram-3"></i> ${p.industry}</span>
                        ${p.frameworks.map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="font-size: 11px;">${fw}</span>`).join('')}
                    </div>
                    <h5 style="font-size: 14px; margin-bottom: 8px;">${this.esc(p.scenario)}</h5>
                    <div id="project-summary-${p.id}" style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; font-size: 13px; line-height: 1.7; color: var(--text-secondary);">
                        ${summary}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="app.copyProjectSummary('${p.id}')"><i class="bi bi-clipboard"></i> Copy</button>
                        <button class="btn btn-ghost btn-sm" onclick="app.switchTab('projects')"><i class="bi bi-arrow-right"></i> View Project</button>
                    </div>
                </div>
            </div>`;
    }
    
    generateProjectSummary(p, pData = null) {
        const progress = this.getProjectProgress(p.id);
        const tasksDone = progress.completed;
        const tasksTotal = progress.total;
        const d = pData || this.getProjectData(p.id);
        
        // Generate dynamic summary based on project type and progress
        const summaries = {
            'iso-risk-assessment': `Led ISO 27001 risk assessment initiative for cloud migration project at a ${p.size} SaaS company. Identified and documented ${d.assets.length} critical information assets, conducted comprehensive risk assessments covering ${d.risks.length} potential threats, and implemented ${d.controls.length} security controls aligned with ISO 27001 Annex A requirements. Developed risk treatment plans and maintained Statement of Applicability documentation.`,
            
            'vendor-tprm': `Managed third-party risk management program for payment processor integration at a ${p.size} financial services firm. Conducted vendor security assessments, evaluated ${d.vendors.length} vendor security postures against PCI DSS and SOC 2 requirements, identified ${d.issues.length} compliance gaps, and coordinated remediation efforts with ${d.controls.length} compensating controls.`,
            
            'soc2-audit': `Coordinated SOC 2 Type II audit preparation for a ${p.size} data analytics platform serving Fortune 500 clients. Documented ${d.controls.length} Trust Services Criteria controls, managed evidence collection for ${d.evidence.length} audit artifacts, and executed ${d.controlTests.length} control testing procedures to validate operational effectiveness.`,
            
            'gdpr-compliance': `Implemented GDPR compliance program for EU market expansion at a ${p.size} e-commerce company processing 3M+ customer records. Mapped ${d.assets.length} data processing activities, conducted Data Protection Impact Assessments for ${d.risks.length} high-risk processes, implemented ${d.controls.length} privacy controls, and developed ${d.policies.length} privacy policies and procedures.`,
            
            'incident-response': `Developed incident response program for a ${p.size} healthcare technology company managing EHR systems with PHI for 2M+ patients. Created ${d.incidents.length} incident response playbooks, implemented ${d.controls.length} detection and response controls, and established HIPAA breach notification procedures and escalation workflows.`,
            
            'cloud-security': `Conducted AWS security assessment and CIS Benchmark hardening for a ${p.size} cloud infrastructure provider serving 50+ enterprise clients. Inventoried ${d.assets.length} cloud assets, identified ${d.findings.length} security findings, assessed ${d.risks.length} cloud-specific risks, and implemented ${d.controls.length} security controls for remediation.`,
            
            'bcdr-planning': `Led business continuity and disaster recovery planning initiative for a ${p.size} critical infrastructure operator. Conducted business impact analysis for ${d.assets.length} critical systems, assessed ${d.risks.length} continuity risks, documented ${d.controls.length} BC/DR controls, and coordinated ${d.audits.length} tabletop exercises and recovery tests.`,
            
            'compliance-gap': `Performed multi-framework compliance gap analysis for a ${p.size} RegTech company requiring simultaneous PCI DSS, SOC 2, and HIPAA compliance. Assessed ${d.controls.length} controls across frameworks, identified ${d.issues.length} compliance gaps, developed ${d.treatments.length} remediation plans, and created unified control matrix for audit readiness.`,
            
            'zero-trust': `Architected Zero Trust security framework implementation for a ${p.size} digital banking organization. Mapped ${d.assets.length} critical assets requiring protection, assessed ${d.risks.length} identity and access risks, implemented ${d.controls.length} Zero Trust controls including microsegmentation and continuous verification, and developed ${d.policies.length} identity-centric security policies.`
        };
        
        let summary = summaries[p.id] || `Completed GRC project for ${p.company} covering ${p.frameworks.join(', ')} frameworks. Managed ${d.assets.length} assets, ${d.risks.length} risks, and ${d.controls.length} controls.`;
        
        if (progress.percent === 0) {
            summary = `<em style="color: var(--text-muted);">Project not started. Complete tasks to generate a detailed summary.</em>`;
        } else if (progress.percent < 100) {
            summary = `<em style="color: var(--accent-amber);">[${progress.percent}% Complete]</em> ` + summary;
        }
        
        return summary;
    }
    
    generateResumeBullets() {
        const bullets = [];
        if (this.data.assets.length > 0) bullets.push(`• Maintained IT asset inventory of ${this.data.assets.length}+ systems including classification, ownership, and lifecycle management`);
        if (this.getActiveData().risks.length > 0) {
            const criticalRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 20).length;
            bullets.push(`• Conducted risk assessments identifying ${this.getActiveData().risks.length} risks across enterprise systems${criticalRisks > 0 ? `, including ${criticalRisks} critical risks requiring immediate remediation` : ''}`);
        }
        if (this.getActiveData().controls.length > 0) {
            const effective = this.getActiveData().controls.filter(c => c.effectiveness === 'Effective').length;
            bullets.push(`• Implemented and maintained ${this.getActiveData().controls.length} security controls aligned with ISO 27001, NIST CSF, and SOC 2 frameworks${effective > 0 ? ` with ${Math.round(effective/this.getActiveData().controls.length*100)}% effectiveness rate` : ''}`);
        }
        if (this.getActiveData().vendors.length > 0) bullets.push(`• Managed third-party risk program overseeing ${this.getActiveData().vendors.length} vendor relationships including due diligence, contract reviews, and ongoing monitoring`);
        if (this.getActiveData().incidents.length > 0) bullets.push(`• Led incident response activities for ${this.getActiveData().incidents.length} security events, coordinating investigation, containment, and post-incident review`);
        if (this.getActiveData().audits.length > 0) bullets.push(`• Supported ${this.getActiveData().audits.length} compliance audits including evidence collection, control testing, and remediation tracking`);
        if (this.getActiveData().evidence.length > 0) bullets.push(`• Maintained audit evidence repository with ${this.getActiveData().evidence.length}+ artifacts supporting SOC 2 Type II and ISO 27001 certification`);
        if (this.getActiveData().policies.length > 0) bullets.push(`• Developed and maintained ${this.getActiveData().policies.length} information security policies and procedures`);
        if (this.getActiveData().findings.length > 0) {
            const closed = this.getActiveData().findings.filter(f => f.status === 'Closed').length;
            bullets.push(`• Tracked remediation of ${this.getActiveData().findings.length} audit findings${closed > 0 ? ` with ${Math.round(closed/this.getActiveData().findings.length*100)}% closure rate` : ''}`);
        }
        if (bullets.length === 0) bullets.push('• Complete GRC projects to generate resume bullet points based on your work');
        return bullets.join('<br><br>');
    }
    
    copyPortfolio() {
        const text = document.getElementById('portfolio-bullets')?.innerText || '';
        navigator.clipboard.writeText(text).then(() => this.toast('Bullets copied to clipboard!', 'success'));
    }
    
    copyProjectSummary(projectId) {
        const el = document.getElementById(`project-summary-${projectId}`);
        if (el) {
            navigator.clipboard.writeText(el.innerText).then(() => this.toast('Project summary copied to clipboard!', 'success'));
        }
    }
    
    copyAllPortfolio() {
        const projects = this.getProjectScenarios();
        let allText = "=== RESUME BULLET POINTS BY PROJECT ===\n\n";
        
        projects.forEach(p => {
            const bullets = this.generateProjectSpecificBullets(p);
            if (bullets.length > 0) {
                allText += `[${p.company} - ${p.scenario}]\n`;
                allText += bullets.map(b => `• ${b}`).join('\n');
                allText += "\n\n";
            }
        });
        
        allText += "=== PROJECT SUMMARIES ===\n\n";
        projects.forEach(p => {
            const el = document.getElementById(`project-summary-${p.id}`);
            if (el) {
                allText += `[${p.company} - ${p.scenario}]\n${el.innerText}\n\n`;
            }
        });
        navigator.clipboard.writeText(allText).then(() => this.toast('All portfolio content copied to clipboard!', 'success'));
    }
    
    exportToGitHub() {
        const projects = this.getProjectScenarios();
        const userName = this.portfolioProfile?.name || prompt('Enter your name for the portfolio:', 'GRC Professional');
        if (!userName) return;
        
        const role = this.portfolioProfile?.role || 'GRC Professional';
        const email = this.portfolioProfile?.email || '';
        const linkedin = this.portfolioProfile?.linkedin || '';
        const summary = this.portfolioProfile?.summary || '';
        
        let readme = `# 🛡️ ${userName}\n`;
        readme += `### ${role}\n\n`;
        
        if (summary) {
            readme += `> ${summary}\n\n`;
        } else {
            readme += `> A collection of Governance, Risk, and Compliance (GRC) projects demonstrating practical experience with enterprise security frameworks.\n\n`;
        }
        
        // Contact badges
        readme += `![GRC Portfolio](https://img.shields.io/badge/GRC-Portfolio-blue?style=for-the-badge) `;
        readme += `![Projects](https://img.shields.io/badge/Projects-${projects.filter(p => this.getProjectProgress(p.id).percent > 0).length}-green?style=for-the-badge)`;
        if (linkedin) {
            readme += ` [![LinkedIn](https://img.shields.io/badge/LinkedIn-Connect-0077b5?style=for-the-badge&logo=linkedin)](${linkedin.startsWith('http') ? linkedin : 'https://' + linkedin})`;
        }
        if (email) {
            readme += ` [![Email](https://img.shields.io/badge/Email-Contact-ea4335?style=for-the-badge&logo=gmail)](mailto:${email})`;
        }
        readme += `\n\n---\n\n`;
        readme += `## 📊 Portfolio Summary\n\n`;
        readme += `| Metric | Count |\n|--------|-------|\n`;
        
        let totalAssets = 0, totalRisks = 0, totalControls = 0, totalProjects = 0, totalEvidence = 0;
        projects.forEach(p => {
            const pd = this.getProjectData(p.id);
            const progress = this.getProjectProgress(p.id);
            if (progress.percent > 0) {
                totalAssets += pd.assets.length;
                totalRisks += pd.risks.length;
                totalControls += pd.controls.length;
                totalProjects++;
                totalEvidence += (this.portfolioEvidence?.[p.id] || []).length;
            }
        });
        
        readme += `| Projects Completed | ${totalProjects} |\n`;
        readme += `| Assets Managed | ${totalAssets} |\n`;
        readme += `| Risks Assessed | ${totalRisks} |\n`;
        readme += `| Controls Implemented | ${totalControls} |\n`;
        if (totalEvidence > 0) {
            readme += `| Evidence Screenshots | ${totalEvidence} |\n`;
        }
        readme += `\n---\n\n`;
        readme += `## 🎯 Projects\n\n`;
        
        projects.forEach(p => {
            const progress = this.getProjectProgress(p.id);
            const pData = this.getProjectData(p.id);
            const bullets = this.generateProjectSpecificBullets(p, pData);
            const notes = this.portfolioNotes?.[p.id] || {};
            const evidence = this.portfolioEvidence?.[p.id] || [];
            
            if (progress.percent === 0) return;
            
            readme += `### ${p.company}\n`;
            readme += `**${p.scenario}**\n\n`;
            readme += `![Progress](https://img.shields.io/badge/Progress-${progress.percent}%25-${progress.percent === 100 ? 'success' : 'yellow'}) `;
            p.frameworks.forEach(fw => {
                readme += `![${fw}](https://img.shields.io/badge/-${fw.replace(/\s/g, '%20')}-informational) `;
            });
            readme += `\n\n`;
            
            readme += `| Assets | Risks | Controls | Tasks |\n`;
            readme += `|--------|-------|----------|-------|\n`;
            readme += `| ${pData.assets.length} | ${pData.risks.length} | ${pData.controls.length} | ${progress.completed}/${progress.total} |\n\n`;
            
            if (notes.context) {
                readme += `**Context:** ${notes.context}\n\n`;
            }
            
            if (bullets.length > 0) {
                readme += `**Key Accomplishments:**\n`;
                bullets.forEach(b => readme += `- ${b}\n`);
                readme += `\n`;
            }
            
            if (notes.decisions) {
                readme += `**Decisions Made:** ${notes.decisions}\n\n`;
            }
            
            if (notes.outcomes) {
                readme += `**Outcomes:** ${notes.outcomes}\n\n`;
            }
            
            // Reference evidence if any
            if (evidence.length > 0) {
                readme += `**Evidence:** ${evidence.length} screenshot(s) available in \`/evidence/${p.id}/\` folder\n\n`;
            }
            
            readme += `---\n\n`;
        });
        
        readme += `## 🛠️ Skills & Frameworks\n\n`;
        readme += `### Technical Skills\n`;
        ['Risk Assessment', 'Control Testing', 'Audit Support', 'Compliance Management', 'Vendor Risk', 'Policy Development'].forEach(s => {
            readme += `- ${s}\n`;
        });
        readme += `\n### Frameworks\n`;
        ['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR', 'CMMC', 'CIS Controls'].forEach(fw => {
            readme += `- ${fw}\n`;
        });
        readme += `\n---\n\n`;
        readme += `## 📁 Repository Structure\n\n`;
        readme += `\`\`\`\n`;
        readme += `grc-portfolio/\n`;
        readme += `├── README.md          # This file\n`;
        readme += `├── evidence/          # Screenshots and documentation\n`;
        projects.forEach(p => {
            const evidence = this.portfolioEvidence?.[p.id] || [];
            if (evidence.length > 0 && this.getProjectProgress(p.id).percent > 0) {
                readme += `│   └── ${p.id}/\n`;
            }
        });
        readme += `└── portfolio.html     # Standalone portfolio page\n`;
        readme += `\`\`\`\n\n`;
        readme += `---\n\n`;
        readme += `*Generated with [GRC Practice Lab](https://grcmadesimple.com) on ${new Date().toLocaleDateString()}*\n`;
        
        // Create and download the file
        const blob = new Blob([readme], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'README.md';
        a.click();
        URL.revokeObjectURL(url);
        
        this.toast('GitHub README.md downloaded!', 'success');
        
        // Show instructions modal with evidence download option
        const hasEvidence = totalEvidence > 0;
        openModal('Export to GitHub', `
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="width: 64px; height: 64px; background: #24292e; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                        <i class="bi bi-github" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h3 style="margin-bottom: 8px;">README.md Downloaded!</h3>
                    <p style="color: var(--text-muted); font-size: 14px;">Your portfolio is ready to upload to GitHub</p>
                </div>
                
                <div style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px;">
                    <h4 style="font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-list-ol" style="color: var(--accent-blue);"></i> Setup Steps
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <span style="width: 24px; height: 24px; background: var(--accent-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0;">1</span>
                            <div style="font-size: 13px;">Create a new repository named <code style="background: var(--bg-surface); padding: 2px 6px; border-radius: 4px;">grc-portfolio</code></div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <span style="width: 24px; height: 24px; background: var(--accent-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0;">2</span>
                            <div style="font-size: 13px;">Upload the downloaded <code style="background: var(--bg-surface); padding: 2px 6px; border-radius: 4px;">README.md</code> file</div>
                        </div>
                        ${hasEvidence ? `
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <span style="width: 24px; height: 24px; background: var(--accent-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0;">3</span>
                            <div style="font-size: 13px;">Create an <code style="background: var(--bg-surface); padding: 2px 6px; border-radius: 4px;">evidence</code> folder and add your screenshots</div>
                        </div>
                        ` : ''}
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <span style="width: 24px; height: 24px; background: var(--accent-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0;">✓</span>
                            <div style="font-size: 13px;">Share your repository link on LinkedIn and resumes!</div>
                        </div>
                    </div>
                </div>
                
                ${hasEvidence ? `
                <div style="background: var(--accent-purple-soft); border-radius: var(--radius-lg); padding: 16px; display: flex; align-items: center; gap: 12px;">
                    <i class="bi bi-images" style="font-size: 20px; color: var(--accent-purple);"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 13px;">You have ${totalEvidence} evidence screenshots</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Go to Evidence Gallery to download them</div>
                    </div>
                    <button class="btn btn-sm" style="background: var(--accent-purple); color: white;" onclick="closeModal(); app.setPortfolioTab('evidence')">
                        View Evidence
                    </button>
                </div>
                ` : ''}
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <a href="https://github.com/new" target="_blank" class="btn btn-primary"><i class="bi bi-github"></i> Create Repository</a>
        `);
    }
    
    shareToLinkedIn() {
        const projects = this.getProjectScenarios();
        let completedCount = 0;
        let totalRisks = 0;
        let totalControls = 0;
        let frameworks = new Set();
        
        projects.forEach(p => {
            const progress = this.getProjectProgress(p.id);
            const pData = this.getProjectData(p.id);
            if (progress.percent > 0) {
                completedCount++;
                totalRisks += pData.risks.length;
                totalControls += pData.controls.length;
                p.frameworks.forEach(fw => frameworks.add(fw));
            }
        });
        
        const postText = `🛡️ Building my GRC Portfolio!\n\nI've been developing practical Governance, Risk & Compliance skills through hands-on projects:\n\n` +
            `📊 ${completedCount} projects completed\n` +
            `⚠️ ${totalRisks} risks assessed\n` +
            `🔒 ${totalControls} controls implemented\n` +
            `📋 Frameworks: ${Array.from(frameworks).slice(0, 4).join(', ')}\n\n` +
            `Key areas: Risk Assessment, Control Testing, Compliance Management, Vendor Risk Management\n\n` +
            `#GRC #Cybersecurity #RiskManagement #Compliance #InfoSec #CareerGrowth`;
        
        openModal('Share on LinkedIn', `
            <div style="padding: 10px;">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Copy this post to share your GRC portfolio on LinkedIn:</p>
                <textarea id="linkedin-post" class="form-control" rows="16" style="font-size: 14px; line-height: 1.7; min-height: 320px; width: 100%; box-sizing: border-box;">${postText}</textarea>
                <div style="margin-top: 16px; padding: 16px; background: var(--accent-blue-soft); border-radius: var(--radius-md);">
                    <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;"><i class="bi bi-lightbulb"></i> Pro Tips:</div>
                    <ul style="font-size: 12px; color: var(--text-secondary); margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li>Add a screenshot of your portfolio dashboard</li>
                        <li>Tag relevant companies or mentors</li>
                        <li>Include a link to your GitHub portfolio</li>
                        <li>Mention specific achievements or certifications you're pursuing</li>
                    </ul>
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('linkedin-post').value).then(() => app.toast('Copied!', 'success'))">
                <i class="bi bi-clipboard"></i> Copy Text
            </button>
            <a href="https://www.linkedin.com/feed/?shareActive=true" target="_blank" class="btn btn-primary" style="background: #0077b5;">
                <i class="bi bi-linkedin"></i> Open LinkedIn
            </a>
        `);
    }
    
    shareProjectToLinkedIn(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return;
        
        const progress = this.getProjectProgress(projectId);
        const pData = this.getProjectData(projectId);
        const bullets = this.generateProjectSpecificBullets(project, pData);
        const notes = this.portfolioNotes?.[projectId] || {};
        
        let postText = `🛡️ GRC Project Spotlight: ${project.scenario}\n\n`;
        postText += `Just completed a hands-on ${project.frameworks.join(' & ')} project simulating a real-world scenario at ${project.company}.\n\n`;
        postText += `📊 Key Metrics:\n`;
        postText += `• ${pData.assets.length} assets inventoried\n`;
        postText += `• ${pData.risks.length} risks assessed\n`;
        postText += `• ${pData.controls.length} controls implemented\n\n`;
        
        if (bullets.length > 0) {
            postText += `✅ Key Accomplishments:\n`;
            bullets.slice(0, 2).forEach(b => postText += `• ${b}\n`);
            postText += `\n`;
        }
        
        if (notes.outcomes) {
            postText += `💡 Outcome: ${notes.outcomes}\n\n`;
        }
        
        postText += `#GRC #${project.frameworks[0].replace(/\s/g, '')} #Cybersecurity #RiskManagement`;
        
        openModal('Share Project on LinkedIn', `
            <div style="padding: 10px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle);">
                    <div style="width: 48px; height: 48px; background: var(--accent-blue-soft); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-briefcase" style="font-size: 20px; color: var(--accent-blue);"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600;">${project.company}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${project.scenario}</div>
                    </div>
                </div>
                <textarea id="linkedin-project-post" class="form-control" rows="14" style="font-size: 13px; line-height: 1.6; width: 100%; box-sizing: border-box;">${postText}</textarea>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('linkedin-project-post').value).then(() => app.toast('Copied!', 'success'))">
                <i class="bi bi-clipboard"></i> Copy
            </button>
            <a href="https://www.linkedin.com/feed/?shareActive=true" target="_blank" class="btn btn-primary" style="background: #0077b5;">
                <i class="bi bi-linkedin"></i> Post to LinkedIn
            </a>
        `);
    }
    
    downloadPortfolio() {
        const projects = this.getProjectScenarios();
        const userName = prompt('Enter your name for the portfolio:', 'GRC Professional');
        if (!userName) return;
        
        let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRC Portfolio - ${userName}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a, #1e3a5f); min-height: 100vh; color: #e2e8f0; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 48px; }
        .header h1 { font-size: 36px; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: #94a3b8; font-size: 18px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 48px; }
        .stat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: 700; color: #60a5fa; }
        .stat-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .project-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 32px; margin-bottom: 24px; }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .project-title { font-size: 22px; font-weight: 700; color: #f8fafc; }
        .project-subtitle { font-size: 14px; color: #94a3b8; margin-top: 4px; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-right: 6px; }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-green { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
        .metric { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: 700; color: #60a5fa; }
        .metric-label { font-size: 11px; color: #94a3b8; }
        .bullets { margin-bottom: 24px; }
        .bullets h4 { font-size: 14px; color: #94a3b8; margin-bottom: 12px; }
        .bullet { padding: 12px 16px; background: rgba(255,255,255,0.02); border-left: 3px solid #60a5fa; margin-bottom: 8px; border-radius: 0 8px 8px 0; font-size: 14px; }
        .rationale { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border-radius: 12px; padding: 24px; margin-top: 20px; }
        .rationale h4 { font-size: 14px; color: #a78bfa; margin-bottom: 16px; }
        .rationale-item { margin-bottom: 16px; }
        .rationale-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .rationale-text { font-size: 14px; color: #e2e8f0; }
        .skills-section { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 32px; margin-top: 48px; }
        .skills-section h3 { font-size: 18px; margin-bottom: 20px; }
        .skills-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .skill-tag { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px; font-size: 13px; }
        .footer { text-align: center; margin-top: 48px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); color: #64748b; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛡️ ${userName}</h1>
            <p>GRC Professional Portfolio</p>
        </div>
        
        <div class="stats-grid">`;
        
        let totalAssets = 0, totalRisks = 0, totalControls = 0, completedProjects = 0;
        projects.forEach(p => {
            const pd = this.getProjectData(p.id);
            const progress = this.getProjectProgress(p.id);
            if (progress.percent > 0) {
                totalAssets += pd.assets.length;
                totalRisks += pd.risks.length;
                totalControls += pd.controls.length;
                if (progress.percent === 100) completedProjects++;
            }
        });
        
        html += `
            <div class="stat-card"><div class="stat-value">${completedProjects}</div><div class="stat-label">Projects</div></div>
            <div class="stat-card"><div class="stat-value">${totalAssets}</div><div class="stat-label">Assets</div></div>
            <div class="stat-card"><div class="stat-value">${totalRisks}</div><div class="stat-label">Risks</div></div>
            <div class="stat-card"><div class="stat-value">${totalControls}</div><div class="stat-label">Controls</div></div>
        </div>`;
        
        projects.forEach(p => {
            const progress = this.getProjectProgress(p.id);
            const pData = this.getProjectData(p.id);
            const bullets = this.generateProjectSpecificBullets(p, pData);
            const notes = this.portfolioNotes?.[p.id] || {};
            
            if (progress.percent === 0) return;
            
            html += `
        <div class="project-card">
            <div class="project-header">
                <div>
                    <div class="project-title">${p.company}</div>
                    <div class="project-subtitle">${p.scenario}</div>
                </div>
                <div>
                    ${p.frameworks.map(fw => `<span class="badge badge-blue">${fw}</span>`).join('')}
                    <span class="badge badge-green">${progress.percent}%</span>
                </div>
            </div>
            <div class="metrics-row">
                <div class="metric"><div class="metric-value">${pData.assets.length}</div><div class="metric-label">Assets</div></div>
                <div class="metric"><div class="metric-value">${pData.risks.length}</div><div class="metric-label">Risks</div></div>
                <div class="metric"><div class="metric-value">${pData.controls.length}</div><div class="metric-label">Controls</div></div>
                <div class="metric"><div class="metric-value">${progress.completed}/${progress.total}</div><div class="metric-label">Tasks</div></div>
            </div>`;
            
            if (bullets.length > 0) {
                html += `<div class="bullets"><h4>Key Accomplishments</h4>`;
                bullets.forEach(b => html += `<div class="bullet">${b}</div>`);
                html += `</div>`;
            }
            
            if (notes.context || notes.decisions || notes.outcomes) {
                html += `<div class="rationale"><h4><i class="bi bi-lightbulb"></i> Decision Rationale</h4>`;
                if (notes.context) html += `<div class="rationale-item"><div class="rationale-label">Context</div><div class="rationale-text">${notes.context}</div></div>`;
                if (notes.decisions) html += `<div class="rationale-item"><div class="rationale-label">Key Decisions</div><div class="rationale-text">${notes.decisions}</div></div>`;
                if (notes.outcomes) html += `<div class="rationale-item"><div class="rationale-label">Outcomes</div><div class="rationale-text">${notes.outcomes}</div></div>`;
                html += `</div>`;
            }
            
            html += `</div>`;
        });
        
        html += `
        <div class="skills-section">
            <h3>Skills & Frameworks</h3>
            <div class="skills-grid">
                <span class="skill-tag">Risk Assessment</span>
                <span class="skill-tag">Control Testing</span>
                <span class="skill-tag">Compliance Management</span>
                <span class="skill-tag">Vendor Risk</span>
                <span class="skill-tag">Policy Development</span>
                <span class="skill-tag">ISO 27001</span>
                <span class="skill-tag">NIST CSF</span>
                <span class="skill-tag">SOC 2</span>
                <span class="skill-tag">PCI DSS</span>
                <span class="skill-tag">HIPAA</span>
                <span class="skill-tag">GDPR</span>
            </div>
        </div>
        
        <div class="footer">
            Generated with GRC Practice Lab • ${new Date().toLocaleDateString()}
        </div>
    </div>
</body>
</html>`;
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `GRC-Portfolio-${userName.replace(/\s/g, '-')}.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.toast('Portfolio HTML downloaded!', 'success');
    }
    
    previewPortfolio() {
        const projects = this.getProjectScenarios();
        let totalAssets = 0, totalRisks = 0, totalControls = 0, completedProjects = 0;
        let projectsHtml = '';
        
        projects.forEach(p => {
            const progress = this.getProjectProgress(p.id);
            const pData = this.getProjectData(p.id);
            if (progress.percent > 0) {
                totalAssets += pData.assets.length;
                totalRisks += pData.risks.length;
                totalControls += pData.controls.length;
                if (progress.percent === 100) completedProjects++;
                
                projectsHtml += `
                    <div style="padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md); margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${p.company}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${p.scenario}</div>
                            </div>
                            <span class="badge badge-${progress.percent === 100 ? 'green' : 'amber'}">${progress.percent}%</span>
                        </div>
                    </div>
                `;
            }
        });
        
        openModal('Portfolio Preview', `
            <div style="text-align: center; padding: 20px 10px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-shield-check" style="font-size: 36px; color: white;"></i>
                </div>
                <h3 style="margin-bottom: 4px;">Your GRC Portfolio</h3>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 24px;">Ready to share with hiring managers</p>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
                    <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">${completedProjects}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Projects</div>
                    </div>
                    <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${totalAssets}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Assets</div>
                    </div>
                    <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-red);">${totalRisks}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Risks</div>
                    </div>
                    <div style="background: var(--accent-purple-soft); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-purple);">${totalControls}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Controls</div>
                    </div>
                </div>
                
                <div style="text-align: left; max-height: 250px; overflow-y: auto;">
                    ${projectsHtml || '<p style="text-align: center; color: var(--text-muted); padding: 24px;">No projects started yet. Load demo data or start a project!</p>'}
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-secondary" onclick="closeModal(); app.exportToGitHub()"><i class="bi bi-github"></i> GitHub</button>
            <button class="btn btn-primary" onclick="closeModal(); app.downloadPortfolio()"><i class="bi bi-download"></i> Download</button>
        `);
    }
    
    generateAllPortfolios() {
        this.toast('Portfolio summaries generated! Review and copy your bullet points.', 'success');
        this.renderPortfolio();
    }
    
    generatePortfolio(projectId) {
        this.switchTab('portfolio');
        this.toast(`Portfolio summary generated for project!`, 'success');
    }

    // ===== Governance Add-ons (Static Practice Lab) =====
    ensureGovernanceKeys() {
        const d = this.getActiveData();
        if (!d.requirements) d.requirements = [];
        if (!d.exceptions) d.exceptions = [];
        if (!d.activityLog) d.activityLog = [];
    }
    logEvent(type, message, meta = {}) {
        this.ensureGovernanceKeys();
        const d = this.getActiveData();
        const entry = {
            id: this.generateId('LOG'),
            ts: new Date().toISOString(),
            type,
            message,
            meta,
            project: this.activeProject || null
        };
        d.activityLog.unshift(entry);
        if (d.activityLog.length > 500) d.activityLog.length = 500;
        this.saveData('activityLog');
    }

    // ---------- Requirements ----------
    renderRequirements() {
        this.ensureGovernanceKeys();
        const c = document.getElementById('tab-requirements');
        const d = this.getActiveData();
        const controls = d.controls || [];
        const evidence = d.evidence || [];
        const findings = d.findings || [];

        const rows = (d.requirements || []).map(req => {
            const statusBadge = req.status === 'Met' ? 'badge-green'
                : req.status === 'Partial' ? 'badge-amber'
                : req.status === 'Not applicable' ? 'badge-blue'
                : 'badge-red';
            return `<tr>
                <td><span class="font-mono text-muted">${this.escapeHtml(req.reqCode || req.id)}</span></td>
                <td class="font-semibold">${this.escapeHtml(req.title || '')}</td>
                <td><span class="badge ${statusBadge}">${this.escapeHtml(req.status || 'Not met')}</span></td>
                <td class="text-muted">${this.escapeHtml(req.framework || '')}</td>
                <td class="text-muted">${this.escapeHtml(req.priority || 'Medium')}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn-secondary btn-sm" onclick="app.editRequirement('${req.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="app.deleteRequirement('${req.id}')"><i class="bi bi-trash3"></i></button>
                </td>
            </tr>`;
        }).join('');

        c.innerHTML = `
            <div class="table-container">
                <div class="table-header">
                    <div>
                        <h2 style="margin:0 0 6px 0;"><i class="bi bi-list-check"></i> Compliance Requirements</h2>
                        <div class="text-muted">Lightweight requirement tracking (framework → requirement → controls/evidence/findings) for practice.</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="app.showRequirementModal()"><i class="bi bi-plus-lg"></i> Add Requirement</button>
                    </div>
                </div>
                ${ (d.requirements || []).length ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Req ID</th><th>Title</th><th>Status</th><th>Framework</th><th>Priority</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                ` : `
                    <div style="padding:18px; color: var(--text-secondary);">
                        No requirements yet. Add a few ISO/PCI/SOC2/UAE IA requirements and map them to your controls/evidence.
                    </div>
                `}
            </div>
        `;
    }

    showRequirementModal(req = null) {
        this.ensureGovernanceKeys();
        const d = this.getActiveData();
        const controls = d.controls || [];
        const evidence = d.evidence || [];
        const findings = d.findings || [];
        const isEdit = !!req;

        const controlOptions = controls.map(c => `<option value="${c.id}" ${req?.mappedControls?.includes(c.id) ? 'selected' : ''}>${this.escapeHtml(c.controlId || c.id)} — ${this.escapeHtml(c.title || c.name || '')}</option>`).join('');
        const evidenceOptions = evidence.map(e => `<option value="${e.id}" ${req?.evidenceIds?.includes(e.id) ? 'selected' : ''}>${this.escapeHtml(e.id)} — ${this.escapeHtml(e.title || '')}</option>`).join('');
        const findingOptions = findings.map(f => `<option value="${f.id}" ${req?.findingIds?.includes(f.id) ? 'selected' : ''}>${this.escapeHtml(f.id)} — ${this.escapeHtml(f.title || '')}</option>`).join('');

        openModal(isEdit ? 'Edit Requirement' : 'Add Requirement', `
            <div class="form-grid">
                <div>
                    <label class="form-label">Framework</label>
                    <input class="form-input" id="req-framework" value="${this.escapeHtml(req?.framework || '')}" placeholder="ISO 27001 / PCI DSS / SOC 2 / UAE IA">
                </div>
                <div>
                    <label class="form-label">Requirement ID</label>
                    <input class="form-input" id="req-code" value="${this.escapeHtml(req?.reqCode || '')}" placeholder="e.g., A.5.12 / PCI 6.3.2">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Title</label>
                    <input class="form-input" id="req-title" value="${this.escapeHtml(req?.title || '')}" placeholder="Short requirement title">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Statement</label>
                    <textarea class="form-textarea" id="req-statement" rows="4" placeholder="Write the requirement in your own words (min 20 chars)">${this.escapeHtml(req?.statement || '')}</textarea>
                </div>
                <div>
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="req-priority">
                        ${['Low','Medium','High','Critical'].map(p => `<option ${req?.priority===p?'selected':''}>${p}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="form-label">Status</label>
                    <select class="form-select" id="req-status">
                        ${['Not met','Partial','Met','Not applicable'].map(s => `<option ${req?.status===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Map to Controls (multi-select)</label>
                    <select class="form-select" id="req-controls" multiple size="6">${controlOptions || '<option disabled>No controls yet</option>'}</select>
                    <div class="text-muted" style="margin-top:6px;">Tip: create controls first, then map requirements.</div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Link Evidence (multi-select)</label>
                    <select class="form-select" id="req-evidence" multiple size="5">${evidenceOptions || '<option disabled>No evidence yet</option>'}</select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Link Findings (multi-select)</label>
                    <select class="form-select" id="req-findings" multiple size="5">${findingOptions || '<option disabled>No findings yet</option>'}</select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="req-notes" rows="3" placeholder="Assumptions, scope notes, auditor notes">${this.escapeHtml(req?.notes || '')}</textarea>
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="app.saveRequirement('${req?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>
        `);
    }

    saveRequirement(editId) {
        this.ensureGovernanceKeys();
        const d = this.getActiveData();
        const title = document.getElementById('req-title').value.trim();
        const statement = document.getElementById('req-statement').value.trim();
        if (title.length < 5) { this.toast('Title must be at least 5 characters', 'error'); return; }
        if (statement.length < 20) { this.toast('Statement must be at least 20 characters', 'error'); return; }

        const pickMulti = (id) => Array.from(document.getElementById(id).selectedOptions || []).map(o => o.value);
        const item = {
            id: editId || this.generateId('REQ'),
            framework: document.getElementById('req-framework').value.trim(),
            reqCode: document.getElementById('req-code').value.trim(),
            title,
            statement,
            priority: document.getElementById('req-priority').value,
            status: document.getElementById('req-status').value,
            mappedControls: pickMulti('req-controls'),
            evidenceIds: pickMulti('req-evidence'),
            findingIds: pickMulti('req-findings'),
            notes: document.getElementById('req-notes').value.trim(),
            createdAt: editId ? (d.requirements.find(x => x.id === editId)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (editId) {
            const idx = d.requirements.findIndex(x => x.id === editId);
            if (idx >= 0) d.requirements[idx] = item;
        } else {
            d.requirements.push(item);
        }
        this.saveData('requirements');
        this.logEvent('requirements', `${editId ? 'Updated' : 'Created'} requirement ${item.reqCode || item.id}`, { id: item.id });
        closeModal();
        this.renderRequirements();
        this.toast(editId ? 'Requirement updated' : 'Requirement added', 'success');
    }

    editRequirement(id) {
        this.ensureGovernanceKeys();
        const req = (this.getActiveData().requirements || []).find(r => r.id === id);
        if (req) this.showRequirementModal(req);
    }
    deleteRequirement(id) {
        this.ensureGovernanceKeys();
        if (!confirm('Delete this requirement?')) return;
        const d = this.getActiveData();
        d.requirements = (d.requirements || []).filter(r => r.id !== id);
        this.saveData('requirements');
        this.logEvent('requirements', `Deleted requirement ${id}`, { id });
        this.renderRequirements();
        this.toast('Requirement deleted', 'success');
    }

    // ---------- Exceptions ----------
    renderExceptions() {
        this.ensureGovernanceKeys();
        const c = document.getElementById('tab-exceptions');
        const d = this.getActiveData();

        const rows = (d.exceptions || []).map(ex => {
            const statusBadge = ex.status === 'Approved' ? 'badge-green'
                : ex.status === 'Expired' ? 'badge-red'
                : ex.status === 'Rejected' ? 'badge-red'
                : ex.status === 'Draft' ? 'badge-amber'
                : 'badge-blue';
            return `<tr>
                <td><span class="font-mono text-muted">${this.escapeHtml(ex.exCode || ex.id)}</span></td>
                <td class="font-semibold">${this.escapeHtml(ex.title || '')}</td>
                <td><span class="badge ${statusBadge}">${this.escapeHtml(ex.status || 'Draft')}</span></td>
                <td class="text-muted">${this.escapeHtml(ex.scopeType || '')}${ex.scopeId ? ' — ' + this.escapeHtml(ex.scopeId) : ''}</td>
                <td class="text-muted">${this.escapeHtml(ex.expiryDate || '')}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn-secondary btn-sm" onclick="app.editException('${ex.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="app.deleteException('${ex.id}')"><i class="bi bi-trash3"></i></button>
                </td>
            </tr>`;
        }).join('');

        c.innerHTML = `
            <div class="table-container">
                <div class="table-header">
                    <div>
                        <h2 style="margin:0 0 6px 0;"><i class="bi bi-shield-exclamation"></i> Exceptions (Risk Acceptance)</h2>
                        <div class="text-muted">Use this to practice risk acceptance, compensating controls, approvals, and expiries.</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="app.showExceptionModal()"><i class="bi bi-plus-lg"></i> Add Exception</button>
                    </div>
                </div>
                ${ (d.exceptions || []).length ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Exception ID</th><th>Title</th><th>Status</th><th>Scope</th><th>Expiry</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                ` : `
                    <div style="padding:18px; color: var(--text-secondary);">
                        No exceptions yet. Create one linked to a risk or requirement, add expiry and compensating controls.
                    </div>
                `}
            </div>
        `;
    }

    showExceptionModal(ex = null) {
        this.ensureGovernanceKeys();
        const d = this.getActiveData();
        const controls = d.controls || [];
        const isEdit = !!ex;

        const controlOptions = controls.map(c => `<option value="${c.id}" ${ex?.compensatingControls?.includes(c.id) ? 'selected' : ''}>${this.escapeHtml(c.controlId || c.id)} — ${this.escapeHtml(c.title || c.name || '')}</option>`).join('');

        openModal(isEdit ? 'Edit Exception' : 'Add Exception', `
            <div class="form-grid">
                <div>
                    <label class="form-label">Exception ID</label>
                    <input class="form-input" id="ex-code" value="${this.escapeHtml(ex?.exCode || '')}" placeholder="e.g., EX-001">
                </div>
                <div>
                    <label class="form-label">Status</label>
                    <select class="form-select" id="ex-status">
                        ${['Draft','Approved','Rejected','Expired'].map(s => `<option ${ex?.status===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Title</label>
                    <input class="form-input" id="ex-title" value="${this.escapeHtml(ex?.title || '')}" placeholder="Exception title">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Reason / Justification</label>
                    <textarea class="form-textarea" id="ex-reason" rows="4" placeholder="Explain business reason, scope, and acceptance rationale (min 20 chars)">${this.escapeHtml(ex?.reason || '')}</textarea>
                </div>
                <div>
                    <label class="form-label">Scope Type</label>
                    <select class="form-select" id="ex-scope-type">
                        ${['Risk','Control','Requirement','Finding','Other'].map(s => `<option ${ex?.scopeType===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="form-label">Scope ID</label>
                    <input class="form-input" id="ex-scope-id" value="${this.escapeHtml(ex?.scopeId || '')}" placeholder="e.g., RSK-001 / REQ-...">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Compensating Controls (multi-select)</label>
                    <select class="form-select" id="ex-controls" multiple size="6">${controlOptions || '<option disabled>No controls yet</option>'}</select>
                </div>
                <div>
                    <label class="form-label">Owner</label>
                    <input class="form-input" id="ex-owner" value="${this.escapeHtml(ex?.owner || '')}" placeholder="Control/Risk owner">
                </div>
                <div>
                    <label class="form-label">Approver</label>
                    <input class="form-input" id="ex-approver" value="${this.escapeHtml(ex?.approver || '')}" placeholder="Risk owner / CISO">
                </div>
                <div>
                    <label class="form-label">Review Date</label>
                    <input class="form-input" type="date" id="ex-review" value="${this.escapeHtml(ex?.reviewDate || '')}">
                </div>
                <div>
                    <label class="form-label">Expiry Date</label>
                    <input class="form-input" type="date" id="ex-expiry" value="${this.escapeHtml(ex?.expiryDate || '')}">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="ex-notes" rows="3">${this.escapeHtml(ex?.notes || '')}</textarea>
                </div>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="app.saveException('${ex?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>
        `);
    }

    saveException(editId) {
        this.ensureGovernanceKeys();
        const d = this.getActiveData();
        const title = document.getElementById('ex-title').value.trim();
        const reason = document.getElementById('ex-reason').value.trim();
        if (title.length < 5) { this.toast('Title must be at least 5 characters', 'error'); return; }
        if (reason.length < 20) { this.toast('Reason must be at least 20 characters', 'error'); return; }

        const pickMulti = (id) => Array.from(document.getElementById(id).selectedOptions || []).map(o => o.value);
        const item = {
            id: editId || this.generateId('EXC'),
            exCode: document.getElementById('ex-code').value.trim(),
            title,
            status: document.getElementById('ex-status').value,
            reason,
            scopeType: document.getElementById('ex-scope-type').value,
            scopeId: document.getElementById('ex-scope-id').value.trim(),
            compensatingControls: pickMulti('ex-controls'),
            owner: document.getElementById('ex-owner').value.trim(),
            approver: document.getElementById('ex-approver').value.trim(),
            reviewDate: document.getElementById('ex-review').value || '',
            expiryDate: document.getElementById('ex-expiry').value || '',
            notes: document.getElementById('ex-notes').value.trim(),
            createdAt: editId ? (d.exceptions.find(x => x.id === editId)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (editId) {
            const idx = d.exceptions.findIndex(x => x.id === editId);
            if (idx >= 0) d.exceptions[idx] = item;
        } else {
            d.exceptions.push(item);
        }
        this.saveData('exceptions');
        this.logEvent('exceptions', `${editId ? 'Updated' : 'Created'} exception ${item.exCode || item.id}`, { id: item.id });
        closeModal();
        this.renderExceptions();
        this.toast(editId ? 'Exception updated' : 'Exception added', 'success');
    }

    editException(id) {
        this.ensureGovernanceKeys();
        const ex = (this.getActiveData().exceptions || []).find(x => x.id === id);
        if (ex) this.showExceptionModal(ex);
    }
    deleteException(id) {
        this.ensureGovernanceKeys();
        if (!confirm('Delete this exception?')) return;
        const d = this.getActiveData();
        d.exceptions = (d.exceptions || []).filter(x => x.id !== id);
        this.saveData('exceptions');
        this.logEvent('exceptions', `Deleted exception ${id}`, { id });
        this.renderExceptions();
        this.toast('Exception deleted', 'success');
    }

    // ---------- Due & Activity ----------
    renderReviews() {
        this.ensureGovernanceKeys();
        const c = document.getElementById('tab-reviews');
        const d = this.getActiveData();
        const now = new Date();
        const toDate = (s) => { try { return s ? new Date(s) : null; } catch(e) { return null; } };
        const daysUntil = (dt) => Math.ceil((dt - now) / (1000*60*60*24));
        const daysSince = (dt) => Math.floor((now - dt) / (1000*60*60*24));

        const dueSoonWindow = 30;

        // Policies due
        const policyDue = (d.policies || []).filter(p => p.reviewDate).map(p => {
            const dt = toDate(p.reviewDate);
            if (!dt) return null;
            return { type:'Policy Review', id:p.id, title:p.title, date:p.reviewDate, delta: daysUntil(dt) };
        }).filter(x => x && x.delta <= dueSoonWindow);

        // Exceptions expiry/review
        const exDue = (d.exceptions || []).flatMap(ex => {
            const out = [];
            const exp = toDate(ex.expiryDate);
            if (exp) out.push({ type:'Exception Expiry', id:ex.id, title:ex.title, date:ex.expiryDate, delta: daysUntil(exp) });
            const rev = toDate(ex.reviewDate);
            if (rev) out.push({ type:'Exception Review', id:ex.id, title:ex.title, date:ex.reviewDate, delta: daysUntil(rev) });
            return out;
        }).filter(x => x.delta <= dueSoonWindow);

        // Evidence stale (use updatedAt)
        const evidenceStaleDays = 90;
        const evStale = (d.evidence || []).map(e => {
            const dt = toDate(e.updatedAt || e.createdAt);
            if (!dt) return null;
            const age = daysSince(dt);
            return age >= evidenceStaleDays ? { type:'Evidence Stale', id:e.id, title:e.title, date:(e.updatedAt||e.createdAt||''), delta:-age } : null;
        }).filter(Boolean);

        // Control testing due (last test date older than 90 days)
        const testDueDays = 90;
        const lastTestByControl = {};
        (d.controlTests || []).forEach(t => {
            if (!t.controlId) return;
            const dt = toDate(t.testDate || t.updatedAt || t.createdAt);
            if (!dt) return;
            if (!lastTestByControl[t.controlId] || dt > lastTestByControl[t.controlId]) lastTestByControl[t.controlId] = dt;
        });
        const testDue = (d.controls || []).map(ctrl => {
            const last = lastTestByControl[ctrl.id];
            if (!last) return { type:'Control Test', id:ctrl.id, title:(ctrl.title||ctrl.name||''), date:'(no tests yet)', delta: -9999 };
            const age = daysSince(last);
            return age >= testDueDays ? { type:'Control Test', id:ctrl.id, title:(ctrl.title||ctrl.name||''), date:last.toISOString().slice(0,10), delta:-age } : null;
        }).filter(Boolean);

        // Findings target date due
        const findingDue = (d.findings || []).filter(f => f.dueDate).map(f => {
            const dt = toDate(f.dueDate);
            if (!dt) return null;
            return { type:'Finding Due', id:f.id, title:f.title, date:f.dueDate, delta: daysUntil(dt) };
        }).filter(x => x && x.delta <= dueSoonWindow);

        const dueItems = [...policyDue, ...exDue, ...findingDue].sort((a,b)=>a.delta-b.delta);
        const overdueItems = dueItems.filter(x => x.delta < 0);
        const dueSoonItems = dueItems.filter(x => x.delta >= 0);

        const renderDueRow = (x) => {
            const badge = x.delta < 0 ? 'badge-red' : x.delta <= 7 ? 'badge-amber' : 'badge-blue';
            const when = x.delta < 0 ? `${Math.abs(x.delta)}d overdue` : `${x.delta}d`;
            return `<tr>
                <td class="font-semibold">${this.escapeHtml(x.type)}</td>
                <td>${this.escapeHtml(x.title || '')} <span class="text-muted">(${this.escapeHtml(x.id)})</span></td>
                <td class="text-muted">${this.escapeHtml(x.date || '')}</td>
                <td><span class="badge ${badge}">${when}</span></td>
            </tr>`;
        };

        const renderStaleRow = (x) => `<tr>
            <td class="font-semibold">${this.escapeHtml(x.type)}</td>
            <td>${this.escapeHtml(x.title || '')} <span class="text-muted">(${this.escapeHtml(x.id)})</span></td>
            <td class="text-muted">${this.escapeHtml(String(x.date || '').slice(0,10))}</td>
            <td>${
            (x.delta === -9999 || x.delta === null || x.delta === undefined)
              ? `<span class="badge badge-gray">Not tested yet</span>`
              : `<span class="badge badge-red">${Math.abs(x.delta)}d old</span>`
          }</td>
        </tr>`;

        const logs = (d.activityLog || []).slice(0, 60).map(l => {
            const dt = new Date(l.ts);
            const when = isNaN(dt.getTime()) ? '' : dt.toLocaleString();
            return `<tr>
                <td class="text-muted">${this.escapeHtml(when)}</td>
                <td><span class="badge badge-blue">${this.escapeHtml(l.type || 'log')}</span></td>
                <td>${this.escapeHtml(l.message || '')}</td>
            </tr>`;
        }).join('');

        c.innerHTML = `
            <div class="grid-2" style="gap:16px;">
                <div class="card">
                    <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 style="margin:0;"><i class="bi bi-calendar2-check"></i> Due & Overdue (next ${dueSoonWindow} days)</h3>
                            <div class="text-muted">A simple governance queue (no SaaS automation).</div>
                        </div>
                        <div class="text-muted" style="font-weight:600;">Overdue: ${overdueItems.length} • Due soon: ${dueSoonItems.length}</div>
                    </div>
                    <div class="card-content">
                        ${(dueItems.length) ? `
                        <div class="table-container" style="margin:0;">
                            <table>
                                <thead><tr><th>Type</th><th>Item</th><th>Date</th><th>Status</th></tr></thead>
                                <tbody>${dueItems.map(renderDueRow).join('')}</tbody>
                            </table>
                        </div>
                        ` : `<div class="text-muted">Nothing due in the next ${dueSoonWindow} days.</div>`}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 style="margin:0;"><i class="bi bi-clock-history"></i> Stale Evidence & Control Testing
<span class='text-xs text-muted'>(Demo data – some controls have not yet been tested)</span></h3>
                        <div class="text-muted">Evidence older than ${evidenceStaleDays}d and controls without recent tests.</div>
                    </div>
                    <div class="card-content">
                        ${(evStale.length || testDue.length) ? `
                        <div class="table-container" style="margin:0;">
                            <table>
                                <thead><tr><th>Type</th><th>Item</th><th>Last</th><th>Age</th></tr></thead>
                                <tbody>
                                    ${evStale.map(renderStaleRow).join('')}
                                    ${testDue.map(renderStaleRow).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : `<div class="text-muted">No stale evidence or overdue testing by the default thresholds.</div>`}
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:16px;">
                <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin:0;"><i class="bi bi-activity"></i> Activity Log</h3>
                        <div class="text-muted">Lightweight work trail for portfolio/interview proof.</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-secondary" onclick="app.exportActivityLog()"><i class="bi bi-download"></i> Export Log</button>
                        <button class="btn btn-danger" onclick="app.clearActivityLog()"><i class="bi bi-trash3"></i> Clear</button>
                    </div>
                </div>
                <div class="card-content">
                    ${(d.activityLog || []).length ? `
                    <div class="table-container" style="margin:0;">
                        <table>
                            <thead><tr><th>Time</th><th>Type</th><th>Message</th></tr></thead>
                            <tbody>${logs}</tbody>
                        </table>
                    </div>` : `<div class="text-muted">No activity yet. Adding requirements/exceptions will log actions here.</div>`}
                </div>
            </div>
        `;
    }

    exportActivityLog() {
        this.ensureGovernanceKeys();
        const d = this.getActiveData();
        const blob = new Blob([JSON.stringify(d.activityLog || [], null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `grc-activity-log${this.activeProject ? '-' + this.activeProject : ''}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Activity log exported', 'success');
    }
    clearActivityLog() {
        this.ensureGovernanceKeys();
        if (!confirm('Clear activity log?')) return;
        const d = this.getActiveData();
        d.activityLog = [];
        this.saveData('activityLog');
        this.toast('Activity log cleared', 'success');
        this.renderReviews();
    }

    downloadEvidenceAttachment(id) {
        const d = this.getActiveData();
        const e = (d.evidence || []).find(x => x.id === id);
        if (!e || !e.attachment || !e.attachment.dataUrl) { this.toast('No attachment found', 'error'); return; }
        const a = document.createElement('a');
        a.href = e.attachment.dataUrl;
        a.download = e.attachment.name || `evidence-${id}`;
        a.click();
        this.toast('Attachment downloaded', 'success');
    }


    // ===== LEARNING MODE (Career Mode) =====
    initLearningMode() {
        // Default: Practice Mode
        this.learningMode = localStorage.getItem('grc_learningMode') || 'practice';
        this.bindLearningUI();
        this.updateLearningUI();
    }

    bindLearningUI() {
        const toggle = document.getElementById('learning-mode-toggle');
        if (!toggle) return;

        toggle.checked = (this.learningMode === 'career');
        toggle.addEventListener('change', () => {
            this.learningMode = toggle.checked ? 'career' : 'practice';
            localStorage.setItem('grc_learningMode', this.learningMode);
            this.updateLearningUI();
            // In career mode, gently steer users to Scenarios (missions)
            if (this.learningMode === 'career') {
                this.toast('Career Mode enabled — follow the Guided Missions for a structured path.', 'success');
            } else {
                this.toast('Practice Mode enabled — explore freely.', 'success');
            }
        });
    }

    updateLearningUI() {
        const icon = document.getElementById('learning-mode-icon');
        if (icon) {
            icon.className = 'bi ' + (this.learningMode === 'career' ? 'bi-toggle2-on' : 'bi-toggle2-off');
            icon.style.color = this.learningMode === 'career' ? 'var(--accent-purple)' : 'var(--text-muted)';
        }

        // Update learning progress pill & action buttons
        const p = this.getLearningProgress();
        const txt = document.getElementById('learning-progress-text');
        if (txt) txt.textContent = `Learning: ${p.completed}/${p.total}`;

        const contBtn = document.getElementById('learning-continue-btn');
        if (contBtn) contBtn.style.display = (this.learningMode === 'career' && p.completed < p.total) ? 'inline-flex' : 'none';

        const certBtn = document.getElementById('learning-cert-btn');
        if (certBtn) certBtn.style.display = (p.missionsComplete) ? 'inline-flex' : 'none';

        // If Scenarios tab is open, re-render so the UI reflects mode (optional)
        if (this.currentTab === 'scenarios') {
            this.renderScenarios();
        }
    }

    getLearningModules() {
        // 9 learning modules total: 3 core missions + 6 selected scenarios
        const scenarios = this.getPracticeScenarioCatalog();
        const missions = scenarios.filter(s => s.isMission);
        const core = scenarios.filter(s => !s.isMission).slice(0, 6);
        return [...missions, ...core];
    }

    getLearningProgress() {
        const modules = this.getLearningModules();
        const completed = modules.filter(m => this.isScenarioCompleted(m.id, m.steps.length)).length;
        const missionsComplete = [101,102,103].every(id => this.isScenarioCompleted(id, (this.getPracticeScenarioCatalog().find(s => s.id===id)?.steps?.length||0)));
        return { completed, total: modules.length, missionsComplete };
    }

    isScenarioCompleted(scenarioId, totalSteps) {
        const key = `grc_scenario_${scenarioId}`;
        const stored = localStorage.getItem(key);
        if (!stored) return false;
        try {
            const progress = JSON.parse(stored);
            const done = progress.completedSteps?.length || 0;
            return totalSteps ? done >= totalSteps : done > 0;
        } catch(e) { return false; }
    }

    continueLearning() {
        // Take user to next incomplete module (prefer missions)
        const modules = this.getLearningModules();
        const next = modules.find(m => !this.isScenarioCompleted(m.id, m.steps.length));
        if (!next) { this.toast('You have completed all learning modules 🎉', 'success'); return; }
        this.switchTab('scenarios');
        this.startScenario(next.id);
    }

    // ===== MODAL EXAMPLES (Load Example) =====
    setModalContext(type, ctx = {}) { this.modalContext = { type, ...ctx }; }
    clearModalContext() { this.modalContext = null; }
    hasModalExample() {
        const t = this.modalContext?.type;
        return ['asset','risk','control','evidence','treatment','soa'].includes(t);
    }

    loadModalExample() {
        const t = this.modalContext?.type;
        if (!t) { this.toast('No example available for this form.', 'error'); return; }

        const fill = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
        const fillSelect = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };

        if (t === 'asset') {
            fill('f-name', 'Customer Database');
            fillSelect('f-type', 'Database');
            fillSelect('f-class', 'Critical');
            fill('f-owner', 'IT Operations');
            fillSelect('f-env', 'Production');
            fill('f-desc', 'Primary datastore containing customer PII and transaction metadata.');
            this.toast('Example loaded (Asset).', 'success');
            return;
        }
        if (t === 'risk') {
            fill('f-title', 'Unauthorized access to customer data');
            fillSelect('f-category', 'Access Control');
            fillSelect('f-likelihood', 'High');
            fillSelect('f-impact', 'High');
            fillSelect('f-status', 'Open');
            fill('f-owner', 'Security Lead');
            fill('f-desc', 'Weak MFA enforcement and inconsistent access reviews increase risk of account compromise and data exposure.');
            this.toast('Example loaded (Risk).', 'success');
            return;
        }
        if (t === 'control') {
            fill('f-name', 'Multi-Factor Authentication (MFA) for privileged access');
            fillSelect('f-framework', 'ISO 27001');
            fill('f-ref', 'A.5.17');
            fillSelect('f-effectiveness', 'Not Tested');
            fillSelect('f-frequency', 'Continuous');
            fill('f-owner', 'IAM Team');
            fill('f-desc', 'Require MFA for all privileged accounts and remote access. Enforce conditional access with device compliance.');
            this.toast('Example loaded (Control).', 'success');
            return;
        }
        if (t === 'evidence') {
            fill('f-title', 'MFA enforcement screenshot');
            fillSelect('f-type', 'Screenshot');
            // Control / Risk linkage fields vary; try common ids if present
            fill('f-owner', 'Security Lead');
            fill('f-desc', 'Screenshot from IdP showing MFA requirement enabled for admin roles; supports MFA control implementation.');
            this.toast('Example loaded (Evidence).', 'success');
            return;
        }
        if (t === 'treatment') {
            fillSelect('f-strategy', 'Mitigate');
            fill('f-owner', 'Security Lead');
            fillSelect('f-status', 'In Progress');
            fill('f-desc', 'Implement MFA for privileged accounts, run quarterly access reviews, and monitor anomalous sign-ins.');
            this.toast('Example loaded (Treatment).', 'success');
            return;
        }
        if (t === 'soa') {
            fillSelect('f-applicable', 'false');
            fill('f-justification', 'Not applicable: Organization does not process physical media; all assets are cloud-hosted with no removable storage usage in scope.');
            this.toast('Example loaded (SoA entry).', 'success');
            return;
        }

        this.toast('Example not available for this form yet.', 'error');
    }

    // ===== IT GENERAL CONTROLS (ITGC) =====
    renderItgc() {
        const c = document.getElementById('tab-itgc');
        const items = this.getActiveData().itgcControls || [];
        const domains = { 'Access Management': items.filter(i => i.domain === 'Access Management'), 'Change Management': items.filter(i => i.domain === 'Change Management'), 'IT Operations': items.filter(i => i.domain === 'IT Operations'), 'SDLC': items.filter(i => i.domain === 'SDLC') };
        const tested = items.filter(i => i.testStatus === 'Passed').length;
        const failed = items.filter(i => i.testStatus === 'Failed').length;
        const pending = items.filter(i => !i.testStatus || i.testStatus === 'Pending').length;
        
        const itgcTemplates = [
            { domain: 'Access Management', ref: 'ITGC-AC-01', name: 'User Access Provisioning', desc: 'New user access requires manager approval and is provisioned based on job role.', frequency: 'Per Occurrence', objective: 'Ensure only authorized users are granted access to financial systems.' },
            { domain: 'Access Management', ref: 'ITGC-AC-02', name: 'User Access Deprovisioning', desc: 'User access is removed within 24 hours of termination.', frequency: 'Per Occurrence', objective: 'Prevent unauthorized access by terminated employees.' },
            { domain: 'Access Management', ref: 'ITGC-AC-03', name: 'Periodic Access Review', desc: 'Access rights are reviewed quarterly by system owners.', frequency: 'Quarterly', objective: 'Ensure continued appropriateness of user access rights.' },
            { domain: 'Access Management', ref: 'ITGC-AC-04', name: 'Privileged Access Management', desc: 'Admin/privileged access is restricted and monitored.', frequency: 'Monthly', objective: 'Limit elevated access to authorized personnel with logging.' },
            { domain: 'Access Management', ref: 'ITGC-AC-05', name: 'Password Policy Enforcement', desc: 'Password complexity, expiration, and lockout policies are enforced.', frequency: 'Continuous', objective: 'Reduce risk of unauthorized access through weak credentials.' },
            { domain: 'Change Management', ref: 'ITGC-CM-01', name: 'Change Request & Approval', desc: 'All changes require documented request and management approval.', frequency: 'Per Occurrence', objective: 'Ensure changes to financial systems are authorized.' },
            { domain: 'Change Management', ref: 'ITGC-CM-02', name: 'Segregation of Duties (Dev/Prod)', desc: 'Developers cannot migrate code to production.', frequency: 'Continuous', objective: 'Prevent unauthorized or untested changes in production.' },
            { domain: 'Change Management', ref: 'ITGC-CM-03', name: 'Testing Before Deployment', desc: 'Changes are tested in a non-production environment before go-live.', frequency: 'Per Occurrence', objective: 'Ensure changes do not introduce errors to financial data.' },
            { domain: 'Change Management', ref: 'ITGC-CM-04', name: 'Emergency Change Process', desc: 'Emergency changes follow a streamlined approval with post-change review.', frequency: 'Per Occurrence', objective: 'Enable rapid response while maintaining control.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-01', name: 'Backup & Recovery', desc: 'Data backups are performed daily and tested quarterly.', frequency: 'Daily / Quarterly', objective: 'Ensure recoverability of financial data.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-02', name: 'Job Scheduling & Monitoring', desc: 'Batch jobs are scheduled, monitored, and failures are escalated.', frequency: 'Daily', objective: 'Ensure completeness and accuracy of automated processing.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-03', name: 'Incident Management', desc: 'IT incidents are logged, triaged, and resolved per SLA.', frequency: 'Per Occurrence', objective: 'Minimize impact of system disruptions on financial reporting.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-04', name: 'Physical & Environmental Security', desc: 'Data centers have restricted physical access and environmental controls.', frequency: 'Continuous', objective: 'Protect infrastructure supporting financial systems.' },
            { domain: 'SDLC', ref: 'ITGC-SD-01', name: 'System Development Methodology', desc: 'A formal SDLC methodology is followed for all system development.', frequency: 'Per Project', objective: 'Ensure systems are developed with appropriate controls built-in.' },
            { domain: 'SDLC', ref: 'ITGC-SD-02', name: 'Security Requirements in Design', desc: 'Security requirements are defined during design phase.', frequency: 'Per Project', objective: 'Embed security controls into new financial systems.' },
            { domain: 'SDLC', ref: 'ITGC-SD-03', name: 'User Acceptance Testing (UAT)', desc: 'Business users validate functionality before go-live.', frequency: 'Per Project', objective: 'Confirm systems meet business and financial reporting needs.' }
        ];

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #1e3a5f, #1a365d, #2c5282, #2b6cb0); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-bank2"></i></div>
                        <div style="flex: 1;">
                            <h1>IT General Controls</h1>
                            <p>IT General Controls across Access, Change, Operations, and SDLC domains</p>
                        </div>
                        <button class="btn" style="background: white; color: #1e3a5f; font-weight: 600;" onclick="app.showItgcModal()">
                            <i class="bi bi-plus-lg"></i> Add ITGC Control
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-shield-fill"></i> ${items.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${tested} Passed</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-x-circle"></i> ${failed} Failed</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-clock"></i> ${pending} Pending</div>
                    </div>
                </div>
            </div>

            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);">
                    <div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-shield-fill-check"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-blue);">${items.length}</div>
                    <div class="modern-kpi-label">Total ITGC Controls</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${items.length > 0 ? Math.round(tested / items.length * 100) : 0}%</div>
                    <div class="modern-kpi-label">Pass Rate</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-collection"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">4</div>
                    <div class="modern-kpi-label">ITGC Domains</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);">
                    <div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-diamond-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-red);">${failed}</div>
                    <div class="modern-kpi-label">Failed / Deficient</div>
                </div>
            </div>

            <!-- Quick-Load Templates -->
            <div class="modern-card" style="margin-bottom: 20px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-lightning-fill" style="color: var(--accent-amber);"></i> Quick-Load ITGC Templates</span>
                    <button class="btn btn-primary btn-sm" onclick="app.loadItgcTemplates()"><i class="bi bi-download"></i> Load All 16 ITGC Controls</button>
                </div>
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    ${Object.entries(domains).map(([domain, list]) => `
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent-blue);">${itgcTemplates.filter(t => t.domain === domain).length}</div>
                            <div style="font-size: 12px; color: var(--text-muted); font-weight: 600;">${domain}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${list.length} added</div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Domain breakdown -->
            ${Object.entries(domains).map(([domain, list]) => `
            <div class="modern-card" style="margin-bottom: 16px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-${domain === 'Access Management' ? 'key' : domain === 'Change Management' ? 'arrow-left-right' : domain === 'IT Operations' ? 'gear-wide-connected' : 'code-square'}" style="color: var(--accent-blue);"></i> ${domain}</span>
                    <span class="badge badge-blue">${list.length} controls</span>
                </div>
                ${list.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead><tr><th>Ref</th><th>Control Name</th><th>Frequency</th><th>Test Status</th><th>Test Date</th><th>Auditor Notes</th><th style="width: 100px;">Actions</th></tr></thead>
                        <tbody>
                            ${list.map(item => `
                            <tr onclick="app.editItgc('${item.id}')">
                                <td><span style="font-family: var(--font-mono); color: var(--accent-blue); font-weight: 600;">${this.esc(item.ref)}</span></td>
                                <td style="font-weight: 500;">${this.esc(item.name)}</td>
                                <td style="color: var(--text-secondary);">${item.frequency || '-'}</td>
                                <td><span class="badge badge-${item.testStatus === 'Passed' ? 'green' : item.testStatus === 'Failed' ? 'red' : 'amber'}">${item.testStatus || 'Pending'}</span></td>
                                <td style="color: var(--text-muted); font-size: 12px;">${item.testDate || '-'}</td>
                                <td style="color: var(--text-secondary); font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.esc(item.notes || '-')}</td>
                                <td>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editItgc('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteItgc('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `<div style="padding: 24px; text-align: center; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 24px;"></i><p style="margin-top: 8px;">No ${domain} controls yet. Add manually or load templates.</p></div>`}
            </div>
            `).join('')}
        `;
    }
    loadItgcTemplates() {
        const templates = [
            { domain: 'Access Management', ref: 'ITGC-AC-01', name: 'User Access Provisioning', desc: 'New user access requires manager approval and is provisioned based on job role.', frequency: 'Per Occurrence', objective: 'Ensure only authorized users are granted access to financial systems.' },
            { domain: 'Access Management', ref: 'ITGC-AC-02', name: 'User Access Deprovisioning', desc: 'User access is removed within 24 hours of termination.', frequency: 'Per Occurrence', objective: 'Prevent unauthorized access by terminated employees.' },
            { domain: 'Access Management', ref: 'ITGC-AC-03', name: 'Periodic Access Review', desc: 'Access rights are reviewed quarterly by system owners.', frequency: 'Quarterly', objective: 'Ensure continued appropriateness of user access rights.' },
            { domain: 'Access Management', ref: 'ITGC-AC-04', name: 'Privileged Access Management', desc: 'Admin/privileged access is restricted and monitored.', frequency: 'Monthly', objective: 'Limit elevated access to authorized personnel with logging.' },
            { domain: 'Access Management', ref: 'ITGC-AC-05', name: 'Password Policy Enforcement', desc: 'Password complexity, expiration, and lockout policies are enforced.', frequency: 'Continuous', objective: 'Reduce risk of unauthorized access through weak credentials.' },
            { domain: 'Change Management', ref: 'ITGC-CM-01', name: 'Change Request & Approval', desc: 'All changes require documented request and management approval.', frequency: 'Per Occurrence', objective: 'Ensure changes to financial systems are authorized.' },
            { domain: 'Change Management', ref: 'ITGC-CM-02', name: 'Segregation of Duties (Dev/Prod)', desc: 'Developers cannot migrate code to production.', frequency: 'Continuous', objective: 'Prevent unauthorized or untested changes in production.' },
            { domain: 'Change Management', ref: 'ITGC-CM-03', name: 'Testing Before Deployment', desc: 'Changes are tested in a non-production environment before go-live.', frequency: 'Per Occurrence', objective: 'Ensure changes do not introduce errors to financial data.' },
            { domain: 'Change Management', ref: 'ITGC-CM-04', name: 'Emergency Change Process', desc: 'Emergency changes follow a streamlined approval with post-change review.', frequency: 'Per Occurrence', objective: 'Enable rapid response while maintaining control.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-01', name: 'Backup & Recovery', desc: 'Data backups are performed daily and tested quarterly.', frequency: 'Daily / Quarterly', objective: 'Ensure recoverability of financial data.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-02', name: 'Job Scheduling & Monitoring', desc: 'Batch jobs are scheduled, monitored, and failures are escalated.', frequency: 'Daily', objective: 'Ensure completeness and accuracy of automated processing.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-03', name: 'Incident Management', desc: 'IT incidents are logged, triaged, and resolved per SLA.', frequency: 'Per Occurrence', objective: 'Minimize impact of system disruptions on financial reporting.' },
            { domain: 'IT Operations', ref: 'ITGC-OP-04', name: 'Physical & Environmental Security', desc: 'Data centers have restricted physical access and environmental controls.', frequency: 'Continuous', objective: 'Protect infrastructure supporting financial systems.' },
            { domain: 'SDLC', ref: 'ITGC-SD-01', name: 'System Development Methodology', desc: 'A formal SDLC methodology is followed for all system development.', frequency: 'Per Project', objective: 'Ensure systems are developed with appropriate controls built-in.' },
            { domain: 'SDLC', ref: 'ITGC-SD-02', name: 'Security Requirements in Design', desc: 'Security requirements are defined during design phase.', frequency: 'Per Project', objective: 'Embed security controls into new financial systems.' },
            { domain: 'SDLC', ref: 'ITGC-SD-03', name: 'User Acceptance Testing (UAT)', desc: 'Business users validate functionality before go-live.', frequency: 'Per Project', objective: 'Confirm systems meet business and financial reporting needs.' }
        ];
        const existing = this.getActiveData().itgcControls || [];
        const existingRefs = new Set(existing.map(e => e.ref));
        let added = 0;
        templates.forEach(t => {
            if (!existingRefs.has(t.ref)) {
                existing.push({ id: this.generateId('ITGC'), ...t, testStatus: 'Pending', testDate: '', notes: '', createdAt: new Date().toISOString() });
                added++;
            }
        });
        this.getActiveData().itgcControls = existing;
        this.saveData('itgcControls');
        this.renderItgc();
        this.toast(`Loaded ${added} ITGC control templates (${templates.length - added} already existed)`, 'success');
    }
    showItgcModal(item = null) {
        const isEdit = item !== null;
        openModal(isEdit ? 'Edit ITGC Control' : 'Add ITGC Control', `
            <div class="form-group"><label class="form-label">Control Name *</label><input type="text" class="form-input" id="f-name" value="${item?.name || ''}"></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Domain</label><select class="form-select" id="f-domain">${['Access Management', 'Change Management', 'IT Operations', 'SDLC'].map(d => `<option value="${d}" ${item?.domain === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Reference</label><input type="text" class="form-input" id="f-ref" value="${item?.ref || ''}" placeholder="e.g., ITGC-AC-01"></div>
            </div>
            <div class="form-group"><label class="form-label">Control Objective</label><textarea class="form-textarea" id="f-objective" rows="2">${item?.objective || ''}</textarea></div>
            <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc" rows="2">${item?.desc || ''}</textarea></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Frequency</label><select class="form-select" id="f-frequency">${['Continuous', 'Daily', 'Weekly', 'Monthly', 'Quarterly', 'Per Occurrence', 'Per Project', 'Annual'].map(f => `<option value="${f}" ${item?.frequency === f ? 'selected' : ''}>${f}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Test Status</label><select class="form-select" id="f-status">${['Pending', 'Passed', 'Failed', 'N/A'].map(s => `<option value="${s}" ${item?.testStatus === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Test Date</label><input type="date" class="form-input" id="f-testdate" value="${item?.testDate || ''}"></div>
                <div class="form-group"><label class="form-label">Auditor / Tester</label><input type="text" class="form-input" id="f-tester" value="${item?.tester || ''}"></div>
            </div>
            <div class="form-group"><label class="form-label">Auditor Notes</label><textarea class="form-textarea" id="f-notes" rows="2">${item?.notes || ''}</textarea></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveItgc('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveItgc(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter control name', 'error'); return; }
        const data = this.getActiveData();
        if (!data.itgcControls) data.itgcControls = [];
        const item = { id: editId || this.generateId('ITGC'), name, domain: document.getElementById('f-domain').value, ref: document.getElementById('f-ref').value, objective: document.getElementById('f-objective').value, desc: document.getElementById('f-desc').value, frequency: document.getElementById('f-frequency').value, testStatus: document.getElementById('f-status').value, testDate: document.getElementById('f-testdate').value, tester: document.getElementById('f-tester').value, notes: document.getElementById('f-notes').value, createdAt: editId ? (data.itgcControls.find(c => c.id === editId)?.createdAt || new Date().toISOString()) : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = data.itgcControls.findIndex(c => c.id === editId); if (idx !== -1) data.itgcControls[idx] = item; } else { data.itgcControls.push(item); }
        this.saveData('itgcControls'); closeModal(); this.renderItgc(); this.toast(editId ? 'ITGC control updated' : 'ITGC control created', 'success');
    }
    editItgc(id) { const d = this.getActiveData(); const item = (d.itgcControls || []).find(x => x.id === id); if (item) this.showItgcModal(item); }
    deleteItgc(id) { if (!confirm('Delete this ITGC control?')) return; const d = this.getActiveData(); d.itgcControls = (d.itgcControls || []).filter(x => x.id !== id); this.saveData('itgcControls'); this.renderItgc(); this.toast('ITGC control deleted', 'success'); }

    // ==================== SOX COMPLIANCE ====================
    renderSox() {
        const c = document.getElementById('tab-sox');
        const d = this.getActiveData();
        const items = d.soxEntries || [];
        const components = ['Control Environment', 'Risk Assessment', 'Control Activities', 'Info & Communication', 'Monitoring'];
        const byComponent = {};
        components.forEach(comp => { byComponent[comp] = items.filter(i => i.cosoComponent === comp); });
        const effective = items.filter(i => i.effectiveness === 'Effective').length;
        const deficient = items.filter(i => i.effectiveness === 'Deficient' || i.effectiveness === 'Material Weakness').length;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #1e3a5f, #312e81, #4c1d95, #1e40af); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-briefcase-fill"></i></div>
                        <div style="flex: 1;">
                            <h1>SOX Compliance</h1>
                            <p>Sarbanes-Oxley Section 302/404 controls mapped to COSO Internal Control Framework</p>
                        </div>
                        <button class="btn" style="background: white; color: #312e81; font-weight: 600;" onclick="app.showSoxModal()"><i class="bi bi-plus-lg"></i> Add SOX Control</button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-briefcase-fill"></i> ${items.length} Total</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-check-circle"></i> ${effective} Effective</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-x-circle"></i> ${deficient} Deficient</div>
                    </div>
                </div>
            </div>

            <!-- COSO Framework Visual -->
            <div class="modern-card" style="margin-bottom: 20px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-diagram-3" style="color: var(--accent-purple);"></i> COSO Internal Control Framework</span>
                    <button class="btn btn-primary btn-sm" onclick="app.loadSoxTemplates()"><i class="bi bi-download"></i> Load SOX Templates</button>
                </div>
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                    ${components.map((comp, i) => {
                        const count = byComponent[comp].length;
                        const eff = byComponent[comp].filter(x => x.effectiveness === 'Effective').length;
                        const colors = ['blue', 'purple', 'green', 'amber', 'cyan'];
                        return `<div style="background: var(--accent-${colors[i]}-soft); border-radius: var(--radius-lg); padding: 16px; text-align: center;">
                            <div style="font-size: 22px; font-weight: 800; color: var(--accent-${colors[i]});">${count}</div>
                            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600; margin-top: 4px;">${comp}</div>
                            <div style="font-size: 10px; color: var(--accent-green); margin-top: 2px;">${eff} effective</div>
                        </div>`;
                    }).join('')}
                </div>
            </div>

            <!-- SOX Controls by Component -->
            ${components.map(comp => {
                const list = byComponent[comp];
                return `<div class="modern-card" style="margin-bottom: 16px;">
                    <div class="modern-card-header"><span class="modern-card-title"><i class="bi bi-layers"></i> ${comp}</span><span class="badge badge-purple">${list.length}</span></div>
                    ${list.length > 0 ? `<div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>Ref</th><th>Control</th><th>Type</th><th>Assertion</th><th>Effectiveness</th><th>Walkthrough</th><th style="width:80px;">Actions</th></tr></thead><tbody>
                    ${list.map(item => `<tr>
                        <td><span style="font-family: var(--font-mono); color: var(--accent-purple); font-weight: 600;">${this.esc(item.ref || '-')}</span></td>
                        <td style="font-weight: 500; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.esc(item.name)}</td>
                        <td><span class="badge badge-${item.controlType === 'Preventive' ? 'green' : item.controlType === 'Detective' ? 'blue' : 'amber'}">${item.controlType || '-'}</span></td>
                        <td style="font-size: 12px;">${item.assertion || '-'}</td>
                        <td><span class="badge badge-${item.effectiveness === 'Effective' ? 'green' : item.effectiveness === 'Deficient' ? 'amber' : item.effectiveness === 'Material Weakness' ? 'red' : 'blue'}">${item.effectiveness || 'Not Tested'}</span></td>
                        <td style="font-size: 12px;">${item.walkthroughDate || 'Not done'}</td>
                        <td><div style="display: flex; gap: 4px;">
                            <button class="btn btn-ghost btn-sm" onclick="app.editSox('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-ghost btn-sm" onclick="app.deleteSox('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                        </div></td>
                    </tr>`).join('')}</tbody></table></div>` : `<div style="padding: 24px; text-align: center; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 24px;"></i><p style="margin-top: 8px;">No controls in ${comp} yet.</p></div>`}
                </div>`;
            }).join('')}

            <!-- Learning Callout -->
            <div class="modern-card" style="border-left: 4px solid var(--accent-purple);">
                <div style="padding: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;"><i class="bi bi-mortarboard"></i> SOX Learning Notes</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <strong>Section 302</strong> requires CEO/CFO to certify financial statements are accurate.<br>
                        <strong>Section 404</strong> requires management to assess internal control over financial reporting (ICFR) and external auditors to attest.<br>
                        <strong>COSO Framework</strong> has 5 components and 17 principles. Each SOX control maps to at least one component.<br>
                        <strong>Assertions</strong>: Completeness, Existence/Occurrence, Valuation, Rights & Obligations, Presentation & Disclosure.<br>
                        <strong>Key concept</strong>: A <em>material weakness</em> means a reasonable possibility that a material misstatement won't be prevented or detected.
                    </div>
                </div>
            </div>
        `;
    }
    loadSoxTemplates() {
        const templates = [
            { cosoComponent: 'Control Environment', ref: 'SOX-CE-01', name: 'Tone at the Top', desc: 'Board and management demonstrate commitment to integrity and ethical values.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Control Environment', ref: 'SOX-CE-02', name: 'Board Independence & Oversight', desc: 'Audit committee exercises oversight of ICFR with independence from management.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Control Environment', ref: 'SOX-CE-03', name: 'Organizational Structure & Authority', desc: 'Clear reporting lines and authority assignment for financial reporting.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Risk Assessment', ref: 'SOX-RA-01', name: 'Financial Reporting Risk Identification', desc: 'Risks to reliable financial reporting are identified and analyzed.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Risk Assessment', ref: 'SOX-RA-02', name: 'Fraud Risk Assessment', desc: 'Potential for fraud in financial reporting is considered.', controlType: 'Detective', assertion: 'Existence/Occurrence', effectiveness: 'Not Tested' },
            { cosoComponent: 'Risk Assessment', ref: 'SOX-RA-03', name: 'Change Management Assessment', desc: 'Changes in business/reporting that could affect ICFR are identified.', controlType: 'Preventive', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Control Activities', ref: 'SOX-CA-01', name: 'Journal Entry Review', desc: 'Non-standard and manual journal entries require documented approval.', controlType: 'Preventive', assertion: 'Completeness', effectiveness: 'Not Tested' },
            { cosoComponent: 'Control Activities', ref: 'SOX-CA-02', name: 'Account Reconciliation', desc: 'Key accounts are reconciled monthly with documented review and sign-off.', controlType: 'Detective', assertion: 'Valuation', effectiveness: 'Not Tested' },
            { cosoComponent: 'Control Activities', ref: 'SOX-CA-03', name: 'Segregation of Duties', desc: 'Incompatible duties are segregated (authorization, custody, recording).', controlType: 'Preventive', assertion: 'Existence/Occurrence', effectiveness: 'Not Tested' },
            { cosoComponent: 'Control Activities', ref: 'SOX-CA-04', name: 'Close Process Review', desc: 'Period-end financial close process includes management review and signoff.', controlType: 'Detective', assertion: 'Completeness', effectiveness: 'Not Tested' },
            { cosoComponent: 'Info & Communication', ref: 'SOX-IC-01', name: 'Financial Reporting Information Quality', desc: 'Relevant, quality information is identified and used in ICFR.', controlType: 'Preventive', assertion: 'Presentation', effectiveness: 'Not Tested' },
            { cosoComponent: 'Info & Communication', ref: 'SOX-IC-02', name: 'Whistleblower Mechanism', desc: 'Anonymous reporting channel available for financial irregularities.', controlType: 'Detective', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Monitoring', ref: 'SOX-MO-01', name: 'Ongoing Monitoring of ICFR', desc: 'Management performs ongoing and separate evaluations of ICFR.', controlType: 'Detective', assertion: 'All', effectiveness: 'Not Tested' },
            { cosoComponent: 'Monitoring', ref: 'SOX-MO-02', name: 'Deficiency Evaluation & Remediation', desc: 'ICFR deficiencies are evaluated and communicated to responsible parties.', controlType: 'Corrective', assertion: 'All', effectiveness: 'Not Tested' }
        ];
        const d = this.getActiveData(); if (!d.soxEntries) d.soxEntries = [];
        const existingRefs = new Set(d.soxEntries.map(e => e.ref));
        let added = 0;
        templates.forEach(t => { if (!existingRefs.has(t.ref)) { d.soxEntries.push({ id: this.generateId('SOX'), ...t, walkthroughDate: '', notes: '', createdAt: new Date().toISOString() }); added++; }});
        this.saveData('soxEntries'); this.renderSox(); this.toast(added > 0 ? `Loaded ${added} SOX control templates` : 'All templates already loaded', 'success');
    }
    showSoxModal(item) {
        const isEdit = !!item;
        openModal(isEdit ? 'Edit SOX Control' : 'Add SOX Control', `
            <div class="form-group"><label class="form-label">Control Name *</label><input class="form-input" id="f-name" value="${item?.name || ''}"></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">COSO Component *</label><select class="form-input" id="f-cosoComponent">${['Control Environment','Risk Assessment','Control Activities','Info & Communication','Monitoring'].map(c => `<option value="${c}" ${item?.cosoComponent===c?'selected':''}>${c}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Reference</label><input class="form-input" id="f-ref" value="${item?.ref || ''}" placeholder="SOX-CA-01"></div>
            </div>
            <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc" rows="2">${item?.desc || ''}</textarea></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Control Type</label><select class="form-input" id="f-controlType">${['Preventive','Detective','Corrective'].map(t => `<option value="${t}" ${item?.controlType===t?'selected':''}>${t}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Assertion</label><select class="form-input" id="f-assertion">${['All','Completeness','Existence/Occurrence','Valuation','Rights & Obligations','Presentation'].map(a => `<option value="${a}" ${item?.assertion===a?'selected':''}>${a}</option>`).join('')}</select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Effectiveness</label><select class="form-input" id="f-effectiveness">${['Not Tested','Effective','Deficient','Material Weakness'].map(e => `<option value="${e}" ${item?.effectiveness===e?'selected':''}>${e}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Walkthrough Date</label><input class="form-input" id="f-walkthroughDate" type="date" value="${item?.walkthroughDate || ''}"></div>
            </div>
            <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" rows="2">${item?.notes || ''}</textarea></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveSox('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveSox(editId) {
        const name = document.getElementById('f-name')?.value?.trim(); if (!name) { this.toast('Control name required', 'error'); return; }
        const entry = { name, cosoComponent: document.getElementById('f-cosoComponent')?.value, ref: document.getElementById('f-ref')?.value?.trim(), desc: document.getElementById('f-desc')?.value?.trim(), controlType: document.getElementById('f-controlType')?.value, assertion: document.getElementById('f-assertion')?.value, effectiveness: document.getElementById('f-effectiveness')?.value, walkthroughDate: document.getElementById('f-walkthroughDate')?.value, notes: document.getElementById('f-notes')?.value?.trim() };
        const d = this.getActiveData(); if (!d.soxEntries) d.soxEntries = [];
        if (editId) { const idx = d.soxEntries.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.soxEntries[idx], entry); }
        else { entry.id = this.generateId('SOX'); entry.createdAt = new Date().toISOString(); d.soxEntries.push(entry); }
        this.saveData('soxEntries'); closeModal(); this.renderSox(); this.toast(editId ? 'SOX control updated' : 'SOX control created', 'success');
    }
    editSox(id) { const item = (this.getActiveData().soxEntries || []).find(x => x.id === id); if (item) this.showSoxModal(item); }
    deleteSox(id) { if (!confirm('Delete this SOX control?')) return; const d = this.getActiveData(); d.soxEntries = (d.soxEntries || []).filter(x => x.id !== id); this.saveData('soxEntries'); this.renderSox(); this.toast('Deleted', 'success'); }

    // ==================== RISK APPETITE STATEMENT ====================
    renderRiskAppetite() {
        const c = document.getElementById('tab-risk-appetite');
        const d = this.getActiveData();
        const items = d.riskAppetiteStatements || [];
        const categories = [...new Set(items.map(i => i.category))];

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #7c2d12 0%, #b91c1c 50%, #dc2626 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-speedometer2"></i> Risk Appetite Statement</h2>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Define how much risk the organization is willing to accept across each risk category. This is the foundation of your GRC program.</p>
                    </div>
                    <button class="btn" style="background: white; color: #b91c1c; font-weight: 600;" onclick="app.showRiskAppetiteModal()"><i class="bi bi-plus-lg"></i> Add Statement</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${items.length}</div><div style="font-size: 12px; color: var(--text-muted);">Total Statements</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${items.filter(i=>i.appetiteLevel==='Averse').length}</div><div style="font-size: 12px; color: var(--text-muted);">Risk Averse</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${items.filter(i=>i.appetiteLevel==='Cautious'||i.appetiteLevel==='Moderate').length}</div><div style="font-size: 12px; color: var(--text-muted);">Cautious/Moderate</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${items.filter(i=>i.appetiteLevel==='Open'||i.appetiteLevel==='Hungry').length}</div><div style="font-size: 12px; color: var(--text-muted);">Open/Hungry</div></div></div>
            </div>

            <!-- Risk Appetite Table -->
            <div class="card"><div class="card-header" style="padding: 16px;"><span style="font-weight: 600;"><i class="bi bi-speedometer2"></i> Appetite Register</span></div>
            <div class="card-body" style="padding: 0;">
                ${items.length > 0 ? `<div style="overflow-x: auto;"><table style="margin:0;"><thead><tr><th>Category</th><th>Appetite Level</th><th>Tolerance (Max Score)</th><th>Statement</th><th>Board Approved</th><th style="width:80px;">Actions</th></tr></thead><tbody>
                ${items.map(item => {
                    const lvlColor = item.appetiteLevel === 'Averse' ? 'red' : item.appetiteLevel === 'Cautious' ? 'amber' : item.appetiteLevel === 'Moderate' ? 'blue' : item.appetiteLevel === 'Open' ? 'green' : 'purple';
                    return `<tr>
                    <td style="font-weight: 600;">${item.category}</td>
                    <td><span class="badge badge-${lvlColor}">${item.appetiteLevel}</span></td>
                    <td><div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; background: var(--bg-elevated); border-radius: 4px; height: 8px; max-width: 100px;"><div style="height: 100%; width: ${(item.toleranceMax/25)*100}%; background: var(--accent-${lvlColor}); border-radius: 4px;"></div></div><span style="font-size: 12px; font-weight: 600;">${item.toleranceMax}</span></div></td>
                    <td style="font-size: 12px; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.statement || '-'}</td>
                    <td>${item.boardApproved ? '<i class="bi bi-check-circle-fill" style="color: var(--accent-green);"></i>' : '<i class="bi bi-dash-circle" style="color: var(--text-muted);"></i>'}</td>
                    <td><div style="display: flex; gap: 4px;">
                        <button class="btn btn-ghost btn-sm" onclick="app.editRiskAppetite('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="app.deleteRiskAppetite('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                    </div></td></tr>`}).join('')}
                </tbody></table></div>` : `<div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-speedometer2" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No risk appetite statements defined. This is the first step in building your GRC program.</p><button class="btn btn-primary" onclick="app.loadRiskAppetiteTemplates()" style="margin-top: 12px;"><i class="bi bi-download"></i> Load Sample Statements</button></div>`}
            </div></div>

            <!-- Learning Callout -->
            <div class="card" style="margin-top: 20px; border-left: 4px solid var(--accent-red);">
                <div style="padding: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;"><i class="bi bi-mortarboard"></i> Risk Appetite Learning Notes</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <strong>Risk Appetite</strong> = How much risk the organization is <em>willing to accept</em> in pursuit of its objectives.<br>
                        <strong>Risk Tolerance</strong> = The specific <em>acceptable range of variation</em> around objectives (often a numeric threshold).<br>
                        <strong>Risk Capacity</strong> = The maximum risk the organization <em>can absorb</em> before failure.<br>
                        Risk appetite is set by the <strong>Board of Directors</strong> and flows down through the organization. Every risk in your register should be evaluated against these appetite statements. If a residual risk score exceeds the tolerance threshold, it requires escalation.
                    </div>
                </div>
            </div>
        `;
    }
    showRiskAppetiteModal(item) {
        const isEdit = !!item;
        openModal(isEdit ? 'Edit Risk Appetite Statement' : 'New Risk Appetite Statement', `
            <div class="form-group"><label class="form-label">Risk Category *</label><select class="form-input" id="f-category">${['Cybersecurity','Operational','Financial','Compliance/Regulatory','Reputational','Strategic','Third-Party','Data Privacy','Legal'].map(c => `<option value="${c}" ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Appetite Level *</label><select class="form-input" id="f-appetiteLevel">${['Averse','Cautious','Moderate','Open','Hungry'].map(l => `<option value="${l}" ${item?.appetiteLevel===l?'selected':''}>${l}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Tolerance Max (risk score 1-25)</label><input class="form-input" id="f-toleranceMax" type="number" min="1" max="25" value="${item?.toleranceMax || '12'}"></div>
            </div>
            <div class="form-group"><label class="form-label">Appetite Statement *</label><textarea class="form-textarea" id="f-statement" rows="3" placeholder="e.g. The organization accepts minimal cyber risk and requires all critical systems to maintain residual risk scores below 8.">${item?.statement || ''}</textarea></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Board Approved?</label><select class="form-input" id="f-boardApproved"><option value="true" ${item?.boardApproved?'selected':''}>Yes</option><option value="false" ${!item?.boardApproved?'selected':''}>No</option></select></div>
                <div class="form-group"><label class="form-label">Review Date</label><input class="form-input" id="f-reviewDate" type="date" value="${item?.reviewDate || ''}"></div>
            </div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveRiskAppetite('${item?.id || ''}')">${isEdit ? 'Update' : 'Save'}</button>`);
    }
    saveRiskAppetite(editId) {
        const statement = document.getElementById('f-statement')?.value?.trim(); if (!statement) { this.toast('Statement required', 'error'); return; }
        const entry = { category: document.getElementById('f-category')?.value, appetiteLevel: document.getElementById('f-appetiteLevel')?.value, toleranceMax: parseInt(document.getElementById('f-toleranceMax')?.value)||12, statement, boardApproved: document.getElementById('f-boardApproved')?.value === 'true', reviewDate: document.getElementById('f-reviewDate')?.value || '' };
        const d = this.getActiveData(); if (!d.riskAppetiteStatements) d.riskAppetiteStatements = [];
        if (editId) { const idx = d.riskAppetiteStatements.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.riskAppetiteStatements[idx], entry); }
        else { entry.id = this.generateId('RA'); entry.createdAt = new Date().toISOString(); d.riskAppetiteStatements.push(entry); }
        this.saveData('riskAppetiteStatements'); closeModal(); this.renderRiskAppetite(); this.toast(editId ? 'Statement updated' : 'Statement created', 'success');
    }
    loadRiskAppetiteTemplates() {
        const templates = [
            { category: 'Cybersecurity', appetiteLevel: 'Averse', toleranceMax: 6, statement: 'The organization has zero tolerance for cyber breaches impacting customer data. All critical systems must maintain residual risk scores at or below 6.', boardApproved: true },
            { category: 'Operational', appetiteLevel: 'Cautious', toleranceMax: 12, statement: 'Moderate operational disruptions are tolerable if recovery occurs within defined RTO. Residual risk scores above 12 require executive escalation.', boardApproved: true },
            { category: 'Financial', appetiteLevel: 'Moderate', toleranceMax: 15, statement: 'The organization accepts measured financial risk in pursuit of growth objectives, provided potential losses remain within quarterly reserves.', boardApproved: true },
            { category: 'Compliance/Regulatory', appetiteLevel: 'Averse', toleranceMax: 4, statement: 'Zero appetite for regulatory non-compliance. All regulatory requirements must be fully met. Any compliance gap requires immediate remediation.', boardApproved: true },
            { category: 'Reputational', appetiteLevel: 'Cautious', toleranceMax: 8, statement: 'The organization is cautious about reputational risk and will not pursue initiatives that could significantly damage public trust.', boardApproved: true },
            { category: 'Third-Party', appetiteLevel: 'Moderate', toleranceMax: 12, statement: 'Third-party risk is accepted where vendors meet minimum security and compliance standards. Critical vendors must maintain SOC 2 certification.', boardApproved: false },
            { category: 'Data Privacy', appetiteLevel: 'Averse', toleranceMax: 6, statement: 'No tolerance for privacy violations. All personal data processing must comply with applicable regulations (GDPR, CCPA, HIPAA).', boardApproved: true }
        ];
        const d = this.getActiveData(); if (!d.riskAppetiteStatements) d.riskAppetiteStatements = [];
        const existing = new Set(d.riskAppetiteStatements.map(e => e.category));
        let added = 0;
        templates.forEach(t => { if (!existing.has(t.category)) { d.riskAppetiteStatements.push({ id: this.generateId('RA'), ...t, reviewDate: '', createdAt: new Date().toISOString() }); added++; }});
        this.saveData('riskAppetiteStatements'); this.renderRiskAppetite(); this.toast(added > 0 ? `Loaded ${added} appetite statements` : 'All templates already loaded', 'success');
    }
    editRiskAppetite(id) { const item = (this.getActiveData().riskAppetiteStatements || []).find(x => x.id === id); if (item) this.showRiskAppetiteModal(item); }
    deleteRiskAppetite(id) { if (!confirm('Delete?')) return; const d = this.getActiveData(); d.riskAppetiteStatements = (d.riskAppetiteStatements || []).filter(x => x.id !== id); this.saveData('riskAppetiteStatements'); this.renderRiskAppetite(); this.toast('Deleted', 'success'); }

    // ==================== KEY RISK INDICATORS (KRI) ====================
    renderKRI() {
        const c = document.getElementById('tab-kri');
        const d = this.getActiveData();
        const items = d.kriEntries || [];
        const breached = items.filter(i => i.currentValue > i.redThreshold).length;
        const warning = items.filter(i => i.currentValue > i.amberThreshold && i.currentValue <= i.redThreshold).length;
        const healthy = items.filter(i => i.currentValue <= i.amberThreshold).length;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #065f46 0%, #047857 50%, #10b981 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-graph-up-arrow"></i> Key Risk Indicators</h2>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Monitor leading and lagging indicators with RAG thresholds to detect risk trends before they materialize.</p>
                    </div>
                    <button class="btn" style="background: white; color: #065f46; font-weight: 600;" onclick="app.showKRIModal()"><i class="bi bi-plus-lg"></i> Add KRI</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${items.length}</div><div style="font-size: 12px; color: var(--text-muted);">Total KRIs</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${healthy}</div><div style="font-size: 12px; color: var(--text-muted);">Within Appetite</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${warning}</div><div style="font-size: 12px; color: var(--text-muted);">Warning</div></div></div>
                <div class="card" style="border-left: 4px solid var(--accent-red);"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${breached}</div><div style="font-size: 12px; color: var(--text-muted);">Breached</div></div></div>
            </div>

            <!-- KRI Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; margin-bottom: 24px;">
                ${items.length > 0 ? items.map(item => {
                    const pct = Math.min(100, Math.round((item.currentValue / (item.redThreshold * 1.2)) * 100));
                    const status = item.currentValue > item.redThreshold ? 'red' : item.currentValue > item.amberThreshold ? 'amber' : 'green';
                    const trend = item.trend || 'stable';
                    const trendIcon = trend === 'increasing' ? 'bi-arrow-up-short' : trend === 'decreasing' ? 'bi-arrow-down-short' : 'bi-dash';
                    return `<div class="card" style="border-left: 4px solid var(--accent-${status});">
                        <div class="card-body" style="padding: 18px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 600;">${item.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${item.category} &bull; ${item.indicatorType || 'Lagging'}</div>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn btn-ghost btn-sm" onclick="app.editKRI('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-ghost btn-sm" onclick="app.deleteKRI('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                </div>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 28px; font-weight: 800; color: var(--accent-${status});">${item.currentValue}</span>
                                <span style="font-size: 12px; color: var(--text-muted);">${item.unit || ''}</span>
                                <span class="badge badge-${status}" style="font-size: 10px;"><i class="bi ${trendIcon}"></i> ${trend}</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-elevated); border-radius: 4px; margin-bottom: 8px; position: relative;">
                                <div style="position: absolute; left: ${Math.round((item.amberThreshold/(item.redThreshold*1.2))*100)}%; top: -2px; bottom: -2px; width: 2px; background: var(--accent-amber); border-radius: 1px;" title="Amber: ${item.amberThreshold}"></div>
                                <div style="position: absolute; left: ${Math.round((item.redThreshold/(item.redThreshold*1.2))*100)}%; top: -2px; bottom: -2px; width: 2px; background: var(--accent-red); border-radius: 1px;" title="Red: ${item.redThreshold}"></div>
                                <div style="height: 100%; width: ${pct}%; background: var(--accent-${status}); border-radius: 4px; transition: width 0.5s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted);">
                                <span>Green: 0-${item.amberThreshold}</span>
                                <span>Amber: ${item.amberThreshold+1}-${item.redThreshold}</span>
                                <span>Red: >${item.redThreshold}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('') : `<div class="card" style="grid-column: 1/-1;"><div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-graph-up-arrow" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No KRIs defined yet.</p><button class="btn btn-primary" onclick="app.loadKRITemplates()" style="margin-top: 12px;"><i class="bi bi-download"></i> Load Sample KRIs</button></div></div>`}
            </div>

            <!-- Learning Callout -->
            <div class="card" style="border-left: 4px solid var(--accent-green);">
                <div style="padding: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;"><i class="bi bi-mortarboard"></i> KRI Learning Notes</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <strong>Leading Indicators</strong> predict future risk events (e.g., % of systems unpatched).<br>
                        <strong>Lagging Indicators</strong> measure the impact of past events (e.g., number of breaches this quarter).<br>
                        <strong>RAG Thresholds</strong>: Green = within appetite, Amber = approaching tolerance, Red = tolerance breached &mdash; escalation required.<br>
                        KRIs should link to your <strong>Risk Appetite</strong> statements. When a KRI breaches red, it means the risk has exceeded the tolerance your board set.
                    </div>
                </div>
            </div>
        `;
    }
    showKRIModal(item) {
        const isEdit = !!item;
        openModal(isEdit ? 'Edit KRI' : 'New Key Risk Indicator', `
            <div class="form-group"><label class="form-label">KRI Name *</label><input class="form-input" id="f-name" value="${item?.name || ''}" placeholder="e.g. Mean Time to Patch Critical Vulnerabilities"></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Category</label><select class="form-input" id="f-category">${['Cybersecurity','Operational','Financial','Compliance','Third-Party','People','Technology'].map(c => `<option value="${c}" ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Indicator Type</label><select class="form-input" id="f-indicatorType"><option value="Leading" ${item?.indicatorType==='Leading'?'selected':''}>Leading</option><option value="Lagging" ${(!item||item?.indicatorType==='Lagging')?'selected':''}>Lagging</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Current Value *</label><input class="form-input" id="f-currentValue" type="number" min="0" value="${item?.currentValue ?? ''}"></div>
                <div class="form-group"><label class="form-label">Unit</label><input class="form-input" id="f-unit" value="${item?.unit || ''}" placeholder="e.g. days, %, count"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Amber Threshold</label><input class="form-input" id="f-amberThreshold" type="number" min="0" value="${item?.amberThreshold ?? '10'}"></div>
                <div class="form-group"><label class="form-label">Red Threshold</label><input class="form-input" id="f-redThreshold" type="number" min="0" value="${item?.redThreshold ?? '20'}"></div>
            </div>
            <div class="form-group"><label class="form-label">Trend</label><select class="form-input" id="f-trend"><option value="stable" ${item?.trend==='stable'?'selected':''}>Stable</option><option value="increasing" ${item?.trend==='increasing'?'selected':''}>Increasing (worsening)</option><option value="decreasing" ${item?.trend==='decreasing'?'selected':''}>Decreasing (improving)</option></select></div>
            <div class="form-group"><label class="form-label">Owner</label><input class="form-input" id="f-owner" value="${item?.owner || ''}" placeholder="e.g. CISO, Compliance Manager"></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveKRI('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveKRI(editId) {
        const name = document.getElementById('f-name')?.value?.trim(); if (!name) { this.toast('KRI name required', 'error'); return; }
        const entry = { name, category: document.getElementById('f-category')?.value, indicatorType: document.getElementById('f-indicatorType')?.value, currentValue: parseFloat(document.getElementById('f-currentValue')?.value)||0, unit: document.getElementById('f-unit')?.value?.trim(), amberThreshold: parseFloat(document.getElementById('f-amberThreshold')?.value)||10, redThreshold: parseFloat(document.getElementById('f-redThreshold')?.value)||20, trend: document.getElementById('f-trend')?.value, owner: document.getElementById('f-owner')?.value?.trim() };
        const d = this.getActiveData(); if (!d.kriEntries) d.kriEntries = [];
        if (editId) { const idx = d.kriEntries.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.kriEntries[idx], entry); }
        else { entry.id = this.generateId('KRI'); entry.createdAt = new Date().toISOString(); d.kriEntries.push(entry); }
        this.saveData('kriEntries'); closeModal(); this.renderKRI(); this.toast(editId ? 'KRI updated' : 'KRI created', 'success');
    }
    loadKRITemplates() {
        const templates = [
            { name: 'Mean Time to Patch Critical Vulns', category: 'Cybersecurity', indicatorType: 'Leading', currentValue: 12, unit: 'days', amberThreshold: 14, redThreshold: 30, trend: 'stable', owner: 'CISO' },
            { name: 'Phishing Click Rate', category: 'Cybersecurity', indicatorType: 'Leading', currentValue: 8, unit: '%', amberThreshold: 10, redThreshold: 20, trend: 'decreasing', owner: 'Security Awareness' },
            { name: 'Overdue Audit Findings', category: 'Compliance', indicatorType: 'Lagging', currentValue: 3, unit: 'count', amberThreshold: 5, redThreshold: 10, trend: 'stable', owner: 'Compliance Manager' },
            { name: 'Vendor SLA Breaches (Quarterly)', category: 'Third-Party', indicatorType: 'Lagging', currentValue: 2, unit: 'count', amberThreshold: 3, redThreshold: 7, trend: 'increasing', owner: 'Vendor Manager' },
            { name: 'System Availability', category: 'Operational', indicatorType: 'Lagging', currentValue: 99.7, unit: '%', amberThreshold: 99.5, redThreshold: 99, trend: 'stable', owner: 'IT Operations' },
            { name: 'Employee Turnover (Security Team)', category: 'People', indicatorType: 'Leading', currentValue: 15, unit: '%', amberThreshold: 20, redThreshold: 30, trend: 'stable', owner: 'HR / CISO' },
            { name: 'Days Since Last Incident', category: 'Cybersecurity', indicatorType: 'Lagging', currentValue: 47, unit: 'days', amberThreshold: 30, redThreshold: 14, trend: 'increasing', owner: 'SOC Manager' },
            { name: 'Regulatory Change Backlog', category: 'Compliance', indicatorType: 'Leading', currentValue: 5, unit: 'count', amberThreshold: 8, redThreshold: 15, trend: 'stable', owner: 'Compliance Manager' }
        ];
        const d = this.getActiveData(); if (!d.kriEntries) d.kriEntries = [];
        const existing = new Set(d.kriEntries.map(e => e.name));
        let added = 0;
        templates.forEach(t => { if (!existing.has(t.name)) { d.kriEntries.push({ id: this.generateId('KRI'), ...t, createdAt: new Date().toISOString() }); added++; }});
        this.saveData('kriEntries'); this.renderKRI(); this.toast(added > 0 ? `Loaded ${added} KRI templates` : 'All KRIs already loaded', 'success');
    }
    editKRI(id) { const item = (this.getActiveData().kriEntries || []).find(x => x.id === id); if (item) this.showKRIModal(item); }
    deleteKRI(id) { if (!confirm('Delete?')) return; const d = this.getActiveData(); d.kriEntries = (d.kriEntries || []).filter(x => x.id !== id); this.saveData('kriEntries'); this.renderKRI(); this.toast('Deleted', 'success'); }

    // ==================== BCM / DR PLANS ====================
    renderBCM() {
        const c = document.getElementById('tab-bcm');
        const d = this.getActiveData();
        const items = d.bcmPlans || [];
        const biaEntries = d.biaEntries || [];
        const tested = items.filter(i => i.lastTestDate).length;
        const approved = items.filter(i => i.status === 'Approved').length;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 50%, #3b82f6 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-shield-fill-plus"></i> BCM / Disaster Recovery Plans</h2>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Business Continuity and Disaster Recovery plans linked to your BIA. Define recovery strategies, team contacts, and test schedules.</p>
                    </div>
                    <button class="btn" style="background: white; color: #1e3a8a; font-weight: 600;" onclick="app.showBCMModal()"><i class="bi bi-plus-lg"></i> Add Plan</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${items.length}</div><div style="font-size: 12px; color: var(--text-muted);">Total Plans</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${approved}</div><div style="font-size: 12px; color: var(--text-muted);">Approved</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-purple);">${tested}</div><div style="font-size: 12px; color: var(--text-muted);">Tested</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${biaEntries.length}</div><div style="font-size: 12px; color: var(--text-muted);">BIA Entries (input)</div></div></div>
            </div>

            <div class="card"><div class="card-header" style="padding: 16px;"><span style="font-weight: 600;"><i class="bi bi-shield-fill-plus"></i> BCM / DR Plan Register</span></div>
            <div class="card-body" style="padding: 0;">
                ${items.length > 0 ? `<div style="overflow-x: auto;"><table style="margin:0;"><thead><tr><th>Plan Name</th><th>Type</th><th>Status</th><th>Recovery Strategy</th><th>BIA Process</th><th>Last Tested</th><th>Next Test</th><th style="width:80px;">Actions</th></tr></thead><tbody>
                ${items.map(item => {
                    const bia = biaEntries.find(b => b.id === item.biaId);
                    return `<tr>
                    <td style="font-weight: 600;">${item.planName}</td>
                    <td><span class="badge badge-${item.planType === 'BCP' ? 'blue' : item.planType === 'DRP' ? 'purple' : 'green'}">${item.planType}</span></td>
                    <td><span class="badge badge-${item.status === 'Approved' ? 'green' : item.status === 'Draft' ? 'amber' : 'blue'}">${item.status}</span></td>
                    <td style="font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.recoveryStrategy || '-'}</td>
                    <td style="font-size: 12px;">${bia?.processName || '-'}</td>
                    <td style="font-size: 12px;">${item.lastTestDate || 'Never'}</td>
                    <td style="font-size: 12px;">${item.nextTestDate || '-'}</td>
                    <td><div style="display: flex; gap: 4px;">
                        <button class="btn btn-ghost btn-sm" onclick="app.editBCM('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="app.deleteBCM('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                    </div></td></tr>`}).join('')}
                </tbody></table></div>` : `<div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-shield-fill-plus" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No BCM/DR plans yet. Start by completing your BIA, then create plans for critical processes.</p></div>`}
            </div></div>

            <!-- Learning Callout -->
            <div class="card" style="margin-top: 20px; border-left: 4px solid var(--accent-blue);">
                <div style="padding: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;"><i class="bi bi-mortarboard"></i> BCM / DR Learning Notes</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <strong>BCP (Business Continuity Plan)</strong> covers how to maintain business operations during a disruption.<br>
                        <strong>DRP (Disaster Recovery Plan)</strong> focuses specifically on restoring IT systems and data after a disaster.<br>
                        <strong>COOP (Continuity of Operations Plan)</strong> ensures essential government/critical functions continue.<br>
                        The <strong>BIA feeds into BCM</strong>: BIA identifies critical processes and their RTO/RPO, then BCM plans define HOW to meet those targets.<br>
                        Plans must be <strong>tested regularly</strong> (tabletop exercises, walkthroughs, full simulations) and updated after every test.
                    </div>
                </div>
            </div>
        `;
    }
    showBCMModal(item) {
        const isEdit = !!item;
        const d = this.getActiveData();
        openModal(isEdit ? 'Edit BCM/DR Plan' : 'New BCM/DR Plan', `
            <div class="form-group"><label class="form-label">Plan Name *</label><input class="form-input" id="f-planName" value="${item?.planName || ''}" placeholder="e.g. Payment Processing Disaster Recovery Plan"></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Plan Type *</label><select class="form-input" id="f-planType">${['BCP','DRP','COOP','Crisis Communication'].map(t => `<option value="${t}" ${item?.planType===t?'selected':''}>${t}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Status</label><select class="form-input" id="f-status">${['Draft','In Review','Approved','Outdated'].map(s => `<option value="${s}" ${item?.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
            </div>
            <div class="form-group"><label class="form-label">Linked BIA Process</label><select class="form-input" id="f-biaId"><option value="">-- None --</option>${(d.biaEntries||[]).map(b => `<option value="${b.id}" ${item?.biaId===b.id?'selected':''}>${b.processName} (${b.criticality})</option>`).join('')}</select></div>
            <div class="form-group"><label class="form-label">Recovery Strategy</label><textarea class="form-textarea" id="f-recoveryStrategy" rows="2" placeholder="e.g. Failover to secondary AWS region within 1 hour...">${item?.recoveryStrategy || ''}</textarea></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Plan Owner</label><input class="form-input" id="f-owner" value="${item?.owner || ''}" placeholder="e.g. IT Director"></div>
                <div class="form-group"><label class="form-label">Emergency Contact</label><input class="form-input" id="f-contact" value="${item?.contact || ''}" placeholder="e.g. +1-555-RECOVER"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Last Tested</label><input class="form-input" id="f-lastTestDate" type="date" value="${item?.lastTestDate || ''}"></div>
                <div class="form-group"><label class="form-label">Next Test Due</label><input class="form-input" id="f-nextTestDate" type="date" value="${item?.nextTestDate || ''}"></div>
            </div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveBCM('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveBCM(editId) {
        const planName = document.getElementById('f-planName')?.value?.trim(); if (!planName) { this.toast('Plan name required', 'error'); return; }
        const entry = { planName, planType: document.getElementById('f-planType')?.value, status: document.getElementById('f-status')?.value, biaId: document.getElementById('f-biaId')?.value, recoveryStrategy: document.getElementById('f-recoveryStrategy')?.value?.trim(), owner: document.getElementById('f-owner')?.value?.trim(), contact: document.getElementById('f-contact')?.value?.trim(), lastTestDate: document.getElementById('f-lastTestDate')?.value, nextTestDate: document.getElementById('f-nextTestDate')?.value };
        const d = this.getActiveData(); if (!d.bcmPlans) d.bcmPlans = [];
        if (editId) { const idx = d.bcmPlans.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.bcmPlans[idx], entry); }
        else { entry.id = this.generateId('BCM'); entry.createdAt = new Date().toISOString(); d.bcmPlans.push(entry); }
        this.saveData('bcmPlans'); closeModal(); this.renderBCM(); this.toast(editId ? 'Plan updated' : 'Plan created', 'success');
    }
    editBCM(id) { const item = (this.getActiveData().bcmPlans || []).find(x => x.id === id); if (item) this.showBCMModal(item); }
    deleteBCM(id) { if (!confirm('Delete?')) return; const d = this.getActiveData(); d.bcmPlans = (d.bcmPlans || []).filter(x => x.id !== id); this.saveData('bcmPlans'); this.renderBCM(); this.toast('Deleted', 'success'); }

    // ==================== CONTROL CROSSWALK ====================
    renderCrosswalk() {
        const c = document.getElementById('tab-crosswalk');
        const d = this.getActiveData();
        const items = d.crosswalkMappings || [];
        const controls = d.controls || [];
        const frameworks = ['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR', 'CIS Controls', 'COBIT'];
        const fwCounts = {};
        frameworks.forEach(fw => { fwCounts[fw] = items.filter(i => (i.frameworks || []).includes(fw)).length; });

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #4338ca 0%, #6d28d9 50%, #a855f7 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-intersect"></i> Control Crosswalk</h2>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Map one control to multiple frameworks. This is the #1 skill GRC employers look for &mdash; reducing audit fatigue through unified controls.</p>
                    </div>
                    <button class="btn" style="background: white; color: #4338ca; font-weight: 600;" onclick="app.showCrosswalkModal()"><i class="bi bi-plus-lg"></i> Add Mapping</button>
                </div>
            </div>

            <!-- Framework Coverage -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
                ${frameworks.map(fw => `<div class="card"><div class="card-body" style="padding: 14px; text-align: center;">
                    <div style="font-size: 22px; font-weight: 700; color: var(--accent-purple);">${fwCounts[fw]}</div>
                    <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">${fw}</div>
                </div></div>`).join('')}
            </div>

            <div class="card"><div class="card-header" style="padding: 16px;"><span style="font-weight: 600;"><i class="bi bi-intersect"></i> Crosswalk Mappings</span><span class="badge badge-purple" style="margin-left: 8px;">${items.length}</span></div>
            <div class="card-body" style="padding: 0;">
                ${items.length > 0 ? `<div style="overflow-x: auto;"><table style="margin:0;"><thead><tr><th>Control</th><th>Frameworks Mapped</th><th>References</th><th>Coverage Ratio</th><th style="width:80px;">Actions</th></tr></thead><tbody>
                ${items.map(item => {
                    const ctrl = controls.find(ct => ct.id === item.controlId);
                    const fwCount = (item.frameworks || []).length;
                    return `<tr>
                    <td style="font-weight: 600;">${ctrl?.name || item.controlName || 'Unknown'}</td>
                    <td>${(item.frameworks || []).map(fw => `<span class="badge badge-purple" style="font-size: 9px; margin: 1px;">${fw}</span>`).join(' ')}</td>
                    <td style="font-size: 11px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.references || '-'}</td>
                    <td><div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; background: var(--bg-elevated); border-radius: 4px; height: 8px; max-width: 80px;"><div style="height: 100%; width: ${(fwCount/frameworks.length)*100}%; background: var(--accent-purple); border-radius: 4px;"></div></div><span style="font-size: 11px;">${fwCount}/${frameworks.length}</span></div></td>
                    <td><div style="display: flex; gap: 4px;">
                        <button class="btn btn-ghost btn-sm" onclick="app.editCrosswalk('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="app.deleteCrosswalk('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                    </div></td></tr>`}).join('')}
                </tbody></table></div>` : `<div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-intersect" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No crosswalk mappings yet. Map your controls across frameworks to show audit efficiency.</p></div>`}
            </div></div>

            <!-- Learning Callout -->
            <div class="card" style="margin-top: 20px; border-left: 4px solid var(--accent-purple);">
                <div style="padding: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;"><i class="bi bi-mortarboard"></i> Crosswalk Learning Notes</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <strong>A crosswalk</strong> maps one control to multiple regulatory and industry frameworks simultaneously.<br>
                        <strong>Why it matters</strong>: If your MFA control satisfies ISO 27001 A.8.5, NIST CSF PR.AC-7, SOC 2 CC6.1, and PCI DSS 8.3 &mdash; you only need to test it <em>once</em>.<br>
                        <strong>Audit efficiency</strong>: Organizations with good crosswalks reduce audit time by 30-50% because one piece of evidence supports multiple framework requirements.<br>
                        This is the <strong>most in-demand GRC skill</strong> for career switchers. Employers want people who can consolidate compliance workloads.
                    </div>
                </div>
            </div>
        `;
    }
    showCrosswalkModal(item) {
        const isEdit = !!item;
        const d = this.getActiveData();
        const frameworks = ['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR', 'CIS Controls', 'COBIT'];
        const selectedFws = item?.frameworks || [];
        openModal(isEdit ? 'Edit Crosswalk Mapping' : 'New Crosswalk Mapping', `
            <div class="form-group"><label class="form-label">Control *</label><select class="form-input" id="f-controlId">${d.controls.length ? d.controls.map(ct => `<option value="${ct.id}" ${item?.controlId===ct.id?'selected':''}>${ct.name} (${ct.ref || ct.framework})</option>`).join('') : '<option value="">-- Add controls first --</option>'}</select></div>
            <div class="form-group"><label class="form-label">Frameworks (check all that apply) *</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                    ${frameworks.map(fw => `<label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;"><input type="checkbox" class="fw-check" value="${fw}" ${selectedFws.includes(fw)?'checked':''}> ${fw}</label>`).join('')}
                </div>
            </div>
            <div class="form-group"><label class="form-label">Reference IDs</label><input class="form-input" id="f-references" value="${item?.references || ''}" placeholder="e.g. A.8.5, PR.AC-7, CC6.1, 8.3"></div>
            <div class="form-group"><label class="form-label">Rationale</label><textarea class="form-textarea" id="f-rationale" rows="2">${item?.rationale || ''}</textarea></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveCrosswalk('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveCrosswalk(editId) {
        const controlId = document.getElementById('f-controlId')?.value; if (!controlId) { this.toast('Select a control', 'error'); return; }
        const fws = [...document.querySelectorAll('.fw-check:checked')].map(cb => cb.value); if (fws.length === 0) { this.toast('Select at least one framework', 'error'); return; }
        const ctrl = this.getActiveData().controls.find(c => c.id === controlId);
        const entry = { controlId, controlName: ctrl?.name || '', frameworks: fws, references: document.getElementById('f-references')?.value?.trim(), rationale: document.getElementById('f-rationale')?.value?.trim() };
        const d = this.getActiveData(); if (!d.crosswalkMappings) d.crosswalkMappings = [];
        if (editId) { const idx = d.crosswalkMappings.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.crosswalkMappings[idx], entry); }
        else { entry.id = this.generateId('CW'); entry.createdAt = new Date().toISOString(); d.crosswalkMappings.push(entry); }
        this.saveData('crosswalkMappings'); closeModal(); this.renderCrosswalk(); this.toast(editId ? 'Mapping updated' : 'Mapping created', 'success');
    }
    editCrosswalk(id) { const item = (this.getActiveData().crosswalkMappings || []).find(x => x.id === id); if (item) this.showCrosswalkModal(item); }
    deleteCrosswalk(id) { if (!confirm('Delete?')) return; const d = this.getActiveData(); d.crosswalkMappings = (d.crosswalkMappings || []).filter(x => x.id !== id); this.saveData('crosswalkMappings'); this.renderCrosswalk(); this.toast('Deleted', 'success'); }

    // ==================== AUDIT SIMULATOR ====================
    renderAuditSim() {
        const c = document.getElementById('tab-audit-sim');
        const d = this.getActiveData();
        const controls = d.controls || [];
        const evidence = d.evidence || [];
        const tests = d.controlTests || [];
        const findings = d.findings || [];
        const simState = this.auditSimState || { phase: 'planning', scope: [], samples: [], workpapers: [], deficiencies: [] };
        this.auditSimState = simState;

        // Calculate Audit Ready Score
        const ctrlWithEv = controls.filter(ct => evidence.some(e => e.controlId === ct.id || e.linkedControl === ct.id)).length;
        const ctrlTested = controls.filter(ct => tests.some(t => t.controlId === ct.id)).length;
        const evQuality = (d.evidenceScores || []).length;
        const auditScore = controls.length > 0 ? Math.round(((ctrlWithEv / controls.length) * 35 + (ctrlTested / controls.length) * 35 + Math.min(1, evQuality / Math.max(1, controls.length)) * 30)) : 0;
        const scoreColor = auditScore >= 80 ? 'green' : auditScore >= 50 ? 'amber' : 'red';

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div style="color: white;">
                        <h2 style="font-size: 22px; font-weight: 700; margin: 0 0 6px;"><i class="bi bi-clipboard2-data"></i> Audit Simulator</h2>
                        <p style="font-size: 13px; opacity: 0.7; margin: 0;">Practice the full audit lifecycle: Planning → Scoping → Sampling → Testing → Workpapers → Deficiency Classification</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: var(--radius-xl); padding: 20px 28px; text-align: center; backdrop-filter: blur(10px);">
                        <div style="font-size: 36px; font-weight: 800; color: ${auditScore >= 80 ? '#22c55e' : auditScore >= 50 ? '#f59e0b' : '#ef4444'};">${auditScore}%</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600;">AUDIT READY</div>
                    </div>
                </div>
            </div>

            <!-- Audit Readiness Breakdown -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${controls.length}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Controls in Scope</div>
                </div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: ${ctrlWithEv === controls.length && controls.length > 0 ? 'var(--accent-green)' : 'var(--accent-amber)'};">${ctrlWithEv}/${controls.length}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Evidence Collected</div>
                </div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: ${ctrlTested === controls.length && controls.length > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${ctrlTested}/${controls.length}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Controls Tested</div>
                </div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${findings.filter(f => f.status !== 'Closed').length}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Open Findings</div>
                </div></div>
            </div>

            <!-- Audit Phases -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header" style="padding: 16px;"><span style="font-weight: 700;"><i class="bi bi-signpost-2"></i> Audit Lifecycle Walkthrough</span></div>
                <div class="card-body" style="padding: 20px;">
                    <div style="display: flex; gap: 0; margin-bottom: 24px;">
                        ${['Planning', 'Scoping', 'Sampling', 'Fieldwork', 'Reporting'].map((phase, i) => {
                            const active = simState.phase === phase.toLowerCase();
                            const done = ['planning','scoping','sampling','fieldwork','reporting'].indexOf(simState.phase) > i;
                            return `<div style="flex: 1; text-align: center; position: relative;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; ${done ? 'background: var(--accent-green); color: white;' : active ? 'background: var(--accent-blue); color: white;' : 'background: var(--bg-elevated); color: var(--text-muted);'}">${done ? '<i class="bi bi-check"></i>' : i + 1}</div>
                                <div style="font-size: 11px; font-weight: ${active ? '700' : '500'}; color: ${active ? 'var(--accent-blue)' : 'var(--text-muted)'};">${phase}</div>
                                ${i < 4 ? `<div style="position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background: ${done ? 'var(--accent-green)' : 'var(--bg-elevated)'}; z-index: -1;"></div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                    ${simState.phase === 'planning' ? `
                        <div style="background: var(--accent-blue-soft); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: var(--accent-blue); margin-bottom: 8px;"><i class="bi bi-1-circle-fill"></i> Phase 1: Audit Planning</div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Define the audit objective, criteria, and timeline. An auditor begins by understanding WHAT they are auditing and AGAINST which standard.</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Audit Objective</label><input class="form-input" id="audit-objective" value="${simState.objective || ''}" placeholder="e.g. Assess effectiveness of access controls"></div>
                                <div><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Framework / Criteria</label><select class="form-input" id="audit-framework"><option>ISO 27001</option><option>SOC 2</option><option>NIST CSF</option><option>PCI DSS</option><option>HIPAA</option><option>SOX/COSO</option></select></div>
                            </div>
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="app.advanceAuditPhase('scoping')"><i class="bi bi-arrow-right"></i> Proceed to Scoping</button>
                        </div>
                    ` : simState.phase === 'scoping' ? `
                        <div style="background: var(--accent-purple-soft); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: var(--accent-purple); margin-bottom: 8px;"><i class="bi bi-2-circle-fill"></i> Phase 2: Scoping</div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Select which controls are in scope for this audit. In a real audit, scoping is done based on materiality, risk, and previous findings.</p>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 8px;">
                                ${controls.length > 0 ? controls.map(ct => `<label style="display: flex; align-items: center; gap: 8px; padding: 6px; font-size: 12px; cursor: pointer;"><input type="checkbox" class="audit-scope-check" value="${ct.id}" ${simState.scope.includes(ct.id)?'checked':''}> <strong>${ct.name}</strong> <span style="color: var(--text-muted);">(${ct.framework} ${ct.ref || ''})</span></label>`).join('') : '<p style="font-size: 12px; color: var(--text-muted); padding: 12px;">No controls to scope. Add controls first.</p>'}
                            </div>
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="app.advanceAuditPhase('sampling')"><i class="bi bi-arrow-right"></i> Proceed to Sampling</button>
                        </div>
                    ` : simState.phase === 'sampling' ? `
                        <div style="background: var(--accent-green-soft); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: var(--accent-green); margin-bottom: 8px;"><i class="bi bi-3-circle-fill"></i> Phase 3: Sampling</div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">${simState.scope.length} controls in scope. The system auto-generates a sample based on control frequency and population size.</p>
                            <div style="overflow-x: auto;"><table style="margin: 0;"><thead><tr><th>Control</th><th>Frequency</th><th>Population</th><th>Sample Size</th><th>Method</th></tr></thead><tbody>
                            ${simState.scope.map(ctId => {
                                const ct = controls.find(x => x.id === ctId);
                                if (!ct) return '';
                                const pop = ct.frequency === 'Continuous' ? 365 : ct.frequency === 'Monthly' ? 12 : ct.frequency === 'Quarterly' ? 4 : 1;
                                const sample = pop >= 250 ? 25 : pop >= 52 ? 15 : pop >= 12 ? 5 : pop >= 4 ? 2 : 1;
                                return `<tr><td style="font-size: 12px; font-weight: 600;">${ct.name}</td><td style="font-size: 12px;">${ct.frequency || 'Annual'}</td><td style="font-size: 12px;">${pop}</td><td style="font-size: 12px; font-weight: 700; color: var(--accent-blue);">${sample}</td><td style="font-size: 12px;">${pop > 25 ? 'Statistical' : 'Judgmental'}</td></tr>`;
                            }).join('')}</tbody></table></div>
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="app.advanceAuditPhase('fieldwork')"><i class="bi bi-arrow-right"></i> Proceed to Fieldwork</button>
                        </div>
                    ` : simState.phase === 'fieldwork' ? `
                        <div style="background: var(--accent-amber-soft); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: var(--accent-amber); margin-bottom: 8px;"><i class="bi bi-4-circle-fill"></i> Phase 4: Fieldwork & Testing</div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Now test each control in scope. For each control, evaluate evidence, run the test procedure, and classify any deficiency found.</p>
                            ${simState.scope.map(ctId => {
                                const ct = controls.find(x => x.id === ctId);
                                if (!ct) return '';
                                const hasEv = evidence.some(e => e.controlId === ctId || e.linkedControl === ctId);
                                const hasTest = tests.some(t => t.controlId === ctId);
                                const wp = simState.workpapers.find(w => w.controlId === ctId) || {};
                                return `<div style="border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 12px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 600; font-size: 13px;">${ct.name}</span>
                                        <div style="display: flex; gap: 4px;">
                                            <span class="badge badge-${hasEv ? 'green' : 'red'}">${hasEv ? 'Evidence ✓' : 'No Evidence'}</span>
                                            <span class="badge badge-${hasTest ? 'green' : 'amber'}">${hasTest ? 'Tested ✓' : 'Not Tested'}</span>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        <div><label style="font-size: 10px; font-weight: 600; color: var(--text-muted);">Test Result</label><select class="form-input audit-wp-result" data-ctrl="${ctId}" style="font-size: 12px; padding: 6px;">${['Not Tested','No Exception','Exception Noted','Not Applicable'].map(r => `<option value="${r}" ${wp.result===r?'selected':''}>${r}</option>`).join('')}</select></div>
                                        <div><label style="font-size: 10px; font-weight: 600; color: var(--text-muted);">Deficiency?</label><select class="form-input audit-wp-deficiency" data-ctrl="${ctId}" style="font-size: 12px; padding: 6px;">${['None','Control Deficiency','Significant Deficiency','Material Weakness'].map(d => `<option value="${d}" ${wp.deficiency===d?'selected':''}>${d}</option>`).join('')}</select></div>
                                    </div>
                                    <div style="margin-top: 6px;"><label style="font-size: 10px; font-weight: 600; color: var(--text-muted);">Workpaper Notes</label><textarea class="form-input audit-wp-notes" data-ctrl="${ctId}" rows="1" style="font-size: 11px; padding: 6px;" placeholder="Document your test procedure and observations...">${wp.notes || ''}</textarea></div>
                                </div>`;
                            }).join('')}
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="app.advanceAuditPhase('reporting')"><i class="bi bi-arrow-right"></i> Proceed to Reporting</button>
                        </div>
                    ` : `
                        <div style="background: linear-gradient(135deg, var(--accent-green-soft), var(--accent-blue-soft)); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: var(--accent-green); margin-bottom: 8px;"><i class="bi bi-5-circle-fill"></i> Phase 5: Audit Report Summary</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                <div style="text-align: center; padding: 12px; background: white; border-radius: var(--radius-md);"><div style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">${simState.scope.length}</div><div style="font-size: 11px;">Controls Tested</div></div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: var(--radius-md);"><div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${simState.workpapers.filter(w => w.result === 'No Exception').length}</div><div style="font-size: 11px;">No Exceptions</div></div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: var(--radius-md);"><div style="font-size: 24px; font-weight: 700; color: var(--accent-red);">${simState.workpapers.filter(w => w.deficiency !== 'None' && w.deficiency).length}</div><div style="font-size: 11px;">Deficiencies</div></div>
                            </div>
                            ${simState.workpapers.filter(w => w.deficiency && w.deficiency !== 'None').length > 0 ? `
                            <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px;">Deficiency Summary:</div>
                            ${simState.workpapers.filter(w => w.deficiency && w.deficiency !== 'None').map(w => {
                                const ct = controls.find(x => x.id === w.controlId);
                                return `<div class="health-gap ${w.deficiency === 'Material Weakness' ? '' : 'warning'}"><i class="bi bi-exclamation-triangle-fill health-gap-icon" style="color: var(--accent-${w.deficiency === 'Material Weakness' ? 'red' : 'amber'});"></i><div><div class="health-gap-text"><strong>${ct?.name || 'Unknown'}</strong>: ${w.deficiency}</div><div style="font-size: 11px; color: var(--text-muted);">${w.notes || 'No notes'}</div></div></div>`;
                            }).join('')}` : '<p style="font-size: 13px; color: var(--accent-green);"><i class="bi bi-patch-check-fill"></i> Clean audit — no deficiencies identified.</p>'}
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="app.auditSimState = { phase: 'planning', scope: [], samples: [], workpapers: [], deficiencies: [] }; app.renderAuditSim();"><i class="bi bi-arrow-counterclockwise"></i> Start New Audit</button>
                        </div>
                    `}
                </div>
            </div>

            <!-- Learning -->
            <div class="card" style="border-left: 4px solid var(--accent-purple);">
                <div style="padding: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;"><i class="bi bi-mortarboard"></i> Audit Simulator Learning Notes</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <strong>Control Deficiency</strong>: A control does not operate as designed, but the likelihood of material misstatement is remote.<br>
                        <strong>Significant Deficiency</strong>: A deficiency important enough to merit attention of those charged with governance.<br>
                        <strong>Material Weakness</strong>: A reasonable possibility that a material misstatement will not be prevented or detected on a timely basis.<br>
                        <strong>Sampling</strong>: For daily controls (population 250+), sample 25. Weekly (52), sample 15. Monthly (12), sample 5. Quarterly (4), sample 2.
                    </div>
                </div>
            </div>
        `;
    }
    advanceAuditPhase(phase) {
        const sim = this.auditSimState;
        if (phase === 'scoping') { sim.objective = document.getElementById('audit-objective')?.value || ''; sim.framework = document.getElementById('audit-framework')?.value || ''; }
        if (phase === 'sampling') { sim.scope = [...document.querySelectorAll('.audit-scope-check:checked')].map(cb => cb.value); if (sim.scope.length === 0) { this.toast('Select at least one control to scope', 'error'); return; } }
        if (phase === 'reporting') {
            sim.workpapers = sim.scope.map(ctId => ({
                controlId: ctId,
                result: document.querySelector(`.audit-wp-result[data-ctrl="${ctId}"]`)?.value || 'Not Tested',
                deficiency: document.querySelector(`.audit-wp-deficiency[data-ctrl="${ctId}"]`)?.value || 'None',
                notes: document.querySelector(`.audit-wp-notes[data-ctrl="${ctId}"]`)?.value || ''
            }));
        }
        sim.phase = phase; this.renderAuditSim();
    }

    // ==================== GUIDED MISSIONS ====================
    renderMissions() {
        const c = document.getElementById('tab-missions');
        const d = this.getActiveData();
        const missions = [
            { id: 'M1', title: 'Build Your First Risk Register', difficulty: 'Beginner', time: '15 min', desc: 'Create a complete risk register from scratch: identify assets, assess risks, and link controls.', icon: 'bi-shield-exclamation', color: 'blue',
              steps: [
                { task: 'Add 3 assets to your inventory', check: () => d.assets.length >= 3, goTo: 'assets', hint: 'Think: what systems hold sensitive data? Database, web app, identity provider.' },
                { task: 'Create 3 risks linked to those assets', check: () => d.risks.length >= 3, goTo: 'risks', hint: 'Use the format: [Threat] exploits [Vulnerability] causing [Impact] to [Asset]' },
                { task: 'Score each risk (likelihood × impact)', check: () => d.risks.filter(r => r.likelihood && r.impact).length >= 3, goTo: 'risks', hint: 'Be honest with scores. Not everything is 5×5.' },
                { task: 'Add 3 controls that mitigate those risks', check: () => d.controls.length >= 3, goTo: 'controls', hint: 'A control should be specific and testable: "Enforce MFA on admin accounts" not "improve security"' },
                { task: 'View your Risk Matrix', check: () => true, goTo: 'matrix', hint: 'This shows your risks plotted by likelihood vs impact. Red = needs immediate treatment.' }
              ]},
            { id: 'M2', title: 'Prepare for Your First Audit', difficulty: 'Intermediate', time: '25 min', desc: 'Collect evidence, test controls, document findings, and run the audit simulator.', icon: 'bi-clipboard2-data', color: 'purple',
              steps: [
                { task: 'Collect evidence for at least 3 controls', check: () => d.evidence.length >= 3, goTo: 'evidence', hint: 'Evidence types: screenshots, config exports, policy docs, log files.' },
                { task: 'Score evidence quality for 2+ items', check: () => (d.evidenceScores||[]).length >= 2, goTo: 'evidence-scoring', hint: 'Rate: relevance, completeness, timeliness, authenticity, traceability.' },
                { task: 'Run control tests on 3 controls', check: () => d.controlTests.length >= 3, goTo: 'testing', hint: 'Document the test procedure: what did you check? What was the expected vs actual result?' },
                { task: 'Document any findings from testing', check: () => d.findings.length >= 1, goTo: 'findings', hint: 'If a test failed, create a finding with severity, owner, and due date.' },
                { task: 'Run the Audit Simulator', check: () => !!this.auditSimState?.phase && this.auditSimState.phase !== 'planning', goTo: 'audit-sim', hint: 'Walk through all 5 phases: planning, scoping, sampling, fieldwork, reporting.' }
              ]},
            { id: 'M3', title: 'Build a Compliance Crosswalk', difficulty: 'Advanced', time: '20 min', desc: 'Map your controls across multiple frameworks. This is the #1 skill employers look for in GRC professionals.', icon: 'bi-intersect', color: 'green',
              steps: [
                { task: 'Ensure you have 5+ controls', check: () => d.controls.length >= 5, goTo: 'controls', hint: 'Add controls for MFA, logging, encryption, access reviews, backup.' },
                { task: 'Create 3+ crosswalk mappings', check: () => (d.crosswalkMappings||[]).length >= 3, goTo: 'crosswalk', hint: 'Map each control to every framework it satisfies. MFA maps to ISO, NIST, SOC 2, PCI DSS.' },
                { task: 'Add framework reference IDs', check: () => (d.crosswalkMappings||[]).filter(m => m.references).length >= 2, goTo: 'crosswalk', hint: 'e.g. ISO A.8.5, NIST PR.AC-7, SOC 2 CC6.1' },
                { task: 'Review traceability for gaps', check: () => true, goTo: 'traceability', hint: 'Look for risks with no controls, controls with no evidence — these are audit gaps.' }
              ]},
            { id: 'M4', title: 'Risk Appetite to KRI Pipeline', difficulty: 'Intermediate', time: '20 min', desc: 'Build the complete risk governance pipeline: appetite → risks → KRIs → monitoring.', icon: 'bi-speedometer2', color: 'red',
              steps: [
                { task: 'Define 3+ risk appetite statements', check: () => (d.riskAppetiteStatements||[]).length >= 3, goTo: 'risk-appetite', hint: 'Set appetite for Cybersecurity (Averse), Operational (Cautious), Financial (Moderate).' },
                { task: 'Ensure risks have categories matching appetite', check: () => d.risks.filter(r => r.category).length >= 3, goTo: 'risks', hint: 'Risk categories should align with your appetite categories.' },
                { task: 'Create 4+ Key Risk Indicators', check: () => (d.kriEntries||[]).length >= 4, goTo: 'kri', hint: 'Mix leading (predictive) and lagging (reactive) indicators.' },
                { task: 'Set KRI thresholds aligned to appetite', check: () => (d.kriEntries||[]).filter(k => k.amberThreshold && k.redThreshold).length >= 3, goTo: 'kri', hint: 'Red threshold = appetite breach. Amber = approaching tolerance.' }
              ]},
            { id: 'M5', title: 'Business Continuity Lifecycle', difficulty: 'Advanced', time: '25 min', desc: 'Complete the BIA → BCM pipeline. Identify critical processes, define recovery strategies, create plans.', icon: 'bi-shield-fill-plus', color: 'amber',
              steps: [
                { task: 'Add 3+ BIA entries with RTO/RPO', check: () => (d.biaEntries||[]).length >= 3, goTo: 'bia', hint: 'Identify your most critical business processes. What breaks if they go down?' },
                { task: 'Create BCM/DR plans for critical processes', check: () => (d.bcmPlans||[]).length >= 2, goTo: 'bcm', hint: 'Link each plan to its BIA entry. Define the recovery strategy.' },
                { task: 'Document a crisis communication plan', check: () => (d.bcmPlans||[]).some(p => p.planType === 'Crisis Communication'), goTo: 'bcm', hint: 'Who gets notified? In what order? Within what timeframe?' },
                { task: 'Set test schedules for all plans', check: () => (d.bcmPlans||[]).filter(p => p.nextTestDate).length >= 2, goTo: 'bcm', hint: 'A plan that has never been tested is not a plan.' }
              ]}
        ];

        const getMissionProgress = (m) => {
            const done = m.steps.filter(s => s.check()).length;
            return { done, total: m.steps.length, pct: Math.round((done / m.steps.length) * 100) };
        };
        const totalDone = missions.reduce((sum, m) => sum + getMissionProgress(m).done, 0);
        const totalSteps = missions.reduce((sum, m) => sum + m.steps.length, 0);

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #7c2d12 0%, #9333ea 50%, #2563eb 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px;">
                <div style="color: white; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; margin: 0 0 6px;"><i class="bi bi-flag-fill"></i> Guided Missions</h2>
                        <p style="font-size: 13px; opacity: 0.7; margin: 0;">Step-by-step missions that teach you real GRC workflows. Complete them all to build a portfolio-ready GRC program.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: var(--radius-lg); padding: 12px 20px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 800;">${totalDone}/${totalSteps}</div>
                        <div style="font-size: 10px; opacity: 0.7;">Steps Complete</div>
                    </div>
                </div>
            </div>

            <div style="display: grid; gap: 16px;">
                ${missions.map(m => {
                    const prog = getMissionProgress(m);
                    const expanded = this.expandedMission === m.id;
                    return `<div class="card" style="border-left: 4px solid var(--accent-${m.color}); overflow: hidden;">
                        <div style="padding: 20px; cursor: pointer;" onclick="app.expandedMission = app.expandedMission === '${m.id}' ? null : '${m.id}'; app.renderMissions();">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent-${m.color}-soft); display: flex; align-items: center; justify-content: center;"><i class="bi ${m.icon}" style="color: var(--accent-${m.color}); font-size: 18px;"></i></div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 15px;">${m.title}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${m.difficulty} · ${m.time} · ${prog.done}/${prog.total} steps</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${prog.pct === 100 ? '<span class="badge badge-green"><i class="bi bi-trophy-fill"></i> Complete</span>' : `<div style="width: 80px; height: 8px; background: var(--bg-elevated); border-radius: 4px;"><div style="height: 100%; width: ${prog.pct}%; background: var(--accent-${m.color}); border-radius: 4px;"></div></div>`}
                                    <i class="bi bi-chevron-${expanded ? 'up' : 'down'}" style="color: var(--text-muted);"></i>
                                </div>
                            </div>
                        </div>
                        ${expanded ? `<div style="padding: 0 20px 20px; border-top: 1px solid var(--border-subtle);">
                            <p style="font-size: 13px; color: var(--text-secondary); margin: 12px 0 16px;">${m.desc}</p>
                            ${m.steps.map((s, i) => {
                                const done = s.check();
                                return `<div style="display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle);">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; ${done ? 'background: var(--accent-green); color: white;' : 'background: var(--bg-elevated); color: var(--text-muted);'} font-size: 11px; font-weight: 700;">${done ? '<i class="bi bi-check"></i>' : i + 1}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: ${done ? '500' : '600'}; ${done ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${s.task}</div>
                                        ${!done ? `<div style="font-size: 11px; color: var(--accent-blue); margin-top: 4px;"><i class="bi bi-lightbulb"></i> ${s.hint}</div>` : ''}
                                    </div>
                                    ${!done ? `<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); app.switchTab('${s.goTo}');">Go →</button>` : ''}
                                </div>`;
                            }).join('')}
                        </div>` : ''}
                    </div>`;
                }).join('')}
            </div>
        `;
    }

    // ==================== INTERVIEW PREP GENERATOR ====================
    renderInterviewPrep() {
        const c = document.getElementById('tab-interview-prep');
        const d = this.getActiveData();
        const risks = d.risks || [];
        const controls = d.controls || [];
        const findings = d.findings || [];
        const evidence = d.evidence || [];
        const hasData = risks.length > 0 || controls.length > 0;

        const questions = [];
        if (risks.length > 0) {
            const highRisk = risks.find(r => (r.likelihood * r.impact) >= 16) || risks[0];
            questions.push({ q: 'Tell me about a risk assessment you conducted.', a: `I conducted a risk assessment and identified ${risks.length} risks across categories including ${[...new Set(risks.map(r => r.category))].slice(0,3).join(', ')}. One of the highest-rated risks was "${highRisk.title}" which I scored as ${highRisk.likelihood}×${highRisk.impact}=${highRisk.likelihood*highRisk.impact}. I recommended ${risks.filter(r => r.status === 'In Progress').length > 0 ? 'treatment plans for high-priority items' : 'immediate mitigation for critical risks'}.`, category: 'Risk Management' });
            questions.push({ q: 'How do you prioritize risks?', a: `I use a 5×5 likelihood × impact matrix. In my assessment, I identified ${risks.filter(r => (r.likelihood*r.impact) >= 20).length} critical risks, ${risks.filter(r => (r.likelihood*r.impact) >= 12 && (r.likelihood*r.impact) < 20).length} high risks, and ${risks.filter(r => (r.likelihood*r.impact) < 12).length} medium/low risks. Critical and high risks get immediate attention with treatment plans, while lower risks may be accepted if they fall within the organization's risk appetite.`, category: 'Risk Management' });
        }
        if (controls.length > 0) {
            const effective = controls.filter(c => c.effectiveness === 'Effective').length;
            questions.push({ q: 'How do you evaluate control effectiveness?', a: `I maintained a control catalog of ${controls.length} controls across frameworks including ${[...new Set(controls.map(c => c.framework))].slice(0,3).join(', ')}. ${effective} controls were rated Effective, ${controls.filter(c => c.effectiveness === 'Partially Effective').length} Partially Effective, and ${controls.filter(c => c.effectiveness === 'Ineffective').length} Ineffective. Controls are evaluated through a combination of testing, evidence review, and operational monitoring.`, category: 'Controls' });
        }
        if (findings.length > 0) {
            questions.push({ q: 'Tell me about a finding you identified and how you remediated it.', a: `During testing, I identified ${findings.length} findings. ${findings.filter(f => f.severity === 'Critical' || f.severity === 'High').length} were rated Critical/High severity. For example, I documented a finding related to "${findings[0].title || findings[0].description?.substring(0, 50) || 'control gap'}" and worked with the control owner to develop a remediation plan with a target date. I tracked it through our findings register until validated closure.`, category: 'Audit & Findings' });
        }
        if (evidence.length > 0) {
            questions.push({ q: 'What types of evidence do you collect during an audit?', a: `I collected ${evidence.length} pieces of evidence including types like ${[...new Set(evidence.map(e => e.type))].slice(0,4).join(', ')}. Good evidence must be relevant, complete, timely, authentic, and traceable. I scored each piece against these criteria and ensured every control had supporting evidence before audit.`, category: 'Evidence' });
        }
        if ((d.crosswalkMappings || []).length > 0) {
            questions.push({ q: 'Have you mapped controls across multiple frameworks?', a: `Yes, I built a control crosswalk mapping ${(d.crosswalkMappings||[]).length} controls across frameworks including ${[...new Set((d.crosswalkMappings||[]).flatMap(m => m.frameworks))].slice(0,4).join(', ')}. This approach reduced audit fatigue by demonstrating that a single control like MFA can satisfy requirements across multiple standards, reducing duplicate testing by an estimated 30-40%.`, category: 'Compliance' });
        }
        // Generic questions always available
        questions.push({ q: 'What is the difference between a risk and a control?', a: 'A risk is something that could go wrong — a threat exploiting a vulnerability to cause harm. A control is the safeguard that reduces that risk to an acceptable level. Every control should trace back to at least one risk, and every risk should have at least one control mitigating it.', category: 'Fundamentals' });
        questions.push({ q: 'What is risk appetite vs risk tolerance?', a: 'Risk appetite is how much risk an organization is WILLING to accept to achieve its objectives — it is set by the Board and is qualitative (Averse, Cautious, Open). Risk tolerance is the specific measurable BOUNDARY — the acceptable range of variation. If your risk appetite for cyber is "Averse," your tolerance might be "no residual risk score above 6."', category: 'Fundamentals' });
        questions.push({ q: 'Walk me through a SOC 2 Type II audit.', a: 'A SOC 2 Type II audit examines control effectiveness over a period (usually 6-12 months). The process: 1) Scoping — define which Trust Services Criteria apply, 2) Readiness assessment, 3) Evidence collection for the audit period, 4) Auditor fieldwork — they test controls via sampling, walkthroughs, and inspection, 5) Management assertion, 6) Auditor opinion and report. Type II differs from Type I because it tests operating effectiveness over time, not just design at a point in time.', category: 'Audit' });

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #0f766e 0%, #0891b2 50%, #0ea5e9 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px;">
                <div style="color: white;">
                    <h2 style="font-size: 22px; font-weight: 700; margin: 0 0 6px;"><i class="bi bi-person-video3"></i> Interview Prep Generator</h2>
                    <p style="font-size: 13px; opacity: 0.7; margin: 0;">AI-generated interview Q&A based on YOUR actual lab work. The more you build, the stronger your answers become.</p>
                </div>
            </div>

            ${!hasData ? `<div class="card"><div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-person-video3" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i><h3>No lab data yet</h3><p style="margin-top: 8px;">Complete some Guided Missions first, then come back here. Your interview answers are generated from YOUR actual work.</p><button class="btn btn-primary" style="margin-top: 16px;" onclick="app.switchTab('missions')"><i class="bi bi-flag-fill"></i> Start a Mission</button></div></div>` : `
            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; padding: 12px; background: var(--accent-blue-soft); border-radius: var(--radius-md);"><i class="bi bi-lightbulb" style="color: var(--accent-blue);"></i> <strong>${questions.length} questions generated</strong> from your ${risks.length} risks, ${controls.length} controls, ${evidence.length} evidence items, and ${findings.length} findings. Add more data to unlock more questions.</div>

            ${questions.map((qa, i) => `<div class="card" style="margin-bottom: 12px;">
                <div style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="font-weight: 700; font-size: 14px; color: var(--text-primary); flex: 1;">${qa.q}</div>
                        <span class="badge badge-blue" style="flex-shrink: 0; margin-left: 8px;">${qa.category}</span>
                    </div>
                    <div id="interview-a-${i}" style="display: none; background: var(--bg-elevated); border-radius: var(--radius-md); padding: 14px; font-size: 13px; color: var(--text-secondary); line-height: 1.7; border-left: 3px solid var(--accent-green);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--accent-green); margin-bottom: 6px;">YOUR ANSWER (based on your lab work)</div>
                        ${qa.a}
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="const el = document.getElementById('interview-a-${i}'); el.style.display = el.style.display === 'none' ? 'block' : 'none'; this.textContent = el.style.display === 'none' ? 'Show Answer' : 'Hide Answer';">Show Answer</button>
                </div>
            </div>`).join('')}
            `}
        `;
    }

    // ==================== EXPORT / IMPORT ====================
    exportAllData() {
        const d = this.data;
        const exportObj = { version: '2.0', exportDate: new Date().toISOString(), platform: 'GRC Practice Lab', data: {} };
        Object.keys(d).forEach(k => { if (d[k] && d[k].length > 0) exportObj.data[k] = d[k]; });
        // Include project data
        if (Object.keys(this.projectData || {}).length > 0) exportObj.projectData = this.projectData;
        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `grc-lab-export-${new Date().toISOString().split('T')[0]}.json`; a.click();
        URL.revokeObjectURL(url);
        this.toast('Data exported as JSON', 'success');
    }
    importAllData() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const imported = JSON.parse(ev.target.result);
                    if (!imported.data) { this.toast('Invalid export file', 'error'); return; }
                    if (!confirm(`Import ${Object.keys(imported.data).length} data collections? This will MERGE with existing data.`)) return;
                    Object.keys(imported.data).forEach(k => {
                        if (!this.data[k]) this.data[k] = [];
                        const existingIds = new Set(this.data[k].map(item => item.id));
                        imported.data[k].forEach(item => { if (!existingIds.has(item.id)) this.data[k].push(item); });
                        localStorage.setItem(`grc_${k}`, JSON.stringify(this.data[k]));
                    });
                    if (imported.projectData) { this.projectData = { ...this.projectData, ...imported.projectData }; localStorage.setItem('grc_projectData', JSON.stringify(this.projectData)); }
                    this.renderCurrentTab(); this.updateAllBadges();
                    this.toast(`Imported successfully from ${imported.exportDate?.split('T')[0] || 'unknown date'}`, 'success');
                } catch(err) { this.toast('Error parsing file: ' + err.message, 'error'); }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // ==================== COMMUNITY ROADMAP ====================
    renderRoadmap() {
        const c = document.getElementById('tab-roadmap');
        const items = [
            { title: 'ITGC/SOX Audit Simulator', status: 'Released', desc: 'Walk through the full audit lifecycle with sampling, workpapers, and deficiency classification.', votes: 47 },
            { title: 'Control Lifecycle Management', status: 'Released', desc: 'Track controls through Draft → Implemented → Tested → Failed → Remediated → Retested.', votes: 38 },
            { title: 'Evidence Quality Scoring', status: 'Released', desc: 'Rate evidence on relevance, completeness, timeliness, authenticity, traceability.', votes: 35 },
            { title: 'Cloud-native Risk Scenarios', status: 'Released', desc: 'AWS, Azure, SaaS scenario packs with shared responsibility model.', votes: 32 },
            { title: 'Vendor Risk Assessment', status: 'Released', desc: 'Vendor tiering, risk scoring across 4 dimensions, SLA tracking.', votes: 29 },
            { title: 'Key Risk Indicators (KRI)', status: 'Released', desc: 'Leading/lagging indicators with RAG thresholds and trend tracking.', votes: 26 },
            { title: 'Risk Appetite & Tolerance', status: 'Released', desc: 'Board-level appetite statements linked to risk scoring.', votes: 24 },
            { title: 'Control Crosswalk', status: 'Released', desc: 'Map single controls to ISO, NIST, SOC 2, PCI DSS, HIPAA, GDPR.', votes: 22 },
            { title: 'Guided Missions', status: 'Released', desc: 'Step-by-step interactive missions with progress tracking.', votes: 41 },
            { title: 'Interview Prep Generator', status: 'Released', desc: 'Generate interview Q&A from your actual lab work.', votes: 44 },
            { title: 'Export / Import (JSON)', status: 'Released', desc: 'Save and share your lab data across sessions and devices.', votes: 33 },
            { title: 'GRC Coach Panel', status: 'Released', desc: 'Contextual coaching for every module with common mistakes.', votes: 30 },
            { title: 'BCM / Disaster Recovery', status: 'Released', desc: 'BCP, DRP, COOP plans linked to BIA with test scheduling.', votes: 25 },
            { title: 'SOX Compliance (COSO)', status: 'Released', desc: 'Sarbanes-Oxley Section 302/404 controls mapped to COSO framework.', votes: 27 },
            { title: 'Market Pack Templates (US/EU/UAE)', status: 'Planned', desc: 'Region-specific scenario packs with local regulatory terminology.', votes: 19 },
            { title: 'Collaborative Mode (Multi-user)', status: 'Planned', desc: 'Shared projects where teams can collaborate on GRC programs.', votes: 18 },
            { title: 'API Integration Simulator', status: 'Planned', desc: 'Practice building GRC API integrations with mock endpoints.', votes: 15 },
            { title: 'Certificate of Completion', status: 'Planned', desc: 'Earn verifiable certificates after completing all missions.', votes: 36 },
            { title: 'Video Walkthrough Library', status: 'Planned', desc: 'Embedded tutorial videos for each module and mission.', votes: 28 }
        ];
        const released = items.filter(i => i.status === 'Released').length;
        const planned = items.filter(i => i.status === 'Planned').length;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #1e3a5f 0%, #312e81 50%, #4c1d95 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px;">
                <div style="color: white;">
                    <h2 style="font-size: 22px; font-weight: 700; margin: 0 0 6px;"><i class="bi bi-kanban"></i> Community Roadmap</h2>
                    <p style="font-size: 13px; opacity: 0.7; margin: 0;">Features requested by the GRC community. ${released} released, ${planned} planned. Built by practitioners, for practitioners.</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><i class="bi bi-check-circle-fill" style="color: var(--accent-green);"></i> Released (${released})</h3>
                    ${items.filter(i => i.status === 'Released').sort((a,b) => b.votes - a.votes).map(i => `
                    <div class="card" style="margin-bottom: 8px;"><div style="padding: 12px; display: flex; align-items: flex-start; gap: 10px;">
                        <div style="background: var(--accent-green-soft); color: var(--accent-green); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px;"><i class="bi bi-check"></i></div>
                        <div style="flex: 1;"><div style="font-weight: 600; font-size: 13px;">${i.title}</div><div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${i.desc}</div></div>
                        <span style="font-size: 11px; color: var(--text-muted); white-space: nowrap;">▲ ${i.votes}</span>
                    </div></div>`).join('')}
                </div>
                <div>
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><i class="bi bi-clock-fill" style="color: var(--accent-amber);"></i> Planned (${planned})</h3>
                    ${items.filter(i => i.status === 'Planned').sort((a,b) => b.votes - a.votes).map(i => `
                    <div class="card" style="margin-bottom: 8px; border-left: 3px solid var(--accent-amber);"><div style="padding: 12px; display: flex; align-items: flex-start; gap: 10px;">
                        <div style="background: var(--accent-amber-soft); color: var(--accent-amber); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px;"><i class="bi bi-clock"></i></div>
                        <div style="flex: 1;"><div style="font-weight: 600; font-size: 13px;">${i.title}</div><div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${i.desc}</div></div>
                        <span style="font-size: 11px; color: var(--text-muted); white-space: nowrap;">▲ ${i.votes}</span>
                    </div></div>`).join('')}
                </div>
            </div>

            <!-- Feedback Form + Suggest Scenario -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                <div class="card" style="border-left: 4px solid var(--accent-blue);">
                    <div style="padding: 20px;">
                        <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px;"><i class="bi bi-chat-left-text" style="color: var(--accent-blue);"></i> Submit Feedback</h3>
                        <div class="form-group" style="margin-bottom: 10px;"><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Category</label><select class="form-select" id="fb-category" style="font-size: 12px;"><option>Bug Report</option><option>Feature Request</option><option>Content Improvement</option><option>UI/UX Feedback</option><option>New Framework Request</option></select></div>
                        <div class="form-group" style="margin-bottom: 10px;"><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Your Feedback</label><textarea class="form-textarea" id="fb-text" rows="3" placeholder="Tell us what you think..." style="font-size: 12px;"></textarea></div>
                        <div class="form-group" style="margin-bottom: 10px;"><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Your Role (optional)</label><select class="form-select" id="fb-role" style="font-size: 12px;"><option value="">Select...</option><option>Student</option><option>Career Switcher</option><option>Junior GRC Analyst</option><option>Senior GRC Professional</option><option>Manager / Director</option><option>Educator / Trainer</option></select></div>
                        <button class="btn btn-primary btn-sm" onclick="app.submitFeedback()"><i class="bi bi-send"></i> Submit Feedback</button>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-purple);">
                    <div style="padding: 20px;">
                        <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px;"><i class="bi bi-plus-circle" style="color: var(--accent-purple);"></i> Suggest a Scenario</h3>
                        <div class="form-group" style="margin-bottom: 10px;"><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Scenario Title</label><input class="form-input" id="sg-title" placeholder="e.g. HIPAA Breach Notification Process" style="font-size: 12px;"></div>
                        <div class="form-group" style="margin-bottom: 10px;"><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Industry / Region</label><select class="form-select" id="sg-market" style="font-size: 12px;"><option>US - General</option><option>US - Healthcare</option><option>US - Financial</option><option>Canada</option><option>EU / UK - GDPR</option><option>UAE / GCC</option><option>India</option><option>Global</option></select></div>
                        <div class="form-group" style="margin-bottom: 10px;"><label style="font-size: 11px; font-weight: 600; color: var(--text-muted);">Description</label><textarea class="form-textarea" id="sg-desc" rows="3" placeholder="Describe the scenario you'd like to practice..." style="font-size: 12px;"></textarea></div>
                        <button class="btn btn-primary btn-sm" onclick="app.submitScenarioSuggestion()"><i class="bi bi-lightbulb"></i> Suggest Scenario</button>
                    </div>
                </div>
            </div>

            <!-- Local Install Guide -->
            <div class="card" style="margin-top: 24px;">
                <div style="padding: 20px;">
                    <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px;"><i class="bi bi-terminal" style="color: var(--accent-green);"></i> Run Locally / Self-Host</h3>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        <p>This lab is a <strong>single HTML file</strong> — no server, database, or build tools required. To run locally:</p>
                        <div style="background: #0f172a; color: #a5f3fc; font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 16px; border-radius: var(--radius-md); margin: 12px 0;">
                            # Option 1: Just open the file<br>
                            $ open grc-lab.html&nbsp;&nbsp;&nbsp;&nbsp;# macOS<br>
                            $ xdg-open grc-lab.html&nbsp;&nbsp;# Linux<br>
                            $ start grc-lab.html&nbsp;&nbsp;&nbsp;&nbsp;# Windows<br><br>
                            # Option 2: Serve with Python (enables full URL routing)<br>
                            $ python3 -m http.server 8080<br>
                            # Then visit http://localhost:8080/grc-lab.html<br><br>
                            # Option 3: Serve with Node.js<br>
                            $ npx serve .
                        </div>
                        <p><strong>Data storage:</strong> All data is saved in your browser's <code>localStorage</code>. Use Export/Import to move data between browsers or devices. No data leaves your machine.</p>
                        <p><strong>License:</strong> Free for personal learning and portfolio building. Not for commercial redistribution or production compliance use.</p>
                    </div>
                </div>
            </div>
        `;
    }
    // ===== FEEDBACK & SUGGESTIONS =====
    submitFeedback() {
        const category = document.getElementById('fb-category')?.value || '';
        const text = document.getElementById('fb-text')?.value?.trim() || '';
        const role = document.getElementById('fb-role')?.value || '';
        if (!text) { this.toast('Please enter your feedback', 'error'); return; }
        const feedback = { id: this.generateId('FB'), category, text, role, date: new Date().toISOString() };
        const stored = JSON.parse(localStorage.getItem('grc_feedback') || '[]');
        stored.push(feedback); localStorage.setItem('grc_feedback', JSON.stringify(stored));
        document.getElementById('fb-text').value = '';
        this.toast('Thank you! Feedback saved locally. Share it with the lab creator to help improve the platform.', 'success');
    }
    submitScenarioSuggestion() {
        const title = document.getElementById('sg-title')?.value?.trim() || '';
        const market = document.getElementById('sg-market')?.value || '';
        const desc = document.getElementById('sg-desc')?.value?.trim() || '';
        if (!title) { this.toast('Please enter a scenario title', 'error'); return; }
        const suggestion = { id: this.generateId('SG'), title, market, desc, date: new Date().toISOString() };
        const stored = JSON.parse(localStorage.getItem('grc_suggestions') || '[]');
        stored.push(suggestion); localStorage.setItem('grc_suggestions', JSON.stringify(stored));
        document.getElementById('sg-title').value = ''; document.getElementById('sg-desc').value = '';
        this.toast('Scenario suggestion saved! Share it with the lab creator.', 'success');
    }

    // ===== CONTROL LIFECYCLE =====
    renderControlLifecycle() {
        const c = document.getElementById('tab-control-lifecycle');
        const items = this.getActiveData().controlLifecycle || [];
        const controls = this.getActiveData().controls || [];
        const phases = ['Proposed', 'Designed', 'Implemented', 'Operating', 'Monitoring', 'Retired'];
        const phaseColors = { 'Proposed': 'purple', 'Designed': 'blue', 'Implemented': 'cyan', 'Operating': 'green', 'Monitoring': 'amber', 'Retired': 'red' };
        const phaseCounts = {};
        phases.forEach(p => phaseCounts[p] = items.filter(i => i.phase === p).length);

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #4c1d95, #5b21b6, #7c3aed, #8b5cf6); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-arrow-repeat"></i></div>
                        <div style="flex: 1;">
                            <h1>Control Lifecycle</h1>
                            <p>Track controls from proposal through retirement</p>
                        </div>
                        <button class="btn" style="background: white; color: #5b21b6; font-weight: 600;" onclick="app.showLifecycleModal()">
                            <i class="bi bi-plus-lg"></i> Add Lifecycle Entry
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        ${phases.map(p => `<div class="modern-stat-pill"><i class="bi bi-circle-fill" style="font-size: 8px;"></i> ${phaseCounts[p]} ${p}</div>`).join('')}
                    </div>
                </div>
            </div>

            <!-- Lifecycle Flow Visualization -->
            <div class="modern-card" style="margin-bottom: 20px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-diagram-3" style="color: var(--accent-purple);"></i> Lifecycle Pipeline</span>
                    <span class="badge badge-purple">${items.length} entries</span>
                </div>
                <div style="padding: 24px;">
                    <div style="display: flex; align-items: center; gap: 4px; overflow-x: auto; padding: 8px 0;">
                        ${phases.map((phase, i) => `
                            <div style="flex: 1; min-width: 120px; text-align: center;">
                                <div style="background: var(--accent-${phaseColors[phase]}-soft); border: 2px solid ${phaseCounts[phase] > 0 ? `var(--accent-${phaseColors[phase]})` : 'var(--border-default)'}; border-radius: var(--radius-lg); padding: 16px 12px; transition: all 0.2s;">
                                    <div style="font-size: 28px; font-weight: 800; color: var(--accent-${phaseColors[phase]});">${phaseCounts[phase]}</div>
                                    <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-top: 4px;">${phase}</div>
                                </div>
                            </div>
                            ${i < phases.length - 1 ? '<div style="color: var(--text-muted); font-size: 18px; flex-shrink: 0;"><i class="bi bi-chevron-right"></i></div>' : ''}
                        `).join('')}
                    </div>
                </div>
            </div>

            <!-- Entries Table -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-purple);"></i> All Lifecycle Entries</span>
                </div>
                ${items.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead><tr><th>Control Name</th><th>Phase</th><th>Owner</th><th>Design Date</th><th>Go-Live Date</th><th>Next Review</th><th>Maturity</th><th style="width: 100px;">Actions</th></tr></thead>
                        <tbody>
                            ${items.map(item => `
                            <tr onclick="app.editLifecycle('${item.id}')">
                                <td style="font-weight: 500;">${this.esc(item.controlName)}</td>
                                <td><span class="badge badge-${phaseColors[item.phase] || 'gray'}">${item.phase}</span></td>
                                <td style="color: var(--text-secondary);">${this.esc(item.owner || '-')}</td>
                                <td style="color: var(--text-muted); font-size: 12px;">${item.designDate || '-'}</td>
                                <td style="color: var(--text-muted); font-size: 12px;">${item.goLiveDate || '-'}</td>
                                <td style="color: var(--text-muted); font-size: 12px;">${item.nextReview || '-'}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="flex: 1; height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden;">
                                            <div style="height: 100%; width: ${(item.maturity || 0) * 20}%; background: var(--accent-${(item.maturity || 0) >= 4 ? 'green' : (item.maturity || 0) >= 2 ? 'amber' : 'red'}); border-radius: 3px;"></div>
                                        </div>
                                        <span style="font-size: 11px; font-weight: 600; color: var(--text-muted);">${item.maturity || 0}/5</span>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editLifecycle('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteLifecycle('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-arrow-repeat"></i></div>
                    <h3>No Lifecycle Entries Yet</h3>
                    <p>Track the journey of your controls from proposal to retirement.</p>
                    <button class="btn btn-primary" onclick="app.showLifecycleModal()"><i class="bi bi-plus-lg"></i> Add First Entry</button>
                    ${controls.length > 0 ? `<button class="btn btn-secondary" style="margin-top: 8px;" onclick="app.autoPopulateLifecycle()"><i class="bi bi-magic"></i> Auto-populate from Controls</button>` : ''}
                </div>
                `}
            </div>
        `;
    }
    autoPopulateLifecycle() {
        const controls = this.getActiveData().controls || [];
        const existing = this.getActiveData().controlLifecycle || [];
        const existingNames = new Set(existing.map(e => e.controlName));
        let added = 0;
        controls.forEach(ctrl => {
            if (!existingNames.has(ctrl.name)) {
                const phase = ctrl.effectiveness === 'Effective' ? 'Operating' : ctrl.effectiveness === 'Partially Effective' ? 'Monitoring' : ctrl.effectiveness === 'Ineffective' ? 'Implemented' : 'Proposed';
                existing.push({ id: this.generateId('LCY'), controlName: ctrl.name, controlId: ctrl.id, phase, owner: ctrl.owner || '', designDate: '', goLiveDate: '', nextReview: '', maturity: ctrl.effectiveness === 'Effective' ? 4 : ctrl.effectiveness === 'Partially Effective' ? 3 : 1, notes: '', createdAt: new Date().toISOString() });
                added++;
            }
        });
        this.getActiveData().controlLifecycle = existing;
        this.saveData('controlLifecycle');
        this.renderControlLifecycle();
        this.toast(`Added ${added} controls to lifecycle tracker`, 'success');
    }
    showLifecycleModal(item = null) {
        const isEdit = item !== null;
        const controls = this.getActiveData().controls || [];
        openModal(isEdit ? 'Edit Lifecycle Entry' : 'Add Lifecycle Entry', `
            <div class="form-group"><label class="form-label">Control Name *</label>
                ${controls.length > 0 ? `<select class="form-select" id="f-controlName"><option value="">— Select or type below —</option>${controls.map(c => `<option value="${c.name}" ${item?.controlName === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}<option value="__custom">Custom name...</option></select><input type="text" class="form-input" id="f-controlNameCustom" value="${item?.controlName || ''}" placeholder="Or type control name" style="margin-top: 6px;">` : `<input type="text" class="form-input" id="f-controlNameCustom" value="${item?.controlName || ''}">`}
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Phase</label><select class="form-select" id="f-phase">${['Proposed', 'Designed', 'Implemented', 'Operating', 'Monitoring', 'Retired'].map(p => `<option value="${p}" ${item?.phase === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${item?.owner || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Design Date</label><input type="date" class="form-input" id="f-designDate" value="${item?.designDate || ''}"></div>
                <div class="form-group"><label class="form-label">Go-Live Date</label><input type="date" class="form-input" id="f-goLiveDate" value="${item?.goLiveDate || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Next Review</label><input type="date" class="form-input" id="f-nextReview" value="${item?.nextReview || ''}"></div>
                <div class="form-group"><label class="form-label">Maturity (1-5)</label><select class="form-select" id="f-maturity">${[1,2,3,4,5].map(m => `<option value="${m}" ${(item?.maturity||1) == m ? 'selected' : ''}>${m} — ${['Initial','Repeatable','Defined','Managed','Optimizing'][m-1]}</option>`).join('')}</select></div>
            </div>
            <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" rows="2">${item?.notes || ''}</textarea></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveLifecycle('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveLifecycle(editId) {
        const selectEl = document.getElementById('f-controlName');
        const customEl = document.getElementById('f-controlNameCustom');
        let controlName = customEl?.value?.trim() || '';
        if (selectEl && selectEl.value && selectEl.value !== '__custom' && selectEl.value !== '') controlName = selectEl.value;
        if (!controlName) { this.toast('Please enter control name', 'error'); return; }
        const data = this.getActiveData();
        if (!data.controlLifecycle) data.controlLifecycle = [];
        const item = { id: editId || this.generateId('LCY'), controlName, phase: document.getElementById('f-phase').value, owner: document.getElementById('f-owner').value, designDate: document.getElementById('f-designDate').value, goLiveDate: document.getElementById('f-goLiveDate').value, nextReview: document.getElementById('f-nextReview').value, maturity: parseInt(document.getElementById('f-maturity').value) || 1, notes: document.getElementById('f-notes').value, createdAt: editId ? (data.controlLifecycle.find(c => c.id === editId)?.createdAt || new Date().toISOString()) : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = data.controlLifecycle.findIndex(c => c.id === editId); if (idx !== -1) data.controlLifecycle[idx] = item; } else { data.controlLifecycle.push(item); }
        this.saveData('controlLifecycle'); closeModal(); this.renderControlLifecycle(); this.toast(editId ? 'Lifecycle entry updated' : 'Lifecycle entry created', 'success');
    }
    editLifecycle(id) { const d = this.getActiveData(); const item = (d.controlLifecycle || []).find(x => x.id === id); if (item) this.showLifecycleModal(item); }
    deleteLifecycle(id) { if (!confirm('Delete this lifecycle entry?')) return; const d = this.getActiveData(); d.controlLifecycle = (d.controlLifecycle || []).filter(x => x.id !== id); this.saveData('controlLifecycle'); this.renderControlLifecycle(); this.toast('Lifecycle entry deleted', 'success'); }

    // ===== EVIDENCE SCORING =====
    renderEvidenceScoring() {
        const c = document.getElementById('tab-evidence-scoring');
        const items = this.getActiveData().evidenceScores || [];
        const evidence = this.getActiveData().evidence || [];
        const avgScore = items.length > 0 ? (items.reduce((s, i) => s + (i.totalScore || 0), 0) / items.length).toFixed(1) : 0;
        const strong = items.filter(i => (i.totalScore || 0) >= 80).length;
        const adequate = items.filter(i => (i.totalScore || 0) >= 50 && (i.totalScore || 0) < 80).length;
        const weak = items.filter(i => (i.totalScore || 0) < 50).length;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #92400e, #b45309, #d97706, #f59e0b); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-star-half"></i></div>
                        <div style="flex: 1;">
                            <h1>Evidence Scoring</h1>
                            <p>Evaluate evidence quality for audit readiness</p>
                        </div>
                        <button class="btn" style="background: white; color: #92400e; font-weight: 600;" onclick="app.showEvidenceScoreModal()">
                            <i class="bi bi-plus-lg"></i> Score Evidence
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-clipboard-data"></i> ${items.length} Scored</div>
                        <div class="modern-stat-pill" style="background: rgba(34,197,94,0.3);"><i class="bi bi-shield-check"></i> ${strong} Strong</div>
                        <div class="modern-stat-pill" style="background: rgba(234,179,8,0.3);"><i class="bi bi-dash-circle"></i> ${adequate} Adequate</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-exclamation-triangle"></i> ${weak} Weak</div>
                    </div>
                </div>
            </div>

            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-clipboard-data-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">${items.length}</div>
                    <div class="modern-kpi-label">Evidence Scored</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-blue);">
                    <div class="modern-kpi-icon" style="background: var(--accent-blue-soft); color: var(--accent-blue);"><i class="bi bi-bar-chart-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-blue);">${avgScore}%</div>
                    <div class="modern-kpi-label">Average Score</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-shield-fill-check"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${strong}</div>
                    <div class="modern-kpi-label">Audit-Ready</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);">
                    <div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-diamond-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-red);">${weak}</div>
                    <div class="modern-kpi-label">Needs Improvement</div>
                </div>
            </div>

            <!-- Scoring Criteria Legend -->
            <div class="modern-card" style="margin-bottom: 20px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-info-circle" style="color: var(--accent-blue);"></i> Scoring Criteria</span>
                </div>
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                    ${[
                        { name: 'Relevance', desc: 'Does it directly support the control?', icon: 'bi-bullseye' },
                        { name: 'Completeness', desc: 'Is it comprehensive enough?', icon: 'bi-check2-all' },
                        { name: 'Timeliness', desc: 'Is it current and within period?', icon: 'bi-clock-history' },
                        { name: 'Reliability', desc: 'Is the source trustworthy?', icon: 'bi-patch-check' },
                        { name: 'Sufficiency', desc: 'Is there enough to satisfy the auditor?', icon: 'bi-stack' }
                    ].map(cr => `
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 12px; text-align: center;">
                            <i class="bi ${cr.icon}" style="font-size: 20px; color: var(--accent-amber);"></i>
                            <div style="font-size: 12px; font-weight: 700; margin-top: 6px;">${cr.name}</div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">${cr.desc}</div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Scored Evidence -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-amber);"></i> Scored Evidence</span>
                </div>
                ${items.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead><tr><th>Evidence Name</th><th>Control</th><th>Relevance</th><th>Complete</th><th>Timely</th><th>Reliable</th><th>Sufficient</th><th>Total</th><th>Rating</th><th style="width: 80px;">Actions</th></tr></thead>
                        <tbody>
                            ${items.map(item => {
                                const total = item.totalScore || 0;
                                const rating = total >= 80 ? 'Strong' : total >= 50 ? 'Adequate' : 'Weak';
                                const rColor = total >= 80 ? 'green' : total >= 50 ? 'amber' : 'red';
                                return `
                                <tr onclick="app.editEvidenceScore('${item.id}')">
                                    <td style="font-weight: 500;">${this.esc(item.evidenceName)}</td>
                                    <td style="color: var(--text-secondary); font-size: 12px;">${this.esc(item.controlName || '-')}</td>
                                    <td style="text-align: center;"><span style="font-weight: 600; color: var(--accent-${(item.relevance||0) >= 16 ? 'green' : (item.relevance||0) >= 10 ? 'amber' : 'red'});">${item.relevance || 0}</span></td>
                                    <td style="text-align: center;"><span style="font-weight: 600; color: var(--accent-${(item.completeness||0) >= 16 ? 'green' : (item.completeness||0) >= 10 ? 'amber' : 'red'});">${item.completeness || 0}</span></td>
                                    <td style="text-align: center;"><span style="font-weight: 600; color: var(--accent-${(item.timeliness||0) >= 16 ? 'green' : (item.timeliness||0) >= 10 ? 'amber' : 'red'});">${item.timeliness || 0}</span></td>
                                    <td style="text-align: center;"><span style="font-weight: 600; color: var(--accent-${(item.reliability||0) >= 16 ? 'green' : (item.reliability||0) >= 10 ? 'amber' : 'red'});">${item.reliability || 0}</span></td>
                                    <td style="text-align: center;"><span style="font-weight: 600; color: var(--accent-${(item.sufficiency||0) >= 16 ? 'green' : (item.sufficiency||0) >= 10 ? 'amber' : 'red'});">${item.sufficiency || 0}</span></td>
                                    <td style="text-align: center; font-weight: 800; font-size: 16px; color: var(--accent-${rColor});">${total}%</td>
                                    <td><span class="badge badge-${rColor}">${rating}</span></td>
                                    <td>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editEvidenceScore('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteEvidenceScore('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-star-half"></i></div>
                    <h3>No Evidence Scored Yet</h3>
                    <p>Evaluate the quality of your evidence to ensure audit readiness.</p>
                    <button class="btn btn-primary" onclick="app.showEvidenceScoreModal()"><i class="bi bi-plus-lg"></i> Score Your First Evidence</button>
                </div>
                `}
            </div>
        `;
    }
    showEvidenceScoreModal(item = null) {
        const isEdit = item !== null;
        const evidence = this.getActiveData().evidence || [];
        const controls = this.getActiveData().controls || [];
        openModal(isEdit ? 'Edit Evidence Score' : 'Score Evidence', `
            <div class="form-group"><label class="form-label">Evidence Name *</label>
                ${evidence.length > 0 ? `<select class="form-select" id="f-evidenceName"><option value="">— Select or type below —</option>${evidence.map(e => `<option value="${e.name}" ${item?.evidenceName === e.name ? 'selected' : ''}>${e.name}</option>`).join('')}<option value="__custom">Custom name...</option></select><input type="text" class="form-input" id="f-evidenceCustom" value="${item?.evidenceName || ''}" placeholder="Or type evidence name" style="margin-top: 6px;">` : `<input type="text" class="form-input" id="f-evidenceCustom" value="${item?.evidenceName || ''}">`}
            </div>
            <div class="form-group"><label class="form-label">Linked Control</label>
                <select class="form-select" id="f-controlName"><option value="">— None —</option>${controls.map(c => `<option value="${c.name}" ${item?.controlName === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}</select>
            </div>
            <p style="font-size: 13px; color: var(--text-muted); margin: 12px 0 8px; font-weight: 600;">Score each dimension (0–20 points each):</p>
            <div class="form-row"><div class="form-group"><label class="form-label">Relevance (0-20)</label><input type="number" class="form-input" id="f-relevance" min="0" max="20" value="${item?.relevance || 0}"><div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Does it directly support the control?</div></div>
            <div class="form-group"><label class="form-label">Completeness (0-20)</label><input type="number" class="form-input" id="f-completeness" min="0" max="20" value="${item?.completeness || 0}"><div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Is it comprehensive enough?</div></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Timeliness (0-20)</label><input type="number" class="form-input" id="f-timeliness" min="0" max="20" value="${item?.timeliness || 0}"><div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Is it current and within audit period?</div></div>
            <div class="form-group"><label class="form-label">Reliability (0-20)</label><input type="number" class="form-input" id="f-reliability" min="0" max="20" value="${item?.reliability || 0}"><div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Is the source trustworthy?</div></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Sufficiency (0-20)</label><input type="number" class="form-input" id="f-sufficiency" min="0" max="20" value="${item?.sufficiency || 0}"><div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Enough to satisfy the auditor?</div></div>
            <div class="form-group"><label class="form-label">Total Score</label><div style="font-size: 32px; font-weight: 800; color: var(--accent-amber); text-align: center; padding-top: 4px;" id="f-totalPreview">0%</div></div></div>
            <div class="form-group"><label class="form-label">Assessor Notes</label><textarea class="form-textarea" id="f-notes" rows="2">${item?.notes || ''}</textarea></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveEvidenceScore('${item?.id || ''}')">${isEdit ? 'Update' : 'Save Score'}</button>`);
        // Live score preview
        setTimeout(() => {
            const ids = ['f-relevance','f-completeness','f-timeliness','f-reliability','f-sufficiency'];
            const updatePreview = () => {
                const total = ids.reduce((s, id) => s + (parseInt(document.getElementById(id)?.value) || 0), 0);
                const el = document.getElementById('f-totalPreview');
                if (el) { el.textContent = total + '%'; el.style.color = total >= 80 ? 'var(--accent-green)' : total >= 50 ? 'var(--accent-amber)' : 'var(--accent-red)'; }
            };
            ids.forEach(id => document.getElementById(id)?.addEventListener('input', updatePreview));
            updatePreview();
        }, 50);
    }
    saveEvidenceScore(editId) {
        const selectEl = document.getElementById('f-evidenceName');
        const customEl = document.getElementById('f-evidenceCustom');
        let evidenceName = customEl?.value?.trim() || '';
        if (selectEl && selectEl.value && selectEl.value !== '__custom' && selectEl.value !== '') evidenceName = selectEl.value;
        if (!evidenceName) { this.toast('Please enter evidence name', 'error'); return; }
        const data = this.getActiveData();
        if (!data.evidenceScores) data.evidenceScores = [];
        const relevance = Math.min(20, Math.max(0, parseInt(document.getElementById('f-relevance').value) || 0));
        const completeness = Math.min(20, Math.max(0, parseInt(document.getElementById('f-completeness').value) || 0));
        const timeliness = Math.min(20, Math.max(0, parseInt(document.getElementById('f-timeliness').value) || 0));
        const reliability = Math.min(20, Math.max(0, parseInt(document.getElementById('f-reliability').value) || 0));
        const sufficiency = Math.min(20, Math.max(0, parseInt(document.getElementById('f-sufficiency').value) || 0));
        const totalScore = relevance + completeness + timeliness + reliability + sufficiency;
        const item = { id: editId || this.generateId('EVS'), evidenceName, controlName: document.getElementById('f-controlName')?.value || '', relevance, completeness, timeliness, reliability, sufficiency, totalScore, notes: document.getElementById('f-notes').value, createdAt: editId ? (data.evidenceScores.find(c => c.id === editId)?.createdAt || new Date().toISOString()) : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = data.evidenceScores.findIndex(c => c.id === editId); if (idx !== -1) data.evidenceScores[idx] = item; } else { data.evidenceScores.push(item); }
        this.saveData('evidenceScores'); closeModal(); this.renderEvidenceScoring(); this.toast(editId ? 'Evidence score updated' : 'Evidence scored', 'success');
    }
    editEvidenceScore(id) { const d = this.getActiveData(); const item = (d.evidenceScores || []).find(x => x.id === id); if (item) this.showEvidenceScoreModal(item); }
    deleteEvidenceScore(id) { if (!confirm('Delete this evidence score?')) return; const d = this.getActiveData(); d.evidenceScores = (d.evidenceScores || []).filter(x => x.id !== id); this.saveData('evidenceScores'); this.renderEvidenceScoring(); this.toast('Evidence score deleted', 'success'); }

    // ===== CLOUD RISK SCENARIOS =====
    renderCloudRisks() {
        const c = document.getElementById('tab-cloud-risks');
        const items = this.getActiveData().cloudRiskScenarios || [];
        const providers = ['AWS', 'Azure', 'GCP', 'Multi-Cloud'];
        const categories = ['Data Breach', 'Misconfiguration', 'Identity & Access', 'Supply Chain', 'Compliance Gap', 'Availability'];
        const catCounts = {};
        categories.forEach(cat => catCounts[cat] = items.filter(i => i.category === cat).length);
        const highRisks = items.filter(i => i.riskLevel === 'Critical' || i.riskLevel === 'High').length;

        const scenarioTemplates = [
            { category: 'Misconfiguration', provider: 'AWS', title: 'S3 Bucket Public Exposure', desc: 'An S3 bucket containing customer PII is misconfigured with public read access, exposing sensitive data to the internet.', likelihood: 'High', impact: 'Critical', riskLevel: 'Critical', mitigations: 'Enable S3 Block Public Access at account level; implement AWS Config rules for public bucket detection; enable CloudTrail logging; conduct regular access reviews.' },
            { category: 'Identity & Access', provider: 'Azure', title: 'Overprivileged Service Principal', desc: 'Azure service principal with Owner role at subscription level is used for a single application, creating excessive blast radius.', likelihood: 'Medium', impact: 'High', riskLevel: 'High', mitigations: 'Implement least privilege with custom RBAC roles; use managed identities; enable PIM for just-in-time access; audit with Azure AD access reviews.' },
            { category: 'Data Breach', provider: 'GCP', title: 'BigQuery Dataset Exfiltration', desc: 'Unauthorized analyst exports full BigQuery dataset containing financial records via personal project, bypassing DLP controls.', likelihood: 'Medium', impact: 'Critical', riskLevel: 'Critical', mitigations: 'Implement VPC Service Controls; enable BigQuery authorized views; configure DLP API scanning; restrict data export permissions; enable audit logging.' },
            { category: 'Supply Chain', provider: 'Multi-Cloud', title: 'Compromised Container Image', desc: 'A base container image pulled from public registry contains embedded cryptominer that runs across Kubernetes clusters in multiple clouds.', likelihood: 'Medium', impact: 'High', riskLevel: 'High', mitigations: 'Use private container registries; implement image signing and verification; scan images with Trivy/Snyk; enforce admission controllers; maintain approved base image catalog.' },
            { category: 'Compliance Gap', provider: 'AWS', title: 'Cross-Region Data Residency Violation', desc: 'Automated failover replicates EU customer data to US region, violating GDPR data residency requirements.', likelihood: 'Medium', impact: 'High', riskLevel: 'High', mitigations: 'Implement AWS Organizations SCPs to restrict regions; configure backup policies with region constraints; enable AWS Config rules for resource location; document data flow maps.' },
            { category: 'Availability', provider: 'Azure', title: 'Single-Region Outage Impact', desc: 'Critical ERP system deployed in single Azure region experiences 8-hour outage, halting business operations with no DR capability.', likelihood: 'Low', impact: 'Critical', riskLevel: 'High', mitigations: 'Implement multi-region deployment; configure Azure Traffic Manager; test DR runbooks quarterly; define RTO/RPO per workload; use availability zones within region.' },
            { category: 'Misconfiguration', provider: 'GCP', title: 'Firewall Rule Allows All Ingress', desc: 'Default VPC firewall rule allows 0.0.0.0/0 ingress on all ports, exposing compute instances to internet-based attacks.', likelihood: 'High', impact: 'High', riskLevel: 'Critical', mitigations: 'Delete default allow-all rules; implement hierarchical firewall policies; use VPC Flow Logs for monitoring; deploy Cloud Armor for web-facing services.' },
            { category: 'Identity & Access', provider: 'AWS', title: 'Long-Lived Access Keys Leak', desc: 'Developer commits AWS access keys with admin privileges to public GitHub repository, discovered by automated scanner.', likelihood: 'High', impact: 'Critical', riskLevel: 'Critical', mitigations: 'Enforce IAM roles over access keys; implement AWS Secrets Manager rotation; enable GitHub secret scanning; use AWS CloudTrail for key usage monitoring; deploy GuardDuty.' }
        ];

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(-45deg, #0c4a6e, #075985, #0369a1, #0284c7); background-size: 400% 400%; animation: modern-gradient 15s ease infinite;">
                <div class="modern-page-hero-content">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="modern-page-hero-icon"><i class="bi bi-cloud-haze2"></i></div>
                        <div style="flex: 1;">
                            <h1>Cloud Risk Scenarios</h1>
                            <p>Identify and assess risks specific to cloud environments</p>
                        </div>
                        <button class="btn" style="background: white; color: #0c4a6e; font-weight: 600;" onclick="app.showCloudRiskModal()">
                            <i class="bi bi-plus-lg"></i> Add Scenario
                        </button>
                    </div>
                    <div class="modern-stats-row">
                        <div class="modern-stat-pill"><i class="bi bi-cloud-fill"></i> ${items.length} Scenarios</div>
                        <div class="modern-stat-pill" style="background: rgba(239,68,68,0.3);"><i class="bi bi-exclamation-triangle-fill"></i> ${highRisks} High/Critical</div>
                        ${providers.map(p => `<div class="modern-stat-pill">${items.filter(i => i.provider === p).length} ${p}</div>`).join('')}
                    </div>
                </div>
            </div>

            <div class="modern-kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-cyan);">
                    <div class="modern-kpi-icon" style="background: var(--accent-cyan-soft); color: var(--accent-cyan);"><i class="bi bi-cloud-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-cyan);">${items.length}</div>
                    <div class="modern-kpi-label">Total Scenarios</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-red);">
                    <div class="modern-kpi-icon" style="background: var(--accent-red-soft); color: var(--accent-red);"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-red);">${items.filter(i => i.riskLevel === 'Critical').length}</div>
                    <div class="modern-kpi-label">Critical Risks</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-amber);">
                    <div class="modern-kpi-icon" style="background: var(--accent-amber-soft); color: var(--accent-amber);"><i class="bi bi-shield-exclamation"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-amber);">${items.filter(i => i.riskLevel === 'High').length}</div>
                    <div class="modern-kpi-label">High Risks</div>
                </div>
                <div class="modern-kpi-card" style="--kpi-color: var(--accent-green);">
                    <div class="modern-kpi-icon" style="background: var(--accent-green-soft); color: var(--accent-green);"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="modern-kpi-value" style="color: var(--accent-green);">${items.filter(i => i.mitigationStatus === 'Mitigated').length}</div>
                    <div class="modern-kpi-label">Mitigated</div>
                </div>
            </div>

            <!-- Quick-Load Templates -->
            <div class="modern-card" style="margin-bottom: 20px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-lightning-fill" style="color: var(--accent-cyan);"></i> Quick-Load Cloud Risk Templates</span>
                    <button class="btn btn-primary btn-sm" onclick="app.loadCloudRiskTemplates()"><i class="bi bi-download"></i> Load 8 Scenarios</button>
                </div>
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    ${['AWS', 'Azure', 'GCP'].map(p => `
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-lg); padding: 16px; text-align: center;">
                            <i class="bi bi-cloud-fill" style="font-size: 24px; color: var(--accent-cyan);"></i>
                            <div style="font-size: 14px; font-weight: 700; margin-top: 6px;">${p}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${scenarioTemplates.filter(s => s.provider === p).length} templates · ${items.filter(i => i.provider === p).length} added</div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Risk Category Breakdown -->
            <div class="modern-card" style="margin-bottom: 20px;">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-pie-chart" style="color: var(--accent-cyan);"></i> Risk Categories</span>
                </div>
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    ${categories.map(cat => `
                        <div style="background: var(--bg-elevated); border-radius: var(--radius-md); padding: 12px; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: var(--accent-cyan-soft); display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-${cat === 'Data Breach' ? 'database-exclamation' : cat === 'Misconfiguration' ? 'sliders' : cat === 'Identity & Access' ? 'person-lock' : cat === 'Supply Chain' ? 'link-45deg' : cat === 'Compliance Gap' ? 'clipboard-x' : 'arrow-repeat'}" style="color: var(--accent-cyan);"></i>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600;">${cat}</div>
                                <div style="font-size: 18px; font-weight: 800; color: var(--accent-cyan);">${catCounts[cat]}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Scenarios Table -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <span class="modern-card-title"><i class="bi bi-list-ul" style="color: var(--accent-cyan);"></i> All Scenarios</span>
                </div>
                ${items.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead><tr><th>Scenario</th><th>Provider</th><th>Category</th><th>Likelihood</th><th>Impact</th><th>Risk Level</th><th>Status</th><th style="width: 80px;">Actions</th></tr></thead>
                        <tbody>
                            ${items.map(item => `
                            <tr onclick="app.viewCloudRisk('${item.id}')">
                                <td style="font-weight: 500; max-width: 250px;">${this.esc(item.title)}</td>
                                <td><span class="badge badge-blue">${item.provider}</span></td>
                                <td style="color: var(--text-secondary); font-size: 12px;">${item.category}</td>
                                <td><span class="badge badge-${item.likelihood === 'High' ? 'red' : item.likelihood === 'Medium' ? 'amber' : 'green'}">${item.likelihood}</span></td>
                                <td><span class="badge badge-${item.impact === 'Critical' ? 'red' : item.impact === 'High' ? 'amber' : 'green'}">${item.impact}</span></td>
                                <td><span class="badge badge-${item.riskLevel === 'Critical' ? 'red' : item.riskLevel === 'High' ? 'amber' : item.riskLevel === 'Medium' ? 'blue' : 'green'}" style="font-weight: 700;">${item.riskLevel}</span></td>
                                <td><span class="badge badge-${item.mitigationStatus === 'Mitigated' ? 'green' : item.mitigationStatus === 'In Progress' ? 'amber' : 'gray'}">${item.mitigationStatus || 'Open'}</span></td>
                                <td>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.editCloudRisk('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); app.deleteCloudRisk('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : `
                <div class="modern-empty">
                    <div class="modern-empty-icon"><i class="bi bi-cloud-haze2"></i></div>
                    <h3>No Cloud Risk Scenarios Yet</h3>
                    <p>Model real-world cloud security risks across AWS, Azure, and GCP.</p>
                    <button class="btn btn-primary" onclick="app.showCloudRiskModal()"><i class="bi bi-plus-lg"></i> Add First Scenario</button>
                    <button class="btn btn-secondary" style="margin-top: 8px;" onclick="app.loadCloudRiskTemplates()"><i class="bi bi-download"></i> Load Templates</button>
                </div>
                `}
            </div>
        `;
    }
    loadCloudRiskTemplates() {
        const templates = [
            { category: 'Misconfiguration', provider: 'AWS', title: 'S3 Bucket Public Exposure', desc: 'An S3 bucket containing customer PII is misconfigured with public read access, exposing sensitive data to the internet.', likelihood: 'High', impact: 'Critical', riskLevel: 'Critical', mitigations: 'Enable S3 Block Public Access at account level; implement AWS Config rules for public bucket detection; enable CloudTrail logging; conduct regular access reviews.' },
            { category: 'Identity & Access', provider: 'Azure', title: 'Overprivileged Service Principal', desc: 'Azure service principal with Owner role at subscription level is used for a single application, creating excessive blast radius.', likelihood: 'Medium', impact: 'High', riskLevel: 'High', mitigations: 'Implement least privilege with custom RBAC roles; use managed identities; enable PIM for just-in-time access; audit with Azure AD access reviews.' },
            { category: 'Data Breach', provider: 'GCP', title: 'BigQuery Dataset Exfiltration', desc: 'Unauthorized analyst exports full BigQuery dataset containing financial records via personal project, bypassing DLP controls.', likelihood: 'Medium', impact: 'Critical', riskLevel: 'Critical', mitigations: 'Implement VPC Service Controls; enable BigQuery authorized views; configure DLP API scanning; restrict data export permissions; enable audit logging.' },
            { category: 'Supply Chain', provider: 'Multi-Cloud', title: 'Compromised Container Image', desc: 'A base container image pulled from public registry contains embedded cryptominer that runs across Kubernetes clusters in multiple clouds.', likelihood: 'Medium', impact: 'High', riskLevel: 'High', mitigations: 'Use private container registries; implement image signing and verification; scan images with Trivy/Snyk; enforce admission controllers; maintain approved base image catalog.' },
            { category: 'Compliance Gap', provider: 'AWS', title: 'Cross-Region Data Residency Violation', desc: 'Automated failover replicates EU customer data to US region, violating GDPR data residency requirements.', likelihood: 'Medium', impact: 'High', riskLevel: 'High', mitigations: 'Implement AWS Organizations SCPs to restrict regions; configure backup policies with region constraints; enable AWS Config rules for resource location; document data flow maps.' },
            { category: 'Availability', provider: 'Azure', title: 'Single-Region Outage Impact', desc: 'Critical ERP system deployed in single Azure region experiences 8-hour outage, halting business operations with no DR capability.', likelihood: 'Low', impact: 'Critical', riskLevel: 'High', mitigations: 'Implement multi-region deployment; configure Azure Traffic Manager; test DR runbooks quarterly; define RTO/RPO per workload; use availability zones within region.' },
            { category: 'Misconfiguration', provider: 'GCP', title: 'Firewall Rule Allows All Ingress', desc: 'Default VPC firewall rule allows 0.0.0.0/0 ingress on all ports, exposing compute instances to internet-based attacks.', likelihood: 'High', impact: 'High', riskLevel: 'Critical', mitigations: 'Delete default allow-all rules; implement hierarchical firewall policies; use VPC Flow Logs for monitoring; deploy Cloud Armor for web-facing services.' },
            { category: 'Identity & Access', provider: 'AWS', title: 'Long-Lived Access Keys Leak', desc: 'Developer commits AWS access keys with admin privileges to public GitHub repository, discovered by automated scanner.', likelihood: 'High', impact: 'Critical', riskLevel: 'Critical', mitigations: 'Enforce IAM roles over access keys; implement AWS Secrets Manager rotation; enable GitHub secret scanning; use AWS CloudTrail for key usage monitoring; deploy GuardDuty.' }
        ];
        const existing = this.getActiveData().cloudRiskScenarios || [];
        const existingTitles = new Set(existing.map(e => e.title));
        let added = 0;
        templates.forEach(t => {
            if (!existingTitles.has(t.title)) {
                existing.push({ id: this.generateId('CRS'), ...t, mitigationStatus: 'Open', createdAt: new Date().toISOString() });
                added++;
            }
        });
        this.getActiveData().cloudRiskScenarios = existing;
        this.saveData('cloudRiskScenarios');
        this.renderCloudRisks();
        this.toast(`Loaded ${added} cloud risk scenarios (${templates.length - added} already existed)`, 'success');
    }
    showCloudRiskModal(item = null) {
        const isEdit = item !== null;
        openModal(isEdit ? 'Edit Cloud Risk Scenario' : 'Add Cloud Risk Scenario', `
            <div class="form-group"><label class="form-label">Scenario Title *</label><input type="text" class="form-input" id="f-title" value="${item?.title || ''}"></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Cloud Provider</label><select class="form-select" id="f-provider">${['AWS', 'Azure', 'GCP', 'Multi-Cloud', 'Other'].map(p => `<option value="${p}" ${item?.provider === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="f-category">${['Data Breach', 'Misconfiguration', 'Identity & Access', 'Supply Chain', 'Compliance Gap', 'Availability'].map(c => `<option value="${c}" ${item?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
            </div>
            <div class="form-group"><label class="form-label">Scenario Description</label><textarea class="form-textarea" id="f-desc" rows="3">${item?.desc || ''}</textarea></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Likelihood</label><select class="form-select" id="f-likelihood">${['Low', 'Medium', 'High'].map(l => `<option value="${l}" ${item?.likelihood === l ? 'selected' : ''}>${l}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Impact</label><select class="form-select" id="f-impact">${['Low', 'Medium', 'High', 'Critical'].map(l => `<option value="${l}" ${item?.impact === l ? 'selected' : ''}>${l}</option>`).join('')}</select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Risk Level</label><select class="form-select" id="f-riskLevel">${['Low', 'Medium', 'High', 'Critical'].map(l => `<option value="${l}" ${item?.riskLevel === l ? 'selected' : ''}>${l}</option>`).join('')}</select></div>
                <div class="form-group"><label class="form-label">Mitigation Status</label><select class="form-select" id="f-mitStatus">${['Open', 'In Progress', 'Mitigated', 'Accepted'].map(s => `<option value="${s}" ${item?.mitigationStatus === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
            </div>
            <div class="form-group"><label class="form-label">Recommended Mitigations</label><textarea class="form-textarea" id="f-mitigations" rows="3">${item?.mitigations || ''}</textarea></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveCloudRisk('${item?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveCloudRisk(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter scenario title', 'error'); return; }
        const data = this.getActiveData();
        if (!data.cloudRiskScenarios) data.cloudRiskScenarios = [];
        const item = { id: editId || this.generateId('CRS'), title, provider: document.getElementById('f-provider').value, category: document.getElementById('f-category').value, desc: document.getElementById('f-desc').value, likelihood: document.getElementById('f-likelihood').value, impact: document.getElementById('f-impact').value, riskLevel: document.getElementById('f-riskLevel').value, mitigationStatus: document.getElementById('f-mitStatus').value, mitigations: document.getElementById('f-mitigations').value, createdAt: editId ? (data.cloudRiskScenarios.find(c => c.id === editId)?.createdAt || new Date().toISOString()) : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = data.cloudRiskScenarios.findIndex(c => c.id === editId); if (idx !== -1) data.cloudRiskScenarios[idx] = item; } else { data.cloudRiskScenarios.push(item); }
        this.saveData('cloudRiskScenarios'); closeModal(); this.renderCloudRisks(); this.toast(editId ? 'Cloud risk scenario updated' : 'Cloud risk scenario created', 'success');
    }
    viewCloudRisk(id) {
        const item = (this.getActiveData().cloudRiskScenarios || []).find(x => x.id === id);
        if (!item) return;
        const rColor = item.riskLevel === 'Critical' ? 'red' : item.riskLevel === 'High' ? 'amber' : item.riskLevel === 'Medium' ? 'blue' : 'green';
        openModal(item.title, `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-md);"><div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Provider</div><div style="font-weight: 600; margin-top: 4px;"><span class="badge badge-blue">${item.provider}</span></div></div>
                <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-md);"><div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Category</div><div style="font-weight: 600; margin-top: 4px;">${item.category}</div></div>
                <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-md);"><div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Likelihood</div><div style="font-weight: 600; margin-top: 4px;"><span class="badge badge-${item.likelihood === 'High' ? 'red' : item.likelihood === 'Medium' ? 'amber' : 'green'}">${item.likelihood}</span></div></div>
                <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-md);"><div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Risk Level</div><div style="font-weight: 600; margin-top: 4px;"><span class="badge badge-${rColor}" style="font-size: 13px;">${item.riskLevel}</span></div></div>
            </div>
            <div style="margin-bottom: 16px;"><h4 style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">Scenario Description</h4><p style="color: var(--text-secondary); line-height: 1.7; font-size: 13px;">${this.esc(item.desc || 'No description provided.')}</p></div>
            <div><h4 style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">Recommended Mitigations</h4><p style="color: var(--text-secondary); line-height: 1.7; font-size: 13px;">${this.esc(item.mitigations || 'No mitigations documented yet.')}</p></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Close</button><button class="btn btn-primary" onclick="closeModal(); app.editCloudRisk('${item.id}')"><i class="bi bi-pencil"></i> Edit</button>`);
    }
    editCloudRisk(id) { const item = (this.getActiveData().cloudRiskScenarios || []).find(x => x.id === id); if (item) this.showCloudRiskModal(item); }
    deleteCloudRisk(id) { if (!confirm('Delete this cloud risk scenario?')) return; const d = this.getActiveData(); d.cloudRiskScenarios = (d.cloudRiskScenarios || []).filter(x => x.id !== id); this.saveData('cloudRiskScenarios'); this.renderCloudRisks(); this.toast('Cloud risk scenario deleted', 'success'); }

    // ==================== BUSINESS IMPACT ANALYSIS ====================
    renderBIA() {
        const c = document.getElementById('tab-bia');
        const d = this.getActiveData();
        const items = d.biaEntries || [];
        const critCount = items.filter(i => i.criticality === 'Critical').length;
        const highCount = items.filter(i => i.criticality === 'High').length;
        const avgRTO = items.length > 0 ? Math.round(items.reduce((s,i) => s + (parseFloat(i.rto)||0), 0) / items.length) : 0;
        const avgRPO = items.length > 0 ? Math.round(items.reduce((s,i) => s + (parseFloat(i.rpo)||0), 0) / items.length) : 0;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0e7490 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-heart-pulse"></i> Business Impact Analysis</h2>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Assess criticality, define RTO/RPO targets, and identify dependencies for each business process.</p>
                    </div>
                    <button class="btn" style="background: white; color: #1e3a8a; font-weight: 600;" onclick="app.showBIAModal()"><i class="bi bi-plus-lg"></i> Add BIA Entry</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${items.length}</div><div style="font-size: 12px; color: var(--text-muted);">Total Processes</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${critCount}</div><div style="font-size: 12px; color: var(--text-muted);">Critical</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${avgRTO}h</div><div style="font-size: 12px; color: var(--text-muted);">Avg RTO</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-purple);">${avgRPO}h</div><div style="font-size: 12px; color: var(--text-muted);">Avg RPO</div></div></div>
            </div>
            <div class="card"><div class="card-header" style="padding: 16px;"><span style="font-weight: 600;"><i class="bi bi-heart-pulse"></i> BIA Register</span></div>
            <div class="card-body" style="padding: 0;">
                ${items.length > 0 ? `<div style="overflow-x: auto;"><table style="margin:0;"><thead><tr><th>Process</th><th>Owner</th><th>Criticality</th><th>RTO</th><th>RPO</th><th>MTPD</th><th>Dependencies</th><th style="width:80px;">Actions</th></tr></thead><tbody>
                ${items.map(item => `<tr>
                    <td style="font-weight: 600;">${item.processName}</td>
                    <td>${item.owner || '-'}</td>
                    <td><span class="badge badge-${item.criticality === 'Critical' ? 'red' : item.criticality === 'High' ? 'amber' : item.criticality === 'Medium' ? 'blue' : 'green'}">${item.criticality}</span></td>
                    <td>${item.rto}h</td><td>${item.rpo}h</td><td>${item.mtpd || '-'}h</td>
                    <td style="font-size: 12px; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.dependencies || '-'}</td>
                    <td><div style="display: flex; gap: 4px;">
                        <button class="btn btn-ghost btn-sm" onclick="app.editBIA('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="app.deleteBIA('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                    </div></td></tr>`).join('')}
                </tbody></table></div>` : `<div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-heart-pulse" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No BIA entries yet. Add a business process to get started.</p></div>`}
            </div></div>`;
    }
    showBIAModal(item) {
        const isEdit = !!item;
        const d = this.getActiveData();
        openModal(isEdit ? 'Edit BIA Entry' : 'New BIA Entry', `
            <div class="form-group"><label class="form-label">Business Process *</label><input class="form-input" id="f-processName" value="${item?.processName || ''}" placeholder="e.g. Payment Processing"></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input class="form-input" id="f-owner" value="${item?.owner || ''}" placeholder="e.g. Finance"></div>
            <div class="form-group"><label class="form-label">Criticality *</label><select class="form-input" id="f-criticality"><option value="Critical" ${item?.criticality==='Critical'?'selected':''}>Critical</option><option value="High" ${item?.criticality==='High'?'selected':''}>High</option><option value="Medium" ${(!item||item?.criticality==='Medium')?'selected':''}>Medium</option><option value="Low" ${item?.criticality==='Low'?'selected':''}>Low</option></select></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">RTO (hours) *</label><input class="form-input" id="f-rto" type="number" min="0" step="0.5" value="${item?.rto || '4'}"></div>
            <div class="form-group"><label class="form-label">RPO (hours) *</label><input class="form-input" id="f-rpo" type="number" min="0" step="0.5" value="${item?.rpo || '1'}"></div>
            <div class="form-group"><label class="form-label">MTPD (hours)</label><input class="form-input" id="f-mtpd" type="number" min="0" step="0.5" value="${item?.mtpd || '24'}"></div></div>
            <div class="form-group"><label class="form-label">Dependencies</label><input class="form-input" id="f-dependencies" value="${item?.dependencies || ''}" placeholder="e.g. AWS, Stripe, Customer DB"></div>
            <div class="form-group"><label class="form-label">Impact Description</label><textarea class="form-textarea" id="f-impact" rows="2">${item?.impact || ''}</textarea></div>
            <div class="form-group"><label class="form-label">Linked Asset</label><select class="form-input" id="f-assetId"><option value="">-- None --</option>${d.assets.map(a => `<option value="${a.id}" ${item?.assetId===a.id?'selected':''}>${a.name}</option>`).join('')}</select></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveBIA('${item?.id || ''}')">${isEdit ? 'Update' : 'Save'}</button>`);
    }
    saveBIA(editId) {
        const processName = document.getElementById('f-processName')?.value?.trim(); if (!processName) { this.toast('Process name required', 'error'); return; }
        const entry = { processName, owner: document.getElementById('f-owner')?.value?.trim() || '', criticality: document.getElementById('f-criticality')?.value || 'Medium', rto: document.getElementById('f-rto')?.value || '4', rpo: document.getElementById('f-rpo')?.value || '1', mtpd: document.getElementById('f-mtpd')?.value || '24', dependencies: document.getElementById('f-dependencies')?.value?.trim() || '', impact: document.getElementById('f-impact')?.value?.trim() || '', assetId: document.getElementById('f-assetId')?.value || '' };
        const d = this.getActiveData(); if (!d.biaEntries) d.biaEntries = [];
        if (editId) { const idx = d.biaEntries.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.biaEntries[idx], entry); }
        else { entry.id = this.generateId('BIA'); entry.createdAt = new Date().toISOString(); d.biaEntries.push(entry); }
        this.saveData('biaEntries'); closeModal(); this.renderBIA(); this.toast(editId ? 'BIA entry updated' : 'BIA entry created', 'success');
        if (!editId) this.showWorkflowPrompt('BIA Complete — Next Step', 'Now create a BCM or DR plan for this critical process. Define HOW you will recover within the RTO you just set.', 'bcm', 'Create BCM Plan →');
    }
    editBIA(id) { const item = (this.getActiveData().biaEntries || []).find(x => x.id === id); if (item) this.showBIAModal(item); }
    deleteBIA(id) { if (!confirm('Delete this BIA entry?')) return; const d = this.getActiveData(); d.biaEntries = (d.biaEntries || []).filter(x => x.id !== id); this.saveData('biaEntries'); this.renderBIA(); this.toast('BIA entry deleted', 'success'); }

    // ==================== VENDOR RISK ASSESSMENT ====================
    renderVendorRisk() {
        const c = document.getElementById('tab-vendor-risk');
        const d = this.getActiveData();
        const items = d.vendorAssessments || [];
        const assessed = items.length;
        const highRisk = items.filter(i => i.riskRating === 'High' || i.riskRating === 'Critical').length;
        const avgScore = items.length > 0 ? Math.round(items.reduce((s,i) => s + (parseInt(i.overallScore)||0), 0) / items.length) : 0;

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #1e293b 0%, #4338ca 50%, #059669 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-clipboard2-pulse"></i> Vendor Risk Assessment</h2>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Assess third-party vendors across security, compliance, financial, and operational risk dimensions.</p>
                    </div>
                    <button class="btn" style="background: white; color: #1e3a8a; font-weight: 600;" onclick="app.showVendorRiskModal()"><i class="bi bi-plus-lg"></i> New Assessment</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${d.vendors.length}</div><div style="font-size: 12px; color: var(--text-muted);">Total Vendors</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${assessed}</div><div style="font-size: 12px; color: var(--text-muted);">Assessed</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${highRisk}</div><div style="font-size: 12px; color: var(--text-muted);">High/Critical Risk</div></div></div>
                <div class="card"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${avgScore}%</div><div style="font-size: 12px; color: var(--text-muted);">Avg Score</div></div></div>
            </div>
            <div class="card"><div class="card-header" style="padding: 16px;"><span style="font-weight: 600;"><i class="bi bi-clipboard2-pulse"></i> Assessment Register</span></div>
            <div class="card-body" style="padding: 0;">
                ${items.length > 0 ? `<div style="overflow-x: auto;"><table style="margin:0;"><thead><tr><th>Vendor</th><th>Risk Rating</th><th>Overall Score</th><th>Security</th><th>Compliance</th><th>Financial</th><th>Operational</th><th>Assessed</th><th style="width:80px;">Actions</th></tr></thead><tbody>
                ${items.map(item => {
                    const vendor = d.vendors.find(v => v.id === item.vendorId);
                    const rColor = item.riskRating === 'Critical' ? 'red' : item.riskRating === 'High' ? 'amber' : item.riskRating === 'Medium' ? 'blue' : 'green';
                    return `<tr>
                    <td style="font-weight: 600;">${vendor?.name || item.vendorName || 'Unknown'}</td>
                    <td><span class="badge badge-${rColor}">${item.riskRating}</span></td>
                    <td><div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; background: var(--bg-elevated); border-radius: 4px; height: 8px;"><div style="height: 100%; width: ${item.overallScore}%; background: var(--accent-${rColor}); border-radius: 4px;"></div></div><span style="font-size: 12px; font-weight: 600;">${item.overallScore}%</span></div></td>
                    <td style="font-size: 12px;">${item.securityScore || '-'}/25</td>
                    <td style="font-size: 12px;">${item.complianceScore || '-'}/25</td>
                    <td style="font-size: 12px;">${item.financialScore || '-'}/25</td>
                    <td style="font-size: 12px;">${item.operationalScore || '-'}/25</td>
                    <td style="font-size: 11px; color: var(--text-muted);">${item.assessmentDate ? new Date(item.assessmentDate).toLocaleDateString() : '-'}</td>
                    <td><div style="display: flex; gap: 4px;">
                        <button class="btn btn-ghost btn-sm" onclick="app.editVendorRisk('${item.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="app.deleteVendorRisk('${item.id}')" title="Delete"><i class="bi bi-trash3"></i></button>
                    </div></td></tr>`}).join('')}
                </tbody></table></div>` : `<div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-clipboard2-pulse" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No vendor assessments yet. Select a vendor and score their risk.</p></div>`}
            </div></div>`;
    }
    showVendorRiskModal(item) {
        const isEdit = !!item;
        const d = this.getActiveData();
        openModal(isEdit ? 'Edit Vendor Assessment' : 'New Vendor Risk Assessment', `
            <div class="form-group"><label class="form-label">Vendor *</label><select class="form-input" id="f-vendorId">${d.vendors.length ? d.vendors.map(v => `<option value="${v.id}" ${item?.vendorId===v.id?'selected':''}>${v.name} (${v.criticality})</option>`).join('') : '<option value="">-- Add vendors first --</option>'}</select></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Security (0-25)</label><input class="form-input" id="f-securityScore" type="number" min="0" max="25" value="${item?.securityScore || '15'}"></div>
                <div class="form-group"><label class="form-label">Compliance (0-25)</label><input class="form-input" id="f-complianceScore" type="number" min="0" max="25" value="${item?.complianceScore || '15'}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Financial (0-25)</label><input class="form-input" id="f-financialScore" type="number" min="0" max="25" value="${item?.financialScore || '20'}"></div>
                <div class="form-group"><label class="form-label">Operational (0-25)</label><input class="form-input" id="f-operationalScore" type="number" min="0" max="25" value="${item?.operationalScore || '18'}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Risk Rating *</label><select class="form-input" id="f-riskRating"><option value="Low" ${item?.riskRating==='Low'?'selected':''}>Low</option><option value="Medium" ${(!item||item?.riskRating==='Medium')?'selected':''}>Medium</option><option value="High" ${item?.riskRating==='High'?'selected':''}>High</option><option value="Critical" ${item?.riskRating==='Critical'?'selected':''}>Critical</option></select></div>
                <div class="form-group"><label class="form-label">Assessment Date</label><input class="form-input" id="f-assessmentDate" type="date" value="${item?.assessmentDate ? item.assessmentDate.split('T')[0] : new Date().toISOString().split('T')[0]}"></div>
            </div>
            <div class="form-group"><label class="form-label">Key Findings</label><textarea class="form-textarea" id="f-findings" rows="2">${item?.findings || ''}</textarea></div>
            <div class="form-group"><label class="form-label">Next Review Date</label><input class="form-input" id="f-nextReview" type="date" value="${item?.nextReview || ''}"></div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveVendorRisk('${item?.id || ''}')">${isEdit ? 'Update' : 'Save Assessment'}</button>`);
    }
    saveVendorRisk(editId) {
        const vendorId = document.getElementById('f-vendorId')?.value; if (!vendorId) { this.toast('Select a vendor', 'error'); return; }
        const ss = parseInt(document.getElementById('f-securityScore')?.value)||0, cs = parseInt(document.getElementById('f-complianceScore')?.value)||0, fs = parseInt(document.getElementById('f-financialScore')?.value)||0, os = parseInt(document.getElementById('f-operationalScore')?.value)||0;
        const overallScore = Math.round(((ss+cs+fs+os)/100)*100);
        const entry = { vendorId, securityScore: ss, complianceScore: cs, financialScore: fs, operationalScore: os, overallScore, riskRating: document.getElementById('f-riskRating')?.value || 'Medium', assessmentDate: document.getElementById('f-assessmentDate')?.value || '', findings: document.getElementById('f-findings')?.value?.trim() || '', nextReview: document.getElementById('f-nextReview')?.value || '' };
        const d = this.getActiveData(); if (!d.vendorAssessments) d.vendorAssessments = [];
        if (editId) { const idx = d.vendorAssessments.findIndex(x => x.id === editId); if (idx >= 0) Object.assign(d.vendorAssessments[idx], entry); }
        else { entry.id = this.generateId('VRA'); entry.createdAt = new Date().toISOString(); d.vendorAssessments.push(entry); }
        this.saveData('vendorAssessments'); closeModal(); this.renderVendorRisk(); this.toast(editId ? 'Assessment updated' : 'Vendor assessed', 'success');
    }
    editVendorRisk(id) { const item = (this.getActiveData().vendorAssessments || []).find(x => x.id === id); if (item) this.showVendorRiskModal(item); }
    deleteVendorRisk(id) { if (!confirm('Delete this assessment?')) return; const d = this.getActiveData(); d.vendorAssessments = (d.vendorAssessments || []).filter(x => x.id !== id); this.saveData('vendorAssessments'); this.renderVendorRisk(); this.toast('Assessment deleted', 'success'); }

    // ==================== COMPLIANCE CALENDAR ====================
    renderComplianceCalendar() {
        const c = document.getElementById('tab-compliance-calendar');
        const d = this.getActiveData();
        const now = new Date();
        const events = [];
        // Gather all dated items across the program
        d.policies.forEach(p => { if (p.reviewDate) events.push({ title: p.title, type: 'Policy Review', date: new Date(p.reviewDate), icon: 'bi-file-earmark-text', color: 'blue', tab: 'policies' }); });
        d.vendors.forEach(v => { if (v.contractRenewal) events.push({ title: v.name + ' renewal', type: 'Vendor Renewal', date: new Date(v.contractRenewal), icon: 'bi-building', color: 'purple', tab: 'vendors' }); });
        d.audits.forEach(a => { if (a.startDate) events.push({ title: a.name, type: 'Audit', date: new Date(a.startDate), icon: 'bi-clipboard-check', color: 'green', tab: 'audits' }); });
        d.tasks.filter(t => t.status !== 'Completed').forEach(t => { if (t.dueDate) events.push({ title: t.title, type: 'Task Due', date: new Date(t.dueDate), icon: 'bi-check2-square', color: 'amber', tab: 'tasks' }); });
        d.findings.filter(f => f.status !== 'Closed').forEach(f => { if (f.dueDate) events.push({ title: f.title, type: 'Finding Due', date: new Date(f.dueDate), icon: 'bi-search', color: 'red', tab: 'findings' }); });
        d.issues.filter(i => i.status !== 'Closed').forEach(i => { if (i.dueDate) events.push({ title: i.title, type: 'Issue Due', date: new Date(i.dueDate), icon: 'bi-bug', color: 'amber', tab: 'issues' }); });
        (d.vendorAssessments||[]).forEach(va => { if (va.nextReview) events.push({ title: (d.vendors.find(v=>v.id===va.vendorId)?.name||'Vendor') + ' re-assessment', type: 'Vendor Review', date: new Date(va.nextReview), icon: 'bi-clipboard2-pulse', color: 'purple', tab: 'vendor-risk' }); });
        (d.itgcControls||[]).forEach(ig => { if (ig.testDate) { const next = new Date(ig.testDate); next.setMonth(next.getMonth() + (ig.frequency === 'Annual' ? 12 : ig.frequency === 'Semi-Annual' ? 6 : 3)); events.push({ title: ig.name + ' retest', type: 'ITGC Retest', date: next, icon: 'bi-bank2', color: 'blue', tab: 'itgc' }); }});
        // Sort by date
        events.sort((a, b) => a.date - b.date);
        const overdue = events.filter(e => e.date < now);
        const next7 = events.filter(e => e.date >= now && e.date <= new Date(now.getTime() + 7*24*60*60*1000));
        const next30 = events.filter(e => e.date >= now && e.date <= new Date(now.getTime() + 30*24*60*60*1000));
        const upcoming = events.filter(e => e.date >= now);

        c.innerHTML = `
            <div class="modern-page-hero" style="background: linear-gradient(135deg, #0c4a6e 0%, #1e40af 50%, #6d28d9 100%); border-radius: var(--radius-2xl); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; inset: 0; background: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"); opacity: 0.3;"></div>
                <div style="position: relative; z-index: 1;">
                    <h2 style="font-size: 22px; font-weight: 700; color: white; margin: 0 0 6px;"><i class="bi bi-calendar3-range"></i> Compliance Calendar</h2>
                    <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">Unified view of all compliance deadlines: policy reviews, audits, vendor renewals, task due dates, and ITGC retests.</p>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card" style="border-left: 4px solid var(--accent-red);"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${overdue.length}</div><div style="font-size: 12px; color: var(--text-muted);">Overdue</div></div></div>
                <div class="card" style="border-left: 4px solid var(--accent-amber);"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${next7.length}</div><div style="font-size: 12px; color: var(--text-muted);">Next 7 Days</div></div></div>
                <div class="card" style="border-left: 4px solid var(--accent-blue);"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${next30.length}</div><div style="font-size: 12px; color: var(--text-muted);">Next 30 Days</div></div></div>
                <div class="card" style="border-left: 4px solid var(--accent-green);"><div class="card-body" style="padding: 18px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${events.length}</div><div style="font-size: 12px; color: var(--text-muted);">Total Events</div></div></div>
            </div>

            ${overdue.length > 0 ? `<div class="card" style="margin-bottom: 20px; border: 1px solid var(--accent-red);">
                <div class="card-header" style="padding: 14px 16px; background: var(--accent-red-soft);"><span style="font-weight: 600; color: var(--accent-red);"><i class="bi bi-exclamation-circle-fill"></i> Overdue (${overdue.length})</span></div>
                <div class="card-body" style="padding: 0; max-height: 250px; overflow-y: auto;">
                    ${overdue.map(e => `<div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer;" onclick="app.switchTab('${e.tab}')">
                        <i class="bi ${e.icon}" style="font-size: 18px; color: var(--accent-${e.color});"></i>
                        <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${e.title}</div><div style="font-size: 11px; color: var(--text-muted);">${e.type}</div></div>
                        <span class="badge badge-red" style="font-size: 10px;">${Math.abs(Math.ceil((e.date - now)/(1000*60*60*24)))}d overdue</span>
                    </div>`).join('')}
                </div></div>` : ''}

            <div class="card">
                <div class="card-header" style="padding: 14px 16px;"><span style="font-weight: 600;"><i class="bi bi-calendar3"></i> Upcoming Events (${upcoming.length})</span></div>
                <div class="card-body" style="padding: 0; max-height: 450px; overflow-y: auto;">
                    ${upcoming.length > 0 ? upcoming.map(e => {
                        const daysUntil = Math.ceil((e.date - now) / (1000*60*60*24));
                        const urgency = daysUntil <= 7 ? 'amber' : daysUntil <= 30 ? 'blue' : 'green';
                        return `<div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer;" onclick="app.switchTab('${e.tab}')">
                            <i class="bi ${e.icon}" style="font-size: 18px; color: var(--accent-${e.color});"></i>
                            <div style="flex: 1; min-width: 0;"><div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${e.title}</div><div style="font-size: 11px; color: var(--text-muted);">${e.type} &bull; ${e.date.toLocaleDateString()}</div></div>
                            <span class="badge badge-${urgency}" style="font-size: 10px;">${daysUntil}d</span>
                        </div>`;
                    }).join('') : `<div style="padding: 50px; text-align: center; color: var(--text-muted);"><i class="bi bi-calendar3-range" style="font-size: 40px; opacity: 0.3; display: block; margin-bottom: 12px;"></i><p>No upcoming compliance events. Add data to see deadlines.</p></div>`}
                </div>
            </div>`;
    }
    generateLearningCertificate() {
        const p = this.getLearningProgress();
        if (!p.missionsComplete) {
            this.toast('Complete Missions 1–3 to unlock the certificate.', 'error');
            return;
        }
        const name = (localStorage.getItem('grc_studentName') || '').trim() || 'GRC Learner';
        const today = new Date().toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });

        const win = window.open('', '_blank');
        if (!win) { this.toast('Popup blocked — allow popups to download the certificate.', 'error'); return; }

        win.document.write(`
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>GRC Practice Completion Certificate</title>
<style>
  body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1020; }
  .wrap{ display:flex; min-height:100vh; align-items:center; justify-content:center; padding:32px; }
  .card{ width:min(900px, 100%); background:#ffffff; border-radius:28px; padding:44px; box-shadow: 0 30px 80px rgba(0,0,0,.35); position:relative; overflow:hidden; }
  .badge{ display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px; background:#f3f4f6; font-weight:700; font-size:12px; letter-spacing:.4px; text-transform:uppercase; }
  h1{ margin:18px 0 10px; font-size:40px; letter-spacing:-.6px; }
  p{ margin:0; color:#374151; line-height:1.7; font-size:14px; }
  .name{ margin:18px 0 6px; font-size:30px; font-weight:800; color:#111827; }
  .meta{ display:flex; gap:18px; flex-wrap:wrap; margin-top:18px; }
  .meta .box{ border:1px solid #e5e7eb; border-radius:16px; padding:12px 14px; min-width: 220px; }
  .meta .k{ font-size:11px; color:#6b7280; text-transform:uppercase; letter-spacing:.7px; margin-bottom:6px; }
  .meta .v{ font-size:14px; font-weight:700; color:#111827; }
  .sig{ margin-top:28px; display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap; }
  .line{ width:240px; height:1px; background:#111827; margin-top:32px; }
  .note{ font-size:12px; color:#6b7280; max-width:520px; }
  .ribbon{ position:absolute; inset:-120px -120px auto auto; width:280px; height:280px; background: linear-gradient(135deg, #7c3aed, #2563eb); border-radius: 60px; transform: rotate(18deg); opacity:.16; }
  .btns{ margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; }
  button{ border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; }
  .print{ background:#111827; color:#fff; }
  .close{ background:#e5e7eb; }
  @media print { .btns{display:none;} body{ background:#fff; } .wrap{ padding:0; } .card{ box-shadow:none; border-radius:0; } }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="ribbon"></div>
      <div class="badge">GRC Practice Lab • Completion Certificate</div>
      <h1>GRC Practice Completion</h1>
      <p>This certifies that the learner has successfully completed the guided learning missions in the GRC Practice Lab:</p>
      <div class="name">${name}</div>
      <p><strong>Missions Completed:</strong> Risk Register • Control Mapping (ISO 27001) • Statement of Applicability (SoA)</p>

      <div class="meta">
        <div class="box"><div class="k">Completion Date</div><div class="v">${today}</div></div>
        <div class="box"><div class="k">Program</div><div class="v">Guided Missions (1–3)</div></div>
        <div class="box"><div class="k">Platform</div><div class="v">GRC Practice Lab (Local)</div></div>
      </div>

      <div class="sig">
        <div>
          <div class="line"></div>
          <div style="font-weight:800; margin-top:8px;">Practice Platform</div>
          <div style="font-size:12px; color:#6b7280;">Auto-generated for learning use</div>
        </div>
        <div class="note">
          Educational / practice use only. This certificate does not represent an accredited certification and is intended to demonstrate guided practice completion within this simulator.
        </div>
      </div>

      <div class="btns">
        <button class="print" onclick="window.print()">Print / Save as PDF</button>
        <button class="close" onclick="window.close()">Close</button>
      </div>
    </div>
  </div>
</body>
</html>`);
        win.document.close();
        this.toast('Certificate opened — use Print to save as PDF.', 'success');
    }

}
function openModal(title, body, footer) {
    const mt = document.getElementById('modal-title');
    // Default title
    mt.textContent = title;
    // Append a contextual "Load Example" button if available
    try {
        if (window.app && typeof app.hasModalExample === 'function' && app.hasModalExample()) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-secondary btn-xs';
            btn.innerHTML = '<i class="bi bi-lightbulb"></i> Load Example';
            btn.onclick = () => { try { app.loadModalExample(); } catch(e) { console.error(e); } };
            mt.appendChild(btn);
        }
    } catch(e) {}

    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal-footer').innerHTML = footer;
    document.getElementById('modal-overlay').classList.add('active');
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); try { if (window.app && typeof app.clearModalContext === 'function') app.clearModalContext(); } catch(e) {} }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
document.getElementById('modal-overlay')?.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
let app;
document.addEventListener('DOMContentLoaded', () => { app = new GRCLabPro(); window.app = app; });
</script>

</div><!-- End app-wrapper -->

<!-- Site Footer -->
<footer style="background: var(--bg-surface); border-top: 1px solid var(--border-default); padding: 40px 0 32px; margin-top: 0;">
    <div style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div style="font-size: 13px; color: var(--text-muted);">
                © <span id="footer-year">2025</span> John Bommeraveni Joseph. Educational use only.
            </div>
            <div style="display: flex; gap: 24px;">
                <a href="index.html" style="font-size: 13px; color: var(--text-muted); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'">Home</a>
                <a href="grc-lab.html" style="font-size: 13px; color: var(--text-muted); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'">GRC Lab</a>
                <a href="terms.html" style="font-size: 13px; color: var(--text-muted); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'">Terms</a>
                <a href="https://www.youtube.com/@GRCMadeSimple" target="_blank" style="font-size: 13px; color: var(--text-muted); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'">YouTube</a>
            </div>
        </div>
    </div>
</footer>
<script>document.getElementById('footer-year').textContent = new Date().getFullYear();</script>
</body>
</html>
