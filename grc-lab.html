<!DOCTYPE html>
<html lang="en">
<head>
  <title>GRC Practice Lab – John B Joseph</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

  <!-- Theme fonts & CSS -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet"/>
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css"/>
  <link rel="stylesheet" href="css/animate.css"/>
  <link rel="stylesheet" href="css/owl.carousel.min.css"/>
  <link rel="stylesheet" href="css/owl.theme.default.min.css"/>
  <link rel="stylesheet" href="css/magnific-popup.css"/>
  <link rel="stylesheet" href="css/aos.css"/>
  <link rel="stylesheet" href="css/ionicons.min.css"/>
  <link rel="stylesheet" href="css/flaticon.css"/>
  <link rel="stylesheet" href="css/icomoon.css"/>
  <link rel="stylesheet" href="css/style.css"/>

  <style>
    /* Make sure theme animations don’t hide content */
    .ftco-animate { opacity: 1 !important; visibility: visible !important; }

    .grc-lab-hero { padding-top: 140px; padding-bottom: 40px; }

    .grc-tab-buttons .btn{ margin-right:8px; margin-bottom:8px; }
    .grc-tab{ display:none; }
    .grc-tab.active{ display:block; }

    .grc-lab-container{ width:80vw; max-width:1600px; margin:0 auto; }
    @media (max-width: 991.98px){ .grc-lab-container{ width:100vw; } }

    .heat-cell{ color:#fff; font-weight:600; text-align:center; white-space:nowrap; }
    .heat-cell small{ display:block; font-weight:400; opacity:.9; }
    .heat-good{ background:#1f8f3b; } .heat-medium{ background:#a96b1f; }
    .heat-low{ background:#8f3b1f; } .heat-none{ background:#7a1f1f; }

    .heat-pill{ border-radius:999px; padding:4px 10px; font-size:.8rem; display:inline-block; }

    .dashboard-card{
      border:1px solid rgba(255,255,255,.06);
      border-radius:10px;
      background:#111827;
      color:#fff;
    }
    .dashboard-card .label{ font-size:.75rem; letter-spacing:.06em; opacity:.7; text-transform:uppercase; }
    .dashboard-card .value{ font-size:1.4rem; font-weight:600; }
    .dashboard-card .sub{ font-size:.8rem; opacity:.8; }

    #risk-matrix-canvas{ background:#0c0f12; border-radius:8px; width:100%; max-width:100%; }

    .table td, .table th { vertical-align: middle; }
    .small-muted{ color:#9ca3af; font-size:.85rem; }

    textarea.form-control{ background:#020617; color:#e5e7eb; border-color:#1f2933; }
  </style>
</head>

<body data-spy="scroll" data-target=".site-navbar-target" data-offset="300">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar ftco-navbar-light site-navbar-target" id="ftco-navbar">
    <div class="container">
      <a class="navbar-brand" href="index.html">John B Joseph</a>
      <button class="navbar-toggler js-fh5co-nav-toggle fh5co-nav-toggle" type="button"
        data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="oi oi-menu"></span> Menu
      </button>
      <div class="collapse navbar-collapse" id="ftco-nav">
        <ul class="navbar-nav nav ml-auto">
          <li class="nav-item"><a href="index.html#home-section" class="nav-link"><span>Home</span></a></li>
          <li class="nav-item"><a href="toolkit.html" class="nav-link"><span>Toolkit</span></a></li>
          <li class="nav-item active"><a href="grc-lab.html" class="nav-link"><span>GRC Practice Lab</span></a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Lab -->
  <section class="ftco-section grc-lab-hero">
    <div class="grc-lab-container container-fluid px-4 px-md-5">
      <!-- Header -->
      <div class="row justify-content-center mb-4">
        <div class="col-md-10 text-center ftco-animate">
          <h1 class="mb-3">GRC Practice Lab (v3.x)</h1>
          <p class="lead">
            Practice frameworks, assets, risks, controls, treatments, issues and reporting — all in your browser (data stays local).
          </p>
          <p class="small-muted mb-0">Controls are paraphrased from ISO 27001, NIST CSF, PCI DSS, HIPAA for education only.</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="row mb-4">
        <div class="col-md-12 text-center grc-tab-buttons">
          <button class="btn btn-primary btn-sm" data-grc-tab="frameworks">Frameworks &amp; Controls</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="assets">Assets</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="risks">Risks</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="controls">Local Controls</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="issues">Issues / Findings</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="treatments">Treatments / Action Plans</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="gap">Gap Analysis</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="dashboard">Dashboard</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="matrix">Risk Matrix</button>
          <button class="btn btn-outline-light btn-sm" data-grc-tab="auditor">Auditor Summary</button>
        </div>
      </div>

      <!-- Frameworks -->
      <div id="tab-frameworks" class="grc-tab active ftco-animate">
        <h3>Framework Library</h3>
        <p class="mb-3">Filter and review a unified control set aligned to ISO/NIST/PCI/HIPAA.</p>

        <div class="row mb-3">
          <div class="col-md-4 mb-2">
            <label class="text-muted small mb-1">Filter by Framework</label>
            <select id="framework-filter" class="form-control form-control-sm">
              <option value="all">All frameworks</option>
              <option value="ISO 27001">ISO 27001</option>
              <option value="NIST CSF">NIST CSF</option>
              <option value="PCI DSS">PCI DSS</option>
              <option value="HIPAA">HIPAA</option>
            </select>
          </div>
          <div class="col-md-4 mb-2">
            <label class="text-muted small mb-1">Filter by Category</label>
            <select id="category-filter" class="form-control form-control-sm">
              <option value="all">All categories</option>
              <option>Access Control</option>
              <option>Identity &amp; Authentication</option>
              <option>Logging &amp; Monitoring</option>
              <option>Encryption &amp; Key Management</option>
              <option>Backup &amp; Recovery</option>
              <option>Change Management</option>
              <option>Vulnerability Management</option>
              <option>Incident Response</option>
              <option>Vendor Risk</option>
              <option>Policy &amp; Governance</option>
              <option>Awareness &amp; Training</option>
            </select>
          </div>
          <div class="col-md-4 mb-2">
            <label class="text-muted small mb-1">Search</label>
            <input id="framework-search" class="form-control form-control-sm" placeholder="Search by name, ID, description...">
          </div>
        </div>

        <div class="table-responsive bg-dark p-3 rounded">
          <table class="table table-dark table-striped table-hover table-sm mb-0">
            <thead>
              <tr>
                <th style="width:10%">ID</th>
                <th style="width:20%">Name</th>
                <th style="width:18%">Category</th>
                <th style="width:20%">Based On</th>
                <th style="width:32%">Description</th>
              </tr>
            </thead>
            <tbody id="frameworks-table-body"></tbody>
          </table>
          <div class="mt-2 text-right">
            <small id="frameworks-count" class="text-muted"></small>
          </div>
        </div>
      </div>

      <!-- Assets -->
      <div id="tab-assets" class="grc-tab ftco-animate">
        <h3>Asset Inventory</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Asset</h5>
              <form id="asset-form">
                <input type="hidden" id="asset-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Name *</label>
                  <input id="asset-name" class="form-control form-control-sm" required placeholder="e.g. MediCloud Web App">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Type *</label>
                  <select id="asset-type" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Application</option><option>Database</option><option>Server / Host</option>
                    <option>Network / Security Device</option><option>Cloud Service</option>
                    <option>Vendor / Third Party</option><option>Data Store</option><option>People / Role</option><option>Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Business criticality *</label>
                  <select id="asset-criticality" class="form-control form-control-sm" required>
                    <option value="">Select level...</option>
                    <option>High</option><option>Medium</option><option>Low</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="text-muted small mb-1 d-block">Data types</label>
                  <div class="d-flex flex-wrap">
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-phi" value="PHI">
                      <label class="custom-control-label" for="dt-phi">PHI</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-pii" value="PII">
                      <label class="custom-control-label" for="dt-pii">PII</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-pan" value="Card data">
                      <label class="custom-control-label" for="dt-pan">Card data</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-3 mb-1">
                      <input type="checkbox" class="custom-control-input asset-dt" id="dt-int" value="Internal data">
                      <label class="custom-control-label" for="dt-int">Internal data</label>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label class="text-muted small mb-1">Owner</label>
                  <input id="asset-owner" class="form-control form-control-sm" placeholder="e.g. DevOps Team / CTO">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Notes</label>
                  <textarea id="asset-notes" class="form-control form-control-sm" rows="2" placeholder="Scope, region, integrations..."></textarea>
                </div>

                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="asset-form-submit">Save asset</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="asset-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally in your browser.</small>
              </form>
            </div>
          </div>

          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Assets</h5>
                <small id="assets-count" class="text-muted"></small>
              </div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:22%">Name</th><th style="width:16%">Type</th><th style="width:14%">Criticality</th>
                      <th style="width:20%">Data types</th><th style="width:16%">Owner</th><th style="width:12%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="assets-table-body"></tbody>
                </table>
              </div>
              <div id="assets-empty" class="text-muted small mt-2">No assets yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risks -->
      <div id="tab-risks" class="grc-tab ftco-animate">
        <h3>Risk Register</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Risk</h5>
              <form id="risk-form">
                <input type="hidden" id="risk-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Title *</label>
                  <input id="risk-title" class="form-control form-control-sm" required placeholder="e.g. Unauthorised access to app">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Asset *</label>
                  <select id="risk-asset" class="form-control form-control-sm" required>
                    <option value="">Select asset...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Category *</label>
                  <select id="risk-category" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Cybersecurity</option><option>Compliance</option><option>Operational</option>
                    <option>Privacy</option><option>Third-Party</option><option>Other</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Likelihood (1–5) *</label>
                    <select id="risk-likelihood" class="form-control form-control-sm" required>
                      <option value="">Select...</option>
                      <option value="1">1 – Rare</option><option value="2">2 – Unlikely</option><option value="3">3 – Possible</option>
                      <option value="4">4 – Likely</option><option value="5">5 – Almost certain</option>
                    </select>
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Impact (1–5) *</label>
                    <select id="risk-impact" class="form-control form-control-sm" required>
                      <option value="">Select...</option>
                      <option value="1">1 – Insignificant</option><option value="2">2 – Minor</option><option value="3">3 – Moderate</option>
                      <option value="4">4 – Major</option><option value="5">5 – Severe</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label class="text-muted small mb-1">Owner</label>
                  <input id="risk-owner" class="form-control form-control-sm" placeholder="e.g. CISO / Product Owner">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Status *</label>
                  <select id="risk-status" class="form-control form-control-sm" required>
                    <option>Open</option><option>In progress</option><option>Mitigated</option><option>Accepted</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Description / Notes</label>
                  <textarea id="risk-notes" class="form-control form-control-sm" rows="2"></textarea>
                </div>

                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="risk-form-submit">Save risk</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="risk-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">
                  Score = Likelihood × Impact (1–25). High ≥ 15; Medium 6–12; Low 1–5.
                </small>
              </form>
            </div>
          </div>

          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Risks</h5>
                <small id="risks-count" class="text-muted"></small>
              </div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:24%">Title</th><th style="width:18%">Asset</th><th style="width:16%">Category</th>
                      <th style="width:16%">Inherent</th><th style="width:14%">Status</th><th style="width:12%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="risks-table-body"></tbody>
                </table>
              </div>
              <div id="risks-empty" class="text-muted small mt-2">No risks yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Local Controls -->
      <div id="tab-controls" class="grc-tab ftco-animate">
        <h3>Local Controls (Org Library)</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Control</h5>
              <form id="control-form">
                <input type="hidden" id="control-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Control name *</label>
                  <input id="control-name" class="form-control form-control-sm" required placeholder="e.g. Enforce MFA for admins">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Type *</label>
                  <select id="control-type" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Preventive</option><option>Detective</option><option>Corrective</option>
                    <option>Administrative</option><option>Technical</option><option>Physical</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Status *</label>
                  <select id="control-status" class="form-control form-control-sm" required>
                    <option>In place</option><option>Planned</option><option>Not applicable</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Owner</label>
                  <input id="control-owner" class="form-control form-control-sm" placeholder="DevSecOps / IT Ops / Compliance">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Description</label>
                  <textarea id="control-description" class="form-control form-control-sm" rows="2" placeholder="Implementation details"></textarea>
                </div>

                <div class="form-group">
                  <label class="text-muted small mb-1">Related risks</label>
                  <select id="control-risks" class="form-control form-control-sm" multiple></select>
                  <small class="text-muted">Hold Ctrl/Cmd to multi-select.</small>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Related framework controls</label>
                  <select id="control-frameworks" class="form-control form-control-sm" multiple></select>
                </div>

                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="control-form-submit">Save control</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="control-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally with assets, risks and issues.</small>
              </form>
            </div>
          </div>

          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Controls</h5>
                <small id="controls-count" class="text-muted"></small>
              </div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:26%">Name</th><th style="width:16%">Type</th><th style="width:14%">Status</th>
                      <th style="width:22%">Linked risks</th><th style="width:12%">Frameworks</th><th style="width:10%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="controls-table-body"></tbody>
                </table>
              </div>
              <div id="controls-empty" class="text-muted small mt-2">No controls yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Issues / Findings -->
      <div id="tab-issues" class="grc-tab ftco-animate">
        <h3>Issues &amp; Findings</h3>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Issue</h5>
              <form id="issue-form">
                <input type="hidden" id="issue-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Title *</label>
                  <input id="issue-title" class="form-control form-control-sm" required placeholder="e.g. Missing MFA for admins">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Type *</label>
                  <select id="issue-type" class="form-control form-control-sm" required>
                    <option value="">Select...</option>
                    <option>Audit</option><option>Pen test</option><option>Incident</option><option>Risk review</option><option>Other</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="text-muted small mb-1">Linked objects (optional)</label>
                  <select id="issue-asset" class="form-control form-control-sm mb-1"><option value="">Linked asset...</option></select>
                  <select id="issue-risk"  class="form-control form-control-sm mb-1"><option value="">Linked risk...</option></select>
                  <select id="issue-control" class="form-control form-control-sm"><option value="">Linked control...</option></select>
                </div>

                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Severity *</label>
                    <select id="issue-severity" class="form-control form-control-sm" required>
                      <option value="">Select...</option>
                      <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
                    </select>
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Status *</label>
                    <select id="issue-status" class="form-control form-control-sm" required>
                      <option>Open</option><option>In progress</option><option>Resolved</option><option>Accepted</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Owner</label>
                    <input id="issue-owner" class="form-control form-control-sm" placeholder="e.g. Dev Lead">
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Due date</label>
                    <input type="date" id="issue-due" class="form-control form-control-sm">
                  </div>
                </div>

                <div class="form-group">
                  <label class="text-muted small mb-1">Details / Recommendation</label>
                  <textarea id="issue-notes" class="form-control form-control-sm" rows="2"></textarea>
                </div>

                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="issue-form-submit">Save issue</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="issue-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Stored locally in your browser.</small>
              </form>
            </div>
          </div>

          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Issues / Findings</h5>
                <small id="issues-count" class="text-muted"></small>
              </div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:24%">Title</th><th style="width:12%">Type</th><th style="width:14%">Severity</th>
                      <th style="width:16%">Status</th><th style="width:18%">Linked to</th><th style="width:16%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="issues-table-body"></tbody>
                </table>
              </div>
              <div id="issues-empty" class="text-muted small mt-2">No issues yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Treatments / Action Plans -->
      <div id="tab-treatments" class="grc-tab ftco-animate">
        <h3>Treatments &amp; Action Plans</h3>
        <p class="mb-3">Link concrete actions to risks, assign owners, and track progress.</p>
        <div class="row">
          <div class="col-lg-4 col-md-5 mb-4">
            <div class="bg-dark p-3 rounded">
              <h5 class="mb-3">Add / Edit Action</h5>
              <form id="treatment-form">
                <input type="hidden" id="treatment-id">
                <div class="form-group">
                  <label class="text-muted small mb-1">Action title *</label>
                  <input id="treatment-title" class="form-control form-control-sm" required placeholder="e.g. Implement WAF for MediCloud">
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Linked risk *</label>
                  <select id="treatment-risk" class="form-control form-control-sm" required>
                    <option value="">Select risk...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Status *</label>
                  <select id="treatment-status" class="form-control form-control-sm" required>
                    <option>Open</option>
                    <option>In progress</option>
                    <option>Completed</option>
                    <option>Accepted</option>
                  </select>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Owner</label>
                    <input id="treatment-owner" class="form-control form-control-sm" placeholder="e.g. DevOps Lead">
                  </div>
                  <div class="form-group col-6">
                    <label class="text-muted small mb-1">Target date</label>
                    <input type="date" id="treatment-due" class="form-control form-control-sm">
                  </div>
                </div>
                <div class="form-group">
                  <label class="text-muted small mb-1">Notes</label>
                  <textarea id="treatment-notes" class="form-control form-control-sm" rows="2" placeholder="Outline remediation steps, dependencies, etc."></textarea>
                </div>

                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary btn-sm" type="submit" id="treatment-form-submit">Save action</button>
                  <button class="btn btn-outline-light btn-sm" type="button" id="treatment-form-cancel">Clear</button>
                </div>
                <small class="text-muted d-block mt-2">Actions are stored locally with your risks.</small>
              </form>
            </div>
          </div>

          <div class="col-lg-8 col-md-7 mb-4">
            <div class="bg-dark p-3 rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Action plan</h5>
                <small id="treatments-count" class="text-muted"></small>
              </div>
              <div class="table-responsive">
                <table class="table table-dark table-striped table-hover table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:26%">Title</th>
                      <th style="width:24%">Linked risk</th>
                      <th style="width:14%">Status</th>
                      <th style="width:14%">Target date</th>
                      <th style="width:12%">Owner</th>
                      <th style="width:10%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="treatments-table-body"></tbody>
                </table>
              </div>
              <div id="treatments-empty" class="text-muted small mt-2">No actions yet.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gap Analysis -->
      <div id="tab-gap" class="grc-tab ftco-animate">
        <h3>Gap analysis &amp; heatmap</h3>
        <p class="mb-3">
          Coverage is based on <b>local controls</b> mapped to framework controls.
          “In place” = implemented; “Planned” = planned-only.
        </p>
        <div class="table-responsive bg-dark p-3 rounded">
          <table class="table table-dark table-striped table-hover table-sm mb-0">
            <thead>
              <tr>
                <th style="width:24%">Category</th>
                <th style="width:12%">Total controls</th>
                <th style="width:16%">Implemented</th>
                <th style="width:16%">Planned only</th>
                <th style="width:16%">Not implemented</th>
                <th style="width:16%">Heatmap</th>
              </tr>
            </thead>
            <tbody id="gap-table-body"></tbody>
          </table>
          <div class="mt-2 text-right"><small id="gap-overall-coverage" class="text-muted"></small></div>
        </div>
      </div>

      <!-- Dashboard -->
      <div id="tab-dashboard" class="grc-tab ftco-animate">
        <h3>Dashboard</h3>
        <div class="row">
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100">
              <div class="label">Assets</div>
              <div class="value" id="dash-assets">0</div>
              <div class="sub">Tracked in inventory</div>
            </div>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100">
              <div class="label">Risks</div>
              <div class="value" id="dash-risks">0</div>
              <div class="sub">
                <span id="dash-high">0</span> high risk(s) ·
                <span id="dash-open-actions">0</span> open action(s)
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100">
              <div class="label">Controls</div>
              <div class="value" id="dash-controls">0</div>
              <div class="sub">Local org controls</div>
            </div>
          </div>
          <div class="col-sm-6 col-md-3 mb-3">
            <div class="dashboard-card p-3 h-100">
              <div class="label">Issues</div>
              <div class="value" id="dash-issues">0</div>
              <div class="sub"><span id="dash-overdue">0</span> overdue</div>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-4 mb-3">
            <div class="dashboard-card p-3 h-100 d-flex flex-column justify-content-between">
              <div>
                <div class="label">Framework coverage</div>
                <div class="value"><span id="dash-coverage">0%</span></div>
                <div class="sub">Implemented local controls mapped to framework controls.</div>
              </div>
              <div class="mt-2">
                <span id="dash-coverage-pill" class="heat-pill heat-none">Coverage heat</span>
              </div>
            </div>
          </div>
          <div class="col-md-8 mb-3">
            <div class="dashboard-card p-3 h-100">
              <div class="label mb-1">Scenarios &amp; exports</div>
              <p class="sub mb-3">
                Export current lab to JSON, import saved scenarios, or start from the built-in MediCloud demo scenario.
              </p>
              <div class="d-flex flex-wrap">
                <button id="btn-export" class="btn btn-sm btn-primary mr-2 mb-2">Export current data (JSON)</button>
                <button id="btn-import" class="btn btn-sm btn-outline-light mr-2 mb-2">Import scenario (JSON)</button>
                <button id="btn-medicloud" class="btn btn-sm btn-success mr-2 mb-2">Load MediCloud demo</button>
                <button id="btn-reset" class="btn btn-sm btn-outline-danger mb-2">Reset lab (clear all data)</button>
                <input type="file" id="file-import" accept="application/json" style="display:none">
              </div>
              <small id="import-status" class="text-muted d-block mt-2"></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Matrix -->
      <div id="tab-matrix" class="grc-tab ftco-animate">
        <h3>Risk Matrix (Inherent vs Residual)</h3>
        <p class="mb-3">
          Toggle to compare <b>Inherent</b> and a basic calculated <b>Residual</b>
          (reduced by implemented controls linked to a risk).
        </p>
        <div class="bg-dark p-3 rounded mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-sm btn-primary active" id="toggle-inherent"><input type="radio" name="mx" checked> Inherent</label>
              <label class="btn btn-sm btn-outline-light" id="toggle-residual"><input type="radio" name="mx"> Residual</label>
            </div>
            <button id="matrix-export" class="btn btn-outline-light btn-sm">Export as PNG</button>
          </div>
          <canvas id="risk-matrix-canvas" width="920" height="640"></canvas>
          <div id="matrix-legend" class="mt-3 text-center text-muted small"></div>
        </div>
      </div>

      <!-- Auditor Summary -->
      <div id="tab-auditor" class="grc-tab ftco-animate">
        <h3>Auditor-style summary</h3>
        <p class="mb-3">
          Automatically generate a narrative you can reuse in audit reports, board decks, or certifications.
        </p>
        <div class="bg-dark p-3 rounded">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small-muted">Summary is generated from your current assets, risks, controls, treatments and issues.</span>
            <button id="btn-refresh-auditor" class="btn btn-outline-light btn-sm">Refresh summary</button>
          </div>
          <textarea id="auditor-summary-text" class="form-control form-control-sm" rows="12"></textarea>
          <small class="text-muted d-block mt-2">
            Tip: You can copy-paste this into an audit report, SOC 2 narrative, or ISO 27001 SoA summary.
          </small>
        </div>
      </div>

    </div>
  </section>

  <footer class="ftco-footer ftco-section">
    <div class="container">
      <div class="row"><div class="col-md-12 text-center">
        <p>Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | GRC Practice Lab by John B Joseph</p>
      </div></div>
    </div>
  </footer>

  <!-- Core scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/main.js"></script>

  <!-- GRC Lab App -->
  <script>
  // ============ FRAMEWORK LIBRARY ============
  const FRAMEWORK_CONTROLS = [
    { id:"CTRL-AC-01", name:"Manage user accounts", category:"Access Control",
      description:"Only approved users receive accounts; access removed quickly on role change/leave.",
      frameworks:["ISO 27001","NIST CSF"], references:["ISO 27001 A.9","NIST PR.AC-1"] },
    { id:"CTRL-AC-02", name:"Limit privileged access", category:"Identity & Authentication",
      description:"Privileged roles tightly controlled, logged, and periodically reviewed.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS"], references:["ISO 27001 A.9.2","NIST PR.AC-4","PCI DSS 7"] },
    { id:"CTRL-AC-03", name:"Strong authentication", category:"Identity & Authentication",
      description:"MFA for admin accounts and remote access to critical systems.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS","HIPAA"], references:["ISO 27001 A.9.4","NIST PR.AC-7","PCI DSS 8","HIPAA 164.312(d)"] },
    { id:"CTRL-LOG-01", name:"Central activity logging", category:"Logging & Monitoring",
      description:"Security events from key systems collected centrally.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS"], references:["ISO 27001 A.12.4","NIST DE.AE-1","PCI DSS 10"] },
    { id:"CTRL-LOG-02", name:"Regular log review", category:"Logging & Monitoring",
      description:"Important system logs reviewed; suspicious events investigated.",
      frameworks:["ISO 27001","NIST CSF","HIPAA"], references:["ISO 27001 A.12.4","NIST DE.CM-1","HIPAA 164.308(a)(1)"] },
    { id:"CTRL-ENC-01", name:"Encrypt data at rest", category:"Encryption & Key Management",
      description:"Sensitive data in DBs, file systems, and backups encrypted.",
      frameworks:["ISO 27001","PCI DSS","HIPAA"], references:["ISO 27001 A.10","PCI DSS 3","HIPAA 164.312(a)(2)(iv)"] },
    { id:"CTRL-ENC-02", name:"Encrypt data in transit", category:"Encryption & Key Management",
      description:"TLS for sensitive data with weak ciphers disabled.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS","HIPAA"], references:["ISO 27001 A.13","NIST PR.DS-2","PCI DSS 4","HIPAA 164.312(e)(1)"] },
    { id:"CTRL-BCP-01", name:"Backups & restore testing", category:"Backup & Recovery",
      description:"Critical systems backed up; restore tests performed and documented.",
      frameworks:["ISO 27001","NIST CSF"], references:["ISO 27001 A.12.3","NIST PR.IP-4"] },
    { id:"CTRL-CHG-01", name:"Controlled changes", category:"Change Management",
      description:"Changes follow an approved process with impact assessment and rollback plan.",
      frameworks:["ISO 27001","NIST CSF"], references:["ISO 27001 A.12.1","NIST PR.IP-3"] },
    { id:"CTRL-CHG-02", name:"Separate environments", category:"Change Management",
      description:"Dev/Test separated from Prod with restricted access.",
      frameworks:["ISO 27001","PCI DSS"], references:["ISO 27001 A.12.1.4","PCI DSS 6.4"] },
    { id:"CTRL-VULN-01", name:"Vulnerability management", category:"Vulnerability Management",
      description:"Regular scans; patches applied per timelines.",
      frameworks:["ISO 27001","NIST CSF","PCI DSS"], references:["ISO 27001 A.12.6","NIST DE.CM-8","PCI DSS 11"] },
    { id:"CTRL-IR-01", name:"Incident response plan", category:"Incident Response",
      description:"Documented IR plan with roles, steps, communications.",
      frameworks:["ISO 27001","NIST CSF","HIPAA"], references:["ISO 27001 A.16","NIST RS.RP-1","HIPAA 164.308(a)(6)"] },
    { id:"CTRL-IR-02", name:"Detect and triage events", category:"Incident Response",
      description:"Events detected, triaged, escalated per procedures.",
      frameworks:["ISO 27001","NIST CSF"], references:["ISO 27001 A.16","NIST DE.CM-1"] },
    { id:"CTRL-VND-01", name:"Vendor due diligence", category:"Vendor Risk",
      description:"3rd parties assessed before onboarding and periodically.",
      frameworks:["ISO 27001","NIST CSF"], references:["ISO 27001 A.15","NIST ID.SC-1"] },
    { id:"CTRL-VND-02", name:"Data protection in contracts", category:"Vendor Risk",
      description:"Vendor contracts include data protection, breach notice, right to audit.",
      frameworks:["ISO 27001","HIPAA"], references:["ISO 27001 A.15.1.2","HIPAA 164.308(b)"] },
    { id:"CTRL-POL-01", name:"Information security policy", category:"Policy & Governance",
      description:"Management-approved policies define expectations, roles, responsibilities.",
      frameworks:["ISO 27001","NIST CSF"], references:["ISO 27001 A.5","NIST ID.GV-1"] },
    { id:"CTRL-AW-01", name:"Security awareness training", category:"Awareness & Training",
      description:"Regular training on security, privacy, phishing, reporting incidents.",
      frameworks:["ISO 27001","NIST CSF","HIPAA"], references:["ISO 27001 A.7.2.2","NIST PR.AT-1","HIPAA 164.308(a)(5)"] },
  ];

  // Simple MediCloud starter scenario
  const MEDICLOUD_SCENARIO = {
    assets: [
      { id:"AST-MEDI-WEB", name:"MediCloud Web Application", type:"Application", criticality:"High",
        owner:"Product / Engineering", dataTypes:["PHI","PII"], notes:"Patient-facing portal hosted in AWS." },
      { id:"AST-MEDI-DB", name:"MediCloud Patient DB", type:"Database", criticality:"High",
        owner:"DBA / SRE", dataTypes:["PHI","PII"], notes:"Primary PHI store (RDS)." },
      { id:"AST-MEDI-IDP", name:"IdP / SSO", type:"Cloud Service", criticality:"High",
        owner:"Security Engineering", dataTypes:["Internal data"], notes:"Used for workforce SSO + admin MFA." },
      { id:"AST-MEDI-LOGS", name:"Central Logging Platform", type:"Cloud Service", criticality:"Medium",
        owner:"SecOps", dataTypes:["Internal data"], notes:"Collects app / infra / security logs." }
    ],
    risks: [
      { id:"RSK-MEDI-001", title:"Unauthorised access to MediCloud production app",
        assetId:"AST-MEDI-WEB", assetName:"MediCloud Web Application",
        category:"Cybersecurity", likelihood:4, impact:5, score:20,
        status:"Open", owner:"CISO", notes:"MFA not enforced for all admins; legacy VPN path still enabled." },
      { id:"RSK-MEDI-002", title:"Compromise of PHI in patient database",
        assetId:"AST-MEDI-DB", assetName:"MediCloud Patient DB",
        category:"Privacy", likelihood:3, impact:5, score:15,
        status:"In progress", owner:"Data Protection Officer", notes:"Legacy backups unencrypted; DB access model complex." },
      { id:"RSK-MEDI-003", title:"Gaps in logging and incident detection",
        assetId:"AST-MEDI-LOGS", assetName:"Central Logging Platform",
        category:"Cybersecurity", likelihood:3, impact:4, score:12,
        status:"Open", owner:"SecOps Lead", notes:"Not all production systems forward logs; alert rules incomplete." }
    ],
    controls: [
      { id:"CTL-MEDI-MFA", name:"MFA enforced for workforce IdP", type:"Technical", status:"In place",
        owner:"Security Engineering", description:"All workforce users require MFA via IdP; high-risk apps tagged as conditional access.",
        linkedRiskIds:["RSK-MEDI-001"], linkedFrameworkControlIds:["CTRL-AC-03"] },
      { id:"CTL-MEDI-LOG", name:"Centralised logging for production workloads", type:"Technical", status:"In place",
        owner:"SecOps", description:"Production workloads send logs to SIEM; retention baseline 365 days.",
        linkedRiskIds:["RSK-MEDI-003"], linkedFrameworkControlIds:["CTRL-LOG-01","CTRL-LOG-02"] },
      { id:"CTL-MEDI-BACKUP", name:"Encrypted backups for PHI DB", type:"Technical", status:"Planned",
        owner:"SRE / DBA", description:"Move historic unencrypted backups to encrypted storage, enforce encryption at rest.",
        linkedRiskIds:["RSK-MEDI-002"], linkedFrameworkControlIds:["CTRL-ENC-01","CTRL-BCP-01"] }
    ],
    issues: [
      { id:"ISS-MEDI-001", title:"MFA not enforced for legacy VPN", type:"Audit", severity:"High", status:"Open",
        owner:"Network Team", dueDate:"", notes:"Legacy VPN path bypasses IdP; users can access prod without MFA.",
        assetId:"AST-MEDI-WEB", riskId:"RSK-MEDI-001", controlId:"CTL-MEDI-MFA",
        linkedSummary:"Asset: MediCloud Web Application | Risk: Unauthorised access to MediCloud production app | Control: MFA enforced for workforce IdP" },
      { id:"ISS-MEDI-002", title:"Unencrypted historical DB backups", type:"Pen test", severity:"High", status:"In progress",
        owner:"SRE / DBA", dueDate:"", notes:"Old snapshots stored without encryption; outside of new baseline.",
        assetId:"AST-MEDI-DB", riskId:"RSK-MEDI-002", controlId:"CTL-MEDI-BACKUP",
        linkedSummary:"Asset: MediCloud Patient DB | Risk: Compromise of PHI in patient database | Control: Encrypted backups for PHI DB" }
    ],
    treatments: [
      { id:"TRT-MEDI-001", title:"Decommission legacy VPN and force IdP SSO",
        riskId:"RSK-MEDI-001", riskTitle:"Unauthorised access to MediCloud production app",
        status:"In progress", owner:"Network Lead", dueDate:"", notes:"Cutover to IdP-based access only; update runbooks." },
      { id:"TRT-MEDI-002", title:"Encrypt all historical PHI backups",
        riskId:"RSK-MEDI-002", riskTitle:"Compromise of PHI in patient database",
        status:"Open", owner:"SRE / DBA", dueDate:"", notes:"Locate all snapshots, move to encrypted storage; document control." },
      { id:"TRT-MEDI-003", title:"Onboard remaining prod systems to SIEM",
        riskId:"RSK-MEDI-003", riskTitle:"Gaps in logging and incident detection",
        status:"Open", owner:"SecOps Lead", dueDate:"", notes:"Prioritise internet-facing components; add alert rules for auth failures." }
    ]
  };

  // ============ STORAGE ============
  const K = {
    assets: 'grc_assets_v1',
    risks: 'grc_risks_v1',
    controls: 'grc_controls_v1',
    issues: 'grc_issues_v1',
    treatments: 'grc_treatments_v1'
  };

  const load = key => {
    try { const v = JSON.parse(localStorage.getItem(key)); return Array.isArray(v) ? v : []; }
    catch { return []; }
  };
  const save = (key, val) => { localStorage.setItem(key, JSON.stringify(val)); };

  let assets = load(K.assets);
  let risks = load(K.risks);
  let controls = load(K.controls);
  let issues = load(K.issues);
  let treatments = load(K.treatments);

  // ============ HELPERS ============
  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  const getMulti = sel => {
    const v = []; if (!sel) return v;
    Array.from(sel.options).forEach(o => { if (o.selected && o.value) v.push(o.value); });
    return v;
  };
  const setMulti = (sel, values) => {
    if (!sel) return; const S = new Set(values||[]);
    Array.from(sel.options).forEach(o => o.selected = S.has(o.value));
  };

  // ============ FRAMEWORK RENDER ============
  function renderFrameworkControls(){
    const tbody = qs('#frameworks-table-body');
    const countEl = qs('#frameworks-count');
    const f = qs('#framework-filter').value;
    const c = qs('#category-filter').value;
    const s = qs('#framework-search').value.trim().toLowerCase();

    const filtered = FRAMEWORK_CONTROLS.filter(x=>{
      const okF = f==='all' || x.frameworks.includes(f);
      const okC = c==='all' || x.category===c;
      const okS = !s || x.name.toLowerCase().includes(s) || x.description.toLowerCase().includes(s) || x.id.toLowerCase().includes(s);
      return okF && okC && okS;
    });

    tbody.innerHTML = '';
    filtered.forEach(x=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.id}</td><td>${x.name}</td><td>${x.category}</td>
        <td>${x.references.join('<br>')}</td><td>${x.description}</td>`;
      tbody.appendChild(tr);
    });
    countEl.textContent = `${filtered.length} control(s) shown of ${FRAMEWORK_CONTROLS.length}`;
  }

  // ============ ASSETS ============
  function selectedDataTypes(){ return qsa('.asset-dt').filter(cb=>cb.checked).map(cb=>cb.value); }
  function setDataTypes(values){ qsa('.asset-dt').forEach(cb => cb.checked = (values||[]).includes(cb.value)); }

  function populateRiskAssetOptions(){
    const sel = qs('#risk-asset'); if(!sel) return;
    const cur = sel.value; sel.innerHTML = '<option value="">Select asset...</option>';
    assets.forEach(a=>{ const o=document.createElement('option'); o.value=a.id; o.textContent=a.name; sel.appendChild(o); });
    if(cur && assets.some(a=>a.id===cur)) sel.value = cur;
  }
  function populateIssueDropdowns(){
    const aSel = qs('#issue-asset'), rSel = qs('#issue-risk'), cSel = qs('#issue-control');
    if(aSel){
      const cur=aSel.value; aSel.innerHTML='<option value="">Linked asset...</option>';
      assets.forEach(a=>{const o=document.createElement('option');o.value=a.id;o.textContent=a.name;aSel.appendChild(o);});
      if(cur&&assets.some(a=>a.id===cur)) aSel.value=cur;
    }
    if(rSel){
      const cur=rSel.value; rSel.innerHTML='<option value="">Linked risk...</option>';
      risks.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.title;rSel.appendChild(o);});
      if(cur&&risks.some(r=>r.id===cur)) rSel.value=cur;
    }
    if(cSel){
      const cur=cSel.value; cSel.innerHTML='<option value="">Linked control...</option>';
      controls.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;cSel.appendChild(o);});
      if(cur&&controls.some(c=>c.id===cur)) cSel.value=cur;
    }
  }
  function populateTreatmentRiskOptions(){
    const sel = qs('#treatment-risk'); if(!sel) return;
    const cur = sel.value; sel.innerHTML = '<option value="">Select risk...</option>';
    risks.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.title; sel.appendChild(o); });
    if(cur && risks.some(r=>r.id===cur)) sel.value=cur;
  }

  function renderAssetsTable(){
    const tbody = qs('#assets-table-body'), empty = qs('#assets-empty'), count = qs('#assets-count');
    tbody.innerHTML='';
    assets.forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.name}</td><td>${a.type}</td><td>${a.criticality}</td>
        <td>${(a.dataTypes||[]).join(', ')}</td><td>${a.owner||''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ae="${a.id}">Edit</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-ad="${a.id}">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = assets.length ? 'none':'block';
    count.textContent = `${assets.length} asset(s)`;
    populateRiskAssetOptions();
    populateIssueDropdowns();
    renderDashboard();
  }

  function resetAssetForm(){
    qs('#asset-form').reset(); qs('#asset-id').value=''; qs('#asset-form-submit').textContent='Save asset';
  }

  // ============ RISKS ============
  const rScore = (l,i)=> (Number(l)||0) * (Number(i)||0);
  const rLevel = s => s>=15?'High': s>=6?'Medium': s>0?'Low':'-';

  function resetRiskForm(){ qs('#risk-form').reset(); qs('#risk-id').value=''; qs('#risk-form-submit').textContent='Save risk'; }

  function populateControlRisks(){
    const sel=qs('#control-risks'); if(!sel) return;
    const cur=getMulti(sel);
    sel.innerHTML=''; risks.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.title; sel.appendChild(o); });
    setMulti(sel, cur);
  }

  function renderRisksTable(){
    const tbody = qs('#risks-table-body'), empty=qs('#risks-empty'), count=qs('#risks-count');
    tbody.innerHTML='';
    risks.forEach(r=>{
      const level=rLevel(r.score), cls = level==='High'?'badge-danger': level==='Medium'?'badge-warning': level==='Low'?'badge-success':'';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.title}</td><td>${r.assetName||''}</td><td>${r.category}</td>
        <td>${r.score?`<span class="badge ${cls} mr-1">${r.score}</span><span class="text-muted small">${level}</span>`:'-'}</td>
        <td>${r.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-re="${r.id}">Edit</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-rd="${r.id}">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = risks.length?'none':'block';
    count.textContent = `${risks.length} risk(s)`;
    populateControlRisks(); populateIssueDropdowns(); populateTreatmentRiskOptions(); renderDashboard();
  }

  // ============ CONTROLS ============
  function populateControlFrameworks(){
    const sel = qs('#control-frameworks'); if(!sel) return;
    sel.innerHTML=''; FRAMEWORK_CONTROLS.forEach(fc=>{ const o=document.createElement('option'); o.value=fc.id; o.textContent=`${fc.id} – ${fc.name}`; sel.appendChild(o); });
  }
  function resetControlForm(){ qs('#control-form').reset(); qs('#control-id').value=''; qs('#control-form-submit').textContent='Save control'; }

  function renderControlsTable(){
    const tbody=qs('#controls-table-body'), empty=qs('#controls-empty'), count=qs('#controls-count');
    tbody.innerHTML='';
    controls.forEach(c=>{
      const rc=(c.linkedRiskIds||[]).length, fw=(c.linkedFrameworkControlIds||[]).length;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${c.name}</td><td>${c.type}</td><td>${c.status}</td>
        <td>${rc?rc+' linked':'-'}</td><td>${fw?fw+' mapped':'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ce="${c.id}">Edit</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-cd="${c.id}">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = controls.length?'none':'block';
    count.textContent = `${controls.length} control(s)`;
    populateIssueDropdowns(); renderGapTable(); renderDashboard();
  }

  // ============ ISSUES ============
  function resetIssueForm(){ qs('#issue-form').reset(); qs('#issue-id').value=''; qs('#issue-form-submit').textContent='Save issue'; }

  function renderIssuesTable(){
    const tbody = qs('#issues-table-body'), empty=qs('#issues-empty'), count=qs('#issues-count');
    tbody.innerHTML='';
    issues.forEach(i=>{
      const sev=i.severity||'', cls = sev==='Critical'||sev==='High'?'badge-danger': sev==='Medium'?'badge-warning':'badge-success';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i.title}</td><td>${i.type}</td><td>${sev?`<span class="badge ${cls}">${sev}</span>`:'-'}</td>
        <td>${i.status}</td><td>${i.linkedSummary||'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-ie="${i.id}">Edit</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-id="${i.id}">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = issues.length?'none':'block';
    count.textContent = `${issues.length} issue(s)`;
    renderDashboard();
  }

  // ============ TREATMENTS ============
  function resetTreatmentForm(){
    qs('#treatment-form').reset();
    qs('#treatment-id').value='';
    qs('#treatment-form-submit').textContent='Save action';
  }

  function renderTreatmentsTable(){
    const tbody = qs('#treatments-table-body'),
          empty = qs('#treatments-empty'),
          count = qs('#treatments-count');
    tbody.innerHTML='';
    treatments.forEach(t=>{
      const tr=document.createElement('tr');
      const status = t.status || 'Open';
      const cls = status==='Completed'?'badge-success':
                  status==='In progress'?'badge-warning':
                  status==='Accepted'?'badge-secondary':'badge-primary';
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${t.riskTitle || ''}</td>
        <td><span class="badge ${cls}">${status}</span></td>
        <td>${t.dueDate || '-'}</td>
        <td>${t.owner || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light mb-1" data-te="${t.id}">Edit</button>
          <button class="btn btn-sm btn-outline-light mb-1" data-td="${t.id}">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
    empty.style.display = treatments.length ? 'none' : 'block';
    count.textContent = `${treatments.length} action(s)`;
    renderDashboard();
  }

  // If a risk is deleted, detach from treatments
  function detachRiskFromTreatments(riskId){
    let changed=false;
    treatments.forEach(t=>{
      if(t.riskId===riskId){
        t.riskId='';
        t.riskTitle='(risk deleted)';
        changed=true;
      }
    });
    if(changed){ save(K.treatments, treatments); renderTreatmentsTable(); }
  }

  // ============ GAP ANALYSIS ============
  const heatClass = p => p>=80?'heat-good': p>=50?'heat-medium': p>0?'heat-low':'heat-none';

  function computeGapRows(){
    const byCat = new Map();
    FRAMEWORK_CONTROLS.forEach(fc=>{
      if(!byCat.has(fc.category)) byCat.set(fc.category, {category:fc.category,total:0,implemented:0,plannedOnly:0,notImplemented:0});
      const row = byCat.get(fc.category); row.total += 1;
      const linked = controls.filter(c=>Array.isArray(c.linkedFrameworkControlIds) && c.linkedFrameworkControlIds.includes(fc.id));
      if(linked.length===0){ row.notImplemented += 1; return; }
      const hasInPlace = linked.some(c=>c.status==='In place');
      const hasPlanned = linked.some(c=>c.status==='Planned');
      if(hasInPlace) row.implemented += 1;
      else if(hasPlanned) row.plannedOnly += 1;
      else row.notImplemented += 1;
    });
    return Array.from(byCat.values()).sort((a,b)=>a.category.localeCompare(b.category));
  }
  function overallCoverage(rows){
    let total=0, imp=0; rows.forEach(r=>{ total+=r.total; imp+=r.implemented; });
    return total? Math.round((imp/total)*100): 0;
  }
  function renderGapTable(){
    const tbody=qs('#gap-table-body'), overall=qs('#gap-overall-coverage');
    const rows = computeGapRows(); tbody.innerHTML='';
    rows.forEach(r=>{
      const pct = r.total? Math.round((r.implemented/r.total)*100):0;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.category}</td><td>${r.total}</td><td>${r.implemented} / ${r.total}</td>
        <td>${r.plannedOnly} / ${r.total}</td><td>${r.notImplemented} / ${r.total}</td>
        <td class="heat-cell ${heatClass(pct)}">${pct}%<small>${r.implemented} of ${r.total} control(s) implemented</small></td>`;
      tbody.appendChild(tr);
    });
    const ov = overallCoverage(rows);
    overall.textContent = rows.length
      ? `Overall implemented coverage: ${ov}% of ${FRAMEWORK_CONTROLS.length} framework control(s).`
      : 'Add local controls and map them to framework controls to see coverage.';
    updateCoveragePill(ov);
  }

  // ============ DASHBOARD ============
  function updateCoveragePill(p){
    const pill = qs('#dash-coverage-pill');
    pill.classList.remove('heat-good','heat-medium','heat-low','heat-none');
    pill.classList.add(heatClass(p));
    pill.textContent = p>=80?'Strong coverage': p>=50?'Moderate coverage': p>0?'Limited coverage':'No implemented coverage yet';
  }

  function renderDashboard(){
    qs('#dash-assets').textContent   = assets.length;
    qs('#dash-risks').textContent    = risks.length;
    qs('#dash-controls').textContent = controls.length;
    qs('#dash-issues').textContent   = issues.length;

    const high = risks.filter(r=>rLevel(r.score)==='High').length;
    qs('#dash-high').textContent = high;

    const today = new Date();
    const overdue = issues.filter(i=>{
      if(!i.dueDate) return false; const d=new Date(i.dueDate); if(isNaN(d)) return false;
      const st=i.status||''; return st!=='Resolved' && st!=='Accepted' && d<today;
    }).length;
    qs('#dash-overdue').textContent = overdue;

    const openActions = treatments.filter(t=>t.status==='Open' || t.status==='In progress').length;
    qs('#dash-open-actions').textContent = openActions;

    const ov = overallCoverage(computeGapRows());
    qs('#dash-coverage').textContent = ov+'%';
    updateCoveragePill(ov);
  }

  // ============ RISK MATRIX ============
  let showResidual = false;
  const canvas = document.createElement('canvas');
  // We'll re-select once DOM is ready

  function residualForRisk(r){
    const impl = controls.filter(c => c.status==='In place' && (c.linkedRiskIds||[]).includes(r.id));
    const dropL = Math.min(2, impl.length);
    const dropI = impl.some(c=>c.type==='Preventive' || c.type==='Corrective') ? 1 : 0;
    return {
      likelihood: Math.max(1, (r.likelihood||1) - dropL),
      impact: Math.max(1, (r.impact||1) - dropI)
    };
  }

  function drawMatrix(){
    const c = qs('#risk-matrix-canvas'); if(!c) return;
    const ctx = c.getContext('2d');
    const legend = qs('#matrix-legend');
    ctx.clearRect(0,0,c.width,c.height);
    const size=110, off=90;

    ctx.strokeStyle="#2b3138"; ctx.lineWidth=1;
    for(let i=0;i<=5;i++){
      ctx.beginPath(); ctx.moveTo(off, off + i*size); ctx.lineTo(off+5*size, off+i*size); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(off + i*size, off); ctx.lineTo(off + i*size, off+5*size); ctx.stroke();
    }
    ctx.font="14px Poppins"; ctx.fillStyle="#aab2bd"; ctx.fillText("Impact →", off+225, off-25);
    ctx.save(); ctx.translate(off-55, off+240); ctx.rotate(-Math.PI/2); ctx.fillText("Likelihood →", 0,0); ctx.restore();

    let high=0, med=0, low=0;
    risks.forEach(r=>{
      let L=r.likelihood, I=r.impact;
      if(showResidual){ const res = residualForRisk(r); L=res.likelihood; I=res.impact; }
      const score = rScore(L,I);
      let color = "#27ae60";
      if(score>=15){ color="#e63946"; high++; }
      else if(score>=6){ color="#f1c40f"; med++; }
      else low++;

      ctx.beginPath();
      ctx.arc(off + (I-0.5)*size, off + (5-L+0.5)*size, 12, 0, 2*Math.PI);
      ctx.fillStyle=color; ctx.fill();
      ctx.fillStyle="#0c0f12"; ctx.font="bold 12px Poppins"; ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(String(score), off + (I-0.5)*size, off + (5-L+0.5)*size);
    });

    legend.innerHTML = `<b>${risks.length}</b> risks &nbsp;—&nbsp; 
      <span style="color:#e63946">High: ${high}</span> &nbsp;|&nbsp;
      <span style="color:#f1c40f">Medium: ${med}</span> &nbsp;|&nbsp;
      <span style="color:#27ae60">Low: ${low}</span>`;
  }

  // ============ AUDITOR SUMMARY ============
  function buildAuditorSummary(){
    const lines = [];
    lines.push("1. Scope and context");
    lines.push(`- The organisation is using the GRC Practice Lab to model ${assets.length || 'no'} key information assets and services.`);
    if(assets.length){
      const critical = assets.filter(a=>a.criticality==='High').map(a=>a.name);
      if(critical.length) lines.push(`- High criticality assets include: ${critical.join(', ')}.`);
    }

    const highRisks = risks.filter(r=>rLevel(r.score)==='High');
    const medRisks  = risks.filter(r=>rLevel(r.score)==='Medium');

    lines.push("");
    lines.push("2. Risk posture");
    lines.push(`- Total documented risks: ${risks.length}.`);
    lines.push(`- High risks: ${highRisks.length}; Medium risks: ${medRisks.length}.`);
    if(highRisks.length){
      lines.push("- Example high risks:");
      highRisks.slice(0,3).forEach(r=>{
        lines.push(`  • ${r.title} (asset: ${r.assetName || 'n/a'}, score: ${r.score}).`);
      });
    }

    lines.push("");
    lines.push("3. Control environment and framework coverage");
    lines.push(`- Local controls defined: ${controls.length}.`);
    const rows = computeGapRows();
    const cov  = overallCoverage(rows);
    lines.push(`- Overall implemented framework coverage: ${cov}% of ${FRAMEWORK_CONTROLS.length} paraphrased framework controls.`);
    if(rows.length){
      lines.push("- Coverage by category:");
      rows.forEach(r=>{
        const pct = r.total ? Math.round((r.implemented/r.total)*100) : 0;
        lines.push(`  • ${r.category}: ${pct}% implemented (${r.implemented}/${r.total}).`);
      });
    }

    lines.push("");
    lines.push("4. Issues, findings and action plans");
    const openIssues = issues.filter(i=>i.status==='Open' || i.status==='In progress');
    const highIssues = issues.filter(i=>i.severity==='High' || i.severity==='Critical');
    const openActions = treatments.filter(t=>t.status==='Open' || t.status==='In progress');
    lines.push(`- Open / in-progress issues: ${openIssues.length} (of ${issues.length} total).`);
    lines.push(`- High/Critical issues: ${highIssues.length}.`);
    lines.push(`- Open / in-progress treatment actions: ${openActions.length} (of ${treatments.length} total action items).`);

    if(openActions.length){
      lines.push("- Sample actions:");
      openActions.slice(0,3).forEach(t=>{
        lines.push(`  • ${t.title} (risk: ${t.riskTitle || 'n/a'}, status: ${t.status}, owner: ${t.owner || 'n/a'}).`);
      });
    }

    lines.push("");
    lines.push("5. Overall observation");
    if(!risks.length && !controls.length){
      lines.push("- The environment is at a very early stage: no risks or controls have been modelled yet.");
    } else if(highRisks.length && openActions.length === 0){
      lines.push("- Several high risks have been identified; however, there are currently no treatment actions logged against them.");
    } else {
      lines.push("- A basic but structured risk and control environment is in place, with active remediation tracked via treatment actions.");
    }

    return lines.join("\\n");
  }

  function renderAuditorSummary(){
    const ta = qs('#auditor-summary-text');
    if(!ta) return;
    ta.value = buildAuditorSummary();
  }

  // ============ SCENARIO EXPORT/IMPORT ============
  function setImportStatus(msg, err){ const el=qs('#import-status'); el.textContent=msg||''; el.style.color=err?'#fca5a5':'#9ca3af'; }
  function exportScenario(){
    const payload = {
      version:2,
      exportedAt:new Date().toISOString(),
      assets, risks, controls, issues, treatments
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`grc-lab-scenario-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url); setImportStatus('Exported current data as JSON.', false);
  }
  function importScenarioFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        assets     = Array.isArray(data.assets)? data.assets: [];
        risks      = Array.isArray(data.risks)? data.risks: [];
        controls   = Array.isArray(data.controls)? data.controls: [];
        issues     = Array.isArray(data.issues)? data.issues: [];
        treatments = Array.isArray(data.treatments)? data.treatments: [];
        save(K.assets, assets); save(K.risks, risks); save(K.controls, controls); save(K.issues, issues); save(K.treatments, treatments);
        refreshAll();
        setImportStatus(`Imported scenario: ${assets.length} assets, ${risks.length} risks, ${controls.length} controls, ${issues.length} issues, ${treatments.length} treatments.`, false);
      }catch(err){ console.error(err); setImportStatus('Failed to import scenario. Check JSON file.', true); }
    };
    reader.onerror = ()=> setImportStatus('Failed to read file.', true);
    reader.readAsText(file);
  }
  function resetLab(){
    if(!confirm('This will clear all assets, risks, controls, treatments and issues in this browser. Continue?')) return;
    assets=[]; risks=[]; controls=[]; issues=[]; treatments=[];
    localStorage.removeItem(K.assets); localStorage.removeItem(K.risks);
    localStorage.removeItem(K.controls); localStorage.removeItem(K.issues); localStorage.removeItem(K.treatments);
    refreshAll(); setImportStatus('Lab reset: all data cleared from this browser.', false);
  }

  function loadMediCloudScenario(){
    if(!confirm('This will replace your current lab data with the MediCloud demo scenario. Continue?')) return;
    assets     = JSON.parse(JSON.stringify(MEDICLOUD_SCENARIO.assets));
    risks      = JSON.parse(JSON.stringify(MEDICLOUD_SCENARIO.risks));
    controls   = JSON.parse(JSON.stringify(MEDICLOUD_SCENARIO.controls));
    issues     = JSON.parse(JSON.stringify(MEDICLOUD_SCENARIO.issues));
    treatments = JSON.parse(JSON.stringify(MEDICLOUD_SCENARIO.treatments));
    save(K.assets, assets); save(K.risks, risks); save(K.controls, controls); save(K.issues, issues); save(K.treatments, treatments);
    refreshAll();
    setImportStatus('Loaded MediCloud demo scenario into this browser.', false);
  }

  // ============ TABS ============
  function bindTabs(){
    const buttons = qsa('[data-grc-tab]');
    const mapping = {};
    ['frameworks','assets','risks','controls','issues','treatments','gap','dashboard','matrix','auditor']
      .forEach(id => mapping[id]=qs('#tab-'+id));
    buttons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tgt = btn.getAttribute('data-grc-tab');
        buttons.forEach(b=>{ b.classList.remove('btn-primary'); b.classList.add('btn-outline-light'); });
        btn.classList.add('btn-primary'); btn.classList.remove('btn-outline-light');
        Object.values(mapping).forEach(el=>el && el.classList.remove('active'));
        if(mapping[tgt]) mapping[tgt].classList.add('active');
        if(tgt==='dashboard'){ renderDashboard(); }
        if(tgt==='gap'){ renderGapTable(); }
        if(tgt==='matrix'){ drawMatrix(); }
        if(tgt==='auditor'){ renderAuditorSummary(); }
      });
    });
  }

  // ============ REFRESH ============
  function refreshAll(){
    renderFrameworkControls();
    renderAssetsTable(); populateRiskAssetOptions();
    renderRisksTable(); populateControlRisks();
    populateControlFrameworks(); renderControlsTable();
    populateIssueDropdowns(); renderIssuesTable();
    populateTreatmentRiskOptions(); renderTreatmentsTable();
    renderGapTable(); renderDashboard(); drawMatrix(); renderAuditorSummary();
  }

  // ============ INIT ============
  document.addEventListener('DOMContentLoaded', ()=>{
    ['#framework-filter','#category-filter','#framework-search'].forEach(sel=>{
      const el = qs(sel); if(el){ el.addEventListener(sel==='#framework-search'?'input':'change', renderFrameworkControls); }
    });

    // Assets
    qs('#asset-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = qs('#asset-id').value;
      const name = qs('#asset-name').value.trim();
      const type = qs('#asset-type').value; const criticality = qs('#asset-criticality').value;
      if(!name || !type || !criticality) return alert('Fill name, type, criticality.');
      const obj = {
        id: id || ('AST-'+Date.now()),
        name, type, criticality,
        owner: qs('#asset-owner').value.trim(),
        dataTypes: selectedDataTypes(),
        notes: qs('#asset-notes').value.trim()
      };
      const idx = assets.findIndex(x=>x.id===obj.id);
      if(idx>-1) assets[idx]=obj; else assets.push(obj);
      save(K.assets, assets); renderAssetsTable(); resetAssetForm();
    });
    qs('#asset-form-cancel').addEventListener('click', resetAssetForm);
    qs('#assets-table-body').addEventListener('click', e=>{
      const idE = e.target.getAttribute('data-ae'); const idD = e.target.getAttribute('data-ad');
      if(idE){
        const a = assets.find(x=>x.id===idE); if(!a) return;
        qs('#asset-id').value=a.id; qs('#asset-name').value=a.name; qs('#asset-type').value=a.type;
        qs('#asset-criticality').value=a.criticality; qs('#asset-owner').value=a.owner||'';
        qs('#asset-notes').value=a.notes||''; setDataTypes(a.dataTypes||[]);
        qs('#asset-form-submit').textContent='Update asset';
      }
      if(idD){
        if(!confirm('Delete this asset?')) return;
        assets = assets.filter(x=>x.id!==idD); save(K.assets, assets); renderAssetsTable();
      }
    });

    // Risks
    qs('#risk-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = qs('#risk-id').value;
      const title = qs('#risk-title').value.trim();
      const assetId = qs('#risk-asset').value;
      const asset = assets.find(a=>a.id===assetId);
      const category = qs('#risk-category').value;
      const likelihood = Number(qs('#risk-likelihood').value);
      const impact = Number(qs('#risk-impact').value);
      const status = qs('#risk-status').value;
      if(!title || !assetId || !category || !likelihood || !impact || !status) return alert('Fill all required fields.');
      const obj = {
        id: id || ('RSK-'+Date.now()),
        title, assetId, assetName: asset?asset.name:'',
        category, likelihood, impact, score: rScore(likelihood, impact),
        status, owner: qs('#risk-owner').value.trim(), notes: qs('#risk-notes').value.trim()
      };
      const idx = risks.findIndex(x=>x.id===obj.id);
      if(idx>-1) risks[idx]=obj; else risks.push(obj);
      save(K.risks, risks); renderRisksTable(); resetRiskForm();
    });
    qs('#risk-form-cancel').addEventListener('click', resetRiskForm);
    qs('#risks-table-body').addEventListener('click', e=>{
      const idE = e.target.getAttribute('data-re'); const idD = e.target.getAttribute('data-rd');
      if(idE){
        const r = risks.find(x=>x.id===idE); if(!r) return;
        qs('#risk-id').value=r.id; qs('#risk-title').value=r.title;
        qs('#risk-asset').value=r.assetId; qs('#risk-category').value=r.category;
        qs('#risk-likelihood').value=String(r.likelihood); qs('#risk-impact').value=String(r.impact);
        qs('#risk-owner').value=r.owner||''; qs('#risk-status').value=r.status||'Open'; qs('#risk-notes').value=r.notes||'';
        qs('#risk-form-submit').textContent='Update risk';
      }
      if(idD){
        if(!confirm('Delete this risk?')) return;
        risks = risks.filter(x=>x.id!==idD); save(K.risks, risks);
        // remove from linked control arrays
        let changed=false;
        controls.forEach(c=>{
          if(Array.isArray(c.linkedRiskIds) && c.linkedRiskIds.includes(idD)){
            c.linkedRiskIds = c.linkedRiskIds.filter(z=>z!==idD); changed=true;
          }
        });
        if(changed){ save(K.controls, controls); renderControlsTable(); }
        // unlink from issues
        issues.forEach(i=>{ if(i.riskId===idD){ i.riskId=''; i.linkedSummary=(i.linkedSummary||'').replace(/ *\| *Risk: [^|]+/,''); }});
        save(K.issues, issues); renderIssuesTable();
        detachRiskFromTreatments(idD);
        renderRisksTable();
      }
    });

    // Controls
    qs('#control-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = qs('#control-id').value;
      const name = qs('#control-name').value.trim();
      const type = qs('#control-type').value;
      const status = qs('#control-status').value;
      if(!name || !type || !status) return alert('Fill control name, type, status.');
      const obj = {
        id: id || ('CTL-'+Date.now()),
        name, type, status,
        owner: qs('#control-owner').value.trim(),
        description: qs('#control-description').value.trim(),
        linkedRiskIds: getMulti(qs('#control-risks')),
        linkedFrameworkControlIds: getMulti(qs('#control-frameworks'))
      };
      const idx = controls.findIndex(x=>x.id===obj.id);
      if(idx>-1) controls[idx]=obj; else controls.push(obj);
      save(K.controls, controls); renderControlsTable(); resetControlForm();
    });
    qs('#control-form-cancel').addEventListener('click', resetControlForm);
    qs('#controls-table-body').addEventListener('click', e=>{
      const idE = e.target.getAttribute('data-ce'); const idD = e.target.getAttribute('data-cd');
      if(idE){
        const c = controls.find(x=>x.id===idE); if(!c) return;
        qs('#control-id').value=c.id; qs('#control-name').value=c.name; qs('#control-type').value=c.type;
        qs('#control-status').value=c.status; qs('#control-owner').value=c.owner||'';
        qs('#control-description').value=c.description||'';
        setMulti(qs('#control-risks'), c.linkedRiskIds||[]); setMulti(qs('#control-frameworks'), c.linkedFrameworkControlIds||[]);
        qs('#control-form-submit').textContent='Update control';
      }
      if(idD){
        if(!confirm('Delete this control?')) return;
        controls = controls.filter(x=>x.id!==idD); save(K.controls, controls); renderControlsTable();
      }
    });

    // Issues
    qs('#issue-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = qs('#issue-id').value;
      const title = qs('#issue-title').value.trim();
      const type = qs('#issue-type').value;
      const severity = qs('#issue-severity').value;
      const status = qs('#issue-status').value;
      if(!title || !type || !severity || !status) return alert('Fill title, type, severity, status.');
      const assetId = qs('#issue-asset').value || '';
      const riskId  = qs('#issue-risk').value || '';
      const controlId = qs('#issue-control').value || '';
      const a = assets.find(x=>x.id===assetId), r=risks.find(x=>x.id===riskId), c=controls.find(x=>x.id===controlId);
      const linkedSummary = [a?`Asset: ${a.name}`:'', r?`Risk: ${r.title}`:'', c?`Control: ${c.name}`:''].filter(Boolean).join(' | ');
      const obj = {
        id: id || ('ISS-'+Date.now()),
        title, type, severity, status,
        owner: qs('#issue-owner').value.trim(),
        dueDate: qs('#issue-due').value, notes: qs('#issue-notes').value.trim(),
        assetId, riskId, controlId, linkedSummary
      };
      const idx = issues.findIndex(x=>x.id===obj.id);
      if(idx>-1) issues[idx]=obj; else issues.push(obj);
      save(K.issues, issues); renderIssuesTable(); resetIssueForm();
    });
    qs('#issue-form-cancel').addEventListener('click', resetIssueForm);
    qs('#issues-table-body').addEventListener('click', e=>{
      const idE = e.target.getAttribute('data-ie'); const idD = e.target.getAttribute('data-id');
      if(idE){
        const i = issues.find(x=>x.id===idE); if(!i) return;
        qs('#issue-id').value=i.id; qs('#issue-title').value=i.title; qs('#issue-type').value=i.type;
        qs('#issue-severity').value=i.severity; qs('#issue-status').value=i.status;
        qs('#issue-owner').value=i.owner||''; qs('#issue-due').value=i.dueDate||''; qs('#issue-notes').value=i.notes||'';
        populateIssueDropdowns();
        qs('#issue-asset').value=i.assetId||''; qs('#issue-risk').value=i.riskId||''; qs('#issue-control').value=i.controlId||'';
        qs('#issue-form-submit').textContent='Update issue';
      }
      if(idD){
        if(!confirm('Delete this issue?')) return;
        issues = issues.filter(x=>x.id!==idD); save(K.issues, issues); renderIssuesTable();
      }
    });

    // Treatments
    qs('#treatment-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = qs('#treatment-id').value;
      const title = qs('#treatment-title').value.trim();
      const riskId = qs('#treatment-risk').value;
      const status = qs('#treatment-status').value;
      if(!title || !riskId || !status) return alert('Fill title, risk and status.');
      const risk = risks.find(r=>r.id===riskId);
      const obj = {
        id: id || ('TRT-'+Date.now()),
        title,
        riskId,
        riskTitle: risk ? risk.title : '',
        status,
        owner: qs('#treatment-owner').value.trim(),
        dueDate: qs('#treatment-due').value,
        notes: qs('#treatment-notes').value.trim()
      };
      const idx = treatments.findIndex(x=>x.id===obj.id);
      if(idx>-1) treatments[idx]=obj; else treatments.push(obj);
      save(K.treatments, treatments); renderTreatmentsTable(); resetTreatmentForm();
    });
    qs('#treatment-form-cancel').addEventListener('click', resetTreatmentForm);
    qs('#treatments-table-body').addEventListener('click', e=>{
      const idE = e.target.getAttribute('data-te'); const idD = e.target.getAttribute('data-td');
      if(idE){
        const t = treatments.find(x=>x.id===idE); if(!t) return;
        qs('#treatment-id').value=t.id;
        qs('#treatment-title').value=t.title;
        populateTreatmentRiskOptions();
        qs('#treatment-risk').value=t.riskId || '';
        qs('#treatment-status').value=t.status || 'Open';
        qs('#treatment-owner').value=t.owner || '';
        qs('#treatment-due').value=t.dueDate || '';
        qs('#treatment-notes').value=t.notes || '';
        qs('#treatment-form-submit').textContent='Update action';
      }
      if(idD){
        if(!confirm('Delete this action?')) return;
        treatments = treatments.filter(x=>x.id!==idD);
        save(K.treatments, treatments); renderTreatmentsTable();
      }
    });

    // Export / import / reset / MediCloud
    qs('#btn-export').addEventListener('click', exportScenario);
    qs('#btn-import').addEventListener('click', ()=>{ setImportStatus('',false); const f=qs('#file-import'); f.value=''; f.click(); });
    qs('#file-import').addEventListener('change', e=>{ const file = e.target.files && e.target.files[0]; if(file) importScenarioFile(file); });
    qs('#btn-reset').addEventListener('click', resetLab);
    qs('#btn-medicloud').addEventListener('click', loadMediCloudScenario);

    // Matrix toggle + export
    qs('#toggle-inherent').addEventListener('click', ()=>{ showResidual=false; qs('#toggle-inherent').classList.add('btn-primary'); qs('#toggle-residual').classList.remove('btn-primary'); drawMatrix(); });
    qs('#toggle-residual').addEventListener('click', ()=>{ showResidual=true;  qs('#toggle-residual').classList.add('btn-primary');  qs('#toggle-inherent').classList.remove('btn-primary'); drawMatrix(); });
    qs('#matrix-export').addEventListener('click', ()=>{ const c=qs('#risk-matrix-canvas'); const a=document.createElement('a'); a.download='risk_matrix.png'; a.href=c.toDataURL('image/png'); a.click(); });

    // Auditor refresh
    qs('#btn-refresh-auditor').addEventListener('click', renderAuditorSummary);

    bindTabs();
    populateControlFrameworks();
    populateControlRisks();
    populateRiskAssetOptions();
    populateIssueDropdowns();
    populateTreatmentRiskOptions();
    refreshAll();
  });
  </script>
</body>
</html>
