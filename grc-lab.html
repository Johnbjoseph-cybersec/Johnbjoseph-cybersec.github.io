
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GRC Made Simple - Practice Lab | Build Real GRC Skills</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
:root {
    --bg-base: #f8fafc;
    --bg-surface: #ffffff;
    --bg-elevated: #f1f5f9;
    --bg-hover: #e2e8f0;
    --border-subtle: rgba(0,0,0,0.06);
    --border-default: rgba(0,0,0,0.1);
    --border-strong: rgba(0,0,0,0.15);
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #64748b;
    --accent-blue: #2563eb;
    --accent-blue-soft: rgba(37,99,235,0.12);
    --accent-green: #16a34a;
    --accent-green-soft: rgba(22,163,74,0.12);
    --accent-amber: #d97706;
    --accent-amber-soft: rgba(217,119,6,0.12);
    --accent-red: #dc2626;
    --accent-red-soft: rgba(220,38,38,0.12);
    --accent-purple: #9333ea;
    --accent-purple-soft: rgba(147,51,234,0.12);
    --accent-cyan: #0891b2;
    --accent-cyan-soft: rgba(8,145,178,0.12);
    --accent-pink: #db2777;
    --accent-pink-soft: rgba(219,39,119,0.12);
    --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    --gradient-green: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    --gradient-purple: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
    --gradient-mesh: radial-gradient(at 40% 20%, rgba(59,130,246,0.08) 0px, transparent 50%),
                     radial-gradient(at 80% 0%, rgba(168,85,247,0.06) 0px, transparent 50%),
                     radial-gradient(at 0% 50%, rgba(34,197,94,0.05) 0px, transparent 50%);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
    --shadow-glow-blue: 0 0 40px rgba(59,130,246,0.15);
    --shadow-glow-green: 0 0 40px rgba(34,197,94,0.15);
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-full: 9999px;
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-mono: 'SF Mono', 'Fira Code', monospace;
    --transition-fast: 0.15s ease;
    --transition-normal: 0.2s ease;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: var(--font-sans);
    background: var(--bg-base);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}
.app-container { display: flex; min-height: 100vh; }
.sidebar {
    width: 260px;
    background: var(--bg-surface);
    border-right: 1px solid var(--border-default);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
}
.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-default);
}
.logo-container { display: flex; align-items: center; gap: 12px; }
.logo-icon {
    width: 40px; height: 40px;
    background: var(--gradient-blue);
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: var(--shadow-glow-blue);
}
.logo-text { font-size: 18px; font-weight: 700; }
.logo-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--accent-purple-soft);
    color: var(--accent-purple);
    border-radius: var(--radius-full);
    font-weight: 600;
    margin-left: auto;
}
.sidebar-nav { flex: 1; overflow-y: auto; padding: 12px; }
.nav-section { margin-bottom: 16px; }
.nav-section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    padding: 8px 12px;
}
.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}
.nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
.nav-item.active {
    background: var(--accent-blue-soft);
    color: var(--accent-blue);
}
.nav-item.active::before {
    content: '';
    position: absolute;
    left: 0; top: 50%;
    transform: translateY(-50%);
    width: 3px; height: 20px;
    background: var(--accent-blue);
    border-radius: 0 2px 2px 0;
}
.nav-item i { font-size: 18px; width: 20px; text-align: center; }
.nav-badge {
    margin-left: auto;
    font-size: 11px;
    padding: 2px 8px;
    background: var(--bg-elevated);
    border-radius: var(--radius-full);
    color: var(--text-muted);
    font-weight: 600;
}
.nav-item.active .nav-badge { background: var(--accent-blue); color: white; }
.main-content {
    flex: 1;
    margin-left: 260px;
    min-height: 100vh;
    background: var(--bg-base);
    background-image: var(--gradient-mesh);
}
.content-header {
    position: sticky; top: 0; z-index: 50;
    background: rgba(248,250,252,0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border-default);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.content-title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
.content-title i { color: var(--accent-blue); }
.header-actions { display: flex; gap: 12px; }
.content-body { padding: 24px; max-width: 1600px; }

/* ===== CONSISTENT BUTTON STYLES ===== */
.btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 18px; font-size: 13px; font-weight: 600;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: var(--font-sans);
    line-height: 1;
    white-space: nowrap;
}
.btn-primary {
    background: var(--accent-blue);
    color: white; border: none;
    box-shadow: var(--shadow-sm);
}
.btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn-secondary {
    background: var(--bg-surface);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
}
.btn-secondary:hover { background: var(--bg-elevated); border-color: var(--border-strong); }
.btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid transparent; }
.btn-ghost:hover { background: var(--bg-elevated); color: var(--text-primary); }
.btn-sm { padding: 7px 14px; font-size: 12px; }
.btn-lg { padding: 12px 24px; font-size: 14px; }
.btn-xs { padding: 5px 10px; font-size: 11px; }

/* Filter/Toggle Button Group - Used everywhere for filters */
.btn-group { display: inline-flex; gap: 0; }
.btn-group .btn { border-radius: 0; margin: 0; }
.btn-group .btn:first-child { border-radius: var(--radius-md) 0 0 var(--radius-md); }
.btn-group .btn:last-child { border-radius: 0 var(--radius-md) var(--radius-md) 0; }
.btn-group .btn:not(:last-child) { border-right: none; }

.btn-filter {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 500;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}
.btn-filter:hover { background: var(--bg-elevated); color: var(--text-primary); }
.btn-filter.active {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
}

/* ===== CONSISTENT TYPOGRAPHY ===== */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-sans);
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
}
h1 { font-size: 24px; }
h2 { font-size: 20px; }
h3 { font-size: 16px; }
h4 { font-size: 14px; }
p { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
.text-sm { font-size: 13px; }
.text-xs { font-size: 12px; }
.text-lg { font-size: 16px; }

.card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-normal);
}
.card:hover { border-color: var(--border-default); box-shadow: var(--shadow-md); }
.card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
}
.card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; }
.metric-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 20px;
    position: relative;
    overflow: hidden;
}
.metric-card::before {
    content: ''; position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--gradient-blue);
    opacity: 0;
    transition: opacity var(--transition-normal);
}
.metric-card:hover::before { opacity: 1; }
.metric-icon {
    width: 48px; height: 48px;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    margin-bottom: 16px;
}
.metric-icon.blue { background: var(--accent-blue-soft); color: var(--accent-blue); }
.metric-icon.green { background: var(--accent-green-soft); color: var(--accent-green); }
.metric-icon.amber { background: var(--accent-amber-soft); color: var(--accent-amber); }
.metric-icon.red { background: var(--accent-red-soft); color: var(--accent-red); }
.metric-icon.purple { background: var(--accent-purple-soft); color: var(--accent-purple); }
.metric-icon.cyan { background: var(--accent-cyan-soft); color: var(--accent-cyan); }
.metric-value { font-size: 32px; font-weight: 700; line-height: 1; margin-bottom: 4px; }
.metric-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
.metric-change {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 12px; font-weight: 600; margin-top: 8px;
    padding: 2px 8px; border-radius: var(--radius-full);
}
.metric-change.positive { background: var(--accent-green-soft); color: var(--accent-green); }
.metric-change.negative { background: var(--accent-red-soft); color: var(--accent-red); }
.table-container {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}
.table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 12px;
}
.table-title { font-size: 15px; font-weight: 600; }
table { width: 100%; border-collapse: collapse; }
thead { background: var(--bg-elevated); }
th {
    padding: 12px 16px;
    font-size: 12px; font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    text-align: left;
    border-bottom: 1px solid var(--border-subtle);
}
td {
    padding: 12px 16px;
    font-size: 14px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
}
tbody tr { transition: background var(--transition-fast); }
tbody tr:hover { background: var(--bg-elevated); }
tbody tr:last-child td { border-bottom: none; }
.badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px;
    font-size: 12px; font-weight: 600;
    border-radius: var(--radius-full);
    white-space: nowrap;
}
.badge-blue { background: var(--accent-blue-soft); color: var(--accent-blue); }
.badge-green { background: var(--accent-green-soft); color: var(--accent-green); }
.badge-amber { background: var(--accent-amber-soft); color: var(--accent-amber); }
.badge-red { background: var(--accent-red-soft); color: var(--accent-red); }
.badge-purple { background: var(--accent-purple-soft); color: var(--accent-purple); }
.badge-cyan { background: var(--accent-cyan-soft); color: var(--accent-cyan); }
.badge-pink { background: var(--accent-pink-soft); color: var(--accent-pink); }
.badge-gray { background: var(--bg-elevated); color: var(--text-muted); }
.fw-badge {
    display: inline-flex; padding: 2px 8px;
    font-size: 11px; font-weight: 600;
    border-radius: var(--radius-sm);
    margin-right: 4px;
}
.fw-iso27001 { background: #1e40af; color: #93c5fd; }
.fw-nistcsf { background: #065f46; color: #6ee7b7; }
.fw-soc2 { background: #5b21b6; color: #c4b5fd; }
.fw-pcidss { background: #92400e; color: #fcd34d; }
.fw-hipaa { background: #831843; color: #f9a8d4; }
.fw-gdpr { background: #7f1d1d; color: #fca5a5; }
.fw-cis { background: #0e7490; color: #67e8f9; }
.severity-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.severity-critical { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
.severity-high { background: #f97316; }
.severity-medium { background: var(--accent-amber); }
.severity-low { background: var(--accent-green); }
.form-group { margin-bottom: 16px; }
.form-label {
    display: block;
    font-size: 13px; font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 10px 14px;
    font-size: 14px;
    font-family: inherit;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    transition: all var(--transition-fast);
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px var(--accent-blue-soft);
}
.form-input::placeholder { color: var(--text-muted); }
.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
}
.form-select option { background: var(--bg-surface); color: var(--text-primary); }
.form-textarea { min-height: 100px; resize: vertical; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
    opacity: 0; visibility: hidden;
    transition: all var(--transition-normal);
}
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    width: 100%; max-width: 560px;
    max-height: 90vh;
    overflow: hidden;
    display: flex; flex-direction: column;
    transform: scale(0.95) translateY(20px);
    transition: transform var(--transition-normal);
    box-shadow: var(--shadow-lg);
}
.modal-overlay.active .modal { transform: scale(1) translateY(0); }
.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close {
    width: 32px; height: 32px;
    border-radius: var(--radius-md);
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
}
.modal-close:hover { background: var(--bg-elevated); color: var(--text-primary); }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-subtle);
    display: flex; justify-content: flex-end; gap: 12px;
    background: var(--bg-elevated);
}
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.welcome-banner {
    background: linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: 32px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
}
.welcome-banner::before {
    content: ''; position: absolute;
    top: -50%; right: -20%;
    width: 500px; height: 500px;
    background: radial-gradient(circle, var(--accent-blue-soft) 0%, transparent 70%);
    pointer-events: none;
}
.welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; position: relative; }
.welcome-subtitle { font-size: 15px; color: var(--text-secondary); max-width: 600px; margin-bottom: 20px; position: relative; }
.welcome-actions { display: flex; gap: 12px; position: relative; }
.risk-matrix {
    display: grid;
    grid-template-columns: auto repeat(5, 1fr);
    gap: 2px;
    background: var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
    padding: 2px;
}
.risk-matrix-cell {
    padding: 12px;
    text-align: center;
    font-size: 12px; font-weight: 600;
    min-width: 55px; min-height: 45px;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-surface);
}
.risk-matrix-header { background: var(--bg-elevated); color: var(--text-muted); }
.risk-low { background: #dcfce7; color: #166534; }
.risk-medium { background: #fef3c7; color: #92400e; }
.risk-high { background: #fed7aa; color: #9a3412; }
.risk-critical { background: #fee2e2; color: #b91c1c; }
.progress-bar { height: 8px; background: var(--bg-elevated); border-radius: var(--radius-full); overflow: hidden; }
.progress-fill { height: 100%; border-radius: var(--radius-full); }
.progress-fill.blue { background: var(--gradient-blue); }
.progress-fill.green { background: var(--gradient-green); }
.progress-fill.amber { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.progress-fill.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.progress-fill.purple { background: var(--gradient-purple); }
.chart-container {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 20px;
}
.chart-header { display: flex; justify-content: space-between; margin-bottom: 16px; }
.chart-title { font-size: 15px; font-weight: 600; }
.chart-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 16px; justify-content: center; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.empty-state { text-align: center; padding: 48px; }
.empty-state-icon {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: var(--bg-elevated);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px;
    font-size: 32px;
    color: var(--text-muted);
}
.empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
.empty-state-text { font-size: 14px; color: var(--text-muted); max-width: 400px; margin: 0 auto 20px; }
.tab-content { display: none; animation: fadeIn var(--transition-normal); }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.toast-container {
    position: fixed;
    bottom: 20px; right: 20px;
    z-index: 2000;
    display: flex; flex-direction: column; gap: 12px;
}
.toast {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: 16px;
    display: flex; align-items: center; gap: 12px;
    min-width: 300px;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.toast-icon {
    width: 32px; height: 32px;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
}
.toast-success .toast-icon { background: var(--accent-green-soft); color: var(--accent-green); }
.toast-error .toast-icon { background: var(--accent-red-soft); color: var(--accent-red); }
.toast-info .toast-icon { background: var(--accent-blue-soft); color: var(--accent-blue); }
.toast-content { flex: 1; }
.toast-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
.toast-message { font-size: 13px; color: var(--text-muted); }
.trace-flow {
    display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    padding: 16px;
    background: var(--bg-elevated);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
}
.trace-node {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    min-width: 100px;
    text-align: center;
}
.trace-node-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.trace-node-value { font-size: 14px; font-weight: 600; }
.trace-arrow { color: var(--text-muted); font-size: 20px; }
.font-mono { font-family: var(--font-mono); }
.font-semibold { font-weight: 600; }
.text-muted { color: var(--text-muted); }
.text-red { color: var(--accent-red); }
.text-amber { color: var(--accent-amber); }
.mt-4 { margin-top: 16px; }
.mt-6 { margin-top: 24px; }
.mb-4 { margin-bottom: 16px; }
.mb-6 { margin-bottom: 24px; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-base); }
::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: var(--radius-full); }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
@media (max-width: 1024px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .mobile-toggle { display: flex !important; }
    .form-row { grid-template-columns: 1fr; }
}
.mobile-toggle { display: none; }
    </style>
</head>
<body>
    <!-- Educational Disclaimer Banner -->
    <div id="edu-banner" style="background: linear-gradient(90deg, #1e40af, #7c3aed); color: white; padding: 10px 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 12px; position: relative;">
        <i class="bi bi-mortarboard-fill" style="font-size: 16px;"></i>
        <span><strong>Educational / Practice Use Only</strong> — This is a learning simulator for portfolio building and skills practice. Not for production compliance decisions or formal audits.</span>
        <button onclick="document.getElementById('edu-banner').style.display='none'" style="background: none; border: none; color: white; cursor: pointer; position: absolute; right: 16px; font-size: 18px; opacity: 0.7;">&times;</button>
    </div>
    
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="logo.png" alt="GRC Made Simple" style="height: 40px; width: 40px; border-radius: var(--radius-md); object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="logo-icon" style="display: none;"><i class="bi bi-shield-check"></i></div>
                    <div>
                        <div class="logo-text" style="font-size: 15px; line-height: 1.2;">GRC Made Simple</div>
                        <div style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Practice Lab</div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <div class="nav-item active" data-tab="dashboard"><i class="bi bi-grid-1x2-fill"></i><span>Dashboard</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Inventory</div>
                    <div class="nav-item" data-tab="assets"><i class="bi bi-hdd-stack"></i><span>Assets</span><span class="nav-badge" id="badge-assets">0</span></div>
                    <div class="nav-item" data-tab="vendors"><i class="bi bi-building"></i><span>Vendors</span><span class="nav-badge" id="badge-vendors">0</span></div>
                    <div class="nav-item" data-tab="policies"><i class="bi bi-file-earmark-text"></i><span>Policies</span><span class="nav-badge" id="badge-policies">0</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Risk Management</div>
                    <div class="nav-item" data-tab="risks"><i class="bi bi-exclamation-triangle"></i><span>Risks</span><span class="nav-badge" id="badge-risks">0</span></div>
                    <div class="nav-item" data-tab="controls"><i class="bi bi-shield-lock"></i><span>Controls</span><span class="nav-badge" id="badge-controls">0</span></div>
                    <div class="nav-item" data-tab="treatments"><i class="bi bi-bandaid"></i><span>Treatments</span><span class="nav-badge" id="badge-treatments">0</span></div>
                    <div class="nav-item" data-tab="matrix"><i class="bi bi-grid-3x3"></i><span>Risk Matrix</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <div class="nav-item" data-tab="issues"><i class="bi bi-bug"></i><span>Issues</span><span class="nav-badge" id="badge-issues">0</span></div>
                    <div class="nav-item" data-tab="incidents"><i class="bi bi-lightning"></i><span>Incidents</span><span class="nav-badge" id="badge-incidents">0</span></div>
                    <div class="nav-item" data-tab="tasks"><i class="bi bi-check2-square"></i><span>Tasks</span><span class="nav-badge" id="badge-tasks">0</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Compliance</div>
                    <div class="nav-item" data-tab="audits"><i class="bi bi-clipboard-check"></i><span>Audits</span><span class="nav-badge" id="badge-audits">0</span></div>
                    <div class="nav-item" data-tab="evidence"><i class="bi bi-folder2-open"></i><span>Evidence</span><span class="nav-badge" id="badge-evidence">0</span></div>
                    <div class="nav-item" data-tab="testing"><i class="bi bi-card-checklist"></i><span>Control Testing</span><span class="nav-badge" id="badge-testing">0</span></div>
                    <div class="nav-item" data-tab="findings"><i class="bi bi-search"></i><span>Findings</span><span class="nav-badge" id="badge-findings">0</span></div>
                    <div class="nav-item" data-tab="soa"><i class="bi bi-file-earmark-check"></i><span>Statement of Applicability</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reporting</div>
                    <div class="nav-item" data-tab="traceability"><i class="bi bi-diagram-3"></i><span>Traceability</span></div>
                    <div class="nav-item" data-tab="reports"><i class="bi bi-file-earmark-bar-graph"></i><span>Reports</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Learning</div>
                    <div class="nav-item" data-tab="frameworks"><i class="bi bi-journal-code"></i><span>Frameworks</span><span class="nav-badge" style="background: var(--accent-blue); color: white;">400+</span></div>
                    <div class="nav-item" data-tab="projects"><i class="bi bi-briefcase"></i><span>Projects</span><span class="nav-badge" style="background: var(--accent-purple); color: white;">9</span></div>
                    <div class="nav-item" data-tab="portfolio"><i class="bi bi-person-badge"></i><span>Portfolio</span></div>
                </div>
            </nav>
            <div style="padding: 16px; border-top: 1px solid var(--border-default);">
                <button class="btn btn-primary" style="width: 100%;" onclick="app.loadDemo()">
                    <i class="bi bi-lightning-fill"></i> Load Demo Data
                </button>
            </div>
        </aside>
        <main class="main-content">
            <header class="content-header">
                <button class="btn btn-ghost mobile-toggle" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                <div class="content-title" id="page-title"><i class="bi bi-grid-1x2-fill"></i> Dashboard</div>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="app.exportData()"><i class="bi bi-download"></i> Export</button>
                    <button class="btn btn-secondary btn-sm" onclick="app.clearAllData()"><i class="bi bi-trash3"></i> Clear</button>
                </div>
            </header>
            <div class="content-body">
                <div class="tab-content active" id="tab-dashboard"></div>
                <div class="tab-content" id="tab-assets"></div>
                <div class="tab-content" id="tab-vendors"></div>
                <div class="tab-content" id="tab-policies"></div>
                <div class="tab-content" id="tab-risks"></div>
                <div class="tab-content" id="tab-controls"></div>
                <div class="tab-content" id="tab-treatments"></div>
                <div class="tab-content" id="tab-matrix"></div>
                <div class="tab-content" id="tab-issues"></div>
                <div class="tab-content" id="tab-incidents"></div>
                <div class="tab-content" id="tab-tasks"></div>
                <div class="tab-content" id="tab-audits"></div>
                <div class="tab-content" id="tab-evidence"></div>
                <div class="tab-content" id="tab-testing"></div>
                <div class="tab-content" id="tab-findings"></div>
                <div class="tab-content" id="tab-soa"></div>
                <div class="tab-content" id="tab-traceability"></div>
                <div class="tab-content" id="tab-reports"></div>
                <div class="tab-content" id="tab-frameworks"></div>
                <div class="tab-content" id="tab-projects"></div>
                <div class="tab-content" id="tab-portfolio"></div>
            </div>
        </main>
    </div>
    <div class="toast-container" id="toast-container"></div>
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Modal</h3>
                <button class="modal-close" onclick="closeModal()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>
<script>
class GRCLabPro {
    constructor() {
        this.currentTab = 'dashboard';
        this.activeProject = null; // null = general mode, project id = project mode
        this.data = { assets: [], vendors: [], policies: [], risks: [], controls: [], treatments: [], issues: [], incidents: [], tasks: [], audits: [], evidence: [], controlTests: [], findings: [], soaEntries: [] };
        this.projectData = {}; // Isolated data for each project: { 'project-id': { assets: [], risks: [], ... } }
        this.init();
    }
    init() { this.loadAllData(); this.loadProjectData(); this.bindEvents(); this.renderCurrentTab(); this.updateAllBadges(); }
    loadAllData() { Object.keys(this.data).forEach(key => { const stored = localStorage.getItem(`grc_${key}`); if (stored) try { this.data[key] = JSON.parse(stored); } catch(e) { this.data[key] = []; } }); }
    loadProjectData() { 
        const stored = localStorage.getItem('grc_projectData'); 
        if (stored) try { this.projectData = JSON.parse(stored); } catch(e) { this.projectData = {}; } 
    }
    saveProjectData() {
        localStorage.setItem('grc_projectData', JSON.stringify(this.projectData));
    }
    saveData(key) { 
        if (this.activeProject) {
            // Save to project-specific storage
            if (!this.projectData[this.activeProject]) this.initProjectData(this.activeProject);
            this.projectData[this.activeProject][key] = this.getActiveData()[key];
            this.saveProjectData();
        } else {
            localStorage.setItem(`grc_${key}`, JSON.stringify(this.data[key])); 
        }
        this.updateAllBadges(); 
    }
    initProjectData(projectId) {
        if (!this.projectData[projectId]) {
            this.projectData[projectId] = { assets: [], vendors: [], policies: [], risks: [], controls: [], treatments: [], issues: [], incidents: [], tasks: [], audits: [], evidence: [], controlTests: [], findings: [] };
            this.saveProjectData();
        }
    }
    getActiveData() {
        if (this.activeProject) {
            if (!this.projectData[this.activeProject]) this.initProjectData(this.activeProject);
            return this.projectData[this.activeProject];
        }
        return this.data;
    }
    getProjectData(projectId) {
        if (!this.projectData[projectId]) this.initProjectData(projectId);
        return this.projectData[projectId];
    }
    enterProjectMode(projectId) {
        this.activeProject = projectId;
        if (!this.projectData[projectId]) this.initProjectData(projectId);
        this.renderCurrentTab();
        this.updateAllBadges();
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        this.toast(`Entered project mode: ${project?.company || projectId}`, 'success');
    }
    exitProjectMode() {
        this.activeProject = null;
        this.switchTab('projects');
        this.updateAllBadges();
        this.toast('Exited project mode - back to general workspace', 'info');
    }
    generateId(prefix) { return `${prefix}-${Date.now().toString(36)}`; }
    esc(str) { return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    bindEvents() { document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => this.switchTab(item.dataset.tab))); }
    switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.tab === tab));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-${tab}`));
        const titles = { dashboard:'Dashboard', assets:'Asset Inventory', vendors:'Vendor Management', policies:'Policy Library', risks:'Risk Register', controls:'Control Catalog', treatments:'Risk Treatments', matrix:'Risk Matrix', issues:'Issue Tracker', incidents:'Incident Log', tasks:'Task Management', audits:'Audit Schedule', evidence:'Evidence Library', testing:'Control Testing', findings:'Audit Findings', soa:'Statement of Applicability', traceability:'Traceability Matrix', reports:'Reports & Analytics', frameworks:'Framework Library', projects:'GRC Projects', portfolio:'Portfolio Builder' };
        const icons = { dashboard:'bi-grid-1x2-fill', assets:'bi-hdd-stack', vendors:'bi-building', policies:'bi-file-earmark-text', risks:'bi-exclamation-triangle', controls:'bi-shield-lock', treatments:'bi-bandaid', matrix:'bi-grid-3x3', issues:'bi-bug', incidents:'bi-lightning', tasks:'bi-check2-square', audits:'bi-clipboard-check', evidence:'bi-folder2-open', testing:'bi-card-checklist', findings:'bi-search', soa:'bi-file-earmark-check', traceability:'bi-diagram-3', reports:'bi-file-earmark-bar-graph', frameworks:'bi-journal-code', projects:'bi-briefcase', portfolio:'bi-person-badge' };
        
        let titleHtml = `<i class="bi ${icons[tab] || 'bi-circle'}"></i> ${titles[tab] || tab}`;
        if (this.activeProject) {
            const project = this.getProjectScenarios().find(p => p.id === this.activeProject);
            titleHtml += ` <span class="badge badge-purple" style="font-size: 11px; margin-left: 12px;"><i class="bi bi-briefcase-fill"></i> ${project?.company || 'Project'}</span>`;
        }
        document.getElementById('page-title').innerHTML = titleHtml;
        this.currentTab = tab;
        this.renderCurrentTab();
        this.updateProjectModeIndicator();
    }
    updateProjectModeIndicator() {
        let indicator = document.getElementById('project-mode-indicator');
        if (this.activeProject) {
            const project = this.getProjectScenarios().find(p => p.id === this.activeProject);
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'project-mode-indicator';
                indicator.style.cssText = 'position: fixed; top: 0; left: 260px; right: 0; background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue)); color: white; padding: 8px 20px; font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; z-index: 1000;';
                document.body.appendChild(indicator);
            }
            indicator.innerHTML = `
                <div><i class="bi bi-briefcase-fill"></i> Project Mode: <strong>${project?.company || 'Unknown'}</strong> - ${project?.scenario || ''}</div>
                <button onclick="app.exitProjectMode()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;"><i class="bi bi-x-lg"></i> Exit Project</button>
            `;
            indicator.style.display = 'flex';
            document.querySelector('.main-content').style.paddingTop = '48px';
        } else {
            if (indicator) indicator.style.display = 'none';
            document.querySelector('.main-content').style.paddingTop = '0';
        }
    }
    renderCurrentTab() {
        const r = { dashboard: () => this.renderDashboard(), assets: () => this.renderAssets(), vendors: () => this.renderVendors(), policies: () => this.renderPolicies(), risks: () => this.renderRisks(), controls: () => this.renderControls(), treatments: () => this.renderTreatments(), matrix: () => this.renderMatrix(), issues: () => this.renderIssues(), incidents: () => this.renderIncidents(), tasks: () => this.renderTasks(), audits: () => this.renderAudits(), evidence: () => this.renderEvidence(), testing: () => this.renderTesting(), findings: () => this.renderFindings(), soa: () => this.renderSoA(), traceability: () => this.renderTraceability(), reports: () => this.renderReports(), frameworks: () => this.renderFrameworks(), projects: () => this.renderProjects(), portfolio: () => this.renderPortfolio() };
        if (r[this.currentTab]) r[this.currentTab]();
        this.updateProjectModeIndicator();
    }
    updateAllBadges() {
        const d = this.getActiveData();
        const b = { assets: d.assets.length, vendors: d.vendors.length, policies: d.policies.length, risks: d.risks.length, controls: d.controls.length, treatments: d.treatments.length, issues: d.issues.length, incidents: d.incidents.length, tasks: d.tasks.length, audits: d.audits.length, evidence: d.evidence.length, testing: d.controlTests.length, findings: d.findings.length };
        Object.entries(b).forEach(([k, v]) => { const el = document.getElementById(`badge-${k}`); if (el) el.textContent = v; });
    }
    renderDashboard() {
        const c = document.getElementById('tab-dashboard');
        const d = this.getActiveData();
        const openRisks = d.risks.filter(r => r.status !== 'Closed').length;
        const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const highRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
        const mediumRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 6 && (r.likelihood * r.impact) < 12).length;
        const lowRisks = d.risks.filter(r => (r.likelihood * r.impact) < 6).length;
        const openIssues = d.issues.filter(i => i.status === 'Open').length;
        const pendingTasks = d.tasks.filter(t => t.status !== 'Completed').length;
        const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
        const partialControls = d.controls.filter(c => c.effectiveness === 'Partially Effective').length;
        const ineffectiveControls = d.controls.filter(c => c.effectiveness === 'Ineffective').length;
        const openFindings = d.findings.filter(f => f.status === 'Open').length;
        const closedFindings = d.findings.filter(f => f.status === 'Closed').length;
        const activeIncidents = d.incidents.filter(i => i.status !== 'Resolved').length;
        const criticalVendors = d.vendors.filter(v => v.criticality === 'Critical').length;
        
        // Calculate health score
        const riskScore = d.risks.length > 0 ? Math.max(0, 100 - (criticalRisks * 15 + highRisks * 8 + mediumRisks * 3)) : 100;
        const controlScore = d.controls.length > 0 ? Math.round((effectiveControls / d.controls.length) * 100) : 0;
        const overallHealth = d.risks.length > 0 || d.controls.length > 0 ? Math.round((riskScore + controlScore) / 2) : 0;
        const healthColor = overallHealth >= 70 ? 'green' : overallHealth >= 40 ? 'amber' : 'red';
        
        const projectModeNote = this.activeProject ? `
            <div style="background: linear-gradient(135deg, var(--accent-purple-soft), var(--accent-blue-soft)); padding: 16px; border-radius: var(--radius-md); margin-bottom: 24px; border: 1px solid var(--accent-purple);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="bi bi-briefcase-fill" style="font-size: 24px; color: var(--accent-purple);"></i>
                    <div>
                        <div style="font-weight: 600;">You are working in Project Mode</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">All data you add will be saved to this project only. Click "Exit Project" in the header to return to general workspace.</div>
                    </div>
                </div>
            </div>
        ` : '';
        
        c.innerHTML = `
            ${projectModeNote}
            
            <!-- Welcome Banner -->
            <div style="background: var(--bg-surface); border-radius: var(--radius-lg); padding: 28px; margin-bottom: 24px; border: 1px solid var(--border-default); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, var(--accent-blue-soft) 0%, transparent 70%); pointer-events: none;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
                        <img src="logo.png" alt="GRC Made Simple" style="height: 56px; width: 56px; border-radius: var(--radius-md); object-fit: contain;" onerror="this.outerHTML='<div style=\\'width:56px;height:56px;background:var(--accent-blue);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;\\'><i class=\\'bi bi-shield-check\\' style=\\'font-size:28px;color:white;\\'></i></div>'">
                        <div style="flex: 1;">
                            <h1 style="font-size: 22px; font-weight: 700; margin: 0; color: var(--text-primary);">${this.activeProject ? 'Project Dashboard' : 'GRC Made Simple — Practice Lab'}</h1>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 6px 0 0 0; line-height: 1.5;">${this.activeProject ? 'Track your progress and complete tasks to build your portfolio.' : 'Build practical GRC skills through hands-on simulations. Create risk registers, implement controls, manage audits, and generate portfolio-ready artifacts.'}</p>
                        </div>
                    </div>
                    
                    ${!this.activeProject ? `
                        <!-- Feature Highlights -->
                        <div style="display: flex; gap: 24px; margin: 20px 0; padding: 16px 0; border-top: 1px solid var(--border-subtle); border-bottom: 1px solid var(--border-subtle);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-journal-code" style="color: var(--accent-blue);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">400+ Framework Controls</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-briefcase" style="color: var(--accent-purple);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">9 Real-World Projects</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-file-earmark-text" style="color: var(--accent-green);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Resume Builder</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-bar-chart" style="color: var(--accent-amber);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Interactive Reports</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="app.loadDemo()"><i class="bi bi-lightning-fill"></i> Load Demo Data</button>
                            <button class="btn btn-secondary" onclick="app.switchTab('projects')"><i class="bi bi-briefcase"></i> Start a Project</button>
                            <button class="btn btn-secondary" onclick="app.switchTab('frameworks')"><i class="bi bi-book"></i> Learn Frameworks</button>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Main Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="metric-card" onclick="app.switchTab('assets')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div class="metric-icon blue"><i class="bi bi-hdd-stack"></i></div>
                    <div class="metric-value">${d.assets.length}</div>
                    <div class="metric-label">Total Assets</div>
                </div>
                <div class="metric-card" onclick="app.switchTab('risks')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div class="metric-icon red"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="metric-value">${openRisks}</div>
                    <div class="metric-label">Open Risks</div>
                    ${criticalRisks > 0 ? `<div class="metric-change negative"><i class="bi bi-exclamation-circle"></i> ${criticalRisks} Critical</div>` : ''}
                </div>
                <div class="metric-card" onclick="app.switchTab('controls')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div class="metric-icon green"><i class="bi bi-shield-check"></i></div>
                    <div class="metric-value">${d.controls.length}</div>
                    <div class="metric-label">Controls</div>
                    ${effectiveControls > 0 ? `<div class="metric-change positive"><i class="bi bi-check"></i> ${effectiveControls} Effective</div>` : ''}
                </div>
                <div class="metric-card" onclick="app.switchTab('issues')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div class="metric-icon amber"><i class="bi bi-bug"></i></div>
                    <div class="metric-value">${openIssues}</div>
                    <div class="metric-label">Open Issues</div>
                </div>
                <div class="metric-card" onclick="app.switchTab('tasks')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div class="metric-icon purple"><i class="bi bi-check2-square"></i></div>
                    <div class="metric-value">${pendingTasks}</div>
                    <div class="metric-label">Pending Tasks</div>
                </div>
                <div class="metric-card" onclick="app.switchTab('findings')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                    <div class="metric-icon cyan"><i class="bi bi-search"></i></div>
                    <div class="metric-value">${openFindings}</div>
                    <div class="metric-label">Open Findings</div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                
                <!-- GRC Health Score -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-heart-pulse"></i> GRC Health Score</span>
                    </div>
                    <div class="card-body" style="padding: 24px; text-align: center;">
                        <div style="position: relative; width: 140px; height: 140px; margin: 0 auto 16px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg-elevated)" stroke-width="12"/>
                                <circle cx="50" cy="50" r="42" fill="none" stroke="var(--accent-${healthColor})" stroke-width="12" 
                                    stroke-dasharray="${overallHealth * 2.64} 264" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--accent-${healthColor});">${overallHealth}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">/ 100</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: center;">
                            <div style="padding: 10px; background: var(--bg-elevated); border-radius: var(--radius-sm);">
                                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${riskScore}%</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Risk Score</div>
                            </div>
                            <div style="padding: 10px; background: var(--bg-elevated); border-radius: var(--radius-sm);">
                                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${controlScore}%</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Control Effectiveness</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Distribution -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-pie-chart"></i> Risk Distribution</span>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        ${d.risks.length > 0 ? `
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <!-- Donut Chart -->
                                <div style="position: relative; width: 120px; height: 120px; flex-shrink: 0;">
                                    <svg viewBox="0 0 100 100">
                                        ${this.renderDonutChart([
                                            { value: criticalRisks, color: '#ef4444' },
                                            { value: highRisks, color: '#f59e0b' },
                                            { value: mediumRisks, color: '#3b82f6' },
                                            { value: lowRisks, color: '#22c55e' }
                                        ], d.risks.length)}
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 20px; font-weight: 700;">${d.risks.length}</div>
                                        <div style="font-size: 9px; color: var(--text-muted);">Total</div>
                                    </div>
                                </div>
                                <!-- Legend -->
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                        <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 3px;"></div>
                                        <span style="font-size: 12px; flex: 1;">Critical</span>
                                        <span style="font-size: 13px; font-weight: 600;">${criticalRisks}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                        <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 3px;"></div>
                                        <span style="font-size: 12px; flex: 1;">High</span>
                                        <span style="font-size: 13px; font-weight: 600;">${highRisks}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 3px;"></div>
                                        <span style="font-size: 12px; flex: 1;">Medium</span>
                                        <span style="font-size: 13px; font-weight: 600;">${mediumRisks}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 3px;"></div>
                                        <span style="font-size: 12px; flex: 1;">Low</span>
                                        <span style="font-size: 13px; font-weight: 600;">${lowRisks}</span>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 30px 0; color: var(--text-muted);">
                                <i class="bi bi-pie-chart" style="font-size: 32px; opacity: 0.3; margin-bottom: 8px; display: block;"></i>
                                <p style="font-size: 13px;">No risks recorded yet</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Control Effectiveness -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-bar-chart"></i> Control Effectiveness</span>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        ${d.controls.length > 0 ? `
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px; display: flex; align-items: center; gap: 6px;"><span style="width: 10px; height: 10px; background: var(--accent-green); border-radius: 2px;"></span> Effective</span>
                                    <span style="font-size: 13px; font-weight: 600;">${effectiveControls}</span>
                                </div>
                                <div class="progress-bar" style="height: 10px; border-radius: 5px;">
                                    <div class="progress-fill green" style="width: ${d.controls.length > 0 ? (effectiveControls/d.controls.length)*100 : 0}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px; display: flex; align-items: center; gap: 6px;"><span style="width: 10px; height: 10px; background: var(--accent-amber); border-radius: 2px;"></span> Partial</span>
                                    <span style="font-size: 13px; font-weight: 600;">${partialControls}</span>
                                </div>
                                <div class="progress-bar" style="height: 10px; border-radius: 5px;">
                                    <div class="progress-fill amber" style="width: ${d.controls.length > 0 ? (partialControls/d.controls.length)*100 : 0}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px; display: flex; align-items: center; gap: 6px;"><span style="width: 10px; height: 10px; background: var(--accent-red); border-radius: 2px;"></span> Ineffective</span>
                                    <span style="font-size: 13px; font-weight: 600;">${ineffectiveControls}</span>
                                </div>
                                <div class="progress-bar" style="height: 10px; border-radius: 5px;">
                                    <div class="progress-fill red" style="width: ${d.controls.length > 0 ? (ineffectiveControls/d.controls.length)*100 : 0}%; border-radius: 5px;"></div>
                                </div>
                            </div>
                            <div style="text-align: center; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                                <span style="font-size: 11px; color: var(--text-muted);">Total: ${d.controls.length} controls</span>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 30px 0; color: var(--text-muted);">
                                <i class="bi bi-bar-chart" style="font-size: 32px; opacity: 0.3; margin-bottom: 8px; display: block;"></i>
                                <p style="font-size: 13px;">No controls recorded yet</p>
                            </div>
                        `}
                    </div>
                </div>
            </div>
            
            <!-- Second Row - Risk by Category & Activity -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;">
                
                <!-- Risk by Category - Visual Bars -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-collection"></i> Risk by Category</span>
                        <span class="badge badge-blue">${d.risks.length} Total</span>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        ${d.risks.length > 0 ? this.renderRiskByCategoryChart() : `
                            <div style="text-align: center; padding: 40px 0; color: var(--text-muted);">
                                <i class="bi bi-collection" style="font-size: 40px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                                <p style="font-size: 13px; margin-bottom: 12px;">No risks by category yet</p>
                                <button class="btn btn-primary btn-sm" onclick="app.switchTab('risks')"><i class="bi bi-plus"></i> Add Risk</button>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Quick Stats Panel -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-speedometer2"></i> Quick Stats</span>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div onclick="app.switchTab('vendors')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background='var(--accent-purple-soft)'" onmouseout="this.style.background='var(--bg-elevated)'">
                                <div style="width: 36px; height: 36px; background: var(--accent-purple-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-building" style="color: var(--accent-purple);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: var(--text-muted);">Vendors</div>
                                    <div style="font-size: 16px; font-weight: 600;">${d.vendors.length} <span style="font-size: 11px; color: var(--accent-red);">${criticalVendors} critical</span></div>
                                </div>
                                <i class="bi bi-chevron-right" style="color: var(--text-muted);"></i>
                            </div>
                            <div onclick="app.switchTab('incidents')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background='var(--accent-amber-soft)'" onmouseout="this.style.background='var(--bg-elevated)'">
                                <div style="width: 36px; height: 36px; background: var(--accent-amber-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-lightning" style="color: var(--accent-amber);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: var(--text-muted);">Incidents</div>
                                    <div style="font-size: 16px; font-weight: 600;">${d.incidents.length} <span style="font-size: 11px; color: var(--accent-red);">${activeIncidents} active</span></div>
                                </div>
                                <i class="bi bi-chevron-right" style="color: var(--text-muted);"></i>
                            </div>
                            <div onclick="app.switchTab('audits')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background='var(--accent-blue-soft)'" onmouseout="this.style.background='var(--bg-elevated)'">
                                <div style="width: 36px; height: 36px; background: var(--accent-blue-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-clipboard-check" style="color: var(--accent-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: var(--text-muted);">Audits</div>
                                    <div style="font-size: 16px; font-weight: 600;">${d.audits.length} <span style="font-size: 11px; color: var(--accent-amber);">${d.audits.filter(a => a.status === 'In Progress').length} active</span></div>
                                </div>
                                <i class="bi bi-chevron-right" style="color: var(--text-muted);"></i>
                            </div>
                            <div onclick="app.switchTab('evidence')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s;" onmouseover="this.style.background='var(--accent-green-soft)'" onmouseout="this.style.background='var(--bg-elevated)'">
                                <div style="width: 36px; height: 36px; background: var(--accent-green-soft); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-file-earmark-check" style="color: var(--accent-green);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: var(--text-muted);">Evidence</div>
                                    <div style="font-size: 16px; font-weight: 600;">${d.evidence.length} items</div>
                                </div>
                                <i class="bi bi-chevron-right" style="color: var(--text-muted);"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity & Top Risks -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                
                <!-- Top Critical Risks -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-exclamation-octagon"></i> Top Risks Requiring Attention</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        ${d.risks.filter(r => r.status !== 'Closed').sort((a,b) => (b.likelihood * b.impact) - (a.likelihood * a.impact)).slice(0, 5).length > 0 ? 
                            d.risks.filter(r => r.status !== 'Closed').sort((a,b) => (b.likelihood * b.impact) - (a.likelihood * a.impact)).slice(0, 5).map((r, i) => {
                                const score = r.likelihood * r.impact;
                                const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                return `
                                    <div style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer;" onclick="app.switchTab('risks')" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                        <div style="width: 28px; height: 28px; background: var(--accent-${scoreClass}-soft); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--accent-${scoreClass});">${score}</div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.title}</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">${r.category}</div>
                                        </div>
                                        <span class="badge badge-${r.status === 'In Progress' ? 'amber' : 'gray'}" style="font-size: 10px;">${r.status}</span>
                                    </div>
                                `;
                            }).join('') 
                        : `
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                                <i class="bi bi-shield-check" style="font-size: 32px; color: var(--accent-green); margin-bottom: 8px; display: block;"></i>
                                <p style="font-size: 13px;">No open risks - great job!</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Findings Status -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-search"></i> Findings Overview</span>
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        ${d.findings.length > 0 ? `
                            <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                                <div style="flex: 1; text-align: center; padding: 16px; background: var(--accent-red-soft); border-radius: var(--radius-md);">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${openFindings}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Open</div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 16px; background: var(--accent-green-soft); border-radius: var(--radius-md);">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${closedFindings}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Closed</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px;">Closure Rate</span>
                                    <span style="font-size: 12px; font-weight: 600;">${Math.round((closedFindings / d.findings.length) * 100)}%</span>
                                </div>
                                <div class="progress-bar" style="height: 8px;">
                                    <div class="progress-fill green" style="width: ${(closedFindings / d.findings.length) * 100}%;"></div>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.switchTab('findings')" style="width: 100%;"><i class="bi bi-arrow-right"></i> View All Findings</button>
                        ` : `
                            <div style="text-align: center; padding: 30px 0; color: var(--text-muted);">
                                <i class="bi bi-search" style="font-size: 32px; opacity: 0.3; margin-bottom: 8px; display: block;"></i>
                                <p style="font-size: 13px; margin-bottom: 12px;">No findings recorded</p>
                                <button class="btn btn-primary btn-sm" onclick="app.switchTab('findings')"><i class="bi bi-plus"></i> Add Finding</button>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }
    
    renderDonutChart(segments, total) {
        if (total === 0) return '';
        let currentAngle = 0;
        return segments.map(seg => {
            if (seg.value === 0) return '';
            const angle = (seg.value / total) * 360;
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;
            currentAngle = endAngle;
            
            const startRad = (startAngle - 90) * Math.PI / 180;
            const endRad = (endAngle - 90) * Math.PI / 180;
            const largeArc = angle > 180 ? 1 : 0;
            
            const x1 = 50 + 35 * Math.cos(startRad);
            const y1 = 50 + 35 * Math.sin(startRad);
            const x2 = 50 + 35 * Math.cos(endRad);
            const y2 = 50 + 35 * Math.sin(endRad);
            
            return `<path d="M 50 50 L ${x1} ${y1} A 35 35 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${seg.color}" opacity="0.9"/>`;
        }).join('');
    }
    
    renderRiskByCategoryChart() {
        const d = this.getActiveData();
        const cats = {};
        d.risks.forEach(r => cats[r.category] = (cats[r.category] || 0) + 1);
        const maxCount = Math.max(...Object.values(cats));
        const colors = ['#3b82f6', '#a855f7', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899'];
        
        return `
            <div style="display: flex; flex-direction: column; gap: 14px;">
                ${Object.entries(cats).sort((a, b) => b[1] - a[1]).map(([cat, count], i) => `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 13px; font-weight: 500;">${cat}</span>
                            <span style="font-size: 13px; font-weight: 600; color: ${colors[i % colors.length]};">${count}</span>
                        </div>
                        <div style="height: 24px; background: var(--bg-elevated); border-radius: 6px; overflow: hidden; position: relative;">
                            <div style="height: 100%; width: ${(count/maxCount)*100}%; background: linear-gradient(90deg, ${colors[i % colors.length]}dd, ${colors[i % colors.length]}99); border-radius: 6px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    renderAssets() {
        const c = document.getElementById('tab-assets');
        const d = this.getActiveData();
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Asset Inventory</h3><button class="btn btn-primary btn-sm" onclick="app.showAssetModal()"><i class="bi bi-plus-lg"></i> Add Asset</button></div>${d.assets.length > 0 ? `<table><thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Classification</th><th>Owner</th><th>Environment</th><th>Actions</th></tr></thead><tbody>${d.assets.map(a => `<tr><td><span class="font-mono text-muted">${a.id}</span></td><td class="font-semibold">${a.name}</td><td><span class="badge badge-blue">${a.type}</span></td><td><span class="badge badge-${a.classification === 'Critical' ? 'red' : a.classification === 'High' ? 'amber' : 'green'}">${a.classification}</span></td><td>${a.owner}</td><td>${a.environment}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editAsset('${a.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('assets','${a.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-hdd-stack', 'No Assets Yet', 'Assets are systems and data you need to protect.', 'showAssetModal')}</div>`;
    }
    showAssetModal(a = null) {
        const isEdit = a !== null;
        openModal(isEdit ? 'Edit Asset' : 'Add Asset', `<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="f-name" value="${a?.name || ''}" placeholder="e.g., Customer Database"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Application', 'Database', 'Server', 'Cloud Account', 'Network Device', 'Data Store', 'Endpoint'].map(t => `<option value="${t}" ${a?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Classification</label><select class="form-select" id="f-class">${['Critical', 'High', 'Medium', 'Low'].map(c => `<option value="${c}" ${a?.classification === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${a?.owner || ''}"></div><div class="form-group"><label class="form-label">Environment</label><select class="form-select" id="f-env">${['Production', 'Staging', 'Development', 'DR'].map(e => `<option value="${e}" ${a?.environment === e ? 'selected' : ''}>${e}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${a?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveAsset('${a?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveAsset(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const d = this.getActiveData();
        const item = { id: editId || this.generateId('AST'), name, type: document.getElementById('f-type').value, classification: document.getElementById('f-class').value, owner: document.getElementById('f-owner').value, environment: document.getElementById('f-env').value, description: document.getElementById('f-desc').value, createdAt: editId ? d.assets.find(a => a.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = d.assets.findIndex(a => a.id === editId); if (idx !== -1) d.assets[idx] = item; } else { d.assets.push(item); }
        this.saveData('assets'); closeModal(); this.renderAssets(); this.toast(editId ? 'Asset updated' : 'Asset created', 'success');
    }
    editAsset(id) { const d = this.getActiveData(); const a = d.assets.find(x => x.id === id); if (a) this.showAssetModal(a); }
    renderVendors() {
        const c = document.getElementById('tab-vendors');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Vendor Management</h3><button class="btn btn-primary btn-sm" onclick="app.showVendorModal()"><i class="bi bi-plus-lg"></i> Add Vendor</button></div>${this.getActiveData().vendors.length > 0 ? `<table><thead><tr><th>ID</th><th>Vendor</th><th>Service</th><th>Criticality</th><th>Status</th><th>Owner</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().vendors.map(v => `<tr><td><span class="font-mono text-muted">${v.id}</span></td><td class="font-semibold">${v.name}</td><td>${v.service}</td><td><span class="badge badge-${v.criticality === 'Critical' ? 'red' : v.criticality === 'High' ? 'amber' : 'green'}">${v.criticality}</span></td><td><span class="badge badge-${v.status === 'Active' ? 'green' : 'gray'}">${v.status}</span></td><td>${v.owner}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editVendor('${v.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('vendors','${v.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-building', 'No Vendors Yet', 'Track third-party vendors and their risk profiles.', 'showVendorModal')}</div>`;
    }
    showVendorModal(v = null) {
        const isEdit = v !== null;
        openModal(isEdit ? 'Edit Vendor' : 'Add Vendor', `<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="f-name" value="${v?.name || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Service</label><input type="text" class="form-input" id="f-service" value="${v?.service || ''}"></div><div class="form-group"><label class="form-label">Criticality</label><select class="form-select" id="f-crit">${['Critical', 'High', 'Medium', 'Low'].map(c => `<option value="${c}" ${v?.criticality === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${v?.owner || ''}"></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Active', 'Under Review', 'Inactive'].map(s => `<option value="${s}" ${v?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes">${v?.notes || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveVendor('${v?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveVendor(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const item = { id: editId || this.generateId('VND'), name, service: document.getElementById('f-service').value, criticality: document.getElementById('f-crit').value, owner: document.getElementById('f-owner').value, status: document.getElementById('f-status').value, notes: document.getElementById('f-notes').value, createdAt: editId ? this.getActiveData().vendors.find(v => v.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().vendors.findIndex(v => v.id === editId); if (idx !== -1) this.getActiveData().vendors[idx] = item; } else { this.getActiveData().vendors.push(item); }
        this.saveData('vendors'); closeModal(); this.renderVendors(); this.toast(editId ? 'Vendor updated' : 'Vendor created', 'success');
    }
    editVendor(id) { const v = this.getActiveData().vendors.find(x => x.id === id); if (v) this.showVendorModal(v); }
    renderPolicies() {
        const c = document.getElementById('tab-policies');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Policy Library</h3><button class="btn btn-primary btn-sm" onclick="app.showPolicyModal()"><i class="bi bi-plus-lg"></i> Add Policy</button></div>${this.getActiveData().policies.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Owner</th><th>Review Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().policies.map(p => `<tr><td><span class="font-mono text-muted">${p.id}</span></td><td class="font-semibold">${p.title}</td><td><span class="badge badge-${p.status === 'Approved' ? 'green' : p.status === 'Draft' ? 'gray' : 'amber'}">${p.status}</span></td><td>${p.owner}</td><td>${p.reviewDate ? new Date(p.reviewDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editPolicy('${p.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('policies','${p.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-file-earmark-text', 'No Policies Yet', 'Document your security policies.', 'showPolicyModal')}</div>`;
    }
    showPolicyModal(p = null) {
        const isEdit = p !== null;
        openModal(isEdit ? 'Edit Policy' : 'Add Policy', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${p?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Draft', 'Under Review', 'Approved', 'Retired'].map(s => `<option value="${s}" ${p?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${p?.owner || ''}"></div></div><div class="form-group"><label class="form-label">Review Date</label><input type="date" class="form-input" id="f-review" value="${p?.reviewDate?.split('T')[0] || ''}"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.savePolicy('${p?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    savePolicy(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('POL'), title, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, reviewDate: document.getElementById('f-review').value || null, createdAt: editId ? this.getActiveData().policies.find(p => p.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().policies.findIndex(p => p.id === editId); if (idx !== -1) this.getActiveData().policies[idx] = item; } else { this.getActiveData().policies.push(item); }
        this.saveData('policies'); closeModal(); this.renderPolicies(); this.toast(editId ? 'Policy updated' : 'Policy created', 'success');
    }
    editPolicy(id) { const p = this.getActiveData().policies.find(x => x.id === id); if (p) this.showPolicyModal(p); }
    renderRisks() {
        const c = document.getElementById('tab-risks');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Risk Register</h3><button class="btn btn-primary btn-sm" onclick="app.showRiskModal()"><i class="bi bi-plus-lg"></i> Add Risk</button></div>${this.getActiveData().risks.length > 0 ? `<table><thead><tr><th>ID</th><th>Risk Title</th><th>Category</th><th>L × I</th><th>Score</th><th>Status</th><th>Owner</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().risks.map(r => { const score = r.likelihood * r.impact; const sev = score >= 20 ? 'critical' : score >= 12 ? 'high' : score >= 6 ? 'medium' : 'low'; return `<tr><td><span class="font-mono text-muted">${r.id}</span></td><td class="font-semibold">${r.title}</td><td><span class="badge badge-blue">${r.category}</span></td><td>${r.likelihood} × ${r.impact}</td><td><span class="severity-dot severity-${sev}"></span>${score}</td><td><span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'red'}">${r.status}</span></td><td>${r.owner}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editRisk('${r.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('risks','${r.id}')"><i class="bi bi-trash3"></i></button></td></tr>`; }).join('')}</tbody></table>` : this.renderEmpty('bi-exclamation-triangle', 'No Risks Yet', 'Identify and assess risks to your organization.', 'showRiskModal')}</div>`;
    }
    showRiskModal(r = null) {
        const isEdit = r !== null;
        openModal(isEdit ? 'Edit Risk' : 'Add Risk', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${r?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="f-category">${['Access Control', 'Application Security', 'Data Protection', 'Availability', 'Compliance', 'Vendor Risk', 'Physical Security', 'Human Error', 'Other'].map(c => `<option value="${c}" ${r?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Open', 'In Progress', 'Closed'].map(s => `<option value="${s}" ${r?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Likelihood (1-5)</label><select class="form-select" id="f-likelihood">${[1,2,3,4,5].map(l => `<option value="${l}" ${r?.likelihood === l ? 'selected' : ''}>${l} - ${['Rare','Unlikely','Possible','Likely','Almost Certain'][l-1]}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Impact (1-5)</label><select class="form-select" id="f-impact">${[1,2,3,4,5].map(i => `<option value="${i}" ${r?.impact === i ? 'selected' : ''}>${i} - ${['Negligible','Minor','Moderate','Major','Severe'][i-1]}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${r?.owner || ''}"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${r?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveRisk('${r?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveRisk(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('RSK'), title, category: document.getElementById('f-category').value, status: document.getElementById('f-status').value, likelihood: parseInt(document.getElementById('f-likelihood').value), impact: parseInt(document.getElementById('f-impact').value), owner: document.getElementById('f-owner').value, description: document.getElementById('f-desc').value, createdAt: editId ? this.getActiveData().risks.find(r => r.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().risks.findIndex(r => r.id === editId); if (idx !== -1) this.getActiveData().risks[idx] = item; } else { this.getActiveData().risks.push(item); }
        this.saveData('risks'); closeModal(); this.renderRisks(); this.toast(editId ? 'Risk updated' : 'Risk created', 'success');
    }
    editRisk(id) { const r = this.getActiveData().risks.find(x => x.id === id); if (r) this.showRiskModal(r); }
    renderControls() {
        const c = document.getElementById('tab-controls');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Control Catalog</h3><button class="btn btn-primary btn-sm" onclick="app.showControlModal()"><i class="bi bi-plus-lg"></i> Add Control</button></div>${this.getActiveData().controls.length > 0 ? `<table><thead><tr><th>ID</th><th>Control Name</th><th>Framework</th><th>Reference</th><th>Effectiveness</th><th>Owner</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().controls.map(c => `<tr><td><span class="font-mono text-muted">${c.id}</span></td><td class="font-semibold">${c.name}</td><td><span class="fw-badge fw-${c.framework?.toLowerCase().replace(/\s/g, '')}">${c.framework}</span></td><td><span class="font-mono">${c.ref || '-'}</span></td><td><span class="badge badge-${c.effectiveness === 'Effective' ? 'green' : c.effectiveness === 'Partially Effective' ? 'amber' : 'red'}">${c.effectiveness}</span></td><td>${c.owner}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editControl('${c.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('controls','${c.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-shield-lock', 'No Controls Yet', 'Define security controls to mitigate risks.', 'showControlModal')}</div>`;
    }
    showControlModal(ctrl = null) {
        const isEdit = ctrl !== null;
        openModal(isEdit ? 'Edit Control' : 'Add Control', `<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="f-name" value="${ctrl?.name || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Framework</label><select class="form-select" id="f-framework">${['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR', 'CIS'].map(f => `<option value="${f}" ${ctrl?.framework === f ? 'selected' : ''}>${f}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Reference</label><input type="text" class="form-input" id="f-ref" value="${ctrl?.ref || ''}" placeholder="e.g., A.5.17"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Effectiveness</label><select class="form-select" id="f-effectiveness">${['Effective', 'Partially Effective', 'Ineffective', 'Not Tested'].map(e => `<option value="${e}" ${ctrl?.effectiveness === e ? 'selected' : ''}>${e}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Frequency</label><select class="form-select" id="f-frequency">${['Continuous', 'Monthly', 'Quarterly', 'Annual'].map(f => `<option value="${f}" ${ctrl?.frequency === f ? 'selected' : ''}>${f}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${ctrl?.owner || ''}"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${ctrl?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveControl('${ctrl?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveControl(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const item = { id: editId || this.generateId('CTL'), name, framework: document.getElementById('f-framework').value, ref: document.getElementById('f-ref').value, effectiveness: document.getElementById('f-effectiveness').value, frequency: document.getElementById('f-frequency').value, owner: document.getElementById('f-owner').value, description: document.getElementById('f-desc').value, createdAt: editId ? this.getActiveData().controls.find(c => c.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().controls.findIndex(c => c.id === editId); if (idx !== -1) this.getActiveData().controls[idx] = item; } else { this.getActiveData().controls.push(item); }
        this.saveData('controls'); closeModal(); this.renderControls(); this.toast(editId ? 'Control updated' : 'Control created', 'success');
    }
    editControl(id) { const c = this.getActiveData().controls.find(x => x.id === id); if (c) this.showControlModal(c); }
    renderTreatments() {
        const c = document.getElementById('tab-treatments');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Risk Treatment Plans</h3><button class="btn btn-primary btn-sm" onclick="app.showTreatmentModal()"><i class="bi bi-plus-lg"></i> Add Treatment</button></div>${this.getActiveData().treatments.length > 0 ? `<table><thead><tr><th>ID</th><th>Risk</th><th>Type</th><th>Status</th><th>Owner</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().treatments.map(t => { const risk = this.getActiveData().risks.find(r => r.id === t.riskId); return `<tr><td><span class="font-mono text-muted">${t.id}</span></td><td>${risk?.title || t.riskId}</td><td><span class="badge badge-${t.type === 'Mitigate' ? 'blue' : t.type === 'Accept' ? 'green' : t.type === 'Transfer' ? 'purple' : 'amber'}">${t.type}</span></td><td><span class="badge badge-${t.status === 'Completed' ? 'green' : t.status === 'In Progress' ? 'amber' : 'gray'}">${t.status}</span></td><td>${t.owner}</td><td>${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editTreatment('${t.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('treatments','${t.id}')"><i class="bi bi-trash3"></i></button></td></tr>`; }).join('')}</tbody></table>` : this.renderEmpty('bi-bandaid', 'No Treatments Yet', 'Create treatment plans to address risks.', 'showTreatmentModal')}</div>`;
    }
    showTreatmentModal(t = null) {
        const isEdit = t !== null;
        openModal(isEdit ? 'Edit Treatment' : 'Add Treatment', `<div class="form-group"><label class="form-label">Related Risk *</label><select class="form-select" id="f-risk"><option value="">-- Select Risk --</option>${this.getActiveData().risks.map(r => `<option value="${r.id}" ${t?.riskId === r.id ? 'selected' : ''}>${r.title}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Mitigate', 'Accept', 'Transfer', 'Avoid'].map(ty => `<option value="${ty}" ${t?.type === ty ? 'selected' : ''}>${ty}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Planned', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${t?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${t?.owner || ''}"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${t?.dueDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Plan</label><textarea class="form-textarea" id="f-plan">${t?.plan || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveTreatment('${t?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveTreatment(editId) {
        const riskId = document.getElementById('f-risk').value;
        if (!riskId) { this.toast('Please select a risk', 'error'); return; }
        const item = { id: editId || this.generateId('TRT'), riskId, type: document.getElementById('f-type').value, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, dueDate: document.getElementById('f-due').value || null, plan: document.getElementById('f-plan').value, createdAt: editId ? this.getActiveData().treatments.find(t => t.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().treatments.findIndex(t => t.id === editId); if (idx !== -1) this.getActiveData().treatments[idx] = item; } else { this.getActiveData().treatments.push(item); }
        this.saveData('treatments'); closeModal(); this.renderTreatments(); this.toast(editId ? 'Treatment updated' : 'Treatment created', 'success');
    }
    editTreatment(id) { const t = this.getActiveData().treatments.find(x => x.id === id); if (t) this.showTreatmentModal(t); }
    renderMatrix() {
        const c = document.getElementById('tab-matrix');
        
        // Build inherent risk matrix (original risk scores)
        const inherentMatrix = Array(5).fill(null).map(() => Array(5).fill(null).map(() => []));
        this.getActiveData().risks.forEach(r => { 
            if (r.likelihood >= 1 && r.likelihood <= 5 && r.impact >= 1 && r.impact <= 5) {
                inherentMatrix[5 - r.impact][r.likelihood - 1].push(r); 
            }
        });
        
        // Build residual risk matrix (after treatments)
        const residualMatrix = Array(5).fill(null).map(() => Array(5).fill(null).map(() => []));
        this.getActiveData().risks.forEach(r => {
            // Check if there's a completed treatment for this risk
            const treatment = this.getActiveData().treatments.find(t => t.riskId === r.id && t.status === 'Completed');
            let resLikelihood = r.likelihood;
            let resImpact = r.impact;
            
            if (treatment) {
                // Reduce by 1 level for mitigate/transfer, by 2 for avoid
                if (treatment.type === 'Mitigate' || treatment.type === 'Transfer') {
                    resLikelihood = Math.max(1, r.likelihood - 1);
                    resImpact = Math.max(1, r.impact - 1);
                } else if (treatment.type === 'Avoid') {
                    resLikelihood = Math.max(1, r.likelihood - 2);
                    resImpact = Math.max(1, r.impact - 2);
                }
                // Accept keeps the same values
            }
            
            if (resLikelihood >= 1 && resLikelihood <= 5 && resImpact >= 1 && resImpact <= 5) {
                residualMatrix[5 - resImpact][resLikelihood - 1].push({...r, resLikelihood, resImpact});
            }
        });
        
        const getCellClass = (l, i) => { 
            const score = l * i; 
            if (score >= 20) return 'risk-critical'; 
            if (score >= 12) return 'risk-high'; 
            if (score >= 6) return 'risk-medium'; 
            return 'risk-low'; 
        };
        
        // Calculate risk statistics
        const totalRisks = this.getActiveData().risks.length;
        const criticalRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 20).length;
        const highRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
        const mediumRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 6 && (r.likelihood * r.impact) < 12).length;
        const lowRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) < 6).length;
        
        // Calculate treated vs untreated
        const treatedRiskIds = new Set(this.getActiveData().treatments.filter(t => t.status === 'Completed').map(t => t.riskId));
        const treatedRisks = this.getActiveData().risks.filter(r => treatedRiskIds.has(r.id)).length;
        const untreatedRisks = totalRisks - treatedRisks;
        
        // Risk by category
        const risksByCategory = {};
        this.getActiveData().risks.forEach(r => {
            const cat = r.category || 'Uncategorized';
            risksByCategory[cat] = (risksByCategory[cat] || 0) + 1;
        });
        
        // Average risk score
        const avgInherentScore = totalRisks > 0 ? 
            (this.getActiveData().risks.reduce((sum, r) => sum + (r.likelihood * r.impact), 0) / totalRisks).toFixed(1) : 0;
        
        // Calculate average residual score
        let totalResidualScore = 0;
        this.getActiveData().risks.forEach(r => {
            const treatment = this.getActiveData().treatments.find(t => t.riskId === r.id && t.status === 'Completed');
            let resL = r.likelihood, resI = r.impact;
            if (treatment) {
                if (treatment.type === 'Mitigate' || treatment.type === 'Transfer') {
                    resL = Math.max(1, r.likelihood - 1);
                    resI = Math.max(1, r.impact - 1);
                } else if (treatment.type === 'Avoid') {
                    resL = Math.max(1, r.likelihood - 2);
                    resI = Math.max(1, r.impact - 2);
                }
            }
            totalResidualScore += resL * resI;
        });
        const avgResidualScore = totalRisks > 0 ? (totalResidualScore / totalRisks).toFixed(1) : 0;
        
        c.innerHTML = `
            <div class="welcome-banner" style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 8px;"><i class="bi bi-grid-3x3-gap-fill"></i> Risk Matrix & Analytics</h2>
                <p style="color: var(--text-secondary);">Visualize and analyze your risk landscape with inherent and residual risk heat maps, distribution charts, and key metrics.</p>
            </div>
            
            <!-- Risk Summary Stats -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-icon blue"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="metric-value">${totalRisks}</div>
                    <div class="metric-label">Total Risks</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon red"><i class="bi bi-exclamation-octagon-fill"></i></div>
                    <div class="metric-value">${criticalRisks}</div>
                    <div class="metric-label">Critical</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon amber"><i class="bi bi-exclamation-diamond"></i></div>
                    <div class="metric-value">${highRisks}</div>
                    <div class="metric-label">High</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon green"><i class="bi bi-shield-check"></i></div>
                    <div class="metric-value">${treatedRisks}/${totalRisks}</div>
                    <div class="metric-label">Treated</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon purple"><i class="bi bi-graph-down-arrow"></i></div>
                    <div class="metric-value">${avgInherentScore} → ${avgResidualScore}</div>
                    <div class="metric-label">Avg Score</div>
                </div>
            </div>
            
            <!-- Heat Maps Row -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-bottom: 24px;">
                <!-- Inherent Risk Matrix -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--accent-red-soft), transparent);">
                        <div class="card-title"><i class="bi bi-grid-3x3"></i> Inherent Risk Heat Map</div>
                        <span class="badge badge-red">Before Controls</span>
                    </div>
                    <div class="card-body">
                        <div class="risk-matrix">
                            <div class="risk-matrix-cell risk-matrix-header"></div>
                            ${[1,2,3,4,5].map(l => `<div class="risk-matrix-cell risk-matrix-header">L${l}</div>`).join('')}
                            ${[5,4,3,2,1].map(i => `
                                <div class="risk-matrix-cell risk-matrix-header">I${i}</div>
                                ${[1,2,3,4,5].map(l => { 
                                    const risks = inherentMatrix[5-i][l-1]; 
                                    return `<div class="risk-matrix-cell ${getCellClass(l, i)}" title="${risks.length} risk(s) at L${l}/I${i}">${risks.length > 0 ? `<span style="font-size:16px;font-weight:600;">${risks.length}</span>` : ''}</div>`; 
                                }).join('')}
                            `).join('')}
                        </div>
                        <div style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">
                            <strong>Inherent Risk:</strong> Risk level before any controls or treatments are applied.
                        </div>
                    </div>
                </div>
                
                <!-- Residual Risk Matrix -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--accent-green-soft), transparent);">
                        <div class="card-title"><i class="bi bi-grid-3x3"></i> Residual Risk Heat Map</div>
                        <span class="badge badge-green">After Treatments</span>
                    </div>
                    <div class="card-body">
                        <div class="risk-matrix">
                            <div class="risk-matrix-cell risk-matrix-header"></div>
                            ${[1,2,3,4,5].map(l => `<div class="risk-matrix-cell risk-matrix-header">L${l}</div>`).join('')}
                            ${[5,4,3,2,1].map(i => `
                                <div class="risk-matrix-cell risk-matrix-header">I${i}</div>
                                ${[1,2,3,4,5].map(l => { 
                                    const risks = residualMatrix[5-i][l-1]; 
                                    return `<div class="risk-matrix-cell ${getCellClass(l, i)}" title="${risks.length} risk(s) at L${l}/I${i} (residual)">${risks.length > 0 ? `<span style="font-size:16px;font-weight:600;">${risks.length}</span>` : ''}</div>`; 
                                }).join('')}
                            `).join('')}
                        </div>
                        <div style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">
                            <strong>Residual Risk:</strong> Risk level after completed treatments are applied.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-body" style="padding: 16px;">
                    <div class="chart-legend" style="justify-content: flex-start; flex-wrap: wrap; gap: 16px;">
                        <div class="legend-item"><div class="legend-dot" style="background:#4ade80; width: 20px; height: 20px;"></div>Low (1-5)</div>
                        <div class="legend-item"><div class="legend-dot" style="background:#fbbf24; width: 20px; height: 20px;"></div>Medium (6-11)</div>
                        <div class="legend-item"><div class="legend-dot" style="background:#fb923c; width: 20px; height: 20px;"></div>High (12-19)</div>
                        <div class="legend-item"><div class="legend-dot" style="background:#f87171; width: 20px; height: 20px;"></div>Critical (20-25)</div>
                        <div style="margin-left: auto; font-size: 12px; color: var(--text-muted);">
                            <strong>L</strong> = Likelihood (1-5) | <strong>I</strong> = Impact (1-5) | <strong>Score</strong> = L × I
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); margin-bottom: 24px;">
                <!-- Risk Distribution Chart -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="bi bi-pie-chart"></i> Risk Distribution by Severity</div>
                    </div>
                    <div class="card-body">
                        ${totalRisks > 0 ? `
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <div style="position: relative; width: 160px; height: 160px;">
                                    <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                        ${this.renderDonutChart([
                                            { value: criticalRisks, color: '#f87171' },
                                            { value: highRisks, color: '#fb923c' },
                                            { value: mediumRisks, color: '#fbbf24' },
                                            { value: lowRisks, color: '#4ade80' }
                                        ], totalRisks)}
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700;">${totalRisks}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Total</div>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; background: #f87171; border-radius: 2px; margin-right: 8px;"></span>Critical</span>
                                            <span style="font-size: 13px; font-weight: 600;">${criticalRisks}</span>
                                        </div>
                                        <div class="progress-bar" style="height: 6px;"><div class="progress-fill red" style="width: ${totalRisks > 0 ? (criticalRisks/totalRisks*100) : 0}%;"></div></div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; background: #fb923c; border-radius: 2px; margin-right: 8px;"></span>High</span>
                                            <span style="font-size: 13px; font-weight: 600;">${highRisks}</span>
                                        </div>
                                        <div class="progress-bar" style="height: 6px;"><div class="progress-fill amber" style="width: ${totalRisks > 0 ? (highRisks/totalRisks*100) : 0}%;"></div></div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; background: #fbbf24; border-radius: 2px; margin-right: 8px;"></span>Medium</span>
                                            <span style="font-size: 13px; font-weight: 600;">${mediumRisks}</span>
                                        </div>
                                        <div class="progress-bar" style="height: 6px;"><div class="progress-fill amber" style="width: ${totalRisks > 0 ? (mediumRisks/totalRisks*100) : 0}%;"></div></div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 13px;"><span style="display: inline-block; width: 12px; height: 12px; background: #4ade80; border-radius: 2px; margin-right: 8px;"></span>Low</span>
                                            <span style="font-size: 13px; font-weight: 600;">${lowRisks}</span>
                                        </div>
                                        <div class="progress-bar" style="height: 6px;"><div class="progress-fill green" style="width: ${totalRisks > 0 ? (lowRisks/totalRisks*100) : 0}%;"></div></div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="bi bi-pie-chart" style="font-size: 48px; opacity: 0.3;"></i>
                                <p style="margin-top: 12px;">Add risks to see distribution</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Risk by Category -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="bi bi-bar-chart"></i> Risks by Category</div>
                    </div>
                    <div class="card-body">
                        ${Object.keys(risksByCategory).length > 0 ? `
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${Object.entries(risksByCategory).sort((a,b) => b[1] - a[1]).slice(0, 8).map(([cat, count]) => `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="font-size: 13px;">${cat}</span>
                                            <span style="font-size: 13px; font-weight: 600;">${count}</span>
                                        </div>
                                        <div class="progress-bar" style="height: 8px;">
                                            <div class="progress-fill blue" style="width: ${totalRisks > 0 ? (count/totalRisks*100) : 0}%;"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="bi bi-bar-chart" style="font-size: 48px; opacity: 0.3;"></i>
                                <p style="margin-top: 12px;">Add risks with categories</p>
                            </div>
                        `}
                    </div>
                </div>
            </div>
            
            <!-- Treatment Status & Risk Reduction -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); margin-bottom: 24px;">
                <!-- Treatment Status -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="bi bi-bandaid"></i> Treatment Status</div>
                    </div>
                    <div class="card-body">
                        ${totalRisks > 0 ? `
                            <div style="display: flex; gap: 24px; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md);">
                                        <div style="text-align: center;">
                                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${treatedRisks}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">Treated</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${untreatedRisks}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">Untreated</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${totalRisks > 0 ? Math.round(treatedRisks/totalRisks*100) : 0}%</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">Coverage</div>
                                        </div>
                                    </div>
                                    <div class="progress-bar" style="height: 12px;">
                                        <div class="progress-fill green" style="width: ${totalRisks > 0 ? (treatedRisks/totalRisks*100) : 0}%;"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text-muted);">
                                        <span>0%</span>
                                        <span>Treatment Coverage</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="bi bi-bandaid" style="font-size: 48px; opacity: 0.3;"></i>
                                <p style="margin-top: 12px;">Add risks and treatments</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Risk Reduction Impact -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="bi bi-graph-down-arrow"></i> Risk Reduction Impact</div>
                    </div>
                    <div class="card-body">
                        ${totalRisks > 0 ? `
                            <div style="padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md); margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 24px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Inherent Score</div>
                                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-red);">${avgInherentScore}</div>
                                    </div>
                                    <div style="font-size: 24px; color: var(--text-muted);">→</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Residual Score</div>
                                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-green);">${avgResidualScore}</div>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 13px; color: var(--text-muted);">Risk Reduction</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">
                                    ${avgInherentScore > 0 ? Math.round((1 - avgResidualScore/avgInherentScore) * 100) : 0}%
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                    ${avgInherentScore > avgResidualScore ? 'Treatments are effectively reducing risk exposure' : 'Complete more treatments to reduce risk'}
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="bi bi-graph-down-arrow" style="font-size: 48px; opacity: 0.3;"></i>
                                <p style="margin-top: 12px;">Add risks and treatments to see impact</p>
                            </div>
                        `}
                    </div>
                </div>
            </div>
            
            <!-- Risk List -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="bi bi-list-ul"></i> Risk Details</div>
                    <button class="btn btn-ghost btn-sm" onclick="app.switchTab('risks')"><i class="bi bi-arrow-right"></i> View All Risks</button>
                </div>
                <div class="card-body">
                    ${this.getActiveData().risks.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Risk</th>
                                    <th>Category</th>
                                    <th style="text-align: center;">Inherent</th>
                                    <th style="text-align: center;">Residual</th>
                                    <th>Treatment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.getActiveData().risks.slice(0, 10).map(r => {
                                    const inherentScore = r.likelihood * r.impact;
                                    const treatment = this.getActiveData().treatments.find(t => t.riskId === r.id && t.status === 'Completed');
                                    let resL = r.likelihood, resI = r.impact;
                                    if (treatment) {
                                        if (treatment.type === 'Mitigate' || treatment.type === 'Transfer') {
                                            resL = Math.max(1, r.likelihood - 1);
                                            resI = Math.max(1, r.impact - 1);
                                        } else if (treatment.type === 'Avoid') {
                                            resL = Math.max(1, r.likelihood - 2);
                                            resI = Math.max(1, r.impact - 2);
                                        }
                                    }
                                    const residualScore = resL * resI;
                                    const getScoreBadge = (score) => {
                                        if (score >= 20) return 'red';
                                        if (score >= 12) return 'amber';
                                        if (score >= 6) return 'amber';
                                        return 'green';
                                    };
                                    return `<tr>
                                        <td class="font-semibold">${r.title}</td>
                                        <td><span class="badge badge-blue">${r.category || 'N/A'}</span></td>
                                        <td style="text-align: center;"><span class="badge badge-${getScoreBadge(inherentScore)}">${inherentScore}</span></td>
                                        <td style="text-align: center;"><span class="badge badge-${getScoreBadge(residualScore)}">${residualScore}</span></td>
                                        <td>${treatment ? `<span class="badge badge-green">${treatment.type}</span>` : '<span class="badge" style="background: var(--bg-elevated);">None</span>'}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                        ${this.getActiveData().risks.length > 10 ? `<div style="text-align: center; margin-top: 12px; color: var(--text-muted); font-size: 13px;">Showing 10 of ${this.getActiveData().risks.length} risks</div>` : ''}
                    ` : `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="bi bi-exclamation-triangle" style="font-size: 48px; opacity: 0.3;"></i>
                            <p style="margin-top: 12px;">No risks recorded yet. Add risks in the Risk Register.</p>
                            <button class="btn btn-primary btn-sm" style="margin-top: 16px;" onclick="app.switchTab('risks')"><i class="bi bi-plus-lg"></i> Add Risks</button>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    renderDonutChart(segments, total) {
        if (total === 0) return '';
        let currentOffset = 0;
        return segments.map(seg => {
            const percent = (seg.value / total) * 100;
            const circumference = 100;
            const dash = (percent / 100) * circumference;
            const gap = circumference - dash;
            const offset = -currentOffset;
            currentOffset += dash;
            if (seg.value === 0) return '';
            return `<circle cx="18" cy="18" r="15.9155" fill="none" stroke="${seg.color}" stroke-width="3" stroke-dasharray="${dash} ${gap}" stroke-dashoffset="${offset}"/>`;
        }).join('');
    }
    renderIssues() {
        const c = document.getElementById('tab-issues');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Issue Tracker</h3><button class="btn btn-primary btn-sm" onclick="app.showIssueModal()"><i class="bi bi-plus-lg"></i> Add Issue</button></div>${this.getActiveData().issues.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Category</th><th>Severity</th><th>Status</th><th>Owner</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().issues.map(i => `<tr><td><span class="font-mono text-muted">${i.id}</span></td><td class="font-semibold">${i.title}</td><td><span class="badge badge-blue">${i.category}</span></td><td><span class="badge badge-${i.severity === 'Critical' ? 'red' : i.severity === 'High' ? 'amber' : 'green'}">${i.severity}</span></td><td><span class="badge badge-${i.status === 'Closed' ? 'green' : i.status === 'In Progress' ? 'amber' : 'red'}">${i.status}</span></td><td>${i.owner}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editIssue('${i.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('issues','${i.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-bug', 'No Issues Yet', 'Track compliance and security issues.', 'showIssueModal')}</div>`;
    }
    showIssueModal(i = null) {
        const isEdit = i !== null;
        openModal(isEdit ? 'Edit Issue' : 'Add Issue', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${i?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="f-category">${['Process Gap', 'Compliance Issue', 'Technical Debt', 'Security Gap'].map(c => `<option value="${c}" ${i?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="f-severity">${['Critical', 'High', 'Medium', 'Low'].map(s => `<option value="${s}" ${i?.severity === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Open', 'In Progress', 'Closed'].map(s => `<option value="${s}" ${i?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${i?.owner || ''}"></div></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${i?.dueDate?.split('T')[0] || ''}"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${i?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveIssue('${i?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveIssue(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('ISS'), title, category: document.getElementById('f-category').value, severity: document.getElementById('f-severity').value, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, dueDate: document.getElementById('f-due').value || null, description: document.getElementById('f-desc').value, createdAt: editId ? this.getActiveData().issues.find(i => i.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().issues.findIndex(i => i.id === editId); if (idx !== -1) this.getActiveData().issues[idx] = item; } else { this.getActiveData().issues.push(item); }
        this.saveData('issues'); closeModal(); this.renderIssues(); this.toast(editId ? 'Issue updated' : 'Issue created', 'success');
    }
    editIssue(id) { const i = this.getActiveData().issues.find(x => x.id === id); if (i) this.showIssueModal(i); }
    renderIncidents() {
        const c = document.getElementById('tab-incidents');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Incident Log</h3><button class="btn btn-primary btn-sm" onclick="app.showIncidentModal()"><i class="bi bi-plus-lg"></i> Add Incident</button></div>${this.getActiveData().incidents.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Severity</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().incidents.map(i => `<tr><td><span class="font-mono text-muted">${i.id}</span></td><td class="font-semibold">${i.title}</td><td><span class="badge badge-blue">${i.type}</span></td><td><span class="badge badge-${i.severity === 'Critical' ? 'red' : i.severity === 'High' ? 'amber' : 'green'}">${i.severity}</span></td><td><span class="badge badge-${i.status === 'Resolved' ? 'green' : 'amber'}">${i.status}</span></td><td>${i.date ? new Date(i.date).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editIncident('${i.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('incidents','${i.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-lightning', 'No Incidents Yet', 'Log security and operational incidents.', 'showIncidentModal')}</div>`;
    }
    showIncidentModal(i = null) {
        const isEdit = i !== null;
        openModal(isEdit ? 'Edit Incident' : 'Add Incident', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${i?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Security', 'Availability', 'Phishing', 'Data Breach', 'Other'].map(t => `<option value="${t}" ${i?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="f-severity">${['Critical', 'High', 'Medium', 'Low'].map(s => `<option value="${s}" ${i?.severity === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Investigating', 'Resolved'].map(s => `<option value="${s}" ${i?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="f-date" value="${i?.date?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${i?.owner || ''}"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${i?.description || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveIncident('${i?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveIncident(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('INC'), title, type: document.getElementById('f-type').value, severity: document.getElementById('f-severity').value, status: document.getElementById('f-status').value, date: document.getElementById('f-date').value || null, owner: document.getElementById('f-owner').value, description: document.getElementById('f-desc').value, createdAt: editId ? this.getActiveData().incidents.find(i => i.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().incidents.findIndex(i => i.id === editId); if (idx !== -1) this.getActiveData().incidents[idx] = item; } else { this.getActiveData().incidents.push(item); }
        this.saveData('incidents'); closeModal(); this.renderIncidents(); this.toast(editId ? 'Incident updated' : 'Incident logged', 'success');
    }
    editIncident(id) { const i = this.getActiveData().incidents.find(x => x.id === id); if (i) this.showIncidentModal(i); }
    renderTasks() {
        const c = document.getElementById('tab-tasks');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Task Management</h3><button class="btn btn-primary btn-sm" onclick="app.showTaskModal()"><i class="bi bi-plus-lg"></i> Add Task</button></div>${this.getActiveData().tasks.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().tasks.map(t => `<tr><td><span class="font-mono text-muted">${t.id}</span></td><td class="font-semibold">${t.title}</td><td><span class="badge badge-${t.priority === 'Critical' ? 'red' : t.priority === 'High' ? 'amber' : 'blue'}">${t.priority}</span></td><td><span class="badge badge-${t.status === 'Completed' ? 'green' : t.status === 'In Progress' ? 'amber' : 'gray'}">${t.status}</span></td><td>${t.assignee}</td><td>${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editTask('${t.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('tasks','${t.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-check2-square', 'No Tasks Yet', 'Track remediation and action items.', 'showTaskModal')}</div>`;
    }
    showTaskModal(t = null) {
        const isEdit = t !== null;
        openModal(isEdit ? 'Edit Task' : 'Add Task', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${t?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="f-priority">${['Critical', 'High', 'Medium', 'Low'].map(p => `<option value="${p}" ${t?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Not Started', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${t?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Assignee</label><input type="text" class="form-input" id="f-assignee" value="${t?.assignee || ''}"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${t?.dueDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes">${t?.notes || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveTask('${t?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveTask(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('TSK'), title, priority: document.getElementById('f-priority').value, status: document.getElementById('f-status').value, assignee: document.getElementById('f-assignee').value, dueDate: document.getElementById('f-due').value || null, notes: document.getElementById('f-notes').value, createdAt: editId ? this.getActiveData().tasks.find(t => t.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().tasks.findIndex(t => t.id === editId); if (idx !== -1) this.getActiveData().tasks[idx] = item; } else { this.getActiveData().tasks.push(item); }
        this.saveData('tasks'); closeModal(); this.renderTasks(); this.toast(editId ? 'Task updated' : 'Task created', 'success');
    }
    editTask(id) { const t = this.getActiveData().tasks.find(x => x.id === id); if (t) this.showTaskModal(t); }
    renderAudits() {
        const c = document.getElementById('tab-audits');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Audit Schedule</h3><button class="btn btn-primary btn-sm" onclick="app.showAuditModal()"><i class="bi bi-plus-lg"></i> Add Audit</button></div>${this.getActiveData().audits.length > 0 ? `<table><thead><tr><th>ID</th><th>Audit Name</th><th>Type</th><th>Status</th><th>Lead</th><th>Start Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().audits.map(a => `<tr><td><span class="font-mono text-muted">${a.id}</span></td><td class="font-semibold">${a.name}</td><td><span class="fw-badge fw-${a.type.toLowerCase().replace(/\s/g, '')}">${a.type}</span></td><td><span class="badge badge-${a.status === 'Completed' ? 'green' : a.status === 'In Progress' ? 'amber' : 'blue'}">${a.status}</span></td><td>${a.lead}</td><td>${a.startDate ? new Date(a.startDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editAudit('${a.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('audits','${a.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-clipboard-check', 'No Audits Yet', 'Schedule and track audits.', 'showAuditModal')}</div>`;
    }
    showAuditModal(a = null) {
        const isEdit = a !== null;
        openModal(isEdit ? 'Edit Audit' : 'Add Audit', `<div class="form-group"><label class="form-label">Audit Name *</label><input type="text" class="form-input" id="f-name" value="${a?.name || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['SOC 2', 'ISO 27001', 'PCI DSS', 'HIPAA', 'Internal', 'GDPR'].map(t => `<option value="${t}" ${a?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Planned', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${a?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Lead</label><input type="text" class="form-input" id="f-lead" value="${a?.lead || ''}"></div><div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="f-start" value="${a?.startDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Scope</label><textarea class="form-textarea" id="f-scope">${a?.scope || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveAudit('${a?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveAudit(editId) {
        const name = document.getElementById('f-name').value.trim();
        if (!name) { this.toast('Please enter name', 'error'); return; }
        const item = { id: editId || this.generateId('AUD'), name, type: document.getElementById('f-type').value, status: document.getElementById('f-status').value, lead: document.getElementById('f-lead').value, startDate: document.getElementById('f-start').value || null, scope: document.getElementById('f-scope').value, createdAt: editId ? this.getActiveData().audits.find(a => a.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().audits.findIndex(a => a.id === editId); if (idx !== -1) this.getActiveData().audits[idx] = item; } else { this.getActiveData().audits.push(item); }
        this.saveData('audits'); closeModal(); this.renderAudits(); this.toast(editId ? 'Audit updated' : 'Audit scheduled', 'success');
    }
    editAudit(id) { const a = this.getActiveData().audits.find(x => x.id === id); if (a) this.showAuditModal(a); }
    renderEvidence() {
        const c = document.getElementById('tab-evidence');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Evidence Library</h3><button class="btn btn-primary btn-sm" onclick="app.showEvidenceModal()"><i class="bi bi-plus-lg"></i> Add Evidence</button></div>${this.getActiveData().evidence.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Related To</th><th>Owner</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().evidence.map(e => `<tr><td><span class="font-mono text-muted">${e.id}</span></td><td class="font-semibold">${e.title}</td><td><span class="badge badge-blue">${e.type}</span></td><td>${e.relatedTo || '-'}</td><td>${e.owner}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editEvidence('${e.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('evidence','${e.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-folder2-open', 'No Evidence Yet', 'Upload and organize audit evidence.', 'showEvidenceModal')}</div>`;
    }
    showEvidenceModal(e = null) {
        const isEdit = e !== null;
        openModal(isEdit ? 'Edit Evidence' : 'Add Evidence', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${e?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type">${['Screenshot', 'Document', 'Report', 'Export', 'Configuration', 'Log'].map(t => `<option value="${t}" ${e?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Related Control</label><select class="form-select" id="f-related"><option value="">-- None --</option>${this.getActiveData().controls.map(c => `<option value="${c.id}" ${e?.relatedTo === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${e?.owner || ''}"></div><div class="form-group"><label class="form-label">URL/Location</label><input type="text" class="form-input" id="f-url" value="${e?.url || ''}"></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes">${e?.notes || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveEvidence('${e?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveEvidence(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('EVD'), title, type: document.getElementById('f-type').value, relatedTo: document.getElementById('f-related').value || null, owner: document.getElementById('f-owner').value, url: document.getElementById('f-url').value, notes: document.getElementById('f-notes').value, createdAt: editId ? this.getActiveData().evidence.find(e => e.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().evidence.findIndex(e => e.id === editId); if (idx !== -1) this.getActiveData().evidence[idx] = item; } else { this.getActiveData().evidence.push(item); }
        this.saveData('evidence'); closeModal(); this.renderEvidence(); this.toast(editId ? 'Evidence updated' : 'Evidence added', 'success');
    }
    editEvidence(id) { const e = this.getActiveData().evidence.find(x => x.id === id); if (e) this.showEvidenceModal(e); }
    renderTesting() {
        const c = document.getElementById('tab-testing');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Control Testing</h3><button class="btn btn-primary btn-sm" onclick="app.showTestModal()"><i class="bi bi-plus-lg"></i> Add Test</button></div>${this.getActiveData().controlTests.length > 0 ? `<table><thead><tr><th>ID</th><th>Control</th><th>Test Date</th><th>Result</th><th>Tester</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().controlTests.map(t => { const ctrl = this.getActiveData().controls.find(c => c.id === t.controlId); return `<tr><td><span class="font-mono text-muted">${t.id}</span></td><td>${ctrl?.name || t.controlId}</td><td>${t.testDate ? new Date(t.testDate).toLocaleDateString() : '-'}</td><td><span class="badge badge-${t.result === 'Pass' ? 'green' : t.result === 'Fail' ? 'red' : 'amber'}">${t.result}</span></td><td>${t.tester}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editTest('${t.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('controlTests','${t.id}')"><i class="bi bi-trash3"></i></button></td></tr>`; }).join('')}</tbody></table>` : this.renderEmpty('bi-card-checklist', 'No Tests Yet', 'Document control testing results.', 'showTestModal')}</div>`;
    }
    showTestModal(t = null) {
        const isEdit = t !== null;
        openModal(isEdit ? 'Edit Test' : 'Record Test', `<div class="form-group"><label class="form-label">Control *</label><select class="form-select" id="test-control"><option value="">-- Select Control --</option>${this.getActiveData().controls.map(c => `<option value="${c.id}" ${t?.controlId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Test Date</label><input type="date" class="form-input" id="test-date" value="${t?.testDate?.split('T')[0] || ''}"></div><div class="form-group"><label class="form-label">Result</label><select class="form-select" id="test-result">${['Pass', 'Partial', 'Fail'].map(r => `<option value="${r}" ${t?.result === r ? 'selected' : ''}>${r}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Tester</label><input type="text" class="form-input" id="test-tester" value="${t?.tester || ''}"></div><div class="form-group"><label class="form-label">Procedure/Notes</label><textarea class="form-textarea" id="test-procedure">${t?.procedure || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveTest('${t?.id || ''}')">${isEdit ? 'Update' : 'Save'}</button>`);
    }
    saveTest(editId) {
        const controlId = document.getElementById('test-control').value;
        if (!controlId) { this.toast('Please select a control', 'error'); return; }
        const item = { id: editId || this.generateId('TST'), controlId, testDate: document.getElementById('test-date').value || null, result: document.getElementById('test-result').value, tester: document.getElementById('test-tester').value, procedure: document.getElementById('test-procedure').value, createdAt: editId ? this.getActiveData().controlTests.find(t => t.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().controlTests.findIndex(t => t.id === editId); if (idx !== -1) this.getActiveData().controlTests[idx] = item; } else { this.getActiveData().controlTests.push(item); }
        this.saveData('controlTests'); closeModal(); this.renderTesting(); this.toast(editId ? 'Test updated' : 'Test saved', 'success');
    }
    editTest(id) { const t = this.getActiveData().controlTests.find(x => x.id === id); if (t) this.showTestModal(t); }
    renderFindings() {
        const c = document.getElementById('tab-findings');
        c.innerHTML = `<div class="table-container"><div class="table-header"><h3 class="table-title">Audit Findings</h3><button class="btn btn-primary btn-sm" onclick="app.showFindingModal()"><i class="bi bi-plus-lg"></i> Add Finding</button></div>${this.getActiveData().findings.length > 0 ? `<table><thead><tr><th>ID</th><th>Title</th><th>Severity</th><th>Status</th><th>Owner</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>${this.getActiveData().findings.map(f => `<tr><td><span class="font-mono text-muted">${f.id}</span></td><td class="font-semibold">${f.title}</td><td><span class="badge badge-${f.severity === 'Critical' ? 'red' : f.severity === 'High' ? 'amber' : 'green'}">${f.severity}</span></td><td><span class="badge badge-${f.status === 'Closed' ? 'green' : f.status === 'In Progress' ? 'amber' : 'red'}">${f.status}</span></td><td>${f.owner}</td><td>${f.dueDate ? new Date(f.dueDate).toLocaleDateString() : '-'}</td><td><button class="btn btn-ghost btn-sm" onclick="app.editFinding('${f.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-ghost btn-sm" onclick="app.deleteItem('findings','${f.id}')"><i class="bi bi-trash3"></i></button></td></tr>`).join('')}</tbody></table>` : this.renderEmpty('bi-search', 'No Findings Yet', 'Document audit findings.', 'showFindingModal')}</div>`;
    }
    showFindingModal(f = null) {
        const isEdit = f !== null;
        openModal(isEdit ? 'Edit Finding' : 'Add Finding', `<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="f-title" value="${f?.title || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Severity</label><select class="form-select" id="f-severity">${['Critical', 'High', 'Medium', 'Low'].map(s => `<option value="${s}" ${f?.severity === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status">${['Open', 'In Progress', 'Closed'].map(s => `<option value="${s}" ${f?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="f-owner" value="${f?.owner || ''}"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="f-due" value="${f?.dueDate?.split('T')[0] || ''}"></div></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f-desc">${f?.description || ''}</textarea></div><div class="form-group"><label class="form-label">Recommendation</label><textarea class="form-textarea" id="f-rec">${f?.recommendation || ''}</textarea></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="app.saveFinding('${f?.id || ''}')">${isEdit ? 'Update' : 'Create'}</button>`);
    }
    saveFinding(editId) {
        const title = document.getElementById('f-title').value.trim();
        if (!title) { this.toast('Please enter title', 'error'); return; }
        const item = { id: editId || this.generateId('FND'), title, severity: document.getElementById('f-severity').value, status: document.getElementById('f-status').value, owner: document.getElementById('f-owner').value, dueDate: document.getElementById('f-due').value || null, description: document.getElementById('f-desc').value, recommendation: document.getElementById('f-rec').value, createdAt: editId ? this.getActiveData().findings.find(f => f.id === editId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
        if (editId) { const idx = this.getActiveData().findings.findIndex(f => f.id === editId); if (idx !== -1) this.getActiveData().findings[idx] = item; } else { this.getActiveData().findings.push(item); }
        this.saveData('findings'); closeModal(); this.renderFindings(); this.toast(editId ? 'Finding updated' : 'Finding created', 'success');
    }
    editFinding(id) { const f = this.getActiveData().findings.find(x => x.id === id); if (f) this.showFindingModal(f); }
    
    // ==================== STATEMENT OF APPLICABILITY ====================
    renderSoA() {
        const c = document.getElementById('tab-soa');
        
        // Get ISO 27001 Annex A controls from the control library
        const annexAControls = this.getAnnexAControls();
        
        // Map implemented controls to Annex A
        const implementedControlIds = new Set(this.getActiveData().controls.map(ctrl => ctrl.controlId || ctrl.id));
        
        // Calculate SoA statistics - DEFAULT TO NOT APPLICABLE
        const totalAnnexA = annexAControls.length;
        const applicable = annexAControls.filter(ac => {
            const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
            return soaEntry ? soaEntry.applicable : false; // Default to NOT applicable
        }).length;
        const implemented = annexAControls.filter(ac => {
            const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
            const isApplicable = soaEntry ? soaEntry.applicable : false;
            return isApplicable && this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name);
        }).length;
        const notApplicable = totalAnnexA - applicable;
        
        // Group controls by category
        const controlsByCategory = {};
        annexAControls.forEach(ac => {
            const cat = ac.category || 'Other';
            if (!controlsByCategory[cat]) controlsByCategory[cat] = [];
            controlsByCategory[cat].push(ac);
        });
        
        const categories = Object.keys(controlsByCategory).sort();
        const selectedCategory = this.soaSelectedCategory || ''; // Default to ALL categories
        
        c.innerHTML = `
            <div class="welcome-banner" style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 8px;"><i class="bi bi-file-earmark-check-fill"></i> Statement of Applicability (SoA)</h2>
                <p style="color: var(--text-secondary);">The SoA documents which ISO 27001 Annex A controls are applicable to your organization, their implementation status, and justification. Required for ISO 27001 certification.</p>
            </div>
            
            <!-- SoA Overview Stats -->
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-icon blue"><i class="bi bi-list-check"></i></div>
                    <div class="metric-value">${totalAnnexA}</div>
                    <div class="metric-label">Total Annex A Controls</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon green"><i class="bi bi-check-circle"></i></div>
                    <div class="metric-value">${applicable}</div>
                    <div class="metric-label">Applicable</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon purple"><i class="bi bi-shield-fill-check"></i></div>
                    <div class="metric-value">${implemented}</div>
                    <div class="metric-label">Implemented</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon amber"><i class="bi bi-x-circle"></i></div>
                    <div class="metric-value">${notApplicable}</div>
                    <div class="metric-label">Not Applicable</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon cyan"><i class="bi bi-percent"></i></div>
                    <div class="metric-value">${applicable > 0 ? Math.round(implemented/applicable*100) : 0}%</div>
                    <div class="metric-label">Implementation Rate</div>
                </div>
            </div>
            
            <!-- Implementation Progress by Category -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title"><i class="bi bi-bar-chart"></i> Implementation Progress by Category</div>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        ${categories.map(cat => {
                            const catControls = controlsByCategory[cat];
                            const catTotal = catControls.length;
                            const catImplemented = catControls.filter(ac => 
                                this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name)
                            ).length;
                            const catPercent = catTotal > 0 ? Math.round(catImplemented/catTotal*100) : 0;
                            const colorClass = catPercent >= 80 ? 'green' : catPercent >= 50 ? 'amber' : 'red';
                            return `
                                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 500;">${cat}</span>
                                        <span class="badge badge-${colorClass}">${catImplemented}/${catTotal}</span>
                                    </div>
                                    <div class="progress-bar" style="height: 8px;">
                                        <div class="progress-fill ${colorClass}" style="width: ${catPercent}%;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            
            <!-- SoA Table -->
            <div class="card">
                <div class="card-header" style="position: sticky; top: 0; z-index: 20; background: var(--bg-surface); flex-wrap: wrap; gap: 12px;">
                    <div class="card-title"><i class="bi bi-table"></i> Annex A Controls</div>
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-sm ${selectedCategory === '' ? 'btn-primary' : 'btn-secondary'}" onclick="app.filterSoACategory('')">All</button>
                        ${categories.map(cat => `<button class="btn btn-sm ${selectedCategory === cat ? 'btn-primary' : 'btn-secondary'}" onclick="app.filterSoACategory('${cat}')">${cat}</button>`).join('')}
                        <button class="btn btn-sm btn-secondary" onclick="app.exportSoA()" style="margin-left: 8px;"><i class="bi bi-download"></i> Export</button>
                    </div>
                </div>
                <div style="max-height: 600px; overflow-y: auto;">
                    <table style="width: 100%;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr style="background: var(--bg-surface);">
                                <th style="width: 100px; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Control ID</th>
                                <th style="background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Control Name</th>
                                <th style="width: 150px; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Category</th>
                                <th style="width: 100px; text-align: center; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Applicable</th>
                                <th style="width: 120px; text-align: center; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Status</th>
                                <th style="width: 80px; background: var(--bg-surface); padding: 12px; border-bottom: 2px solid var(--border-default);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(selectedCategory ? controlsByCategory[selectedCategory] : annexAControls).map(ac => {
                                const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
                                const isApplicable = soaEntry ? soaEntry.applicable : false; // Default to NOT applicable
                                const isImplemented = isApplicable && this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name);
                                const justification = soaEntry?.justification || '';
                                
                                let statusBadge = '';
                                if (!isApplicable) {
                                    statusBadge = '<span class="badge" style="background: var(--bg-elevated);">N/A</span>';
                                } else if (isImplemented) {
                                    statusBadge = '<span class="badge badge-green">Implemented</span>';
                                } else {
                                    statusBadge = '<span class="badge badge-amber">Gap</span>';
                                }
                                
                                return `
                                    <tr>
                                        <td><span class="font-mono text-muted">${ac.id}</span></td>
                                        <td>
                                            <div class="font-semibold">${ac.name}</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${ac.description?.substring(0, 80) || ''}${ac.description?.length > 80 ? '...' : ''}</div>
                                        </td>
                                        <td><span class="badge badge-blue" style="font-size: 11px;">${ac.category}</span></td>
                                        <td style="text-align: center;">
                                            <button class="btn btn-ghost btn-sm" onclick="app.toggleSoAApplicability('${ac.id}')" title="Toggle applicability">
                                                <i class="bi ${isApplicable ? 'bi-check-circle-fill' : 'bi-x-circle'}" style="color: ${isApplicable ? 'var(--accent-green)' : 'var(--text-muted)'}; font-size: 18px;"></i>
                                            </button>
                                        </td>
                                        <td style="text-align: center;">${statusBadge}</td>
                                        <td>
                                            <button class="btn btn-ghost btn-sm" onclick="app.editSoAEntry('${ac.id}')" title="Edit justification">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            ${!isImplemented && isApplicable ? `
                                                <button class="btn btn-ghost btn-sm" onclick="app.addControlFromSoA('${ac.id}')" title="Add control">
                                                    <i class="bi bi-plus-lg"></i>
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- SoA Legend -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 24px; align-items: center;">
                        <div style="font-size: 13px; font-weight: 600;">Legend:</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-check-circle-fill" style="color: var(--accent-green);"></i>
                            <span style="font-size: 13px;">Applicable</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-x-circle" style="color: var(--text-muted);"></i>
                            <span style="font-size: 13px;">Not Applicable</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="badge badge-green">Implemented</span>
                            <span style="font-size: 13px;">Control is in place</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="badge badge-amber">Gap</span>
                            <span style="font-size: 13px;">Control not yet implemented</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    getAnnexAControls() {
        // ISO 27001:2022 Annex A Controls (93 controls across 4 themes)
        return [
            // Organizational Controls (A.5)
            { id: 'A.5.1', name: 'Policies for information security', category: 'Organizational', description: 'Information security policy and topic-specific policies shall be defined.' },
            { id: 'A.5.2', name: 'Information security roles and responsibilities', category: 'Organizational', description: 'Information security roles and responsibilities shall be defined and allocated.' },
            { id: 'A.5.3', name: 'Segregation of duties', category: 'Organizational', description: 'Conflicting duties and areas of responsibility shall be segregated.' },
            { id: 'A.5.4', name: 'Management responsibilities', category: 'Organizational', description: 'Management shall require personnel to apply information security.' },
            { id: 'A.5.5', name: 'Contact with authorities', category: 'Organizational', description: 'Appropriate contacts with relevant authorities shall be maintained.' },
            { id: 'A.5.6', name: 'Contact with special interest groups', category: 'Organizational', description: 'Contacts with special interest groups shall be maintained.' },
            { id: 'A.5.7', name: 'Threat intelligence', category: 'Organizational', description: 'Information about threats shall be collected and analyzed.' },
            { id: 'A.5.8', name: 'Information security in project management', category: 'Organizational', description: 'Information security shall be integrated into project management.' },
            { id: 'A.5.9', name: 'Inventory of information and assets', category: 'Organizational', description: 'An inventory of information and associated assets shall be maintained.' },
            { id: 'A.5.10', name: 'Acceptable use of information', category: 'Organizational', description: 'Rules for acceptable use shall be identified and documented.' },
            { id: 'A.5.11', name: 'Return of assets', category: 'Organizational', description: 'Personnel shall return assets upon termination.' },
            { id: 'A.5.12', name: 'Classification of information', category: 'Organizational', description: 'Information shall be classified according to security needs.' },
            { id: 'A.5.13', name: 'Labelling of information', category: 'Organizational', description: 'Appropriate labelling procedures shall be developed.' },
            { id: 'A.5.14', name: 'Information transfer', category: 'Organizational', description: 'Information transfer rules and procedures shall be in place.' },
            { id: 'A.5.15', name: 'Access control', category: 'Organizational', description: 'Access control rules shall be established and implemented.' },
            { id: 'A.5.16', name: 'Identity management', category: 'Organizational', description: 'The full lifecycle of identities shall be managed.' },
            { id: 'A.5.17', name: 'Authentication information', category: 'Organizational', description: 'Allocation of authentication information shall be controlled.' },
            { id: 'A.5.18', name: 'Access rights', category: 'Organizational', description: 'Access rights shall be provisioned, reviewed, modified and removed.' },
            { id: 'A.5.19', name: 'Information security in supplier relationships', category: 'Organizational', description: 'Security requirements for supplier relationships shall be defined.' },
            { id: 'A.5.20', name: 'Addressing security in supplier agreements', category: 'Organizational', description: 'Security requirements shall be established with suppliers.' },
            { id: 'A.5.21', name: 'Managing information security in ICT supply chain', category: 'Organizational', description: 'Security in ICT supply chain shall be managed.' },
            { id: 'A.5.22', name: 'Monitoring and review of supplier services', category: 'Organizational', description: 'Supplier service delivery shall be monitored and reviewed.' },
            { id: 'A.5.23', name: 'Information security for cloud services', category: 'Organizational', description: 'Cloud service security shall be managed.' },
            { id: 'A.5.24', name: 'Information security incident management planning', category: 'Organizational', description: 'Incident management shall be planned and prepared.' },
            { id: 'A.5.25', name: 'Assessment and decision on information security events', category: 'Organizational', description: 'Security events shall be assessed and decided upon.' },
            { id: 'A.5.26', name: 'Response to information security incidents', category: 'Organizational', description: 'Information security incidents shall be responded to.' },
            { id: 'A.5.27', name: 'Learning from information security incidents', category: 'Organizational', description: 'Knowledge from incidents shall be used to strengthen controls.' },
            { id: 'A.5.28', name: 'Collection of evidence', category: 'Organizational', description: 'Evidence collection procedures shall be defined and applied.' },
            { id: 'A.5.29', name: 'Information security during disruption', category: 'Organizational', description: 'Security shall be maintained during disruption.' },
            { id: 'A.5.30', name: 'ICT readiness for business continuity', category: 'Organizational', description: 'ICT readiness shall be planned and implemented.' },
            { id: 'A.5.31', name: 'Legal, statutory, regulatory and contractual requirements', category: 'Organizational', description: 'Legal and regulatory requirements shall be identified.' },
            { id: 'A.5.32', name: 'Intellectual property rights', category: 'Organizational', description: 'Intellectual property rights shall be protected.' },
            { id: 'A.5.33', name: 'Protection of records', category: 'Organizational', description: 'Records shall be protected from loss and unauthorized access.' },
            { id: 'A.5.34', name: 'Privacy and protection of PII', category: 'Organizational', description: 'Privacy and PII protection shall be ensured.' },
            { id: 'A.5.35', name: 'Independent review of information security', category: 'Organizational', description: 'Information security shall be independently reviewed.' },
            { id: 'A.5.36', name: 'Compliance with policies, rules and standards', category: 'Organizational', description: 'Compliance shall be regularly reviewed.' },
            { id: 'A.5.37', name: 'Documented operating procedures', category: 'Organizational', description: 'Operating procedures shall be documented and available.' },
            // People Controls (A.6)
            { id: 'A.6.1', name: 'Screening', category: 'People', description: 'Background verification checks shall be carried out.' },
            { id: 'A.6.2', name: 'Terms and conditions of employment', category: 'People', description: 'Employment agreements shall state security responsibilities.' },
            { id: 'A.6.3', name: 'Information security awareness, education and training', category: 'People', description: 'Personnel shall receive appropriate security awareness.' },
            { id: 'A.6.4', name: 'Disciplinary process', category: 'People', description: 'A disciplinary process shall be formalized.' },
            { id: 'A.6.5', name: 'Responsibilities after termination or change', category: 'People', description: 'Security responsibilities shall remain valid after changes.' },
            { id: 'A.6.6', name: 'Confidentiality or non-disclosure agreements', category: 'People', description: 'Confidentiality agreements shall be identified and reviewed.' },
            { id: 'A.6.7', name: 'Remote working', category: 'People', description: 'Security measures for remote working shall be implemented.' },
            { id: 'A.6.8', name: 'Information security event reporting', category: 'People', description: 'Personnel shall report security events promptly.' },
            // Physical Controls (A.7)
            { id: 'A.7.1', name: 'Physical security perimeters', category: 'Physical', description: 'Security perimeters shall be defined and used.' },
            { id: 'A.7.2', name: 'Physical entry', category: 'Physical', description: 'Secure areas shall be protected by entry controls.' },
            { id: 'A.7.3', name: 'Securing offices, rooms and facilities', category: 'Physical', description: 'Physical security shall be designed and implemented.' },
            { id: 'A.7.4', name: 'Physical security monitoring', category: 'Physical', description: 'Premises shall be continuously monitored.' },
            { id: 'A.7.5', name: 'Protecting against physical and environmental threats', category: 'Physical', description: 'Protection against threats shall be designed.' },
            { id: 'A.7.6', name: 'Working in secure areas', category: 'Physical', description: 'Security measures for working in secure areas shall apply.' },
            { id: 'A.7.7', name: 'Clear desk and clear screen', category: 'Physical', description: 'Clear desk and screen rules shall be defined.' },
            { id: 'A.7.8', name: 'Equipment siting and protection', category: 'Physical', description: 'Equipment shall be sited and protected.' },
            { id: 'A.7.9', name: 'Security of assets off-premises', category: 'Physical', description: 'Off-site assets shall be protected.' },
            { id: 'A.7.10', name: 'Storage media', category: 'Physical', description: 'Storage media shall be managed through lifecycle.' },
            { id: 'A.7.11', name: 'Supporting utilities', category: 'Physical', description: 'Supporting utilities shall be protected.' },
            { id: 'A.7.12', name: 'Cabling security', category: 'Physical', description: 'Cables shall be protected from interference.' },
            { id: 'A.7.13', name: 'Equipment maintenance', category: 'Physical', description: 'Equipment shall be maintained correctly.' },
            { id: 'A.7.14', name: 'Secure disposal or re-use of equipment', category: 'Physical', description: 'Equipment shall be securely disposed or re-used.' },
            // Technological Controls (A.8)
            { id: 'A.8.1', name: 'User endpoint devices', category: 'Technological', description: 'Information on endpoint devices shall be protected.' },
            { id: 'A.8.2', name: 'Privileged access rights', category: 'Technological', description: 'Privileged access shall be restricted and managed.' },
            { id: 'A.8.3', name: 'Information access restriction', category: 'Technological', description: 'Access to information shall be restricted.' },
            { id: 'A.8.4', name: 'Access to source code', category: 'Technological', description: 'Read and write access to source code shall be managed.' },
            { id: 'A.8.5', name: 'Secure authentication', category: 'Technological', description: 'Secure authentication technologies shall be implemented.' },
            { id: 'A.8.6', name: 'Capacity management', category: 'Technological', description: 'Resources shall be monitored and adjusted.' },
            { id: 'A.8.7', name: 'Protection against malware', category: 'Technological', description: 'Protection against malware shall be implemented.' },
            { id: 'A.8.8', name: 'Management of technical vulnerabilities', category: 'Technological', description: 'Technical vulnerabilities shall be identified and addressed.' },
            { id: 'A.8.9', name: 'Configuration management', category: 'Technological', description: 'Configurations shall be defined and managed.' },
            { id: 'A.8.10', name: 'Information deletion', category: 'Technological', description: 'Information shall be deleted when no longer required.' },
            { id: 'A.8.11', name: 'Data masking', category: 'Technological', description: 'Data masking shall be used based on access control policy.' },
            { id: 'A.8.12', name: 'Data leakage prevention', category: 'Technological', description: 'Data leakage prevention measures shall be applied.' },
            { id: 'A.8.13', name: 'Information backup', category: 'Technological', description: 'Backup copies shall be maintained and tested.' },
            { id: 'A.8.14', name: 'Redundancy of information processing facilities', category: 'Technological', description: 'Facilities shall have sufficient redundancy.' },
            { id: 'A.8.15', name: 'Logging', category: 'Technological', description: 'Logs shall record activities and security events.' },
            { id: 'A.8.16', name: 'Monitoring activities', category: 'Technological', description: 'Networks, systems and applications shall be monitored.' },
            { id: 'A.8.17', name: 'Clock synchronization', category: 'Technological', description: 'Clocks shall be synchronized to approved time sources.' },
            { id: 'A.8.18', name: 'Use of privileged utility programs', category: 'Technological', description: 'Use of utility programs shall be restricted and controlled.' },
            { id: 'A.8.19', name: 'Installation of software on operational systems', category: 'Technological', description: 'Software installation shall be controlled.' },
            { id: 'A.8.20', name: 'Networks security', category: 'Technological', description: 'Networks shall be managed and controlled.' },
            { id: 'A.8.21', name: 'Security of network services', category: 'Technological', description: 'Security of network services shall be identified.' },
            { id: 'A.8.22', name: 'Segregation of networks', category: 'Technological', description: 'Groups shall be segregated in networks.' },
            { id: 'A.8.23', name: 'Web filtering', category: 'Technological', description: 'Access to external websites shall be managed.' },
            { id: 'A.8.24', name: 'Use of cryptography', category: 'Technological', description: 'Rules for cryptography shall be defined and implemented.' },
            { id: 'A.8.25', name: 'Secure development life cycle', category: 'Technological', description: 'Rules for secure development shall be established.' },
            { id: 'A.8.26', name: 'Application security requirements', category: 'Technological', description: 'Security requirements shall be identified and specified.' },
            { id: 'A.8.27', name: 'Secure system architecture and engineering principles', category: 'Technological', description: 'Secure engineering principles shall be established.' },
            { id: 'A.8.28', name: 'Secure coding', category: 'Technological', description: 'Secure coding principles shall be applied.' },
            { id: 'A.8.29', name: 'Security testing in development and acceptance', category: 'Technological', description: 'Security testing processes shall be defined.' },
            { id: 'A.8.30', name: 'Outsourced development', category: 'Technological', description: 'Outsourced development shall be directed and monitored.' },
            { id: 'A.8.31', name: 'Separation of development, test and production environments', category: 'Technological', description: 'Environments shall be separated and protected.' },
            { id: 'A.8.32', name: 'Change management', category: 'Technological', description: 'Changes shall be subject to change management.' },
            { id: 'A.8.33', name: 'Test information', category: 'Technological', description: 'Test information shall be appropriately protected.' },
            { id: 'A.8.34', name: 'Protection of information systems during audit testing', category: 'Technological', description: 'Audit tests shall be planned and agreed.' }
        ];
    }
    
    filterSoACategory(category) {
        this.soaSelectedCategory = category;
        this.renderSoA();
    }
    
    toggleSoAApplicability(controlId) {
        if (!this.data.soaEntries) this.data.soaEntries = [];
        
        const existing = this.data.soaEntries.find(e => e.controlId === controlId);
        if (existing) {
            existing.applicable = !existing.applicable;
        } else {
            this.data.soaEntries.push({ controlId, applicable: false, justification: '' });
        }
        
        localStorage.setItem('grc_soaEntries', JSON.stringify(this.data.soaEntries));
        this.renderSoA();
    }
    
    editSoAEntry(controlId) {
        const annexAControl = this.getAnnexAControls().find(ac => ac.id === controlId);
        if (!this.data.soaEntries) this.data.soaEntries = [];
        
        const existing = this.data.soaEntries.find(e => e.controlId === controlId);
        const justification = existing?.justification || '';
        const applicable = existing ? existing.applicable : true;
        
        openModal('Edit SoA Entry', `
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--text-muted);">Control ID</div>
                <div style="font-weight: 600;">${controlId}</div>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--text-muted);">Control Name</div>
                <div>${annexAControl?.name || 'Unknown'}</div>
            </div>
            <div class="form-group">
                <label class="form-label">Applicable</label>
                <select class="form-select" id="f-applicable">
                    <option value="true" ${applicable ? 'selected' : ''}>Yes - Applicable</option>
                    <option value="false" ${!applicable ? 'selected' : ''}>No - Not Applicable</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Justification / Notes</label>
                <textarea class="form-textarea" id="f-justification" placeholder="Explain why this control is or is not applicable, implementation notes, etc.">${justification}</textarea>
            </div>
        `, `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="app.saveSoAEntry('${controlId}')">Save</button>
        `);
    }
    
    saveSoAEntry(controlId) {
        if (!this.data.soaEntries) this.data.soaEntries = [];
        
        const applicable = document.getElementById('f-applicable').value === 'true';
        const justification = document.getElementById('f-justification').value;
        
        const existing = this.data.soaEntries.find(e => e.controlId === controlId);
        if (existing) {
            existing.applicable = applicable;
            existing.justification = justification;
        } else {
            this.data.soaEntries.push({ controlId, applicable, justification });
        }
        
        localStorage.setItem('grc_soaEntries', JSON.stringify(this.data.soaEntries));
        closeModal();
        this.renderSoA();
        this.toast('SoA entry updated', 'success');
    }
    
    addControlFromSoA(annexAControlId) {
        const annexAControl = this.getAnnexAControls().find(ac => ac.id === annexAControlId);
        if (!annexAControl) return;
        
        // Pre-fill the control modal with Annex A data
        this.showControlModal({
            controlId: annexAControlId,
            name: annexAControl.name,
            framework: 'ISO 27001',
            ref: annexAControlId,
            description: annexAControl.description,
            effectiveness: 'Not Tested'
        });
    }
    
    exportSoA() {
        const annexAControls = this.getAnnexAControls();
        let csv = 'Control ID,Control Name,Category,Applicable,Status,Justification\n';
        
        annexAControls.forEach(ac => {
            const soaEntry = this.data.soaEntries?.find(e => e.controlId === ac.id);
            const isApplicable = soaEntry ? soaEntry.applicable : true;
            const isImplemented = this.getActiveData().controls.some(c => c.controlId === ac.id || c.name === ac.name);
            const justification = soaEntry?.justification || '';
            
            const status = !isApplicable ? 'Not Applicable' : (isImplemented ? 'Implemented' : 'Gap');
            
            csv += `"${ac.id}","${ac.name}","${ac.category}","${isApplicable ? 'Yes' : 'No'}","${status}","${justification.replace(/"/g, '""')}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `soa-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Statement of Applicability exported', 'success');
    }
    
    renderTraceability() {
        const c = document.getElementById('tab-traceability');
        const d = this.getActiveData();
        
        // Calculate traceability metrics
        const risksWithTreatments = d.risks.filter(r => d.treatments.some(t => t.riskId === r.id)).length;
        const risksWithoutTreatments = d.risks.length - risksWithTreatments;
        const controlsWithEvidence = d.controls.filter(c => d.evidence.some(e => e.controlId === c.id)).length;
        const controlsWithoutEvidence = d.controls.length - controlsWithEvidence;
        const controlsTested = d.controls.filter(c => d.controlTests.some(t => t.controlId === c.id)).length;
        const findingsWithOwner = d.findings.filter(f => f.owner).length;
        
        // Calculate coverage percentages
        const riskCoverage = d.risks.length > 0 ? Math.round((risksWithTreatments / d.risks.length) * 100) : 0;
        const evidenceCoverage = d.controls.length > 0 ? Math.round((controlsWithEvidence / d.controls.length) * 100) : 0;
        const testCoverage = d.controls.length > 0 ? Math.round((controlsTested / d.controls.length) * 100) : 0;
        
        const selectedView = this.traceabilityView || 'overview';
        
        c.innerHTML = `
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-diagram-3"></i> Traceability Matrix</h2>
                <p style="color: var(--text-muted); font-size: 13px;">Track relationships between risks, controls, evidence, and findings across your GRC program.</p>
            </div>
            
            <!-- View Selector Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 16px;">
                <button class="btn ${selectedView === 'overview' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('overview')">
                    <i class="bi bi-grid-3x3-gap"></i> Overview
                </button>
                <button class="btn ${selectedView === 'risk-control' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('risk-control')">
                    <i class="bi bi-arrow-right-circle"></i> Risk → Control
                </button>
                <button class="btn ${selectedView === 'control-evidence' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('control-evidence')">
                    <i class="bi bi-file-earmark-check"></i> Control → Evidence
                </button>
                <button class="btn ${selectedView === 'gaps' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('gaps')">
                    <i class="bi bi-exclamation-triangle"></i> Gap Analysis
                </button>
                <button class="btn ${selectedView === 'flow' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTraceabilityView('flow')">
                    <i class="bi bi-bezier2"></i> Full Flow
                </button>
            </div>
            
            ${this.renderTraceabilityView(selectedView, d, { riskCoverage, evidenceCoverage, testCoverage, risksWithTreatments, risksWithoutTreatments, controlsWithEvidence, controlsWithoutEvidence, controlsTested })}
        `;
    }
    
    setTraceabilityView(view) {
        this.traceabilityView = view;
        this.renderTraceability();
    }
    
    renderTraceabilityView(view, d, stats) {
        switch(view) {
            case 'overview':
                return this.renderTraceabilityOverview(d, stats);
            case 'risk-control':
                return this.renderRiskControlMatrix(d);
            case 'control-evidence':
                return this.renderControlEvidenceMatrix(d);
            case 'gaps':
                return this.renderGapAnalysis(d, stats);
            case 'flow':
                return this.renderFullFlowView(d);
            default:
                return this.renderTraceabilityOverview(d, stats);
        }
    }
    
    renderTraceabilityOverview(d, stats) {
        return `
            <!-- Coverage Metrics -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 12px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent-blue)" stroke-width="10" stroke-dasharray="${stats.riskCoverage * 2.51} 251" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700;">${stats.riskCoverage}%</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Risk Treatment Coverage</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${stats.risksWithTreatments} of ${d.risks.length} risks treated</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 12px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent-green)" stroke-width="10" stroke-dasharray="${stats.evidenceCoverage * 2.51} 251" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700;">${stats.evidenceCoverage}%</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Evidence Coverage</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${stats.controlsWithEvidence} of ${d.controls.length} controls documented</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 12px;">
                            <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-elevated)" stroke-width="10"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent-purple)" stroke-width="10" stroke-dasharray="${stats.testCoverage * 2.51} 251" stroke-linecap="round"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: 700;">${stats.testCoverage}%</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Testing Coverage</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${stats.controlsTested} of ${d.controls.length} controls tested</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding: 20px; text-align: center;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 12px; background: var(--bg-elevated); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-amber);">${d.findings.filter(f => f.status === 'Open').length}</div>
                            </div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600;">Open Findings</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${d.findings.length} total findings</div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <!-- Relationships Summary -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-link-45deg"></i> Relationship Summary</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table style="margin: 0;">
                            <tbody>
                                <tr onclick="app.setTraceabilityView('risk-control')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-blue);"></i> Risks → Treatments</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-blue">${d.treatments.length} links</span></td>
                                </tr>
                                <tr onclick="app.setTraceabilityView('control-evidence')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-green);"></i> Controls → Evidence</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-green">${d.evidence.filter(e => e.controlId).length} links</span></td>
                                </tr>
                                <tr onclick="app.setTraceabilityView('control-evidence')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-purple);"></i> Controls → Tests</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-purple">${d.controlTests.length} links</span></td>
                                </tr>
                                <tr onclick="app.setTraceabilityView('gaps')" style="cursor: pointer;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <td style="padding: 14px 16px;"><i class="bi bi-arrow-right" style="color: var(--accent-amber);"></i> Audits → Findings</td>
                                    <td style="padding: 14px 16px; text-align: right;"><span class="badge badge-amber">${d.findings.length} items</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header" style="padding: 16px;">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-lightning"></i> Quick Actions</span>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-secondary" onclick="app.setTraceabilityView('gaps')" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-search"></i> Run Gap Analysis
                            </button>
                            <button class="btn btn-secondary" onclick="app.exportTraceabilityMatrix()" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-download"></i> Export Traceability Matrix
                            </button>
                            <button class="btn btn-secondary" onclick="app.setTraceabilityView('flow')" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-diagram-3"></i> View Full Flow Diagram
                            </button>
                            <button class="btn btn-secondary" onclick="app.switchTab('reports')" style="justify-content: flex-start; text-align: left;">
                                <i class="bi bi-file-text"></i> Generate Compliance Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    renderRiskControlMatrix(d) {
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-table"></i> Risk → Treatment → Control Mapping</span>
                    <button class="btn btn-secondary btn-sm" onclick="app.exportTraceabilityMatrix()"><i class="bi bi-download"></i> Export</button>
                </div>
                <div class="card-body" style="padding: 0; max-height: 600px; overflow-y: auto;">
                    ${d.risks.length > 0 ? `
                        <table style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: var(--bg-surface); z-index: 10;">
                                <tr>
                                    <th style="padding: 14px 16px; width: 120px;">Risk ID</th>
                                    <th style="padding: 14px 16px;">Risk Title</th>
                                    <th style="padding: 14px 16px; width: 100px; text-align: center;">Score</th>
                                    <th style="padding: 14px 16px;">Treatments</th>
                                    <th style="padding: 14px 16px;">Linked Controls</th>
                                    <th style="padding: 14px 16px; width: 100px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${d.risks.map(risk => {
                                    const treatments = d.treatments.filter(t => t.riskId === risk.id);
                                    const linkedControls = treatments.map(t => d.controls.find(c => c.id === t.controlId)).filter(Boolean);
                                    const score = risk.likelihood * risk.impact;
                                    const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                    const hasTreatment = treatments.length > 0;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                                            <td style="padding: 14px 16px;"><span class="font-mono text-muted">${risk.id}</span></td>
                                            <td style="padding: 14px 16px;">
                                                <div class="font-semibold">${risk.title}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${risk.category}</div>
                                            </td>
                                            <td style="padding: 14px 16px; text-align: center;">
                                                <span class="badge badge-${scoreClass}">${score}</span>
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${treatments.length > 0 ? treatments.map(t => `
                                                    <div style="font-size: 12px; padding: 4px 8px; background: var(--accent-blue-soft); border-radius: 4px; margin-bottom: 4px;">
                                                        <span class="badge badge-${t.type === 'Mitigate' ? 'green' : t.type === 'Transfer' ? 'purple' : t.type === 'Avoid' ? 'amber' : 'gray'}" style="font-size: 9px; margin-right: 4px;">${t.type}</span>
                                                        ${t.description?.substring(0, 30) || 'No description'}...
                                                    </div>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;"><i class="bi bi-exclamation-circle" style="color: var(--accent-red);"></i> No treatment</span>`}
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${linkedControls.length > 0 ? linkedControls.map(c => `
                                                    <span class="badge badge-green" style="margin-right: 4px; margin-bottom: 4px; font-size: 10px;">${c.name.substring(0, 20)}...</span>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;">-</span>`}
                                            </td>
                                            <td style="padding: 14px 16px; text-align: center;">
                                                <span class="badge badge-${hasTreatment ? 'green' : 'red'}">${hasTreatment ? 'Mapped' : 'Gap'}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <i class="bi bi-diagram-3" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <p style="font-size: 14px; margin-bottom: 16px;">No risks to display</p>
                            <button class="btn btn-primary" onclick="app.switchTab('risks')"><i class="bi bi-plus"></i> Add Risks</button>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    renderControlEvidenceMatrix(d) {
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-table"></i> Control → Evidence → Test Mapping</span>
                    <button class="btn btn-secondary btn-sm" onclick="app.exportTraceabilityMatrix()"><i class="bi bi-download"></i> Export</button>
                </div>
                <div class="card-body" style="padding: 0; max-height: 600px; overflow-y: auto;">
                    ${d.controls.length > 0 ? `
                        <table style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: var(--bg-surface); z-index: 10;">
                                <tr>
                                    <th style="padding: 14px 16px; width: 120px;">Control ID</th>
                                    <th style="padding: 14px 16px;">Control Name</th>
                                    <th style="padding: 14px 16px; width: 120px;">Framework</th>
                                    <th style="padding: 14px 16px;">Evidence</th>
                                    <th style="padding: 14px 16px;">Tests</th>
                                    <th style="padding: 14px 16px; width: 120px; text-align: center;">Effectiveness</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${d.controls.map(ctrl => {
                                    const evidence = d.evidence.filter(e => e.controlId === ctrl.id);
                                    const tests = d.controlTests.filter(t => t.controlId === ctrl.id);
                                    const hasEvidence = evidence.length > 0;
                                    const hasTested = tests.length > 0;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                                            <td style="padding: 14px 16px;"><span class="font-mono text-muted">${ctrl.id}</span></td>
                                            <td style="padding: 14px 16px;">
                                                <div class="font-semibold">${ctrl.name}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${ctrl.ref || 'No reference'}</div>
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                <span class="badge badge-${this.getFrameworkColor(ctrl.framework)}">${ctrl.framework}</span>
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${evidence.length > 0 ? evidence.map(e => `
                                                    <div style="font-size: 12px; padding: 4px 8px; background: var(--accent-green-soft); border-radius: 4px; margin-bottom: 4px;">
                                                        <i class="bi bi-file-earmark" style="margin-right: 4px;"></i> ${e.name.substring(0, 25)}...
                                                    </div>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;"><i class="bi bi-exclamation-circle" style="color: var(--accent-amber);"></i> No evidence</span>`}
                                            </td>
                                            <td style="padding: 14px 16px;">
                                                ${tests.length > 0 ? tests.map(t => `
                                                    <div style="font-size: 12px; padding: 4px 8px; background: var(--accent-purple-soft); border-radius: 4px; margin-bottom: 4px;">
                                                        <span class="badge badge-${t.result === 'Pass' ? 'green' : t.result === 'Fail' ? 'red' : 'amber'}" style="font-size: 9px; margin-right: 4px;">${t.result}</span>
                                                        ${t.testType || 'Test'}
                                                    </div>
                                                `).join('') : `<span style="color: var(--text-muted); font-size: 12px;"><i class="bi bi-exclamation-circle" style="color: var(--accent-amber);"></i> Not tested</span>`}
                                            </td>
                                            <td style="padding: 14px 16px; text-align: center;">
                                                <span class="badge badge-${ctrl.effectiveness === 'Effective' ? 'green' : ctrl.effectiveness === 'Partially Effective' ? 'amber' : ctrl.effectiveness === 'Ineffective' ? 'red' : 'gray'}">${ctrl.effectiveness}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <i class="bi bi-shield-check" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <p style="font-size: 14px; margin-bottom: 16px;">No controls to display</p>
                            <button class="btn btn-primary" onclick="app.switchTab('controls')"><i class="bi bi-plus"></i> Add Controls</button>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    renderGapAnalysis(d, stats) {
        const untreatedRisks = d.risks.filter(r => !d.treatments.some(t => t.riskId === r.id));
        const controlsWithoutEvidence = d.controls.filter(c => !d.evidence.some(e => e.controlId === c.id));
        const untestedControls = d.controls.filter(c => !d.controlTests.some(t => t.controlId === c.id));
        const findingsOpen = d.findings.filter(f => f.status === 'Open');
        
        return `
            <!-- Gap Summary -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card" style="border-left: 4px solid var(--accent-red);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-red);">${untreatedRisks.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Untreated Risks</div>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-amber);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-amber);">${controlsWithoutEvidence.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Controls Without Evidence</div>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-purple);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-purple);">${untestedControls.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Untested Controls</div>
                    </div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent-cyan);">
                    <div class="card-body" style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: var(--accent-cyan);">${findingsOpen.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Open Findings</div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Untreated Risks -->
                <div class="card">
                    <div class="card-header" style="padding: 16px; background: var(--accent-red-soft);">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-exclamation-triangle"></i> Untreated Risks</span>
                        <span class="badge badge-red">${untreatedRisks.length}</span>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 300px; overflow-y: auto;">
                        ${untreatedRisks.length > 0 ? untreatedRisks.map(r => {
                            const score = r.likelihood * r.impact;
                            const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : 'blue';
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);">
                                    <span class="badge badge-${scoreClass}">${score}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.title}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">${r.category}</div>
                                    </div>
                                    <button class="btn btn-ghost btn-sm" onclick="app.switchTab('treatments')" title="Add Treatment"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            `;
                        }).join('') : `<div style="padding: 30px; text-align: center; color: var(--text-muted);"><i class="bi bi-check-circle" style="color: var(--accent-green); font-size: 24px; display: block; margin-bottom: 8px;"></i>All risks have treatments!</div>`}
                    </div>
                </div>
                
                <!-- Controls Without Evidence -->
                <div class="card">
                    <div class="card-header" style="padding: 16px; background: var(--accent-amber-soft);">
                        <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-file-earmark-x"></i> Controls Missing Evidence</span>
                        <span class="badge badge-amber">${controlsWithoutEvidence.length}</span>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 300px; overflow-y: auto;">
                        ${controlsWithoutEvidence.length > 0 ? controlsWithoutEvidence.map(c => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);">
                                <span class="badge badge-${this.getFrameworkColor(c.framework)}" style="font-size: 10px;">${c.framework}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${c.ref || 'No reference'}</div>
                                </div>
                                <button class="btn btn-ghost btn-sm" onclick="app.switchTab('evidence')" title="Add Evidence"><i class="bi bi-plus-lg"></i></button>
                            </div>
                        `).join('') : `<div style="padding: 30px; text-align: center; color: var(--text-muted);"><i class="bi bi-check-circle" style="color: var(--accent-green); font-size: 24px; display: block; margin-bottom: 8px;"></i>All controls have evidence!</div>`}
                    </div>
                </div>
            </div>
        `;
    }
    
    renderFullFlowView(d) {
        return `
            <div class="card">
                <div class="card-header" style="padding: 16px;">
                    <span style="font-weight: 600; font-size: 14px;"><i class="bi bi-bezier2"></i> End-to-End GRC Flow</span>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <!-- Flow Diagram -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; padding: 24px; background: var(--bg-elevated); border-radius: var(--radius-lg);">
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-blue-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-hdd-stack" style="font-size: 24px; color: var(--accent-blue);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Assets</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-blue);">${d.assets.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-red-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-exclamation-triangle" style="font-size: 24px; color: var(--accent-red);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Risks</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${d.risks.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-amber-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-bandaid" style="font-size: 24px; color: var(--accent-amber);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Treatments</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${d.treatments.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-green-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-shield-check" style="font-size: 24px; color: var(--accent-green);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Controls</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${d.controls.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-purple-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-clipboard-check" style="font-size: 24px; color: var(--accent-purple);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Tests</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-purple);">${d.controlTests.length}</div>
                        </div>
                        <i class="bi bi-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 60px; height: 60px; background: var(--accent-cyan-soft); border-radius: 12px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-file-earmark-check" style="font-size: 24px; color: var(--accent-cyan);"></i>
                            </div>
                            <div style="font-size: 14px; font-weight: 600;">Evidence</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-cyan);">${d.evidence.length}</div>
                        </div>
                    </div>
                    
                    <!-- Detailed Flow Table -->
                    <h4 style="font-size: 14px; margin-bottom: 16px;"><i class="bi bi-list-columns-reverse"></i> Detailed Traceability Chain</h4>
                    ${d.risks.length > 0 ? `
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${d.risks.slice(0, 10).map(risk => {
                                const treatments = d.treatments.filter(t => t.riskId === risk.id);
                                const linkedControls = treatments.map(t => d.controls.find(c => c.id === t.controlId)).filter(Boolean);
                                const allEvidence = linkedControls.flatMap(c => d.evidence.filter(e => e.controlId === c.id));
                                const score = risk.likelihood * risk.impact;
                                const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                
                                return `
                                    <div style="display: flex; align-items: stretch; gap: 2px; margin-bottom: 12px; background: var(--bg-elevated); border-radius: var(--radius-md); overflow: hidden;">
                                        <div style="flex: 1; padding: 12px; border-left: 3px solid var(--accent-${scoreClass}); min-width: 0;">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">RISK</div>
                                            <div style="font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${risk.title}</div>
                                            <span class="badge badge-${scoreClass}" style="font-size: 9px; margin-top: 4px;">${score}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; padding: 0 8px;"><i class="bi bi-chevron-right" style="color: var(--text-muted);"></i></div>
                                        <div style="flex: 1; padding: 12px; background: var(--bg-surface); min-width: 0;">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">TREATMENTS</div>
                                            ${treatments.length > 0 ? `<div style="font-size: 12px;">${treatments.length} treatment(s)</div>` : `<div style="font-size: 11px; color: var(--accent-red);">No treatment</div>`}
                                        </div>
                                        <div style="display: flex; align-items: center; padding: 0 8px;"><i class="bi bi-chevron-right" style="color: var(--text-muted);"></i></div>
                                        <div style="flex: 1; padding: 12px; background: var(--bg-surface); min-width: 0;">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">CONTROLS</div>
                                            ${linkedControls.length > 0 ? `<div style="font-size: 12px;">${linkedControls.length} control(s)</div>` : `<div style="font-size: 11px; color: var(--text-muted);">-</div>`}
                                        </div>
                                        <div style="display: flex; align-items: center; padding: 0 8px;"><i class="bi bi-chevron-right" style="color: var(--text-muted);"></i></div>
                                        <div style="flex: 1; padding: 12px; background: var(--bg-surface); min-width: 0;">
                                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">EVIDENCE</div>
                                            ${allEvidence.length > 0 ? `<div style="font-size: 12px; color: var(--accent-green);">${allEvidence.length} item(s)</div>` : `<div style="font-size: 11px; color: var(--text-muted);">-</div>`}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="bi bi-diagram-3" style="font-size: 40px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                            <p>Add risks and controls to see the traceability flow</p>
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    exportTraceabilityMatrix() {
        const d = this.getActiveData();
        let csv = 'Risk ID,Risk Title,Risk Score,Treatment Type,Control ID,Control Name,Evidence Count,Test Result\\n';
        
        d.risks.forEach(risk => {
            const treatments = d.treatments.filter(t => t.riskId === risk.id);
            const score = risk.likelihood * risk.impact;
            
            if (treatments.length > 0) {
                treatments.forEach(t => {
                    const ctrl = d.controls.find(c => c.id === t.controlId);
                    const evidenceCount = ctrl ? d.evidence.filter(e => e.controlId === ctrl.id).length : 0;
                    const tests = ctrl ? d.controlTests.filter(ct => ct.controlId === ctrl.id) : [];
                    const testResult = tests.length > 0 ? tests[tests.length - 1].result : 'Not Tested';
                    
                    csv += `"${risk.id}","${risk.title}",${score},"${t.type}","${ctrl?.id || ''}","${ctrl?.name || ''}",${evidenceCount},"${testResult}"\\n`;
                });
            } else {
                csv += `"${risk.id}","${risk.title}",${score},"No Treatment","","",0,"N/A"\\n`;
            }
        });
        
        const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `traceability-matrix-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Traceability matrix exported!', 'success');
    }
    renderReports() {
        const c = document.getElementById('tab-reports');
        const d = this.getActiveData();
        
        // Calculate statistics
        const totalRisks = d.risks.length;
        const criticalRisks = d.risks.filter(r => r.likelihood * r.impact >= 20).length;
        const highRisks = d.risks.filter(r => r.likelihood * r.impact >= 12 && r.likelihood * r.impact < 20).length;
        const openRisks = d.risks.filter(r => r.status !== 'Closed').length;
        const totalControls = d.controls.length;
        const effectiveControls = d.controls.filter(ct => ct.effectiveness === 'Effective').length;
        const partialControls = d.controls.filter(ct => ct.effectiveness === 'Partially Effective').length;
        const openFindings = d.findings.filter(f => f.status === 'Open').length;
        const closedFindings = d.findings.filter(f => f.status === 'Closed').length;
        const openIssues = d.issues.filter(i => i.status === 'Open').length;
        const criticalVendors = d.vendors.filter(v => v.criticality === 'Critical').length;
        
        const selectedReport = this.selectedReport || null;
        
        c.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-file-earmark-bar-graph"></i> Reports & Analytics</h2>
                    <p style="color: var(--text-muted); font-size: 13px;">Generate detailed reports for compliance, audits, and management review.</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="app.exportAllReports()" style="white-space: nowrap;"><i class="bi bi-download"></i> Export All</button>
                    <button class="btn btn-primary" onclick="app.printReport()" style="white-space: nowrap;"><i class="bi bi-printer"></i> Print to PDF</button>
                </div>
            </div>
            
            <!-- Report Cards Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
                
                <!-- Risk Report Card -->
                <div class="card" onclick="app.showReport('risk')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-red-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-exclamation-triangle" style="font-size: 24px; color: var(--accent-red);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Risk Assessment Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Complete risk register analysis</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${totalRisks}</div><div style="font-size: 11px; color: var(--text-muted);">Total</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${criticalRisks}</div><div style="font-size: 11px; color: var(--text-muted);">Critical</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${highRisks}</div><div style="font-size: 11px; color: var(--text-muted);">High</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Control Report Card -->
                <div class="card" onclick="app.showReport('control')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-green-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-shield-check" style="font-size: 24px; color: var(--accent-green);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Control Effectiveness Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Control status and testing results</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${totalControls}</div><div style="font-size: 11px; color: var(--text-muted);">Total</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${effectiveControls}</div><div style="font-size: 11px; color: var(--text-muted);">Effective</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${partialControls}</div><div style="font-size: 11px; color: var(--text-muted);">Partial</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Compliance Report Card -->
                <div class="card" onclick="app.showReport('compliance')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-blue-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-clipboard-check" style="font-size: 24px; color: var(--accent-blue);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Compliance Status Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Framework compliance overview</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${d.audits.length}</div><div style="font-size: 11px; color: var(--text-muted);">Audits</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${closedFindings}</div><div style="font-size: 11px; color: var(--text-muted);">Closed</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${openFindings}</div><div style="font-size: 11px; color: var(--text-muted);">Open</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Vendor Report Card -->
                <div class="card" onclick="app.showReport('vendor')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-purple-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-building" style="font-size: 24px; color: var(--accent-purple);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Third-Party Risk Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Vendor risk assessment summary</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${d.vendors.length}</div><div style="font-size: 11px; color: var(--text-muted);">Vendors</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${criticalVendors}</div><div style="font-size: 11px; color: var(--text-muted);">Critical</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${d.vendors.filter(v => v.status === 'Active').length}</div><div style="font-size: 11px; color: var(--text-muted);">Active</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Incident Report Card -->
                <div class="card" onclick="app.showReport('incident')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-amber-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-lightning" style="font-size: 24px; color: var(--accent-amber);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Incident Summary Report</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">Security incident analysis</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${d.incidents.length}</div><div style="font-size: 11px; color: var(--text-muted);">Total</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">${d.incidents.filter(i => i.status === 'Resolved').length}</div><div style="font-size: 11px; color: var(--text-muted);">Resolved</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">${d.incidents.filter(i => i.status === 'Investigating').length}</div><div style="font-size: 11px; color: var(--text-muted);">Active</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Executive Summary Card -->
                <div class="card" onclick="app.showReport('executive')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-cyan-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-graph-up" style="font-size: 24px; color: var(--accent-cyan);"></i>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 2px;">Executive Summary</h4>
                                <p style="font-size: 12px; color: var(--text-muted);">High-level GRC overview</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${this.data.assets.length}</div><div style="font-size: 11px; color: var(--text-muted);">Assets</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-blue);">${d.policies.length}</div><div style="font-size: 11px; color: var(--text-muted);">Policies</div></div>
                            <div><div style="font-size: 20px; font-weight: 700; color: var(--accent-purple);">${openIssues}</div><div style="font-size: 11px; color: var(--text-muted);">Issues</div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Detail View -->
            <div id="report-detail-container">
                ${selectedReport ? this.renderReportDetail(selectedReport) : `
                    <div class="card">
                        <div class="card-body" style="padding: 60px; text-align: center;">
                            <i class="bi bi-file-earmark-text" style="font-size: 48px; color: var(--text-muted); opacity: 0.4; margin-bottom: 16px; display: block;"></i>
                            <h4 style="font-size: 16px; margin-bottom: 8px;">Select a Report</h4>
                            <p style="color: var(--text-muted); font-size: 13px;">Click on any report card above to view detailed information.</p>
                        </div>
                    </div>
                `}
            </div>
        `;
    }
    
    showReport(reportType) {
        this.selectedReport = reportType;
        const container = document.getElementById('report-detail-container');
        if (container) {
            container.innerHTML = this.renderReportDetail(reportType);
        }
    }
    
    renderReportDetail(reportType) {
        const d = this.getActiveData();
        const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const reports = {
            'risk': () => {
                const criticalRisks = d.risks.filter(r => r.likelihood * r.impact >= 20);
                const highRisks = d.risks.filter(r => r.likelihood * r.impact >= 12 && r.likelihood * r.impact < 20);
                const mediumRisks = d.risks.filter(r => r.likelihood * r.impact >= 6 && r.likelihood * r.impact < 12);
                const lowRisks = d.risks.filter(r => r.likelihood * r.impact < 6);
                const risksByCategory = {};
                d.risks.forEach(r => { risksByCategory[r.category] = (risksByCategory[r.category] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-red-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-exclamation-triangle"></i> Risk Assessment Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('risk')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Risk Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${criticalRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Critical (20-25)</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${highRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">High (12-19)</div>
                                </div>
                                <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${mediumRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Medium (6-11)</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${lowRisks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Low (1-5)</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Risks by Category</h4>
                            <div style="margin-bottom: 24px;">
                                ${Object.entries(risksByCategory).map(([cat, count]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                                        <span style="font-size: 13px;">${cat}</span>
                                        <span class="badge badge-blue">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${criticalRisks.length > 0 ? `
                                <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle); color: var(--accent-red);">⚠️ Critical Risks Requiring Immediate Attention</h4>
                                <table style="margin-bottom: 24px;">
                                    <thead><tr><th>ID</th><th>Risk</th><th>Category</th><th>Score</th><th>Owner</th><th>Status</th></tr></thead>
                                    <tbody>
                                        ${criticalRisks.map(r => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${r.id}</span></td>
                                                <td class="font-semibold">${r.title}</td>
                                                <td>${r.category}</td>
                                                <td><span class="badge badge-red">${r.likelihood * r.impact}</span></td>
                                                <td>${r.owner || '-'}</td>
                                                <td><span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'red'}">${r.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : ''}
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Complete Risk Register</h4>
                            ${d.risks.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Risk</th><th>Category</th><th>L</th><th>I</th><th>Score</th><th>Status</th></tr></thead>
                                    <tbody>
                                        ${d.risks.map(r => {
                                            const score = r.likelihood * r.impact;
                                            const scoreClass = score >= 20 ? 'red' : score >= 12 ? 'amber' : score >= 6 ? 'blue' : 'green';
                                            return `
                                                <tr>
                                                    <td><span class="font-mono text-muted">${r.id}</span></td>
                                                    <td class="font-semibold">${r.title}</td>
                                                    <td><span class="badge badge-blue" style="font-size: 10px;">${r.category}</span></td>
                                                    <td>${r.likelihood}</td>
                                                    <td>${r.impact}</td>
                                                    <td><span class="badge badge-${scoreClass}">${score}</span></td>
                                                    <td><span class="badge badge-${r.status === 'Closed' ? 'green' : r.status === 'In Progress' ? 'amber' : 'gray'}">${r.status}</span></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No risks recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'control': () => {
                const byFramework = {};
                d.controls.forEach(c => { byFramework[c.framework] = (byFramework[c.framework] || 0) + 1; });
                const byEffectiveness = { 'Effective': 0, 'Partially Effective': 0, 'Ineffective': 0, 'Not Tested': 0 };
                d.controls.forEach(c => { byEffectiveness[c.effectiveness] = (byEffectiveness[c.effectiveness] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-green-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-shield-check"></i> Control Effectiveness Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('control')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Control Effectiveness Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${byEffectiveness['Effective']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Effective</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${byEffectiveness['Partially Effective']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Partial</div>
                                </div>
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${byEffectiveness['Ineffective']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Ineffective</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--text-muted);">${byEffectiveness['Not Tested']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Not Tested</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Controls by Framework</h4>
                            <div style="margin-bottom: 24px;">
                                ${Object.entries(byFramework).map(([fw, count]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                                        <span style="font-size: 13px;">${fw}</span>
                                        <span class="badge badge-${this.getFrameworkColor(fw)}">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Control Catalog</h4>
                            ${d.controls.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Control</th><th>Framework</th><th>Ref</th><th>Effectiveness</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        ${d.controls.map(c => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${c.id}</span></td>
                                                <td class="font-semibold">${c.name}</td>
                                                <td><span class="badge badge-${this.getFrameworkColor(c.framework)}" style="font-size: 10px;">${c.framework}</span></td>
                                                <td><span class="font-mono">${c.ref || '-'}</span></td>
                                                <td><span class="badge badge-${c.effectiveness === 'Effective' ? 'green' : c.effectiveness === 'Partially Effective' ? 'amber' : c.effectiveness === 'Ineffective' ? 'red' : 'gray'}">${c.effectiveness}</span></td>
                                                <td>${c.owner || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No controls recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'compliance': () => {
                const auditsByStatus = { 'In Progress': 0, 'Planned': 0, 'Completed': 0 };
                d.audits.forEach(a => { auditsByStatus[a.status] = (auditsByStatus[a.status] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-blue-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-clipboard-check"></i> Compliance Status Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('compliance')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Audit Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${auditsByStatus['In Progress']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">In Progress</div>
                                </div>
                                <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${auditsByStatus['Planned']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Planned</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${auditsByStatus['Completed']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Completed</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Findings Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${d.findings.filter(f => f.status === 'Open').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Open Findings</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${d.findings.filter(f => f.status === 'Closed').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Closed Findings</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Active Audits</h4>
                            ${d.audits.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Audit Name</th><th>Type</th><th>Status</th><th>Lead</th><th>Scope</th></tr></thead>
                                    <tbody>
                                        ${d.audits.map(a => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${a.id}</span></td>
                                                <td class="font-semibold">${a.name}</td>
                                                <td><span class="badge badge-blue">${a.type}</span></td>
                                                <td><span class="badge badge-${a.status === 'Completed' ? 'green' : a.status === 'In Progress' ? 'amber' : 'gray'}">${a.status}</span></td>
                                                <td>${a.lead || '-'}</td>
                                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${a.scope || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No audits recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'vendor': () => {
                const byCriticality = { 'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0 };
                d.vendors.forEach(v => { byCriticality[v.criticality] = (byCriticality[v.criticality] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-purple-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-building"></i> Third-Party Risk Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('vendor')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Vendor Criticality Breakdown</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${byCriticality['Critical']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Critical</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${byCriticality['High']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">High</div>
                                </div>
                                <div style="background: var(--accent-blue-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);">${byCriticality['Medium']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Medium</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${byCriticality['Low']}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Low</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Vendor Inventory</h4>
                            ${d.vendors.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Vendor</th><th>Service</th><th>Criticality</th><th>Status</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        ${d.vendors.map(v => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${v.id}</span></td>
                                                <td class="font-semibold">${v.name}</td>
                                                <td>${v.service || '-'}</td>
                                                <td><span class="badge badge-${v.criticality === 'Critical' ? 'red' : v.criticality === 'High' ? 'amber' : 'green'}">${v.criticality}</span></td>
                                                <td><span class="badge badge-${v.status === 'Active' ? 'green' : 'gray'}">${v.status}</span></td>
                                                <td>${v.owner || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No vendors recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'incident': () => {
                const byType = {};
                d.incidents.forEach(i => { byType[i.type] = (byType[i.type] || 0) + 1; });
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-amber-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-lightning"></i> Incident Summary Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('incident')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Incident Status</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--accent-red-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-red);">${d.incidents.filter(i => i.status === 'Investigating').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Investigating</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${d.incidents.filter(i => i.status === 'Contained').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Contained</div>
                                </div>
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${d.incidents.filter(i => i.status === 'Resolved').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Resolved</div>
                                </div>
                            </div>
                            
                            ${Object.keys(byType).length > 0 ? `
                                <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Incidents by Type</h4>
                                <div style="margin-bottom: 24px;">
                                    ${Object.entries(byType).map(([type, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                                            <span style="font-size: 13px;">${type}</span>
                                            <span class="badge badge-amber">${count}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Incident Log</h4>
                            ${d.incidents.length > 0 ? `
                                <table>
                                    <thead><tr><th>ID</th><th>Incident</th><th>Type</th><th>Severity</th><th>Status</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        ${d.incidents.map(i => `
                                            <tr>
                                                <td><span class="font-mono text-muted">${i.id}</span></td>
                                                <td class="font-semibold">${i.title}</td>
                                                <td><span class="badge badge-blue">${i.type}</span></td>
                                                <td><span class="badge badge-${i.severity === 'Critical' ? 'red' : i.severity === 'High' ? 'amber' : 'green'}">${i.severity}</span></td>
                                                <td><span class="badge badge-${i.status === 'Resolved' ? 'green' : i.status === 'Investigating' ? 'red' : 'amber'}">${i.status}</span></td>
                                                <td>${i.owner || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No incidents recorded.</p>'}
                        </div>
                    </div>
                `;
            },
            
            'executive': () => {
                const criticalRisks = d.risks.filter(r => r.likelihood * r.impact >= 20).length;
                const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
                const controlEffectiveness = d.controls.length > 0 ? Math.round((effectiveControls / d.controls.length) * 100) : 0;
                
                return `
                    <div class="card" id="printable-report">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--accent-cyan-soft), transparent);">
                            <div>
                                <h3 class="card-title"><i class="bi bi-graph-up"></i> Executive Summary Report</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Generated: ${today}</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="app.exportReportCSV('executive')" style="white-space: nowrap;"><i class="bi bi-download"></i> Export CSV</button>
                        </div>
                        <div class="card-body">
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">GRC Program Overview</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-blue);">${this.data.assets.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Assets</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-red);">${d.risks.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Risks</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-green);">${d.controls.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Controls</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-purple);">${d.vendors.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Vendors</div>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Key Metrics</h4>
                            <table style="margin-bottom: 24px;">
                                <tbody>
                                    <tr><td style="padding: 12px;">Critical Risks</td><td style="padding: 12px;"><span class="badge badge-red">${criticalRisks}</span></td><td style="padding: 12px; color: var(--text-muted);">${criticalRisks > 0 ? 'Requires immediate attention' : 'No critical risks'}</td></tr>
                                    <tr><td style="padding: 12px;">Control Effectiveness</td><td style="padding: 12px;"><span class="badge badge-${controlEffectiveness >= 80 ? 'green' : controlEffectiveness >= 50 ? 'amber' : 'red'}">${controlEffectiveness}%</span></td><td style="padding: 12px; color: var(--text-muted);">${effectiveControls} of ${d.controls.length} controls effective</td></tr>
                                    <tr><td style="padding: 12px;">Open Findings</td><td style="padding: 12px;"><span class="badge badge-${d.findings.filter(f => f.status === 'Open').length > 0 ? 'amber' : 'green'}">${d.findings.filter(f => f.status === 'Open').length}</span></td><td style="padding: 12px; color: var(--text-muted);">Pending remediation</td></tr>
                                    <tr><td style="padding: 12px;">Open Issues</td><td style="padding: 12px;"><span class="badge badge-${d.issues.filter(i => i.status === 'Open').length > 0 ? 'amber' : 'green'}">${d.issues.filter(i => i.status === 'Open').length}</span></td><td style="padding: 12px; color: var(--text-muted);">Require follow-up</td></tr>
                                    <tr><td style="padding: 12px;">Active Audits</td><td style="padding: 12px;"><span class="badge badge-blue">${d.audits.filter(a => a.status === 'In Progress').length}</span></td><td style="padding: 12px; color: var(--text-muted);">Currently in progress</td></tr>
                                    <tr><td style="padding: 12px;">Evidence Items</td><td style="padding: 12px;"><span class="badge badge-green">${d.evidence.length}</span></td><td style="padding: 12px; color: var(--text-muted);">Collected for audits</td></tr>
                                </tbody>
                            </table>
                            
                            <h4 style="font-size: 14px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);">Policy Compliance</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div style="background: var(--accent-green-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);">${d.policies.filter(p => p.status === 'Approved').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Approved Policies</div>
                                </div>
                                <div style="background: var(--accent-amber-soft); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--accent-amber);">${d.policies.filter(p => p.status === 'Under Review' || p.status === 'Draft').length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">In Review/Draft</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">${d.policies.length}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Policies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };
        
        return reports[reportType] ? reports[reportType]() : '<p>Report not found.</p>';
    }
    
    printReport() {
        const reportEl = document.getElementById('printable-report');
        if (!reportEl) {
            this.toast('Please select a report first', 'error');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>GRC Report - ${new Date().toLocaleDateString()}</title>
                <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1a1a2e; }
                    h3, h4 { margin-top: 0; }
                    table { width: 100%; border-collapse: collapse; margin: 16px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 12px; }
                    th { background: #f5f5f5; font-weight: 600; }
                    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
                    .badge-red { background: #fee2e2; color: #dc2626; }
                    .badge-amber { background: #fef3c7; color: #d97706; }
                    .badge-green { background: #dcfce7; color: #16a34a; }
                    .badge-blue { background: #dbeafe; color: #2563eb; }
                    .badge-gray { background: #f3f4f6; color: #6b7280; }
                    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 16px 0; }
                    .stat-box { background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center; }
                    .stat-value { font-size: 24px; font-weight: 700; }
                    .stat-label { font-size: 11px; color: #6b7280; }
                    @media print { body { padding: 20px; } }
                </style>
            </head>
            <body>
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1a1a2e; padding-bottom: 20px;">
                    <h1 style="margin: 0; font-size: 24px;">GRC Lab Pro Report</h1>
                    <p style="color: #6b7280; margin: 8px 0 0 0;">Generated: ${new Date().toLocaleString()}</p>
                </div>
                ${reportEl.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
    
    exportAllReports() {
        const d = this.getActiveData();
        const allData = {
            exportDate: new Date().toISOString(),
            summary: {
                totalAssets: this.data.assets.length,
                totalRisks: d.risks.length,
                totalControls: d.controls.length,
                totalVendors: d.vendors.length,
                totalPolicies: d.policies.length,
                totalAudits: d.audits.length
            },
            assets: this.data.assets,
            risks: d.risks,
            controls: d.controls,
            vendors: d.vendors,
            policies: d.policies,
            audits: d.audits,
            findings: d.findings,
            incidents: d.incidents,
            evidence: d.evidence
        };
        
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `grc-complete-report-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Complete report exported!', 'success');
    }
    
    exportReportCSV(reportType) {
        const d = this.getActiveData();
        let csv = '';
        let filename = '';
        
        const csvEscape = (val) => `"${String(val || '').replace(/"/g, '""')}"`;
        
        switch(reportType) {
            case 'risk':
                csv = 'ID,Title,Category,Likelihood,Impact,Score,Status,Owner\\n';
                d.risks.forEach(r => {
                    csv += `${csvEscape(r.id)},${csvEscape(r.title)},${csvEscape(r.category)},${r.likelihood},${r.impact},${r.likelihood * r.impact},${csvEscape(r.status)},${csvEscape(r.owner)}\\n`;
                });
                filename = 'risk-report';
                break;
            case 'control':
                csv = 'ID,Name,Framework,Reference,Effectiveness,Frequency,Owner\\n';
                d.controls.forEach(c => {
                    csv += `${csvEscape(c.id)},${csvEscape(c.name)},${csvEscape(c.framework)},${csvEscape(c.ref)},${csvEscape(c.effectiveness)},${csvEscape(c.frequency)},${csvEscape(c.owner)}\\n`;
                });
                filename = 'control-report';
                break;
            case 'vendor':
                csv = 'ID,Name,Service,Criticality,Status,Owner\\n';
                d.vendors.forEach(v => {
                    csv += `${csvEscape(v.id)},${csvEscape(v.name)},${csvEscape(v.service)},${csvEscape(v.criticality)},${csvEscape(v.status)},${csvEscape(v.owner)}\\n`;
                });
                filename = 'vendor-report';
                break;
            case 'incident':
                csv = 'ID,Title,Type,Severity,Status,Owner,Date\\n';
                d.incidents.forEach(i => {
                    csv += `${csvEscape(i.id)},${csvEscape(i.title)},${csvEscape(i.type)},${csvEscape(i.severity)},${csvEscape(i.status)},${csvEscape(i.owner)},${csvEscape(i.date)}\\n`;
                });
                filename = 'incident-report';
                break;
            default:
                csv = 'Metric,Value\\n';
                csv += `Total Assets,${this.data.assets.length}\\n`;
                csv += `Total Risks,${d.risks.length}\\n`;
                csv += `Total Controls,${d.controls.length}\\n`;
                csv += `Total Vendors,${d.vendors.length}\\n`;
                filename = 'executive-summary';
        }
        
        const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('Report exported as CSV!', 'success');
    }
    renderEmpty(icon, title, text, action) { return `<div class="empty-state"><div class="empty-state-icon"><i class="bi ${icon}"></i></div><h3 class="empty-state-title">${title}</h3><p class="empty-state-text">${text}</p>${action ? `<button class="btn btn-primary" onclick="app.${action}()"><i class="bi bi-plus-lg"></i> Get Started</button>` : ''}</div>`; }
    deleteItem(key, id) { if (confirm('Delete this item?')) { this.data[key] = this.data[key].filter(x => x.id !== id); this.saveData(key); this.renderCurrentTab(); this.toast('Item deleted', 'success'); } }
    toast(message, type = 'info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast toast-${type}`; t.innerHTML = `<div class="toast-icon"><i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : 'bi-info-circle'}"></i></div><div class="toast-content"><div class="toast-message">${message}</div></div>`; c.appendChild(t); setTimeout(() => t.remove(), 4000); }
    exportData() { const d = JSON.stringify(this.data, null, 2); const b = new Blob([d], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `grc-export-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(u); this.toast('Data exported', 'success'); }
    clearAllData() { if (confirm('Clear ALL data? This cannot be undone.')) { Object.keys(this.data).forEach(k => { this.data[k] = []; localStorage.removeItem(`grc_${k}`); }); this.renderCurrentTab(); this.updateAllBadges(); this.toast('All data cleared', 'success'); } }
    loadDemo() {
        const now = new Date();
        const daysAgo = (n) => new Date(now.getTime() - n*24*60*60*1000).toISOString();
        const daysFromNow = (n) => new Date(now.getTime() + n*24*60*60*1000).toISOString();
        
        // ASSETS (10)
        this.data.assets = [
            { id: 'AST-001', name: 'Customer Portal', type: 'Application', classification: 'Critical', owner: 'Engineering', environment: 'Production', description: 'Public-facing SaaS app for 50K+ customers', createdAt: daysAgo(60), updatedAt: daysAgo(2) },
            { id: 'AST-002', name: 'Patient Database', type: 'Database', classification: 'Critical', owner: 'Data Team', environment: 'Production', description: 'PostgreSQL with PHI and medical records', createdAt: daysAgo(60), updatedAt: daysAgo(1) },
            { id: 'AST-003', name: 'AWS Production', type: 'Cloud Account', classification: 'Critical', owner: 'Cloud Team', environment: 'Production', description: 'Primary AWS account us-east-1', createdAt: daysAgo(60), updatedAt: daysAgo(3) },
            { id: 'AST-004', name: 'Admin Dashboard', type: 'Application', classification: 'High', owner: 'Engineering', environment: 'Production', description: 'Internal admin tools', createdAt: daysAgo(45), updatedAt: daysAgo(5) },
            { id: 'AST-005', name: 'API Gateway', type: 'Application', classification: 'High', owner: 'Platform', environment: 'Production', description: 'Kong gateway, 10M req/day', createdAt: daysAgo(40), updatedAt: daysAgo(7) },
            { id: 'AST-006', name: 'Corporate VPN', type: 'Network Device', classification: 'High', owner: 'IT Security', environment: 'Production', description: 'Cisco AnyConnect infrastructure', createdAt: daysAgo(90), updatedAt: daysAgo(10) },
            { id: 'AST-007', name: 'Data Warehouse', type: 'Database', classification: 'High', owner: 'Analytics', environment: 'Production', description: 'Snowflake for BI/reporting', createdAt: daysAgo(30), updatedAt: daysAgo(4) },
            { id: 'AST-008', name: 'Backup Storage', type: 'Data Store', classification: 'Critical', owner: 'Infrastructure', environment: 'DR', description: 'S3 Glacier for DR', createdAt: daysAgo(60), updatedAt: daysAgo(15) },
            { id: 'AST-009', name: 'CI/CD Pipeline', type: 'Application', classification: 'High', owner: 'DevOps', environment: 'Production', description: 'GitHub Actions deployment', createdAt: daysAgo(35), updatedAt: daysAgo(2) },
            { id: 'AST-010', name: 'Employee Laptops', type: 'Endpoint', classification: 'Medium', owner: 'IT', environment: 'Production', description: 'MacBook fleet with MDM', createdAt: daysAgo(30), updatedAt: daysAgo(8) }
        ];
        
        // VENDORS (8)
        this.data.vendors = [
            { id: 'VND-001', name: 'Amazon Web Services', service: 'Cloud Infrastructure', criticality: 'Critical', status: 'Active', owner: 'Cloud Team', contractRenewal: daysFromNow(180), notes: 'SOC 2 Type II, ISO 27001', createdAt: daysAgo(365), updatedAt: daysAgo(30) },
            { id: 'VND-002', name: 'Stripe', service: 'Payment Processing', criticality: 'Critical', status: 'Active', owner: 'Finance', contractRenewal: daysFromNow(90), notes: 'PCI DSS Level 1', createdAt: daysAgo(200), updatedAt: daysAgo(14) },
            { id: 'VND-003', name: 'Okta', service: 'Identity Management', criticality: 'Critical', status: 'Active', owner: 'IT Security', contractRenewal: daysFromNow(120), notes: 'SSO/MFA provider', createdAt: daysAgo(180), updatedAt: daysAgo(7) },
            { id: 'VND-004', name: 'Datadog', service: 'Monitoring', criticality: 'High', status: 'Active', owner: 'DevOps', contractRenewal: daysFromNow(60), notes: 'APM and log management', createdAt: daysAgo(150), updatedAt: daysAgo(21) },
            { id: 'VND-005', name: 'SendGrid', service: 'Email Delivery', criticality: 'Medium', status: 'Active', owner: 'Marketing', contractRenewal: daysFromNow(45), notes: 'Transactional email', createdAt: daysAgo(100), updatedAt: daysAgo(35) },
            { id: 'VND-006', name: 'Salesforce', service: 'CRM', criticality: 'High', status: 'Active', owner: 'Sales Ops', contractRenewal: daysFromNow(200), notes: 'Customer data with encryption', createdAt: daysAgo(400), updatedAt: daysAgo(10) },
            { id: 'VND-007', name: 'GitHub', service: 'Code Repository', criticality: 'High', status: 'Active', owner: 'Engineering', contractRenewal: daysFromNow(240), notes: 'Source code and CI/CD', createdAt: daysAgo(300), updatedAt: daysAgo(5) },
            { id: 'VND-008', name: 'Snyk', service: 'Security Scanning', criticality: 'Medium', status: 'Active', owner: 'SecOps', contractRenewal: daysFromNow(150), notes: 'Dependency scanning', createdAt: daysAgo(120), updatedAt: daysAgo(12) }
        ];
        
        // POLICIES (8)
        this.data.policies = [
            { id: 'POL-001', title: 'Information Security Policy', status: 'Approved', owner: 'CISO', reviewDate: daysFromNow(90), createdAt: daysAgo(365), updatedAt: daysAgo(30) },
            { id: 'POL-002', title: 'Access Control Policy', status: 'Approved', owner: 'IT Security', reviewDate: daysFromNow(60), createdAt: daysAgo(300), updatedAt: daysAgo(45) },
            { id: 'POL-003', title: 'Data Classification Policy', status: 'Approved', owner: 'Data Gov', reviewDate: daysFromNow(120), createdAt: daysAgo(200), updatedAt: daysAgo(60) },
            { id: 'POL-004', title: 'Incident Response Policy', status: 'Review', owner: 'SecOps', reviewDate: daysFromNow(14), createdAt: daysAgo(180), updatedAt: daysAgo(5) },
            { id: 'POL-005', title: 'Backup & Recovery Policy', status: 'Approved', owner: 'Infrastructure', reviewDate: daysFromNow(150), createdAt: daysAgo(250), updatedAt: daysAgo(90) },
            { id: 'POL-006', title: 'Acceptable Use Policy', status: 'Approved', owner: 'HR', reviewDate: daysFromNow(180), createdAt: daysAgo(400), updatedAt: daysAgo(120) },
            { id: 'POL-007', title: 'Vendor Management Policy', status: 'Draft', owner: 'Procurement', reviewDate: daysFromNow(30), createdAt: daysAgo(30), updatedAt: daysAgo(2) },
            { id: 'POL-008', title: 'Encryption Policy', status: 'Approved', owner: 'IT Security', reviewDate: daysFromNow(100), createdAt: daysAgo(150), updatedAt: daysAgo(75) }
        ];
        
        // RISKS (12)
        this.data.risks = [
            { id: 'RSK-001', title: 'Unauthorized access via compromised credentials', category: 'Access Control', status: 'In Progress', likelihood: 4, impact: 5, owner: 'IT Security', assetId: 'AST-003', description: 'Credential stuffing or phishing could grant unauthorized AWS access', createdAt: daysAgo(45), updatedAt: daysAgo(2) },
            { id: 'RSK-002', title: 'Data breach through application vulnerability', category: 'Application Security', status: 'In Progress', likelihood: 3, impact: 5, owner: 'AppSec', assetId: 'AST-001', description: 'OWASP Top 10 vulnerabilities could expose customer data', createdAt: daysAgo(40), updatedAt: daysAgo(3) },
            { id: 'RSK-003', title: 'Extended outage from failed disaster recovery', category: 'Availability', status: 'Open', likelihood: 3, impact: 4, owner: 'Infrastructure', assetId: 'AST-008', description: 'Backup restoration procedures untested for 6 months', createdAt: daysAgo(35), updatedAt: daysAgo(1) },
            { id: 'RSK-004', title: 'PHI exposure via S3 misconfiguration', category: 'Data Protection', status: 'In Progress', likelihood: 2, impact: 5, owner: 'Cloud Team', assetId: 'AST-003', description: 'IAM or bucket policy errors could expose patient data', createdAt: daysAgo(30), updatedAt: daysAgo(5) },
            { id: 'RSK-005', title: 'Vendor data breach affecting customers', category: 'Vendor Risk', status: 'Open', likelihood: 3, impact: 4, owner: 'Procurement', assetId: null, description: 'Critical vendor breach could expose shared data', createdAt: daysAgo(28), updatedAt: daysAgo(7) },
            { id: 'RSK-006', title: 'Ransomware encrypting production databases', category: 'Application Security', status: 'In Progress', likelihood: 3, impact: 5, owner: 'SecOps', assetId: 'AST-002', description: 'Ransomware could cause extended downtime and data loss', createdAt: daysAgo(25), updatedAt: daysAgo(4) },
            { id: 'RSK-007', title: 'Insider threat data exfiltration', category: 'Access Control', status: 'Open', likelihood: 2, impact: 4, owner: 'HR Security', assetId: null, description: 'Malicious insider could steal sensitive data', createdAt: daysAgo(20), updatedAt: daysAgo(10) },
            { id: 'RSK-008', title: 'API abuse causing service degradation', category: 'Availability', status: 'In Progress', likelihood: 4, impact: 3, owner: 'Platform', assetId: 'AST-005', description: 'DDoS or API abuse could overwhelm gateway', createdAt: daysAgo(18), updatedAt: daysAgo(6) },
            { id: 'RSK-009', title: 'HIPAA non-compliance penalties', category: 'Compliance', status: 'In Progress', likelihood: 2, impact: 5, owner: 'Compliance', assetId: null, description: 'Control gaps could result in $1.5M+ fines', createdAt: daysAgo(15), updatedAt: daysAgo(3) },
            { id: 'RSK-010', title: 'VPN compromise enabling lateral movement', category: 'Access Control', status: 'Open', likelihood: 3, impact: 4, owner: 'Network', assetId: 'AST-006', description: 'VPN vulnerability could enable network intrusion', createdAt: daysAgo(12), updatedAt: daysAgo(8) },
            { id: 'RSK-011', title: 'Supply chain attack via dependencies', category: 'Vendor Risk', status: 'Open', likelihood: 2, impact: 4, owner: 'Engineering', assetId: 'AST-009', description: 'Compromised npm/pip packages could introduce backdoors', createdAt: daysAgo(10), updatedAt: daysAgo(5) },
            { id: 'RSK-012', title: 'Phishing attacks targeting employees', category: 'Human Error', status: 'In Progress', likelihood: 4, impact: 3, owner: 'IT Security', assetId: 'AST-010', description: 'Sophisticated phishing campaigns', createdAt: daysAgo(8), updatedAt: daysAgo(2) }
        ];
        
        // CONTROLS (15)
        this.data.controls = [
            { id: 'CTL-001', name: 'Multi-Factor Authentication (MFA)', framework: 'ISO 27001', ref: 'A.5.17', effectiveness: 'Effective', frequency: 'Continuous', owner: 'IT Security', description: 'MFA via Okta for all admin access', createdAt: daysAgo(90), updatedAt: daysAgo(5) },
            { id: 'CTL-002', name: 'Centralized Log Monitoring', framework: 'SOC 2', ref: 'CC7.2', effectiveness: 'Effective', frequency: 'Continuous', owner: 'SecOps', description: 'Datadog SIEM with 90-day retention', createdAt: daysAgo(85), updatedAt: daysAgo(3) },
            { id: 'CTL-003', name: 'Automated Backup & Encryption', framework: 'ISO 27001', ref: 'A.8.13', effectiveness: 'Partially Effective', frequency: 'Daily', owner: 'Infrastructure', description: 'Daily AES-256 encrypted backups', createdAt: daysAgo(80), updatedAt: daysAgo(10) },
            { id: 'CTL-004', name: 'Vulnerability Scanning', framework: 'NIST CSF', ref: 'DE.CM-8', effectiveness: 'Effective', frequency: 'Weekly', owner: 'AppSec', description: 'Weekly Snyk scans, 7-day critical SLA', createdAt: daysAgo(75), updatedAt: daysAgo(7) },
            { id: 'CTL-005', name: 'Network Segmentation', framework: 'PCI DSS', ref: '1.3', effectiveness: 'Effective', frequency: 'Quarterly', owner: 'Network', description: 'VPC isolation between environments', createdAt: daysAgo(70), updatedAt: daysAgo(15) },
            { id: 'CTL-006', name: 'Access Review Process', framework: 'SOC 2', ref: 'CC6.1', effectiveness: 'Partially Effective', frequency: 'Quarterly', owner: 'IT Security', description: 'Quarterly privileged access reviews', createdAt: daysAgo(65), updatedAt: daysAgo(20) },
            { id: 'CTL-007', name: 'Data Encryption at Rest', framework: 'HIPAA', ref: '164.312(a)', effectiveness: 'Effective', frequency: 'Continuous', owner: 'Data Team', description: 'AES-256 for all PHI databases', createdAt: daysAgo(60), updatedAt: daysAgo(12) },
            { id: 'CTL-008', name: 'Security Awareness Training', framework: 'ISO 27001', ref: 'A.6.3', effectiveness: 'Effective', frequency: 'Annual', owner: 'HR', description: 'Annual training + monthly phishing sims', createdAt: daysAgo(55), updatedAt: daysAgo(30) },
            { id: 'CTL-009', name: 'Incident Response Plan', framework: 'NIST CSF', ref: 'RS.RP-1', effectiveness: 'Partially Effective', frequency: 'Annual', owner: 'SecOps', description: 'Documented IR playbooks', createdAt: daysAgo(50), updatedAt: daysAgo(8) },
            { id: 'CTL-010', name: 'API Rate Limiting', framework: 'CIS', ref: '13.1', effectiveness: 'Effective', frequency: 'Continuous', owner: 'Platform', description: '1000 req/min via Kong', createdAt: daysAgo(45), updatedAt: daysAgo(4) },
            { id: 'CTL-011', name: 'Vendor Security Assessment', framework: 'ISO 27001', ref: 'A.5.19', effectiveness: 'Ineffective', frequency: 'Annual', owner: 'Procurement', description: 'Security questionnaires (incomplete)', createdAt: daysAgo(40), updatedAt: daysAgo(25) },
            { id: 'CTL-012', name: 'Endpoint Detection & Response', framework: 'NIST CSF', ref: 'DE.CM-4', effectiveness: 'Effective', frequency: 'Continuous', owner: 'SecOps', description: 'CrowdStrike on all endpoints', createdAt: daysAgo(35), updatedAt: daysAgo(2) },
            { id: 'CTL-013', name: 'WAF Protection', framework: 'CIS', ref: '13.6', effectiveness: 'Effective', frequency: 'Continuous', owner: 'Platform', description: 'AWS WAF with OWASP rules', createdAt: daysAgo(30), updatedAt: daysAgo(6) },
            { id: 'CTL-014', name: 'Change Management', framework: 'COBIT', ref: 'BAI06', effectiveness: 'Effective', frequency: 'Per Change', owner: 'DevOps', description: 'PR reviews and deployment approvals', createdAt: daysAgo(25), updatedAt: daysAgo(1) },
            { id: 'CTL-015', name: 'Data Loss Prevention', framework: 'GDPR', ref: 'Art. 32', effectiveness: 'Ineffective', frequency: 'Continuous', owner: 'IT Security', description: 'DLP tool currently disabled', createdAt: daysAgo(20), updatedAt: daysAgo(5) }
        ];
        
        // TREATMENTS (6)
        this.data.treatments = [
            { id: 'TRT-001', riskId: 'RSK-003', type: 'Mitigate', status: 'In Progress', owner: 'Infrastructure', dueDate: daysFromNow(14), plan: '1. Document restore procedures\n2. Schedule monthly tests\n3. Create DR runbook', createdAt: daysAgo(20), updatedAt: daysAgo(3) },
            { id: 'TRT-002', riskId: 'RSK-001', type: 'Mitigate', status: 'In Progress', owner: 'IT Security', dueDate: daysFromNow(30), plan: '1. Deploy hardware security keys\n2. Enable impossible travel detection\n3. Phishing campaign', createdAt: daysAgo(18), updatedAt: daysAgo(5) },
            { id: 'TRT-003', riskId: 'RSK-005', type: 'Transfer', status: 'Planned', owner: 'Legal', dueDate: daysFromNow(45), plan: '1. Review cyber insurance\n2. Require SOC 2 from vendors\n3. Update contracts', createdAt: daysAgo(15), updatedAt: daysAgo(7) },
            { id: 'TRT-004', riskId: 'RSK-006', type: 'Mitigate', status: 'In Progress', owner: 'SecOps', dueDate: daysFromNow(21), plan: '1. Deploy ransomware detection\n2. Implement immutable backups\n3. Create response playbook', createdAt: daysAgo(12), updatedAt: daysAgo(2) },
            { id: 'TRT-005', riskId: 'RSK-007', type: 'Mitigate', status: 'Planned', owner: 'HR Security', dueDate: daysFromNow(60), plan: '1. Deploy DLP\n2. USB restrictions\n3. User behavior analytics', createdAt: daysAgo(10), updatedAt: daysAgo(4) },
            { id: 'TRT-006', riskId: 'RSK-009', type: 'Mitigate', status: 'In Progress', owner: 'Compliance', dueDate: daysFromNow(28), plan: '1. HIPAA gap assessment\n2. Remediate findings\n3. Update BAAs', createdAt: daysAgo(8), updatedAt: daysAgo(1) }
        ];
        
        // ISSUES (5)
        this.data.issues = [
            { id: 'ISS-001', title: 'Q3 access reviews incomplete', category: 'Process Gap', severity: 'High', status: 'Open', owner: 'IT Security', dueDate: daysFromNow(7), description: '45 privileged accounts pending review', createdAt: daysAgo(21), updatedAt: daysAgo(1) },
            { id: 'ISS-002', title: 'Missing BAA with analytics vendor', category: 'Compliance Issue', severity: 'Critical', status: 'In Progress', owner: 'Legal', dueDate: daysFromNow(3), description: 'Datadog processes PHI without BAA - HIPAA violation', createdAt: daysAgo(14), updatedAt: daysAgo(2) },
            { id: 'ISS-003', title: 'Outdated IR playbooks', category: 'Process Gap', severity: 'Medium', status: 'Open', owner: 'SecOps', dueDate: daysFromNow(21), description: 'Last updated 14 months ago', createdAt: daysAgo(10), updatedAt: daysAgo(5) },
            { id: 'ISS-004', title: 'Backup restore test documentation missing', category: 'Technical Debt', severity: 'High', status: 'In Progress', owner: 'Infrastructure', dueDate: daysFromNow(14), description: 'Last documented test was 8 months ago', createdAt: daysAgo(7), updatedAt: daysAgo(3) },
            { id: 'ISS-005', title: 'Encryption key rotation overdue', category: 'Security Gap', severity: 'Medium', status: 'Open', owner: 'Cloud Team', dueDate: daysFromNow(10), description: 'KMS keys not rotated in 120 days (policy: 90 days)', createdAt: daysAgo(5), updatedAt: daysAgo(2) }
        ];
        
        // INCIDENTS (4)
        this.data.incidents = [
            { id: 'INC-001', title: 'Customer portal 5xx errors', type: 'Availability', severity: 'High', status: 'Resolved', owner: 'SRE', date: daysAgo(5), description: '15-minute outage due to DB connection pool exhaustion', createdAt: daysAgo(5), updatedAt: daysAgo(4) },
            { id: 'INC-002', title: 'Phishing campaign targeting finance', type: 'Phishing', severity: 'Medium', status: 'Resolved', owner: 'SecOps', date: daysAgo(12), description: '23 employees received emails, 2 clicked, MFA blocked compromise', createdAt: daysAgo(12), updatedAt: daysAgo(10) },
            { id: 'INC-003', title: 'Unauthorized access attempt detected', type: 'Security', severity: 'High', status: 'Investigating', owner: 'SecOps', date: daysAgo(2), description: 'Multiple failed logins from suspicious IPs, accounts locked', createdAt: daysAgo(2), updatedAt: daysAgo(1) },
            { id: 'INC-004', title: 'Accidental staging data exposure', type: 'Data Breach', severity: 'Medium', status: 'Resolved', owner: 'DevOps', date: daysAgo(20), description: 'Prod data copied to staging, accessible by contractors for 2 hours', createdAt: daysAgo(20), updatedAt: daysAgo(18) }
        ];
        
        // TASKS (8)
        this.data.tasks = [
            { id: 'TSK-001', title: 'Complete Q3 access review', priority: 'High', status: 'In Progress', assignee: 'IT Security', dueDate: daysFromNow(7), notes: 'Review 45 privileged accounts', createdAt: daysAgo(21), updatedAt: daysAgo(2) },
            { id: 'TSK-002', title: 'Execute database restore test', priority: 'High', status: 'Not Started', assignee: 'DBA Team', dueDate: daysFromNow(14), notes: 'Full restore to DR environment', createdAt: daysAgo(14), updatedAt: daysAgo(7) },
            { id: 'TSK-003', title: 'Deploy hardware security keys', priority: 'Critical', status: 'In Progress', assignee: 'IT Security', dueDate: daysFromNow(21), notes: 'YubiKeys for 15 admins', createdAt: daysAgo(10), updatedAt: daysAgo(3) },
            { id: 'TSK-004', title: 'Update IR playbooks', priority: 'Medium', status: 'Not Started', assignee: 'SOC Manager', dueDate: daysFromNow(30), notes: 'Add cloud-specific scenarios', createdAt: daysAgo(7), updatedAt: daysAgo(5) },
            { id: 'TSK-005', title: 'Rotate KMS keys', priority: 'Medium', status: 'Not Started', assignee: 'Cloud Engineer', dueDate: daysFromNow(10), notes: 'All keys older than 90 days', createdAt: daysAgo(5), updatedAt: daysAgo(2) },
            { id: 'TSK-006', title: 'Finalize Datadog BAA', priority: 'Critical', status: 'In Progress', assignee: 'Legal', dueDate: daysFromNow(3), notes: 'Execute BAA for PHI processing', createdAt: daysAgo(10), updatedAt: daysAgo(1) },
            { id: 'TSK-007', title: 'Vendor security assessment - Stripe', priority: 'High', status: 'Not Started', assignee: 'Procurement', dueDate: daysFromNow(45), notes: 'Review SOC 2 and PCI compliance', createdAt: daysAgo(3), updatedAt: daysAgo(1) },
            { id: 'TSK-008', title: 'Schedule ransomware tabletop', priority: 'Medium', status: 'Not Started', assignee: 'CISO', dueDate: daysFromNow(60), notes: 'Include IT, Legal, Comms teams', createdAt: daysAgo(2), updatedAt: daysAgo(1) }
        ];
        
        // AUDITS (4)
        this.data.audits = [
            { id: 'AUD-001', name: 'SOC 2 Type II Annual', type: 'SOC 2', status: 'In Progress', lead: 'Deloitte', startDate: daysAgo(30), scope: 'Security, Availability, Confidentiality', createdAt: daysAgo(60), updatedAt: daysAgo(2) },
            { id: 'AUD-002', name: 'HIPAA Assessment', type: 'HIPAA', status: 'Planned', lead: 'Compliance Officer', startDate: daysFromNow(45), scope: 'PHI processing systems and procedures', createdAt: daysAgo(30), updatedAt: daysAgo(10) },
            { id: 'AUD-003', name: 'Internal Control Testing Q4', type: 'Internal', status: 'Planned', lead: 'Internal Audit', startDate: daysFromNow(14), scope: 'Access management, change management, IR', createdAt: daysAgo(14), updatedAt: daysAgo(5) },
            { id: 'AUD-004', name: 'PCI DSS v4.0 Gap Assessment', type: 'PCI DSS', status: 'Completed', lead: 'Coalfire', startDate: daysAgo(90), scope: 'Cardholder data environment', createdAt: daysAgo(120), updatedAt: daysAgo(60) }
        ];
        
        // EVIDENCE (10)
        this.data.evidence = [
            { id: 'EVD-001', title: 'MFA Configuration Screenshot', type: 'Screenshot', relatedTo: 'CTL-001', owner: 'IT Security', url: 'https://drive.company.com/mfa-config.png', notes: 'Okta MFA enforcement for admin groups', createdAt: daysAgo(30), updatedAt: daysAgo(5) },
            { id: 'EVD-002', title: 'SIEM Alert Rules Export', type: 'Export', relatedTo: 'CTL-002', owner: 'SecOps', url: 'https://drive.company.com/siem-rules.json', notes: '47 detection rules from Datadog', createdAt: daysAgo(25), updatedAt: daysAgo(10) },
            { id: 'EVD-003', title: 'Backup Job Report', type: 'Report', relatedTo: 'CTL-003', owner: 'Infrastructure', url: 'https://drive.company.com/backup-dec.pdf', notes: '99.2% backup completion rate', createdAt: daysAgo(20), updatedAt: daysAgo(15) },
            { id: 'EVD-004', title: 'Vulnerability Scan Results', type: 'Report', relatedTo: 'CTL-004', owner: 'AppSec', url: 'https://drive.company.com/snyk-q4.pdf', notes: '0 critical, 3 high findings', createdAt: daysAgo(15), updatedAt: daysAgo(7) },
            { id: 'EVD-005', title: 'Firewall Rule Review', type: 'Document', relatedTo: 'CTL-005', owner: 'Network', url: 'https://drive.company.com/fw-review.xlsx', notes: 'Quarterly review with approvals', createdAt: daysAgo(45), updatedAt: daysAgo(40) },
            { id: 'EVD-006', title: 'Access Review Report Q2', type: 'Report', relatedTo: 'CTL-006', owner: 'IT Security', url: 'https://drive.company.com/access-q2.pdf', notes: '98% completion rate', createdAt: daysAgo(90), updatedAt: daysAgo(85) },
            { id: 'EVD-007', title: 'KMS Key Rotation Log', type: 'Log', relatedTo: 'CTL-007', owner: 'Cloud Team', url: 'https://drive.company.com/kms.log', notes: 'CloudTrail rotation events', createdAt: daysAgo(60), updatedAt: daysAgo(55) },
            { id: 'EVD-008', title: 'Security Training Report', type: 'Report', relatedTo: 'CTL-008', owner: 'HR', url: 'https://drive.company.com/training.pdf', notes: '100% completion', createdAt: daysAgo(30), updatedAt: daysAgo(25) },
            { id: 'EVD-009', title: 'IR Plan Document', type: 'Document', relatedTo: 'CTL-009', owner: 'SecOps', url: 'https://drive.company.com/ir-plan.pdf', notes: 'v2.3 current plan', createdAt: daysAgo(240), updatedAt: daysAgo(240) },
            { id: 'EVD-010', title: 'WAF Configuration', type: 'Configuration', relatedTo: 'CTL-013', owner: 'Platform', url: 'https://drive.company.com/waf.yaml', notes: 'AWS WAF rule set', createdAt: daysAgo(45), updatedAt: daysAgo(4) }
        ];
        
        // CONTROL TESTS (6)
        this.data.controlTests = [
            { id: 'TST-001', controlId: 'CTL-001', testDate: daysAgo(14), result: 'Pass', tester: 'External Auditor', procedure: 'Verified MFA for 20 admin accounts, all required MFA', createdAt: daysAgo(14), updatedAt: daysAgo(14) },
            { id: 'TST-002', controlId: 'CTL-002', testDate: daysAgo(10), result: 'Pass', tester: 'Internal Audit', procedure: 'Generated test events, alerts triggered within SLA', createdAt: daysAgo(10), updatedAt: daysAgo(10) },
            { id: 'TST-003', controlId: 'CTL-003', testDate: daysAgo(7), result: 'Partial', tester: 'Internal Audit', procedure: 'Backups running but restore test incomplete', createdAt: daysAgo(7), updatedAt: daysAgo(7) },
            { id: 'TST-004', controlId: 'CTL-006', testDate: daysAgo(30), result: 'Fail', tester: 'External Auditor', procedure: 'Only 60% of accounts reviewed by deadline', createdAt: daysAgo(30), updatedAt: daysAgo(30) },
            { id: 'TST-005', controlId: 'CTL-013', testDate: daysAgo(12), result: 'Pass', tester: 'SecOps', procedure: 'OWASP Top 10 attacks blocked successfully', createdAt: daysAgo(12), updatedAt: daysAgo(12) },
            { id: 'TST-006', controlId: 'CTL-015', testDate: daysAgo(5), result: 'Fail', tester: 'IT Security', procedure: 'DLP tool disabled, control not operational', createdAt: daysAgo(5), updatedAt: daysAgo(5) }
        ];
        
        // FINDINGS (5)
        this.data.findings = [
            { id: 'FND-001', title: 'Backup restore testing not performed', severity: 'High', status: 'Open', owner: 'Infrastructure', dueDate: daysFromNow(14), description: 'No evidence of restore testing in 6 months', recommendation: 'Implement quarterly restore tests with documentation', createdAt: daysAgo(20), updatedAt: daysAgo(5) },
            { id: 'FND-002', title: 'DLP controls not operational', severity: 'High', status: 'Open', owner: 'IT Security', dueDate: daysFromNow(21), description: 'DLP disabled due to performance issues', recommendation: 'Optimize and re-enable DLP', createdAt: daysAgo(5), updatedAt: daysAgo(3) },
            { id: 'FND-003', title: 'Access reviews incomplete', severity: 'Medium', status: 'In Progress', owner: 'IT Security', dueDate: daysFromNow(7), description: '40% of accounts reviewed late', recommendation: 'Implement automated review workflow', createdAt: daysAgo(30), updatedAt: daysAgo(2) },
            { id: 'FND-004', title: 'Vendor SOC 2 reports expired', severity: 'Medium', status: 'In Progress', owner: 'Procurement', dueDate: daysFromNow(7), description: '2 critical vendors have expired reports', recommendation: 'Request updated reports immediately', createdAt: daysAgo(15), updatedAt: daysAgo(5) },
            { id: 'FND-005', title: 'Missing Business Associate Agreement', severity: 'Critical', status: 'In Progress', owner: 'Legal', dueDate: daysFromNow(3), description: 'BAA not executed with Datadog for PHI', recommendation: 'Execute BAA immediately, review all PHI vendors', createdAt: daysAgo(14), updatedAt: daysAgo(1) }
        ];
        
        Object.keys(this.data).forEach(k => this.saveData(k));
        this.renderCurrentTab();
        this.updateAllBadges();
        this.toast('🎉 Complete demo data loaded! Explore all 19 tabs.', 'success');
    }
    
    // ==================== FRAMEWORK LIBRARY (400+ Controls) ====================
    renderFrameworks() {
        const c = document.getElementById('tab-frameworks');
        const frameworks = this.getFrameworkControls();
        const selectedFw = this.fwFilter || 'all';
        const selectedCat = this.catFilter || 'all';
        
        c.innerHTML = `
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;"><i class="bi bi-journal-code"></i> Framework Control Library</h2>
                <p style="font-size: 13px; color: var(--text-secondary);">400+ security controls from 9 major compliance frameworks. Use these as reference when implementing your own controls.</p>
            </div>
            
            <!-- Filters Section -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Framework</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                <button class="btn btn-sm ${selectedFw === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('all')">All</button>
                                <button class="btn btn-sm ${selectedFw === 'ISO 27001' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('ISO 27001')">ISO 27001</button>
                                <button class="btn btn-sm ${selectedFw === 'NIST CSF' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('NIST CSF')">NIST CSF</button>
                                <button class="btn btn-sm ${selectedFw === 'SOC 2' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('SOC 2')">SOC 2</button>
                                <button class="btn btn-sm ${selectedFw === 'PCI DSS' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('PCI DSS')">PCI DSS</button>
                                <button class="btn btn-sm ${selectedFw === 'HIPAA' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('HIPAA')">HIPAA</button>
                                <button class="btn btn-sm ${selectedFw === 'GDPR' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('GDPR')">GDPR</button>
                                <button class="btn btn-sm ${selectedFw === 'CIS Controls' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('CIS Controls')">CIS</button>
                                <button class="btn btn-sm ${selectedFw === 'CMMC' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('CMMC')">CMMC</button>
                                <button class="btn btn-sm ${selectedFw === 'COBIT' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setFwFilter('COBIT')">COBIT</button>
                            </div>
                        </div>
                        <div style="margin-left: auto;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Search</label>
                            <input type="text" class="form-input" id="fw-search" placeholder="Search controls..." oninput="app.filterFrameworks()" style="width: 220px; padding: 8px 12px; font-size: 13px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                        <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Category</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            <button class="btn btn-sm ${selectedCat === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('all')">All Categories</button>
                            <button class="btn btn-sm ${selectedCat === 'Access Control' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Access Control')">Access Control</button>
                            <button class="btn btn-sm ${selectedCat === 'Asset Management' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Asset Management')">Asset Management</button>
                            <button class="btn btn-sm ${selectedCat === 'Data Protection' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Data Protection')">Data Protection</button>
                            <button class="btn btn-sm ${selectedCat === 'Network Security' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Network Security')">Network Security</button>
                            <button class="btn btn-sm ${selectedCat === 'Incident Management' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Incident Management')">Incident Mgmt</button>
                            <button class="btn btn-sm ${selectedCat === 'Risk Management' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Risk Management')">Risk Management</button>
                            <button class="btn btn-sm ${selectedCat === 'Compliance' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Compliance')">Compliance</button>
                            <button class="btn btn-sm ${selectedCat === 'Logging & Monitoring' ? 'btn-primary' : 'btn-secondary'}" onclick="app.setCatFilter('Logging & Monitoring')">Logging</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Controls</div>
                    <span class="badge badge-blue" id="fw-count">0 controls</span>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead style="position: sticky; top: 0; background: var(--bg-surface); z-index: 10;">
                            <tr>
                                <th style="width: 120px;">Control ID</th>
                                <th>Name</th>
                                <th style="width: 140px;">Category</th>
                                <th style="width: 150px;">Framework</th>
                                <th>Description</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="fw-table-body"></tbody>
                    </table>
                </div>
            </div>`;
        setTimeout(() => this.filterFrameworks(), 0);
    }
    
    setFwFilter(fw) {
        this.fwFilter = fw;
        this.renderFrameworks();
    }
    
    setCatFilter(cat) {
        this.catFilter = cat;
        this.renderFrameworks();
    }
    
    filterFrameworks() {
        const fw = this.fwFilter || 'all';
        const cat = this.catFilter || 'all';
        const search = (document.getElementById('fw-search')?.value || '').toLowerCase();
        let controls = this.getFrameworkControls();
        if (fw !== 'all') controls = controls.filter(c => c.frameworks.includes(fw));
        if (cat !== 'all') controls = controls.filter(c => c.category === cat);
        if (search) controls = controls.filter(c => c.name.toLowerCase().includes(search) || c.description.toLowerCase().includes(search) || c.id.toLowerCase().includes(search));
        
        const countEl = document.getElementById('fw-count');
        if (countEl) countEl.textContent = `${controls.length} controls`;
        
        const tbody = document.getElementById('fw-table-body');
        if (!tbody) return;
        if (controls.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="bi bi-search" style="font-size: 32px; display: block; margin-bottom: 8px; opacity: 0.3;"></i>No matching controls found</td></tr>';
        } else {
            tbody.innerHTML = controls.slice(0, 100).map(c => `
                <tr>
                    <td><code style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${this.esc(c.id)}</code></td>
                    <td style="font-weight: 500;">${this.esc(c.name)}</td>
                    <td><span class="badge badge-gray" style="font-size: 10px;">${this.esc(c.category)}</span></td>
                    <td>${c.frameworks.map(f => `<span class="badge badge-${this.getFrameworkColor(f)}" style="font-size: 10px;">${f}</span>`).join(' ')}</td>
                    <td style="max-width: 280px; font-size: 12px; color: var(--text-muted);">${this.esc(c.description.substring(0, 100))}${c.description.length > 100 ? '...' : ''}</td>
                    <td><button class="btn btn-sm btn-secondary" onclick="app.adoptControl('${c.id}')"><i class="bi bi-plus"></i> Add</button></td>
                </tr>`).join('');
            if (controls.length > 100) {
                tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Showing 100 of ${controls.length} controls. Refine your search to see more.</td></tr>`;
            }
        }
    }
    
    adoptControl(ctrlId) {
        const fwCtrl = this.getFrameworkControls().find(c => c.id === ctrlId);
        if (!fwCtrl) return;
        const newCtrl = {
            id: this.generateId('CTL'),
            name: fwCtrl.name,
            type: 'Preventive',
            status: 'Planned',
            owner: 'TBD',
            effectiveness: 'Not Tested',
            frameworks: fwCtrl.frameworks,
            description: fwCtrl.description,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        this.getActiveData().controls.push(newCtrl);
        this.saveData('controls');
        this.toast(`Control "${fwCtrl.name}" adopted to your Control Catalog`, 'success');
    }
    
    getFrameworkColor(fw) {
        const colors = { 'ISO 27001': 'blue', 'NIST CSF': 'purple', 'PCI DSS': 'amber', 'HIPAA': 'pink', 'SOC 2': 'green', 'CIS Controls': 'cyan', 'GDPR': 'red', 'CMMC': 'amber', 'COBIT': 'purple' };
        return colors[fw] || 'blue';
    }
    
    getFrameworkControls() {
        return [
            // ISO 27001:2022 (93 controls)
            {id:"ISO-5.1",name:"Security policies",category:"Policy & Governance",description:"Define, approve, communicate, and periodically review this policy to guide information security.",frameworks:["ISO 27001"]},
            {id:"ISO-5.2",name:"Info security roles",category:"Policy & Governance",description:"Implement and maintain measures for info security roles to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.3",name:"Segregation of duties",category:"Policy & Governance",description:"Implement and maintain measures for segregation of duties to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.4",name:"Management responsibilities",category:"Policy & Governance",description:"Implement and maintain measures for management responsibilities to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.5",name:"Authority contacts",category:"Compliance",description:"Implement and maintain measures for authority contacts to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.6",name:"Special interest contacts",category:"Compliance",description:"Implement and maintain measures for special interest contacts to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.7",name:"Threat intel",category:"Risk Management",description:"Implement and maintain measures for threat intel to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.8",name:"Project security",category:"Policy & Governance",description:"Implement and maintain measures for project security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.9",name:"Asset inventory",category:"Asset Management",description:"Maintain an accurate, up-to-date inventory including ownership, classification, and lifecycle status.",frameworks:["ISO 27001"]},
            {id:"ISO-5.10",name:"Acceptable use",category:"Asset Management",description:"Implement and maintain measures for acceptable use to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.11",name:"Asset return",category:"Asset Management",description:"Implement and maintain measures for asset return to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.12",name:"Information classification",category:"Data Protection",description:"Implement and maintain measures for information classification to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.13",name:"Information labeling",category:"Data Protection",description:"Implement and maintain measures for information labeling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.14",name:"Information transfer",category:"Data Protection",description:"Implement and maintain measures for information transfer to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.15",name:"Access control rules",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-5.16",name:"Identity lifecycle",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-5.17",name:"Authentication info handling",category:"Access Control",description:"Implement and maintain measures for authentication info handling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.18",name:"Access rights",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-5.19",name:"Supplier security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.20",name:"Supplier security requirements",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.21",name:"Supplier agreements security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.22",name:"Supplier service monitoring",category:"Vendor Management",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-5.23",name:"Cloud services security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-5.24",name:"Incident planning & readiness",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
            {id:"ISO-5.25",name:"Incident assessment & decision",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
            {id:"ISO-5.26",name:"Incident response & communication",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
            {id:"ISO-5.27",name:"Lessons learned",category:"Incident Management",description:"Implement and maintain measures for lessons learned to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.28",name:"Evidence handling",category:"Incident Management",description:"Implement and maintain measures for evidence handling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.29",name:"Security during disruption",category:"Business Continuity",description:"Implement and maintain measures for security during disruption to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.30",name:"ICT continuity readiness",category:"Business Continuity",description:"Plan, implement, and test continuity arrangements to meet recovery objectives during disruption.",frameworks:["ISO 27001"]},
            {id:"ISO-5.31",name:"Legal/regulatory/contract",category:"Compliance",description:"Implement and maintain measures for legal/regulatory/contract to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.32",name:"Intellectual property",category:"Compliance",description:"Implement and maintain measures for intellectual property to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.33",name:"Records protection",category:"Compliance",description:"Implement and maintain measures for records protection to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.34",name:"Privacy & personal data",category:"Data Protection",description:"Identify privacy/PII requirements and implement measures to protect personal data appropriately.",frameworks:["ISO 27001"]},
            {id:"ISO-5.35",name:"Independent security review",category:"Compliance",description:"Implement and maintain measures for independent security review to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-5.36",name:"Compliance with policies/standards",category:"Compliance",description:"Define, approve, communicate, and periodically review this policy to guide information security.",frameworks:["ISO 27001"]},
            {id:"ISO-5.37",name:"Documented operating procedures",category:"Policy & Governance",description:"Implement and maintain measures for documented operating procedures to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.1",name:"Screening checks",category:"Policy & Governance",description:"Implement and maintain measures for screening checks to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.2",name:"Terms & conditions",category:"Policy & Governance",description:"Implement and maintain measures for terms & conditions to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.3",name:"Awareness and training",category:"Policy & Governance",description:"Provide role-based awareness and training to ensure personnel understand responsibilities and threats.",frameworks:["ISO 27001"]},
            {id:"ISO-6.4",name:"Disciplinary process",category:"Policy & Governance",description:"Implement and maintain measures for disciplinary process to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.5",name:"Responsibilities after termination",category:"Policy & Governance",description:"Control changes through authorization, testing, documentation, and rollback where appropriate.",frameworks:["ISO 27001"]},
            {id:"ISO-6.6",name:"Confidentiality/NDA",category:"Policy & Governance",description:"Implement and maintain measures for confidentiality/nda to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.7",name:"Remote working security",category:"Access Control",description:"Implement and maintain measures for remote working security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-6.8",name:"Event reporting",category:"Incident Management",description:"Implement and maintain measures for event reporting to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-7.1",name:"Physical security perimeters",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.2",name:"Physical entry controls",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.3",name:"Securing offices/rooms",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.4",name:"Physical monitoring",category:"Physical Security",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-7.5",name:"Protection against threats",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.6",name:"Working in secure areas",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.7",name:"Clear desk / clear screen",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.8",name:"Equipment siting & protection",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.9",name:"Off-premises asset security",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.10",name:"Storage media",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.11",name:"Supporting utilities",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.12",name:"Cabling security",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.13",name:"Equipment maintenance",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-7.14",name:"Secure disposal / reuse",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
            {id:"ISO-8.1",name:"Endpoint devices",category:"Asset Management",description:"Implement and maintain measures for endpoint devices to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.2",name:"Privileged access",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.3",name:"Information access restrictions",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.4",name:"Source code access",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.5",name:"Secure authentication",category:"Access Control",description:"Implement and maintain measures for secure authentication to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.6",name:"Capacity management",category:"Business Continuity",description:"Implement and maintain measures for capacity management to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.7",name:"Malware protection",category:"Network Security",description:"Deploy preventive and detective measures to reduce malware infection and impact.",frameworks:["ISO 27001"]},
            {id:"ISO-8.8",name:"Vulnerability management",category:"Risk Management",description:"Identify, assess, prioritize, and remediate technical vulnerabilities within defined timelines.",frameworks:["ISO 27001"]},
            {id:"ISO-8.9",name:"Configuration management",category:"Asset Management",description:"Define secure configuration baselines and manage changes to reduce unintended exposure and drift.",frameworks:["ISO 27001"]},
            {id:"ISO-8.10",name:"Information deletion",category:"Data Protection",description:"Ensure information and media are securely deleted/disposed to prevent unauthorized recovery.",frameworks:["ISO 27001"]},
            {id:"ISO-8.11",name:"Data masking",category:"Data Protection",description:"Implement and maintain measures for data masking to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.12",name:"Data leakage prevention",category:"Data Protection",description:"Implement and maintain measures for data leakage prevention to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.13",name:"Backups",category:"Business Continuity",description:"Perform backups at defined intervals, protect backup media, and regularly test restoration.",frameworks:["ISO 27001"]},
            {id:"ISO-8.14",name:"Redundancy",category:"Business Continuity",description:"Implement and maintain measures for redundancy to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.15",name:"Logging",category:"Logging & Monitoring",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-8.16",name:"Monitoring",category:"Logging & Monitoring",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
            {id:"ISO-8.17",name:"Clock synchronization",category:"Logging & Monitoring",description:"Implement and maintain measures for clock synchronization to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.18",name:"Admin utilities",category:"Access Control",description:"Implement and maintain measures for admin utilities to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.19",name:"Software installation controls",category:"Asset Management",description:"Implement and maintain measures for software installation controls to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.20",name:"Network security",category:"Network Security",description:"Implement and maintain measures for network security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.21",name:"Network services security",category:"Network Security",description:"Implement and maintain measures for network services security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.22",name:"Network segmentation",category:"Network Security",description:"Implement and maintain measures for network segmentation to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.23",name:"Web filtering",category:"Network Security",description:"Implement and maintain measures for web filtering to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.24",name:"Cryptography use",category:"Data Protection",description:"Use cryptography appropriately and manage keys securely throughout their lifecycle.",frameworks:["ISO 27001"]},
            {id:"ISO-8.25",name:"Secure development lifecycle",category:"Asset Management",description:"Integrate security into the SDLC, including requirements, design, coding, testing, and release controls.",frameworks:["ISO 27001"]},
            {id:"ISO-8.26",name:"Application security requirements",category:"Asset Management",description:"Implement and maintain measures for application security requirements to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.27",name:"Secure system architecture",category:"Asset Management",description:"Implement and maintain measures for secure system architecture to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.28",name:"Secure coding",category:"Asset Management",description:"Implement and maintain measures for secure coding to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.29",name:"Security testing in development",category:"Asset Management",description:"Implement and maintain measures for security testing in development to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.30",name:"Outsourced development",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
            {id:"ISO-8.31",name:"Separation of environments",category:"Asset Management",description:"Implement and maintain measures for separation of dev/test/prod to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.32",name:"Change management",category:"Asset Management",description:"Control changes through authorization, testing, documentation, and rollback where appropriate.",frameworks:["ISO 27001"]},
            {id:"ISO-8.33",name:"Test data protection",category:"Data Protection",description:"Implement and maintain measures for test data protection to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            {id:"ISO-8.34",name:"Audit system protection",category:"Compliance",description:"Implement and maintain measures for protection of info systems during audits to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
            // NIST CSF 2.0 (20 key controls)
            {id:"NIST-ID.AM-01",name:"Physical devices inventory",category:"Asset Management",description:"Inventories of physical devices maintained.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-02",name:"Software inventory",category:"Asset Management",description:"Inventories of software platforms maintained.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-01",name:"Cybersecurity policy",category:"Policy & Governance",description:"Organizational cybersecurity policy established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-01",name:"Asset vulnerabilities",category:"Risk Management",description:"Asset vulnerabilities identified and documented.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-02",name:"Cyber threat intelligence",category:"Risk Management",description:"Cyber threat intelligence received from sharing forums.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RM-01",name:"Risk management processes",category:"Risk Management",description:"Risk management processes established and managed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-01",name:"Supply chain risk management",category:"Vendor Management",description:"Cyber supply chain risk processes established.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-01",name:"Identity management",category:"Access Control",description:"Identities and credentials managed for authorized access.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-01",name:"Security awareness",category:"Policy & Governance",description:"All users informed and trained on cybersecurity responsibilities.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-01",name:"Data-at-rest protection",category:"Data Protection",description:"Data-at-rest is protected.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-02",name:"Data-in-transit protection",category:"Data Protection",description:"Data-in-transit is protected.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-01",name:"Baseline configuration",category:"Asset Management",description:"Baseline configuration of IT systems created and maintained.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-04",name:"Backups maintained",category:"Business Continuity",description:"Backups of information conducted and tested.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.PT-01",name:"Audit records",category:"Logging & Monitoring",description:"Audit/log records determined and reviewed.",frameworks:["NIST CSF"]},
            {id:"NIST-DE.CM-01",name:"Network monitoring",category:"Logging & Monitoring",description:"Network monitored to detect cybersecurity events.",frameworks:["NIST CSF"]},
            {id:"NIST-DE.CM-04",name:"Malicious code detection",category:"Network Security",description:"Malicious code is detected.",frameworks:["NIST CSF"]},
            {id:"NIST-RS.RP-01",name:"Response plan execution",category:"Incident Management",description:"Response plan executed during incidents.",frameworks:["NIST CSF"]},
            {id:"NIST-RS.MI-01",name:"Incident containment",category:"Incident Management",description:"Incidents are contained.",frameworks:["NIST CSF"]},
            {id:"NIST-RC.RP-01",name:"Recovery plan execution",category:"Business Continuity",description:"Recovery plan executed after incidents.",frameworks:["NIST CSF"]},
            {id:"NIST-RC.IM-01",name:"Recovery improvements",category:"Business Continuity",description:"Recovery plans incorporate lessons learned.",frameworks:["NIST CSF"]},
            // PCI DSS v4.0 (20 key controls)
            {id:"PCI-1.1.1",name:"Firewall standards",category:"Network Security",description:"Formal standards for firewall and router configurations.",frameworks:["PCI DSS"]},
            {id:"PCI-1.2.1",name:"Configuration standards",category:"Network Security",description:"Configuration standards for network security controls.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.1",name:"System configuration standards",category:"Asset Management",description:"Configuration standards for all system components.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.2",name:"Vendor defaults management",category:"Access Control",description:"Vendor default accounts managed before deployment.",frameworks:["PCI DSS"]},
            {id:"PCI-3.2.1",name:"Account data minimization",category:"Data Protection",description:"Account data storage kept to minimum.",frameworks:["PCI DSS"]},
            {id:"PCI-3.3.1",name:"PAN masking",category:"Data Protection",description:"PAN masked when displayed.",frameworks:["PCI DSS"]},
            {id:"PCI-3.4.1",name:"Cryptographic keys storage",category:"Data Protection",description:"Cryptographic keys stored securely.",frameworks:["PCI DSS"]},
            {id:"PCI-4.2.1",name:"Strong cryptography",category:"Data Protection",description:"Strong cryptography for PAN transmission.",frameworks:["PCI DSS"]},
            {id:"PCI-5.2.1",name:"Anti-malware deployed",category:"Network Security",description:"Anti-malware mechanisms deployed.",frameworks:["PCI DSS"]},
            {id:"PCI-5.2.2",name:"Phishing protection",category:"Network Security",description:"Technical mechanisms protect against phishing.",frameworks:["PCI DSS"]},
            {id:"PCI-6.3.1",name:"System component inventory",category:"Asset Management",description:"Inventory of in-scope system components maintained.",frameworks:["PCI DSS"]},
            {id:"PCI-6.4.1",name:"Public-facing applications",category:"Asset Management",description:"Public-facing web applications protected.",frameworks:["PCI DSS"]},
            {id:"PCI-7.2.1",name:"User access management",category:"Access Control",description:"User access to system components managed.",frameworks:["PCI DSS"]},
            {id:"PCI-8.2.1",name:"Unique user IDs",category:"Access Control",description:"Unique user IDs assigned to each user.",frameworks:["PCI DSS"]},
            {id:"PCI-8.3.1",name:"Multi-factor authentication",category:"Access Control",description:"MFA for remote network access.",frameworks:["PCI DSS"]},
            {id:"PCI-9.1.1",name:"Physical access controls",category:"Physical Security",description:"Physical access to cardholder data controlled.",frameworks:["PCI DSS"]},
            {id:"PCI-10.2.1",name:"Audit trails",category:"Logging & Monitoring",description:"Audit trails implemented to track user activities.",frameworks:["PCI DSS"]},
            {id:"PCI-11.3.1",name:"External penetration testing",category:"Risk Management",description:"External penetration testing performed.",frameworks:["PCI DSS"]},
            {id:"PCI-12.1.1",name:"Security policy",category:"Policy & Governance",description:"Overall information security policy established.",frameworks:["PCI DSS"]},
            {id:"PCI-12.6.1",name:"Security awareness program",category:"Policy & Governance",description:"Formal security awareness program implemented.",frameworks:["PCI DSS"]},
            // HIPAA (15 key controls)
            {id:"HIPAA-164.308(a)(1)",name:"Security management",category:"Policy & Governance",description:"Policies to prevent, detect and correct security violations.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(1)(ii)(A)",name:"Risk analysis",category:"Risk Management",description:"Assess potential risks to ePHI confidentiality, integrity, availability.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(1)(ii)(B)",name:"Risk management",category:"Risk Management",description:"Implement measures to reduce risks to reasonable level.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)",name:"Workforce security",category:"Policy & Governance",description:"Ensure workforce has appropriate access to ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)",name:"Access management",category:"Access Control",description:"Policies for authorizing access to ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)",name:"Security awareness",category:"Policy & Governance",description:"Security awareness and training program for workforce.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(6)",name:"Security incidents",category:"Incident Management",description:"Policies to address security incidents.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)",name:"Contingency plan",category:"Business Continuity",description:"Policies for responding to emergencies.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(1)",name:"Facility access controls",category:"Physical Security",description:"Limit physical access to systems with ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(d)(1)",name:"Device controls",category:"Physical Security",description:"Govern receipt and removal of hardware/media.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(a)(1)",name:"Access control",category:"Access Control",description:"Allow access only to authorized persons/software.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(a)(2)(iv)",name:"Encryption",category:"Data Protection",description:"Mechanism to encrypt and decrypt ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(b)",name:"Audit controls",category:"Logging & Monitoring",description:"Record and examine activity in systems with ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(d)",name:"Person authentication",category:"Access Control",description:"Verify person seeking access is the one claimed.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.312(e)(1)",name:"Transmission security",category:"Network Security",description:"Guard against unauthorized access to ePHI in transit.",frameworks:["HIPAA"]},
            // SOC 2 (20 key controls)
            {id:"SOC2-CC1.1",name:"Integrity and ethics",category:"Policy & Governance",description:"Demonstrates commitment to integrity and ethical values.",frameworks:["SOC 2"]},
            {id:"SOC2-CC1.2",name:"Board oversight",category:"Policy & Governance",description:"Board exercises oversight of internal control.",frameworks:["SOC 2"]},
            {id:"SOC2-CC2.1",name:"Risk assessment objectives",category:"Risk Management",description:"Objectives specified with sufficient clarity.",frameworks:["SOC 2"]},
            {id:"SOC2-CC2.2",name:"Risk identification",category:"Risk Management",description:"Identifies and analyzes risks across entity.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.1",name:"Policies and procedures",category:"Policy & Governance",description:"Establishes policies and procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC4.1",name:"Monitoring activities",category:"Logging & Monitoring",description:"Performs ongoing evaluations of internal control.",frameworks:["SOC 2"]},
            {id:"SOC2-CC5.1",name:"Control activities",category:"Policy & Governance",description:"Selects control activities to mitigate risks.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.1",name:"Logical and physical access",category:"Access Control",description:"Implements access controls to protect data.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.2",name:"User registration",category:"Access Control",description:"Registers and authorizes new users.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.6",name:"Data classification",category:"Data Protection",description:"Implements logical access security measures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.1",name:"System operations",category:"Logging & Monitoring",description:"Uses detection and monitoring procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.2",name:"Incident response",category:"Incident Management",description:"Monitors system components for anomalies.",frameworks:["SOC 2"]},
            {id:"SOC2-CC8.1",name:"Change management",category:"Asset Management",description:"Authorizes, tests and implements changes.",frameworks:["SOC 2"]},
            {id:"SOC2-CC9.1",name:"Risk mitigation",category:"Risk Management",description:"Identifies and develops risk mitigation activities.",frameworks:["SOC 2"]},
            {id:"SOC2-A1.1",name:"Availability commitments",category:"Business Continuity",description:"Maintains and monitors processing capacity.",frameworks:["SOC 2"]},
            {id:"SOC2-C1.1",name:"Confidentiality commitments",category:"Data Protection",description:"Identifies and maintains confidential information.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.1",name:"Processing integrity",category:"Data Protection",description:"Obtains and uses quality information for processing.",frameworks:["SOC 2"]},
            {id:"SOC2-P1.1",name:"Privacy notice",category:"Data Protection",description:"Provides notice about privacy practices.",frameworks:["SOC 2"]},
            {id:"SOC2-P2.1",name:"Choice and consent",category:"Data Protection",description:"Communicates choices about personal information.",frameworks:["SOC 2"]},
            {id:"SOC2-P4.1",name:"Access to personal info",category:"Data Protection",description:"Grants data subjects access to their information.",frameworks:["SOC 2"]},
            // CIS Controls v8 (20 key controls)
            {id:"CIS-1.1",name:"Enterprise asset inventory",category:"Asset Management",description:"Maintain accurate inventory of enterprise assets.",frameworks:["CIS Controls"]},
            {id:"CIS-2.1",name:"Software inventory",category:"Asset Management",description:"Maintain detailed inventory of authorized software.",frameworks:["CIS Controls"]},
            {id:"CIS-3.1",name:"Data management",category:"Data Protection",description:"Establish data management process.",frameworks:["CIS Controls"]},
            {id:"CIS-3.3",name:"Data access control",category:"Access Control",description:"Configure data access control lists.",frameworks:["CIS Controls"]},
            {id:"CIS-3.10",name:"Encrypt data in transit",category:"Data Protection",description:"Encrypt sensitive data in transit.",frameworks:["CIS Controls"]},
            {id:"CIS-3.11",name:"Encrypt data at rest",category:"Data Protection",description:"Encrypt sensitive data at rest.",frameworks:["CIS Controls"]},
            {id:"CIS-4.1",name:"Secure configuration",category:"Asset Management",description:"Establish secure configuration process.",frameworks:["CIS Controls"]},
            {id:"CIS-5.1",name:"Account inventory",category:"Access Control",description:"Maintain inventory of accounts.",frameworks:["CIS Controls"]},
            {id:"CIS-5.3",name:"Disable dormant accounts",category:"Access Control",description:"Delete or disable dormant accounts.",frameworks:["CIS Controls"]},
            {id:"CIS-5.4",name:"Restrict admin privileges",category:"Access Control",description:"Restrict administrator privileges.",frameworks:["CIS Controls"]},
            {id:"CIS-6.1",name:"Access granting process",category:"Access Control",description:"Establish access granting process.",frameworks:["CIS Controls"]},
            {id:"CIS-6.3",name:"MFA for external apps",category:"Access Control",description:"Require MFA for externally-exposed applications.",frameworks:["CIS Controls"]},
            {id:"CIS-6.4",name:"MFA for remote access",category:"Access Control",description:"Require MFA for remote network access.",frameworks:["CIS Controls"]},
            {id:"CIS-7.1",name:"Vulnerability management",category:"Risk Management",description:"Establish vulnerability management process.",frameworks:["CIS Controls"]},
            {id:"CIS-7.3",name:"Automated OS patching",category:"Asset Management",description:"Perform automated OS patch management.",frameworks:["CIS Controls"]},
            {id:"CIS-7.4",name:"Automated app patching",category:"Asset Management",description:"Perform automated application patching.",frameworks:["CIS Controls"]},
            {id:"CIS-8.1",name:"Audit log management",category:"Logging & Monitoring",description:"Establish audit log management process.",frameworks:["CIS Controls"]},
            {id:"CIS-10.1",name:"Malware defenses",category:"Network Security",description:"Deploy and maintain anti-malware software.",frameworks:["CIS Controls"]},
            {id:"CIS-11.1",name:"Data recovery capability",category:"Business Continuity",description:"Establish data recovery processes.",frameworks:["CIS Controls"]},
            {id:"CIS-16.1",name:"Application security",category:"Asset Management",description:"Establish secure application development.",frameworks:["CIS Controls"]},
            // GDPR (10 key controls)
            {id:"GDPR-5.1",name:"Lawfulness of processing",category:"Data Protection",description:"Personal data processed lawfully, fairly, transparently.",frameworks:["GDPR"]},
            {id:"GDPR-5.2",name:"Purpose limitation",category:"Data Protection",description:"Data collected for specified, legitimate purposes.",frameworks:["GDPR"]},
            {id:"GDPR-5.3",name:"Data minimization",category:"Data Protection",description:"Data adequate, relevant, limited to what is necessary.",frameworks:["GDPR"]},
            {id:"GDPR-5.4",name:"Accuracy",category:"Data Protection",description:"Personal data kept accurate and up to date.",frameworks:["GDPR"]},
            {id:"GDPR-5.5",name:"Storage limitation",category:"Data Protection",description:"Data kept no longer than necessary.",frameworks:["GDPR"]},
            {id:"GDPR-5.6",name:"Integrity and confidentiality",category:"Data Protection",description:"Appropriate security for personal data.",frameworks:["GDPR"]},
            {id:"GDPR-12",name:"Transparent communication",category:"Data Protection",description:"Clear communication about data processing.",frameworks:["GDPR"]},
            {id:"GDPR-15",name:"Right of access",category:"Data Protection",description:"Data subjects can access their personal data.",frameworks:["GDPR"]},
            {id:"GDPR-17",name:"Right to erasure",category:"Data Protection",description:"Data subjects can request data deletion.",frameworks:["GDPR"]},
            {id:"GDPR-32",name:"Security of processing",category:"Data Protection",description:"Implement appropriate technical and organizational measures.",frameworks:["GDPR"]},
            // CMMC (10 key controls)
            {id:"CMMC-AC.1.001",name:"Limit system access",category:"Access Control",description:"Limit information system access to authorized users.",frameworks:["CMMC"]},
            {id:"CMMC-AC.1.002",name:"Limit transactions",category:"Access Control",description:"Limit access to types of transactions and functions.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.007",name:"Least privilege",category:"Access Control",description:"Employ least privilege principle.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.008",name:"Privileged functions",category:"Access Control",description:"Use non-privileged accounts for non-security functions.",frameworks:["CMMC"]},
            {id:"CMMC-IA.1.076",name:"Identify users",category:"Access Control",description:"Identify information system users.",frameworks:["CMMC"]},
            {id:"CMMC-IA.1.077",name:"Authenticate users",category:"Access Control",description:"Authenticate users as prerequisite to access.",frameworks:["CMMC"]},
            {id:"CMMC-SC.1.175",name:"Monitor communications",category:"Network Security",description:"Monitor, control, protect communications at boundaries.",frameworks:["CMMC"]},
            {id:"CMMC-SC.1.176",name:"Subnetworks",category:"Network Security",description:"Implement subnetworks for publicly accessible components.",frameworks:["CMMC"]},
            {id:"CMMC-SI.1.210",name:"Flaw remediation",category:"Risk Management",description:"Identify, report, correct information flaws timely.",frameworks:["CMMC"]},
            {id:"CMMC-SI.1.211",name:"Malicious code protection",category:"Network Security",description:"Provide protection from malicious code.",frameworks:["CMMC"]},
            // COBIT (10 key controls)
            {id:"COBIT-APO01.03",name:"Management framework",category:"Policy & Governance",description:"Maintain enablers of the management system.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.01",name:"Data collection",category:"Risk Management",description:"Collect data on risk management activities.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.02",name:"Risk analysis",category:"Risk Management",description:"Develop useful information to support risk decisions.",frameworks:["COBIT"]},
            {id:"COBIT-APO13.01",name:"ISMS establishment",category:"Policy & Governance",description:"Establish and maintain an ISMS.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.01",name:"Change evaluation",category:"Asset Management",description:"Evaluate and authorize change requests.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.01",name:"Malware protection",category:"Network Security",description:"Protect information systems from malware.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.02",name:"Network security",category:"Network Security",description:"Maintain network security mechanisms.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.04",name:"User access management",category:"Access Control",description:"Manage user identity and logical access.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.05",name:"Physical access",category:"Physical Security",description:"Manage physical access to IT assets.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.07",name:"Security monitoring",category:"Logging & Monitoring",description:"Monitor infrastructure for security events.",frameworks:["COBIT"]},
            // Additional NIST CSF Controls (40 more)
            {id:"NIST-ID.AM-03",name:"Data flow mapping",category:"Asset Management",description:"Organizational communication and data flows mapped.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-04",name:"External information systems",category:"Asset Management",description:"External information systems catalogued.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-05",name:"Resource prioritization",category:"Asset Management",description:"Resources prioritized based on classification and business value.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.AM-06",name:"Cybersecurity roles",category:"Policy & Governance",description:"Cybersecurity roles and responsibilities established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-01",name:"Supply chain role",category:"Risk Management",description:"Organization's role in supply chain identified.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-02",name:"Critical infrastructure",category:"Asset Management",description:"Organization's place in critical infrastructure identified.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-03",name:"Organizational mission",category:"Policy & Governance",description:"Priorities for organizational mission established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-04",name:"Dependencies",category:"Risk Management",description:"Dependencies and critical functions established.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.BE-05",name:"Resilience requirements",category:"Business Continuity",description:"Resilience requirements established for delivery of services.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-02",name:"Legal requirements",category:"Compliance",description:"Cybersecurity roles coordinated with external partners.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-03",name:"Regulatory requirements",category:"Compliance",description:"Legal and regulatory requirements understood and managed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.GV-04",name:"Governance processes",category:"Policy & Governance",description:"Governance and risk management processes address cybersecurity.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-03",name:"Internal threats",category:"Risk Management",description:"Threats, internal and external, identified and documented.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-04",name:"Business impacts",category:"Risk Management",description:"Potential business impacts and likelihoods identified.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-05",name:"Risk responses",category:"Risk Management",description:"Threats, vulnerabilities, likelihoods used to determine risk.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RA-06",name:"Risk response selection",category:"Risk Management",description:"Risk responses identified and prioritized.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RM-02",name:"Risk tolerance",category:"Risk Management",description:"Organizational risk tolerance determined and expressed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.RM-03",name:"Risk-informed decisions",category:"Risk Management",description:"Risk tolerance informed by role in critical infrastructure.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-02",name:"Supplier identification",category:"Vendor Management",description:"Suppliers and partners identified and prioritized.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-03",name:"Supplier contracts",category:"Vendor Management",description:"Contracts with suppliers address cybersecurity.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-04",name:"Supplier assessments",category:"Vendor Management",description:"Suppliers and partners routinely assessed.",frameworks:["NIST CSF"]},
            {id:"NIST-ID.SC-05",name:"Supplier testing",category:"Vendor Management",description:"Response and recovery planning tested with suppliers.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-02",name:"Physical access management",category:"Physical Security",description:"Physical access to assets managed and protected.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-03",name:"Remote access management",category:"Access Control",description:"Remote access managed.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-04",name:"Access permissions",category:"Access Control",description:"Access permissions managed with least privilege.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-05",name:"Network integrity",category:"Network Security",description:"Network integrity protected with segregation.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-06",name:"Identity proofing",category:"Access Control",description:"Identities proofed, bound to credentials, and authenticated.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AC-07",name:"Strong authentication",category:"Access Control",description:"Users, devices authenticated commensurate with risk.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-02",name:"Privileged user training",category:"Policy & Governance",description:"Privileged users understand roles and responsibilities.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-03",name:"Third-party training",category:"Vendor Management",description:"Third-party stakeholders understand roles.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-04",name:"Senior executive awareness",category:"Policy & Governance",description:"Senior executives understand roles and responsibilities.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.AT-05",name:"Physical security training",category:"Physical Security",description:"Physical and cybersecurity personnel understand roles.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-03",name:"Asset management",category:"Asset Management",description:"Assets formally managed throughout lifecycle.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-04",name:"Availability maintained",category:"Business Continuity",description:"Adequate capacity ensures availability.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-05",name:"Data leakage prevention",category:"Data Protection",description:"Protections against data leaks implemented.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-06",name:"Integrity checking",category:"Data Protection",description:"Integrity checking mechanisms verify software integrity.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-07",name:"Development environments",category:"Asset Management",description:"Development and testing environments separate from production.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.DS-08",name:"Hardware integrity",category:"Asset Management",description:"Integrity checking mechanisms verify hardware integrity.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-02",name:"SDLC management",category:"Asset Management",description:"System development life cycle implemented.",frameworks:["NIST CSF"]},
            {id:"NIST-PR.IP-03",name:"Configuration management",category:"Asset Management",description:"Configuration change control processes in place.",frameworks:["NIST CSF"]},
            // Additional PCI DSS Controls (30 more)
            {id:"PCI-1.3.1",name:"DMZ implementation",category:"Network Security",description:"DMZ implemented to limit inbound traffic.",frameworks:["PCI DSS"]},
            {id:"PCI-1.3.2",name:"Inbound traffic restriction",category:"Network Security",description:"Inbound internet traffic limited to DMZ.",frameworks:["PCI DSS"]},
            {id:"PCI-1.3.3",name:"Anti-spoofing measures",category:"Network Security",description:"Anti-spoofing measures implemented.",frameworks:["PCI DSS"]},
            {id:"PCI-1.3.4",name:"Outbound traffic authorization",category:"Network Security",description:"Outbound traffic from CDE explicitly authorized.",frameworks:["PCI DSS"]},
            {id:"PCI-1.4.1",name:"Personal firewall software",category:"Network Security",description:"Personal firewall software installed on mobile devices.",frameworks:["PCI DSS"]},
            {id:"PCI-2.1.1",name:"Wireless defaults changed",category:"Network Security",description:"Wireless vendor defaults changed at installation.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.3",name:"Security features enabled",category:"Asset Management",description:"Primary security features configured.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.4",name:"Non-essential removed",category:"Asset Management",description:"Unnecessary functionality removed.",frameworks:["PCI DSS"]},
            {id:"PCI-2.2.5",name:"Security parameters documented",category:"Asset Management",description:"System security parameters configured.",frameworks:["PCI DSS"]},
            {id:"PCI-2.3.1",name:"Encrypted admin access",category:"Access Control",description:"All non-console administrative access encrypted.",frameworks:["PCI DSS"]},
            {id:"PCI-3.1.1",name:"Data retention policy",category:"Data Protection",description:"Data retention and disposal policies implemented.",frameworks:["PCI DSS"]},
            {id:"PCI-3.2.2",name:"Data after authorization",category:"Data Protection",description:"Data not stored after authorization.",frameworks:["PCI DSS"]},
            {id:"PCI-3.5.1",name:"Key access restriction",category:"Data Protection",description:"Access to cryptographic keys restricted.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.1",name:"Key generation",category:"Data Protection",description:"Strong cryptographic key generation.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.2",name:"Key distribution",category:"Data Protection",description:"Secure cryptographic key distribution.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.3",name:"Key storage",category:"Data Protection",description:"Secure cryptographic key storage.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.4",name:"Key changes",category:"Data Protection",description:"Cryptographic key changes for end of cryptoperiod.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.5",name:"Key retirement",category:"Data Protection",description:"Retirement of old keys.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.6",name:"Split knowledge",category:"Data Protection",description:"Split knowledge and dual control for key management.",frameworks:["PCI DSS"]},
            {id:"PCI-3.6.7",name:"Key substitution prevention",category:"Data Protection",description:"Prevention of unauthorized key substitution.",frameworks:["PCI DSS"]},
            {id:"PCI-4.1.1",name:"Trusted keys/certificates",category:"Network Security",description:"Only trusted keys and certificates accepted.",frameworks:["PCI DSS"]},
            {id:"PCI-5.1.1",name:"Anti-malware capability",category:"Network Security",description:"Anti-malware capable of detecting all malware.",frameworks:["PCI DSS"]},
            {id:"PCI-5.3.1",name:"Anti-malware mechanisms active",category:"Network Security",description:"Anti-malware mechanisms actively running.",frameworks:["PCI DSS"]},
            {id:"PCI-5.3.2",name:"Anti-malware logs retained",category:"Logging & Monitoring",description:"Anti-malware logs retained per policy.",frameworks:["PCI DSS"]},
            {id:"PCI-6.2.1",name:"Custom software security",category:"Asset Management",description:"Custom software developed securely.",frameworks:["PCI DSS"]},
            {id:"PCI-6.3.2",name:"Code review",category:"Asset Management",description:"Custom code reviewed before release.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.1",name:"Injection flaws",category:"Asset Management",description:"Injection flaws addressed in development.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.2",name:"Buffer overflows",category:"Asset Management",description:"Buffer overflow addressed in development.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.3",name:"Insecure storage",category:"Data Protection",description:"Insecure cryptographic storage addressed.",frameworks:["PCI DSS"]},
            {id:"PCI-6.5.4",name:"Insecure communications",category:"Network Security",description:"Insecure communications addressed.",frameworks:["PCI DSS"]},
            // Additional HIPAA Controls (25 more)
            {id:"HIPAA-164.308(a)(1)(ii)(C)",name:"Sanction policy",category:"Policy & Governance",description:"Apply appropriate sanctions against workforce members who fail to comply.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(1)(ii)(D)",name:"Information system activity review",category:"Logging & Monitoring",description:"Implement procedures to regularly review records of activity.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)(ii)(A)",name:"Authorization supervision",category:"Access Control",description:"Implement procedures for authorization and supervision.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)(ii)(B)",name:"Workforce clearance",category:"Policy & Governance",description:"Implement procedures to determine access appropriateness.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(3)(ii)(C)",name:"Termination procedures",category:"Access Control",description:"Implement procedures for terminating access.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)(ii)(A)",name:"Isolating healthcare function",category:"Access Control",description:"Isolate healthcare clearinghouse functions.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)(ii)(B)",name:"Access authorization",category:"Access Control",description:"Implement policies for granting access to ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(4)(ii)(C)",name:"Access establishment",category:"Access Control",description:"Implement policies for access establishment and modification.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(A)",name:"Security reminders",category:"Policy & Governance",description:"Periodic security updates.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(B)",name:"Malicious software protection",category:"Network Security",description:"Procedures for guarding against malicious software.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(C)",name:"Log-in monitoring",category:"Logging & Monitoring",description:"Procedures for monitoring log-in attempts.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(5)(ii)(D)",name:"Password management",category:"Access Control",description:"Procedures for creating, changing, and safeguarding passwords.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(6)(ii)",name:"Response and reporting",category:"Incident Management",description:"Identify and respond to suspected security incidents.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(A)",name:"Data backup plan",category:"Business Continuity",description:"Establish procedures to create and maintain exact copies of ePHI.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(B)",name:"Disaster recovery plan",category:"Business Continuity",description:"Establish procedures to restore lost data.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(C)",name:"Emergency mode operations",category:"Business Continuity",description:"Establish procedures for emergency mode operation.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(D)",name:"Testing and revision",category:"Business Continuity",description:"Implement procedures for periodic testing of contingency plans.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(7)(ii)(E)",name:"Applications and data criticality",category:"Business Continuity",description:"Assess relative criticality of applications and data.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.308(a)(8)",name:"Evaluation",category:"Compliance",description:"Perform periodic technical and non-technical evaluation.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(i)",name:"Contingency operations",category:"Physical Security",description:"Establish procedures for facility access during emergency.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(ii)",name:"Facility security plan",category:"Physical Security",description:"Implement policies to safeguard the facility.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(iii)",name:"Access control and validation",category:"Physical Security",description:"Implement procedures to control and validate access.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(a)(2)(iv)",name:"Maintenance records",category:"Physical Security",description:"Implement policies to document repairs and modifications.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(b)",name:"Workstation use",category:"Physical Security",description:"Implement policies for proper workstation use.",frameworks:["HIPAA"]},
            {id:"HIPAA-164.310(c)",name:"Workstation security",category:"Physical Security",description:"Implement physical safeguards for workstations.",frameworks:["HIPAA"]},
            // Additional SOC 2 Controls (30 more)
            {id:"SOC2-CC1.3",name:"Structure and authority",category:"Policy & Governance",description:"Management establishes organizational structure.",frameworks:["SOC 2"]},
            {id:"SOC2-CC1.4",name:"Competence commitment",category:"Policy & Governance",description:"Demonstrates commitment to competence.",frameworks:["SOC 2"]},
            {id:"SOC2-CC1.5",name:"Accountability",category:"Policy & Governance",description:"Holds individuals accountable for responsibilities.",frameworks:["SOC 2"]},
            {id:"SOC2-CC2.3",name:"Internal communication",category:"Policy & Governance",description:"Internally communicates necessary information.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.2",name:"Change identification",category:"Risk Management",description:"Identifies and assesses changes.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.3",name:"Fraud risk",category:"Risk Management",description:"Considers potential for fraud.",frameworks:["SOC 2"]},
            {id:"SOC2-CC3.4",name:"Risk assessment update",category:"Risk Management",description:"Risk assessment updated for changes.",frameworks:["SOC 2"]},
            {id:"SOC2-CC4.2",name:"Deficiency evaluation",category:"Compliance",description:"Evaluates and communicates deficiencies.",frameworks:["SOC 2"]},
            {id:"SOC2-CC5.2",name:"Technology controls",category:"Asset Management",description:"Selects and develops technology controls.",frameworks:["SOC 2"]},
            {id:"SOC2-CC5.3",name:"Policy deployment",category:"Policy & Governance",description:"Deploys control activities through policies.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.3",name:"Authorization removal",category:"Access Control",description:"Removes access when no longer required.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.4",name:"Access review",category:"Access Control",description:"Reviews access rights periodically.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.5",name:"Physical restrictions",category:"Physical Security",description:"Restricts physical access to facilities.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.7",name:"Transmission protection",category:"Network Security",description:"Restricts transmission of data.",frameworks:["SOC 2"]},
            {id:"SOC2-CC6.8",name:"Malware prevention",category:"Network Security",description:"Implements controls to prevent malware.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.3",name:"Security event evaluation",category:"Incident Management",description:"Evaluates security events.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.4",name:"Incident response",category:"Incident Management",description:"Responds to identified security incidents.",frameworks:["SOC 2"]},
            {id:"SOC2-CC7.5",name:"Incident recovery",category:"Incident Management",description:"Identifies and executes recovery procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-CC9.2",name:"Vendor risk management",category:"Vendor Management",description:"Assesses and manages vendor risk.",frameworks:["SOC 2"]},
            {id:"SOC2-A1.2",name:"Environmental protections",category:"Physical Security",description:"Protects against environmental threats.",frameworks:["SOC 2"]},
            {id:"SOC2-A1.3",name:"Recovery testing",category:"Business Continuity",description:"Tests recovery procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-C1.2",name:"Confidential data disposal",category:"Data Protection",description:"Disposes of confidential information.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.2",name:"Input validation",category:"Data Protection",description:"Implements input validation.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.3",name:"Processing accuracy",category:"Data Protection",description:"Implements processing accuracy checks.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.4",name:"Output completeness",category:"Data Protection",description:"Implements output completeness checks.",frameworks:["SOC 2"]},
            {id:"SOC2-PI1.5",name:"Input/output reconciliation",category:"Data Protection",description:"Implements reconciliation procedures.",frameworks:["SOC 2"]},
            {id:"SOC2-P3.1",name:"Personal info collection",category:"Data Protection",description:"Collects personal information for stated purposes.",frameworks:["SOC 2"]},
            {id:"SOC2-P4.2",name:"Personal info correction",category:"Data Protection",description:"Corrects personal information upon request.",frameworks:["SOC 2"]},
            {id:"SOC2-P5.1",name:"Disclosure to third parties",category:"Data Protection",description:"Discloses personal information to third parties appropriately.",frameworks:["SOC 2"]},
            {id:"SOC2-P6.1",name:"Personal info quality",category:"Data Protection",description:"Personal information quality maintained.",frameworks:["SOC 2"]},
            // Additional CIS Controls (30 more)
            {id:"CIS-1.2",name:"Address unauthorized assets",category:"Asset Management",description:"Ensure unauthorized assets are addressed.",frameworks:["CIS Controls"]},
            {id:"CIS-1.3",name:"DHCP logging",category:"Logging & Monitoring",description:"Utilize DHCP logging to update inventory.",frameworks:["CIS Controls"]},
            {id:"CIS-1.4",name:"Detailed asset inventory",category:"Asset Management",description:"Use detailed asset inventory.",frameworks:["CIS Controls"]},
            {id:"CIS-1.5",name:"Asset information quality",category:"Asset Management",description:"Ensure asset inventory information quality.",frameworks:["CIS Controls"]},
            {id:"CIS-2.2",name:"Authorized software inventory",category:"Asset Management",description:"Ensure authorized software is currently supported.",frameworks:["CIS Controls"]},
            {id:"CIS-2.3",name:"Address unauthorized software",category:"Asset Management",description:"Ensure unauthorized software is addressed.",frameworks:["CIS Controls"]},
            {id:"CIS-2.4",name:"Software inventory tool",category:"Asset Management",description:"Utilize automated software inventory tools.",frameworks:["CIS Controls"]},
            {id:"CIS-2.5",name:"Allowlisting software",category:"Asset Management",description:"Use application allowlisting technology.",frameworks:["CIS Controls"]},
            {id:"CIS-2.6",name:"Allowlist libraries",category:"Asset Management",description:"Allowlist authorized libraries.",frameworks:["CIS Controls"]},
            {id:"CIS-2.7",name:"Allowlist scripts",category:"Asset Management",description:"Allowlist authorized scripts.",frameworks:["CIS Controls"]},
            {id:"CIS-3.2",name:"Data inventory",category:"Data Protection",description:"Maintain data inventory.",frameworks:["CIS Controls"]},
            {id:"CIS-3.4",name:"Data classification enforcement",category:"Data Protection",description:"Enforce data classification policies.",frameworks:["CIS Controls"]},
            {id:"CIS-3.5",name:"Sensitive data documentation",category:"Data Protection",description:"Document data flows.",frameworks:["CIS Controls"]},
            {id:"CIS-3.6",name:"Encrypt mobile device data",category:"Data Protection",description:"Encrypt data on mobile devices.",frameworks:["CIS Controls"]},
            {id:"CIS-3.7",name:"Removable media encryption",category:"Data Protection",description:"Encrypt data on removable media.",frameworks:["CIS Controls"]},
            {id:"CIS-3.8",name:"Removable media management",category:"Data Protection",description:"Manage removable storage devices.",frameworks:["CIS Controls"]},
            {id:"CIS-3.9",name:"Remote storage encryption",category:"Data Protection",description:"Encrypt data on remote storage.",frameworks:["CIS Controls"]},
            {id:"CIS-3.12",name:"Network data segmentation",category:"Network Security",description:"Segment data processing and storage.",frameworks:["CIS Controls"]},
            {id:"CIS-3.13",name:"Data disposal process",category:"Data Protection",description:"Deploy secure disposal process.",frameworks:["CIS Controls"]},
            {id:"CIS-3.14",name:"Data disposal logging",category:"Data Protection",description:"Log sensitive data access.",frameworks:["CIS Controls"]},
            {id:"CIS-4.2",name:"Secure image maintenance",category:"Asset Management",description:"Maintain secure configuration images.",frameworks:["CIS Controls"]},
            {id:"CIS-4.3",name:"Secure configuration for portable devices",category:"Asset Management",description:"Configure devices to use secure configuration.",frameworks:["CIS Controls"]},
            {id:"CIS-4.4",name:"Firewall host-based",category:"Network Security",description:"Implement and manage host-based firewall.",frameworks:["CIS Controls"]},
            {id:"CIS-4.5",name:"Unused services and ports",category:"Network Security",description:"Uninstall unnecessary services.",frameworks:["CIS Controls"]},
            {id:"CIS-4.6",name:"DNS filtering",category:"Network Security",description:"Configure DNS filtering services.",frameworks:["CIS Controls"]},
            {id:"CIS-4.7",name:"Email filtering",category:"Network Security",description:"Configure email filtering services.",frameworks:["CIS Controls"]},
            {id:"CIS-4.8",name:"DMARC implementation",category:"Network Security",description:"Implement DMARC.",frameworks:["CIS Controls"]},
            {id:"CIS-4.9",name:"Block unnecessary file types",category:"Network Security",description:"Block unnecessary file types.",frameworks:["CIS Controls"]},
            {id:"CIS-4.10",name:"Wireless client isolation",category:"Network Security",description:"Enforce wireless client isolation.",frameworks:["CIS Controls"]},
            {id:"CIS-4.11",name:"Browser extensions",category:"Asset Management",description:"Manage default and approved browser extensions.",frameworks:["CIS Controls"]},
            // Additional GDPR Controls (20 more)
            {id:"GDPR-6",name:"Lawful basis",category:"Compliance",description:"Processing has a lawful basis.",frameworks:["GDPR"]},
            {id:"GDPR-7",name:"Conditions for consent",category:"Data Protection",description:"Conditions for consent met.",frameworks:["GDPR"]},
            {id:"GDPR-8",name:"Child consent",category:"Data Protection",description:"Conditions for child consent met.",frameworks:["GDPR"]},
            {id:"GDPR-9",name:"Special categories",category:"Data Protection",description:"Processing of special categories of data.",frameworks:["GDPR"]},
            {id:"GDPR-10",name:"Criminal convictions",category:"Data Protection",description:"Processing relating to criminal convictions.",frameworks:["GDPR"]},
            {id:"GDPR-13",name:"Information provision",category:"Data Protection",description:"Information provided when collecting personal data.",frameworks:["GDPR"]},
            {id:"GDPR-14",name:"Information when not obtained",category:"Data Protection",description:"Information provided when data not obtained from subject.",frameworks:["GDPR"]},
            {id:"GDPR-16",name:"Right to rectification",category:"Data Protection",description:"Data subjects can rectify inaccurate data.",frameworks:["GDPR"]},
            {id:"GDPR-18",name:"Right to restriction",category:"Data Protection",description:"Data subjects can restrict processing.",frameworks:["GDPR"]},
            {id:"GDPR-19",name:"Notification obligation",category:"Data Protection",description:"Notification of rectification or erasure.",frameworks:["GDPR"]},
            {id:"GDPR-20",name:"Right to portability",category:"Data Protection",description:"Data subjects can receive data in portable format.",frameworks:["GDPR"]},
            {id:"GDPR-21",name:"Right to object",category:"Data Protection",description:"Data subjects can object to processing.",frameworks:["GDPR"]},
            {id:"GDPR-22",name:"Automated decision-making",category:"Data Protection",description:"Rights related to automated decision-making.",frameworks:["GDPR"]},
            {id:"GDPR-25",name:"Data protection by design",category:"Data Protection",description:"Data protection by design and default implemented.",frameworks:["GDPR"]},
            {id:"GDPR-28",name:"Processor requirements",category:"Vendor Management",description:"Only processors with sufficient guarantees used.",frameworks:["GDPR"]},
            {id:"GDPR-30",name:"Records of processing",category:"Compliance",description:"Records of processing activities maintained.",frameworks:["GDPR"]},
            {id:"GDPR-33",name:"Breach notification authority",category:"Incident Management",description:"Personal data breaches notified to authority.",frameworks:["GDPR"]},
            {id:"GDPR-34",name:"Breach notification subject",category:"Incident Management",description:"Data subjects notified of high risk breaches.",frameworks:["GDPR"]},
            {id:"GDPR-35",name:"Impact assessments",category:"Risk Management",description:"Data protection impact assessments conducted.",frameworks:["GDPR"]},
            {id:"GDPR-37",name:"DPO designation",category:"Policy & Governance",description:"Data Protection Officer designated when required.",frameworks:["GDPR"]},
            // Additional CMMC Controls (20 more)
            {id:"CMMC-AC.2.005",name:"Separation of duties",category:"Access Control",description:"Separate duties of individuals to reduce risk.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.006",name:"Remote access",category:"Access Control",description:"Limit use of portable storage devices.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.009",name:"Wireless access",category:"Access Control",description:"Limit wireless access.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.010",name:"Session control",category:"Access Control",description:"Limit unsuccessful logon attempts.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.011",name:"Session termination",category:"Access Control",description:"Terminate sessions after defined periods.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.013",name:"Remote session control",category:"Access Control",description:"Monitor and control remote access sessions.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.015",name:"Privileged remote access",category:"Access Control",description:"Route privileged access through managed access points.",frameworks:["CMMC"]},
            {id:"CMMC-AC.2.016",name:"Wireless protection",category:"Network Security",description:"Protect wireless access using authentication and encryption.",frameworks:["CMMC"]},
            {id:"CMMC-AT.2.056",name:"Awareness training",category:"Policy & Governance",description:"Ensure security awareness and training.",frameworks:["CMMC"]},
            {id:"CMMC-AT.2.057",name:"Insider threat awareness",category:"Policy & Governance",description:"Provide insider threat awareness.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.041",name:"Audit content",category:"Logging & Monitoring",description:"Ensure audit logs contain required information.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.042",name:"Audit review",category:"Logging & Monitoring",description:"Review and update audited events.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.043",name:"Audit alerts",category:"Logging & Monitoring",description:"Alert in event of audit process failure.",frameworks:["CMMC"]},
            {id:"CMMC-AU.2.044",name:"Audit correlation",category:"Logging & Monitoring",description:"Correlate audit review and analysis.",frameworks:["CMMC"]},
            {id:"CMMC-CA.2.157",name:"Security assessments",category:"Compliance",description:"Develop and implement security assessment plans.",frameworks:["CMMC"]},
            {id:"CMMC-CA.2.158",name:"Assessment findings",category:"Compliance",description:"Assess security controls periodically.",frameworks:["CMMC"]},
            {id:"CMMC-CA.2.159",name:"Remediation plans",category:"Compliance",description:"Develop plans of action to correct deficiencies.",frameworks:["CMMC"]},
            {id:"CMMC-CM.2.061",name:"Configuration baselines",category:"Asset Management",description:"Establish and maintain configuration baselines.",frameworks:["CMMC"]},
            {id:"CMMC-CM.2.062",name:"Security configuration",category:"Asset Management",description:"Employ security configuration settings.",frameworks:["CMMC"]},
            {id:"CMMC-CM.2.063",name:"User software installation",category:"Asset Management",description:"Track and control user-installed software.",frameworks:["CMMC"]},
            // Additional COBIT Controls (20 more)
            {id:"COBIT-APO01.01",name:"IT management framework",category:"Policy & Governance",description:"Define and communicate the management framework.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.02",name:"Organizational positioning",category:"Policy & Governance",description:"Establish organizational positioning of IT.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.04",name:"Communication mechanisms",category:"Policy & Governance",description:"Communicate management philosophy and direction.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.05",name:"Culture development",category:"Policy & Governance",description:"Define and develop a culture and ethics.",frameworks:["COBIT"]},
            {id:"COBIT-APO01.06",name:"Data and system ownership",category:"Asset Management",description:"Define data and system ownership.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.03",name:"Risk profile maintenance",category:"Risk Management",description:"Maintain a risk profile.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.04",name:"Risk expression",category:"Risk Management",description:"Express risk in business-relevant terms.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.05",name:"Risk response portfolio",category:"Risk Management",description:"Define a risk management action portfolio.",frameworks:["COBIT"]},
            {id:"COBIT-APO12.06",name:"Risk response execution",category:"Risk Management",description:"Respond to risk.",frameworks:["COBIT"]},
            {id:"COBIT-APO13.02",name:"ISMS plan",category:"Policy & Governance",description:"Define and manage an information security plan.",frameworks:["COBIT"]},
            {id:"COBIT-APO13.03",name:"ISMS monitoring",category:"Logging & Monitoring",description:"Monitor and review the ISMS.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.02",name:"Change impact assessment",category:"Asset Management",description:"Assess and prioritize change requests.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.03",name:"Emergency changes",category:"Asset Management",description:"Manage emergency changes.",frameworks:["COBIT"]},
            {id:"COBIT-BAI06.04",name:"Change closure",category:"Asset Management",description:"Close and document changes.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.03",name:"Endpoint security",category:"Network Security",description:"Manage endpoint security.",frameworks:["COBIT"]},
            {id:"COBIT-DSS05.06",name:"Sensitive documents",category:"Data Protection",description:"Manage sensitive documents and devices.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.01",name:"Logical access controls",category:"Access Control",description:"Manage access to information and data.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.02",name:"Privileged access controls",category:"Access Control",description:"Manage privileged access rights.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.03",name:"Access profiles",category:"Access Control",description:"Manage user access entitlements.",frameworks:["COBIT"]},
            {id:"COBIT-DSS06.04",name:"Access segregation",category:"Access Control",description:"Segregate and manage privileged user accounts.",frameworks:["COBIT"]}
        ];
    }
    
    // ==================== GRC PROJECTS ====================
    renderProjects() {
        const c = document.getElementById('tab-projects');
        const projects = this.getProjectScenarios();
        c.innerHTML = `
            <div class="welcome-banner" style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 8px;"><i class="bi bi-briefcase-fill"></i> GRC Practice Projects</h2>
                <p style="color: var(--text-secondary);">Complete real-world GRC scenarios to build your skills and portfolio. Each project simulates enterprise challenges across different industries and frameworks.</p>
            </div>
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));">
                ${projects.map(p => this.renderProjectCard(p)).join('')}
            </div>`;
    }
    
    renderProjectCard(p) {
        const progress = this.getProjectProgress(p.id);
        const statusClass = progress.percent === 100 ? 'green' : progress.percent > 0 ? 'amber' : 'blue';
        const self = this;
        return `
            <div class="card" style="overflow: visible;">
                <div class="card-header" style="background: linear-gradient(135deg, var(--accent-${statusClass}-soft), transparent);">
                    <div class="card-title"><i class="bi bi-building"></i> ${this.esc(p.company)}</div>
                    <span class="badge badge-${statusClass}">${progress.percent}% Complete</span>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                        <span class="badge" style="background: var(--bg-elevated);"><i class="bi bi-diagram-3"></i> ${p.industry}</span>
                        <span class="badge" style="background: var(--bg-elevated);"><i class="bi bi-people"></i> ${p.size}</span>
                    </div>
                    <h4 style="font-size: 15px; margin-bottom: 8px;">${this.esc(p.scenario)}</h4>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5;">${this.esc(p.description.substring(0, 180))}...</p>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px;">
                        ${p.frameworks.map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}">${fw}</span>`).join('')}
                    </div>
                    <div class="progress-bar" style="margin-bottom: 12px;"><div class="progress-fill ${statusClass}" style="width: ${progress.percent}%;"></div></div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                        <strong>${progress.completed}/${progress.total}</strong> tasks completed
                    </div>
                    <h5 style="font-size: 13px; margin-bottom: 8px;">Tasks:</h5>
                    <ul style="list-style: none; font-size: 13px;">
                        ${p.tasks.map(t => {
                            const isComplete = self.checkTaskComplete(p.id, t);
                            return `
                            <li style="padding: 6px 0; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border-subtle);">
                                <i class="bi ${isComplete ? 'bi-check-circle-fill' : 'bi-circle'}" style="color: ${isComplete ? 'var(--accent-green)' : 'var(--text-muted)'};"></i>
                                <span style="color: ${isComplete ? 'var(--text-muted)' : 'var(--text-primary)'}; ${isComplete ? 'text-decoration: line-through;' : ''}">${t.label}</span>
                                ${!isComplete ? `<button class="btn btn-sm btn-ghost" style="margin-left: auto;" onclick="app.startProject('${p.id}'); app.switchTab('${t.tab}')"><i class="bi bi-arrow-right"></i></button>` : ''}
                            </li>
                        `;}).join('')}
                    </ul>
                    <div style="margin-top: 16px; display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="app.startProject('${p.id}')"><i class="bi bi-play-fill"></i> ${progress.percent > 0 ? 'Continue' : 'Start'} Project</button>
                        ${progress.percent === 100 ? `<button class="btn btn-secondary btn-sm" onclick="app.generatePortfolio('${p.id}')"><i class="bi bi-file-earmark-text"></i> Generate Summary</button>` : ''}
                    </div>
                </div>
            </div>`;
    }
    
    getProjectScenarios() {
        const self = this;
        return [
            {
                id: 'iso-risk-assessment', company: 'TechStart Inc', industry: 'SaaS / Cloud Services', size: '500 employees',
                scenario: 'ISO 27001 Risk Assessment for Cloud Migration',
                description: 'TechStart Inc is migrating their customer database (5M+ records) from on-premises to AWS while pursuing ISO 27001 certification. As GRC Analyst, identify critical assets, assess migration risks, implement security controls, and document a Statement of Applicability.',
                frameworks: ['ISO 27001', 'NIST CSF'],
                tasks: [
                    { id: 'assets', label: 'Add 3 critical assets', tab: 'assets', required: 3, type: 'assets' },
                    { id: 'risks', label: 'Identify 5 risks', tab: 'risks', required: 5, type: 'risks' },
                    { id: 'controls', label: 'Implement 8 controls', tab: 'controls', required: 8, type: 'controls' },
                    { id: 'treatments', label: 'Document 3 risk treatments', tab: 'treatments', required: 3, type: 'treatments' }
                ]
            },
            {
                id: 'vendor-tprm', company: 'FinSecure Banking', industry: 'Financial Services', size: '1200 employees',
                scenario: 'Third-Party Risk Management for Payment Processor',
                description: 'FinSecure Banking is integrating a third-party payment processor with access to cardholder data. As TPRM lead, conduct vendor due diligence, assess security risks, verify compliance controls, and document remediation requirements.',
                frameworks: ['PCI DSS', 'SOC 2'],
                tasks: [
                    { id: 'vendor', label: 'Add vendor profile', tab: 'vendors', required: 1, type: 'vendors' },
                    { id: 'risks', label: 'Assess 4 vendor risks', tab: 'risks', required: 4, type: 'risks' },
                    { id: 'controls', label: 'Verify 6 controls', tab: 'controls', required: 6, type: 'controls' },
                    { id: 'issues', label: 'Document 3 issues', tab: 'issues', required: 3, type: 'issues' }
                ]
            },
            {
                id: 'soc2-audit', company: 'DataFlow Analytics', industry: 'Data Analytics Platform', size: '300 employees',
                scenario: 'SOC 2 Type II Audit Preparation',
                description: 'DataFlow Analytics serves Fortune 500 clients requiring SOC 2 Type II certification. As Compliance Manager, document Trust Services Criteria controls, catalog critical systems, collect audit evidence, and complete control matrix.',
                frameworks: ['SOC 2', 'NIST CSF'],
                tasks: [
                    { id: 'controls', label: 'Document 12 SOC 2 controls', tab: 'controls', required: 12, type: 'controls' },
                    { id: 'assets', label: 'Catalog 4 systems', tab: 'assets', required: 4, type: 'assets' },
                    { id: 'evidence', label: 'Collect 5 evidence items', tab: 'evidence', required: 5, type: 'evidence' },
                    { id: 'testing', label: 'Complete 4 control tests', tab: 'testing', required: 4, type: 'controlTests' }
                ]
            },
            {
                id: 'gdpr-compliance', company: 'EuroShop Ltd', industry: 'E-commerce', size: '800 employees',
                scenario: 'GDPR Compliance Program Implementation',
                description: 'EuroShop Ltd is expanding into EU markets, processing personal data for 3M+ customers. As Data Protection Officer, map data processing activities, conduct DPIAs, implement privacy controls, and establish data subject rights procedures.',
                frameworks: ['GDPR', 'ISO 27001'],
                tasks: [
                    { id: 'assets', label: 'Map 5 data processing assets', tab: 'assets', required: 5, type: 'assets' },
                    { id: 'risks', label: 'Assess 6 privacy risks', tab: 'risks', required: 6, type: 'risks' },
                    { id: 'controls', label: 'Implement 10 controls', tab: 'controls', required: 10, type: 'controls' },
                    { id: 'policies', label: 'Create 3 policies', tab: 'policies', required: 3, type: 'policies' }
                ]
            },
            {
                id: 'incident-response', company: 'HealthTech Systems', industry: 'Healthcare Technology', size: '600 employees',
                scenario: 'Incident Response Program Development',
                description: 'HealthTech provides EHR systems to 200+ hospitals storing PHI for 2M+ patients. As Security Operations Manager, develop IR playbooks, define team roles, establish escalation procedures, and ensure HIPAA breach notification compliance.',
                frameworks: ['HIPAA', 'NIST CSF'],
                tasks: [
                    { id: 'incidents', label: 'Document 3 incident scenarios', tab: 'incidents', required: 3, type: 'incidents' },
                    { id: 'controls', label: 'Define 8 IR controls', tab: 'controls', required: 8, type: 'controls' },
                    { id: 'assets', label: 'Identify 4 critical systems', tab: 'assets', required: 4, type: 'assets' },
                    { id: 'tasks', label: 'Create 5 response tasks', tab: 'tasks', required: 5, type: 'tasks' }
                ]
            },
            {
                id: 'cloud-security', company: 'CloudNative Corp', industry: 'Cloud Infrastructure', size: '400 employees',
                scenario: 'AWS Security Assessment and Hardening',
                description: 'CloudNative manages AWS infrastructure for 50+ enterprise clients. Recent audits revealed critical misconfigurations. As Cloud Security Engineer, conduct CIS Benchmark assessment, document findings, implement remediation, and create security roadmap.',
                frameworks: ['CIS Controls', 'NIST CSF'],
                tasks: [
                    { id: 'assets', label: 'Inventory 6 cloud assets', tab: 'assets', required: 6, type: 'assets' },
                    { id: 'findings', label: 'Document 5 findings', tab: 'findings', required: 5, type: 'findings' },
                    { id: 'risks', label: 'Assess 4 cloud risks', tab: 'risks', required: 4, type: 'risks' },
                    { id: 'controls', label: 'Implement 10 controls', tab: 'controls', required: 10, type: 'controls' }
                ]
            },
            {
                id: 'bcdr-planning', company: 'CriticalOps Inc', industry: 'Critical Infrastructure', size: '900 employees',
                scenario: 'Business Continuity & Disaster Recovery Planning',
                description: 'CriticalOps operates infrastructure for water treatment and power grid monitoring serving 10M+ citizens. As Business Continuity Manager, conduct BIA, define RTO/RPO requirements, document recovery procedures, and implement technical controls.',
                frameworks: ['COBIT', 'ISO 27001'],
                tasks: [
                    { id: 'assets', label: 'Identify 5 critical assets', tab: 'assets', required: 5, type: 'assets' },
                    { id: 'risks', label: 'Assess 4 continuity risks', tab: 'risks', required: 4, type: 'risks' },
                    { id: 'controls', label: 'Document 8 BC controls', tab: 'controls', required: 8, type: 'controls' },
                    { id: 'audits', label: 'Plan 2 BC exercises', tab: 'audits', required: 2, type: 'audits' }
                ]
            },
            {
                id: 'compliance-gap', company: 'RegTech Solutions', industry: 'Regulatory Technology', size: '350 employees',
                scenario: 'Multi-Framework Compliance Gap Analysis',
                description: 'RegTech serves healthcare, finance, and payment clients requiring simultaneous PCI DSS, SOC 2, and HIPAA compliance. As Compliance Architect, map controls across frameworks, assess implementation status, document gaps, and create remediation roadmap.',
                frameworks: ['PCI DSS', 'SOC 2', 'HIPAA'],
                tasks: [
                    { id: 'controls', label: 'Assess 15 controls', tab: 'controls', required: 15, type: 'controls' },
                    { id: 'issues', label: 'Identify 5 gaps', tab: 'issues', required: 5, type: 'issues' },
                    { id: 'treatments', label: 'Plan 5 remediations', tab: 'treatments', required: 5, type: 'treatments' },
                    { id: 'audits', label: 'Schedule 2 audits', tab: 'audits', required: 2, type: 'audits' }
                ]
            },
            {
                id: 'zero-trust', company: 'SecureBank Digital', industry: 'Digital Banking', size: '750 employees',
                scenario: 'Zero Trust Architecture Implementation',
                description: 'SecureBank Digital is modernizing their security architecture with Zero Trust principles after recent industry breaches. As Security Architect, assess current state, design identity-centric controls, implement microsegmentation, and establish continuous verification mechanisms.',
                frameworks: ['NIST CSF', 'CIS Controls'],
                tasks: [
                    { id: 'assets', label: 'Map 6 critical assets', tab: 'assets', required: 6, type: 'assets' },
                    { id: 'risks', label: 'Assess 5 access risks', tab: 'risks', required: 5, type: 'risks' },
                    { id: 'controls', label: 'Implement 12 ZT controls', tab: 'controls', required: 12, type: 'controls' },
                    { id: 'policies', label: 'Create 4 ZT policies', tab: 'policies', required: 4, type: 'policies' }
                ]
            }
        ];
    }
    
    checkTaskComplete(projectId, task) {
        const pData = this.getProjectData(projectId);
        return pData[task.type]?.length >= task.required;
    }
    
    getProjectProgress(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return { completed: 0, total: 0, percent: 0 };
        const completed = project.tasks.filter(t => this.checkTaskComplete(projectId, t)).length;
        const total = project.tasks.length;
        return { completed, total, percent: Math.round((completed / total) * 100) };
    }
    
    startProject(projectId) {
        // Enter project mode first
        this.enterProjectMode(projectId);
        
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (project && project.tasks.length > 0) {
            const firstIncomplete = project.tasks.find(t => !this.checkTaskComplete(projectId, t));
            if (firstIncomplete) {
                this.switchTab(firstIncomplete.tab);
                this.toast(`Started "${project.company}" - Complete: ${firstIncomplete.label}`, 'info');
            } else {
                this.switchTab('dashboard');
                this.toast(`All tasks completed for "${project.company}"!`, 'success');
            }
        }
    }
    
    // ==================== PORTFOLIO BUILDER ====================
    renderPortfolio() {
        const c = document.getElementById('tab-portfolio');
        const projects = this.getProjectScenarios();
        const selectedProject = this.selectedPortfolioProject || null;
        
        // Calculate total stats across all projects
        let totalStats = { assets: 0, risks: 0, controls: 0, vendors: 0, audits: 0, evidence: 0, projectsCompleted: 0 };
        projects.forEach(p => {
            const pd = this.getProjectData(p.id);
            totalStats.assets += pd.assets.length;
            totalStats.risks += pd.risks.length;
            totalStats.controls += pd.controls.length;
            totalStats.vendors += pd.vendors.length;
            if (this.getProjectProgress(p.id).percent === 100) totalStats.projectsCompleted++;
        });
        
        c.innerHTML = `
            <!-- Header -->
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 8px;"><i class="bi bi-person-badge"></i> Portfolio Builder</h2>
                <p style="color: var(--text-muted); font-size: 14px;">Generate professional resume content from your completed GRC projects.</p>
            </div>
            
            <!-- Main Layout -->
            <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start;">
                
                <!-- Left Sidebar - Project List -->
                <div class="card">
                    <div class="card-header" style="padding: 14px 16px; border-bottom: 1px solid var(--border-subtle);">
                        <span style="font-weight: 600; font-size: 13px;">Projects</span>
                        <span class="badge badge-blue">${totalStats.projectsCompleted}/${projects.length}</span>
                    </div>
                    <div style="max-height: 480px; overflow-y: auto;">
                        ${projects.map(p => {
                            const progress = this.getProjectProgress(p.id);
                            const isSelected = selectedProject === p.id;
                            const pData = this.getProjectData(p.id);
                            const hasData = pData.assets.length > 0 || pData.risks.length > 0 || pData.controls.length > 0;
                            return `
                                <div onclick="app.selectPortfolioProject('${p.id}')" 
                                     style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-subtle); 
                                            background: ${isSelected ? 'var(--accent-blue-soft)' : 'transparent'};
                                            border-left: 3px solid ${isSelected ? 'var(--accent-blue)' : 'transparent'};
                                            transition: background 0.15s;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="font-weight: 500; font-size: 13px;">${p.company}</span>
                                        <span style="font-size: 11px; font-weight: 600; color: ${progress.percent === 100 ? 'var(--accent-green)' : progress.percent > 0 ? 'var(--accent-amber)' : 'var(--text-muted)'};">${progress.percent}%</span>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px; line-height: 1.3;">${p.scenario.substring(0, 50)}...</div>
                                    <div style="display: flex; gap: 4px;">
                                        ${p.frameworks.slice(0, 2).map(fw => `<span style="font-size: 9px; padding: 2px 5px; background: var(--bg-elevated); border-radius: 3px; color: var(--text-muted);">${fw}</span>`).join('')}
                                        ${!hasData ? '<span style="font-size: 9px; padding: 2px 5px; background: var(--bg-elevated); border-radius: 3px; color: var(--text-muted);">Not Started</span>' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Right Content - Resume Preview -->
                <div>
                    ${selectedProject ? this.renderPortfolioContent(selectedProject) : `
                        <div class="card" style="min-height: 400px; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center; padding: 40px; max-width: 350px;">
                                <i class="bi bi-file-earmark-person" style="font-size: 48px; color: var(--text-muted); opacity: 0.4; margin-bottom: 16px; display: block;"></i>
                                <h4 style="font-size: 16px; margin-bottom: 8px;">Select a Project</h4>
                                <p style="color: var(--text-muted); font-size: 13px; line-height: 1.5;">
                                    Choose a project from the list to preview resume bullet points and generate professional content for your portfolio.
                                </p>
                            </div>
                        </div>
                    `}
                </div>
            </div>
            
            <!-- Skills Summary -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="padding: 14px 16px;">
                    <span style="font-weight: 600; font-size: 13px;"><i class="bi bi-stars"></i> Skills & Frameworks</span>
                </div>
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${['Risk Assessment', 'Control Testing', 'Audit Support', 'Compliance', 'Vendor Risk', 'Incident Response', 'Policy Development', 'Cloud Security'].map(s => `<span class="badge" style="padding: 6px 10px; background: var(--bg-elevated);">${s}</span>`).join('')}
                        ${['ISO 27001', 'NIST CSF', 'SOC 2', 'PCI DSS', 'HIPAA', 'GDPR'].map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="padding: 6px 10px;">${fw}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    renderPortfolioContent(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return '';
        
        const progress = this.getProjectProgress(projectId);
        const pData = this.getProjectData(projectId);
        const bullets = this.generateProjectSpecificBullets(project, pData);
        
        return `
            <div class="card">
                <!-- Project Header -->
                <div class="card-header" style="padding: 16px; background: linear-gradient(135deg, var(--accent-blue-soft), transparent);">
                    <div>
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${project.company}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${project.scenario}</div>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        ${project.frameworks.map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="font-size: 10px;">${fw}</span>`).join('')}
                        <span class="badge badge-${progress.percent === 100 ? 'green' : progress.percent > 0 ? 'amber' : 'blue'}" style="font-size: 10px;">${progress.percent}%</span>
                    </div>
                </div>
                
                <div class="card-body" style="padding: 20px;">
                    <!-- Quick Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-subtle);">
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--accent-blue);">${pData.assets.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Assets</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--accent-red);">${pData.risks.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Risks</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--accent-green);">${pData.controls.length}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Controls</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--accent-purple);">${progress.completed}/${progress.total}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Tasks</div>
                        </div>
                    </div>
                    
                    <!-- Resume Bullets Section -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 600; font-size: 13px;"><i class="bi bi-card-text"></i> Resume Bullet Points</span>
                            ${bullets.length > 0 ? `<button class="btn btn-secondary btn-sm" onclick="app.copyProjectBullets('${projectId}')"><i class="bi bi-clipboard"></i> Copy</button>` : ''}
                        </div>
                        
                        ${bullets.length > 0 ? `
                            <div id="portfolio-bullets" style="background: var(--bg-elevated); padding: 16px 20px; border-radius: var(--radius-md); font-size: 13px; line-height: 1.7;">
                                ${bullets.map(b => `<div style="margin-bottom: 8px; padding-left: 14px; position: relative;"><span style="position: absolute; left: 0; color: var(--text-muted);">•</span>${b}</div>`).join('')}
                            </div>
                        ` : `
                            <div style="background: var(--bg-elevated); padding: 32px; border-radius: var(--radius-md); text-align: center;">
                                <i class="bi bi-info-circle" style="font-size: 28px; color: var(--text-muted); opacity: 0.5; margin-bottom: 12px; display: block;"></i>
                                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">No content yet. Start the project and add data to generate resume bullets.</p>
                                <button class="btn btn-primary btn-sm" onclick="app.startProject('${projectId}')"><i class="bi bi-play-fill"></i> Start Project</button>
                            </div>
                        `}
                    </div>
                    
                    <!-- Project Summary -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 600; font-size: 13px;"><i class="bi bi-file-text"></i> Project Summary</span>
                            <button class="btn btn-ghost btn-sm" onclick="app.copyProjectSummary('${projectId}')"><i class="bi bi-clipboard"></i></button>
                        </div>
                        <div id="project-summary-${projectId}" style="background: var(--bg-elevated); padding: 16px 20px; border-radius: var(--radius-md); font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                            ${this.generateProjectSummary(project, pData)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    selectPortfolioProject(projectId) {
        this.selectedPortfolioProject = projectId || null;
        this.renderPortfolio();
    }
    
    generateProjectSpecificBullets(project, pData = null) {
        const bullets = [];

        const p = project;
        const progress = this.getProjectProgress(p.id);
        const d = pData || this.getProjectData(p.id);
        
        // Project-specific bullet generation based on project type
        const projectBullets = {
            'iso-risk-assessment': () => {
                if (d.assets.length > 0) bullets.push(`Conducted comprehensive asset inventory and classification for ${d.assets.length} information assets supporting ISO 27001 ISMS implementation`);
                if (d.risks.length > 0) {
                    const criticalRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 20).length;
                    const highRisks = d.risks.filter(r => (r.likelihood * r.impact) >= 12 && (r.likelihood * r.impact) < 20).length;
                    bullets.push(`Performed risk assessment identifying ${d.risks.length} risks across cloud migration scope${criticalRisks > 0 ? `, including ${criticalRisks} critical and ${highRisks} high-severity risks requiring immediate attention` : ''}`);
                }
                if (d.controls.length > 0) {
                    const iso27001Controls = d.controls.filter(c => c.frameworks?.includes('ISO 27001')).length || d.controls.length;
                    bullets.push(`Implemented ${iso27001Controls} security controls aligned with ISO 27001 Annex A requirements and NIST CSF`);
                }
                if (d.treatments.length > 0) bullets.push(`Developed ${d.treatments.length} risk treatment plans with documented mitigation strategies, acceptance criteria, and residual risk calculations`);
                if (progress.percent === 100) bullets.push(`Completed ISO 27001 risk assessment documentation supporting certification readiness for cloud infrastructure`);
            },
            'vendor-tprm': () => {
                if (d.vendors.length > 0) bullets.push(`Conducted third-party security assessments for ${d.vendors.length} vendor(s), evaluating security posture against PCI DSS and SOC 2 requirements`);
                if (d.risks.length > 0) bullets.push(`Identified and documented ${d.risks.length} vendor-related security risks impacting payment card data environment`);
                if (d.controls.length > 0) bullets.push(`Verified implementation of ${d.controls.length} compensating controls for third-party payment processor integration`);
                if (d.issues.length > 0) {
                    const closedIssues = d.issues.filter(i => i.status === 'Closed').length;
                    bullets.push(`Documented ${d.issues.length} compliance gaps and coordinated remediation efforts${closedIssues > 0 ? ` with ${Math.round(closedIssues/d.issues.length*100)}% resolution rate` : ''}`);
                }
                if (progress.percent === 100) bullets.push(`Established ongoing vendor monitoring program with quarterly security assessments and contract compliance reviews`);
            },
            'soc2-audit': () => {
                if (d.controls.length > 0) {
                    const effectiveControls = d.controls.filter(c => c.effectiveness === 'Effective').length;
                    bullets.push(`Documented ${d.controls.length} Trust Services Criteria controls for SOC 2 Type II audit${effectiveControls > 0 ? ` with ${Math.round(effectiveControls/d.controls.length*100)}% operating effectiveness` : ''}`);
                }
                if (d.assets.length > 0) bullets.push(`Cataloged ${d.assets.length} in-scope systems and infrastructure components for SOC 2 boundary definition`);
                if (d.evidence.length > 0) bullets.push(`Managed evidence collection and organization of ${d.evidence.length} audit artifacts supporting Trust Services Criteria`);
                if (d.controlTests.length > 0) {
                    const passedTests = d.controlTests.filter(t => t.result === 'Pass').length;
                    bullets.push(`Executed ${d.controlTests.length} control testing procedures${passedTests > 0 ? ` achieving ${Math.round(passedTests/d.controlTests.length*100)}% pass rate` : ''}`);
                }
                if (progress.percent === 100) bullets.push(`Coordinated successful SOC 2 Type II audit preparation ensuring all Trust Services Criteria requirements were addressed`);
            },
            'gdpr-compliance': () => {
                if (d.assets.length > 0) bullets.push(`Mapped ${d.assets.length} data processing activities documenting personal data flows, legal basis, and retention periods per GDPR Article 30`);
                if (d.risks.length > 0) bullets.push(`Conducted Data Protection Impact Assessments (DPIAs) for ${d.risks.length} high-risk processing activities per GDPR Article 35`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} privacy-by-design controls addressing GDPR principles and data subject rights`);
                if (d.policies.length > 0) bullets.push(`Developed ${d.policies.length} privacy policies and procedures including data retention, breach notification, and DSAR handling`);
                if (progress.percent === 100) bullets.push(`Established GDPR compliance program enabling EU market expansion with documented accountability framework`);
            },
            'incident-response': () => {
                if (d.incidents.length > 0) bullets.push(`Developed ${d.incidents.length} incident response playbooks covering security, availability, and data breach scenarios`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} detection, response, and recovery controls aligned with HIPAA Security Rule requirements`);
                if (d.assets.length > 0) bullets.push(`Identified ${d.assets.length} critical systems containing PHI requiring enhanced monitoring and rapid response capabilities`);
                if (d.tasks.length > 0) bullets.push(`Created ${d.tasks.length} incident response tasks defining roles, escalation procedures, and communication protocols`);
                if (progress.percent === 100) bullets.push(`Established incident response program with HIPAA breach notification procedures and post-incident review process`);
            },
            'cloud-security': () => {
                if (d.assets.length > 0) bullets.push(`Inventoried ${d.assets.length} AWS cloud assets including EC2, S3, RDS, and IAM configurations for CIS Benchmark assessment`);
                if (d.findings.length > 0) {
                    const closedFindings = d.findings.filter(f => f.status === 'Closed').length;
                    bullets.push(`Identified ${d.findings.length} security misconfigurations and vulnerabilities${closedFindings > 0 ? ` with ${Math.round(closedFindings/d.findings.length*100)}% remediated` : ''}`);
                }
                if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} cloud-specific risks including data exposure, misconfiguration, and privilege escalation vectors`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} CIS Benchmark controls for AWS hardening including encryption, logging, and network segmentation`);
                if (progress.percent === 100) bullets.push(`Delivered cloud security assessment report with prioritized remediation roadmap and ongoing monitoring recommendations`);
            },
            'bcdr-planning': () => {
                if (d.assets.length > 0) bullets.push(`Conducted Business Impact Analysis (BIA) for ${d.assets.length} critical systems defining RTO/RPO requirements`);
                if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} business continuity risks including infrastructure failure, natural disaster, and cyber attack scenarios`);
                if (d.controls.length > 0) bullets.push(`Documented ${d.controls.length} BC/DR controls including backup procedures, failover mechanisms, and recovery runbooks`);
                if (d.audits.length > 0) bullets.push(`Planned and coordinated ${d.audits.length} tabletop exercises and disaster recovery tests validating plan effectiveness`);
                if (progress.percent === 100) bullets.push(`Delivered comprehensive BC/DR program aligned with COBIT and ISO 22301 requirements for critical infrastructure protection`);
            },
            'compliance-gap': () => {
                if (d.controls.length > 0) bullets.push(`Assessed ${d.controls.length} controls across PCI DSS, SOC 2, and HIPAA frameworks creating unified control matrix`);
                if (d.issues.length > 0) bullets.push(`Identified ${d.issues.length} compliance gaps requiring remediation across multiple regulatory frameworks`);
                if (d.treatments.length > 0) bullets.push(`Developed ${d.treatments.length} remediation plans with prioritization based on risk severity and compliance deadlines`);
                if (d.audits.length > 0) bullets.push(`Scheduled ${d.audits.length} compliance audits coordinating evidence collection and stakeholder preparation`);
                if (progress.percent === 100) bullets.push(`Completed multi-framework gap analysis enabling efficient compliance management across healthcare, finance, and payment processing requirements`);
            },
            'zero-trust': () => {
                if (d.assets.length > 0) bullets.push(`Mapped ${d.assets.length} critical assets identifying protect surfaces for Zero Trust Architecture implementation`);
                if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} identity and access risks supporting "never trust, always verify" security model`);
                if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} Zero Trust controls including microsegmentation, continuous verification, and least privilege access`);
                if (d.policies.length > 0) bullets.push(`Developed ${d.policies.length} identity-centric security policies governing authentication, authorization, and session management`);
                if (progress.percent === 100) bullets.push(`Delivered Zero Trust Architecture roadmap aligned with NIST SP 800-207 and CIS Controls for modern security transformation`);
            }
        };
        
        // Execute the project-specific bullet generator
        if (projectBullets[p.id]) {
            projectBullets[p.id]();
        } else {
            // Fallback for unknown projects
            if (d.assets.length > 0) bullets.push(`Managed ${d.assets.length} assets for ${p.company} GRC project`);
            if (d.risks.length > 0) bullets.push(`Assessed ${d.risks.length} risks across ${p.frameworks.join(', ')} frameworks`);
            if (d.controls.length > 0) bullets.push(`Implemented ${d.controls.length} security controls`);
        }
        
        return bullets;
    }
    
    copyProjectBullets(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return;
        
        const pData = this.getProjectData(projectId);
        const bullets = this.generateProjectSpecificBullets(project, pData);
        const text = bullets.map(b => `• ${b}`).join('\n');
        navigator.clipboard.writeText(text).then(() => this.toast(`${project.company} bullets copied to clipboard!`, 'success'));
    }
    
    renderProjectPortfolioCard(p) {
        const progress = this.getProjectProgress(p.id);
        const statusClass = progress.percent === 100 ? 'green' : progress.percent > 0 ? 'amber' : 'blue';
        const summary = this.generateProjectSummary(p);
        
        return `
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, var(--accent-${statusClass}-soft), transparent);">
                    <div class="card-title"><i class="bi bi-building"></i> ${this.esc(p.company)}</div>
                    <span class="badge badge-${statusClass}">${progress.percent}%</span>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                        <span class="badge" style="background: var(--bg-elevated);"><i class="bi bi-diagram-3"></i> ${p.industry}</span>
                        ${p.frameworks.map(fw => `<span class="badge badge-${this.getFrameworkColor(fw)}" style="font-size: 11px;">${fw}</span>`).join('')}
                    </div>
                    <h5 style="font-size: 14px; margin-bottom: 8px;">${this.esc(p.scenario)}</h5>
                    <div id="project-summary-${p.id}" style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; font-size: 13px; line-height: 1.7; color: var(--text-secondary);">
                        ${summary}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="app.copyProjectSummary('${p.id}')"><i class="bi bi-clipboard"></i> Copy</button>
                        <button class="btn btn-ghost btn-sm" onclick="app.switchTab('projects')"><i class="bi bi-arrow-right"></i> View Project</button>
                    </div>
                </div>
            </div>`;
    }
    
    generateProjectSummary(p, pData = null) {
        const progress = this.getProjectProgress(p.id);
        const tasksDone = progress.completed;
        const tasksTotal = progress.total;
        const d = pData || this.getProjectData(p.id);
        
        // Generate dynamic summary based on project type and progress
        const summaries = {
            'iso-risk-assessment': `Led ISO 27001 risk assessment initiative for cloud migration project at a ${p.size} SaaS company. Identified and documented ${d.assets.length} critical information assets, conducted comprehensive risk assessments covering ${d.risks.length} potential threats, and implemented ${d.controls.length} security controls aligned with ISO 27001 Annex A requirements. Developed risk treatment plans and maintained Statement of Applicability documentation.`,
            
            'vendor-tprm': `Managed third-party risk management program for payment processor integration at a ${p.size} financial services firm. Conducted vendor security assessments, evaluated ${d.vendors.length} vendor security postures against PCI DSS and SOC 2 requirements, identified ${d.issues.length} compliance gaps, and coordinated remediation efforts with ${d.controls.length} compensating controls.`,
            
            'soc2-audit': `Coordinated SOC 2 Type II audit preparation for a ${p.size} data analytics platform serving Fortune 500 clients. Documented ${d.controls.length} Trust Services Criteria controls, managed evidence collection for ${d.evidence.length} audit artifacts, and executed ${d.controlTests.length} control testing procedures to validate operational effectiveness.`,
            
            'gdpr-compliance': `Implemented GDPR compliance program for EU market expansion at a ${p.size} e-commerce company processing 3M+ customer records. Mapped ${d.assets.length} data processing activities, conducted Data Protection Impact Assessments for ${d.risks.length} high-risk processes, implemented ${d.controls.length} privacy controls, and developed ${d.policies.length} privacy policies and procedures.`,
            
            'incident-response': `Developed incident response program for a ${p.size} healthcare technology company managing EHR systems with PHI for 2M+ patients. Created ${d.incidents.length} incident response playbooks, implemented ${d.controls.length} detection and response controls, and established HIPAA breach notification procedures and escalation workflows.`,
            
            'cloud-security': `Conducted AWS security assessment and CIS Benchmark hardening for a ${p.size} cloud infrastructure provider serving 50+ enterprise clients. Inventoried ${d.assets.length} cloud assets, identified ${d.findings.length} security findings, assessed ${d.risks.length} cloud-specific risks, and implemented ${d.controls.length} security controls for remediation.`,
            
            'bcdr-planning': `Led business continuity and disaster recovery planning initiative for a ${p.size} critical infrastructure operator. Conducted business impact analysis for ${d.assets.length} critical systems, assessed ${d.risks.length} continuity risks, documented ${d.controls.length} BC/DR controls, and coordinated ${d.audits.length} tabletop exercises and recovery tests.`,
            
            'compliance-gap': `Performed multi-framework compliance gap analysis for a ${p.size} RegTech company requiring simultaneous PCI DSS, SOC 2, and HIPAA compliance. Assessed ${d.controls.length} controls across frameworks, identified ${d.issues.length} compliance gaps, developed ${d.treatments.length} remediation plans, and created unified control matrix for audit readiness.`,
            
            'zero-trust': `Architected Zero Trust security framework implementation for a ${p.size} digital banking organization. Mapped ${d.assets.length} critical assets requiring protection, assessed ${d.risks.length} identity and access risks, implemented ${d.controls.length} Zero Trust controls including microsegmentation and continuous verification, and developed ${d.policies.length} identity-centric security policies.`
        };
        
        let summary = summaries[p.id] || `Completed GRC project for ${p.company} covering ${p.frameworks.join(', ')} frameworks. Managed ${d.assets.length} assets, ${d.risks.length} risks, and ${d.controls.length} controls.`;
        
        if (progress.percent === 0) {
            summary = `<em style="color: var(--text-muted);">Project not started. Complete tasks to generate a detailed summary.</em>`;
        } else if (progress.percent < 100) {
            summary = `<em style="color: var(--accent-amber);">[${progress.percent}% Complete]</em> ` + summary;
        }
        
        return summary;
    }
    
    generateResumeBullets() {
        const bullets = [];
        if (this.data.assets.length > 0) bullets.push(`• Maintained IT asset inventory of ${this.data.assets.length}+ systems including classification, ownership, and lifecycle management`);
        if (this.getActiveData().risks.length > 0) {
            const criticalRisks = this.getActiveData().risks.filter(r => (r.likelihood * r.impact) >= 20).length;
            bullets.push(`• Conducted risk assessments identifying ${this.getActiveData().risks.length} risks across enterprise systems${criticalRisks > 0 ? `, including ${criticalRisks} critical risks requiring immediate remediation` : ''}`);
        }
        if (this.getActiveData().controls.length > 0) {
            const effective = this.getActiveData().controls.filter(c => c.effectiveness === 'Effective').length;
            bullets.push(`• Implemented and maintained ${this.getActiveData().controls.length} security controls aligned with ISO 27001, NIST CSF, and SOC 2 frameworks${effective > 0 ? ` with ${Math.round(effective/this.getActiveData().controls.length*100)}% effectiveness rate` : ''}`);
        }
        if (this.getActiveData().vendors.length > 0) bullets.push(`• Managed third-party risk program overseeing ${this.getActiveData().vendors.length} vendor relationships including due diligence, contract reviews, and ongoing monitoring`);
        if (this.getActiveData().incidents.length > 0) bullets.push(`• Led incident response activities for ${this.getActiveData().incidents.length} security events, coordinating investigation, containment, and post-incident review`);
        if (this.getActiveData().audits.length > 0) bullets.push(`• Supported ${this.getActiveData().audits.length} compliance audits including evidence collection, control testing, and remediation tracking`);
        if (this.getActiveData().evidence.length > 0) bullets.push(`• Maintained audit evidence repository with ${this.getActiveData().evidence.length}+ artifacts supporting SOC 2 Type II and ISO 27001 certification`);
        if (this.getActiveData().policies.length > 0) bullets.push(`• Developed and maintained ${this.getActiveData().policies.length} information security policies and procedures`);
        if (this.getActiveData().findings.length > 0) {
            const closed = this.getActiveData().findings.filter(f => f.status === 'Closed').length;
            bullets.push(`• Tracked remediation of ${this.getActiveData().findings.length} audit findings${closed > 0 ? ` with ${Math.round(closed/this.getActiveData().findings.length*100)}% closure rate` : ''}`);
        }
        if (bullets.length === 0) bullets.push('• Complete GRC projects to generate resume bullet points based on your work');
        return bullets.join('<br><br>');
    }
    
    copyPortfolio() {
        const text = document.getElementById('portfolio-bullets')?.innerText || '';
        navigator.clipboard.writeText(text).then(() => this.toast('Bullets copied to clipboard!', 'success'));
    }
    
    copyProjectSummary(projectId) {
        const el = document.getElementById(`project-summary-${projectId}`);
        if (el) {
            navigator.clipboard.writeText(el.innerText).then(() => this.toast('Project summary copied to clipboard!', 'success'));
        }
    }
    
    copyAllPortfolio() {
        const projects = this.getProjectScenarios();
        let allText = "=== RESUME BULLET POINTS BY PROJECT ===\n\n";
        
        projects.forEach(p => {
            const bullets = this.generateProjectSpecificBullets(p);
            if (bullets.length > 0) {
                allText += `[${p.company} - ${p.scenario}]\n`;
                allText += bullets.map(b => `• ${b}`).join('\n');
                allText += "\n\n";
            }
        });
        
        allText += "=== PROJECT SUMMARIES ===\n\n";
        projects.forEach(p => {
            const el = document.getElementById(`project-summary-${p.id}`);
            if (el) {
                allText += `[${p.company} - ${p.scenario}]\n${el.innerText}\n\n`;
            }
        });
        navigator.clipboard.writeText(allText).then(() => this.toast('All portfolio content copied to clipboard!', 'success'));
    }
    
    generateAllPortfolios() {
        this.toast('Portfolio summaries generated! Review and copy your bullet points.', 'success');
        this.renderPortfolio();
    }
    
    generatePortfolio(projectId) {
        this.switchTab('portfolio');
        this.toast(`Portfolio summary generated for project!`, 'success');
    }
}
function openModal(title, body, footer) { document.getElementById('modal-title').textContent = title; document.getElementById('modal-body').innerHTML = body; document.getElementById('modal-footer').innerHTML = footer; document.getElementById('modal-overlay').classList.add('active'); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
document.getElementById('modal-overlay')?.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
let app;
document.addEventListener('DOMContentLoaded', () => { app = new GRCLabPro(); window.app = app; });
</script>
</body>
</html>
