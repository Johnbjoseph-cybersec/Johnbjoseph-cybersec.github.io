<!DOCTYPE html>
<html lang="en">
<head>
  <title>GRC Practice Lab – John B Joseph</title>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Theme CSS from your site -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900"
        rel="stylesheet" />
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css" />
  <link rel="stylesheet" href="css/animate.css" />
  <link rel="stylesheet" href="css/owl.carousel.min.css" />
  <link rel="stylesheet" href="css/owl.theme.default.min.css" />
  <link rel="stylesheet" href="css/magnific-popup.css" />
  <link rel="stylesheet" href="css/aos.css" />
  <link rel="stylesheet" href="css/ionicons.min.css" />
  <link rel="stylesheet" href="css/flaticon.css" />
  <link rel="stylesheet" href="css/icomoon.css" />
  <link rel="stylesheet" href="css/style.css" />
  <!-- Inline styles for the lab -->
  <style>
    :root {
      --grc-bg: #020617;
      --grc-bg-alt: #020817;
      --grc-card-bg: rgba(15, 23, 42, 0.98);
      --grc-border-subtle: rgba(148, 163, 184, 0.25);
      --grc-accent: #38bdf8;
      --grc-accent-soft: rgba(56, 189, 248, 0.16);
      --grc-accent-strong: #0ea5e9;
      --grc-danger: #f97373;
      --grc-success: #22c55e;
      --grc-warning: #fbbf24;
      --grc-text-main: #e5e7eb;
      --grc-text-muted: #9ca3af;
    }

    body {
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: var(--grc-text-main);
    }

    .grc-lab-container {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow:
        0 18px 60px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 2.25rem;
      margin-bottom: 3rem;
      position: relative;
      overflow: hidden;
    }

    .grc-lab-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(94, 234, 212, 0.12), transparent 55%);
      opacity: 0.85;
      pointer-events: none;
    }

    .grc-lab-container > * {
      position: relative;
      z-index: 1;
    }

    .grc-title-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), rgba(30, 64, 175, 0.35));
      border: 1px solid rgba(56, 189, 248, 0.5);
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e0f2fe;
    }

    .grc-title-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
    }

    .grc-main-title {
      font-size: 1.9rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #f9fafb;
    }

    .grc-main-subtitle {
      font-size: 0.95rem;
      color: var(--grc-text-muted);
    }

    .grc-main-subtitle strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge-lite {
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(148, 163, 184, 0.12);
      border: 1px dashed rgba(148, 163, 184, 0.45);
      color: var(--grc-text-muted);
    }

    .grc-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.20rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15, 118, 110, 0.18);
      border: 1px solid rgba(45, 212, 191, 0.6);
      color: #ccfbf1;
    }

    .grc-chip .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #a5b4fc;
    }

    .grc-tab-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 999px;
      padding: 0.3rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .grc-tab-buttons .btn {
      flex: 1 1 auto;
      border-radius: 999px !important;
      font-size: 0.82rem;
      border: none;
      position: relative;
      background: transparent;
      color: var(--grc-text-muted);
    }

    .grc-tab-buttons .btn.active {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: #0b1120;
      box-shadow: 0 12px 30px rgba(8, 47, 73, 0.9);
      font-weight: 500;
    }

    .grc-tab {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }

    .grc-tab.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .grc-card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      border-radius: 16px;
      padding: 1.2rem 1.3rem;
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow:
        0 14px 40px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .grc-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.35rem;
    }

    .grc-card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .grc-card-tag {
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.7rem;
      color: var(--grc-accent);
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.45);
    }

    .dashboard-card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 10px 35px rgba(15, 23, 42, 0.9);
    }

    .dashboard-card .label {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .dashboard-card .value {
      font-size: 1.6rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .dashboard-card .sub {
      font-size: 0.82rem;
      color: #9ca3af;
    }

    .table-dark {
      background-color: rgba(15, 23, 42, 0.96);
    }

    .table-dark thead th {
      border-bottom-color: rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.98);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .table-dark tbody td {
      border-top-color: rgba(31, 41, 55, 0.9);
      font-size: 0.84rem;
    }

    .table-responsive {
      border-radius: 0.75rem;
      border: 1px solid rgba(31, 41, 55, 0.8);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.99));
    }

    .pagination {
      margin-bottom: 0;
    }

    .pagination .page-link {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.55);
      color: #cbd5f5;
      font-size: 0.78rem;
    }

    .pagination .page-item.active .page-link {
      background: var(--grc-accent-strong);
      border-color: var(--grc-accent-strong);
      color: #020617;
    }

    .badge-risk-high {
      background: rgba(248, 113, 113, 0.15);
      color: #fecaca;
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
    }

    .badge-risk-medium {
      background: rgba(251, 191, 36, 0.15);
      color: #fef9c3;
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
    }

    .badge-risk-low {
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
    }

    .guidance {
      font-size: 0.85rem;
      color: var(--grc-text-muted);
      background: linear-gradient(120deg, rgba(51, 65, 85, 0.75), rgba(15, 23, 42, 0.95));
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      margin-bottom: 1rem;
    }

    .guidance strong {
      color: #e5e7eb;
    }

    .btn-outline-light {
      border-color: rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
    }

    .btn-outline-light:hover {
      background-color: rgba(148, 163, 184, 0.12);
      color: #f9fafb;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      border-color: transparent;
      box-shadow: 0 10px 24px rgba(8, 47, 73, 0.85);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0ea5e9, #38bdf8);
    }

    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: transparent;
    }

    .btn-danger {
      background: linear-gradient(135deg, #f97373, #ef4444);
      border-color: transparent;
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.74rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    .tag-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 0.35rem;
      background: #22c55e;
    }

    .tooltip {
      position: relative;
      cursor: help;
      border-bottom: 1px dotted rgba(148, 163, 184, 0.8);
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: auto;
      min-width: 220px;
      background-color: #020617;
      color: #e5e7eb;
      text-align: left;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 0.6rem 0.8rem;
      position: absolute;
      z-index: 10;
      top: 140%;
      left: 0;
      font-size: 0.76rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
    }

    textarea.form-control {
      background-color: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.45);
      color: #e5e7eb;
      font-size: 0.88rem;
    }

    textarea.form-control:focus {
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.65);
      border-color: rgba(56, 189, 248, 0.75);
    }

    .toast-grc {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.7rem 1rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(56, 189, 248, 0.8);
      color: #e0f2fe;
      font-size: 0.82rem;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.9);
      z-index: 9999;
      display: none;
    }

    .toast-grc.show {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    canvas#riskMatrixCanvas {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background-color: #020617;
    }

    .matrix-legend {
      font-size: 0.78rem;
      color: var(--grc-text-muted);
    }

    .matrix-legend span.box {
      display: inline-block;
      width: 16px;
      height: 10px;
      border-radius: 4px;
      margin-right: 0.25rem;
    }

    .matrix-legend .box-high {
      background: #f97373;
    }

    .matrix-legend .box-mid {
      background: #facc15;
    }

    .matrix-legend .box-low {
      background: #4ade80;
    }

    .challenge-card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
    }

    .challenge-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--grc-accent);
    }

    .challenge-meta {
      font-size: 0.75rem;
      color: var(--grc-text-muted);
    }

    .challenge-meta strong {
      color: #e5e7eb;
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--grc-text-muted);
      padding: 1rem 0;
    }

    .badge-pill {
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.75rem;
    }

    .badge-pill.badge-primary {
      background-color: rgba(56, 189, 248, 0.18);
      color: #e0f2fe;
    }

    .badge-pill.badge-secondary {
      background-color: rgba(148, 163, 184, 0.23);
      color: #e5e7eb;
    }

    .badge-pill.badge-success {
      background-color: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
    }

    .badge-pill.badge-warning {
      background-color: rgba(251, 191, 36, 0.18);
      color: #fef3c7;
    }

    .text-soft {
      color: var(--grc-text-muted);
    }

    .border-subtle {
      border-color: var(--grc-border-subtle) !important;
    }

    .form-control,
    .custom-select {
      background-color: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.45);
      color: #e5e7eb;
      font-size: 0.86rem;
    }

    .form-control:focus,
    .custom-select:focus {
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
      border-color: rgba(56, 189, 248, 0.75);
      background-color: #020617;
    }

    .custom-select option {
      background-color: #020617;
      color: #e5e7eb;
    }

    .grc-tagline-small {
      font-size: 0.78rem;
      color: var(--grc-text-muted);
    }

    .badge-lite-edu {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.72rem;
      color: #f9fafb;
      background: rgba(56, 189, 248, 0.12);
      border: 1px dashed rgba(56, 189, 248, 0.75);
    }

    .badge-lite-edu .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #facc15;
    }

    small.framework-note {
      font-size: 0.72rem;
      color: var(--grc-text-muted);
    }

    textarea#summary-text,
    textarea#report-text {
      min-height: 420px !important;
      max-height: 900px !important;
    }
  </style>
</head>

<body>
  <section class="ftco-section ftco-no-pt ftco-no-pb">
    <div class="container">
      <div class="row justify-content-center pb-4">
        <div class="col-md-12 heading-section text-center ftco-animate">
          <div class="grc-lab-container">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <div class="grc-title-badge mb-2">
                  <span class="dot"></span>
                  GRC Practice Lab – Lite Edition
                </div>
                <h2 class="grc-main-title mb-1">GRC Practice Lab for Future Analysts</h2>
                <p class="grc-main-subtitle mb-2">
                  Practice frameworks, assets, risks, controls, issues, actions, vendors, incidents, and reporting —
                  all in your browser (data stays local).
                  Built as a self-study GRC practice lab to help future analysts learn by doing.
                </p>
                <div class="d-flex flex-wrap align-items-center" style="gap: .5rem;">
                  <span class="badge-lite">Lite, single-page version</span>
                  <span class="grc-chip">
                    <span class="dot"></span>
                    All controls paraphrased · For education only
                  </span>
                </div>
              </div>
              <div class="text-right">
                <div class="badge-lite-edu mb-2">
                  <span class="dot"></span>
                  Educational practice only — not production-ready
                </div>
                <p class="grc-tagline-small mb-0">
                  All framework control texts are paraphrased and simplified for learning purposes.
                  Not legal advice, not a substitute for official standards, and not intended for real-world
                  certifications or audits.
                </p>
              </div>
            </div>

            <!-- Tabs -->
            <div class="grc-tab-buttons mb-4">
              <button class="btn btn-sm active" data-grc-tab="dashboard">Dashboard</button>
              <button class="btn btn-sm" data-grc-tab="assets">Assets</button>
              <button class="btn btn-sm" data-grc-tab="vendors">Vendors</button>
              <button class="btn btn-sm" data-grc-tab="risks">Risks</button>
              <button class="btn btn-sm" data-grc-tab="controls">Controls</button>
              <button class="btn btn-sm" data-grc-tab="issues">Issues</button>
              <button class="btn btn-sm" data-grc-tab="incidents">Incidents</button>
              <button class="btn btn-sm" data-grc-tab="treatments">Actions</button>
              <button class="btn btn-sm" data-grc-tab="matrix">Matrix</button>
              <button class="btn btn-sm" data-grc-tab="soa">SoA</button>
              <button class="btn btn-sm" data-grc-tab="summary">Audit Summary</button>
              <button class="btn btn-sm" data-grc-tab="reports">Reports</button>
              <button class="btn btn-sm" data-grc-tab="frameworks">Framework Controls</button>
              <button class="btn btn-sm" data-grc-tab="challenges">Challenge Mode</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="grc-tab active ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Use Dashboard to see overall health. Then move left-to-right through Assets → Risks → Controls →
                      Issues/Actions → Matrix → SoA → Summary/Reports.
                    </span>
                  </span>
                  : Start each GRC practice session here.
                </p>
                <p class="mb-0">
                  <strong>Pro tip from the lab creator:</strong>
                  In a real environment, you’d connect this data to ticketing tools, CMDB, SIEM, and evidence repositories.
                  Here we simulate that flow with simple tables and practice narrative.
                </p>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Inventory overview</div>
                    <div class="value" id="dash-count-assets">0</div>
                    <p class="sub mb-2">Assets in scope (apps, DBs, servers).</p>
                    <span class="badge-pill badge-primary mr-1" id="dash-count-vendors">0 vendors</span>
                    <span class="badge-pill badge-secondary" id="dash-count-controls">0 controls</span>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Risk posture</div>
                    <div class="value" id="dash-risk-score">0</div>
                    <p class="sub mb-2">Average current residual risk score.</p>
                    <div>
                      <span class="badge-pill badge-danger mr-1" id="dash-risk-high">0 high</span>
                      <span class="badge-pill badge-warning mr-1" id="dash-risk-med">0 medium</span>
                      <span class="badge-pill badge-success" id="dash-risk-low">0 low</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Work in progress</div>
                    <div class="value" id="dash-open-issues">0</div>
                    <p class="sub mb-2">Open issues / actions across the lab.</p>
                    <div>
                      <span class="badge-pill badge-primary mr-1" id="dash-open-actions">0 actions</span>
                      <span class="badge-pill badge-secondary" id="dash-open-incidents">0 incidents</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mt-3">
                <div class="col-md-8 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Quickstart steps</div>
                    <p class="sub mb-2">
                      Use this like a mini-implementation project. You can reset and replay as many times as you want.
                    </p>
                    <ol class="mb-0 pl-3" style="font-size: 0.86rem;">
                      <li>Load the demo scenario (MediCloud) to see a fully populated environment.</li>
                      <li>Add/modify assets and vendors to match your own imaginary organization.</li>
                      <li>Review risks. Change likelihood/impact and see the Matrix update.</li>
                      <li>Link controls to risks and vendors. Watch residual risk change.</li>
                      <li>Capture issues and treatments, then generate a narrative Summary and Report.</li>
                    </ol>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Framework templates</div>
                    <p class="sub mb-1">
                      Quickly preload controls &amp; SoA entries for a single framework.
                    </p>
                    <small class="framework-note d-block mb-2">
                      This overwrites current controls &amp; SoA with a filtered subset for that framework only.
                    </small>
                    <div class="d-flex flex-wrap">
                      <button id="load-iso-template" class="btn btn-sm btn-outline-info mr-2 mb-2">Load ISO 27001</button>
                      <button id="load-nist-template" class="btn btn-sm btn-outline-info mr-2 mb-2">Load NIST CSF</button>
                      <button id="load-pci-template" class="btn btn-sm btn-outline-info mr-2 mb-2">Load PCI DSS</button>
                      <button id="load-hipaa-template" class="btn btn-sm btn-outline-info mb-2">Load HIPAA</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-4 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Scenarios &amp; exports</div>
                    <p class="sub mb-2">Manage data and load examples.</p>
                    <div class="d-flex flex-wrap">
                      <button id="btn-export" class="btn btn-sm btn-primary mr-2 mb-2">Export JSON</button>
                      <button id="btn-import" class="btn btn-sm btn-outline-light mr-2 mb-2">Import JSON</button>
                      <button id="btn-load-demo" class="btn btn-sm btn-outline-info mr-2 mb-2">Load Demo</button>
                      <button id="btn-reset" class="btn btn-sm btn-outline-danger mb-2">Reset All</button>
                      <input type="file" id="file-import" accept="application/json" style="display:none">
                    </div>
                    <small id="import-status" class="text-muted d-block mt-2"></small>
                  </div>
                </div>
                <div class="col-md-8 mb-3">
                  <div class="dashboard-card p-3 h-100">
                    <div class="label mb-1">Best Practices for Modern GRC Teams</div>
                    <p class="sub mb-2">
                      Use this lab as a playground to practice thinking like a GRC engineer —
                      not just checking boxes.
                    </p>
                    <ul class="mb-0 pl-3" style="font-size:0.84rem;">
                      <li>Treat each tab as a real module in a GRC platform: inventory, risk, controls, findings, actions.</li>
                      <li>Practice linking objects — risk without asset, control, or evidence is a red flag.</li>
                      <li>Use the Matrix and Summary tabs to turn raw data into executive-ready narrative.</li>
                      <li>Experiment with thresholds and scoring to see how risk appetite changes dashboards.</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Assets Tab -->
            <div id="tab-assets" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Add applications, databases, servers, and data stores. Link them to risks and issues later.
                      Practice tagging with data types (PHI, PII, PCI, etc.).
                    </span>
                  </span>
                  : Maintain your asset register.
                </p>
                <p class="mb-0">
                  In a real GRC product, this would sync with CMDB or cloud inventory. Here, you manually define scope and
                  learn the logic.
                </p>
              </div>
              <!-- Assets content (unchanged) -->
              <!-- ... existing Assets HTML ... -->
            </div>

            <!-- Vendors Tab -->
            <div id="tab-vendors" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Capture critical third parties. Link them to risks, issues, and incidents. Practise third-party
                      risk thinking.
                    </span>
                  </span>
                  : Third-party / vendor inventory.
                </p>
              </div>
              <!-- Vendors content (unchanged) -->
              <!-- ... existing Vendors HTML ... -->
            </div>

            <!-- Risks Tab -->
            <div id="tab-risks" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Create risks tied to assets/vendors. Set likelihood &amp; impact. Residual risk is calculated from
                      treated values.
                    </span>
                  </span>
                  : Risk register for cyber, privacy, third-party, and operational risks.
                </p>
              </div>
              <!-- Risks content (unchanged) -->
              <!-- ... existing Risks HTML ... -->
            </div>

            <!-- Controls Tab -->
            <div id="tab-controls" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Define local controls (policy, process, technical, detective, preventive, etc.) and link them to
                      risks and framework controls.
                    </span>
                  </span>
                  : Control library and mapping hub.
                </p>
                <p class="mb-0">
                  Remember: control text here is paraphrased for education and not from any official standard.
                </p>
              </div>
              <!-- Controls content (unchanged) -->
              <!-- ... existing Controls HTML ... -->
            </div>

            <!-- Issues Tab -->
            <div id="tab-issues" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Findings from audits, self-assessments, incidents, and continuous monitoring go here.
                    </span>
                  </span>
                  : Track nonconformities and gaps.
                </p>
              </div>
              <!-- Issues content (unchanged) -->
              <!-- ... existing Issues HTML ... -->
            </div>

            <!-- Incidents Tab -->
            <div id="tab-incidents" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Capture security events and incidents. Link back to assets, vendors, risks, and controls to tell the story.
                    </span>
                  </span>
                  : Incident log for your practice environment.
                </p>
              </div>
              <!-- Incidents content (unchanged) -->
              <!-- ... existing Incidents HTML ... -->
            </div>

            <!-- Treatments Tab -->
            <div id="tab-treatments" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Define remediation / risk treatment actions, assign owners and due dates, and track status.
                    </span>
                  </span>
                  : From findings to concrete actions.
                </p>
              </div>
              <!-- Treatments content (unchanged) -->
              <!-- ... existing Actions/Treatments HTML ... -->
            </div>

            <!-- Risk Matrix -->
            <div id="tab-matrix" class="grc-tab ftco-animate">
              <div class="guidance">
                <p><span class="tooltip">How to use
                    <span class="tooltiptext">
                      Visualize risks. Toggle inherent vs residual. Export PNG for reports. Tip: Residual shows control
                      effectiveness.
                    </span>
                  </span>
                  : Risk visualization tool.</p>
              </div>
              <h3>Risk Matrix (Inherent vs Residual)</h3>
              <p class="mb-3">Toggle to compare inherent (pre-controls) and residual (post-controls) risks.</p>
              <div class="bg-dark p-3 rounded mb-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
                  <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-sm btn-primary active" id="toggle-inherent">
                      <input type="radio" name="matrixOptions" autocomplete="off" checked> Inherent
                    </label>
                    <label class="btn btn-sm btn-outline-light" id="toggle-residual">
                      <input type="radio" name="matrixOptions" autocomplete="off"> Residual
                    </label>
                  </div>
                  <button id="matrix-export" class="btn btn-sm btn-outline-light">Export Matrix PNG</button>
                </div>
                <canvas id="riskMatrixCanvas" width="700" height="420"></canvas>
                <div class="d-flex justify-content-between mt-2 matrix-legend">
                  <div>
                    <span class="box box-high"></span> High
                    <span class="box box-mid ml-3"></span> Medium
                    <span class="box box-low ml-3"></span> Low
                  </div>
                  <div class="text-right">
                    <span class="badge-pill badge-secondary">X-axis: Likelihood (1–5)</span>
                    <span class="badge-pill badge-secondary ml-1">Y-axis: Impact (1–5)</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- SoA Tab -->
            <div id="tab-soa" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Statement of Applicability: for each framework control, record if it is applicable, how implemented,
                      who owns it, and any rationale/evidence.
                    </span>
                  </span>
                  : Practice building a SoA table.
                </p>
                <p class="mb-0">
                  All controls remain paraphrased and generic for education. For real audits, you must use official
                  text and scope.
                </p>
              </div>
              <!-- SoA content (unchanged) -->
              <!-- ... existing SoA HTML ... -->
            </div>

            <!-- Audit Summary Tab -->
            <div id="tab-summary" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Auto-generate a narrative summary (like an internal audit / GRC assessment summary) based on your data.
                    </span>
                  </span>
                  : Copy-paste into notes or practice writing your own.
                </p>
              </div>
              <div class="grc-card">
                <div class="grc-card-header">
                  <div class="grc-card-title">Auto-generated auditor-style summary</div>
                  <div class="grc-card-tag">Practice Narrative</div>
                </div>
                <p class="mb-2 text-soft">
                  Click <strong>Refresh summary</strong> to update. Adjust manually if needed (that’s what real auditors
                  do).
                </p>
                <textarea id="summary-text" class="form-control mb-2" rows="22"></textarea>
                <div class="d-flex justify-content-between">
                  <button id="summary-refresh" class="btn btn-sm btn-primary">Refresh summary</button>
                  <button id="summary-copy" class="btn btn-sm btn-outline-light">Copy to clipboard</button>
                </div>
              </div>
            </div>

            <!-- Reports Tab -->
            <div id="tab-reports" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Build an executive-ready report: scope, key risks, treatments, incidents, and next steps.
                      This uses your data to draft a report-like text.
                    </span>
                  </span>
                  : Turn your lab run into a practice report.
                </p>
              </div>
              <div class="grc-card">
                <div class="grc-card-header">
                  <div class="grc-card-title">Executive-style GRC report</div>
                  <div class="grc-card-tag">Practice Writing</div>
                </div>
                <p class="mb-2 text-soft">
                  Click <strong>Generate report</strong> to create a full narrative draft. You can tweak the text to
                  practice your reporting style.
                </p>
                <textarea id="report-text" class="form-control mb-2" rows="22"></textarea>
                <button id="generate-report" class="btn btn-sm btn-primary">Generate report</button>
              </div>
            </div>

            <!-- Framework Controls Tab -->
            <div id="tab-frameworks" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Browse paraphrased controls from ISO 27001, NIST CSF, HIPAA Security Rule, PCI DSS key areas.
                      Use filters to explore mapping.
                    </span>
                  </span>
                  : Framework &amp; control catalog (paraphrased).
                </p>
                <p class="mb-0">
                  Again: this is an educational approximation. Not official text. Do not reuse directly for real
                  certification work.
                </p>
              </div>
              <!-- Framework Controls content (unchanged) -->
              <!-- ... existing Frameworks HTML ... -->
            </div>

            <!-- Challenge Mode Tab -->
            <div id="tab-challenges" class="grc-tab ftco-animate">
              <div class="guidance">
                <p class="mb-1">
                  <span class="tooltip">How to use
                    <span class="tooltiptext">
                      Pick a challenge, follow the tasks, and then use the rest of the lab tabs to implement the scenario.
                      Optionally timebox yourself (e.g., 45–60 minutes).
                    </span>
                  </span>
                  : Scenario-based practice.
                </p>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <div class="challenge-card p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <div class="challenge-tag">Challenge 1</div>
                      <span class="badge-pill badge-primary">Beginner</span>
                    </div>
                    <h5 class="mb-2">Secure a single web app</h5>
                    <p class="challenge-meta mb-2">
                      Scope: one internet-facing app, one DB, one vendor.
                    </p>
                    <ul class="mb-2 pl-3" style="font-size:0.84rem;">
                      <li>Create 3–4 assets (app, DB, file share, logging).</li>
                      <li>Add at least 5 risks across cyber, privacy, and ops.</li>
                      <li>Map 5–7 controls to those risks.</li>
                      <li>Record 2 issues and 2 actions.</li>
                    </ul>
                    <button class="btn btn-sm btn-outline-light" onclick="scoreChallenge(1)">Calculate Score</button>
                    <span id="challenge-1-score" class="ml-2 text-soft"></span>
                  </div>
                </div>

                <div class="col-md-4 mb-3">
                  <div class="challenge-card p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <div class="challenge-tag">Challenge 2</div>
                      <span class="badge-pill badge-warning">Intermediate</span>
                    </div>
                    <h5 class="mb-2">Third-party risk mini-program</h5>
                    <p class="challenge-meta mb-2">
                      Scope: 3–4 critical vendors + related risks &amp; controls.
                    </p>
                    <ul class="mb-2 pl-3" style="font-size:0.84rem;">
                      <li>Create at least 4 vendors with different criticality.</li>
                      <li>Map a minimum of 5 third-party risks.</li>
                      <li>Define controls and issues per vendor.</li>
                      <li>Generate a summary that could be sent to leadership.</li>
                    </ul>
                    <button class="btn btn-sm btn-outline-light" onclick="scoreChallenge(2)">Calculate Score</button>
                    <span id="challenge-2-score" class="ml-2 text-soft"></span>
                  </div>
                </div>

                <div class="col-md-4 mb-3">
                  <div class="challenge-card p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <div class="challenge-tag">Challenge 3</div>
                      <span class="badge-pill badge-danger">Advanced</span>
                    </div>
                    <h5 class="mb-2">Incident-driven risk re-assessment</h5>
                    <p class="challenge-meta mb-2">
                      Scope: Start from an incident and re-shape the risk register.
                    </p>
                    <ul class="mb-2 pl-3" style="font-size:0.84rem;">
                      <li>Log at least 2 security incidents with links to assets.</li>
                      <li>Update existing risks and residual scores.</li>
                      <li>Define remediation actions and owners.</li>
                      <li>Use the Matrix, Summary, and Reports to tell the story.</li>
                    </ul>
                    <button class="btn btn-sm btn-outline-light" onclick="scoreChallenge(3)">Calculate Score</button>
                    <span id="challenge-3-score" class="ml-2 text-soft"></span>
                  </div>
                </div>
              </div>

              <!-- (Extra challenge cards can be added in a future iteration) -->

              <div class="grc-card mt-3">
                <div class="grc-card-header">
                  <div class="grc-card-title">Optional: Track your attempts</div>
                  <div class="grc-card-tag">Self-Assessment</div>
                </div>
                <p class="mb-2 text-soft">
                  Use this table to track your own runs (for your portfolio).
                </p>
                <div class="table-responsive">
                  <table class="table table-dark table-sm mb-0">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Challenge</th>
                        <th>Scope</th>
                        <th>Notes / Lessons Learned</th>
                      </tr>
                    </thead>
                    <tbody id="challenges-table-body">
                      <!-- you can manually log your runs here or extend via JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div> <!-- /grc-lab-container -->
        </div>
      </div>
    </div>
  </section>

  <div id="toast" class="toast-grc"></div>

  <!-- Core JS (jQuery, Bootstrap) from your theme -->
  <script src="js/jquery.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <!-- Lab logic -->
  <script>
    (function () {
      const K = {
        assets: 'grc_lab_assets_v4',
        vendors: 'grc_lab_vendors_v4',
        risks: 'grc_lab_risks_v4',
        controls: 'grc_lab_controls_v4',
        issues: 'grc_lab_issues_v4',
        treats: 'grc_lab_treatments_v4',
        soa: 'grc_lab_soa_v4',
        incidents: 'grc_lab_incidents_v4',
        riskCfg: 'grc_lab_risk_cfg_v4'
      };

      const defaultRiskConfig = {
        highThreshold: 12,
        mediumThreshold: 6
      };

      let assets = load(K.assets, []);
      let vendors = load(K.vendors, []);
      let risks = load(K.risks, []);
      let controls = load(K.controls, []);
      let issues = load(K.issues, []);
      let treatments = load(K.treats, []);
      let soa = load(K.soa, []);
      let incidents = load(K.incidents, []);
      let riskConfig = load(K.riskCfg, defaultRiskConfig);

      let currentAssetsPage = 1;
      let currentVendorsPage = 1;
      let currentRisksPage = 1;
      let currentControlsPage = 1;
      let currentIssuesPage = 1;
      let currentIncidentsPage = 1;
      let currentTreatmentsPage = 1;
      let currentFrameworksPage = 1;
      let currentSoAPage = 1;
      const ITEMS_PER_PAGE = 7;

      let riskFilterStatus = '';
      let riskFilterLevel = '';
      let riskFilterCategory = '';
      let riskSortField = 'score';
      let riskSortDir = 'desc';

      function load(key, fallback) {
        try {
          const s = localStorage.getItem(key);
          if (!s) return fallback;
          return JSON.parse(s);
        } catch (e) {
          console.error('Failed to parse', key, e);
          return fallback;
        }
      }

      function save(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error('Failed to save', key, e);
        }
      }

      function saveRiskConfig(cfg) {
        save(K.riskCfg, cfg);
      }

      function qs(sel) {
        return document.querySelector(sel);
      }

      function qsa(sel) {
        return Array.from(document.querySelectorAll(sel));
      }

      function showToast(msg) {
        const t = qs('#toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2600);
      }

      function setImportStatus(msg, isError) {
        const el = qs('#import-status');
        if (!el) return;
        el.textContent = msg;
        el.style.color = isError ? '#fecaca' : '#9ca3af';
      }

      function renderPagination(containerId, totalItems, currentPage, onPageChange) {
        const container = qs('#' + containerId);
        if (!container) return;
        container.innerHTML = '';
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE) || 1;
        const ul = document.createElement('ul');
        ul.className = 'pagination pagination-sm';

        function createPageItem(page, label, disabled, active) {
          const li = document.createElement('li');
          li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
          const a = document.createElement('a');
          a.className = 'page-link';
          a.href = '#';
          a.textContent = label;
          a.addEventListener('click', (e) => {
            e.preventDefault();
            if (!disabled && !active) onPageChange(page);
          });
          li.appendChild(a);
          return li;
        }

        ul.appendChild(createPageItem(currentPage - 1, '«', currentPage <= 1, false));

        for (let p = 1; p <= totalPages; p++) {
          ul.appendChild(createPageItem(p, p, false, p === currentPage));
        }

        ul.appendChild(createPageItem(currentPage + 1, '»', currentPage >= totalPages, false));
        container.appendChild(ul);
      }

      const CHALLENGES = [
        {
          id: 1,
          name: 'Secure a single web app',
          minAssets: 3,
          minRisks: 5,
          minControls: 5,
          minIssues: 2
        },
        {
          id: 2,
          name: 'Third-party risk mini-program',
          minVendors: 4,
          minRisks: 5,
          minControls: 5,
          minIssues: 3
        },
        {
          id: 3,
          name: 'Incident-driven risk re-assessment',
          minIncidents: 2,
          minRisks: 5,
          minTreatments: 3
        }
      ];

      const FRAMEWORK_CONTROLS = [
        { id: "CTRL-5.1", frameworks: ["ISO 27001"], domain: "Leadership & Governance", name: "InfoSec roles & responsibilities defined", description: "Define and communicate roles for information security.", type: "Administrative" },
        { id: "CTRL-5.17", frameworks: ["ISO 27001"], domain: "Access Control", name: "Authentication management", description: "Use strong authentication for critical systems.", type: "Technical" },
        { id: "CTRL-5.19", frameworks: ["ISO 27001"], domain: "Supplier Relationships", name: "Supplier risk management", description: "Assess and monitor security of third-party providers.", type: "Administrative" },
        { id: "CTRL-5.21", frameworks: ["ISO 27001"], domain: "Supplier Relationships", name: "Information security in supplier contracts", description: "Include security clauses in supplier agreements.", type: "Administrative" },
        { id: "CTRL-6.3", frameworks: ["ISO 27001"], domain: "Awareness & Training", name: "Security awareness program", description: "Run regular awareness and training activities.", type: "Administrative" },
        { id: "CTRL-8.5", frameworks: ["ISO 27001"], domain: "Access Control", name: "Privileged access control", description: "Restrict and monitor privileged accounts.", type: "Technical" },
        { id: "CTRL-8.15", frameworks: ["ISO 27001"], domain: "Operations Security", name: "Logging and monitoring", description: "Log and monitor security events for critical systems.", type: "Technical" },
        { id: "CTRL-8.16", frameworks: ["ISO 27001"], domain: "Operations Security", name: "Clock synchronization", description: "Synchronize system clocks to support log correlation.", type: "Technical" },
        { id: "CTRL-8.24", frameworks: ["ISO 27001"], domain: "Cryptography", name: "Use of cryptography", description: "Apply cryptographic controls to protect information.", type: "Technical" },
        { id: "CTRL-NIST-ID.AM-1", frameworks: ["NIST CSF"], domain: "Identify / Asset Management", name: "Asset inventory", description: "Physical devices and systems are inventoried.", type: "Administrative" },
        { id: "CTRL-NIST-PR.AC-1", frameworks: ["NIST CSF"], domain: "Protect / Access Control", name: "Identities and credentials", description: "Identities and credentials are issued, managed, verified, revoked.", type: "Technical" },
        { id: "CTRL-NIST-PR.DS-1", frameworks: ["NIST CSF"], domain: "Protect / Data Security", name: "Data-at-rest protection", description: "Data-at-rest is protected.", type: "Technical" },
        { id: "CTRL-HIPAA-164.308(a)(1)", frameworks: ["HIPAA"], domain: "Security Management Process", name: "Risk analysis and management", description: "Implement policies and procedures to prevent, detect, contain, and correct security violations.", type: "Administrative" },
        { id: "CTRL-HIPAA-164.312(a)(2)(i)", frameworks: ["HIPAA"], domain: "Access Control", name: "Unique user identification", description: "Assign a unique name and/or number for identifying and tracking user identity.", type: "Technical" },
        { id: "CTRL-PCI-1.1", frameworks: ["PCI DSS"], domain: "Network Security", name: "Firewall and router configuration", description: "Install and maintain firewall configuration to protect cardholder data.", type: "Technical" },
        { id: "CTRL-PCI-3.4", frameworks: ["PCI DSS"], domain: "Data Protection", name: "Render PAN unreadable", description: "Render PAN unreadable wherever it is stored.", type: "Technical" }
      ];

      function resetAll() {
        if (!confirm('Reset ALL lab data? This clears assets, risks, controls, etc.')) return;
        assets = [];
        vendors = [];
        risks = [];
        controls = [];
        issues = [];
        treatments = [];
        soa = [];
        incidents = [];
        save(K.assets, assets);
        save(K.vendors, vendors);
        save(K.risks, risks);
        save(K.controls, controls);
        save(K.issues, issues);
        save(K.treats, treatments);
        save(K.soa, soa);
        save(K.incidents, incidents);
        showToast('All lab data reset.');
        refreshAll();
      }

      function exportScenario() {
        const payload = {
          version: 4,
          exportedAt: new Date().toISOString(),
          assets, risks, controls, issues, treatments, soa, vendors, incidents
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `grc-lab-scenario-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        setImportStatus('Exported current data as JSON.', false);
      }

      function importScenarioFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            assets = Array.isArray(data.assets) ? data.assets : [];
            risks = Array.isArray(data.risks) ? data.risks : [];
            controls = Array.isArray(data.controls) ? data.controls : [];
            issues = Array.isArray(data.issues) ? data.issues : [];
            treatments = Array.isArray(data.treatments) ? data.treatments : [];
            soa = Array.isArray(data.soa) ? data.soa : [];
            vendors = Array.isArray(data.vendors) ? data.vendors : [];
            incidents = Array.isArray(data.incidents) ? data.incidents : [];
            save(K.assets, assets); save(K.risks, risks); save(K.controls, controls);
            save(K.issues, issues); save(K.treats, treatments); save(K.soa, soa); save(K.vendors, vendors); save(K.incidents, incidents);
            refreshAll();
            setImportStatus(`Imported scenario: ${assets.length} assets, ${vendors.length} vendors, ${risks.length} risks, ${controls.length} controls, ${issues.length} issues, ${incidents.length} incidents, ${treatments.length} actions, ${soa.length} SoA entries.`, false);
          } catch (err) {
            console.error(err);
            setImportStatus('Failed to import scenario. Check JSON file.', true);
          }
        };
        reader.onerror = () => setImportStatus('Failed to read file.', true);
        reader.readAsText(file);
      }

      function loadDemoScenario() {
        assets = [
          { id: "AST-DEMO-APP", name: "MediCloud Web Application", type: "Application", criticality: "High", dataTypes: ["PHI", "PII"], owner: "DevOps Team", location: "AWS US-East-1", notes: "Main patient portal app" },
          { id: "AST-DEMO-DB", name: "MediCloud Database", type: "Database", criticality: "High", dataTypes: ["PHI", "PII"], owner: "DBA Team", location: "AWS RDS", notes: "Stores patient records" },
          { id: "AST-DEMO-SERVER", name: "Internal File Server", type: "Server / Host", criticality: "Medium", dataTypes: ["Internal data"], owner: "IT Ops", location: "On-prem", notes: "Employee files" }
        ];
        vendors = [
          { id: "VND-DEMO-AWS", name: "AWS", type: "Cloud Provider", criticality: "High", dataAccess: "Full", contract: "Active", assessment: "2025-01-01", notes: "Cloud hosting for app and DB" },
          { id: "VND-DEMO-OKTA", name: "Okta", type: "SaaS", criticality: "Medium", dataAccess: "Read", contract: "Active", assessment: "2025-06-01", notes: "Identity management" },
          { id: "VND-DEMO-SLACK", name: "Slack", type: "SaaS", criticality: "Low", dataAccess: "None", contract: "Active", assessment: "2024-12-01", notes: "Team communication" }
        ];
        risks = [
          {
            id: "RSK-DEMO-1",
            title: "Unauthorised access to MediCloud production",
            linked: "asset-AST-DEMO-APP",
            linkedType: "asset",
            linkedId: "AST-DEMO-APP",
            linkedName: "MediCloud Web Application",
            category: "Cybersecurity",
            likelihood: 4,
            impact: 5,
            score: 20,
            resLikelihood: 2,
            resImpact: 4,
            resScore: 8,
            status: "In progress",
            owner: "CISO",
            notes: "Potential data breach"
          },
          {
            id: "RSK-DEMO-2",
            title: "Data leakage from database",
            linked: "asset-AST-DEMO-DB",
            linkedType: "asset",
            linkedId: "AST-DEMO-DB",
            linkedName: "MediCloud Database",
            category: "Privacy",
            likelihood: 3,
            impact: 5,
            score: 15,
            resLikelihood: 1,
            resImpact: 5,
            resScore: 5,
            status: "Open",
            owner: "DBA",
            notes: "Sensitive PHI exposure"
          },
          {
            id: "RSK-DEMO-3",
            title: "Vendor data breach (AWS)",
            linked: "vendor-VND-DEMO-AWS",
            linkedType: "vendor",
            linkedId: "VND-DEMO-AWS",
            linkedName: "AWS",
            category: "Third-Party",
            likelihood: 2,
            impact: 5,
            score: 10,
            resLikelihood: 1,
            resImpact: 4,
            resScore: 4,
            status: "Accepted",
            owner: "Compliance",
            notes: "Cloud provider incident"
          },
          {
            id: "RSK-DEMO-4",
            title: "Insider threat via file server",
            linked: "asset-AST-DEMO-SERVER",
            linkedType: "asset",
            linkedId: "AST-DEMO-SERVER",
            linkedName: "Internal File Server",
            category: "Operational",
            likelihood: 3,
            impact: 3,
            score: 9,
            resLikelihood: 2,
            resImpact: 2,
            resScore: 4,
            status: "Mitigated",
            owner: "HR",
            notes: "Employee data access"
          },
          {
            id: "RSK-DEMO-5",
            title: "Phishing attack on users",
            linked: "asset-AST-DEMO-APP",
            linkedType: "asset",
            linkedId: "AST-DEMO-APP",
            linkedName: "MediCloud Web Application",
            category: "Cybersecurity",
            likelihood: 4,
            impact: 4,
            score: 16,
            resLikelihood: 3,
            resImpact: 3,
            resScore: 9,
            status: "In progress",
            owner: "Security Team",
            notes: "User credentials compromise"
          }
        ];
        controls = [
          {
            id: "CTL-DEMO-MFA",
            name: "Multi-factor authentication for admins",
            type: "Preventive",
            status: "In place",
            owner: "DevSecOps",
            description: "Enforce MFA for all admin accounts",
            linkedRiskIds: ["RSK-DEMO-1", "RSK-DEMO-5"],
            linkedFrameworkControlIds: ["CTRL-5.17", "CTRL-8.5"],
            evidence: "Okta dashboard screenshot"
          },
          {
            id: "CTL-DEMO-ENC",
            name: "Data encryption at rest",
            type: "Technical",
            status: "In place",
            owner: "DBA",
            description: "Encrypt database with AES-256",
            linkedRiskIds: ["RSK-DEMO-2"],
            linkedFrameworkControlIds: ["CTRL-8.24"],
            evidence: "AWS RDS config"
          },
          {
            id: "CTL-DEMO-VRA",
            name: "Vendor risk assessment",
            type: "Administrative",
            status: "Planned",
            owner: "Compliance",
            description: "Annual vendor reviews",
            linkedRiskIds: ["RSK-DEMO-3"],
            linkedFrameworkControlIds: ["CTRL-5.19", "CTRL-5.21"],
            evidence: "Assessment report template"
          },
          {
            id: "CTL-DEMO-LOG",
            name: "Centralized logging and monitoring",
            type: "Detective",
            status: "In place",
            owner: "Security Team",
            description: "SIEM for all systems",
            linkedRiskIds: ["RSK-DEMO-1", "RSK-DEMO-4"],
            linkedFrameworkControlIds: ["CTRL-8.15", "CTRL-8.16"],
            evidence: "Splunk setup"
          },
          {
            id: "CTL-DEMO-TRAIN",
            name: "Security awareness training",
            type: "Preventive",
            status: "In place",
            owner: "HR",
            description: "Quarterly phishing simulations",
            linkedRiskIds: ["RSK-DEMO-5"],
            linkedFrameworkControlIds: ["CTRL-6.3"],
            evidence: "Training records"
          }
        ];
        issues = [
          {
            id: "ISS-DEMO-1",
            title: "Missing MFA on dev accounts",
            type: "Audit",
            severity: "High",
            status: "Open",
            owner: "Dev Lead",
            dueDate: "2025-12-31",
            notes: "From internal audit",
            assetId: "AST-DEMO-APP",
            vendorId: "",
            riskId: "RSK-DEMO-1",
            controlId: "CTL-DEMO-MFA",
            linkedSummary: "Asset: MediCloud Web Application | Risk: Unauthorised access to MediCloud production | Control: Multi-factor authentication for admins"
          },
          {
            id: "ISS-DEMO-2",
            title: "Outdated encryption keys",
            type: "Audit",
            severity: "Medium",
            status: "In progress",
            owner: "DBA",
            dueDate: "2025-11-15",
            notes: "Rotate keys",
            assetId: "AST-DEMO-DB",
            vendorId: "",
            riskId: "RSK-DEMO-2",
            controlId: "",
            linkedSummary: "Asset: MediCloud Database | Risk: Data leakage from database"
          },
          {
            id: "ISS-DEMO-3",
            title: "Vendor contract expired",
            type: "Self-Assessment",
            severity: "Low",
            status: "Resolved",
            owner: "Compliance",
            dueDate: "2025-10-01",
            notes: "Renewed",
            assetId: "",
            vendorId: "VND-DEMO-SLACK",
            riskId: "",
            controlId: "",
            linkedSummary: "Vendor: Slack"
          }
        ];
        incidents = [
          {
            id: "INC-DEMO-1",
            title: "Suspected phishing attempt",
            type: "Phishing",
            detected: "2025-10-01",
            severity: "Medium",
            status: "Contained",
            owner: "IR Team",
            notes: "User reported suspicious email",
            assetId: "AST-DEMO-APP",
            vendorId: "",
            riskId: "RSK-DEMO-5",
            controlId: "CTL-DEMO-TRAIN",
            linkedSummary: "Asset: MediCloud Web Application | Risk: Phishing attack on users | Control: Security awareness training"
          },
          {
            id: "INC-DEMO-2",
            title: "Database outage",
            type: "Denial of Service",
            detected: "2025-09-15",
            severity: "High",
            status: "Recovered",
            owner: "DBA",
            notes: "DDoS attack mitigated",
            assetId: "AST-DEMO-DB",
            vendorId: "VND-DEMO-AWS",
            riskId: "RSK-DEMO-2",
            controlId: "CTL-DEMO-ENC",
            linkedSummary: "Asset: MediCloud Database | Vendor: AWS | Risk: Data leakage from database | Control: Data encryption at rest"
          }
        ];
        treatments = [
          {
            id: "TRT-DEMO-1",
            title: "Implement MFA for all users",
            linked: "RSK-DEMO-1",
            controlId: "CTL-DEMO-MFA",
            status: "In progress",
            targetDate: "2025-12-01",
            owner: "DevOps Lead",
            budget: "1000 USD",
            notes: "Roll out Okta MFA"
          },
          {
            id: "TRT-DEMO-2",
            title: "Key rotation procedure",
            linked: "ISS-DEMO-2",
            controlId: "",
            status: "Open",
            targetDate: "2025-11-30",
            owner: "DBA",
            budget: "",
            notes: "Automate key rotation"
          },
          {
            id: "TRT-DEMO-3",
            title: "Vendor reassessment",
            linked: "RSK-DEMO-3",
            controlId: "CTL-DEMO-VRA",
            status: "Closed",
            targetDate: "2025-10-15",
            owner: "Compliance",
            budget: "500 USD",
            notes: "Completed review"
          }
        ];
        soa = FRAMEWORK_CONTROLS.map(fc => ({
          fcId: fc.id,
          applicability: 'Applicable',
          implementation: 'Auto',
          owner: '',
          rationale: '',
          evidence: ''
        }));
        save(K.assets, assets);
        save(K.vendors, vendors);
        save(K.risks, risks);
        save(K.controls, controls);
        save(K.issues, issues);
        save(K.incidents, incidents);
        save(K.treats, treatments);
        save(K.soa, soa);
        refreshAll();
        setImportStatus('Loaded full demo scenario (MediCloud Healthcare App). Explore tabs!', false);
      }

      function loadISOTemplate() {
        controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("ISO 27001")).map(fc => ({
          id: 'CTL-ISO-' + fc.id.split('-')[1],
          name: fc.name,
          type: "Technical",
          status: "Planned",
          owner: "Security Team",
          description: fc.description,
          linkedRiskIds: [],
          linkedFrameworkControlIds: [fc.id],
          evidence: ""
        }));
        soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("ISO 27001")).map(fc => ({
          fcId: fc.id,
          applicability: 'Applicable',
          implementation: 'Auto',
          owner: '',
          rationale: '',
          evidence: ''
        }));
        save(K.controls, controls);
        save(K.soa, soa);
        refreshAll();
        const fwFilter = qs('#framework-filter');
        if (fwFilter) { fwFilter.value = 'ISO 27001'; }
        const soaFilter = qs('#soa-framework-filter');
        if (soaFilter) { soaFilter.value = 'ISO 27001'; }
        if (typeof renderFrameworkControls === 'function') renderFrameworkControls();
        if (typeof renderSoATable === 'function') renderSoATable();
        const controlsTabBtn = document.querySelector('[data-grc-tab="controls"]');
        if (controlsTabBtn) controlsTabBtn.click();
        showToast('Loaded ISO 27001 template');
      }

      function loadNISTTemplate() {
        controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("NIST CSF")).map(fc => ({
          id: 'CTL-NIST-' + fc.id.split('-')[1],
          name: fc.name,
          type: "Administrative",
          status: "Planned",
          owner: "Compliance Team",
          description: fc.description,
          linkedRiskIds: [],
          linkedFrameworkControlIds: [fc.id],
          evidence: ""
        }));
        soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("NIST CSF")).map(fc => ({
          fcId: fc.id,
          applicability: 'Applicable',
          implementation: 'Auto',
          owner: '',
          rationale: '',
          evidence: ''
        }));
        save(K.controls, controls);
        save(K.soa, soa);
        refreshAll();
        const fwFilter = qs('#framework-filter');
        if (fwFilter) { fwFilter.value = 'NIST CSF'; }
        const soaFilter = qs('#soa-framework-filter');
        if (soaFilter) { soaFilter.value = 'NIST CSF'; }
        if (typeof renderFrameworkControls === 'function') renderFrameworkControls();
        if (typeof renderSoATable === 'function') renderSoATable();
        const controlsTabBtn = document.querySelector('[data-grc-tab="controls"]');
        if (controlsTabBtn) controlsTabBtn.click();
        showToast('Loaded NIST CSF template');
      }

      function loadPCITemplate() {
        controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("PCI DSS")).map(fc => ({
          id: 'CTL-PCI-' + fc.id.split('-')[1],
          name: fc.name,
          type: "Technical",
          status: "Planned",
          owner: "PCI Team",
          description: fc.description,
          linkedRiskIds: [],
          linkedFrameworkControlIds: [fc.id],
          evidence: ""
        }));
        soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("PCI DSS")).map(fc => ({
          fcId: fc.id,
          applicability: 'Applicable',
          implementation: 'Auto',
          owner: '',
          rationale: '',
          evidence: ''
        }));
        save(K.controls, controls);
        save(K.soa, soa);
        refreshAll();
        const fwFilter = qs('#framework-filter');
        if (fwFilter) { fwFilter.value = 'PCI DSS'; }
        const soaFilter = qs('#soa-framework-filter');
        if (soaFilter) { soaFilter.value = 'PCI DSS'; }
        if (typeof renderFrameworkControls === 'function') renderFrameworkControls();
        if (typeof renderSoATable === 'function') renderSoATable();
        const controlsTabBtn = document.querySelector('[data-grc-tab="controls"]');
        if (controlsTabBtn) controlsTabBtn.click();
        showToast('Loaded PCI DSS template');
      }

      function loadHIPAATemplate() {
        controls = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("HIPAA")).map(fc => ({
          id: 'CTL-HIPAA-' + fc.id.split('-')[1],
          name: fc.name,
          type: "Administrative",
          status: "Planned",
          owner: "HIPAA Team",
          description: fc.description,
          linkedRiskIds: [],
          linkedFrameworkControlIds: [fc.id],
          evidence: ""
        }));
        soa = FRAMEWORK_CONTROLS.filter(fc => fc.frameworks.includes("HIPAA")).map(fc => ({
          fcId: fc.id,
          applicability: 'Applicable',
          implementation: 'Auto',
          owner: '',
          rationale: '',
          evidence: ''
        }));
        save(K.controls, controls);
        save(K.soa, soa);
        refreshAll();
        const fwFilter = qs('#framework-filter');
        if (fwFilter) { fwFilter.value = 'HIPAA'; }
        const soaFilter = qs('#soa-framework-filter');
        if (soaFilter) { soaFilter.value = 'HIPAA'; }
        if (typeof renderFrameworkControls === 'function') renderFrameworkControls();
        if (typeof renderSoATable === 'function') renderSoATable();
        const controlsTabBtn = document.querySelector('[data-grc-tab="controls"]');
        if (controlsTabBtn) controlsTabBtn.click();
        showToast('Loaded HIPAA template');
      }

      function applyRiskThresholdInputs() {
        const high = parseInt(qs('#risk-thres-high').value, 10) || 12;
        const med = parseInt(qs('#risk-thres-med').value, 10) || 6;
        riskConfig.highThreshold = high;
        riskConfig.mediumThreshold = med;
        saveRiskConfig(riskConfig);
        renderRisksTable();
        drawMatrix();
        renderDashboard();
      }

      function syncRiskThresholdInputs() {
        const high = qs('#risk-thres-high');
        const med = qs('#risk-thres-med');
        if (high) high.value = riskConfig.highThreshold || 12;
        if (med) med.value = riskConfig.mediumThreshold || 6;
      }

      function levelFromScore(score) {
        if (score >= riskConfig.highThreshold) return 'High';
        if (score >= riskConfig.mediumThreshold) return 'Medium';
        return 'Low';
      }

      function colorForScore(score) {
        const lvl = levelFromScore(score);
        if (lvl === 'High') return '#f97373';
        if (lvl === 'Medium') return '#facc15';
        return '#4ade80';
      }

      function drawMatrix() {
        const canvas = qs('#riskMatrixCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const bgGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        bgGradient.addColorStop(0, "#111827");
        bgGradient.addColorStop(1, "#020617");
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = 'rgba(148,163,184,0.6)';
        ctx.lineWidth = 1;

        const paddingLeft = 40;
        const paddingBottom = 30;
        const paddingRight = 20;
        const paddingTop = 20;

        const gridWidth = canvas.width - paddingLeft - paddingRight;
        const gridHeight = canvas.height - paddingTop - paddingBottom;

        for (let i = 0; i <= 5; i++) {
          const x = paddingLeft + (gridWidth / 5) * i;
          ctx.beginPath();
          ctx.moveTo(x, paddingTop);
          ctx.lineTo(x, paddingTop + gridHeight);
          ctx.stroke();
        }

        for (let j = 0; j <= 5; j++) {
          const y = canvas.height - paddingBottom - (gridHeight / 5) * j;
          ctx.beginPath();
          ctx.moveTo(paddingLeft, y);
          ctx.lineTo(paddingLeft + gridWidth, y);
          ctx.stroke();
        }

        ctx.fillStyle = '#e5e7eb';
        ctx.font = '10px Poppins, system-ui';

        for (let i = 1; i <= 5; i++) {
          const x = paddingLeft + (gridWidth / 5) * i - 4;
          const y = canvas.height - paddingBottom + 14;
          ctx.fillText(String(i), x, y);
        }
        for (let j = 1; j <= 5; j++) {
          const x = paddingLeft - 18;
          const y = canvas.height - paddingBottom - (gridHeight / 5) * j + 4;
          ctx.fillText(String(j), x, y);
        }

        ctx.fillStyle = '#9ca3af';
        ctx.fillText('Likelihood →', paddingLeft + gridWidth / 2 - 30, canvas.height - 8);
        ctx.save();
        ctx.translate(12, paddingTop + gridHeight / 2 + 30);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('Impact ↑', 0, 0);
        ctx.restore();

        const showResidual = qs('#toggle-residual').classList.contains('btn-primary');

        (risks || []).forEach(r => {
          const like = showResidual ? (r.resLikelihood || r.likelihood) : r.likelihood;
          const imp = showResidual ? (r.resImpact || r.impact) : r.impact;
          if (!like || !imp) return;
          const x = paddingLeft + (gridWidth / 5) * (like - 0.5);
          const y = canvas.height - paddingBottom - (gridHeight / 5) * (imp - 0.5);
          const sc = showResidual ? (r.resScore || r.score) : r.score;
          const color = colorForScore(sc || 0);
          ctx.beginPath();
          ctx.fillStyle = color;
          ctx.strokeStyle = 'rgba(15,23,42,0.9)';
          ctx.lineWidth = 1.2;
          ctx.arc(x, y, 6, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
        });
      }

      function generateAuditorSummary() {
        const totalAssets = assets.length;
        const totalVendors = vendors.length;
        const totalRisks = risks.length;
        const totalControls = controls.length;
        const openIssues = issues.filter(i => i.status && i.status.toLowerCase() !== 'closed' && i.status.toLowerCase() !== 'resolved').length;
        const openActions = treatments.filter(t => t.status && t.status.toLowerCase() !== 'closed' && t.status.toLowerCase() !== 'completed').length;
        const incCount = incidents.length;

        const highCount = risks.filter(r => levelFromScore(r.resScore || r.score) === 'High').length;
        const medCount = risks.filter(r => levelFromScore(r.resScore || r.score) === 'Medium').length;
        const lowCount = risks.filter(r => levelFromScore(r.resScore || r.score) === 'Low').length;

        let text = '';
        text += 'Internal GRC Lab – Audit-Style Summary\n';
        text += '=====================================\n\n';
        text += '1. Scope & Context\n';
        text += `- The lab currently models ${totalAssets} asset(s) and ${totalVendors} vendor(s).\n`;
        text += `- There are ${totalRisks} risk(s) and ${totalControls} local control(s) defined.\n`;
        text += `- ${incCount} security incident(s) have been recorded in this practice environment.\n\n`;

        text += '2. Risk Posture (Residual)\n';
        text += `- High risks:   ${highCount}\n`;
        text += `- Medium risks: ${medCount}\n`;
        text += `- Low risks:    ${lowCount}\n`;
        text += '- Residual risk levels are derived from likelihood × impact after considering existing controls.\n\n';

        text += '3. Governance, Risk, and Control Observations\n';
        text += '- Assets and vendors are linked to risks, demonstrating basic traceability.\n';
        text += '- Controls are mapped to risks and, where applicable, to framework controls (ISO/NIST/HIPAA/PCI) in a simplified way.\n';
        text += `- There are ${openIssues} open issue(s) and ${openActions} open action(s) that represent work-in-progress remediation items.\n\n`;

        text += '4. Incident & Issue Themes\n';
        text += '- Incidents in this lab typically represent common scenarios: phishing, outages, and configuration issues.\n';
        text += '- Issues capture missing or weak controls (e.g., MFA gaps, key management, vendor oversight).\n';
        text += '- Treatments are used to track remediation tasks and due dates.\n\n';

        text += '5. Next Steps (For Practice)\n';
        text += '- Add more assets and vendors to reflect a more realistic environment (e.g., endpoints, logging, backup systems).\n';
        text += '- Expand the risk register for privacy, third-party, and operational risks.\n';
        text += '- Strengthen control mappings and document rationale and evidence in the SoA.\n';
        text += '- Use the generated report tab to build an executive-friendly summary for your portfolio.\n\n';

        text += 'Note: This summary is auto-generated for learning and practice only. It is not a real audit opinion.\n';

        const area = qs('#summary-text');
        if (area) area.value = text;
      }

      function generateReport() {
        const highRisks = risks.filter(r => levelFromScore(r.resScore || r.score) === 'High');
        const medRisks = risks.filter(r => levelFromScore(r.resScore || r.score) === 'Medium');
        const lowRisks = risks.filter(r => levelFromScore(r.resScore || r.score) === 'Low');
        const openIssues = issues.filter(i => i.status && i.status.toLowerCase() !== 'closed' && i.status.toLowerCase() !== 'resolved');
        const openTreats = treatments.filter(t => t.status && t.status.toLowerCase() !== 'closed' && t.status.toLowerCase() !== 'completed');

        let text = '';
        text += 'GRC Practice Lab – Executive-Style Report\n';
        text += '=========================================\n\n';
        text += '1. Overview\n';
        text += 'This report summarises the current state of the GRC practice lab environment, based on the configured assets,\n';
        text += 'vendors, risks, controls, issues, actions, and incidents. The intent is to practise how GRC data can be turned\n';
        text += 'into an executive-level narrative.\n\n';

        text += '2. Key Risk Highlights\n';
        if (highRisks.length === 0 && medRisks.length === 0) {
          text += '- No high or medium residual risks are registered at this time in the lab data.\n';
        } else {
          if (highRisks.length > 0) {
            text += `- High residual risks (${highRisks.length}):\n`;
            highRisks.forEach(r => {
              text += `  • ${r.title} (Owner: ${r.owner || 'n/a'}, Score: ${r.resScore || r.score})\n`;
            });
          }
          if (medRisks.length > 0) {
            text += `- Medium residual risks (${medRisks.length}):\n`;
            medRisks.forEach(r => {
              text += `  • ${r.title} (Owner: ${r.owner || 'n/a'}, Score: ${r.resScore || r.score})\n`;
            });
          }
          if (lowRisks.length > 0) {
            text += `- Low residual risks (${lowRisks.length}) are also tracked but not listed in detail.\n`;
          }
        }
        text += '\n';

        text += '3. Control Environment\n';
        text += '- Controls in this lab are mapped to risks and (optionally) to simplified framework controls.\n';
        text += '- Stronger control coverage generally correlates with lower residual risk in the matrix.\n';
        text += '- For practice, you may add more detective and preventive controls, and track their implementation status.\n\n';

        text += '4. Open Issues & Actions\n';
        text += `- Open issues: ${openIssues.length}\n`;
        openIssues.forEach(i => {
          text += `  • [${i.severity}] ${i.title} (Owner: ${i.owner || 'n/a'}, Due: ${i.dueDate || 'n/a'})\n`;
        });
        text += `- Open remediation actions: ${openTreats.length}\n`;
        openTreats.forEach(t => {
          text += `  • ${t.title} (Owner: ${t.owner || 'n/a'}, Target date: ${t.targetDate || 'n/a'})\n`;
        });
        text += '\n';

        text += '5. Recommended Focus Areas (For Practice)\n';
        text += '- Use this lab to rehearse how you would explain risk and control posture to non-technical stakeholders.\n';
        text += '- Practise grouping risks by theme (e.g., identity, data protection, vendor, operations).\n';
        text += '- Extend the SoA to show which framework controls are in scope and how they are implemented.\n';
        text += '- Iterate on the report and summary as you change data to see how the narrative evolves.\n\n';

        text += 'Disclaimer: This report is generated from a training lab and is intended solely for educational purposes.\n';

        const area = qs('#report-text');
        if (area) area.value = text;
      }

      function renderDashboard() {
        const a = qs('#dash-count-assets');
        const v = qs('#dash-count-vendors');
        const c = qs('#dash-count-controls');
        const s = qs('#dash-risk-score');
        const high = qs('#dash-risk-high');
        const med = qs('#dash-risk-med');
        const low = qs('#dash-risk-low');
        const openIssuesEl = qs('#dash-open-issues');
        const openActionsEl = qs('#dash-open-actions');
        const openIncEl = qs('#dash-open-incidents');

        const avgScore = risks.length ? Math.round(risks.reduce((acc, r) => acc + (r.resScore || r.score || 0), 0) / risks.length) : 0;
        const highCount = risks.filter(r => levelFromScore(r.resScore || r.score) === 'High').length;
        const medCount = risks.filter(r => levelFromScore(r.resScore || r.score) === 'Medium').length;
        const lowCount = risks.filter(r => levelFromScore(r.resScore || r.score) === 'Low').length;
        const openIssues = issues.filter(i => i.status && i.status.toLowerCase() !== 'closed' && i.status.toLowerCase() !== 'resolved').length;
        const openActions = treatments.filter(t => t.status && t.status.toLowerCase() !== 'closed' && t.status.toLowerCase() !== 'completed').length;
        const openInc = incidents.filter(inc => inc.status && inc.status.toLowerCase() !== 'closed' && inc.status.toLowerCase() !== 'resolved' && inc.status.toLowerCase() !== 'recovered').length;

        if (a) a.textContent = String(assets.length);
        if (v) v.textContent = `${vendors.length} vendors`;
        if (c) c.textContent = `${controls.length} controls`;
        if (s) s.textContent = String(avgScore);
        if (high) high.textContent = `${highCount} high`;
        if (med) med.textContent = `${medCount} medium`;
        if (low) low.textContent = `${lowCount} low`;
        if (openIssuesEl) openIssuesEl.textContent = String(openIssues);
        if (openActionsEl) openActionsEl.textContent = `${openActions} actions`;
        if (openIncEl) openIncEl.textContent = `${openInc} incidents`;
      }

      function applyTabs() {
        const buttons = qsa('.grc-tab-buttons .btn');
        const tabs = qsa('.grc-tab');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-grc-tab');
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tabs.forEach(t => t.classList.remove('active'));
            const tabEl = qs('#tab-' + target);
            if (tabEl) tabEl.classList.add('active');
          });
        });
      }

      function scoreChallenge(id) {
        const c = CHALLENGES.find(x => x.id === id);
        if (!c) return;
        let score = 0;
        let max = 0;
        if (c.minAssets) {
          max++;
          if (assets.length >= c.minAssets) score++;
        }
        if (c.minRisks) {
          max++;
          if (risks.length >= c.minRisks) score++;
        }
        if (c.minControls) {
          max++;
          if (controls.length >= c.minControls) score++;
        }
        if (c.minIssues) {
          max++;
          if (issues.length >= c.minIssues) score++;
        }
        if (c.minVendors) {
          max++;
          if (vendors.length >= c.minVendors) score++;
        }
        if (c.minIncidents) {
          max++;
          if (incidents.length >= c.minIncidents) score++;
        }
        if (c.minTreatments) {
          max++;
          if (treatments.length >= c.minTreatments) score++;
        }
        const pct = max ? Math.round((score / max) * 100) : 0;
        const el = qs(`#challenge-${id}-score`);
        if (el) {
          el.textContent = `Score: ${score}/${max} (${pct}%)`;
        }
        showToast(`Challenge ${id} – approx. completion: ${pct}%`);
      }

      document.addEventListener('DOMContentLoaded', () => {
        applyTabs();

        const canvas = qs('#riskMatrixCanvas');
        if (canvas) {
          qs('#toggle-inherent').addEventListener('click', () => {
            qs('#toggle-inherent').classList.add('btn-primary');
            qs('#toggle-residual').classList.remove('btn-primary');
            drawMatrix();
          });
          qs('#toggle-residual').addEventListener('click', () => {
            qs('#toggle-residual').classList.add('btn-primary');
            qs('#toggle-inherent').classList.remove('btn-primary');
            drawMatrix();
          });
          qs('#matrix-export').addEventListener('click', () => {
            const a = document.createElement('a');
            a.download = 'risk_matrix.png';
            a.href = canvas.toDataURL('image/png');
            a.click();
          });
        }

        const btnExport = qs('#btn-export');
        const btnImport = qs('#btn-import');
        const fileImport = qs('#file-import');
        const btnLoadDemo = qs('#btn-load-demo');
        const btnReset = qs('#btn-reset');

        if (btnExport) btnExport.addEventListener('click', exportScenario);
        if (btnImport && fileImport) {
          btnImport.addEventListener('click', () => fileImport.click());
          fileImport.addEventListener('change', e => importScenarioFile(e.target.files[0]));
        }
        if (btnLoadDemo) btnLoadDemo.addEventListener('click', loadDemoScenario);
        if (btnReset) btnReset.addEventListener('click', resetAll);

        const sumRefresh = qs('#summary-refresh');
        const sumCopy = qs('#summary-copy');
        if (sumRefresh) sumRefresh.addEventListener('click', generateAuditorSummary);
        if (sumCopy) {
          sumCopy.addEventListener('click', () => {
            const text = qs('#summary-text');
            if (!text) return;
            text.select();
            document.execCommand('copy');
            showToast('Copied to clipboard');
          });
        }

        const repBtn = qs('#generate-report');
        if (repBtn) repBtn.addEventListener('click', generateReport);

        const btnISO = qs('#load-iso-template');
        const btnNIST = qs('#load-nist-template');
        const btnPCI = qs('#load-pci-template');
        const btnHIPAA = qs('#load-hipaa-template');
        if (btnISO) btnISO.addEventListener('click', loadISOTemplate);
        if (btnNIST) btnNIST.addEventListener('click', loadNISTTemplate);
        if (btnPCI) btnPCI.addEventListener('click', loadPCITemplate);
        if (btnHIPAA) btnHIPAA.addEventListener('click', loadHIPAATemplate);

        syncRiskThresholdInputs();
        refreshAll();
      });

      function refreshAll() {
        // NOTE: In your original code you already had renderAssetsTable, renderVendorsTable,
        // renderRisksTable, renderControlsTable, renderIssuesTable, renderIncidentsTable,
        // renderTreatmentsTable, renderFrameworkControls, renderSoATable.
        // Here we just call them if they exist, to keep all logic.
        if (typeof renderAssetsTable === 'function') renderAssetsTable(currentAssetsPage);
        if (typeof renderVendorsTable === 'function') renderVendorsTable(currentVendorsPage);
        if (typeof renderRisksTable === 'function') renderRisksTable(currentRisksPage);
        if (typeof renderControlsTable === 'function') renderControlsTable(currentControlsPage);
        if (typeof renderIssuesTable === 'function') renderIssuesTable(currentIssuesPage);
        if (typeof renderIncidentsTable === 'function') renderIncidentsTable(currentIncidentsPage);
        if (typeof renderTreatmentsTable === 'function') renderTreatmentsTable(currentTreatmentsPage);
        if (typeof renderFrameworkControls === 'function') renderFrameworkControls(currentFrameworksPage);
        if (typeof renderSoATable === 'function') renderSoATable(currentSoAPage);
        renderDashboard();
        drawMatrix();
      }
    })();
  </script>
</body>
</html>
