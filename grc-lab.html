



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>GRC Practice Lab Enhanced | Complete Edition</title>
    <meta name="description" content="Interactive GRC simulation lab - 400+ controls from ISO 27001, NIST CSF, PCI DSS, HIPAA, SOC 2, CIS, GDPR, CMMC, COBIT">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
:root {
    /* Premium Design Tokens */
    --bg: #0A0A0A;
    --surface: #121212;
    --surface-elevated: #1A1A1A;
    --border: rgba(255,255,255,.08);
    --border-elevated: rgba(255,255,255,.12);
    --text-primary: #f8fafc;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --accent-primary: #3b82f6;
    --accent-success: #10b981;
    --accent-warning: #f59e0b;
    --accent-danger: #ef4444;
    --accent-info: #06b6d4;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.4);
    --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-serif: 'Cormorant Garamond', Georgia, serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; height: 100%; }
body {
    font-family: var(--font-sans);
    background: var(--bg) !important;
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-serif);
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 1rem;
    letter-spacing: -0.01em;
}
h1 {
    font-size: clamp(32px, 4vw, 48px);
    font-weight: 400;
    color: var(--text-primary);
}
h2 {
    font-size: clamp(24px, 3vw, 32px);
    margin-top: 2rem;
}
.lead { font-size: 1.125rem; color: var(--text-secondary); margin-bottom: 1.5rem; }
.wrap { max-width: 1200px; margin: 0 auto; padding: 28px 18px 60px; position: relative; z-index: 1; }
.topbar {
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    position:sticky; top:0; z-index:50; padding: 24px 0; margin-bottom: 18px;
    background: rgba(10, 10, 10, 0.9); border-bottom: 1px solid var(--border);
    backdrop-filter: blur(20px) saturate(180%);
}
.brandRow{ display:flex; align-items:center; gap:10px; text-decoration:none; color: inherit; }
.logo {
    width:38px; height:38px; border-radius: var(--radius-md);
    background: var(--surface-elevated); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
}
.brandTitle{ margin:0; font-size:14px; font-weight:800; }
.brandSub{ margin-top:2px; font-size:12px; color: var(--text-muted); }
.navlinks{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.pill {
    display:flex; align-items:center; gap:8px; padding: 12px 16px; border-radius: var(--radius-md);
    background: transparent; border: 1px solid var(--border-elevated);
    color: var(--text-primary); cursor:pointer; transition: all .18s;
    font-weight:600; font-size:14px; text-decoration:none;
}
.pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.03); border-color: var(--text-primary); }
.pill.primary {
    background: var(--text-primary); color: var(--bg); border-color: var(--text-primary);
}
.pill.primary:hover{ background: transparent; color: var(--text-primary); }
.container-glass {
    background: var(--surface) !important; border: 1px solid var(--border) !important;
    backdrop-filter: blur(12px); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-lg);
}
.card-glass {
    background: var(--surface-elevated) !important; border: 1px solid var(--border) !important;
    border-radius: var(--radius-md); padding: 1.5rem; transition: all 0.25s;
}
.card-glass:hover { border-color: var(--border-elevated); transform: translateY(-4px); }
.tab-nav { display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 1rem 0; margin-bottom: 2rem; }
.tab-btn {
    border-radius: var(--radius-md) !important; padding: 0.75rem 1.25rem !important;
    border: 1px solid var(--border-elevated) !important; background: transparent !important;
    color: var(--text-primary) !important; font-weight: 600 !important; white-space: nowrap;
    transition: all .18s;
}
.tab-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.03) !important; }
.tab-btn.active {
    background: var(--text-primary) !important;
    color: var(--bg) !important;
}
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.form-control, .form-select, textarea {
    background: rgba(255,255,255,.05) !important; border: 1px solid var(--border) !important;
    color: var(--text-primary) !important; border-radius: var(--radius-sm);
    padding: 0.75rem 1rem; transition: all 0.15s;
}
.form-control:focus, .form-select:focus {
    background: rgba(255,255,255,.08) !important; border-color: var(--border-elevated) !important;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05); color: var(--text-primary) !important;
}
.form-control::placeholder { color: rgba(255,255,255,.45) !important; }
.form-select option { color: #111 !important; }
.form-label { color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; }
.table-dark {
    --bs-table-bg: transparent; --bs-table-color: var(--text-primary);
    --bs-table-border-color: var(--border-light);
}
.table-dark thead th {
    background: rgba(30, 41, 59, 0.8); border-bottom: 2px solid var(--border-medium);
    font-weight: 700; color: var(--text-secondary); padding: 1rem;
}
.table-dark tbody tr { transition: background-color 0.15s; }
.table-dark tbody tr:hover { background: rgba(59, 130, 246, 0.05); }
.table-dark td { padding: 1rem; vertical-align: middle; border-color: var(--border-light); }
.btn {
    font-weight: 600; padding: 0.75rem 1.5rem; border-radius: var(--radius-md);
    transition: all 0.15s;
}
.btn-primary {
    background: linear-gradient(135deg, var(--accent-primary), #1d4ed8); border: none;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3); }
.btn-outline-light { border-color: var(--border-medium); color: var(--text-secondary); }
.btn-outline-light:hover {
    background: rgba(255,255,255,.05); border-color: var(--accent-primary); color: var(--text-primary);
}
.btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
.status-badge {
    display: inline-flex; align-items: center; padding: 0.25rem 0.75rem;
    border-radius: 100px; font-size: 0.75rem; font-weight: 600;
}
.status-open { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
.status-in-progress { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
.status-closed { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
.status-mitigated { background: rgba(6, 182, 212, 0.15); color: #67e8f9; }
.framework-badge {
    display: inline-flex; align-items: center; padding: 0.25rem 0.75rem;
    border-radius: 100px; font-size: 0.75rem; font-weight: 600; margin: 0.125rem;
}
.points-badge{
    display:inline-flex; align-items:center; justify-content:center;
    padding:.25rem .65rem; border-radius: 999px;
    font-size:.75rem; font-weight:800; letter-spacing:.01em;
    border:1px solid rgba(255,255,255,.12);
}
.points-green{ background: rgba(16,185,129,.16); color:#6ee7b7; }
.points-amber{ background: rgba(245,158,11,.16); color:#fcd34d; }
.points-red{ background: rgba(239,68,68,.16); color:#fca5a5; }
.points-cyan{ background: rgba(34,211,238,.16); color:#67e8f9; }

.badge-iso { background: rgba(59, 130, 246, 0.15); color: #93c5fd; }
.badge-nist { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
.badge-pci { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
.badge-hipaa { background: rgba(236, 72, 153, 0.15); color: #f9a8d4; }
.badge-soc2 { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; }
.badge-cis { background: rgba(34, 211, 238, 0.15); color: #67e8f9; }
.badge-gdpr { background: rgba(251, 113, 133, 0.15); color: #fda4af; }
.badge-cmmc { background: rgba(234, 179, 8, 0.15); color: #fde047; }
.badge-cobit { background: rgba(168, 85, 247, 0.15); color: #d8b4fe; }
.metric-card {
    background: rgba(30, 41, 59, 0.7); border: 1px solid var(--border-light);
    border-radius: var(--radius-md); padding: 1.5rem; text-align: center; transition: all 0.25s;
}
.metric-card:hover { border-color: var(--accent-primary); transform: translateY(-4px); }
.metric-value {
    font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-info));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.metric-label {
    color: var(--text-muted); font-size: 0.875rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.05em;
}
.modal-content {
    background: rgba(10,14,26,.92) !important; border: 1px solid rgba(255,255,255,.12) !important;
}
.modal-header, .modal-footer { border-color: rgba(255,255,255,.10) !important; }
.modal-backdrop { opacity: 0.5 !important; }
@media (max-width: 768px) {
    h1 { font-size: 2rem; } h2 { font-size: 1.5rem; }
    .container-glass { padding: 1.5rem; }
    .tab-btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
}
        /* === Risk Heatmap: force white text === */
.risk-heatmap-white,
.risk-heatmap-white * {
  color: #ffffff !important;
}

.risk-heatmap-white .text-muted {
  color: #ffffff !important;
  opacity: 0.85;
}

.risk-heatmap-white small {
  color: #ffffff !important;
  opacity: 0.85;
}
/* ================================
   Risk Heatmap – Selected Cell Glow
   ================================ */

/* ================================
   Heatmap Selected Cell Glow
   ================================ */

.heatmap-cell.selected {
  outline: 2px solid rgba(124, 58, 237, 0.9);
  box-shadow:
    0 0 0 2px rgba(124, 58, 237, 0.35),
    0 0 18px rgba(124, 58, 237, 0.65),
    inset 0 0 12px rgba(124, 58, 237, 0.25);
  transform: scale(1.03);
  z-index: 2;
}

/* ================================
   Hero / Header Tile Polish (GRC Practice Lab)
   ================================ */

/* Make the first hero tile feel "product-grade" */
.wrap > section.py-5 .container-glass {
  padding: 2.25rem !important;
}

/* Bigger, cleaner title */
.wrap > section.py-5 h1 {
  font-size: 34px !important;
  line-height: 1.12 !important;
  letter-spacing: -0.02em !important;
}

/* Subtitle: slightly bigger and clearer */
.wrap > section.py-5 h1 + span,
.wrap > section.py-5 .container-glass span {
  font-size: 15.5px !important;
  color: rgba(255,255,255,.78) !important;
}

/* Align header row content nicely + breathing room */
.wrap > section.py-5 .container-glass > .row .mb-3.p-3 > div {
  align-items: center !important;
}

/* Buttons slightly larger + consistent height */
.wrap > section.py-5 .btn.btn-sm {
  padding: 0.55rem 0.95rem !important;
  font-size: 14px !important;
  border-radius: 12px !important;
}

/* Disclaimer block: better readability */
.wrap > section.py-5 .container-glass .mt-3.p-3 {
  padding: 1.05rem 1.15rem !important;
}

.wrap > section.py-5 .container-glass .mt-3.p-3 strong {
  font-size: 14.5px !important;
}

.wrap > section.py-5 .container-glass .mt-3.p-3 div {
  font-size: 14px !important;
  line-height: 1.55 !important;
}

/* Framework pills: slightly bigger + more “enterprise” */
.wrap > section.py-5 .framework-badge {
  padding: 0.33rem 0.8rem !important;
  font-size: 12.5px !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
}
/* ================================
   Full-width Framework Badges Row
   ================================ */

.frameworks-row {
  justify-content: flex-start;
  padding-top: 6px;
}

/* Optional: distribute nicely if screen is wide */
@media (min-width: 992px) {
  .frameworks-row {
    justify-content: space-between;
  }
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,.05); }
::-webkit-scrollbar-thumb { background: var(--border-medium); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
    
    

/* ================================
   Dashboard spacing compact fixes
   ================================ */

/* Reduce vertical & horizontal gutter on dashboard grids */
#tabDashboard .row{
  --bs-gutter-x: 0.9rem;
  --bs-gutter-y: 0.9rem;
}

/* Compact metric cards (dashboard top tiles) */
#tabDashboard .metric-card{
  padding: 1.1rem !important;
}
#tabDashboard .metric-value{
  font-size: 2.1rem !important;
  margin-bottom: 0.25rem !important;
}

/* Slightly tighter card spacing under dashboard */
#tabDashboard .card-glass{
  padding: 1.25rem !important;
}



/* ================================
   Dashboard tiles: bring closer
   ================================ */
#tabDashboard .container-glass{
  padding: 1.5rem !important;
}
#tabDashboard h2{
  margin-top: 0 !important;
  margin-bottom: 1rem !important;
}
/* tighten bootstrap gutters for dashboard rows */
#tabDashboard .g-3, 
#tabDashboard .g-2,
#tabDashboard .row{
  --bs-gutter-x: 0.55rem !important;
  --bs-gutter-y: 0.55rem !important;
}
/* reduce extra spacing between metric row and the next row */
#tabDashboard .row.mb-3{ margin-bottom: 0.6rem !important; }
#tabDashboard .metric-card{ padding: 1rem !important; }
#tabDashboard .metric-value{ font-size: 2.0rem !important; margin-bottom: 0.2rem !important; }
#tabDashboard .card-glass{ padding: 1.15rem !important; }

/* ================================
   Risks tab: make category text visible
   ================================ */
#tabRisks .text-muted,
#tabRisks small.text-muted{
  color: rgba(255,255,255,.78) !important;
  opacity: 1 !important;
}
/* ================================
   Dashboard – Recent Risks text color fix
   ================================ */

/* Make category labels readable in Recent Risks */
#tabDashboard .card-glass .text-muted {
  color: rgba(255,255,255,0.78) !important;
}
/* ===== Global Footer ===== */
.footer{
  margin-top: 48px;
  padding: 22px 18px;
  border-top: 1px solid rgba(255,255,255,.12);
  background: rgba(10,14,26,.55);
  backdrop-filter: blur(14px);
  border-radius: 18px;
}

.footer a{
  color: rgba(255,255,255,.85);
  text-decoration: none;
  font-weight: 700;
}

.footer a:hover{
  color: #ffffff;
}
.site-logo{
  width: 44px;
  height: 44px;
  border-radius: 12px;
  object-fit: cover;
  box-shadow: 0 6px 20px rgba(0,0,0,.35);
}

/* Project Cards */
.project-card {
    background: var(--surface-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
}
.project-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.08), transparent);
    pointer-events: none;
}
.project-card:hover {
    transform: translateY(-4px);
    border-color: var(--accent-primary);
    box-shadow: 0 10px 40px rgba(59, 130, 246, 0.2);
}
.project-card > * { position: relative; }

.project-task-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
}
.project-task-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    color: rgba(255,255,255,0.8);
}
.project-task-item.completed {
    color: rgba(16, 185, 129, 0.9);
}
.project-task-item i {
    font-size: 1rem;
}
.project-progress-bar {
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 999px;
    overflow: hidden;
    margin-top: 1rem;
}
.project-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
    transition: width 0.3s;
}

/* Portfolio Summary Cards */
.portfolio-summary {
    background: var(--surface-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    color: #ffffff !important;
}
.portfolio-summary * {
    color: #ffffff !important;
}
.portfolio-summary h3 {
    color: var(--accent-primary) !important;
    margin-bottom: 1.5rem;
}
.portfolio-summary h5 {
    color: #ffffff !important;
}
.portfolio-summary p {
    color: rgba(255,255,255,0.9) !important;
}
.portfolio-summary .text-muted {
    color: rgba(255,255,255,0.8) !important;
}
.portfolio-bullet {
    background: rgba(255,255,255,0.05);
    border-left: 3px solid var(--accent-success);
    padding: 0.75rem 1rem;
    margin: 0.5rem 0;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: #ffffff !important;
}
.portfolio-stat {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 999px;
    margin: 0.25rem;
    font-size: 0.875rem;
    color: #ffffff !important;
}
    border-radius: 999px;
    margin: 0.25rem;
    font-size: 0.875rem;
    color: var(--text-primary) !important;
}
/* ================================
   Projects tab – force white text
   Industry / Size / Description
   ================================ */

#tabProjects .project-card strong,
#tabProjects .project-card .industry,
#tabProjects .project-card .size,
#tabProjects .project-card .description,
#tabProjects .project-card p,
#tabProjects .project-card span {
  color: #ffffff !important;
}

/* If labels are rendered as muted text */
#tabProjects .project-card .text-muted {
  color: #ffffff !important;
  opacity: 0.9;
}



/* Risk Analytics header polish */
#riskAnalyticsProjectFilter,
#riskAnalyticsViewMode {
  font-size: 0.9rem;
}

#tabMatrix small.text-muted {
  font-size: 0.7rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

</style>
</head>
<body>

<div class="wrap">
        <header class="topbar">
  <a class="brandRow" href="index.html" style="text-decoration:none;color:inherit;">
 <img src="logo.png" alt="GRC Made Simple Logo" class="site-logo">

    <div>
      <div class="brandTitle">John Bommeraveni Joseph</div>
      <div class="brandSub">Cybersecurity • GRC • AI Governance • ISO/IEC 27001 & 42001 Lead Auditor</div>
    </div>
  </a>

<nav class="navlinks" aria-label="Primary navigation">
  <a class="pill muted" href="index.html">Home</a>
  <a class="pill primary" href="grc-lab.html">GRC Lab</a>
    <a class="pill muted" href="terms.html">Terms</a>
  <a class="pill muted" href="https://www.youtube.com/@GRCMadeSimple" target="_blank" rel="noopener noreferrer">YouTube</a>
</nav>

</header>

    <section class="py-5">
        <div class="container">
            <div class="container-glass">
                <div class="row align-items-center">
<div class="col-12">

  <!-- ONE TILE: Title + Subtitle + Buttons all on one line -->
  <div class="mb-3 p-3"
       style="border:1px solid rgba(255,255,255,.12);
              background:rgba(255,255,255,.04);
              border-radius:14px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">

      <!-- Left: Title + subtitle in same line -->
      <div style="display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;">
        <h1 class="mb-0" style="font-size: clamp(36px, 5vw, 64px); font-weight: 600;">GRC Practice Lab</h1>
        <span style="color:rgba(255,255,255,.75); font-size:14px;">
          Interactive simulation with 400+ controls from 9 major frameworks
        </span>
      </div>

      <!-- Right: Buttons -->
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="window.app.loadDemoScenario()">
          <i class="bi bi-rocket-takeoff me-1"></i> Load Demo
        </button>
        <button class="btn btn-outline-light btn-sm" onclick="window.app.exportAllData()">
          <i class="bi bi-download me-1"></i> Export
        </button>
      </div>

    </div>
  </div>

  <!-- Educational purpose: ONE continuous title + full line text -->
  <div class="mt-3 p-3"
       style="border:1px solid rgba(255,255,255,.12);
              background:rgba(255,255,255,.04);
              border-radius:14px;">
    <div style="display:flex; gap:10px; align-items:flex-start;">
      <i class="bi bi-info-circle"
         style="font-size:18px; color:rgba(255,255,255,.85); margin-top:2px;"></i>

      <div style="color:rgba(255,255,255,.85); font-size:14px; line-height:1.5;">
        <strong>Educational / Practice Use Only —</strong>
        This GRC Practice Lab is a learning simulator for portfolio building and skills practice.
        It is <strong>not</strong> a certified GRC platform and should <strong>not</strong> be used
        as the sole basis for production compliance decisions, formal audits, or certification
        activities. Control statements and descriptions are paraphrased for training and educational purposes.
      </div>
    </div>
  </div>

  <!-- Framework badges -->
<div class="d-flex flex-wrap gap-2 mt-3 w-100 frameworks-row">

    <span class="framework-badge badge-iso">ISO 27001</span>
    <span class="framework-badge badge-nist">NIST CSF</span>
    <span class="framework-badge badge-pci">PCI DSS</span>
    <span class="framework-badge badge-hipaa">HIPAA</span>
    <span class="framework-badge badge-soc2">SOC 2</span>
    <span class="framework-badge badge-cis">CIS</span>
    <span class="framework-badge badge-gdpr">GDPR</span>
    <span class="framework-badge badge-cmmc">CMMC</span>
    <span class="framework-badge badge-cobit">COBIT</span>
  </div>

</div>

            </div>
        </div>
    </section>

    <section class="py-4">
        <div class="container">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="window.app.switchTab('dashboard')">
                    <i class="bi bi-speedometer2 me-2"></i> Dashboard
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('frameworks')">
                    <i class="bi bi-building me-2"></i> Frameworks
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('assets')">
                    <i class="bi bi-hdd-stack me-2"></i> Assets
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('vendors')">
                    <i class="bi bi-people me-2"></i> Vendors
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('risks')">
                    <i class="bi bi-exclamation-triangle me-2"></i> Risks
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('controls')">
                    <i class="bi bi-shield-check me-2"></i> Controls
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('issues')">
                    <i class="bi bi-bug me-2"></i> Issues
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('incidents')">
                    <i class="bi bi-exclamation-octagon me-2"></i> Incidents
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('treatments')">
                    <i class="bi bi-check2-circle me-2"></i> Treatments
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('SoA')">
                    <i class="bi bi-list-check me-2"></i> SoA
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('matrix')">
                    <i class="bi bi-grid-3x3-gap me-2"></i> Risk Matrix
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('reports')">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i> Reports
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('projects')">
                    <i class="bi bi-briefcase me-2"></i> Projects
                </button>
                <button class="tab-btn" onclick="window.app.switchTab('portfolio')">
                    <i class="bi bi-folder-check me-2"></i> Portfolio
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div id="tabDashboard" class="tab-content active">
                <div class="container-glass">
                    <h2>Dashboard Overview</h2>
                    <div class="row g-2 mb-2">
                        <div class="col-md-3 col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="metricAssets">0</div>
                                <div class="metric-label">Assets</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="metricRisks">0</div>
                                <div class="metric-label">Risks</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="metricControls">0</div>
                                <div class="metric-label">Controls</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="metricCoverage">0%</div>
                                <div class="metric-label">Coverage</div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-lg-8">
                            <div class="card-glass">
                                <h4>Recent Risks</h4>
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead><tr><th>Risk</th><th>Severity</th><th>Status</th><th>Action</th></tr></thead>
                                        <tbody id="recentRisks">
                                            <tr><td colspan="4" class="text-center text-muted">No risks yet</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card-glass">
                                <h4>Quick Actions</h4>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-light" onclick="window.app.switchTab('risks'); window.app.showRiskForm()">
                                        <i class="bi bi-plus-circle me-2"></i> Add Risk
                                    </button>
                                    <button class="btn btn-outline-light" onclick="window.app.loadDemoScenario()">
                                        <i class="bi bi-play-circle me-2"></i> Load Demo
                                    </button>
                                    <button class="btn btn-outline-light" onclick="window.app.exportAllData()">
                                        <i class="bi bi-box-arrow-up me-2"></i> Export
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="window.resetLabData()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Frameworks Tab -->
            <div id="tabFrameworks" class="tab-content">
                <div class="container-glass">
                    <h2>Framework Library (400+ Controls)</h2>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <select class="form-select" id="frameworkSelect" onchange="window.app.renderFrameworks()">
                                <option value="all">All Frameworks</option>
                                <option value="iso">ISO 27001</option>
                                <option value="nist">NIST CSF</option>
                                <option value="pci">PCI DSS</option>
                                <option value="hipaa">HIPAA</option>
                                <option value="soc2">SOC 2</option>
                                <option value="cis">CIS Controls</option>
                                <option value="gdpr">GDPR</option>
                                <option value="cmmc">CMMC</option>
                                <option value="cobit">COBIT</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="categorySelect" onchange="window.app.renderFrameworks()">
                                <option value="all">All Categories</option>
                                <option value="Access Control">Access Control</option>
<option value="Asset Management">Asset Management</option>
<option value="Cloud Security">Cloud Security</option>
<option value="Network Security">Network Security</option>
<option value="Application Security">Application Security</option>
<option value="Data Protection">Data Protection</option>
<option value="Monitoring & Logging">Monitoring &amp; Logging</option>
<option value="Incident Management">Incident Management</option>
<option value="Vulnerability Management">Vulnerability Management</option>
<option value="Change Management">Change Management</option>
<option value="Business Continuity">Business Continuity</option>
<option value="Vendor Management">Vendor Management</option>
<option value="Privacy">Privacy</option>
<option value="Compliance">Compliance</option>
<option value="Governance">Governance</option>
<option value="Physical Security">Physical Security</option>
<option value="Human Resources">Human Resources</option>
<option value="Risk Management">Risk Management</option>
</select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="frameworkSearch" placeholder="Search...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Framework</th><th>Description</th></tr></thead>
                            <tbody id="frameworkTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Assets Tab -->
            <div id="tabAssets" class="tab-content">
                <div class="container-glass">
                    <h2>Asset Inventory</h2>
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="assetSearch" placeholder="Search assets...">
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" onclick="window.app.showAssetForm()">
                                <i class="bi bi-plus-circle me-2"></i> Add Asset
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Name</th><th>Type</th><th>Criticality</th><th>Owner</th><th>Actions</th></tr></thead>
                            <tbody id="assetTableBody">
                                <tr><td colspan="5" class="text-center text-muted">No assets yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Vendors Tab -->
            <div id="tabVendors" class="tab-content">
                <div class="container-glass">
                    <h2>Vendor Management</h2>
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="vendorSearch" placeholder="Search vendors...">
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" onclick="window.app.showVendorForm()">
                                <i class="bi bi-plus-circle me-2"></i> Add Vendor
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Name</th><th>Service</th><th>Risk Level</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="vendorTableBody">
                                <tr><td colspan="5" class="text-center text-muted">No vendors yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Risks Tab -->
            <div id="tabRisks" class="tab-content">
                <div class="container-glass">
                    <h2>Risk Register</h2>
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="riskSearch" placeholder="Search risks...">
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" onclick="window.app.showRiskForm()">
                                <i class="bi bi-plus-circle me-2"></i> Add Risk
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Title</th><th>Category</th><th>Severity</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="riskTableBody">
                                <tr><td colspan="5" class="text-center text-muted">No risks yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Controls Tab -->
            <div id="tabControls" class="tab-content">
                <div class="container-glass">
                    <h2>Control Library</h2>
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="controlSearch" placeholder="Search controls...">
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" onclick="window.app.showControlForm()">
                                <i class="bi bi-plus-circle me-2"></i> Add Control
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Name</th><th>Type</th><th>Framework</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="controlTableBody">
                                <tr><td colspan="5" class="text-center text-muted">No controls yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Issues Tab -->
            <div id="tabIssues" class="tab-content">
                <div class="container-glass">
                    <h2>Security Issues</h2>
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="issueSearch" placeholder="Search issues...">
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" onclick="window.app.showIssueForm()">
                                <i class="bi bi-plus-circle me-2"></i> Add Issue
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Title</th><th>Source</th><th>Severity</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="issueTableBody">
                                <tr><td colspan="5" class="text-center text-muted">No issues yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Incidents Tab -->
            <div id="tabIncidents" class="tab-content">
                <div class="container-glass">
                    <h2>Security Incidents</h2>
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="incidentSearch" placeholder="Search incidents...">
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" onclick="window.app.showIncidentForm()">
                                <i class="bi bi-plus-circle me-2"></i> Add Incident
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Title</th><th>Type</th><th>Severity</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="incidentTableBody">
                                <tr><td colspan="5" class="text-center text-muted">No incidents yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Treatments Tab -->
            <div id="tabTreatments" class="tab-content">
                <div class="container-glass">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                        <div>
                            <h2 class="mb-1">Treatments</h2>
                            <div class="text-muted">Risk Treatment Plan (link risks to controls, owners, due dates).</div>
                        </div>
                        <button class="btn btn-primary" onclick="window.app.showTreatmentForm()"><i class="bi bi-plus-circle me-2"></i> Add Treatment</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Risk</th><th>Treatment</th><th>Owner</th><th>Target</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="treatmentTableBody"><tr><td colspan="6" class="text-center text-muted">No treatments yet</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SoA Tab -->
            <div id="tabSoA" class="tab-content">
                <div class="container-glass">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                        <div>
                            <h2 class="mb-1">Statement of Applicability (SoA)</h2>
                            <div class="text-muted">ISO 27001 Annex A applicability + justification + implementation status.</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="window.app.resetSoA()"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset SoA</button>
                            <button class="btn btn-outline-light btn-sm" onclick="window.app.exportSoA()"><i class="bi bi-download me-1"></i> Export SoA</button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><input id="soaSearch" class="form-control" placeholder="Search ISO controls..." oninput="window.app.renderSoA()"></div>
                        <div class="col-md-6 mt-2 mt-md-0">
                            <select id="soaStatusFilter" class="form-select" onchange="window.app.renderSoA()">
                                <option value="all">All statuses</option>
                                <option value="Implemented">Implemented</option>
                                <option value="Planned">Planned</option>
                                <option value="Not Implemented">Not Implemented</option>
                                <option value="Not Applicable">Not Applicable</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Control</th><th>Applicable</th><th>Justification</th><th>Status</th></tr></thead>
                            <tbody id="soaTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Risk Matrix Tab -->
      <div id="tabMatrix" class="tab-content">
  <div class="container-glass">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <div>
        <h2 class="mb-1">Risk Analytics</h2>
        <div class="text-muted">Industry standard: 5×5 Inherent Likelihood (1–5) × Inherent Impact (1–5). Supports Low/Medium/High too.</div>
      </div>
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <div class="d-flex flex-column">
  <small class="text-muted mb-1">Project Scope</small>
  <select id="riskAnalyticsProjectFilter" class="form-select" style="min-width: 280px;" onchange="window.app.renderRiskAnalytics()">
          <option value="">None (General Risk Analytics)</option>
        </select>
</div>
<div class="d-flex flex-column">
  <small class="text-muted mb-1">Risk View</small>
  <select id="riskAnalyticsViewMode" class="form-select" style="min-width: 220px;" onchange="window.app.renderRiskAnalytics()">
          <option value="inherent">View: Inherent Risk</option>
          <option value="residual">View: Residual Risk</option>
        </select>
</div>
<button class="btn btn-outline-light btn-sm align-self-end" onclick="window.app.renderRiskAnalytics()">
          <i class="bi bi-arrow-repeat me-2"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Top row: Heatmap + Top risks -->
    <div class="row g-3">
      <div class="col-lg-8">
    <div class="card-glass risk-heatmap-white">
          <h4 class="mb-2">Risk Heatmap (5×5)</h4>
          <div class="text-muted mb-3" style="font-size:13px;">Click a cell to view risks in that bucket.</div>
          <div id="heatmap5x5"></div>
          <div class="mt-3">
            <div class="text-muted" style="font-size:13px;">Selected cell:</div>
            <div id="heatmapSelection" class="text-secondary">None</div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card-glass mb-3">
          <h4 class="mb-2">Open vs Closed</h4>
          <canvas id="chartOpenClosed" height="160"></canvas>
        </div>
        <div class="card-glass">
          <h4 class="mb-2">Top Risks</h4>
          <div id="topRisksList" class="text-secondary"></div>
        </div>
      </div>
    </div>

    <!-- Bottom row: Category / Score distribution / Trend -->
    <div class="row g-3 mt-1">
      <div class="col-lg-4">
        <div class="card-glass">
          <h4 class="mb-2">Risks by Category</h4>
          <canvas id="chartByCategory" height="180"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card-glass">
          <h4 class="mb-2">Score Distribution</h4>
          <canvas id="chartScoreDist" height="180"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card-glass">
          <h4 class="mb-2">Trend (Last 30 days)</h4>
          <canvas id="chartTrend" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>


            <!-- Reports Tab -->
            <div id="tabReports" class="tab-content">
                
                
              <div class="card-glass mb-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
    <div>
      <h4 class="mb-1">Report Builder</h4>
      <div class="text-muted" style="font-size:13px;">Generate multiple report sections and export to PDF.</div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-light btn-sm" onclick="window.app.clearReportDraft()">
        <i class="bi bi-trash me-1"></i> Clear
      </button>
      <button class="btn btn-primary btn-sm" onclick="window.app.exportReportPDF()">
        <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
      </button>
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-4">
      <label class="form-label">Report Section</label>
      <select class="form-select" id="reportType">
        <option value="executive">Executive Summary</option>
        <option value="SoA">ISO SoA Status</option>
        <option value="risk">Risk Register Summary</option>
        <option value="treatments">Treatment Plan Summary</option>
      </select>
    </div>

    <div class="col-md-5">
      <label class="form-label">Title (optional)</label>
      <input class="form-control" id="reportTitle" placeholder="e.g., Monthly Security & GRC Report">
    </div>

    <div class="col-md-3 d-flex align-items-end">
<button class="btn btn-primary w-100" onclick="window.app.generateBoardReport()">
  <i class="bi bi-magic me-2"></i> Generate Report
</button>
    </div>

    <div class="col-12">
      <label class="form-label">Report Draft</label>
      <textarea class="form-control" id="reportDraft" rows="14" placeholder="Generated reports will appear here..."></textarea>
      <div class="text-muted mt-2" style="font-size:12px;">
        Educational use only. Do not use this output as a sole basis for production compliance decisions or formal audits.
      </div>
    </div>
  </div>
</div>

            </div>

            <!-- Projects Tab -->
            <div id="tabProjects" class="tab-content">
                <div class="container-glass">
                    <h2>GRC Projects</h2>
                    <p class="lead">Select a company scenario and complete real-world GRC projects. Use existing tabs to complete tasks.</p>
                    <div id="projectList" class="row g-4"></div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="tabPortfolio" class="tab-content">
                <div class="container-glass">
                    <h2>Portfolio Summary Generator</h2>
                    <p class="lead">Generate professional summaries and resume bullet points from your completed projects</p>
                    <div class="mb-4">
                        <button class="btn btn-primary" onclick="window.app.generateAllPortfolios()">
                            <i class="bi bi-magic me-2"></i> Generate All Summaries
                        </button>
                        <button class="btn btn-outline-light ms-2" onclick="window.app.copyAllBullets()">
                            <i class="bi bi-clipboard me-2"></i> Copy All Summaries
                        </button>
                        <button class="btn btn-outline-light ms-2" onclick="window.app.exportPortfolioPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> Export Portfolio PDF
                        </button>
                    </div>
                    <div id="portfolioContent"></div>
                </div>
            </div>


        </div>
    </section>
<section class="py-4">
  <div class="container">
    <div class="container-glass">
      <h4 class="mb-2">Disclaimer</h4>
      <p class="mb-2" style="color: rgba(255,255,255,.72);">
        This site is provided for <strong>educational and demonstration purposes only</strong>. It simulates common GRC workflows (assets, risks, controls,
        vendors, incidents, SoA, and treatments) to help users learn concepts and build a portfolio.
      </p>
      <ul style="color: rgba(255,255,255,.72); margin-bottom: 0;">
        <li>Not an official audit artifact generator; outputs require professional review.</li>
        <li>Framework references (ISO 27001, NIST CSF, PCI DSS, HIPAA, SOC 2, CIS, GDPR, CMMC, COBIT) are included in a summarized/paraphrased form for learning.</li>
        <li>No warranty; use at your own risk. Do not store sensitive or real client data in this demo.</li>
      </ul>
    </div>
  </div>
</section>
<footer class="footer">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div style="font-weight:800; font-size:13px;">
      © 2026 John Bommeraveni Joseph.
    </div>

    <div style="display:flex; gap:14px; flex-wrap:wrap; font-size:12.5px;">
      <a href="terms.html">Terms</a>
            <a href="grc-lab.html">GRC Lab</a>
      <a href="https://www.youtube.com/@GRCMadeSimple" target="_blank" rel="noopener noreferrer">YouTube</a>
      <a href="https://www.linkedin.com/in/john-bj/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
      <a href="https://github.com/Johnbjoseph-cybersec/" target="_blank" rel="noopener noreferrer">GitHub</a>
    </div>
  </div>
</footer>

</div>

<!-- Modals -->
<div class="modal fade" id="riskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Risk Management</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="riskModalBody"></div>
</div></div></div>

<div class="modal fade" id="assetModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Asset Management</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="assetModalBody"></div>
</div></div></div>

<div class="modal fade" id="vendorModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Vendor Management</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="vendorModalBody"></div>
</div></div></div>

<div class="modal fade" id="controlModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Control Management</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="controlModalBody"></div>
</div></div></div>

<div class="modal fade" id="issueModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Issue Management</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="issueModalBody"></div>
</div></div></div>

<div class="modal fade" id="incidentModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Incident Management</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="incidentModalBody"></div>
</div></div></div>


<div class="modal fade" id="treatmentModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Risk Treatment</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="treatmentModalBody"></div>
</div></div></div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert">
        <div class="toast-body bg-dark border border-light d-flex align-items-center">
            <span id="toastMessage"></span>
            <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>


<script>
// FRAMEWORK CONTROLS DATA - Condensed version with key controls from each framework
const FRAMEWORK_CONTROLS = [
    // ISO 27001:2022 (93 controls)
    {id:"ISO-5.1",name:"Security policies",category:"Policy & Governance",description:"Define, approve, communicate, and periodically review this policy to guide information security.",frameworks:["ISO 27001"]},
    {id:"ISO-5.2",name:"Info security roles",category:"Policy & Governance",description:"Implement and maintain measures for info security roles to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.3",name:"Segregation of duties",category:"Policy & Governance",description:"Implement and maintain measures for segregation of duties to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.4",name:"Management responsibilities",category:"Policy & Governance",description:"Implement and maintain measures for management responsibilities to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.5",name:"Authority contacts",category:"Compliance",description:"Implement and maintain measures for authority contacts to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.6",name:"Special interest contacts",category:"Compliance",description:"Implement and maintain measures for special interest contacts to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.7",name:"Threat intel",category:"Risk Management",description:"Implement and maintain measures for threat intel to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.8",name:"Project security",category:"Policy & Governance",description:"Implement and maintain measures for project security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.9",name:"Asset inventory",category:"Asset Management",description:"Maintain an accurate, up-to-date inventory including ownership, classification, and lifecycle status.",frameworks:["ISO 27001"]},
    {id:"ISO-5.10",name:"Acceptable use",category:"Asset Management",description:"Implement and maintain measures for acceptable use to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.11",name:"Asset return",category:"Asset Management",description:"Implement and maintain measures for asset return to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.12",name:"Information classification",category:"Data Protection",description:"Implement and maintain measures for information classification to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.13",name:"Information labeling",category:"Data Protection",description:"Implement and maintain measures for information labeling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.14",name:"Information transfer",category:"Data Protection",description:"Implement and maintain measures for information transfer to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.15",name:"Access control rules",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-5.16",name:"Identity lifecycle",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-5.17",name:"Authentication info handling",category:"Access Control",description:"Implement and maintain measures for authentication info handling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.18",name:"Access rights",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-5.19",name:"Supplier security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
    {id:"ISO-5.20",name:"Supplier security requirements",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
    {id:"ISO-5.21",name:"Supplier agreements security",category:"Vendor Management",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
    {id:"ISO-5.22",name:"Supplier service monitoring",category:"Vendor Management",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
    {id:"ISO-5.23",name:"Cloud services security",category:"Cloud Security",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
    {id:"ISO-5.24",name:"Incident planning & readiness",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
    {id:"ISO-5.25",name:"Incident assessment & decision",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
    {id:"ISO-5.26",name:"Incident response & communication",category:"Incident Management",description:"Plan, prepare, and operate an incident management capability with roles, escalation, and lessons learned.",frameworks:["ISO 27001"]},
    {id:"ISO-5.27",name:"Lessons learned",category:"Incident Management",description:"Implement and maintain measures for lessons learned to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.28",name:"Evidence handling",category:"Incident Management",description:"Implement and maintain measures for evidence handling to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.29",name:"Security during disruption",category:"Business Continuity",description:"Implement and maintain measures for security during disruption to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.30",name:"ICT continuity readiness",category:"Business Continuity",description:"Plan, implement, and test continuity arrangements to meet recovery objectives during disruption.",frameworks:["ISO 27001"]},
    {id:"ISO-5.31",name:"Legal/regulatory/contract",category:"Compliance",description:"Implement and maintain measures for legal/regulatory/contract to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.32",name:"Intellectual property",category:"Compliance",description:"Implement and maintain measures for intellectual property to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.33",name:"Records protection",category:"Compliance",description:"Implement and maintain measures for records protection to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.34",name:"Privacy & personal data",category:"Privacy",description:"Identify privacy/PII requirements and implement measures to protect personal data appropriately.",frameworks:["ISO 27001"]},
    {id:"ISO-5.35",name:"Independent security review",category:"Audit & Assurance",description:"Implement and maintain measures for independent security review to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-5.36",name:"Compliance with policies/standards",category:"Audit & Assurance",description:"Define, approve, communicate, and periodically review this policy to guide information security.",frameworks:["ISO 27001"]},
    {id:"ISO-5.37",name:"Documented operating procedures",category:"Policy & Governance",description:"Implement and maintain measures for documented operating procedures to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-6.1",name:"Screening checks",category:"Human Resources",description:"Implement and maintain measures for screening checks to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-6.2",name:"Terms & conditions",category:"Human Resources",description:"Implement and maintain measures for terms & conditions to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-6.3",name:"Awareness and training",category:"Training & Awareness",description:"Provide role-based awareness and training to ensure personnel understand responsibilities and threats.",frameworks:["ISO 27001"]},
    {id:"ISO-6.4",name:"Disciplinary process",category:"Human Resources",description:"Implement and maintain measures for disciplinary process to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-6.5",name:"Responsibilities after termination/change",category:"Human Resources",description:"Control changes through authorization, testing, documentation, and rollback where appropriate.",frameworks:["ISO 27001"]},
    {id:"ISO-6.6",name:"Confidentiality/NDA",category:"Human Resources",description:"Implement and maintain measures for confidentiality/nda to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-6.7",name:"Remote working security",category:"Remote Work",description:"Implement and maintain measures for remote working security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-6.8",name:"Event reporting",category:"Incident Management",description:"Implement and maintain measures for event reporting to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-7.1",name:"Physical security perimeters",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.2",name:"Physical entry controls",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.3",name:"Securing offices/rooms",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.4",name:"Physical monitoring",category:"Physical Security",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
    {id:"ISO-7.5",name:"Protection against physical/environmental threats",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.6",name:"Working in secure areas",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.7",name:"Clear desk / clear screen",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.8",name:"Equipment siting & protection",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.9",name:"Off-premises asset security",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.10",name:"Storage media",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.11",name:"Supporting utilities",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.12",name:"Cabling security",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.13",name:"Equipment maintenance",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-7.14",name:"Secure disposal / reuse",category:"Physical Security",description:"Implement physical safeguards to prevent unauthorized access, damage, or interference.",frameworks:["ISO 27001"]},
    {id:"ISO-8.1",name:"Endpoint devices",category:"Endpoint Security",description:"Implement and maintain measures for endpoint devices to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.2",name:"Privileged access",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-8.3",name:"Information access restrictions",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-8.4",name:"Source code access",category:"Access Control",description:"Establish rules and procedures to ensure only authorized identities have appropriate access throughout the lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-8.5",name:"Secure authentication",category:"Access Control",description:"Implement and maintain measures for secure authentication to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.6",name:"Capacity management",category:"Capacity & Availability",description:"Implement and maintain measures for capacity management to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.7",name:"Malware protection",category:"Malware Protection",description:"Deploy preventive and detective measures to reduce malware infection and impact.",frameworks:["ISO 27001"]},
    {id:"ISO-8.8",name:"Vulnerability management",category:"Vulnerability Management",description:"Identify, assess, prioritize, and remediate technical vulnerabilities within defined timelines.",frameworks:["ISO 27001"]},
    {id:"ISO-8.9",name:"Configuration management",category:"Configuration Management",description:"Define secure configuration baselines and manage changes to reduce unintended exposure and drift.",frameworks:["ISO 27001"]},
    {id:"ISO-8.10",name:"Information deletion",category:"Data Protection",description:"Ensure information and media are securely deleted/disposed to prevent unauthorized recovery.",frameworks:["ISO 27001"]},
    {id:"ISO-8.11",name:"Data masking",category:"Data Protection",description:"Implement and maintain measures for data masking to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.12",name:"Data leakage prevention",category:"Data Protection",description:"Implement and maintain measures for data leakage prevention to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.13",name:"Backups",category:"Backup & Recovery",description:"Perform backups at defined intervals, protect backup media, and regularly test restoration.",frameworks:["ISO 27001"]},
    {id:"ISO-8.14",name:"Redundancy",category:"Capacity & Availability",description:"Implement and maintain measures for redundancy to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.15",name:"Logging",category:"Logging & Monitoring",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
    {id:"ISO-8.16",name:"Monitoring",category:"Logging & Monitoring",description:"Collect, protect, and review logs/monitoring data to detect and investigate security events.",frameworks:["ISO 27001"]},
    {id:"ISO-8.17",name:"Clock synchronization",category:"Logging & Monitoring",description:"Implement and maintain measures for clock synchronization to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.18",name:"Admin utilities",category:"Operations",description:"Implement and maintain measures for admin utilities to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.19",name:"Software installation controls",category:"Operations",description:"Implement and maintain measures for software installation controls to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.20",name:"Network security",category:"Network Security",description:"Implement and maintain measures for network security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.21",name:"Network services security",category:"Network Security",description:"Implement and maintain measures for network services security to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.22",name:"Network segmentation",category:"Network Security",description:"Implement and maintain measures for network segmentation to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.23",name:"Web filtering",category:"Network Security",description:"Implement and maintain measures for web filtering to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.24",name:"Cryptography use",category:"Cryptography",description:"Use cryptography appropriately and manage keys securely throughout their lifecycle.",frameworks:["ISO 27001"]},
    {id:"ISO-8.25",name:"Secure development lifecycle",category:"Secure Development",description:"Integrate security into the SDLC, including requirements, design, coding, testing, and release controls.",frameworks:["ISO 27001"]},
    {id:"ISO-8.26",name:"Application security requirements",category:"Secure Development",description:"Implement and maintain measures for application security requirements to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.27",name:"Secure system architecture",category:"Secure Development",description:"Implement and maintain measures for secure system architecture to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.28",name:"Secure coding",category:"Secure Development",description:"Implement and maintain measures for secure coding to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.29",name:"Security testing in development",category:"Secure Development",description:"Implement and maintain measures for security testing in development to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.30",name:"Outsourced development controls",category:"Secure Development",description:"Define and manage security requirements for suppliers/services, including assurance, monitoring, and exit.",frameworks:["ISO 27001"]},
    {id:"ISO-8.31",name:"Separation of dev/test/prod",category:"Secure Development",description:"Implement and maintain measures for separation of dev/test/prod to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.32",name:"Change management",category:"Secure Development",description:"Control changes through authorization, testing, documentation, and rollback where appropriate.",frameworks:["ISO 27001"]},
    {id:"ISO-8.33",name:"Test data protection",category:"Secure Development",description:"Implement and maintain measures for test data protection to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},
    {id:"ISO-8.34",name:"Protection of info systems during audits",category:"Audit & Assurance",description:"Implement and maintain measures for protection of info systems during audits to protect confidentiality, integrity, and availability.",frameworks:["ISO 27001"]},

// NIST CSF 2.0 (60 controls - showing 20 key ones)
    {id:"NIST-ID.AM-01",name:"Physical devices inventory",category:"Asset Management",description:"Inventories of physical devices maintained.",frameworks:["NIST CSF"]},
    {id:"NIST-ID.AM-02",name:"Software inventory",category:"Asset Management",description:"Inventories of software platforms maintained.",frameworks:["NIST CSF"]},
    {id:"NIST-ID.GV-01",name:"Cybersecurity policy",category:"Policy & Governance",description:"Organizational cybersecurity policy established.",frameworks:["NIST CSF"]},
    {id:"NIST-ID.RA-01",name:"Asset vulnerabilities",category:"Risk Assessment",description:"Asset vulnerabilities identified and documented.",frameworks:["NIST CSF"]},
    {id:"NIST-ID.RA-02",name:"Cyber threat intelligence",category:"Intelligence & Monitoring",description:"Cyber threat intelligence received from sharing forums.",frameworks:["NIST CSF"]},
    {id:"NIST-ID.RM-01",name:"Risk management processes",category:"Risk Management",description:"Risk management processes established and managed.",frameworks:["NIST CSF"]},
    {id:"NIST-ID.SC-01",name:"Supply chain risk management",category:"Supply Chain Security",description:"Cyber supply chain risk processes established.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.AC-01",name:"Identity management",category:"Access Control",description:"Identities and credentials managed for authorized access.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.AT-01",name:"Security awareness",category:"Training & Awareness",description:"All users informed and trained on cybersecurity responsibilities.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.DS-01",name:"Data-at-rest protection",category:"Data Protection",description:"Data-at-rest is protected.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.DS-02",name:"Data-in-transit protection",category:"Data Protection",description:"Data-in-transit is protected.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.IP-01",name:"Baseline configuration",category:"Configuration Management",description:"Baseline configuration of IT systems created and maintained.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.IP-04",name:"Backups maintained",category:"Backup & Recovery",description:"Backups of information conducted and tested.",frameworks:["NIST CSF"]},
    {id:"NIST-PR.PT-01",name:"Audit records",category:"Logging & Monitoring",description:"Audit/log records determined and reviewed.",frameworks:["NIST CSF"]},
    {id:"NIST-DE.CM-01",name:"Network monitoring",category:"Continuous Monitoring",description:"Network monitored to detect cybersecurity events.",frameworks:["NIST CSF"]},
    {id:"NIST-DE.CM-04",name:"Malicious code detection",category:"Malware Protection",description:"Malicious code is detected.",frameworks:["NIST CSF"]},
    {id:"NIST-RS.RP-01",name:"Response plan execution",category:"Incident Management",description:"Response plan executed during incidents.",frameworks:["NIST CSF"]},
    {id:"NIST-RS.MI-01",name:"Incident containment",category:"Incident Management",description:"Incidents are contained.",frameworks:["NIST CSF"]},
    {id:"NIST-RC.RP-01",name:"Recovery plan execution",category:"Business Continuity",description:"Recovery plan executed after incidents.",frameworks:["NIST CSF"]},
    {id:"NIST-RC.IM-01",name:"Recovery improvements",category:"Business Continuity",description:"Recovery plans incorporate lessons learned.",frameworks:["NIST CSF"]},
    
    // PCI DSS v4.0 (50 controls - showing 20 key ones)
    {id:"PCI-1.1.1",name:"Firewall standards",category:"Network Security",description:"Formal standards for firewall and router configurations.",frameworks:["PCI DSS"]},
    {id:"PCI-1.2.1",name:"Configuration standards",category:"Network Security",description:"Configuration standards for network security controls.",frameworks:["PCI DSS"]},
    {id:"PCI-2.2.1",name:"System configuration standards",category:"Configuration Management",description:"Configuration standards for all system components.",frameworks:["PCI DSS"]},
    {id:"PCI-2.2.2",name:"Vendor defaults management",category:"Access Control",description:"Vendor default accounts managed before deployment.",frameworks:["PCI DSS"]},
    {id:"PCI-3.2.1",name:"Account data minimization",category:"Data Protection",description:"Account data storage kept to minimum.",frameworks:["PCI DSS"]},
    {id:"PCI-3.3.1",name:"PAN masking",category:"Data Protection",description:"PAN masked when displayed.",frameworks:["PCI DSS"]},
    {id:"PCI-3.4.1",name:"Cryptographic keys storage",category:"Cryptography",description:"Cryptographic keys stored securely.",frameworks:["PCI DSS"]},
    {id:"PCI-4.2.1",name:"Strong cryptography",category:"Cryptography",description:"Strong cryptography for PAN transmission.",frameworks:["PCI DSS"]},
    {id:"PCI-5.2.1",name:"Anti-malware deployed",category:"Malware Protection",description:"Anti-malware mechanisms deployed.",frameworks:["PCI DSS"]},
    {id:"PCI-5.2.2",name:"Phishing protection",category:"Malware Protection",description:"Technical mechanisms protect against phishing.",frameworks:["PCI DSS"]},
    {id:"PCI-6.3.1",name:"Inventory of system components",category:"Asset Management",description:"Inventory of in-scope system components maintained.",frameworks:["PCI DSS"]},
    {id:"PCI-6.4.1",name:"Public-facing applications",category:"Secure Development",description:"Public-facing web applications protected.",frameworks:["PCI DSS"]},
    {id:"PCI-7.2.1",name:"User access management",category:"Access Control",description:"User access to system components managed.",frameworks:["PCI DSS"]},
    {id:"PCI-8.2.1",name:"Unique user IDs",category:"Access Control",description:"Unique user IDs assigned to each user.",frameworks:["PCI DSS"]},
    {id:"PCI-8.3.1",name:"Multi-factor authentication",category:"Access Control",description:"MFA for remote network access.",frameworks:["PCI DSS"]},
    {id:"PCI-9.1.1",name:"Physical access controls",category:"Physical Security",description:"Physical access to cardholder data controlled.",frameworks:["PCI DSS"]},
    {id:"PCI-10.2.1",name:"Audit trails",category:"Logging & Monitoring",description:"Audit trails implemented to track user activities.",frameworks:["PCI DSS"]},
    {id:"PCI-11.3.1",name:"External penetration testing",category:"Security Testing",description:"External penetration testing performed.",frameworks:["PCI DSS"]},
    {id:"PCI-12.1.1",name:"Security policy",category:"Policy & Governance",description:"Overall information security policy established.",frameworks:["PCI DSS"]},
    {id:"PCI-12.6.1",name:"Security awareness program",category:"Training & Awareness",description:"Formal security awareness program implemented.",frameworks:["PCI DSS"]},
    
    // HIPAA (30 controls - showing 15 key ones)
    {id:"HIPAA-164.308(a)(1)(i)",name:"Security management",category:"Policy & Governance",description:"Policies to prevent, detect and correct security violations.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(1)(ii)(A)",name:"Risk analysis",category:"Risk Assessment",description:"Assess potential risks to ePHI confidentiality, integrity, availability.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(1)(ii)(B)",name:"Risk management",category:"Risk Management",description:"Implement measures to reduce risks to reasonable level.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(3)(i)",name:"Workforce security",category:"Human Resources",description:"Ensure workforce has appropriate access to ePHI.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(4)(i)",name:"Access management",category:"Access Control",description:"Policies for authorizing access to ePHI.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(5)(i)",name:"Security awareness",category:"Training & Awareness",description:"Security awareness and training program for workforce.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(6)(i)",name:"Security incidents",category:"Incident Management",description:"Policies to address security incidents.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.308(a)(7)(i)",name:"Contingency plan",category:"Business Continuity",description:"Policies for responding to emergencies.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.310(a)(1)",name:"Facility access controls",category:"Physical Security",description:"Limit physical access to systems with ePHI.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.310(d)(1)",name:"Device controls",category:"Physical Security",description:"Govern receipt and removal of hardware/media.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.312(a)(1)",name:"Access control",category:"Access Control",description:"Allow access only to authorized persons/software.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.312(a)(2)(iv)",name:"Encryption",category:"Cryptography",description:"Mechanism to encrypt and decrypt ePHI.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.312(b)",name:"Audit controls",category:"Logging & Monitoring",description:"Record and examine activity in systems with ePHI.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.312(d)",name:"Person authentication",category:"Access Control",description:"Verify person seeking access is the one claimed.",frameworks:["HIPAA"]},
    {id:"HIPAA-164.312(e)(1)",name:"Transmission security",category:"Network Security",description:"Guard against unauthorized access to ePHI in transit.",frameworks:["HIPAA"]},
    
    // SOC 2 (50 controls - showing 20 key ones)
    {id:"SOC2-CC1.1",name:"Integrity and ethics",category:"Policy & Governance",description:"Demonstrates commitment to integrity and ethical values.",frameworks:["SOC 2"]},
    {id:"SOC2-CC1.2",name:"Board oversight",category:"Policy & Governance",description:"Board exercises oversight of internal control.",frameworks:["SOC 2"]},
    {id:"SOC2-CC2.1",name:"Risk assessment objectives",category:"Risk Assessment",description:"Objectives specified with sufficient clarity.",frameworks:["SOC 2"]},
    {id:"SOC2-CC2.2",name:"Risk identification",category:"Risk Assessment",description:"Identifies and analyzes risks across entity.",frameworks:["SOC 2"]},
    {id:"SOC2-CC3.1",name:"Policies and procedures",category:"Policy & Governance",description:"Establishes policies and procedures.",frameworks:["SOC 2"]},
    {id:"SOC2-CC4.1",name:"Monitoring activities",category:"Logging & Monitoring",description:"Performs ongoing evaluations of internal control.",frameworks:["SOC 2"]},
    {id:"SOC2-CC5.1",name:"Control activities",category:"Policy & Governance",description:"Selects control activities to mitigate risks.",frameworks:["SOC 2"]},
    {id:"SOC2-CC6.1",name:"Logical and physical access",category:"Access Control",description:"Implements access controls to protect data.",frameworks:["SOC 2"]},
    {id:"SOC2-CC6.2",name:"User registration",category:"Access Control",description:"Registers and authorizes new users.",frameworks:["SOC 2"]},
    {id:"SOC2-CC6.6",name:"Data classification",category:"Data Protection",description:"Implements logical access security measures.",frameworks:["SOC 2"]},
    {id:"SOC2-CC7.1",name:"System operations",category:"Operations",description:"Uses detection and monitoring procedures.",frameworks:["SOC 2"]},
    {id:"SOC2-CC7.2",name:"Incident response",category:"Incident Management",description:"Monitors system components for anomalies.",frameworks:["SOC 2"]},
    {id:"SOC2-CC8.1",name:"Change management",category:"Change Management",description:"Authorizes, tests and implements changes.",frameworks:["SOC 2"]},
    {id:"SOC2-CC9.1",name:"Risk mitigation",category:"Risk Management",description:"Identifies and develops risk mitigation activities.",frameworks:["SOC 2"]},
    {id:"SOC2-A1.1",name:"Availability commitments",category:"Business Continuity",description:"Maintains and monitors processing capacity.",frameworks:["SOC 2"]},
    {id:"SOC2-C1.1",name:"Confidentiality commitments",category:"Data Protection",description:"Identifies and maintains confidential information.",frameworks:["SOC 2"]},
    {id:"SOC2-PI1.1",name:"Processing integrity",category:"Data Protection",description:"Obtains and uses quality information for processing.",frameworks:["SOC 2"]},
    {id:"SOC2-P1.1",name:"Privacy notice",category:"Privacy",description:"Provides notice about privacy practices.",frameworks:["SOC 2"]},
    {id:"SOC2-P2.1",name:"Choice and consent",category:"Privacy",description:"Communicates choices about personal information.",frameworks:["SOC 2"]},
    {id:"SOC2-P4.1",name:"Access to personal info",category:"Privacy",description:"Grants data subjects access to their information.",frameworks:["SOC 2"]},
    
    // CIS Controls v8 (50 controls - showing 20 key ones)
    {id:"CIS-1.1",name:"Enterprise asset inventory",category:"Asset Management",description:"Maintain accurate inventory of enterprise assets.",frameworks:["CIS Controls"]},
    {id:"CIS-2.1",name:"Software inventory",category:"Asset Management",description:"Maintain detailed inventory of authorized software.",frameworks:["CIS Controls"]},
    {id:"CIS-3.1",name:"Data management",category:"Data Protection",description:"Establish data management process.",frameworks:["CIS Controls"]},
    {id:"CIS-3.3",name:"Data access control",category:"Access Control",description:"Configure data access control lists.",frameworks:["CIS Controls"]},
    {id:"CIS-3.10",name:"Encrypt data in transit",category:"Cryptography",description:"Encrypt sensitive data in transit.",frameworks:["CIS Controls"]},
    {id:"CIS-3.11",name:"Encrypt data at rest",category:"Cryptography",description:"Encrypt sensitive data at rest.",frameworks:["CIS Controls"]},
    {id:"CIS-4.1",name:"Secure configuration",category:"Configuration Management",description:"Establish secure configuration process.",frameworks:["CIS Controls"]},
    {id:"CIS-5.1",name:"Account inventory",category:"Access Control",description:"Maintain inventory of accounts.",frameworks:["CIS Controls"]},
    {id:"CIS-5.3",name:"Disable dormant accounts",category:"Access Control",description:"Delete or disable dormant accounts.",frameworks:["CIS Controls"]},
    {id:"CIS-5.4",name:"Restrict admin privileges",category:"Access Control",description:"Restrict administrator privileges.",frameworks:["CIS Controls"]},
    {id:"CIS-6.1",name:"Access granting process",category:"Access Control",description:"Establish access granting process.",frameworks:["CIS Controls"]},
    {id:"CIS-6.3",name:"MFA for external apps",category:"Access Control",description:"Require MFA for externally-exposed applications.",frameworks:["CIS Controls"]},
    {id:"CIS-6.4",name:"MFA for remote access",category:"Access Control",description:"Require MFA for remote network access.",frameworks:["CIS Controls"]},
    {id:"CIS-7.1",name:"Vulnerability management",category:"Vulnerability Management",description:"Establish vulnerability management process.",frameworks:["CIS Controls"]},
    {id:"CIS-7.3",name:"Automated OS patching",category:"Vulnerability Management",description:"Perform automated OS patch management.",frameworks:["CIS Controls"]},
    {id:"CIS-7.4",name:"Automated app patching",category:"Vulnerability Management",description:"Perform automated application patching.",frameworks:["CIS Controls"]},
    {id:"CIS-8.1",name:"Audit log management",category:"Logging & Monitoring",description:"Establish audit log management process.",frameworks:["CIS Controls"]},
    {id:"CIS-10.1",name:"Malware defenses",category:"Malware Protection",description:"Deploy and maintain anti-malware software.",frameworks:["CIS Controls"]},
    {id:"CIS-11.1",name:"Data recovery capability",category:"Backup & Recovery",description:"Establish data recovery processes.",frameworks:["CIS Controls"]},
    {id:"CIS-16.1",name:"Application software security",category:"Secure Development",description:"Establish secure application development.",frameworks:["CIS Controls"]},
    
    // GDPR (40 controls - showing 15 key ones)
    {id:"GDPR-5",name:"Processing principles",category:"Privacy",description:"Personal data processed lawfully, fairly, transparently.",frameworks:["GDPR"]},
    {id:"GDPR-6",name:"Lawfulness of processing",category:"Privacy",description:"Processing lawful only with legal basis.",frameworks:["GDPR"]},
    {id:"GDPR-7",name:"Conditions for consent",category:"Privacy",description:"Demonstrate data subject consented to processing.",frameworks:["GDPR"]},
    {id:"GDPR-15",name:"Right of access",category:"Privacy",description:"Data subject has right to access their data.",frameworks:["GDPR"]},
    {id:"GDPR-17",name:"Right to erasure",category:"Privacy",description:"Data subject has right to erasure (right to be forgotten).",frameworks:["GDPR"]},
    {id:"GDPR-25",name:"Data protection by design",category:"Privacy",description:"Implement data protection by design and default.",frameworks:["GDPR"]},
    {id:"GDPR-30",name:"Records of processing",category:"Compliance",description:"Maintain record of processing activities.",frameworks:["GDPR"]},
    {id:"GDPR-32",name:"Security of processing",category:"Data Protection",description:"Implement appropriate technical and organizational measures.",frameworks:["GDPR"]},
    {id:"GDPR-33",name:"Breach notification",category:"Incident Management",description:"Notify supervisory authority of breach within 72 hours.",frameworks:["GDPR"]},
    {id:"GDPR-34",name:"Breach communication",category:"Incident Management",description:"Communicate breach to data subject when high risk.",frameworks:["GDPR"]},
    {id:"GDPR-35",name:"Data protection impact assessment",category:"Privacy",description:"Carry out DPIA for high-risk processing.",frameworks:["GDPR"]},
    {id:"GDPR-37",name:"Data protection officer",category:"Policy & Governance",description:"Designate data protection officer when required.",frameworks:["GDPR"]},
    {id:"GDPR-44",name:"General principle for transfers",category:"Privacy",description:"Transfer personal data only if conditions met.",frameworks:["GDPR"]},
    {id:"GDPR-46",name:"Appropriate safeguards",category:"Privacy",description:"Provide appropriate safeguards for transfers.",frameworks:["GDPR"]},
    {id:"GDPR-58",name:"Penalties",category:"Compliance",description:"Administrative fines up to 4% of annual turnover.",frameworks:["GDPR"]},
    
    // CMMC 2.0 (40 controls - showing 15 key ones)
    {id:"CMMC-AC.L1-3.1.1",name:"Limit system access",category:"Access Control",description:"Limit system access to authorized users.",frameworks:["CMMC"]},
    {id:"CMMC-AC.L2-3.1.5",name:"Least privilege",category:"Access Control",description:"Employ principle of least privilege.",frameworks:["CMMC"]},
    {id:"CMMC-AC.L2-3.1.12",name:"Remote access",category:"Access Control",description:"Monitor and control remote access sessions.",frameworks:["CMMC"]},
    {id:"CMMC-AC.L2-3.1.13",name:"Cryptographic protection",category:"Cryptography",description:"Employ cryptography for remote access.",frameworks:["CMMC"]},
    {id:"CMMC-AT.L2-3.2.1",name:"Security awareness",category:"Training & Awareness",description:"Ensure managers and users are aware of security risks.",frameworks:["CMMC"]},
    {id:"CMMC-AU.L2-3.3.1",name:"System audit logs",category:"Logging & Monitoring",description:"Create and retain system audit records.",frameworks:["CMMC"]},
    {id:"CMMC-AU.L2-3.3.2",name:"User accountability",category:"Logging & Monitoring",description:"Ensure actions can be traced to users.",frameworks:["CMMC"]},
    {id:"CMMC-CA.L2-3.12.1",name:"Security control assessment",category:"Compliance",description:"Periodically assess security controls.",frameworks:["CMMC"]},
    {id:"CMMC-CM.L2-3.4.1",name:"Baseline configurations",category:"Configuration Management",description:"Establish and maintain baseline configurations.",frameworks:["CMMC"]},
    {id:"CMMC-CM.L2-3.4.2",name:"Security configuration",category:"Configuration Management",description:"Establish security configuration settings.",frameworks:["CMMC"]},
    {id:"CMMC-IA.L2-3.5.1",name:"User identification",category:"Access Control",description:"Identify system users and processes.",frameworks:["CMMC"]},
    {id:"CMMC-IA.L2-3.5.2",name:"User authentication",category:"Access Control",description:"Authenticate users and processes.",frameworks:["CMMC"]},
    {id:"CMMC-IR.L2-3.6.1",name:"Incident response",category:"Incident Management",description:"Establish incident handling capability.",frameworks:["CMMC"]},
    {id:"CMMC-MA.L2-3.7.1",name:"System maintenance",category:"Operations",description:"Perform maintenance on systems.",frameworks:["CMMC"]},
    {id:"CMMC-SC.L2-3.13.1",name:"Boundary protection",category:"Network Security",description:"Monitor and control communications at boundaries.",frameworks:["CMMC"]},
    
    // COBIT 2019 (40 controls - showing 15 key ones)
    {id:"COBIT-APO01.01",name:"Strategic IT plan",category:"Policy & Governance",description:"Maintain strategic IT plan.",frameworks:["COBIT"]},
    {id:"COBIT-APO12.01",name:"Risk data collection",category:"Risk Management",description:"Collect data to identify IT-related risk.",frameworks:["COBIT"]},
    {id:"COBIT-APO12.02",name:"Risk analysis",category:"Risk Assessment",description:"Analyze identified risk and impact.",frameworks:["COBIT"]},
    {id:"COBIT-APO12.03",name:"Risk profile",category:"Risk Management",description:"Maintain comprehensive risk profile.",frameworks:["COBIT"]},
    {id:"COBIT-APO13.01",name:"ISMS establishment",category:"Policy & Governance",description:"Establish and maintain ISMS.",frameworks:["COBIT"]},
    {id:"COBIT-BAI03.01",name:"Solution design",category:"Secure Development",description:"Design solutions to meet requirements.",frameworks:["COBIT"]},
    {id:"COBIT-BAI06.01",name:"Change evaluation",category:"Change Management",description:"Evaluate and authorize change requests.",frameworks:["COBIT"]},
    {id:"COBIT-DSS05.01",name:"Malware protection",category:"Malware Protection",description:"Protect information systems from malware.",frameworks:["COBIT"]},
    {id:"COBIT-DSS05.02",name:"Network security",category:"Network Security",description:"Maintain network security mechanisms.",frameworks:["COBIT"]},
    {id:"COBIT-DSS05.04",name:"User access management",category:"Access Control",description:"Manage user identity and logical access.",frameworks:["COBIT"]},
    {id:"COBIT-DSS05.05",name:"Physical access",category:"Physical Security",description:"Manage physical access to IT assets.",frameworks:["COBIT"]},
    {id:"COBIT-DSS05.07",name:"Security monitoring",category:"Logging & Monitoring",description:"Monitor infrastructure for security events.",frameworks:["COBIT"]},
    {id:"COBIT-DSS06.01",name:"Business continuity",category:"Business Continuity",description:"Establish business continuity policy.",frameworks:["COBIT"]},
    {id:"COBIT-MEA03.01",name:"External compliance",category:"Compliance",description:"Identify external compliance requirements.",frameworks:["COBIT"]},
    {id:"COBIT-MEA03.03",name:"Compliance confirmation",category:"Compliance",description:"Confirm compliance with requirements.",frameworks:["COBIT"]},
];

function safeHideModal(modalId) {
    try {
        const el = document.getElementById(modalId);
        if (!el) return;
        const modalInstance = bootstrap.Modal.getInstance(el);
        if (modalInstance) modalInstance.hide();
        else new bootstrap.Modal(el).hide();
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 300);
    } catch(e) { console.error("Modal hide error:", e); }
}

function resetLabData() {
    if (!confirm("Reset Lab will clear all data. Continue?")) return;
    localStorage.clear();
    window.location.reload();
}

class GRCApplication {
    constructor() {
        this.version = '2.5.0';
        this.storagePrefix = 'grc_lab_v2_';
        this.currentTab = 'dashboard';
        this.currentProjectId = null; // Track current project for auto-assignment
        this.data = this.initializeData();
        this.frameworks = this.initializeFrameworks();
        this.init();
    }

    initializeData() {
        return {
            assets: this.loadData('assets') || [],
            vendors: this.loadData('vendors') || [],
            risks: this.loadData('risks') || [],
            controls: this.loadData('controls') || [],
            issues: this.loadData('issues') || [],
            incidents: this.loadData('incidents') || [],
            treatments: this.loadData('treatments') || [],
            SoA: this.loadData('SoA') || [],
            projects: this.loadData('projects') || [],
            portfolioSummaries: this.loadData('portfolioSummaries') || {}
        };
    }

    initializeFrameworks() {
        const map = {
            iso:   { name: 'ISO 27001', controls: [] },
            nist:  { name: 'NIST CSF', controls: [] },
            pci:   { name: 'PCI DSS', controls: [] },
            hipaa: { name: 'HIPAA', controls: [] },
            soc2:  { name: 'SOC 2', controls: [] },
            cis:   { name: 'CIS Controls', controls: [] },
            gdpr:  { name: 'GDPR', controls: [] },
            cmmc:  { name: 'CMMC', controls: [] },
            cobit: { name: 'COBIT', controls: [] }
        };

        const normalize = s => String(s || '').toLowerCase();
        for (const c of FRAMEWORK_CONTROLS) {
            const fws = Array.isArray(c.frameworks) ? c.frameworks : [c.frameworks];
            const entry = {...c, frameworks: fws};
            
            for (const [key, fw] of Object.entries(map)) {
                if (fws.some(f => normalize(f).includes(normalize(fw.name).split(' ')[0]))) {
                    fw.controls.push(entry);
                }
            }
        }
        return map;
    }

    init() {
        this.setupSearchHandlers();
        this.renderDashboard();
        this.showToast('GRC Lab loaded - 400+ controls ready', 'success');
    }

    setupSearchHandlers() {
        ['risk', 'asset', 'vendor', 'control', 'issue', 'incident', 'framework'].forEach(type => {
            const input = document.getElementById(type + 'Search');
            if (input) {
                input.addEventListener('input', () => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => this.renderTabContent(this.currentTab), 300);
                });
            }
        });
    }

    loadData(key) {
        try {
            const data = localStorage.getItem(this.storagePrefix + key);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('Load error:', e);
            return null;
        }
    }

    saveData(key, data) {
        try {
            localStorage.setItem(this.storagePrefix + key, JSON.stringify(data));
            this.data[key] = data;
            return true;
        } catch (e) {
            this.showToast('Error saving data', 'error');
            return false;
        }
    }

    switchTab(tabName) {
        this.currentTab = tabName;
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        const tabElement = document.getElementById('tab' + this.capitalize(tabName));
        if (tabElement) tabElement.classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('onclick')?.includes(`switchTab('${tabName}')`)) {
                btn.classList.add('active');
            }
        });
        this.renderTabContent(tabName);
        
        // Refresh projects when switching back to see updated progress
        if (tabName === 'projects') {
            this.renderProjects();
        }
    }

    renderTabContent(tabName) {
        const methods = {
            dashboard: 'renderDashboard',
            frameworks: 'renderFrameworks',
            assets: 'renderAssets',
            vendors: 'renderVendors',
            risks: 'renderRisks',
            controls: 'renderControls',
            issues: 'renderIssues',
            incidents: 'renderIncidents',
            treatments: 'renderTreatments',
            SoA: 'renderSoA',
            matrix: 'renderRiskAnalytics',
            reports: 'renderReports',
            projects: 'renderProjects',
            portfolio: 'renderPortfolio'
        };
        if (methods[tabName] && this[methods[tabName]]) {
            this[methods[tabName]]();
        }
    }

    capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }
    escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    renderDashboard() {
        document.getElementById('metricAssets').textContent = this.data.assets.length;
        document.getElementById('metricRisks').textContent = this.data.risks.length;
        document.getElementById('metricControls').textContent = this.data.controls.length;
        
        const total = this.data.controls.length;
        const impl = this.data.controls.filter(c => c.status === 'Implemented').length;
        const coverage = total > 0 ? Math.round((impl / total) * 100) : 0;
        document.getElementById('metricCoverage').textContent = `${coverage}%`;
        
        this.renderRecentRisks();
    }

    renderRecentRisks() {
        const container = document.getElementById('recentRisks');
        if (!container) return;
        
        const recent = this.data.risks.sort((a, b) => 
            new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0)
        ).slice(0, 5);
        
        if (recent.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No risks yet</td></tr>';
        } else {
            container.innerHTML = recent.map(r => `
                <tr>
                    <td><strong>${this.escapeHtml(r.title)}</strong><br><small class="text-muted">${this.escapeHtml(r.category)}</small></td>
                    <td><span class="badge bg-${r.severity === 'High' ? 'danger' : r.severity === 'Medium' ? 'warning' : 'success'}">${this.escapeHtml(r.severity)}</span></td>
                    <td><span class="status-badge status-${r.status.toLowerCase().replace(' ', '-')}">${this.escapeHtml(r.status)}</span></td>
                    <td><button class="btn btn-sm btn-outline-light" onclick="window.app.showRiskForm('${r.id}')"><i class="bi bi-eye"></i></button></td>
                </tr>
            `).join('');
        }
    }

    // FRAMEWORKS
    renderFrameworks() {
        const tbody = document.getElementById('frameworkTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('frameworkSearch')?.value || '').toLowerCase();
        const fwFilter = document.getElementById('frameworkSelect')?.value || 'all';
        const catFilter = document.getElementById('categorySelect')?.value || 'all';
        
        let all = [];
        Object.entries(this.frameworks).forEach(([key, fw]) => {
            fw.controls.forEach(c => all.push({...c, fwKey: key, fwName: fw.name}));
        });
        
        let filtered = all;
        if (search) filtered = filtered.filter(c => 
            c.name.toLowerCase().includes(search) || 
            c.description.toLowerCase().includes(search) || 
            c.id.toLowerCase().includes(search)
        );
        if (fwFilter !== 'all') filtered = filtered.filter(c => c.fwKey === fwFilter);
        if (catFilter !== 'all') filtered = filtered.filter(c => c.category === catFilter);
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No controls match filters</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(c => `
                <tr>
                    <td><code>${this.escapeHtml(c.id)}</code></td>
                    <td><strong>${this.escapeHtml(c.name)}</strong></td>
                    <td><span class="badge bg-info">${this.escapeHtml(c.category)}</span></td>
                    <td><span class="framework-badge badge-${c.fwKey}">${this.escapeHtml(c.fwName)}</span></td>
                    <td><small>${this.escapeHtml(c.description)}</small></td>
                </tr>
            `).join('');
        }
    }

    // RISKS
    showRiskForm(riskId = null) {
        const risk = riskId ? this.data.risks.find(r => r.id === riskId) : null;
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        
        document.getElementById('riskModalBody').innerHTML = `
            <form id="riskForm" onsubmit="window.app.saveRisk(event); return false;">
                <input type="hidden" id="riskId" value="${risk?.id || ''}">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="riskTitle" value="${risk?.title || ''}" required>
                    </div>
                    ${startedProjects.length > 0 ? `
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="riskProjectId">
                            <option value="">None (General Risk)</option>
                            ${startedProjects.map(p => {
                                const proj = projects.find(pr => pr.id === p.id);
                                return `<option value="${p.id}" ${(risk?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Category *</label>
                        <select class="form-select" id="riskCategory" required>
                            <option value="">Select...</option>
                            ${['Access Control','Asset Management','Cloud Security','Network Security','Application Security','Data Protection','Monitoring & Logging','Incident Management','Vulnerability Management','Change Management','Business Continuity','Vendor Management','Privacy','Compliance','Governance','Physical Security','Human Resources'].map(c => 
                                `<option value="${c}" ${risk?.category === c ? 'selected' : ''}>${c}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="riskStatus" required>
                            ${['Open','In Progress','Mitigated','Closed'].map(s => 
                                `<option value="${s}" ${risk?.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Likelihood (1-5) *</label>
                        <select class="form-select" id="riskLikelihood" required onchange="window.app.updateRiskScore()">
                            ${[1,2,3,4,5].map(n => `<option value="${n}" ${risk?.likelihood === n ? 'selected' : ''}>${n}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Impact (1-5) *</label>
                        <select class="form-select" id="riskImpact" required onchange="window.app.updateRiskScore()">
                            ${[1,2,3,4,5].map(n => `<option value="${n}" ${risk?.impact === n ? 'selected' : ''}>${n}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="riskDescription" rows="3">${risk?.description || ''}</textarea>
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <small><strong>Score:</strong> <span id="riskScore">${risk?.score || 0}</span> | 
                            <strong>Severity:</strong> <span id="riskSeverity">${risk?.severity || 'Low'}</span></small>
                        </div>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-light me-2" onclick="safeHideModal('riskModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;
        this.updateRiskScore();
        new bootstrap.Modal(document.getElementById('riskModal')).show();
    }

    updateRiskScore() {
        const l = parseInt(document.getElementById('riskLikelihood')?.value) || 0;
        const i = parseInt(document.getElementById('riskImpact')?.value) || 0;
        const score = l * i;
        const severity = score >= 15 ? 'High' : score >= 6 ? 'Medium' : 'Low';
        if (document.getElementById('riskScore')) document.getElementById('riskScore').textContent = score;
        if (document.getElementById('riskSeverity')) document.getElementById('riskSeverity').textContent = severity;
    }

    saveRisk(event) {
        event.preventDefault();
        const projectIdEl = document.getElementById('riskProjectId');
        const data = {
            id: document.getElementById('riskId').value || 'RISK_' + Date.now(),
            title: document.getElementById('riskTitle').value.trim(),
            category: document.getElementById('riskCategory').value,
            status: document.getElementById('riskStatus').value,
            likelihood: parseInt(document.getElementById('riskLikelihood').value),
            impact: parseInt(document.getElementById('riskImpact').value),
            description: document.getElementById('riskDescription').value.trim(),
            updatedAt: new Date().toISOString()
        };
        data.score = data.likelihood * data.impact;
        data.severity = data.score >= 15 ? 'High' : data.score >= 6 ? 'Medium' : 'Low';
        
        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            data.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            data.projectId = this.currentProjectId;
        }
        
        const idx = this.data.risks.findIndex(r => r.id === data.id);
        if (idx > -1) this.data.risks[idx] = data;
        else this.data.risks.push(data);
        
        this.saveData('risks', this.data.risks);
        this.renderRisks();
        this.renderDashboard();
        safeHideModal('riskModal');
        this.showToast('Risk saved', 'success');
        
        // Refresh projects if working on one
        if (data.projectId) {
            this.renderProjects();
        }
    }

    renderRisks() {
        const tbody = document.getElementById('riskTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('riskSearch')?.value || '').toLowerCase();
        let filtered = this.data.risks;
        if (search) filtered = filtered.filter(r => 
            r.title.toLowerCase().includes(search) || 
            r.category.toLowerCase().includes(search)
        );
        
        filtered.sort((a, b) => b.score - a.score);
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No risks yet</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(r => `
                <tr>
                    <td><strong>${this.escapeHtml(r.title)}</strong><br><small class="text-muted">${this.escapeHtml(r.category)}</small></td>
                    <td>${this.escapeHtml(r.category)}</td>
                    <td><span class="badge bg-${r.severity === 'High' ? 'danger' : r.severity === 'Medium' ? 'warning' : 'success'}">${this.escapeHtml(r.severity)} (${r.score})</span></td>
                    <td><span class="status-badge status-${r.status.toLowerCase().replace(' ', '-')}">${this.escapeHtml(r.status)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="window.app.showRiskForm('${r.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger" onclick="window.app.deleteItem('risks', '${r.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // ASSETS
    showAssetForm(assetId = null) {
        const asset = assetId ? this.data.assets.find(a => a.id === assetId) : null;
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        
        document.getElementById('assetModalBody').innerHTML = `
            <form id="assetForm" onsubmit="window.app.saveAsset(event); return false;">
                <input type="hidden" id="assetId" value="${asset?.id || ''}">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Asset Name *</label>
                        <input type="text" class="form-control" id="assetName" value="${asset?.name || ''}" required>
                    </div>
                    ${startedProjects.length > 0 ? `
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="assetProjectId">
                            <option value="">None (General Asset)</option>
                            ${startedProjects.map(p => {
                                const proj = projects.find(pr => pr.id === p.id);
                                return `<option value="${p.id}" ${(asset?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Type *</label>
                        
<select class="form-select" id="assetType" required>
  <option value="">Select Asset Type</option>

  <!-- GRC / Business-aligned -->
  <option>Application</option>
  <option>Data Asset</option>
  <option>Database</option>
  <option>Cloud Infrastructure</option>
  <option>Cloud Service</option>
  <option>Identity & Access System</option>
  <option>DevOps / CI-CD Pipeline</option>

  <!-- Technical -->
  <option>Network Infrastructure</option>
  <option>Endpoint Device</option>
  <option>Security Tool</option>
  <option>Monitoring & Logging System</option>
  <option>Backup & Recovery System</option>

  <!-- External -->
  <option>Third-Party Service</option>
</select>

                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Criticality *</label>
                        <select class="form-select" id="assetCriticality" required>
                            ${['High','Medium','Low'].map(c => 
                                `<option value="${c}" ${asset?.criticality === c ? 'selected' : ''}>${c}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Owner</label>
                        <input type="text" class="form-control" id="assetOwner" value="${asset?.owner || ''}">
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-light me-2" onclick="safeHideModal('assetModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;
        new bootstrap.Modal(document.getElementById('assetModal')).show();
    }

    saveAsset(event) {
        event.preventDefault();
        const projectIdEl = document.getElementById('assetProjectId');
        const data = {
            id: document.getElementById('assetId').value || 'ASSET_' + Date.now(),
            name: document.getElementById('assetName').value.trim(),
            type: document.getElementById('assetType').value,
            criticality: document.getElementById('assetCriticality').value,
            owner: document.getElementById('assetOwner').value.trim(),
            updatedAt: new Date().toISOString()
        };
        
        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            data.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            data.projectId = this.currentProjectId;
        }
        
        const idx = this.data.assets.findIndex(a => a.id === data.id);
        if (idx > -1) this.data.assets[idx] = data;
        else this.data.assets.push(data);
        
        this.saveData('assets', this.data.assets);
        this.renderAssets();
        this.renderDashboard();
        safeHideModal('assetModal');
        this.showToast('Asset saved', 'success');
        
        // Refresh projects if working on one
        if (data.projectId) {
            this.renderProjects();
        }
    }

    renderAssets() {
        const tbody = document.getElementById('assetTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('assetSearch')?.value || '').toLowerCase();
        let filtered = this.data.assets;
        if (search) filtered = filtered.filter(a => 
            a.name.toLowerCase().includes(search) || a.type.toLowerCase().includes(search)
        );
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No assets yet</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(a => `
                <tr>
                    <td><strong>${this.escapeHtml(a.name)}</strong></td>
                    <td>${this.escapeHtml(a.type)}</td>
                    <td><span class="badge bg-${a.criticality === 'High' ? 'danger' : a.criticality === 'Medium' ? 'warning' : 'success'}">${this.escapeHtml(a.criticality)}</span></td>
                    <td>${this.escapeHtml(a.owner)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="window.app.showAssetForm('${a.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger" onclick="window.app.deleteItem('assets', '${a.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // VENDORS
    showVendorForm(vendorId = null) {
        const vendor = vendorId ? this.data.vendors.find(v => v.id === vendorId) : null;
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        
        document.getElementById('vendorModalBody').innerHTML = `
            <form id="vendorForm" onsubmit="window.app.saveVendor(event); return false;">
                <input type="hidden" id="vendorId" value="${vendor?.id || ''}">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Vendor Name *</label>
                        <input type="text" class="form-control" id="vendorName" value="${vendor?.name || ''}" required>
                    </div>
                    ${startedProjects.length > 0 ? `
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="vendorProjectId">
                            <option value="">None (General Vendor)</option>
                            ${startedProjects.map(p => {
                                const proj = projects.find(pr => pr.id === p.id);
                                return `<option value="${p.id}" ${(vendor?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Service Type *</label>
                        <select class="form-select" id="vendorService" required>
                            ${['Cloud Hosting','SaaS','IT Services','Security Services','Consulting','Other'].map(s => 
                                `<option value="${s}" ${vendor?.service === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Risk Level *</label>
                        <select class="form-select" id="vendorRisk" required>
                            ${['High','Medium','Low'].map(r => 
                                `<option value="${r}" ${vendor?.risk === r ? 'selected' : ''}>${r}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="vendorStatus" required>
                            ${['Active','Under Review','Suspended','Terminated'].map(s => 
                                `<option value="${s}" ${vendor?.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-light me-2" onclick="safeHideModal('vendorModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;
        new bootstrap.Modal(document.getElementById('vendorModal')).show();
    }

    saveVendor(event) {
        event.preventDefault();
        const projectIdEl = document.getElementById('vendorProjectId');
        const data = {
            id: document.getElementById('vendorId').value || 'VENDOR_' + Date.now(),
            name: document.getElementById('vendorName').value.trim(),
            service: document.getElementById('vendorService').value,
            risk: document.getElementById('vendorRisk').value,
            status: document.getElementById('vendorStatus').value,
            updatedAt: new Date().toISOString()
        };
        
        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            data.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            data.projectId = this.currentProjectId;
        }
        
        const idx = this.data.vendors.findIndex(v => v.id === data.id);
        if (idx > -1) this.data.vendors[idx] = data;
        else this.data.vendors.push(data);
        
        this.saveData('vendors', this.data.vendors);
        this.renderVendors();
        safeHideModal('vendorModal');
        this.showToast('Vendor saved', 'success');
        
        // Refresh projects if working on one
        if (data.projectId) {
            this.renderProjects();
        }
    }

    renderVendors() {
        const tbody = document.getElementById('vendorTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('vendorSearch')?.value || '').toLowerCase();
        let filtered = this.data.vendors;
        if (search) filtered = filtered.filter(v => 
            v.name.toLowerCase().includes(search) || v.service.toLowerCase().includes(search)
        );
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No vendors yet</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(v => `
                <tr>
                    <td><strong>${this.escapeHtml(v.name)}</strong></td>
                    <td>${this.escapeHtml(v.service)}</td>
                    <td><span class="badge bg-${v.risk === 'High' ? 'danger' : v.risk === 'Medium' ? 'warning' : 'success'}">${this.escapeHtml(v.risk)}</span></td>
                    <td><span class="status-badge status-${v.status.toLowerCase().replace(' ', '-')}">${this.escapeHtml(v.status)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="window.app.showVendorForm('${v.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger" onclick="window.app.deleteItem('vendors', '${v.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // CONTROLS (similar pattern)
    showControlForm(controlId = null) {
        const control = controlId ? this.data.controls.find(c => c.id === controlId) : null;
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        
        document.getElementById('controlModalBody').innerHTML = `
            <form id="controlForm" onsubmit="window.app.saveControl(event); return false;">
                <input type="hidden" id="controlId" value="${control?.id || ''}">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Control Name *</label>
                        <input type="text" class="form-control" id="controlName" value="${control?.name || ''}" required>
                    </div>
                    ${startedProjects.length > 0 ? `
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="controlProjectId">
                            <option value="">None (General Control)</option>
                            ${startedProjects.map(p => {
                                const proj = projects.find(pr => pr.id === p.id);
                                return `<option value="${p.id}" ${(control?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="controlType" required>
                            ${['Preventive','Detective','Corrective','Administrative'].map(t => 
                                `<option value="${t}" ${control?.type === t ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Framework</label>
                        <select class="form-select" id="controlFramework">
                            ${['ISO 27001','NIST CSF','PCI DSS','HIPAA','SOC 2','CIS','GDPR','CMMC','COBIT'].map(f => 
                                `<option value="${f}" ${control?.framework === f ? 'selected' : ''}>${f}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="controlStatus" required>
                            ${['Implemented','Planned','Not Implemented'].map(s => 
                                `<option value="${s}" ${control?.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-light me-2" onclick="safeHideModal('controlModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;
        new bootstrap.Modal(document.getElementById('controlModal')).show();
    }

    saveControl(event) {
        event.preventDefault();
        const projectIdEl = document.getElementById('controlProjectId');
        const data = {
            id: document.getElementById('controlId').value || 'CTRL_' + Date.now(),
            name: document.getElementById('controlName').value.trim(),
            type: document.getElementById('controlType').value,
            framework: document.getElementById('controlFramework').value,
            status: document.getElementById('controlStatus').value,
            updatedAt: new Date().toISOString()
        };
        
        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            data.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            data.projectId = this.currentProjectId;
        }
        
        const idx = this.data.controls.findIndex(c => c.id === data.id);
        if (idx > -1) this.data.controls[idx] = data;
        else this.data.controls.push(data);
        
        this.saveData('controls', this.data.controls);
        this.renderControls();
        this.renderDashboard();
        safeHideModal('controlModal');
        this.showToast('Control saved', 'success');
        
        // Refresh projects if working on one
        if (data.projectId) {
            this.renderProjects();
        }
    }

    renderControls() {
        const tbody = document.getElementById('controlTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('controlSearch')?.value || '').toLowerCase();
        let filtered = this.data.controls;
        if (search) filtered = filtered.filter(c => 
            c.name.toLowerCase().includes(search) || c.framework.toLowerCase().includes(search)
        );
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No controls yet</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(c => `
                <tr>
                    <td><strong>${this.escapeHtml(c.name)}</strong></td>
                    <td>${this.escapeHtml(c.type)}</td>
                    <td><span class="framework-badge badge-${c.framework.toLowerCase().split(' ')[0]}">${this.escapeHtml(c.framework)}</span></td>
                    <td><span class="status-badge status-${c.status.toLowerCase().replace(' ', '-')}">${this.escapeHtml(c.status)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="window.app.showControlForm('${c.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger" onclick="window.app.deleteItem('controls', '${c.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // ISSUES
    showIssueForm(issueId = null) {
        const issue = issueId ? this.data.issues.find(i => i.id === issueId) : null;
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        
        document.getElementById('issueModalBody').innerHTML = `
            <form id="issueForm" onsubmit="window.app.saveIssue(event); return false;">
                <input type="hidden" id="issueId" value="${issue?.id || ''}">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Issue Title *</label>
                        <input type="text" class="form-control" id="issueTitle" value="${issue?.title || ''}" required>
                    </div>
                    ${startedProjects.length > 0 ? `
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="issueProjectId">
                            <option value="">None (General Issue)</option>
                            ${startedProjects.map(p => {
                                const proj = projects.find(pr => pr.id === p.id);
                                return `<option value="${p.id}" ${(issue?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Source *</label>
                        <select class="form-select" id="issueSource" required>
                            ${['Audit','Penetration Test','Vulnerability Scan','Internal Review','Incident'].map(s => 
                                `<option value="${s}" ${issue?.source === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Severity *</label>
                        <select class="form-select" id="issueSeverity" required>
                            ${['Critical','High','Medium','Low'].map(s => 
                                `<option value="${s}" ${issue?.severity === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="issueStatus" required>
                            ${['Open','In Progress','Resolved'].map(s => 
                                `<option value="${s}" ${issue?.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-light me-2" onclick="safeHideModal('issueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;
        new bootstrap.Modal(document.getElementById('issueModal')).show();
    }

    saveIssue(event) {
        event.preventDefault();
        const projectIdEl = document.getElementById('issueProjectId');
        const data = {
            id: document.getElementById('issueId').value || 'ISSUE_' + Date.now(),
            title: document.getElementById('issueTitle').value.trim(),
            source: document.getElementById('issueSource').value,
            severity: document.getElementById('issueSeverity').value,
            status: document.getElementById('issueStatus').value,
            updatedAt: new Date().toISOString()
        };
        
        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            data.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            data.projectId = this.currentProjectId;
        }
        
        const idx = this.data.issues.findIndex(i => i.id === data.id);
        if (idx > -1) this.data.issues[idx] = data;
        else this.data.issues.push(data);
        
        this.saveData('issues', this.data.issues);
        this.renderIssues();
        safeHideModal('issueModal');
        this.showToast('Issue saved', 'success');
        
        // Refresh projects if working on one
        if (data.projectId) {
            this.renderProjects();
        }
    }

    renderIssues() {
        const tbody = document.getElementById('issueTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('issueSearch')?.value || '').toLowerCase();
        let filtered = this.data.issues;
        if (search) filtered = filtered.filter(i => 
            i.title.toLowerCase().includes(search) || i.source.toLowerCase().includes(search)
        );
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No issues yet</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(i => `
                <tr>
                    <td><strong>${this.escapeHtml(i.title)}</strong></td>
                    <td>${this.escapeHtml(i.source)}</td>
                    <td><span class="badge bg-${i.severity === 'Critical' || i.severity === 'High' ? 'danger' : i.severity === 'Medium' ? 'warning' : 'success'}">${this.escapeHtml(i.severity)}</span></td>
                    <td><span class="status-badge status-${i.status.toLowerCase().replace(' ', '-')}">${this.escapeHtml(i.status)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="window.app.showIssueForm('${i.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger" onclick="window.app.deleteItem('issues', '${i.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // INCIDENTS
    showIncidentForm(incidentId = null) {
        const incident = incidentId ? this.data.incidents.find(i => i.id === incidentId) : null;
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        
        document.getElementById('incidentModalBody').innerHTML = `
            <form id="incidentForm" onsubmit="window.app.saveIncident(event); return false;">
                <input type="hidden" id="incidentId" value="${incident?.id || ''}">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Incident Title *</label>
                        <input type="text" class="form-control" id="incidentTitle" value="${incident?.title || ''}" required>
                    </div>
                    ${startedProjects.length > 0 ? `
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="incidentProjectId">
                            <option value="">None (General Incident)</option>
                            ${startedProjects.map(p => {
                                const proj = projects.find(pr => pr.id === p.id);
                                return `<option value="${p.id}" ${(incident?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="incidentType" required>
                            ${['Data Breach','Malware','Phishing','DDoS','Unauthorized Access','Other'].map(t => 
                                `<option value="${t}" ${incident?.type === t ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Severity *</label>
                        <select class="form-select" id="incidentSeverity" required>
                            ${['Critical','High','Medium','Low'].map(s => 
                                `<option value="${s}" ${incident?.severity === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="incidentStatus" required>
                            ${['Detected','Investigating','Contained','Resolved'].map(s => 
                                `<option value="${s}" ${incident?.status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-outline-light me-2" onclick="safeHideModal('incidentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;
        new bootstrap.Modal(document.getElementById('incidentModal')).show();
    }

    saveIncident(event) {
        event.preventDefault();
        const projectIdEl = document.getElementById('incidentProjectId');
        const data = {
            id: document.getElementById('incidentId').value || 'INC_' + Date.now(),
            title: document.getElementById('incidentTitle').value.trim(),
            type: document.getElementById('incidentType').value,
            severity: document.getElementById('incidentSeverity').value,
            status: document.getElementById('incidentStatus').value,
            updatedAt: new Date().toISOString()
        };
        
        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            data.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            data.projectId = this.currentProjectId;
        }
        
        const idx = this.data.incidents.findIndex(i => i.id === data.id);
        if (idx > -1) this.data.incidents[idx] = data;
        else this.data.incidents.push(data);
        
        this.saveData('incidents', this.data.incidents);
        this.renderIncidents();
        safeHideModal('incidentModal');
        this.showToast('Incident saved', 'success');
        
        // Refresh projects if working on one
        if (data.projectId) {
            this.renderProjects();
        }
    }

    renderIncidents() {
        const tbody = document.getElementById('incidentTableBody');
        if (!tbody) return;
        
        const search = (document.getElementById('incidentSearch')?.value || '').toLowerCase();
        let filtered = this.data.incidents;
        if (search) filtered = filtered.filter(i => 
            i.title.toLowerCase().includes(search) || i.type.toLowerCase().includes(search)
        );
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No incidents yet</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(i => `
                <tr>
                    <td><strong>${this.escapeHtml(i.title)}</strong></td>
                    <td>${this.escapeHtml(i.type)}</td>
                    <td><span class="badge bg-${i.severity === 'Critical' || i.severity === 'High' ? 'danger' : i.severity === 'Medium' ? 'warning' : 'success'}">${this.escapeHtml(i.severity)}</span></td>
                    <td><span class="status-badge status-${i.status.toLowerCase()}">${this.escapeHtml(i.status)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="window.app.showIncidentForm('${i.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger" onclick="window.app.deleteItem('incidents', '${i.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // UTILITIES
    deleteItem(collection, id) {
        if (!confirm('Delete this item?')) return;
        this.data[collection] = this.data[collection].filter(item => item.id !== id);
        this.saveData(collection, this.data[collection]);
        this.renderTabContent(this.currentTab);
        this.renderDashboard();
        this.showToast('Item deleted', 'info');
    }

loadDemoScenario() {

    if (localStorage.getItem('demoLoaded') === 'true') {
        this.showToast('Demo data already loaded', 'info');
        return;
    }

    const demoData = {
        risks: [
            {id:'DR1',title:'SQL Injection Vulnerability',category:'Cybersecurity',status:'Open',likelihood:4,impact:5,score:20,severity:'High',description:'Web application vulnerable to SQL injection',updatedAt:new Date().toISOString()},
            {id:'DR2',title:'GDPR Compliance Gap',category:'Compliance',status:'In Progress',likelihood:3,impact:4,score:12,severity:'Medium',description:'Data retention policy non-compliant',updatedAt:new Date().toISOString()},
            {id:'DR3',title:'Vendor Security Assessment',category:'Third-Party',status:'Open',likelihood:2,impact:3,score:6,severity:'Medium',description:'Cloud provider lacks SOC 2',updatedAt:new Date().toISOString()}
        ],
        assets: [
            {id:'DA1',name:'Production Database',type:'Database',criticality:'High',owner:'DBA Team',updatedAt:new Date().toISOString()},
            {id:'DA2',name:'Web Application Server',type:'Server',criticality:'High',owner:'DevOps',updatedAt:new Date().toISOString()},
            {id:'DA3',name:'Employee Laptops',type:'Workstation',criticality:'Medium',owner:'IT Support',updatedAt:new Date().toISOString()}
        ],
        vendors: [
            {id:'DV1',name:'AWS',service:'Cloud Hosting',risk:'Medium',status:'Active',updatedAt:new Date().toISOString()},
            {id:'DV2',name:'Salesforce',service:'SaaS',risk:'Low',status:'Active',updatedAt:new Date().toISOString()}
        ],
        controls: [
            {id:'DC1',name:'Multi-Factor Authentication',type:'Preventive',framework:'ISO 27001',status:'Implemented',updatedAt:new Date().toISOString()},
            {id:'DC2',name:'Security Awareness Training',type:'Administrative',framework:'NIST CSF',status:'Implemented',updatedAt:new Date().toISOString()},
            {id:'DC3',name:'Data Encryption at Rest',type:'Preventive',framework:'PCI DSS',status:'Planned',updatedAt:new Date().toISOString()}
        ],
        issues: [
            {id:'DI1',title:'Unpatched Servers',source:'Vulnerability Scan',severity:'High',status:'Open',updatedAt:new Date().toISOString()},
            {id:'DI2',title:'Weak Password Policy',source:'Audit',severity:'Medium',status:'In Progress',updatedAt:new Date().toISOString()}
        ],
        incidents: [
            {id:'DIN1',title:'Phishing Email Campaign',type:'Phishing',severity:'Medium',status:'Resolved',updatedAt:new Date().toISOString()},
            {id:'DIN2',title:'Failed Login Attempts',type:'Unauthorized Access',severity:'Low',status:'Investigating',updatedAt:new Date().toISOString()}
        ]
    };

    Object.keys(demoData).forEach(key => {
        this.data[key] = [...demoData[key]];
        this.saveData(key, this.data[key]);
    });

    this.renderDashboard();
    this.renderTabContent(this.currentTab);
    this.showToast('Demo scenario loaded with sample data across all modules', 'success');
    localStorage.setItem('demoLoaded', 'true');
}


    exportAllData() {
        const exportData = {
            version: this.version,
            exportDate: new Date().toISOString(),
            data: this.data
        };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `grc-lab-export-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        this.showToast('Data exported successfully', 'success');
    }



    // ======== TREATMENTS (Risk Treatment Plan) ========
    renderTreatments() {
        const tbody = document.getElementById('treatmentTableBody');
        if (!tbody) return;
        if (!Array.isArray(this.data.treatments) || this.data.treatments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No treatments yet</td></tr>';
            return;
        }

        const riskById = Object.fromEntries((this.data.risks || []).map(r => [r.id, r]));
        tbody.innerHTML = this.data.treatments
            .sort((a,b) => new Date(b.updatedAt||0) - new Date(a.updatedAt||0))
            .map(t => {
                const risk = riskById[t.riskId];
                const riskLabel = risk ? `${this.escapeHtml(risk.title)} <br><small class="text-muted">${this.escapeHtml(risk.category||'')}</small>` : '<span class="text-muted">(Risk not found)</span>';
                const status = this.escapeHtml(t.status || 'Planned');
                return `
                    <tr>
                        <td>${riskLabel}</td>
                        <td><strong>${this.escapeHtml(t.treatment||'')}</strong><br><small class="text-muted">${this.escapeHtml(t.controls||'')}</small></td>
                        <td>${this.escapeHtml(t.owner||'')}</td>
                        <td>${this.escapeHtml(t.targetDate||'')}</td>
                        <td><span class="status-badge status-${status.toLowerCase().replace(/\s/g,'-')}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-light" onclick="window.app.showTreatmentForm('${t.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-light ms-1" onclick="window.app.deleteTreatment('${t.id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
    }

    showTreatmentForm(treatmentId = null) {
        const t = treatmentId ? (this.data.treatments || []).find(x => x.id === treatmentId) : null;
        const risks = (this.data.risks || []);
        const projects = this.getProjectScenarios();
        const startedProjects = this.data.projects.filter(p => p.status === 'in-progress');
        const options = risks.length
            ? risks.map(r => `<option value="${this.escapeHtml(r.id)}" ${t?.riskId===r.id?'selected':''}>${this.escapeHtml(r.title)}</option>`).join('')
            : '<option value="">No risks found (add a risk first)</option>';

        const body = document.getElementById('treatmentModalBody');
        body.innerHTML = `
            <form id="treatmentForm" onsubmit="window.app.saveTreatment(event); return false;">
                <input type="hidden" id="treatmentId" value="${t?.id || ''}">
                <div class="mb-3">
                    <label class="form-label">Risk *</label>
                    <select class="form-select" id="treatmentRiskId" required>${options}</select>
                </div>
                ${startedProjects.length > 0 ? `
                <div class="mb-3">
                    <label class="form-label">Project (Optional)</label>
                    <select class="form-select" id="treatmentProjectId">
                        <option value="">None (General Treatment)</option>
                        ${startedProjects.map(p => {
                            const proj = projects.find(pr => pr.id === p.id);
                            return `<option value="${p.id}" ${(t?.projectId === p.id || this.currentProjectId === p.id) ? 'selected' : ''}>${proj ? proj.company : p.id}</option>`;
                        }).join('')}
                    </select>
                </div>
                ` : ''}
                <div class="mb-3">
                    <label class="form-label">Treatment *</label>
                    <input class="form-control" id="treatmentText" required value="${this.escapeHtml(t?.treatment || '')}" placeholder="e.g., Implement MFA for admin access">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Owner</label>
                        <input class="form-control" id="treatmentOwner" value="${this.escapeHtml(t?.owner || '')}" placeholder="e.g., IT Manager">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="treatmentTargetDate" value="${this.escapeHtml(t?.targetDate || '')}">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Mapped Controls (optional)</label>
                    <input class="form-control" id="treatmentControls" value="${this.escapeHtml(t?.controls || '')}" placeholder="e.g., ISO-5.17, ISO-8.2">
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="treatmentStatus">
                        ${['Planned','In Progress','Mitigated','Closed'].map(st => `<option ${t?.status===st?'selected':''}>${st}</option>`).join('')}
                    </select>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-light" onclick="safeHideModal('treatmentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        `;

        const el = document.getElementById('treatmentModal');
        new bootstrap.Modal(el).show();
    }

    saveTreatment(e) {
        e.preventDefault();
        const projectIdEl = document.getElementById('treatmentProjectId');
        const id = document.getElementById('treatmentId')?.value || '';
        const treatment = {
            id: id || ('treat_' + Math.random().toString(16).slice(2)),
            riskId: document.getElementById('treatmentRiskId').value,
            treatment: document.getElementById('treatmentText').value.trim(),
            owner: document.getElementById('treatmentOwner').value.trim(),
            targetDate: document.getElementById('treatmentTargetDate').value,
            controls: document.getElementById('treatmentControls').value.trim(),
            status: document.getElementById('treatmentStatus').value,
            updatedAt: new Date().toISOString()
        };

        // Add projectId if selected
        if (projectIdEl && projectIdEl.value) {
            treatment.projectId = projectIdEl.value;
        } else if (this.currentProjectId) {
            treatment.projectId = this.currentProjectId;
        }

        const list = Array.isArray(this.data.treatments) ? [...this.data.treatments] : [];
        const idx = list.findIndex(x => x.id === treatment.id);
        if (idx >= 0) list[idx] = treatment; else list.push(treatment);
        this.saveData('treatments', list);
        safeHideModal('treatmentModal');
        this.renderTreatments();
        this.showToast('Treatment saved', 'success');
        
        // Refresh projects if working on one
        if (treatment.projectId) {
            this.renderProjects();
        }
    }

    deleteTreatment(id) {
        if (!confirm('Delete this treatment?')) return;
        const list = (this.data.treatments || []).filter(t => t.id !== id);
        this.saveData('treatments', list);
        this.renderTreatments();
        this.showToast('Treatment deleted', 'success');
    }

    exportTreatments() {
        const payload = { exportedAt: new Date().toISOString(), treatments: this.data.treatments || [] };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `treatments-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ======== STATEMENT OF APPLICABILITY (ISO SoA) ========
    getIsoControls() {
        return (FRAMEWORK_CONTROLS || []).filter(c => String(c.id||'').startsWith('ISO-'));
    }

    ensureSoASeeded() {
        const iso = this.getIsoControls();
        if (!Array.isArray(this.data.SoA)) this.data.SoA = [];
        const byId = Object.fromEntries(this.data.SoA.map(x => [x.controlId, x]));
        let changed = false;
        for (const c of iso) {
            if (!byId[c.id]) {
                this.data.SoA.push({ controlId: c.id, applicable: false, justification: '', status: 'Not Applicable' });
                changed = true;
            }
        }
        if (changed) this.saveData('SoA', this.data.SoA);
    }

    renderSoA() {
        const tbody = document.getElementById('soaTableBody');
        if (!tbody) return;
        this.ensureSoASeeded();

        const iso = this.getIsoControls();
        const index = Object.fromEntries(iso.map(c => [c.id, c]));
        const search = (document.getElementById('soaSearch')?.value || '').toLowerCase();
        const statusFilter = document.getElementById('soaStatusFilter')?.value || 'all';

        let rows = (this.data.SoA || []).map(x => ({...x, meta: index[x.controlId]})).filter(r => r.meta);
        if (search) rows = rows.filter(r =>
            r.controlId.toLowerCase().includes(search) ||
            (r.meta.name||'').toLowerCase().includes(search) ||
            (r.meta.category||'').toLowerCase().includes(search) ||
            (r.justification||'').toLowerCase().includes(search)
        );
        if (statusFilter !== 'all') rows = rows.filter(r => (r.status||'') === statusFilter);

        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No controls match filters</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(r => {
            const meta = r.meta;
            const checked = r.applicable ? 'checked' : '';
            const statuses = ['Implemented','Planned','Not Implemented','Not Applicable'];
            const statusOpts = statuses.map(st => `<option ${r.status===st?'selected':''}>${st}</option>`).join('');
            return `
                <tr>
                    <td>
                        <code>${this.escapeHtml(r.controlId)}</code><br>
                        <strong>${this.escapeHtml(meta.name || '')}</strong><br>
                        <small class="text-muted">${this.escapeHtml(meta.category || '')}</small>
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${checked} onchange="window.app.updateSoA('${r.controlId}', 'applicable', this.checked)">
                        </div>
                    </td>
                    <td>
                        <input class="form-control" value="${this.escapeHtml(r.justification||'')}" placeholder="Why applicable / not applicable?" oninput="window.app.updateSoA('${r.controlId}', 'justification', this.value)">
                    </td>
                    <td>
                        <select class="form-select" onchange="window.app.updateSoA('${r.controlId}', 'status', this.value)">${statusOpts}</select>
                    </td>
                </tr>
            `;
        }).join('');
    }

    updateSoA(controlId, field, value) {
        this.ensureSoASeeded();
        const list = [...(this.data.SoA || [])];
        const idx = list.findIndex(x => x.controlId === controlId);
        if (idx < 0) return;
        list[idx] = { ...list[idx], [field]: value };
        
        // When applicable toggle changes, automatically update status
        if (field === 'applicable') {
            if (value === true) {
                // When turned ON, set to Planned (unless already Implemented)
                if (list[idx].status === 'Not Applicable') {
                    list[idx].status = 'Planned';
                }
            } else {
                // When turned OFF, set to Not Applicable
                list[idx].status = 'Not Applicable';
            }
        }
        
        // Auto-assign projectId if working on a project
        if (this.currentProjectId && !list[idx].projectId) {
            list[idx].projectId = this.currentProjectId;
        }
        
        this.saveData('SoA', list);
        // Re-render to show the updated status
        this.renderSoA();
        // Refresh projects if working on one
        if (list[idx].projectId) {
            this.renderProjects();
        }
    }

    resetSoA() {
        if (!confirm('Reset SoA to defaults (all Not Applicable)?')) return;
        // Clear all existing data
        this.saveData('SoA', []);
        this.data.SoA = [];
        // Re-seed with all controls set to NOT applicable
        this.ensureSoASeeded();
        this.renderSoA();
        this.showToast('SoA reset - all controls set to Not Applicable', 'success');
    }

    exportSoA() {
        this.ensureSoASeeded();
        const payload = { exportedAt: new Date().toISOString(), SoA: this.data.SoA || [] };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SoA-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

   
    populateRiskAnalyticsProjectFilter() {
        const sel = document.getElementById('riskAnalyticsProjectFilter');
        if (!sel) return;

        // Preserve current selection
        const current = sel.value || '';

        // Build options from project scenarios + started/in-progress projects
        const scenarios = this.getProjectScenarios ? this.getProjectScenarios() : [];
        const projects = Array.isArray(this.data?.projects) ? this.data.projects : [];
        const inProgress = projects.filter(p => p.status === 'in-progress');

        // Always keep the first option as "None (General...)"
        const options = [
            { value: '', label: 'None (General Risk Analytics)' },
            ...inProgress.map(p => {
                const sc = scenarios.find(s => s.id === p.id);
                const label = sc ? `${sc.company}` : p.id;
                return { value: p.id, label };
            })
        ];

        // De-duplicate by value while keeping order
        const seen = new Set();
        const unique = options.filter(o => {
            if (seen.has(o.value)) return false;
            seen.add(o.value);
            return true;
        });

        sel.innerHTML = unique.map(o => `<option value="${o.value}">${this.escapeHtml(o.label)}</option>`).join('');
        sel.value = current;
    }

    getRiskLI(risk) {
        const modeSel = document.getElementById('riskAnalyticsViewMode');
        const mode = modeSel ? (modeSel.value || 'inherent') : 'inherent';
        const L = (mode === 'residual' && risk.residualLikelihood !== undefined && risk.residualLikelihood !== null && String(risk.residualLikelihood) !== '')
            ? Number(risk.residualLikelihood)
            : Number(risk.likelihood);
        const I = (mode === 'residual' && risk.residualImpact !== undefined && risk.residualImpact !== null && String(risk.residualImpact) !== '')
            ? Number(risk.residualImpact)
            : Number(risk.impact);
        return { L, I, mode };
    }

    getRisksForAnalytics() {
        const all = Array.isArray(this.data?.risks) ? this.data.risks : [];
        const sel = document.getElementById('riskAnalyticsProjectFilter');
        const projectId = sel ? (sel.value || '') : '';

        // None => General analytics across all risks
        if (!projectId) return all;

        // Project selected => only risks linked to that project
        return all.filter(r => String(r.projectId || '') === String(projectId));
    }


renderRiskAnalytics() {
  // Ensure project filter options are in sync
  this.populateRiskAnalyticsProjectFilter();

  const risks = this.getRisksForAnalytics();

  // --- Helpers (supports 1–5 and Low/Medium/High) ---
  const to15 = (v) => {
    if (v === null || v === undefined) return null;

    // numeric string or number
    const n = Number(v);
    if (!Number.isNaN(n) && n >= 1 && n <= 5) return n;

    // Low/Medium/High mapping (common)
    const s = String(v).toLowerCase();
    if (s.includes("low")) return 2;
    if (s.includes("med")) return 3;
    if (s.includes("high")) return 5;

    return null;
  };

  const inferFromSeverity = (sev) => {
    const s = String(sev || "").toLowerCase();
    if (s.includes("high")) return { i: 5, l: 4 };
    if (s.includes("medium")) return { i: 3, l: 3 };
    return { i: 2, l: 2 };
  };

  const normIL = (r) => {
    const li = this.getRiskLI ? this.getRiskLI(r) : {L: r.likelihood, I: r.impact};
    let i = to15(li.I);
    let l = to15(li.L);

    // some of your demo uses 1–5 but could be stored as score components; fallback
    if (!i && r.impactLevel) i = to15(r.impactLevel);
    if (!l && r.likelihoodLevel) l = to15(r.likelihoodLevel);

    if (!i || !l) {
      const inf = inferFromSeverity(r.severity);
      i = i || inf.i;
      l = l || inf.l;
    }
    return { i, l, score: i * l };
  };

  // --- Heatmap 5×5 counts ---
  const buckets = Array.from({ length: 5 }, () => Array.from({ length: 5 }, () => []));
  risks.forEach(r => {
    const { i, l } = normIL(r);
    // matrix indexes: [impact-1][likelihood-1]
    buckets[i - 1][l - 1].push(r);
  });

  // Render heatmap HTML
  const heatmap = document.getElementById("heatmap5x5");
  const selection = document.getElementById("heatmapSelection");
  if (heatmap) {
    const cellHtml = (impact, likelihood) => {
      const list = buckets[impact - 1][likelihood - 1];
      const count = list.length;
      const score = impact * likelihood;

      // simple intensity via score bands
      const bg =
        score >= 20 ? "rgba(239,68,68,.20)" :
        score >= 12 ? "rgba(245,158,11,.18)" :
        score >= 6  ? "rgba(6,182,212,.14)" :
                      "rgba(16,185,129,.12)";

return `
  <div class="heatmap-cell"
       style="border:1px solid rgba(255,255,255,.10);
              border-radius:12px;
              padding:12px;
              cursor:pointer;
              background:${bg};"
       onclick="
         document.querySelectorAll('.heatmap-cell.selected')
           .forEach(el => el.classList.remove('selected'));
         this.classList.add('selected');
         window.app._showHeatmapCell(${impact},${likelihood});
       ">
    <div class="text-muted" style="font-size:12px;">I:${impact} • L:${likelihood}</div>
    <div style="font-size:28px; font-weight:900;">${count}</div>
    <div class="text-muted" style="font-size:12px;">Score: ${score}</div>
  </div>
`;
    };

    let html = `
     <div style="display:grid; grid-template-columns: 50px repeat(5, 1fr); gap:10px;">
        <div></div>
        ${[1,2,3,4,5].map(l => `<div class="text-center text-muted" style="font-weight:800;">L${l}</div>`).join("")}
        ${[5,4,3,2,1].map(i => `
          <div class="text-muted" style="font-weight:800; display:flex; align-items:center; justify-content:flex-end; padding-right:6px;">I${i}</div>
          ${[1,2,3,4,5].map(l => cellHtml(i,l)).join("")}
        `).join("")}
      </div>
    `;
    heatmap.innerHTML = html;
  }

  // expose cell click handler
  window.app._showHeatmapCell = (impact, likelihood) => {
    const list = buckets[impact - 1][likelihood - 1];
    const names = list.slice(0, 8).map(r => `• ${r.title || r.id}`).join("<br>");
    if (selection) {
      selection.innerHTML = `<strong>I${impact} / L${likelihood}</strong> (${list.length} risks)<br><br>${names || "<span class='text-muted'>No risks</span>"}`;
    }
  };

  // --- Charts ---
  const statuses = risks.reduce((acc, r) => {
    const st = String(r.status || "Open").toLowerCase();
    if (st.includes("closed") || st.includes("resolved")) acc.closed++;
    else acc.open++;
    return acc;
  }, { open: 0, closed: 0 });

  const byCategory = {};
  risks.forEach(r => {
    const c = r.category || "Uncategorized";
    byCategory[c] = (byCategory[c] || 0) + 1;
  });

  const scores = risks.map(r => normIL(r).score);
  // distribution bins 1–25
  const dist = Array.from({ length: 25 }, () => 0);
  scores.forEach(sc => dist[sc - 1] = (dist[sc - 1] || 0) + 1);

  // trend last 30 days by day (using updatedAt)
  const days = 30;
  const today = new Date();
  const labels = [];
  const trend = Array.from({ length: days }, () => 0);
  for (let d = days - 1; d >= 0; d--) {
    const dt = new Date(today);
    dt.setDate(today.getDate() - d);
    labels.push(`${dt.getMonth()+1}/${dt.getDate()}`);
  }
  risks.forEach(r => {
    const t = new Date(r.updatedAt || r.createdAt || Date.now());
    const diff = Math.floor((today - t) / (1000*60*60*24));
    if (diff >= 0 && diff < days) {
      trend[days - 1 - diff] += 1;
    }
  });

  // destroy old charts safely
  window.app._charts = window.app._charts || {};
  const kill = (key) => {
    if (window.app._charts[key]) {
      window.app._charts[key].destroy();
      window.app._charts[key] = null;
    }
  };

  // Donut: open vs closed
  kill("openClosed");
  const ctx1 = document.getElementById("chartOpenClosed");
  if (ctx1) {
    window.app._charts.openClosed = new Chart(ctx1, {
      type: "doughnut",
      data: {
        labels: ["Open", "Closed"],
        datasets: [{ data: [statuses.open, statuses.closed] }]
      },
      options: { plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" }}}}
    });
  }

  // Bar: by category
  kill("byCategory");
  const ctx2 = document.getElementById("chartByCategory");
  if (ctx2) {
    const cats = Object.keys(byCategory);
    window.app._charts.byCategory = new Chart(ctx2, {
      type: "bar",
      data: { labels: cats, datasets: [{ data: cats.map(c => byCategory[c]) }] },
      options: {
        plugins: { legend: { display: false }},
        scales: {
          x: { ticks: { color: "rgba(255,255,255,.70)" } },
          y: { ticks: { color: "rgba(255,255,255,.70)" } }
        }
      }
    });
  }

  // Histogram: score distribution
  kill("scoreDist");
  const ctx3 = document.getElementById("chartScoreDist");
  if (ctx3) {
    window.app._charts.scoreDist = new Chart(ctx3, {
      type: "bar",
      data: {
        labels: Array.from({ length: 25 }, (_, i) => String(i + 1)),
        datasets: [{ data: dist }]
      },
      options: {
        plugins: { legend: { display: false }},
        scales: {
          x: { ticks: { color: "rgba(255,255,255,.70)", maxRotation: 0 }, title: { display: true, text: "Score", color: "rgba(255,255,255,.70)" } },
          y: { ticks: { color: "rgba(255,255,255,.70)" } }
        }
      }
    });
  }

  // Line: trend
  kill("trend");
  const ctx4 = document.getElementById("chartTrend");
  if (ctx4) {
    window.app._charts.trend = new Chart(ctx4, {
      type: "line",
      data: { labels, datasets: [{ data: trend, tension: 0.35 }] },
      options: {
        plugins: { legend: { display: false }},
        scales: {
          x: { ticks: { color: "rgba(255,255,255,.70)", maxTicksLimit: 6 } },
          y: { ticks: { color: "rgba(255,255,255,.70)" } }
        }
      }
    });
  }

  // Top risks list
  const top = [...risks]
    .map(r => ({ r, ...normIL(r) }))
    .sort((a,b) => b.score - a.score)
    .slice(0, 5);

  const topEl = document.getElementById("topRisksList");
  if (topEl) {
    topEl.innerHTML = top.length ? top.map(x =>
      `<div class="mb-2">
        <div style="font-weight:800;">${this.escapeHtml(x.r.title || x.r.id)}</div>
        <div class="text-muted" style="font-size:12px;">Score ${x.score} (I${x.i} × L${x.l}) • ${this.escapeHtml(x.r.status || "Open")}</div>
      </div>`
    ).join("") : `<div class="text-muted">No risks yet.</div>`;
  }
}

    // ======== REPORTS ========
  renderReports() {
  const summary = document.getElementById('reportSummary');
  if (!summary) return;
  summary.innerHTML = `<div class="text-muted">Use Report Builder above to generate and export reports.</div>`;
}


// =====================

// REPORT BUILDER + PDF
// =====================

getReportDraftEl() {
  return document.getElementById('reportDraft');
}

appendToReport(text) {
  const el = this.getReportDraftEl();
  if (!el) return;
  const current = el.value || '';
  el.value = current ? (current.trim() + "\n\n" + text.trim() + "\n") : (text.trim() + "\n");
}

clearReportDraft() {
  const el = this.getReportDraftEl();
  if (el) el.value = '';
  this.showToast('Report draft cleared', 'info');
}

generateBoardReport() {
  const draft = document.getElementById('reportDraft');
  if (!draft) return;

  const type = document.getElementById('reportType')?.value || 'executive';
  const title = (document.getElementById('reportTitle')?.value || 'GRC Management Report').trim();
  const stamp = new Date().toISOString().replace('T',' ').slice(0,19);
  const NL = "\n";

  const assets = this.data.assets || [];
  const vendors = this.data.vendors || [];
  const risks = this.data.risks || [];
  const controls = this.data.controls || [];
  const issues = this.data.issues || [];
  const incidents = this.data.incidents || [];
  const treatments = this.data.treatments || [];
  const SoA = this.data.SoA || [];

  const isOpen = (s) => {
    const x = String(s || '').toLowerCase();
    return x.includes('open') || x.includes('in progress') || x.includes('investig');
  };
  const countOpen = (arr) => arr.filter(x => isOpen(x.status)).length;

  const to15 = (v) => {
    const n = Number(v);
    if (!Number.isNaN(n) && n >= 1 && n <= 5) return n;
    const s = String(v || '').toLowerCase();
    if (s.includes('low')) return 2;
    if (s.includes('med')) return 3;
    if (s.includes('high')) return 5;
    return null;
  };

  const inferIL = (r) => {
    let i = to15(r.impact);
    let l = to15(r.likelihood);
    if (!i || !l) {
      const sev = String(r.severity || '').toLowerCase();
      if (sev.includes('high')) { i = i || 5; l = l || 4; }
      else if (sev.includes('medium')) { i = i || 3; l = l || 3; }
      else { i = i || 2; l = l || 2; }
    }
    return { i, l, score: i*l };
  };

  const topRisks = [...risks]
    .map(r => ({ r, ...inferIL(r) }))
    .sort((a,b) => b.score - a.score)
    .slice(0, 8);

  const byCategory = {};
  risks.forEach(r => {
    const c = r.category || 'Uncategorized';
    byCategory[c] = (byCategory[c] || 0) + 1;
  });

  const soaApplicable = SoA.filter(x => x.applicable !== false);
  const soaImplemented = soaApplicable.filter(x => String(x.status||'').toLowerCase() === 'implemented');
  const soaCoverage = soaApplicable.length ? Math.round((soaImplemented.length / soaApplicable.length) * 100) : 0;

  const header = [
    '==============================',
    title,
    '==============================',
    `Generated: ${stamp}`,
    '',
    'CONFIDENTIAL – INTERNAL USE (Training / Demo)',
  ].join(NL);

  const executive = [
    '1) EXECUTIVE SUMMARY',
    `Assets: ${assets.length}`,
    `Vendors: ${vendors.length}`,
    `Risks: ${risks.length} (Open: ${countOpen(risks)})`,
    `Controls tracked: ${controls.length}`,
    `Treatments: ${treatments.length}`,
    `Issues: ${issues.length} (Open: ${countOpen(issues)})`,
    `Incidents: ${incidents.length} (Open: ${countOpen(incidents)})`,
    '',
    `ISO SoA coverage (Applicable implemented): ${soaCoverage}% (${soaImplemented.length}/${soaApplicable.length})`,
    '',
    'TOP RISKS (Impact×Likelihood)',
    (topRisks.length ? topRisks.map((x,i)=>`  ${i+1}. ${x.r.title || x.r.id} — Score ${x.score} (I${x.i}×L${x.l}) • Status: ${x.r.status || '—'}`).join(NL) : '  (No risks available)'),
  ].join(NL);

  const riskPosture = [
    '2) RISK POSTURE',
    'Distribution by category:',
    (Object.keys(byCategory).length ? Object.entries(byCategory).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`  • ${k}: ${v}`).join(NL) : '  (No categories available)'),
    '',
    'Recommendations:',
    '  • Ensure High risks have owner, target date, and treatment plan.',
    '  • Confirm risk appetite thresholds and escalation paths.',
  ].join(NL);

  const controlsSection = [
    '3) CONTROLS & COMPLIANCE',
    `Controls tracked: ${controls.length}`,
    `SoA entries: ${SoA.length}`,
    `Applicable: ${soaApplicable.length}`,
    `Implemented: ${soaImplemented.length}`,
    `Coverage: ${soaCoverage}%`,
    '',
    'Next actions (30 days):',
    '  • Update top 20 SoA controls with status + evidence references.',
    '  • Map risks → controls → treatments for traceability.',
  ].join(NL);

  const incidentsSection = [
    '4) INCIDENTS & ISSUES',
    `Incidents: ${incidents.length} (Open: ${countOpen(incidents)})`,
    `Issues: ${issues.length} (Open: ${countOpen(issues)})`,
    '',
    'Board expectation:',
    '  • Confirm triage SLAs, escalation, and post-incident reviews.',
  ].join(NL);

  const vendorsSection = [
    '5) THIRD-PARTY RISK',
    `Vendors tracked: ${vendors.length}`,
    'Next actions:',
    '  • Assign vendor risk tier and collect assurance evidence (SOC2, ISO, DPAs).',
  ].join(NL);

  const roadmap = [
    '6) 30/60/90 DAY ROADMAP',
    '30 Days: asset inventory, SoA baseline, top risks treated.',
    '60 Days: full traceability (risk→control→treatment), vendor workflow.',
    '90 Days: simulate internal audit evidence pack + management review.',
  ].join(NL);

  const disclaimer = [
    'DISCLAIMER',
    'Educational/practice use only. Not a certified GRC platform; not for formal audit/certification decisions.',
    'Framework content summarized/paraphrased for training.',
  ].join(NL);

  let report = header + NL + NL;

  if (type === 'executive') report += executive + NL + NL + disclaimer;
  else if (type === 'SoA') report += controlsSection + NL + NL + disclaimer;
  else if (type === 'risk') report += executive + NL + NL + riskPosture + NL + NL + disclaimer;
  else if (type === 'treatments') report += roadmap + NL + NL + disclaimer;
  else if (type === 'full') report += [executive, riskPosture, controlsSection, incidentsSection, vendorsSection, roadmap, disclaimer].join(NL + NL);
  else report += executive + NL + NL + disclaimer;

  draft.value = report;
  this.showToast('Report generated', 'success');
}


generateReportSection() {
  const type = document.getElementById('reportType')?.value || 'executive';
  const title = (document.getElementById('reportTitle')?.value || '').trim();
  const stamp = new Date().toISOString().replace('T',' ').slice(0,19);

    
  // Data snapshots
  const assets = this.data.assets || [];
  const vendors = this.data.vendors || [];
  const risks = this.data.risks || [];
  const controls = this.data.controls || [];
  const incidents = this.data.incidents || [];
  const treatments = this.data.treatments || [];
  const SoA = this.data.SoA || [];

  // Helpers
  const countStatus = (arr, field='status', match='open') =>
    arr.filter(x => String(x[field] || '').toLowerCase().includes(match)).length;

  const topRisks = [...risks]
    .map(r => {
      const impact = Number(r.impact) || Number(r.score) || (r.severity === 'High' ? 5 : r.severity === 'Medium' ? 3 : 2);
      const likelihood = Number(r.likelihood) || (r.severity === 'High' ? 4 : r.severity === 'Medium' ? 3 : 2);
      return { r, score: impact * likelihood };
    })
    .sort((a,b) => b.score - a.score)
    .slice(0,5);

  const sectionHeader = (h) => `=== ${h} ===\nGenerated: ${stamp}${title ? `\nReport Title: ${title}` : ''}\n`;

  let block = '';

  if (type === 'executive') {
    const openRisks = countStatus(risks,'status','open') + countStatus(risks,'status','in progress');
    const openIssues = countStatus(this.data.issues || [], 'status', 'open');
    const openInc = countStatus(incidents,'status','open') + countStatus(incidents,'status','investig');
    block =
      sectionHeader('Executive Summary') +
      `Assets: ${assets.length}\nVendors: ${vendors.length}\nRisks: ${risks.length} (Open approx: ${openRisks})\nControls tracked: ${controls.length}\nTreatments: ${treatments.length}\nIssues: ${(this.data.issues || []).length} (Open approx: ${openIssues})\nIncidents: ${incidents.length} (Open approx: ${openInc})\n\n` +
      `Top Risks:\n` +
      (topRisks.length ? topRisks.map(x => `- ${x.r.title || x.r.id} (Score ${x.score})`).join('\n') : '- None') +
      `\n\nNotes:\n- This output is for educational/practice use only.\n`;
  }

  if (type === 'SoA') {
    const applicable = SoA.filter(x => x.applicable !== false);
    const implemented = applicable.filter(x => String(x.status||'').toLowerCase() === 'implemented');
    const coverage = applicable.length ? Math.round((implemented.length / applicable.length) * 100) : 0;

    block =
      sectionHeader('ISO SoA Status') +
      `SoA entries: ${SoA.length}\nApplicable: ${applicable.length}\nImplemented: ${implemented.length}\nCoverage: ${coverage}%\n\n` +
      `Top gaps (first 10):\n` +
      (applicable.filter(x => String(x.status||'').toLowerCase() !== 'implemented')
        .slice(0,10)
        .map(x => `- ${x.controlId || ''} ${x.title || ''} [${x.status || 'Planned'}]`)
        .join('\n') || '- None') +
      `\n`;
  }

  if (type === 'risk') {
    block =
      sectionHeader('Risk Register Summary') +
      `Total risks: ${risks.length}\nOpen/In Progress: ${countStatus(risks,'status','open') + countStatus(risks,'status','in progress')}\nResolved/Closed: ${countStatus(risks,'status','closed') + countStatus(risks,'status','resolved')}\n\n` +
      `Top Risks:\n` +
      (topRisks.length ? topRisks.map(x => `- ${x.r.title || x.r.id} (Score ${x.score}) • ${x.r.status || ''}`).join('\n') : '- None') +
      `\n`;
  }

  if (type === 'treatments') {
    block =
      sectionHeader('Treatment Plan Summary') +
      `Total treatments: ${treatments.length}\nPlanned: ${treatments.filter(x => String(x.status||'')==='Planned').length}\nIn Progress: ${treatments.filter(x => String(x.status||'')==='In Progress').length}\nCompleted: ${treatments.filter(x => String(x.status||'')==='Completed').length}\n\n` +
      `Sample treatments (first 10):\n` +
      (treatments.slice(0,10).map(t => `- ${t.riskTitle || t.riskId || ''}: ${t.treatment || ''} [${t.status || ''}]`).join('\n') || '- None') +
      `\n`;
  }

  this.appendToReport(block);
  this.showToast('Report section added', 'success');
  this.bumpReportCount();
}

exportReportPDF() {
  const el = this.getReportDraftEl();
  if (!el || !(el.value || '').trim()) {
    this.showToast('Report draft is empty', 'warning');
    return;
  }

  if (!window.jspdf || !window.jspdf.jsPDF) {
    this.showToast('PDF library not loaded (jsPDF)', 'error');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });

  const margin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  const title = (document.getElementById('reportTitle')?.value || 'GRC Practice Lab Report').trim();
  const body = el.value;

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(16);
  doc.text(title, margin, 60);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.text('Educational / Practice Use Only — Not for production audits or certification.', margin, 80);

  doc.setFontSize(11);
  const textLines = doc.splitTextToSize(body, pageWidth - margin*2);

  let y = 110;
  for (const line of textLines) {
    if (y > pageHeight - 60) {
      doc.addPage();
      y = 60;
    }
    doc.text(line, margin, y);
    y += 16;
  }

  const fname = `grc-report-${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fname);
  this.showToast('PDF exported', 'success');
  this.bumpReportCount();
}

    // ====================
    // PROJECTS & PORTFOLIO
    // ====================

    getProjectScenarios() {
        return [
            {
                id: 'iso-risk-assessment',
                company: 'TechStart Inc',
                industry: 'SaaS / Cloud Services',
                size: '500 employees',
                scenario: 'Conducting ISO 27001 risk assessment for cloud migration project',
                description: 'TechStart Inc is migrating their customer database (5M+ records) from on-premises to AWS cloud infrastructure while pursuing ISO 27001 certification. As GRC Analyst, you will identify critical cloud assets, assess migration risks, implement security controls, and document findings in a Statement of Applicability. This project demonstrates cloud security risk assessment and ISO 27001 implementation skills.',
                frameworks: ['ISO 27001', 'NIST CSF'],
                tasks: [
                    { id: 'assets', label: 'Add 3 critical assets', tab: 'assets', check: () => this.countProjectItems('iso-risk-assessment', 'assets') >= 3 },
                    { id: 'risks', label: 'Identify 5 risks', tab: 'risks', check: () => this.countProjectItems('iso-risk-assessment', 'risks') >= 5 },
                    { id: 'controls', label: 'Implement 8 controls', tab: 'controls', check: () => this.countProjectItems('iso-risk-assessment', 'controls') >= 8 },
                    { id: 'treatments', label: 'Document 5 risk treatments', tab: 'treatments', check: () => this.countProjectItems('iso-risk-assessment', 'treatments') >= 5 },
                    { id: 'SoA', label: 'Complete SoA (10 controls)', tab: 'SoA', check: () => this.countProjectItems('iso-risk-assessment', 'SoA') >= 10 }
                ]
            },
            {
                id: 'vendor-tprm',
                company: 'FinSecure Banking',
                industry: 'Financial Services',
                size: '1200 employees',
                scenario: 'Third-party risk management for payment processor integration',
                description: 'FinSecure Banking is integrating a third-party payment processor with access to cardholder data and PCI DSS scope systems. As TPRM lead, you will conduct vendor due diligence, assess security risks, verify compliance controls, and document remediation requirements. This project demonstrates third-party risk management skills in a regulated financial environment.',
                frameworks: ['PCI DSS', 'SOC 2'],
                tasks: [
                    { id: 'vendor', label: 'Add vendor profile', tab: 'vendors', check: () => this.countProjectItems('vendor-tprm', 'vendors') >= 1 },
                    { id: 'vendor-risks', label: 'Assess 4 vendor-related risks', tab: 'risks', check: () => this.countProjectItems('vendor-tprm', 'risks') >= 4 },
                    { id: 'vendor-controls', label: 'Verify 6 security controls', tab: 'controls', check: () => this.countProjectItems('vendor-tprm', 'controls') >= 6 },
                    { id: 'issues', label: 'Document 3 remediation issues', tab: 'issues', check: () => this.countProjectItems('vendor-tprm', 'issues') >= 3 }
                ]
            },
            {
                id: 'soc2-audit',
                company: 'DataFlow Analytics',
                industry: 'Data Analytics Platform',
                size: '300 employees',
                scenario: 'SOC 2 Type II audit preparation',
                description: 'DataFlow Analytics is a SaaS platform serving Fortune 500 clients, with customers requiring SOC 2 Type II certification for contract renewals. As Compliance Manager, you will document Trust Services Criteria controls, catalog critical systems, collect audit evidence, and complete a control matrix demonstrating operational effectiveness. This project covers comprehensive SOC 2 audit preparation.',
                frameworks: ['SOC 2', 'NIST CSF'],
                tasks: [
                    { id: 'soc2-controls', label: 'Document 12 SOC 2 controls', tab: 'controls', check: () => this.countProjectItems('soc2-audit', 'controls') >= 12 },
                    { id: 'soc2-assets', label: 'Catalog 4 critical systems', tab: 'assets', check: () => this.countProjectItems('soc2-audit', 'assets') >= 4 },
                    { id: 'soc2-incidents', label: 'Track 2 security incidents', tab: 'incidents', check: () => this.countProjectItems('soc2-audit', 'incidents') >= 2 },
                    { id: 'soc2-SoA', label: 'Complete control matrix (15 controls)', tab: 'SoA', check: () => this.countProjectItems('soc2-audit', 'SoA') >= 15 }
                ]
            },
            {
                id: 'gdpr-compliance',
                company: 'EuroShop Ltd',
                industry: 'E-commerce',
                size: '800 employees',
                scenario: 'GDPR compliance program implementation',
                description: 'EuroShop Ltd is a UK e-commerce retailer expanding into EU markets, processing personal data for 3M+ European customers and facing penalties up to €20M for non-compliance. As Data Protection Officer, you will map data processing activities, conduct DPIAs, implement privacy controls, and establish data subject rights procedures. This project demonstrates GDPR compliance program development.',
                frameworks: ['GDPR', 'ISO 27001'],
                tasks: [
                    { id: 'gdpr-assets', label: 'Map 5 data processing assets', tab: 'assets', check: () => this.countProjectItems('gdpr-compliance', 'assets') >= 5 },
                    { id: 'gdpr-risks', label: 'Assess 6 privacy risks', tab: 'risks', check: () => this.countProjectItems('gdpr-compliance', 'risks') >= 6 },
                    { id: 'gdpr-controls', label: 'Implement 10 privacy controls', tab: 'controls', check: () => this.countProjectItems('gdpr-compliance', 'controls') >= 10 },
                    { id: 'gdpr-treatments', label: 'Document 4 risk mitigations', tab: 'treatments', check: () => this.countProjectItems('gdpr-compliance', 'treatments') >= 4 }
                ]
            },
            {
                id: 'incident-response',
                company: 'HealthTech Systems',
                industry: 'Healthcare Technology',
                size: '600 employees',
                scenario: 'Incident response program development',
                description: 'HealthTech Systems provides EHR systems to 200+ hospitals storing PHI for 2M+ patients, with recent attacks highlighting the need for formal incident response capabilities. As Security Operations Manager, you will develop IR playbooks, define team roles, establish escalation procedures, and ensure HIPAA breach notification compliance. This project demonstrates healthcare incident response program development.',
                frameworks: ['HIPAA', 'NIST CSF'],
                tasks: [
                    { id: 'ir-incidents', label: 'Document 3 incident scenarios', tab: 'incidents', check: () => this.countProjectItems('incident-response', 'incidents') >= 3 },
                    { id: 'ir-controls', label: 'Define 8 IR controls', tab: 'controls', check: () => this.countProjectItems('incident-response', 'controls') >= 8 },
                    { id: 'ir-assets', label: 'Identify 4 critical systems', tab: 'assets', check: () => this.countProjectItems('incident-response', 'assets') >= 4 },
                    { id: 'ir-treatments', label: 'Create 5 response procedures', tab: 'treatments', check: () => this.countProjectItems('incident-response', 'treatments') >= 5 }
                ]
            },
            {
                id: 'cloud-security',
                company: 'CloudNative Corp',
                industry: 'Cloud Infrastructure',
                size: '400 employees',
                scenario: 'AWS security assessment and hardening',
                description: 'CloudNative Corp manages AWS infrastructure for 50+ enterprise clients, with recent audits revealing critical misconfigurations including public S3 buckets and overly permissive IAM policies. As Cloud Security Engineer, you will conduct a CIS Benchmark assessment, document security findings, implement remediation controls, and create a prioritized security roadmap. This project demonstrates AWS security assessment and hardening expertise.',
                frameworks: ['CIS Controls', 'NIST CSF'],
                tasks: [
                    { id: 'cloud-assets', label: 'Inventory 6 cloud assets', tab: 'assets', check: () => this.countProjectItems('cloud-security', 'assets') >= 6 },
                    { id: 'cloud-issues', label: 'Document 5 security findings', tab: 'issues', check: () => this.countProjectItems('cloud-security', 'issues') >= 5 },
                    { id: 'cloud-risks', label: 'Assess 4 cloud risks', tab: 'risks', check: () => this.countProjectItems('cloud-security', 'risks') >= 4 },
                    { id: 'cloud-controls', label: 'Implement 10 security controls', tab: 'controls', check: () => this.countProjectItems('cloud-security', 'controls') >= 10 },
                    { id: 'cloud-treatments', label: 'Remediate 5 findings', tab: 'treatments', check: () => this.countProjectItems('cloud-security', 'treatments') >= 5 }
                ]
            },
            {
                id: 'bcdr-planning',
                company: 'CriticalOps Inc',
                industry: 'Critical Infrastructure',
                size: '900 employees',
                scenario: 'Business Continuity and Disaster Recovery planning',
                description: 'CriticalOps Inc operates critical infrastructure for water treatment, power grid monitoring, and emergency services serving 10M+ citizens, with recent disasters exposing preparedness gaps. As Business Continuity Manager, you will conduct Business Impact Analysis, define RTO/RPO requirements, document recovery procedures, and implement technical controls. This project covers BCDR planning for critical infrastructure with regulatory compliance requirements.',
                frameworks: ['COBIT', 'ISO 27001'],
                tasks: [
                    { id: 'bcdr-assets', label: 'Identify 5 critical assets', tab: 'assets', check: () => this.countProjectItems('bcdr-planning', 'assets') >= 5 },
                    { id: 'bcdr-risks', label: 'Assess 4 continuity risks', tab: 'risks', check: () => this.countProjectItems('bcdr-planning', 'risks') >= 4 },
                    { id: 'bcdr-controls', label: 'Document 8 BC controls', tab: 'controls', check: () => this.countProjectItems('bcdr-planning', 'controls') >= 8 },
                    { id: 'bcdr-incidents', label: 'Plan 2 disaster scenarios', tab: 'incidents', check: () => this.countProjectItems('bcdr-planning', 'incidents') >= 2 }
                ]
            },
            {
                id: 'compliance-gap',
                company: 'RegTech Solutions',
                industry: 'Regulatory Technology',
                size: '350 employees',
                scenario: 'Multi-framework compliance gap analysis',
                description: 'RegTech Solutions serves healthcare, finance, and payment clients requiring simultaneous compliance with PCI DSS, SOC 2, and HIPAA frameworks. As Compliance Architect, you will map control objectives across frameworks, assess implementation status for 100+ controls, document gaps with risk ratings, and create a unified remediation roadmap. This project demonstrates multi-framework compliance assessment skills.',
                frameworks: ['PCI DSS', 'SOC 2', 'HIPAA'],
                tasks: [
                    { id: 'gap-controls', label: 'Assess 15 controls', tab: 'controls', check: () => this.countProjectItems('compliance-gap', 'controls') >= 15 },
                    { id: 'gap-issues', label: 'Identify 6 compliance gaps', tab: 'issues', check: () => this.countProjectItems('compliance-gap', 'issues') >= 6 },
                    { id: 'gap-treatments', label: 'Plan 6 remediations', tab: 'treatments', check: () => this.countProjectItems('compliance-gap', 'treatments') >= 6 },
                    { id: 'gap-SoA', label: 'Complete control matrix (20 controls)', tab: 'SoA', check: () => this.countProjectItems('compliance-gap', 'SoA') >= 20 }
                ]
            }
        ];
    }

    countProjectItems(projectId, type) {
        const items = this.data[type] || [];
        return items.filter(item => item.projectId === projectId).length;
    }

    getProjectProgress(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return { completed: 0, total: 0, percent: 0 };
        
        const completed = project.tasks.filter(t => t.check()).length;
        const total = project.tasks.length;
        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        return { completed, total, percent, isComplete: percent === 100 };
    }

    startProject(projectId) {
        const existing = this.data.projects.find(p => p.id === projectId);
        if (!existing) {
            this.data.projects.push({
                id: projectId,
                startedAt: new Date().toISOString(),
                status: 'in-progress'
            });
            this.saveData('projects', this.data.projects);
        }
        this.showToast('Project started! Use tabs to complete tasks', 'success');
        this.renderProjects();
    }

    setProjectContext(projectId) {
        this.currentProjectId = projectId;
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (project) {
            this.showToast(`Working on: ${project.company}`, 'info');
        }
    }

    renderProjects() {
        const container = document.getElementById('projectList');
        if (!container) return;

        const scenarios = this.getProjectScenarios();
        
        container.innerHTML = scenarios.map(project => {
            const progress = this.getProjectProgress(project.id);
            const started = this.data.projects.find(p => p.id === project.id);
            
            return `
                <div class="col-md-6">
                    <div class="project-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h4 class="mb-1">${this.escapeHtml(project.company)}</h4>
                                <div class="text-muted mb-2">${this.escapeHtml(project.industry)} • ${this.escapeHtml(project.size)}</div>
                            </div>
                            ${progress.isComplete ? '<span class="badge bg-success">Complete</span>' : ''}
                        </div>
                        
                        <h5 class="mb-2">${this.escapeHtml(project.scenario)}</h5>
                        <p class="text-muted mb-3" style="font-size:0.875rem;">${this.escapeHtml(project.description)}</p>
                        
                        <div class="d-flex gap-2 flex-wrap mb-3">
                            ${project.frameworks.map(f => `
                                <span class="framework-badge badge-${f.toLowerCase().replace(/\s+/g, '')}">${this.escapeHtml(f)}</span>
                            `).join('')}
                        </div>
                        
                        <h6 class="mb-2">Tasks (${progress.completed}/${progress.total}):</h6>
                        <ul class="project-task-list">
                            ${project.tasks.map(task => {
                                const isDone = task.check();
                                return `
                                    <li class="project-task-item ${isDone ? 'completed' : ''}">
                                        <i class="bi bi-${isDone ? 'check-circle-fill' : 'circle'}"></i>
                                        <span>${this.escapeHtml(task.label)}</span>
                                        ${!isDone && task.tab ? `<button class="btn btn-sm btn-outline-light ms-auto" onclick="window.app.setProjectContext('${project.id}'); window.app.switchTab('${task.tab}')">Go to ${this.capitalize(task.tab)}</button>` : ''}
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                        
                        <div class="project-progress-bar">
                            <div class="project-progress-fill" style="width: ${progress.percent}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-muted" style="font-size:0.875rem;">${progress.percent}% Complete</span>
                            ${started ? 
                                (progress.isComplete ? 
                                    `<button class="btn btn-success btn-sm" onclick="window.app.generatePortfolio('${project.id}')"><i class="bi bi-file-earmark-text me-1"></i> Generate Summary</button>` 
                                    : '<span class="badge bg-warning">In Progress</span>') 
                                : `<button class="btn btn-primary btn-sm" onclick="window.app.startProject('${project.id}')"><i class="bi bi-play-fill me-1"></i> Start Project</button>`}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    generatePortfolio(projectId) {
        const project = this.getProjectScenarios().find(p => p.id === projectId);
        if (!project) return;

        const projectData = {
            company: project.company,
            industry: project.industry,
            size: project.size,
            scenario: project.scenario,
            description: project.description,
            frameworks: project.frameworks,
            assets: this.data.assets.filter(a => a.projectId === projectId),
            risks: this.data.risks.filter(r => r.projectId === projectId),
            controls: this.data.controls.filter(c => c.projectId === projectId),
            vendors: this.data.vendors.filter(v => v.projectId === projectId),
            issues: this.data.issues.filter(i => i.projectId === projectId),
            incidents: this.data.incidents.filter(i => i.projectId === projectId),
            treatments: this.data.treatments.filter(t => t.projectId === projectId),
            SoA: this.data.SoA.filter(s => s.projectId === projectId)
        };

        // Generate summary
        const summary = this.generateProjectSummary(projectData);
        
        // Save to portfolio
        this.data.portfolioSummaries[projectId] = {
            ...summary,
            generatedAt: new Date().toISOString()
        };
        this.saveData('portfolioSummaries', this.data.portfolioSummaries);
        
        this.showToast('Portfolio summary generated!', 'success');
        this.switchTab('portfolio');
    }

    generateProjectSummary(data) {
        const bullets = [];
        
        // Asset management
        if (data.assets.length > 0) {
            bullets.push(`• Conducted comprehensive asset inventory, cataloging ${data.assets.length} critical assets including ${data.assets.slice(0,3).map(a => a.name).join(', ')}`);
        }
        
        // Risk assessment
        if (data.risks.length > 0) {
            const highRisks = data.risks.filter(r => r.severity === 'High').length;
            bullets.push(`• Performed risk assessment identifying ${data.risks.length} risks across multiple categories, prioritizing ${highRisks} high-severity risks for immediate mitigation`);
        }
        
        // Control implementation
        if (data.controls.length > 0) {
            const implemented = data.controls.filter(c => c.status === 'Implemented').length;
            bullets.push(`• Implemented and documented ${implemented} of ${data.controls.length} security controls aligned with ${data.frameworks.join(', ')} requirements`);
        }
        
        // Vendor management
        if (data.vendors.length > 0) {
            bullets.push(`• Conducted third-party risk assessments for ${data.vendors.length} vendors, evaluating security posture and compliance requirements`);
        }
        
        // Issue tracking
        if (data.issues.length > 0) {
            const resolved = data.issues.filter(i => i.status === 'Closed').length;
            bullets.push(`• Tracked and remediated ${resolved} of ${data.issues.length} security findings, coordinating with technical teams for implementation`);
        }
        
        // Incident response
        if (data.incidents.length > 0) {
            bullets.push(`• Managed ${data.incidents.length} security incidents through structured response process, documenting lessons learned and process improvements`);
        }
        
        // Risk treatments
        if (data.treatments.length > 0) {
            bullets.push(`• Developed ${data.treatments.length} risk treatment plans with clear ownership, timelines, and success criteria`);
        }
        
        // Compliance
        if (data.SoA.length > 0) {
            const applicable = data.SoA.filter(s => s.applicable !== false).length;
            bullets.push(`• Completed Statement of Applicability for ${applicable} controls, establishing compliance baseline for ${data.frameworks.join(', ')}`);
        }
        
        // Project outcome
        bullets.push(`• Delivered comprehensive GRC project for ${data.company} (${data.industry}), improving security posture and demonstrating compliance with industry standards`);
        
        return {
            company: data.company,
            industry: data.industry,
            scenario: data.scenario,
            description: data.description,
            frameworks: data.frameworks,
            bullets: bullets,
            stats: {
                assets: data.assets.length,
                risks: data.risks.length,
                controls: data.controls.length,
                vendors: data.vendors.length,
                issues: data.issues.length,
                incidents: data.incidents.length,
                treatments: data.treatments.length,
                SoA: data.SoA.length
            }
        };
    }

    generateAllPortfolios() {
        const scenarios = this.getProjectScenarios();
        let generated = 0;
        
        scenarios.forEach(project => {
            const progress = this.getProjectProgress(project.id);
            if (progress.isComplete) {
                this.generatePortfolio(project.id);
                generated++;
            }
        });
        
        if (generated === 0) {
            this.showToast('No completed projects to generate', 'info');
        } else {
            this.showToast(`Generated ${generated} portfolio summaries`, 'success');
        }
    }

    copyAllBullets() {
        const summaries = Object.values(this.data.portfolioSummaries);
        if (summaries.length === 0) {
            this.showToast('No portfolio summaries to copy', 'info');
            return;
        }
        
        const allBullets = summaries.map(s => {
            return `${s.company} - ${s.scenario}\n${s.bullets.join('\n')}`;
        }).join('\n\n');
        
        navigator.clipboard.writeText(allBullets).then(() => {
            this.showToast('All bullets copied to clipboard!', 'success');
        }).catch(() => {
            this.showToast('Failed to copy to clipboard', 'error');
        });
    }

    
    copyPortfolioSummary(projectId) {
        const summary = (this.data.portfolioSummaries || {})[projectId];
        if (!summary) {
            this.showToast('Summary not found', 'error');
            return;
        }
        const text = this.formatPortfolioSummaryText(summary);
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Summary copied!', 'success');
        }).catch(() => {
            this.showToast('Failed to copy to clipboard', 'error');
        });
    }


    formatPortfolioSummaryText(summary) {
        const lines = [];
        lines.push(summary.company);
        lines.push(`${summary.industry} • ${summary.scenario}`);
        lines.push('');
        lines.push('Project Description:');
        lines.push(summary.description || '');
        lines.push('');
        lines.push('Frameworks Used:');
        lines.push((summary.frameworks || []).join(', '));
        lines.push('');
        lines.push('Project Statistics:');
        lines.push(`${summary.stats.assets} Assets`);
        lines.push(`${summary.stats.risks} Risks`);
        lines.push(`${summary.stats.controls} Controls`);
        lines.push(`${summary.stats.treatments} Treatments`);
        lines.push(`${summary.stats.SoA} SoA Controls`);
        lines.push('');
        lines.push('Resume Bullet Points:');
        (summary.bullets || []).forEach(b => lines.push(b.startsWith('•') ? b : `• ${b}`));
        return lines.join('\n');
    }

    exportPortfolioPDF(projectId = null) {
        // jsPDF UMD exposes window.jspdf.jsPDF
        const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : window.jsPDF;
        if (!jsPDF) {
            this.showToast('PDF library not loaded. Please refresh the page.', 'error');
            return;
        }

        const summariesMap = this.data.portfolioSummaries || {};
        const summaries = projectId
            ? (summariesMap[projectId] ? [summariesMap[projectId]] : [])
            : Object.values(summariesMap);

        if (summaries.length === 0) {
            this.showToast('No portfolio summaries to export', 'info');
            return;
        }

        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 40;
        const maxWidth = pageWidth - margin * 2;

        let y = margin;

        const addWrapped = (text, fontSize = 11, bold = false, gap = 6) => {
            doc.setFont('helvetica', bold ? 'bold' : 'normal');
            doc.setFontSize(fontSize);
            const lines = doc.splitTextToSize(String(text || ''), maxWidth);
            for (const line of lines) {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.text(line, margin, y);
                y += fontSize + 3;
            }
            y += gap;
        };

        summaries.forEach((s, idx) => {
            addWrapped(s.company, 16, true, 2);
            addWrapped(`${s.industry} • ${s.scenario}`, 11, false, 10);

            addWrapped('Project Description', 12, true, 2);
            addWrapped(s.description || '', 11, false, 10);

            addWrapped('Frameworks Used', 12, true, 2);
            addWrapped((s.frameworks || []).join(', '), 11, false, 10);

            addWrapped('Project Statistics', 12, true, 2);
            addWrapped(
                `${s.stats.assets} Assets • ${s.stats.risks} Risks • ${s.stats.controls} Controls • ${s.stats.treatments} Treatments • ${s.stats.SoA} SoA Controls`,
                11, false, 10
            );

            addWrapped('Resume Bullet Points', 12, true, 2);
            (s.bullets || []).forEach(b => addWrapped(b.startsWith('•') ? b : `• ${b}`, 11, false, 2));
            y += 8;

            if (idx < summaries.length - 1) {
                doc.setDrawColor(180);
                doc.line(margin, y, pageWidth - margin, y);
                y += 18;
            }
        });

        const nameBase = projectId ? (summaries[0].company || 'Portfolio') : 'Portfolio_Summaries';
        const safeName = nameBase.replace(/[\\/:*?"<>|]+/g, '').replace(/\s+/g, '_').trim();
        doc.save(`${safeName}.pdf`);
        this.showToast('PDF exported!', 'success');
    }

renderPortfolio() {
        const container = document.getElementById('portfolioContent');
        if (!container) return;

        const summaries = Object.entries(this.data.portfolioSummaries);
        
        if (summaries.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-folder2-open" style="font-size:3rem;color:rgba(255,255,255,0.5);"></i>
                    <p style="color:rgba(255,255,255,0.7);" class="mt-3">No portfolio summaries yet. Complete projects and generate summaries!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = summaries.map(([projectId, summary]) => `
            <div class="portfolio-summary">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h3>${this.escapeHtml(summary.company)}</h3>
                        <p style="color:rgba(255,255,255,0.85);" class="mb-2">${this.escapeHtml(summary.industry)} • ${this.escapeHtml(summary.scenario)}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="navigator.clipboard.writeText(\`${summary.bullets.join('\\n')}\`).then(() => window.app.showToast('Bullets copied!', 'success'))">
                        <i class="bi bi-clipboard"></i> Copy Summary
                    </button>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="window.app.exportPortfolioPDF('${projectId}')"><i class="bi bi-file-earmark-pdf"></i> Export PDF</button>
                </div>
                
                <h5 class="mb-3">Project Description:</h5>
                <p style="color:rgba(255,255,255,0.85);" class="mb-3">${this.escapeHtml(summary.description)}</p>
                
                <h5 class="mb-3">Frameworks Used:</h5>
                <div class="d-flex gap-2 flex-wrap mb-4">
                    ${summary.frameworks.map(f => `<span class="framework-badge badge-iso">${this.escapeHtml(f)}</span>`).join('')}
                </div>
                
                <h5 class="mb-3">Project Statistics:</h5>
                <div class="d-flex gap-2 flex-wrap mb-4">
                    ${summary.stats.assets > 0 ? `<span class="portfolio-stat"><i class="bi bi-hdd-stack"></i> ${summary.stats.assets} Assets</span>` : ''}
                    ${summary.stats.risks > 0 ? `<span class="portfolio-stat"><i class="bi bi-exclamation-triangle"></i> ${summary.stats.risks} Risks</span>` : ''}
                    ${summary.stats.controls > 0 ? `<span class="portfolio-stat"><i class="bi bi-shield-check"></i> ${summary.stats.controls} Controls</span>` : ''}
                    ${summary.stats.vendors > 0 ? `<span class="portfolio-stat"><i class="bi bi-people"></i> ${summary.stats.vendors} Vendors</span>` : ''}
                    ${summary.stats.issues > 0 ? `<span class="portfolio-stat"><i class="bi bi-bug"></i> ${summary.stats.issues} Issues</span>` : ''}
                    ${summary.stats.incidents > 0 ? `<span class="portfolio-stat"><i class="bi bi-exclamation-octagon"></i> ${summary.stats.incidents} Incidents</span>` : ''}
                    ${summary.stats.treatments > 0 ? `<span class="portfolio-stat"><i class="bi bi-check2-circle"></i> ${summary.stats.treatments} Treatments</span>` : ''}
                    ${summary.stats.SoA > 0 ? `<span class="portfolio-stat"><i class="bi bi-list-check"></i> ${summary.stats.SoA} SoA Controls</span>` : ''}
                </div>
                
                <h5 class="mb-3">Resume Bullet Points:</h5>
                <div>
                    ${summary.bullets.map(bullet => `
                        <div class="portfolio-bullet">${this.escapeHtml(bullet)}</div>
                    `).join('')}
                </div>
                
                <div style="color:rgba(255,255,255,0.6); font-size:0.875rem;" class="mt-3">
                    Generated: ${new Date(summary.generatedAt).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    
    showToast(message, type = 'info') {
        const toastEl = document.getElementById('liveToast');
        const toastMessage = document.getElementById('toastMessage');
        if (!toastEl || !toastMessage) return;
        
        toastMessage.textContent = message;
        toastEl.className = 'toast';
        const colors = { success: 'bg-success text-white', error: 'bg-danger text-white', 
                        warning: 'bg-warning text-dark', info: 'bg-info text-white' };
        toastEl.classList.add(...(colors[type] || colors.info).split(' '));
        
        new bootstrap.Toast(toastEl, { delay: 3000 }).show();
    }
}

let app;
document.addEventListener('DOMContentLoaded', () => {
    app = new GRCApplication();
    window.app = app;
});
</script>

</body>
</html>
